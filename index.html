<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>JDP CABS ‚Äî MapmyIndia Live</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap" rel="stylesheet">

<!-- ‚úÖ MAPPLS SDK with your API Key -->
<script src="https://apis.mappls.com/advancedmaps/api/kwzjopzmxtgmraerxyxpsrqqrxhdivkycqnc/map_sdk?layer=vector&v=3.0&callback=onMapplsReady" defer async></script>
<!-- Mappls Plugins -->
<script src="https://apis.mappls.com/advancedmaps/api/kwzjopzmxtgmraerxyxpsrqqrxhdivkycqnc/map_sdk_plugins?v=3.0" defer async></script>

<style>
:root {
  --yellow: #FBBF24;
  --yd: #d97706;
  --bg: #0c0c0c;
  --card: #181818;
  --border: #252525;
  --text: #f1f5f9;
  --muted: #64748b;
  --green: #10b981;
  --red: #ef4444;
  --orange: #FF9933;
}
* { margin:0; padding:0; box-sizing:border-box; }
body {
  font-family: 'Plus Jakarta Sans', sans-serif;
  background: var(--bg);
  color: var(--text);
  height: 100vh;
  overflow: hidden;
}

/* MAP */
#map {
  width: 100vw; height: 100vh;
  position: absolute; inset: 0; z-index: 1;
}

/* LOADER */
#loader {
  position: fixed; inset: 0;
  background: var(--bg);
  z-index: 9000;
  display: flex; flex-direction: column;
  align-items: center; justify-content: center; gap: 20px;
}
.ld-logo {
  display: flex; align-items: center; gap: 14px;
}
.ld-icon {
  width: 64px; height: 64px;
  background: var(--yellow);
  border-radius: 18px;
  display: flex; align-items: center; justify-content: center;
  font-size: 1.8rem; font-weight: 900; color: #000;
  box-shadow: 0 12px 40px rgba(251,191,36,0.35);
  animation: logoPulse 2s ease-in-out infinite;
}
@keyframes logoPulse { 0%,100%{box-shadow:0 12px 40px rgba(251,191,36,0.35)} 50%{box-shadow:0 12px 60px rgba(251,191,36,0.6)} }
.ld-name { font-size: 2.4rem; font-weight: 900; letter-spacing: -1px; }
.ld-badge {
  display: flex; align-items: center; gap: 8px;
  background: rgba(255,153,51,0.1);
  border: 1px solid rgba(255,153,51,0.25);
  border-radius: 100px; padding: 7px 18px;
  font-size: 0.8rem; font-weight: 700; color: var(--orange);
}
.ld-bar-wrap {
  width: 240px; height: 4px;
  background: rgba(255,255,255,0.07);
  border-radius: 100px; overflow: hidden;
}
.ld-bar {
  height: 100%; width: 0%;
  background: linear-gradient(90deg, var(--yellow), #ff9900);
  border-radius: 100px;
  transition: width 0.4s ease;
}
.ld-text { font-size: 0.78rem; color: var(--muted); letter-spacing: 0.5px; }

/* TOP BAR */
.topbar {
  position: fixed; top: 0; left: 0; right: 0;
  z-index: 500;
  padding: 14px 20px;
  display: flex; justify-content: space-between; align-items: center;
  background: linear-gradient(to bottom, rgba(0,0,0,0.75) 0%, transparent 100%);
}
.logo { display: flex; align-items: center; gap: 10px; }
.logo-box {
  width: 42px; height: 42px;
  background: var(--yellow);
  border-radius: 13px;
  display: flex; align-items: center; justify-content: center;
  font-weight: 900; font-size: 13px; color: #000;
  letter-spacing: -0.5px;
  box-shadow: 0 4px 14px rgba(251,191,36,0.4);
}
.logo-name { font-size: 1.25rem; font-weight: 900; color: white; }
.india-tag {
  background: rgba(255,153,51,0.15);
  border: 1px solid rgba(255,153,51,0.3);
  border-radius: 100px; padding: 4px 10px;
  font-size: 0.62rem; font-weight: 800; color: var(--orange);
  letter-spacing: 0.5px; text-transform: uppercase;
}
.top-btns { display: flex; gap: 8px; }
.topbtn {
  width: 42px; height: 42px;
  background: rgba(0,0,0,0.45);
  backdrop-filter: blur(12px);
  border: 1px solid rgba(255,255,255,0.1);
  border-radius: 12px;
  display: flex; align-items: center; justify-content: center;
  cursor: pointer; font-size: 1rem; transition: all 0.2s;
}
.topbtn:hover { border-color: var(--yellow); }

/* LIVE PILL */
.live-pill {
  position: fixed; top: 78px; left: 50%;
  transform: translateX(-50%);
  z-index: 500;
  background: rgba(16,185,129,0.12);
  border: 1px solid rgba(16,185,129,0.25);
  border-radius: 100px; padding: 7px 16px;
  font-size: 0.7rem; font-weight: 700; color: var(--green);
  display: flex; align-items: center; gap: 6px;
  backdrop-filter: blur(12px); white-space: nowrap;
}
.live-dot { width: 6px; height: 6px; background: var(--green); border-radius: 50%; animation: ldot 1s infinite; }
@keyframes ldot { 0%,100%{opacity:1} 50%{opacity:0.2} }

/* LOCATE BTN */
.locate-btn {
  position: fixed; right: 18px; bottom: 380px;
  z-index: 500; width: 48px; height: 48px;
  background: white; border-radius: 50%;
  border: none; cursor: pointer; font-size: 1.2rem;
  box-shadow: 0 4px 20px rgba(0,0,0,0.35);
  display: flex; align-items: center; justify-content: center;
  transition: transform 0.2s;
}
.locate-btn:hover { transform: scale(1.08); }

/* BOTTOM SHEET */
.bsheet {
  position: fixed; bottom: 0; left: 0; right: 0;
  z-index: 400;
  background: rgba(10,10,10,0.97);
  backdrop-filter: blur(28px);
  border-radius: 26px 26px 0 0;
  border-top: 1px solid rgba(255,255,255,0.07);
  padding: 0 18px 32px;
  max-height: 76vh; overflow-y: auto;
}
.bsheet::-webkit-scrollbar { display: none; }
.handle { width: 38px; height: 4px; background: rgba(255,255,255,0.13); border-radius: 4px; margin: 13px auto 18px; }

/* SCREENS */
.scr { display: none; }
.scr.on { display: block; animation: fadeUp 0.35s cubic-bezier(0.16,1,0.3,1); }
@keyframes fadeUp { from{opacity:0;transform:translateY(16px)} to{opacity:1;transform:translateY(0)} }

/* HOME */
.where-lbl { font-size: 0.65rem; font-weight: 800; letter-spacing: 2px; text-transform: uppercase; color: var(--muted); margin-bottom: 12px; }
.loc-boxes { display: flex; flex-direction: column; gap: 9px; margin-bottom: 16px; }
.loc-box {
  display: flex; align-items: center; gap: 12px;
  background: rgba(255,255,255,0.04);
  border: 1.5px solid rgba(255,255,255,0.07);
  border-radius: 14px; padding: 13px 15px;
  cursor: pointer; transition: all 0.2s;
}
.loc-box:hover { border-color: var(--yellow); background: rgba(251,191,36,0.04); }
.ldot-g { width: 10px; height: 10px; border-radius: 50%; background: var(--green); box-shadow: 0 0 8px rgba(16,185,129,0.7); flex-shrink: 0; }
.ldot-r { width: 10px; height: 10px; border-radius: 50%; background: var(--red); box-shadow: 0 0 8px rgba(239,68,68,0.7); flex-shrink: 0; }
.lbl-main { font-weight: 600; font-size: 0.88rem; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
.lbl-sub { font-size: 0.7rem; color: var(--muted); margin-top: 2px; }

.qpicks { display: flex; gap: 7px; margin-bottom: 16px; overflow-x: auto; padding-bottom: 2px; }
.qpicks::-webkit-scrollbar { display: none; }
.qchip {
  display: flex; align-items: center; gap: 5px;
  background: rgba(255,255,255,0.05);
  border: 1px solid rgba(255,255,255,0.08);
  border-radius: 100px; padding: 8px 14px;
  font-size: 0.77rem; font-weight: 600;
  white-space: nowrap; cursor: pointer; transition: all 0.2s;
}
.qchip:hover { border-color: var(--yellow); color: var(--yellow); }

.main-btn {
  width: 100%; background: var(--yellow); color: #000;
  border: none; border-radius: 16px; padding: 17px;
  font-size: 0.98rem; font-weight: 800; cursor: pointer;
  transition: all 0.2s; font-family: 'Plus Jakarta Sans', sans-serif;
}
.main-btn:hover { background: var(--yd); transform: translateY(-1px); box-shadow: 0 10px 28px rgba(251,191,36,0.3); }

/* SECTION HEADER */
.shdr { display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px; }
.stitle { font-weight: 800; font-size: 1.1rem; }
.sback { font-size: 0.8rem; color: var(--muted); cursor: pointer; padding: 6px 12px; border-radius: 8px; transition: all 0.2s; }
.sback:hover { color: var(--yellow); }

/* SEARCH */
.sinp-wrap { position: relative; margin-bottom: 12px; }
.sinp-icon { position: absolute; left: 14px; top: 50%; transform: translateY(-50%); font-size: 0.9rem; }
.sinp {
  width: 100%; background: rgba(255,255,255,0.06);
  border: 1.5px solid rgba(255,255,255,0.09);
  border-radius: 13px; padding: 13px 14px 13px 40px;
  color: white; font-family: 'Plus Jakarta Sans', sans-serif;
  font-size: 0.93rem; font-weight: 500; outline: none; transition: border-color 0.2s;
}
.sinp:focus { border-color: var(--yellow); }
.sinp::placeholder { color: var(--muted); }

.suglist { display: flex; flex-direction: column; gap: 1px; }
.sugrow {
  display: flex; align-items: center; gap: 12px;
  padding: 11px 10px; border-radius: 11px;
  cursor: pointer; transition: background 0.18s;
}
.sugrow:hover { background: rgba(255,255,255,0.05); }
.sugico { width: 40px; height: 40px; background: rgba(255,255,255,0.05); border-radius: 10px; display: flex; align-items: center; justify-content: center; font-size: 1rem; flex-shrink: 0; }
.sugbody { flex: 1; min-width: 0; }
.sugname { font-weight: 600; font-size: 0.86rem; }
.sugaddr { font-size: 0.71rem; color: var(--muted); margin-top: 1px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
.sugdist { font-size: 0.7rem; color: var(--yellow); font-weight: 700; white-space: nowrap; }

/* ROUTE BAR */
.rbar {
  display: flex; align-items: center; gap: 10px;
  background: rgba(255,255,255,0.04);
  border-radius: 12px; padding: 12px 14px; margin-bottom: 13px;
}
.rline { display: flex; flex-direction: column; align-items: center; gap: 2px; }
.rg { width: 8px; height: 8px; border-radius: 50%; background: var(--green); }
.rr { width: 8px; height: 8px; border-radius: 50%; background: var(--red); }
.rdashes { display: flex; flex-direction: column; gap: 2px; }
.rdash { width: 2px; height: 4px; background: var(--muted); border-radius: 1px; }
.rfrom { font-size: 0.82rem; font-weight: 600; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
.rto { font-size: 0.82rem; color: var(--muted); margin-top: 7px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }

/* RIDE OPTION */
.ropt {
  display: flex; align-items: center; gap: 13px;
  padding: 13px 12px;
  border: 1.5px solid rgba(255,255,255,0.06);
  border-radius: 15px; cursor: pointer;
  transition: all 0.22s; margin-bottom: 8px; position: relative;
}
.ropt.sel { border-color: var(--yellow); background: rgba(251,191,36,0.05); }
.ropt:hover { border-color: rgba(251,191,36,0.35); }
.rico { width: 56px; height: 42px; background: rgba(255,255,255,0.05); border-radius: 10px; display: flex; align-items: center; justify-content: center; font-size: 1.5rem; flex-shrink: 0; }
.rname { font-weight: 700; font-size: 0.92rem; }
.rdesc { font-size: 0.72rem; color: var(--muted); margin-top: 2px; }
.reta { font-size: 0.71rem; color: var(--green); font-weight: 700; margin-top: 4px; }
.rprice { text-align: right; }
.rp-amt { font-size: 1.1rem; font-weight: 800; }
.rp-sub { font-size: 0.68rem; color: var(--muted); }
.rbadge { position: absolute; top: -8px; right: 12px; background: var(--green); color: white; font-size: 0.58rem; font-weight: 700; padding: 2px 8px; border-radius: 100px; text-transform: uppercase; letter-spacing: 0.5px; }

/* PAY ROW */
.payrow {
  display: flex; align-items: center; justify-content: space-between;
  background: rgba(255,255,255,0.04); border-radius: 12px;
  padding: 12px 14px; margin: 12px 0;
}
.payl { display: flex; align-items: center; gap: 10px; font-size: 0.85rem; font-weight: 600; }

/* CONFIRM BTN */
.conf-btn {
  width: 100%; background: var(--yellow); color: #000;
  border: none; border-radius: 15px; padding: 17px;
  font-size: 1rem; font-weight: 800; cursor: pointer;
  transition: all 0.2s; font-family: 'Plus Jakarta Sans', sans-serif;
}
.conf-btn:hover { background: var(--yd); transform: translateY(-1px); box-shadow: 0 8px 28px rgba(251,191,36,0.3); }

/* TRACKING */
.etabar {
  display: flex; justify-content: space-between; align-items: center;
  background: rgba(16,185,129,0.09);
  border: 1px solid rgba(16,185,129,0.2);
  border-radius: 14px; padding: 16px; margin-bottom: 13px;
}
.etanum { font-size: 2.4rem; font-weight: 900; color: var(--green); line-height: 1; }
.etalbl { font-size: 0.7rem; color: var(--muted); margin-top: 4px; }
.etasteps { display: flex; flex-direction: column; gap: 5px; text-align: right; }
.stp { font-size: 0.75rem; color: var(--muted); }
.stp.on { color: var(--text); font-weight: 700; }
.stp.done { color: var(--green); text-decoration: line-through; opacity: 0.6; }

.dcard {
  display: flex; align-items: center; gap: 13px;
  background: rgba(255,255,255,0.04);
  border: 1px solid rgba(255,255,255,0.06);
  border-radius: 15px; padding: 14px; margin-bottom: 13px;
}
.dav { width: 52px; height: 52px; border-radius: 50%; overflow: hidden; flex-shrink: 0; border: 2px solid var(--yellow); }
.dav img { width: 100%; height: 100%; object-fit: cover; }
.dname { font-weight: 700; font-size: 0.94rem; }
.dcar { font-size: 0.74rem; color: var(--muted); margin-top: 2px; }
.drating { font-size: 0.74rem; color: var(--yellow); font-weight: 700; margin-top: 3px; }
.dbtns { display: flex; gap: 8px; }
.dbtn { width: 42px; height: 42px; border-radius: 50%; border: 1px solid rgba(255,255,255,0.1); background: rgba(255,255,255,0.05); display: flex; align-items: center; justify-content: center; font-size: 1.1rem; cursor: pointer; transition: all 0.2s; }
.dbtn:hover { border-color: var(--yellow); }

.canc-btn {
  width: 100%; background: rgba(239,68,68,0.09);
  color: var(--red); border: 1px solid rgba(239,68,68,0.2);
  border-radius: 14px; padding: 14px;
  font-weight: 700; font-size: 0.9rem; cursor: pointer;
  transition: all 0.2s; font-family: 'Plus Jakarta Sans', sans-serif;
}
.canc-btn:hover { background: rgba(239,68,68,0.18); }

/* TOAST */
.toast {
  position: fixed; top: 88px; left: 50%;
  transform: translateX(-50%);
  background: rgba(20,20,20,0.96);
  border: 1px solid rgba(255,255,255,0.09);
  border-radius: 100px; padding: 10px 20px;
  font-size: 0.82rem; font-weight: 600;
  z-index: 9999; backdrop-filter: blur(16px);
  animation: tin 0.3s ease, tout 0.3s ease 2.6s forwards;
  white-space: nowrap; pointer-events: none;
}
@keyframes tin { from{opacity:0;top:68px} to{opacity:1;top:88px} }
@keyframes tout { to{opacity:0} }

/* Car marker */
@keyframes carPulse { 0%{transform:scale(0.8);opacity:1} 100%{transform:scale(2);opacity:0} }
</style>
</head>
<body>

<!-- LOADER -->
<div id="loader">
  <div class="ld-logo">
    <div class="ld-icon">JDP</div>
    <div class="ld-name">CABS</div>
  </div>
  <div class="ld-badge">üáÆüá≥ MapmyIndia Map Loading...</div>
  <div class="ld-bar-wrap"><div class="ld-bar" id="ldBar"></div></div>
  <div class="ld-text" id="ldText">Connecting to India's best map...</div>
</div>

<!-- MAP -->
<div id="map"></div>

<!-- TOP BAR -->
<div class="topbar" id="topbar" style="display:none">
  <div class="logo">
    <div class="logo-box">JDP</div>
    <div class="logo-name">CABS</div>
    <div class="india-tag">üáÆüá≥ MapmyIndia</div>
  </div>
  <div class="top-btns">
    <div class="topbtn" onclick="toast('üîî Koi naya alert nahi!')">üîî</div>
    <div class="topbtn" onclick="toast('üë§ Profile jald aayega!')">üë§</div>
  </div>
</div>

<!-- LIVE PILL -->
<div class="live-pill" id="livePill" style="display:none">
  <div class="live-dot"></div>
  <span id="drvCount">5 drivers kareeb hain</span>
</div>

<!-- LOCATE BTN -->
<button class="locate-btn" id="locBtn" style="display:none" onclick="locateMe()">üìç</button>

<!-- BOTTOM SHEET -->
<div class="bsheet" id="bsheet" style="display:none">
  <div class="handle"></div>

  <!-- HOME -->
  <div class="scr on" id="scrHome">
    <div class="where-lbl">Kahan jaana hai?</div>
    <div class="loc-boxes">
      <div class="loc-box" onclick="openPick('pickup')">
        <div class="ldot-g"></div>
        <div style="flex:1;min-width:0">
          <div class="lbl-main" id="puLbl">Pickup jagah set karo</div>
          <div class="lbl-sub">Search karo ya map pe tap karo</div>
        </div>
        <span style="color:var(--muted);font-size:0.8rem">‚úé</span>
      </div>
      <div class="loc-box" onclick="openPick('drop')">
        <div class="ldot-r"></div>
        <div style="flex:1;min-width:0">
          <div class="lbl-main" id="drLbl">Kahan jaana hai?</div>
          <div class="lbl-sub">Sheher, landmark, area...</div>
        </div>
        <span style="color:var(--muted);font-size:0.8rem">‚úé</span>
      </div>
    </div>
    <div class="qpicks">
      <div class="qchip" onclick="qpick('ghar')">üè† Ghar</div>
      <div class="qchip" onclick="qpick('office')">üíº Office</div>
      <div class="qchip" onclick="qpick('airport')">‚úàÔ∏è Airport</div>
      <div class="qchip" onclick="qpick('station')">üöâ Station</div>
      <div class="qchip" onclick="qpick('hospital')">üè• Hospital</div>
      <div class="qchip" onclick="qpick('mall')">üõçÔ∏è Mall</div>
    </div>
    <button class="main-btn" onclick="goRides()">üöó Ride Dekho &amp; Book Karo</button>
  </div>

  <!-- PICKER -->
  <div class="scr" id="scrPick">
    <div class="shdr">
      <div class="stitle" id="pickTitle">Pickup Set Karo</div>
      <div class="sback" onclick="goScr('Home')">‚Üê Wapas</div>
    </div>
    <div class="sinp-wrap">
      <span class="sinp-icon">üîç</span>
      <input type="text" class="sinp" id="sinp" placeholder="Jagah dhundho..." oninput="filterSug(this.value)">
    </div>
    <div class="suglist" id="suglist"></div>
  </div>

  <!-- RIDES -->
  <div class="scr" id="scrRides">
    <div class="shdr">
      <div class="stitle">Ride Chuniye</div>
      <div class="sback" onclick="goScr('Home')">‚Üê Wapas</div>
    </div>
    <div class="rbar">
      <div class="rline">
        <div class="rg"></div>
        <div class="rdashes"><div class="rdash"></div><div class="rdash"></div><div class="rdash"></div></div>
        <div class="rr"></div>
      </div>
      <div style="flex:1;min-width:0">
        <div class="rfrom" id="rfrom">Pickup</div>
        <div class="rto" id="rto">Drop</div>
      </div>
      <div style="text-align:right">
        <div id="rdist" style="font-weight:800;font-size:0.92rem">‚Äî</div>
        <div style="font-size:0.68rem;color:var(--muted)">distance</div>
      </div>
    </div>
    <div id="rlist"></div>
    <div class="payrow">
      <div class="payl"><span>üí≥</span><span>Cash Payment</span></div>
      <span style="font-size:0.73rem;color:var(--yellow);cursor:pointer;font-weight:700">Change ‚Üí</span>
    </div>
    <button class="conf-btn" onclick="confirmRide()">‚úÖ Booking Confirm Karo</button>
  </div>

  <!-- TRACKING -->
  <div class="scr" id="scrTrack">
    <div class="shdr">
      <div class="stitle">Live Tracking üáÆüá≥</div>
      <div class="sback" onclick="cancelRide()">Cancel</div>
    </div>
    <div class="etabar">
      <div>
        <div class="etanum" id="etanum">4</div>
        <div class="etalbl">min mein aayega</div>
      </div>
      <div class="etasteps">
        <div class="stp done" id="s1">‚úì Booking confirm</div>
        <div class="stp on"   id="s2">üöó Driver aa raha hai</div>
        <div class="stp"      id="s3">üìç Pickup pe pahuncha</div>
        <div class="stp"      id="s4">üèÅ Trip shuru</div>
      </div>
    </div>
    <div class="dcard">
      <div class="dav"><img src="https://randomuser.me/api/portraits/men/44.jpg" alt="Driver"></div>
      <div style="flex:1">
        <div class="dname">Ramesh Kumar</div>
        <div class="dcar">üöó Maruti Swift Dzire ¬∑ DL 4C AZ 5678</div>
        <div class="drating">‚òÖ 4.9 ¬∑ 3,241 rides</div>
      </div>
      <div class="dbtns">
        <div class="dbtn" onclick="toast('üìû Driver ko call kar raha hai...')">üìû</div>
        <div class="dbtn" onclick="toast('üí¨ Chat jald aayega!')">üí¨</div>
      </div>
    </div>
    <div class="payrow">
      <div class="payl"><span>üí∞</span><span>Estimated Fare</span></div>
      <span style="font-weight:900;color:var(--yellow);font-size:1.05rem" id="tfare">‚Çπ180</span>
    </div>
    <button class="canc-btn" onclick="cancelRide()">Ride Cancel Karo</button>
  </div>
</div>

<!-- Leaflet FALLBACK CSS/JS (only if Mappls fails) -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<script>
// ===== GLOBALS =====
const DEFAULT_CENTER = [28.6139, 77.2090];
let puCoords = null, drCoords = null;
let puMarker = null, drMarker = null;
let routeLine = null;
let drvObjs = [];
let pickerType = 'pickup';
let mapMode = 'none';
let lmap = null; // leaflet map
let mmap = null; // mappls map
let drvAnim = null, etaTimer = null;
let selRide = 1, currentEta = 4;

// ===== LOADER =====
let ldProgress = 0;
const ldInterval = setInterval(() => {
  ldProgress += Math.random() * 12;
  if (ldProgress > 88) ldProgress = 88;
  document.getElementById('ldBar').style.width = ldProgress + '%';
}, 350);

function ldText(t) { document.getElementById('ldText').textContent = t; }

function finishLoader() {
  clearInterval(ldInterval);
  document.getElementById('ldBar').style.width = '100%';
  setTimeout(() => {
    document.getElementById('loader').style.opacity = '0';
    document.getElementById('loader').style.transition = 'opacity 0.5s';
    setTimeout(() => {
      document.getElementById('loader').style.display = 'none';
      document.getElementById('topbar').style.display = 'flex';
      document.getElementById('livePill').style.display = 'flex';
      document.getElementById('locBtn').style.display = 'flex';
      document.getElementById('bsheet').style.display = 'block';
    }, 500);
  }, 600);
}

// ===== MAPPLS CALLBACK =====
window.onMapplsReady = function() {
  ldText('MapmyIndia India Map Loading...');
  mapMode = 'mappls';

  try {
    mmap = new mappls.Map('map', {
      center: DEFAULT_CENTER,
      zoom: 13,
      search: false,
      zoomControl: true,
    });

    mmap.on('load', () => {
      ldText('India Map Ready! üáÆüá≥');
      toast('üáÆüá≥ MapmyIndia map taiyaar!');
      finishLoader();
      spawnDriversMappls();
      setInterval(animDrivers, 2000);
      setTimeout(() => setPickup(DEFAULT_CENTER, 'Rajiv Chowk, New Delhi'), 400);

      // Map click to set location
      mmap.on('click', (e) => {
        if (document.getElementById('scrPick').classList.contains('on')) {
          reverseGeo([e.lngLat.lat, e.lngLat.lng], pickerType);
        }
      });
    });
  } catch(err) {
    console.warn('Mappls error, switching to Leaflet:', err);
    fallbackLeaflet();
  }
};

// ===== MAPPLS MARKERS =====
function makeMaplsCarIcon() {
  const el = document.createElement('div');
  el.innerHTML = `<div style="position:relative;width:40px;height:40px">
    <div style="position:absolute;inset:-8px;border-radius:50%;background:rgba(251,191,36,0.18);animation:carPulse 2s ease-out infinite;"></div>
    <div style="width:40px;height:40px;background:#FBBF24;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:20px;box-shadow:0 4px 16px rgba(251,191,36,0.5)">üöó</div>
  </div>`;
  return el;
}

const drvPositions = [
  [28.620, 77.210], [28.608, 77.218], [28.617, 77.197],
  [28.626, 77.204], [28.602, 77.232]
];

function spawnDriversMappls() {
  if (mapMode !== 'mappls') return;
  drvPositions.forEach(pos => {
    try {
      const m = new mappls.Marker({
        map: mmap,
        position: { lat: pos[0], lng: pos[1] },
        draggable: false,
        fitbounds: false,
      });
      drvObjs.push({ marker: m, pos: [...pos], mode: 'mappls' });
    } catch(e) {}
  });
}

function animDrivers() {
  drvObjs.forEach(d => {
    d.pos[0] += (Math.random() - 0.5) * 0.001;
    d.pos[1] += (Math.random() - 0.5) * 0.001;
    try {
      if (d.mode === 'mappls') d.marker.setPosition({ lat: d.pos[0], lng: d.pos[1] });
      else d.marker.setLatLng(d.pos);
    } catch(e) {}
  });
}

// ===== MAPPLS SET MARKERS =====
function setPickup(latlng, label) {
  puCoords = latlng;
  document.getElementById('puLbl').textContent = label || `${latlng[0].toFixed(4)}, ${latlng[1].toFixed(4)}`;
  try {
    if (mapMode === 'mappls') {
      if (puMarker) puMarker.remove();
      puMarker = new mappls.Marker({
        map: mmap,
        position: { lat: latlng[0], lng: latlng[1] },
        fitbounds: false,
      });
    } else if (mapMode === 'leaflet') {
      if (puMarker) lmap.removeLayer(puMarker);
      puMarker = L.marker(latlng, { icon: leafletIcon('green') }).addTo(lmap);
    }
  } catch(e) {}
  if (drCoords) drawRoute();
}

function setDrop(latlng, label) {
  drCoords = latlng;
  document.getElementById('drLbl').textContent = label || `${latlng[0].toFixed(4)}, ${latlng[1].toFixed(4)}`;
  try {
    if (mapMode === 'mappls') {
      if (drMarker) drMarker.remove();
      drMarker = new mappls.Marker({
        map: mmap,
        position: { lat: latlng[0], lng: latlng[1] },
        fitbounds: false,
      });
    } else if (mapMode === 'leaflet') {
      if (drMarker) lmap.removeLayer(drMarker);
      drMarker = L.marker(latlng, { icon: leafletIcon('red') }).addTo(lmap);
    }
  } catch(e) {}
  if (puCoords) drawRoute();
}

function drawRoute() {
  if (mapMode === 'leaflet') {
    if (routeLine) lmap.removeLayer(routeLine);
    const m1 = [(puCoords[0]*0.65+drCoords[0]*0.35)+(Math.random()-0.5)*0.01, (puCoords[1]*0.65+drCoords[1]*0.35)+(Math.random()-0.5)*0.01];
    const m2 = [(puCoords[0]*0.35+drCoords[0]*0.65)+(Math.random()-0.5)*0.01, (puCoords[1]*0.35+drCoords[1]*0.65)+(Math.random()-0.5)*0.01];
    routeLine = L.polyline([puCoords, m1, m2, drCoords], {
      color: '#FBBF24', weight: 5, opacity: 0.9, dashArray: '10,6', lineCap: 'round'
    }).addTo(lmap);
    let off = 0;
    if (window._ra) clearInterval(window._ra);
    window._ra = setInterval(() => { off=(off+1)%16; if(routeLine) routeLine.setStyle({dashOffset:-off}); }, 55);
    lmap.fitBounds(routeLine.getBounds(), { padding: [80, 80] });
  } else if (mapMode === 'mappls') {
    // Mappls route line
    try {
      if (routeLine) routeLine.remove();
      routeLine = new mappls.Polyline({
        map: mmap,
        path: [
          { lat: puCoords[0], lng: puCoords[1] },
          { lat: drCoords[0], lng: drCoords[1] }
        ],
        strokeColor: '#FBBF24',
        strokeOpacity: 0.9,
        strokeWeight: 5,
        fitbounds: true,
        fitboundOptions: { padding: 80 }
      });
    } catch(e) {}
  }
}

// ===== LEAFLET FALLBACK =====
function fallbackLeaflet() {
  mapMode = 'leaflet';
  ldText('Demo Map Loading...');
  lmap = L.map('map', { zoomControl: true, attributionControl: false }).setView(DEFAULT_CENTER, 13);
  L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', { maxZoom: 19, subdomains: 'abcd' }).addTo(lmap);
  lmap.on('click', e => {
    if (document.getElementById('scrPick').classList.contains('on'))
      reverseGeo([e.latlng.lat, e.latlng.lng], pickerType);
  });
  drvPositions.forEach(pos => {
    const m = L.marker(pos, { icon: leafletCarIcon() }).addTo(lmap);
    drvObjs.push({ marker: m, pos: [...pos], mode: 'leaflet' });
  });
  setInterval(animDrivers, 1800);
  setPickup(DEFAULT_CENTER, 'Rajiv Chowk, New Delhi');
  finishLoader();
  toast('‚ö†Ô∏è MapmyIndia load nahi hua ‚Äî Demo mode mein chal raha hai');
}

function leafletIcon(color) {
  const c = color === 'green' ? '#10b981' : '#ef4444';
  return L.divIcon({ className: '', html: `<div style="width:13px;height:13px;background:${c};border-radius:50%;border:3px solid white;box-shadow:0 0 10px ${c}88"></div>`, iconSize:[13,13], iconAnchor:[6,6] });
}
function leafletCarIcon() {
  return L.divIcon({ className: '', html: `<div style="position:relative;width:36px;height:36px"><div style="position:absolute;inset:-7px;border-radius:50%;background:rgba(251,191,36,0.15);animation:carPulse 2s ease-out infinite;"></div><div style="width:36px;height:36px;background:#FBBF24;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:18px;box-shadow:0 4px 12px rgba(251,191,36,0.5)">üöó</div></div>`, iconSize:[36,36], iconAnchor:[18,18] });
}

// ===== LOCATE =====
function locateMe() {
  toast('üìç Location dhundh raha hai...');
  navigator.geolocation?.getCurrentPosition(p => {
    const ll = [p.coords.latitude, p.coords.longitude];
    setPickup(ll, 'Aapki Current Location');
    if (mapMode === 'mappls') mmap.setCenter({ lat: ll[0], lng: ll[1] });
    else lmap.flyTo(ll, 15, { duration: 1.4 });
    toast('‚úÖ Location mil gayi!');
  }, () => toast('‚ùå Location permission denied'));
}

// ===== REVERSE GEOCODE =====
function reverseGeo(ll, type) {
  fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${ll[0]}&lon=${ll[1]}&accept-language=hi,en`)
    .then(r => r.json())
    .then(d => {
      const name = d.address?.road || d.address?.suburb || d.display_name.split(',')[0];
      if (type === 'pickup') setPickup(ll, name);
      else setDrop(ll, name);
      goScr('Home');
      toast(`‚úÖ ${type === 'pickup' ? 'Pickup' : 'Drop'} set: ${name}`);
    }).catch(() => {
      if (type === 'pickup') setPickup(ll);
      else setDrop(ll);
      goScr('Home');
    });
}

// ===== SCREENS =====
function goScr(name) {
  ['Home','Pick','Rides','Track'].forEach(s => {
    const el = document.getElementById('scr' + s);
    if (el) { el.classList.remove('on'); }
  });
  const target = document.getElementById('scr' + name);
  if (target) { target.classList.add('on'); }
}

// ===== QUICK PICKS =====
const qdata = {
  ghar: { n:'Ghar', lat:28.625, lon:77.210 },
  office: { n:'Office - Connaught Place', lat:28.6315, lon:77.2167 },
  airport: { n:'IGI Airport Terminal 3', lat:28.5562, lon:77.0998 },
  station: { n:'New Delhi Railway Station', lat:28.6429, lon:77.2195 },
  hospital: { n:'AIIMS New Delhi', lat:28.5672, lon:77.2100 },
  mall: { n:'Select Citywalk Saket', lat:28.5244, lon:77.2185 },
};
function qpick(k) {
  const p = qdata[k];
  setDrop([p.lat, p.lon], p.n);
  if (mapMode === 'mappls') mmap.setCenter({ lat: p.lat, lng: p.lon });
  else lmap.flyTo([p.lat, p.lon], 14, { duration: 1 });
  toast(`üéØ Drop: ${p.n}`);
}

// ===== SUGGESTIONS =====
const sugs = [
  { i:'üèõÔ∏è', n:'India Gate', a:'Rajpath, New Delhi', lat:28.6129, lon:77.2295, d:'1.2 km' },
  { i:'üõçÔ∏è', n:'Connaught Place', a:'Central Delhi', lat:28.6315, lon:77.2167, d:'2.1 km' },
  { i:'‚úàÔ∏è', n:'IGI Airport T3', a:'Dwarka, New Delhi', lat:28.5562, lon:77.0998, d:'11.4 km' },
  { i:'üè•', n:'AIIMS Hospital', a:'Ansari Nagar, New Delhi', lat:28.5672, lon:77.2100, d:'5.3 km' },
  { i:'üéì', n:'Delhi University', a:'North Campus, Delhi', lat:28.6878, lon:77.2146, d:'7.8 km' },
  { i:'üõí', n:'Select Citywalk', a:'Saket, South Delhi', lat:28.5244, lon:77.2185, d:'9.1 km' },
  { i:'üïå', n:'Jama Masjid', a:'Chandni Chowk, Old Delhi', lat:28.6507, lon:77.2334, d:'4.2 km' },
  { i:'üöâ', n:'New Delhi Railway Station', a:'Paharganj, Delhi', lat:28.6429, lon:77.2195, d:'3.0 km' },
  { i:'üåø', n:'Lodhi Garden', a:'Lodhi Road, New Delhi', lat:28.5931, lon:77.2196, d:'3.8 km' },
  { i:'üè∞', n:'Red Fort', a:'Chandni Chowk, Old Delhi', lat:28.6562, lon:77.2410, d:'5.5 km' },
  { i:'üå∏', n:'Lotus Temple', a:'Bahapur, New Delhi', lat:28.5535, lon:77.2588, d:'7.1 km' },
  { i:'üè®', n:'Taj Mahal Hotel Delhi', a:'Mansingh Road, New Delhi', lat:28.6012, lon:77.2180, d:'3.3 km' },
];

function renderSugs(list) {
  document.getElementById('suglist').innerHTML = list.map(s => `
    <div class="sugrow" onclick="pickSug(${s.lat},${s.lon},'${s.n.replace(/'/g,"\\'")}')">
      <div class="sugico">${s.i}</div>
      <div class="sugbody">
        <div class="sugname">${s.n}</div>
        <div class="sugaddr">${s.a}</div>
      </div>
      <div class="sugdist">${s.d}</div>
    </div>`).join('');
}

function openPick(type) {
  pickerType = type;
  document.getElementById('pickTitle').textContent = type === 'pickup' ? 'Pickup Set Karo' : 'Drop Set Karo';
  document.getElementById('sinp').value = '';
  renderSugs(sugs);
  goScr('Pick');
  setTimeout(() => document.getElementById('sinp').focus(), 200);
}

function filterSug(q) {
  if (!q.trim()) { renderSugs(sugs); return; }
  renderSugs(sugs.filter(s => s.n.toLowerCase().includes(q.toLowerCase()) || s.a.toLowerCase().includes(q.toLowerCase())));
}

function pickSug(lat, lon, name) {
  const ll = [lat, lon];
  if (pickerType === 'pickup') setPickup(ll, name);
  else setDrop(ll, name);
  if (mapMode === 'mappls') mmap.setCenter({ lat, lng: lon });
  else lmap.flyTo(ll, 14, { duration: 1.2 });
  goScr('Home');
  toast(`üìç ${name} set kar diya!`);
}

// ===== DISTANCE =====
function dist(a, b) {
  const R = 6371, dL = (b[0]-a[0])*Math.PI/180, dN = (b[1]-a[1])*Math.PI/180;
  const x = Math.sin(dL/2)**2 + Math.cos(a[0]*Math.PI/180)*Math.cos(b[0]*Math.PI/180)*Math.sin(dN/2)**2;
  return R * 2 * Math.atan2(Math.sqrt(x), Math.sqrt(1-x));
}

// ===== RIDE OPTIONS =====
const rides = [
  { i:'üõµ', n:'Moto', d:'1 sawari ¬∑ Sabse tez', base:11, badge:'Sabse Sasta', eta:'2 min' },
  { i:'üöó', n:'GO', d:'4 sawari ¬∑ Affordable', base:17, badge:'Popular', eta:'4 min' },
  { i:'üöô', n:'Prime Sedan', d:'4 sawari ¬∑ Aaram', base:25, badge:null, eta:'6 min' },
  { i:'üöê', n:'GO XL', d:'6 sawari ¬∑ Family', base:31, badge:null, eta:'8 min' },
];

function goRides() {
  if (!puCoords || !drCoords) {
    toast('‚ö†Ô∏è Pehle pickup aur drop set karo!');
    if (!puCoords) openPick('pickup');
    else openPick('drop');
    return;
  }
  const km = dist(puCoords, drCoords);
  document.getElementById('rfrom').textContent = document.getElementById('puLbl').textContent;
  document.getElementById('rto').textContent = document.getElementById('drLbl').textContent;
  document.getElementById('rdist').textContent = km.toFixed(1) + ' km';
  document.getElementById('tfare').textContent = '‚Çπ' + Math.round(17 * km + 40);

  document.getElementById('rlist').innerHTML = rides.map((r, i) => {
    const fare = Math.round(r.base * km + 40);
    return `<div class="ropt ${i===1?'sel':''}" id="ro${i}" onclick="selRideOpt(${i},${fare})">
      ${r.badge?`<div class="rbadge">${r.badge}</div>`:''}
      <div class="rico">${r.i}</div>
      <div style="flex:1">
        <div class="rname">${r.n}</div>
        <div class="rdesc">${r.d}</div>
        <div class="reta">üïê ${r.eta} door hai</div>
      </div>
      <div class="rprice">
        <div class="rp-amt">‚Çπ${fare}</div>
        <div class="rp-sub">${km.toFixed(1)} km</div>
      </div>
    </div>`;
  }).join('');
  goScr('Rides');
}

function selRideOpt(idx, fare) {
  document.querySelectorAll('.ropt').forEach((el,i) => el.classList.toggle('sel', i===idx));
  selRide = idx;
  document.getElementById('tfare').textContent = '‚Çπ' + fare;
}

// ===== CONFIRM RIDE =====
function confirmRide() {
  toast('üîç Driver dhundh raha hai...');
  goScr('Track');
  if (puCoords) {
    if (mapMode === 'mappls') mmap.setCenter({ lat: puCoords[0], lng: puCoords[1] });
    else lmap.flyTo(puCoords, 15, { duration: 1.4 });
  }
  // Animate driver to pickup
  if (drvObjs.length > 0) {
    const drv = drvObjs[0];
    const start = [...drv.pos];
    const target = puCoords;
    let step = 0, total = 50;
    if (drvAnim) clearInterval(drvAnim);
    drvAnim = setInterval(() => {
      step++;
      const t = step / total;
      drv.pos[0] = start[0] + (target[0]-start[0])*t;
      drv.pos[1] = start[1] + (target[1]-start[1])*t;
      try {
        if (drv.mode === 'mappls') drv.marker.setPosition({ lat: drv.pos[0], lng: drv.pos[1] });
        else drv.marker.setLatLng(drv.pos);
      } catch(e) {}
      if (step >= total) {
        clearInterval(drvAnim);
        toast('üöó Driver pickup pe pahunch gaya!');
        updStep(3);
      }
    }, 160);
  }
  currentEta = 4;
  document.getElementById('etanum').textContent = currentEta;
  if (etaTimer) clearInterval(etaTimer);
  etaTimer = setInterval(() => {
    currentEta--;
    document.getElementById('etanum').textContent = Math.max(0, currentEta);
    if (currentEta <= 0) { clearInterval(etaTimer); updStep(3); }
  }, 60000);
}

function updStep(n) {
  [1,2,3,4].forEach(i => {
    const el = document.getElementById('s'+i);
    if (i < n) el.className = 'stp done';
    else if (i === n) el.className = 'stp on';
    else el.className = 'stp';
  });
}

function cancelRide() {
  if (etaTimer) clearInterval(etaTimer);
  if (drvAnim) clearInterval(drvAnim);
  goScr('Home');
  toast('‚ùå Ride cancel ho gayi');
}

// ===== TOAST =====
function toast(msg) {
  document.querySelectorAll('.toast').forEach(t => t.remove());
  const el = document.createElement('div');
  el.className = 'toast'; el.textContent = msg;
  document.body.appendChild(el);
  setTimeout(() => el.remove(), 3200);
}

// ===== MAPPLS TIMEOUT FALLBACK =====
setTimeout(() => {
  if (mapMode === 'none') {
    console.warn('Mappls timeout ‚Äî using leaflet');
    fallbackLeaflet();
  }
}, 8000);
</script>
</body>
</html>

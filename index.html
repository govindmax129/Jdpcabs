<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>JDP CABS ‚Äî Firebase Live</title>
<link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800;900&display=swap" rel="stylesheet">

<!-- Mappls Map -->
<script src="https://apis.mappls.com/advancedmaps/api/kwzjopzmxtgmraerxyxpsrqqrxhdivkycqnc/map_sdk?layer=vector&v=3.0&callback=onMapReady" defer async></script>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<!-- Firebase -->
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
import { getFirestore, doc, setDoc, getDoc, updateDoc, collection, addDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-storage.js";

const firebaseConfig = {
  apiKey: "AIzaSyBRPV3mosWr3YFnW6xCfJaqC1bV4MhJm_Y",
  authDomain: "jdpcabs.firebaseapp.com",
  projectId: "jdpcabs",
  storageBucket: "jdpcabs.firebasestorage.app",
  messagingSenderId: "148264332732",
  appId: "1:148264332732:web:eed512ac4e685cef97cfb9",
  measurementId: "G-68X79DK95F"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);
const storage = getStorage(app);

// ‚ïê‚ïê Make Firebase globally available ‚ïê‚ïê
window.FB = { auth, db, storage, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, onAuthStateChanged, doc, setDoc, getDoc, updateDoc, collection, addDoc, serverTimestamp, ref, uploadBytes, getDownloadURL };

window.dispatchEvent(new Event('firebaseReady'));
</script>

<style>
:root {
  --bg:#0a0a0a; --card:#141414; --card2:#1c1c1c;
  --border:#252525; --text:#f1f5f9; --muted:#64748b;
  --yellow:#FBBF24; --yd:#d97706;
  --green:#10b981; --red:#ef4444; --blue:#3b82f6;
}
*{margin:0;padding:0;box-sizing:border-box;-webkit-tap-highlight-color:transparent;}
body{font-family:'Plus Jakarta Sans',sans-serif;background:var(--bg);color:var(--text);height:100vh;overflow:hidden;}
#map{width:100vw;height:100vh;position:absolute;inset:0;z-index:1;}

/* ‚ïê‚ïê LOADER ‚ïê‚ïê */
#loader{position:fixed;inset:0;background:var(--bg);z-index:9000;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:16px;}
.ld-icon{width:72px;height:72px;background:var(--yellow);border-radius:20px;display:flex;align-items:center;justify-content:center;font-size:2rem;font-weight:900;color:#000;box-shadow:0 12px 40px rgba(251,191,36,0.4);animation:ldP 2s infinite;}
@keyframes ldP{0%,100%{box-shadow:0 12px 40px rgba(251,191,36,0.4)}50%{box-shadow:0 12px 60px rgba(251,191,36,0.7)}}
.ld-name{font-size:2rem;font-weight:900;}
.ld-badge{display:flex;align-items:center;gap:6px;background:rgba(255,153,51,0.1);border:1px solid rgba(255,153,51,0.2);border-radius:100px;padding:5px 14px;font-size:0.72rem;font-weight:700;color:#FF9933;}
.ld-bar-wrap{width:220px;height:4px;background:rgba(255,255,255,0.07);border-radius:100px;overflow:hidden;}
.ld-bar{height:100%;width:0%;background:linear-gradient(90deg,var(--yellow),#f97316);border-radius:100px;transition:width 0.4s;}
.ld-txt{font-size:0.75rem;color:var(--muted);}

/* ‚ïê‚ïê AUTH ‚ïê‚ïê */
#authScreen{position:fixed;inset:0;z-index:8000;display:none;flex-direction:column;background:var(--bg);overflow-y:auto;}
#authScreen::-webkit-scrollbar{display:none;}
.auth-hero{position:relative;width:100%;height:200px;overflow:hidden;flex-shrink:0;}
.auth-hero img{width:100%;height:100%;object-fit:cover;opacity:0.45;}
.auth-hero-ov{position:absolute;inset:0;background:linear-gradient(to bottom,rgba(10,10,10,0.2),rgba(10,10,10,1));display:flex;flex-direction:column;justify-content:flex-end;padding:20px 22px 22px;}
.auth-logo{display:flex;align-items:center;gap:12px;margin-bottom:8px;}
.auth-logo-box{width:44px;height:44px;background:var(--yellow);border-radius:13px;display:flex;align-items:center;justify-content:center;font-weight:900;font-size:13px;color:#000;}
.auth-logo-name{font-size:1.5rem;font-weight:900;}
.auth-tagline{font-size:0.8rem;color:rgba(255,255,255,0.6);}
.auth-body{padding:0 18px 40px;}

.role-toggle{display:flex;background:rgba(255,255,255,0.05);border:1px solid var(--border);border-radius:14px;padding:4px;margin-bottom:16px;}
.rtab{flex:1;padding:11px;border-radius:10px;border:none;background:transparent;color:var(--muted);font-family:'Plus Jakarta Sans',sans-serif;font-size:0.85rem;font-weight:700;cursor:pointer;transition:all 0.25s;display:flex;align-items:center;justify-content:center;gap:6px;}
.rtab.active.r{background:var(--yellow);color:#000;}
.rtab.active.d{background:var(--green);color:#fff;}

.auth-tabs{display:flex;gap:4px;margin-bottom:18px;background:rgba(255,255,255,0.04);border:1px solid var(--border);border-radius:12px;padding:4px;}
.atab{flex:1;padding:10px;border-radius:9px;border:none;background:transparent;color:var(--muted);font-family:'Plus Jakarta Sans',sans-serif;font-size:0.84rem;font-weight:700;cursor:pointer;transition:all 0.25s;}
.atab.active{background:var(--card2);color:var(--text);box-shadow:0 2px 8px rgba(0,0,0,0.3);}

.auth-form{display:none;}
.auth-form.show{display:block;animation:fUp 0.3s ease;}
@keyframes fUp{from{opacity:0;transform:translateY(12px)}to{opacity:1;transform:translateY(0)}}

.fg{margin-bottom:13px;}
.fl{font-size:0.68rem;font-weight:700;letter-spacing:1.5px;text-transform:uppercase;color:var(--muted);margin-bottom:6px;display:block;}
.fi{width:100%;background:rgba(255,255,255,0.05);border:1.5px solid var(--border);border-radius:12px;padding:13px 15px;color:var(--text);font-family:'Plus Jakarta Sans',sans-serif;font-size:0.9rem;font-weight:500;outline:none;transition:border-color 0.2s;}
.fi:focus{border-color:var(--yellow);}
.fi.gf:focus{border-color:var(--green);}
.fi::placeholder{color:var(--muted);}
.frow{display:grid;grid-template-columns:1fr 1fr;gap:11px;}
.ferr{display:none;font-size:0.73rem;color:var(--red);margin-top:5px;font-weight:600;}
.ferr.on{display:block;}

/* Upload Box */
.ubox{border:1.5px dashed var(--border);border-radius:12px;padding:18px;text-align:center;cursor:pointer;transition:all 0.2s;margin-bottom:12px;background:rgba(255,255,255,0.02);}
.ubox:hover{border-color:var(--green);background:rgba(16,185,129,0.04);}
.ubox.done{border-color:var(--green);background:rgba(16,185,129,0.06);}
.ubox-ico{font-size:1.7rem;margin-bottom:6px;}
.ubox-title{font-size:0.83rem;font-weight:700;margin-bottom:3px;}
.ubox-sub{font-size:0.7rem;color:var(--muted);}
.ubox-progress{height:4px;background:rgba(255,255,255,0.07);border-radius:100px;margin-top:10px;overflow:hidden;display:none;}
.ubox-progress.on{display:block;}
.ubox-prog-bar{height:100%;background:var(--green);border-radius:100px;width:0%;transition:width 0.3s;}

/* Vehicle type */
.vgrid{display:grid;grid-template-columns:1fr 1fr;gap:9px;margin-bottom:13px;}
.vcard{background:rgba(255,255,255,0.04);border:1.5px solid var(--border);border-radius:12px;padding:12px;text-align:center;cursor:pointer;transition:all 0.2s;}
.vcard.sel{border-color:var(--green);background:rgba(16,185,129,0.07);}
.vcard-ico{font-size:1.7rem;margin-bottom:5px;}
.vcard-name{font-size:0.76rem;font-weight:700;}

.auth-submit{width:100%;border:none;border-radius:14px;padding:16px;font-size:0.97rem;font-weight:800;cursor:pointer;transition:all 0.2s;font-family:'Plus Jakarta Sans',sans-serif;margin-top:4px;display:flex;align-items:center;justify-content:center;gap:8px;}
.auth-submit.y{background:var(--yellow);color:#000;}
.auth-submit.y:hover{background:var(--yd);transform:translateY(-1px);}
.auth-submit.g{background:var(--green);color:#fff;}
.auth-submit.g:hover{background:#0da271;transform:translateY(-1px);}
.auth-submit:disabled{opacity:0.6;cursor:not-allowed;transform:none;}

.auth-switch{text-align:center;margin-top:14px;font-size:0.8rem;color:var(--muted);}
.auth-switch span{font-weight:700;cursor:pointer;}
.auth-switch span.y{color:var(--yellow);}
.auth-switch span.g{color:var(--green);}

.auth-divider{display:flex;align-items:center;gap:10px;margin:14px 0;}
.auth-divider::before,.auth-divider::after{content:'';flex:1;height:1px;background:var(--border);}
.auth-divider span{font-size:0.7rem;color:var(--muted);}

/* OTP */
.otp-screen{display:none;text-align:center;padding:8px 0;}
.otp-screen.show{display:block;animation:fUp 0.3s ease;}
.otp-inputs{display:flex;gap:9px;justify-content:center;margin:18px 0;}
.oi{width:50px;height:54px;background:rgba(255,255,255,0.06);border:1.5px solid var(--border);border-radius:12px;text-align:center;font-size:1.4rem;font-weight:800;color:var(--text);outline:none;transition:border-color 0.2s;font-family:'Plus Jakarta Sans',sans-serif;}
.oi:focus{border-color:var(--yellow);}

/* Firebase status badge */
.fb-badge{display:inline-flex;align-items:center;gap:5px;background:rgba(255,165,0,0.1);border:1px solid rgba(255,165,0,0.2);border-radius:100px;padding:4px 10px;font-size:0.65rem;font-weight:700;color:orange;margin-bottom:14px;}
.fb-badge.ok{background:rgba(16,185,129,0.1);border-color:rgba(16,185,129,0.2);color:var(--green);}

/* ‚ïê‚ïê TOP BAR ‚ïê‚ïê */
.topbar{position:fixed;top:0;left:0;right:0;z-index:500;display:flex;justify-content:space-between;align-items:center;padding:12px 16px;background:linear-gradient(to bottom,rgba(0,0,0,0.85) 0%,transparent 100%);}
.logo-wrap{display:flex;align-items:center;gap:9px;}
.logo-box{width:40px;height:40px;background:var(--yellow);border-radius:12px;display:flex;align-items:center;justify-content:center;font-weight:900;font-size:12px;color:#000;}
.logo-title{font-size:1.1rem;font-weight:900;color:white;}
.mode-tag{border-radius:100px;padding:3px 9px;font-size:0.6rem;font-weight:800;letter-spacing:0.5px;text-transform:uppercase;}
.mode-tag.r{background:rgba(251,191,36,0.15);border:1px solid rgba(251,191,36,0.3);color:var(--yellow);}
.mode-tag.d{background:rgba(16,185,129,0.15);border:1px solid rgba(16,185,129,0.3);color:var(--green);}
.topbtn{height:38px;background:rgba(0,0,0,0.5);backdrop-filter:blur(12px);border:1px solid rgba(255,255,255,0.1);border-radius:10px;display:flex;align-items:center;justify-content:center;cursor:pointer;font-size:0.85rem;transition:all 0.2s;padding:0 12px;font-weight:700;}
.topbtn:hover{border-color:var(--yellow);}
.prof-chip{display:flex;align-items:center;gap:8px;background:rgba(255,255,255,0.06);border:1px solid var(--border);border-radius:100px;padding:4px 12px 4px 4px;cursor:pointer;}
.prof-av{width:30px;height:30px;border-radius:50%;overflow:hidden;border:2px solid var(--yellow);}
.prof-av img{width:100%;height:100%;object-fit:cover;}
.prof-name{font-size:0.76rem;font-weight:700;max-width:80px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}

/* ‚ïê‚ïê LIVE PILL ‚ïê‚ïê */
.live-pill{position:fixed;top:72px;left:50%;transform:translateX(-50%);z-index:500;background:rgba(16,185,129,0.12);border:1px solid rgba(16,185,129,0.25);border-radius:100px;padding:6px 14px;font-size:0.68rem;font-weight:700;color:var(--green);display:flex;align-items:center;gap:6px;backdrop-filter:blur(12px);white-space:nowrap;}
.ldot{width:6px;height:6px;background:var(--green);border-radius:50%;animation:blink 1s infinite;}
@keyframes blink{0%,100%{opacity:1}50%{opacity:0.2}}

.locate-btn{position:fixed;right:16px;z-index:500;width:46px;height:46px;background:white;border-radius:50%;border:none;cursor:pointer;font-size:1.1rem;box-shadow:0 4px 18px rgba(0,0,0,0.35);display:flex;align-items:center;justify-content:center;transition:transform 0.2s;}
.locate-btn:hover{transform:scale(1.1);}

/* ‚ïê‚ïê DUTY BTN ‚ïê‚ïê */
.duty-wrap{position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:500;display:flex;flex-direction:column;align-items:center;gap:12px;pointer-events:none;}
.duty-btn{width:130px;height:130px;border-radius:50%;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:6px;cursor:pointer;pointer-events:all;transition:all 0.4s cubic-bezier(0.16,1,0.3,1);position:relative;border:none;font-family:'Plus Jakarta Sans',sans-serif;}
.duty-btn.off{background:rgba(20,20,20,0.9);border:3px solid #333;color:var(--muted);box-shadow:0 8px 32px rgba(0,0,0,0.5);}
.duty-btn.on{background:var(--green);border:3px solid rgba(255,255,255,0.2);color:white;box-shadow:0 12px 48px rgba(16,185,129,0.5);transform:scale(1.05);}
.duty-ico{font-size:2rem;}.duty-txt{font-size:0.68rem;font-weight:800;letter-spacing:2px;text-transform:uppercase;}
.radar{position:absolute;inset:-14px;border-radius:50%;border:2px solid rgba(16,185,129,0.4);animation:radar 1.8s ease-out infinite;}
.radar2{position:absolute;inset:-28px;border-radius:50%;border:2px solid rgba(16,185,129,0.2);animation:radar 1.8s ease-out 0.6s infinite;}
@keyframes radar{0%{transform:scale(0.8);opacity:1}100%{transform:scale(1.35);opacity:0}}
.duty-hint{font-size:0.72rem;color:rgba(255,255,255,0.4);font-weight:600;pointer-events:all;text-align:center;}

/* ‚ïê‚ïê BOTTOM SHEET ‚ïê‚ïê */
.bsheet{position:fixed;bottom:0;left:0;right:0;z-index:400;background:rgba(10,10,10,0.97);backdrop-filter:blur(28px);border-radius:24px 24px 0 0;border-top:1px solid rgba(255,255,255,0.07);padding:0 18px 30px;max-height:80vh;overflow-y:auto;}
.bsheet::-webkit-scrollbar{display:none;}
.handle{width:36px;height:4px;background:rgba(255,255,255,0.12);border-radius:4px;margin:12px auto 18px;}
.scr{display:none;}.scr.on{display:block;animation:fUp 0.3s ease;}

/* ‚ïê‚ïê SHARED ‚ïê‚ïê */
.shdr{display:flex;justify-content:space-between;align-items:center;margin-bottom:16px;}
.stitle{font-size:1.05rem;font-weight:800;}
.sback{font-size:0.8rem;color:var(--muted);cursor:pointer;padding:6px 12px;border-radius:8px;transition:all 0.2s;}
.sback:hover{color:var(--yellow);}
.mbtn{width:100%;border:none;border-radius:15px;padding:16px;font-size:0.96rem;font-weight:800;cursor:pointer;transition:all 0.2s;font-family:'Plus Jakarta Sans',sans-serif;}
.mbtn.y{background:var(--yellow);color:#000;}.mbtn.y:hover{background:var(--yd);transform:translateY(-1px);}
.mbtn.g{background:var(--green);color:#fff;}.mbtn.g:hover{background:#0da271;transform:translateY(-1px);}
.mbtn.ro{background:rgba(239,68,68,0.08);color:var(--red);border:1px solid rgba(239,68,68,0.2);}
.mbtn.ghost{background:rgba(255,255,255,0.04);border:1px solid var(--border);color:var(--text);margin-top:10px;}

/* ‚ïê‚ïê RIDER UI ‚ïê‚ïê */
.wlbl{font-size:0.65rem;font-weight:800;letter-spacing:2px;text-transform:uppercase;color:var(--muted);margin-bottom:12px;}
.loc-boxes{display:flex;flex-direction:column;gap:9px;margin-bottom:15px;}
.loc-box{display:flex;align-items:center;gap:12px;background:rgba(255,255,255,0.04);border:1.5px solid rgba(255,255,255,0.07);border-radius:14px;padding:12px 14px;cursor:pointer;transition:all 0.2s;}
.loc-box:hover{border-color:var(--yellow);}
.ldg{width:10px;height:10px;border-radius:50%;background:var(--green);box-shadow:0 0 8px rgba(16,185,129,0.7);flex-shrink:0;}
.ldr{width:10px;height:10px;border-radius:50%;background:var(--red);box-shadow:0 0 8px rgba(239,68,68,0.7);flex-shrink:0;}
.lbl-main{font-weight:600;font-size:0.87rem;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
.lbl-sub{font-size:0.7rem;color:var(--muted);margin-top:2px;}
.qpicks{display:flex;gap:7px;margin-bottom:15px;overflow-x:auto;padding-bottom:2px;}
.qpicks::-webkit-scrollbar{display:none;}
.qchip{display:flex;align-items:center;gap:5px;background:rgba(255,255,255,0.05);border:1px solid rgba(255,255,255,0.08);border-radius:100px;padding:7px 12px;font-size:0.75rem;font-weight:600;white-space:nowrap;cursor:pointer;transition:all 0.2s;}
.qchip:hover{border-color:var(--yellow);color:var(--yellow);}

.sinp-wrap{position:relative;margin-bottom:12px;}
.sinp-ico{position:absolute;left:13px;top:50%;transform:translateY(-50%);font-size:0.9rem;}
.sinp{width:100%;background:rgba(255,255,255,0.06);border:1.5px solid rgba(255,255,255,0.09);border-radius:13px;padding:13px 14px 13px 38px;color:white;font-family:'Plus Jakarta Sans',sans-serif;font-size:0.9rem;font-weight:500;outline:none;transition:border-color 0.2s;}
.sinp:focus{border-color:var(--yellow);}
.sinp::placeholder{color:var(--muted);}
.suglist{display:flex;flex-direction:column;gap:1px;}
.sugrow{display:flex;align-items:center;gap:12px;padding:11px 10px;border-radius:11px;cursor:pointer;transition:background 0.18s;}
.sugrow:hover{background:rgba(255,255,255,0.05);}
.sugico{width:40px;height:40px;background:rgba(255,255,255,0.05);border-radius:10px;display:flex;align-items:center;justify-content:center;font-size:1rem;flex-shrink:0;}
.sugname{font-weight:600;font-size:0.86rem;}
.sugaddr{font-size:0.71rem;color:var(--muted);margin-top:1px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
.sugdist{font-size:0.7rem;color:var(--yellow);font-weight:700;white-space:nowrap;}

.rbar{display:flex;align-items:center;gap:10px;background:rgba(255,255,255,0.04);border-radius:12px;padding:12px 14px;margin-bottom:13px;}
.rline{display:flex;flex-direction:column;align-items:center;gap:2px;}
.rg{width:8px;height:8px;border-radius:50%;background:var(--green);}
.rr{width:8px;height:8px;border-radius:50%;background:var(--red);}
.rdashes{display:flex;flex-direction:column;gap:2px;}
.rdash{width:2px;height:4px;background:var(--muted);border-radius:1px;}
.rfrom{font-size:0.82rem;font-weight:600;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
.rto{font-size:0.82rem;color:var(--muted);margin-top:7px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
.ropt{display:flex;align-items:center;gap:13px;padding:12px;border:1.5px solid rgba(255,255,255,0.06);border-radius:15px;cursor:pointer;transition:all 0.22s;margin-bottom:8px;position:relative;}
.ropt.sel{border-color:var(--yellow);background:rgba(251,191,36,0.05);}
.ropt:hover{border-color:rgba(251,191,36,0.35);}
.rico{width:52px;height:40px;background:rgba(255,255,255,0.05);border-radius:10px;display:flex;align-items:center;justify-content:center;font-size:1.4rem;flex-shrink:0;}
.rname{font-weight:700;font-size:0.9rem;}.rdesc{font-size:0.71rem;color:var(--muted);margin-top:2px;}.reta{font-size:0.71rem;color:var(--green);font-weight:700;margin-top:4px;}
.rprice{text-align:right;}.rp-amt{font-size:1.05rem;font-weight:800;}.rp-sub{font-size:0.67rem;color:var(--muted);}
.rbadge{position:absolute;top:-8px;right:12px;background:var(--green);color:white;font-size:0.58rem;font-weight:700;padding:2px 8px;border-radius:100px;text-transform:uppercase;}
.payrow{display:flex;align-items:center;justify-content:space-between;background:rgba(255,255,255,0.04);border-radius:12px;padding:12px 14px;margin:12px 0;}
.payl{display:flex;align-items:center;gap:10px;font-size:0.85rem;font-weight:600;}

.etabar{display:flex;justify-content:space-between;align-items:center;background:rgba(16,185,129,0.09);border:1px solid rgba(16,185,129,0.2);border-radius:14px;padding:16px;margin-bottom:13px;}
.etanum{font-size:2.4rem;font-weight:900;color:var(--green);line-height:1;}
.etalbl{font-size:0.7rem;color:var(--muted);margin-top:4px;}
.etasteps{display:flex;flex-direction:column;gap:5px;text-align:right;}
.stp{font-size:0.74rem;color:var(--muted);}
.stp.on{color:var(--text);font-weight:700;}.stp.done{color:var(--green);text-decoration:line-through;opacity:0.6;}
.dcard{display:flex;align-items:center;gap:13px;background:rgba(255,255,255,0.04);border:1px solid rgba(255,255,255,0.06);border-radius:15px;padding:14px;margin-bottom:13px;}
.dav{width:50px;height:50px;border-radius:50%;overflow:hidden;flex-shrink:0;border:2px solid var(--yellow);}
.dav img{width:100%;height:100%;object-fit:cover;}
.dname{font-weight:700;font-size:0.9rem;}.dcar{font-size:0.72rem;color:var(--muted);margin-top:2px;}.drating{font-size:0.72rem;color:var(--yellow);font-weight:700;margin-top:3px;}
.dbtns{display:flex;gap:8px;}
.dbtn{width:40px;height:40px;border-radius:50%;border:1px solid rgba(255,255,255,0.1);background:rgba(255,255,255,0.05);display:flex;align-items:center;justify-content:center;font-size:1rem;cursor:pointer;transition:all 0.2s;}
.dbtn:hover{border-color:var(--yellow);}

/* ‚ïê‚ïê DRIVER UI ‚ïê‚ïê */
.stats-row{display:grid;grid-template-columns:1fr 1fr 1fr;gap:10px;margin-bottom:16px;}
.stat-box{background:rgba(255,255,255,0.04);border:1px solid rgba(255,255,255,0.06);border-radius:14px;padding:14px 10px;text-align:center;}
.stat-num{font-size:1.4rem;font-weight:900;color:var(--yellow);}
.stat-lbl{font-size:0.63rem;color:var(--muted);margin-top:4px;text-transform:uppercase;letter-spacing:0.5px;}
.icard{display:flex;align-items:center;gap:12px;background:rgba(255,255,255,0.04);border:1px solid rgba(255,255,255,0.06);border-radius:14px;padding:14px;margin-bottom:10px;}
.icard-ico{width:44px;height:44px;border-radius:12px;display:flex;align-items:center;justify-content:center;font-size:1.3rem;flex-shrink:0;}
.ic-y{background:rgba(251,191,36,0.12);}.ic-g{background:rgba(16,185,129,0.12);}.ic-b{background:rgba(59,130,246,0.12);}
.icard-body{flex:1;}.icard-title{font-weight:700;font-size:0.87rem;}.icard-sub{font-size:0.72rem;color:var(--muted);margin-top:2px;}
.icard-val{font-weight:800;font-size:0.98rem;text-align:right;}

/* Popup */
.popup{position:fixed;bottom:0;left:0;right:0;z-index:700;background:rgba(8,8,8,0.99);backdrop-filter:blur(28px);border-radius:24px 24px 0 0;border-top:2px solid var(--yellow);padding:0 18px 32px;transform:translateY(100%);transition:transform 0.4s cubic-bezier(0.16,1,0.3,1);}
.popup.show{transform:translateY(0);}
.pop-handle{width:36px;height:4px;background:rgba(255,255,255,0.15);border-radius:4px;margin:12px auto 16px;}
.alert-pill{display:flex;align-items:center;gap:8px;background:rgba(251,191,36,0.1);border:1px solid rgba(251,191,36,0.25);border-radius:100px;padding:7px 14px;margin-bottom:14px;width:fit-content;}
.alert-dot{width:8px;height:8px;background:var(--yellow);border-radius:50%;animation:blink 0.6s infinite;}
.alert-pill span{font-size:0.72rem;font-weight:800;color:var(--yellow);text-transform:uppercase;letter-spacing:1px;}
.pop-fare{text-align:center;margin-bottom:16px;}
.pop-fare-num{font-size:3rem;font-weight:900;color:var(--yellow);line-height:1;}
.pop-fare-lbl{font-size:0.73rem;color:var(--muted);margin-top:4px;}
.timer-wrap{background:rgba(255,255,255,0.05);border-radius:100px;height:5px;margin-bottom:16px;overflow:hidden;}
.timer-bar{height:100%;background:var(--yellow);border-radius:100px;width:100%;transition:width 0.5s linear;}
.pop-route{display:flex;align-items:center;gap:12px;background:rgba(255,255,255,0.04);border-radius:13px;padding:13px;margin-bottom:12px;}
.pop-rg{width:10px;height:10px;border-radius:50%;background:var(--green);}
.pop-rr{width:10px;height:10px;border-radius:50%;background:var(--red);}
.pop-rdash{width:2px;height:5px;background:var(--muted);border-radius:1px;}
.pop-from{font-weight:700;font-size:0.87rem;}.pop-to{font-size:0.83rem;color:var(--muted);margin-top:8px;}
.pop-details{display:flex;gap:10px;margin-bottom:14px;}
.pop-det{flex:1;background:rgba(255,255,255,0.04);border-radius:11px;padding:11px;text-align:center;}
.pop-det-val{font-weight:800;font-size:0.95rem;}.pop-det-lbl{font-size:0.67rem;color:var(--muted);margin-top:3px;}
.pop-rider{display:flex;align-items:center;gap:12px;background:rgba(255,255,255,0.04);border-radius:12px;padding:12px 14px;margin-bottom:16px;}
.pop-av{width:42px;height:42px;border-radius:50%;overflow:hidden;flex-shrink:0;border:2px solid var(--yellow);}
.pop-av img{width:100%;height:100%;object-fit:cover;}
.pop-btns{display:flex;gap:12px;}
.pop-btn-dec{flex:1;background:rgba(239,68,68,0.08);color:var(--red);border:1px solid rgba(239,68,68,0.2);border-radius:13px;padding:15px;font-weight:700;font-size:0.9rem;cursor:pointer;transition:all 0.2s;font-family:'Plus Jakarta Sans',sans-serif;}
.pop-btn-acc{flex:2;background:var(--green);color:white;border:none;border-radius:13px;padding:15px;font-weight:800;font-size:0.98rem;cursor:pointer;transition:all 0.2s;font-family:'Plus Jakarta Sans',sans-serif;box-shadow:0 8px 24px rgba(16,185,129,0.35);}
.pop-btn-acc:hover{background:#0da271;transform:translateY(-1px);}

.navcard{display:flex;align-items:center;gap:12px;background:rgba(59,130,246,0.08);border:1px solid rgba(59,130,246,0.2);border-radius:14px;padding:14px;margin-bottom:13px;}
.trip-fare-row{display:flex;align-items:center;justify-content:space-between;background:rgba(255,255,255,0.04);border-radius:12px;padding:12px 14px;margin-bottom:13px;}
.earn-total{text-align:center;padding:8px 0 18px;}
.earn-amt{font-size:3.2rem;font-weight:900;color:var(--yellow);line-height:1;}
.earn-lbl{font-size:0.73rem;color:var(--muted);margin-top:5px;}
.earn-grid{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:16px;}
.earn-box{background:rgba(255,255,255,0.04);border:1px solid rgba(255,255,255,0.07);border-radius:14px;padding:15px;}
.earn-box-num{font-size:1.5rem;font-weight:900;}
.earn-box-lbl{font-size:0.67rem;color:var(--muted);margin-top:4px;text-transform:uppercase;letter-spacing:0.5px;}
.hist-list{display:flex;flex-direction:column;gap:9px;}
.hist-row{display:flex;align-items:center;gap:12px;background:rgba(255,255,255,0.03);border:1px solid rgba(255,255,255,0.06);border-radius:12px;padding:12px 14px;}
.hist-ico{width:38px;height:38px;background:rgba(251,191,36,0.1);border-radius:10px;display:flex;align-items:center;justify-content:center;font-size:1rem;flex-shrink:0;}
.hist-from{font-weight:600;font-size:0.83rem;}
.hist-time{font-size:0.7rem;color:var(--muted);margin-top:2px;}
.hist-amt{font-weight:800;font-size:0.95rem;color:var(--yellow);}

/* Profile screen */
.prof-screen{display:none;position:fixed;inset:0;z-index:600;background:rgba(10,10,10,0.98);backdrop-filter:blur(20px);overflow-y:auto;padding:20px;}
.prof-screen.show{display:block;animation:fUp 0.3s ease;}
.prof-screen::-webkit-scrollbar{display:none;}
.prof-header{display:flex;align-items:center;justify-content:space-between;margin-bottom:24px;}
.prof-av-big{width:80px;height:80px;border-radius:50%;overflow:hidden;border:3px solid var(--yellow);margin:0 auto 12px;display:block;}
.prof-av-big img{width:100%;height:100%;object-fit:cover;}
.prof-info-card{background:var(--card2);border:1px solid var(--border);border-radius:16px;padding:20px;margin-bottom:14px;}
.prof-field{display:flex;justify-content:space-between;align-items:center;padding:10px 0;border-bottom:1px solid rgba(255,255,255,0.05);}
.prof-field:last-child{border-bottom:none;}
.pf-label{font-size:0.73rem;color:var(--muted);font-weight:600;}
.pf-value{font-size:0.85rem;font-weight:700;text-align:right;max-width:200px;word-break:break-all;}
.doc-card{background:var(--card2);border:1px solid var(--border);border-radius:14px;padding:16px;margin-bottom:10px;display:flex;align-items:center;gap:12px;}
.doc-status{font-size:0.72rem;font-weight:700;padding:3px 10px;border-radius:100px;}
.doc-status.ok{background:rgba(16,185,129,0.1);color:var(--green);}
.doc-status.pending{background:rgba(251,191,36,0.1);color:var(--yellow);}

.toast{position:fixed;top:84px;left:50%;transform:translateX(-50%);background:rgba(20,20,20,0.97);border:1px solid rgba(255,255,255,0.09);border-radius:100px;padding:10px 20px;font-size:0.8rem;font-weight:600;z-index:9999;backdrop-filter:blur(16px);animation:tin 0.3s ease,tout 0.3s ease 2.6s forwards;white-space:nowrap;pointer-events:none;}
@keyframes tin{from{opacity:0;top:64px}to{opacity:1;top:84px}}
@keyframes tout{to{opacity:0}}
@keyframes carPulse{0%{transform:scale(0.8);opacity:1}100%{transform:scale(2.2);opacity:0}}
</style>
</head>
<body>

<!-- LOADER -->
<div id="loader">
  <div class="ld-icon">JDP</div>
  <div class="ld-name">CABS</div>
  <div class="ld-badge">üî• Firebase + üáÆüá≥ MapmyIndia</div>
  <div class="ld-bar-wrap"><div class="ld-bar" id="ldBar"></div></div>
  <div class="ld-txt" id="ldTxt">Firebase se connect ho raha hai...</div>
</div>

<!-- MAP -->
<div id="map"></div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê AUTH SCREEN ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div id="authScreen">
  <div class="auth-hero">
    <img src="https://images.unsplash.com/photo-1449965408869-eaa3f722e40d?auto=format&fit=crop&w=800&q=80">
    <div class="auth-hero-ov">
      <div class="auth-logo"><div class="auth-logo-box">JDP</div><div class="auth-logo-name">CABS</div></div>
      <div class="auth-tagline">üáÆüá≥ India ka best cab app ‚Äî Firebase Powered üî•</div>
    </div>
  </div>

  <div class="auth-body">
    <div class="fb-badge" id="fbBadge">‚è≥ Firebase connect ho raha hai...</div>

    <!-- Role Toggle -->
    <div class="role-toggle">
      <button class="rtab active r" id="rTab" onclick="setAuthRole('rider')">üßç Rider hoon</button>
      <button class="rtab d" id="dTab" onclick="setAuthRole('driver')">üöó Driver hoon</button>
    </div>

    <!-- Login / Register Tabs -->
    <div class="auth-tabs">
      <button class="atab active" id="loginTab" onclick="setAuthTab('login')">Login Karo</button>
      <button class="atab" id="regTab" onclick="setAuthTab('register')">Naya Account</button>
    </div>

    <!-- LOGIN FORM -->
    <div class="auth-form show" id="loginForm">
      <div class="fg">
        <label class="fl">üì± Mobile Number / Email</label>
        <input type="text" class="fi" id="loginId" placeholder="+91 98765 43210 ya email">
        <div class="ferr" id="loginIdErr">Valid mobile ya email daalo</div>
      </div>
      <div class="fg">
        <label class="fl">üîí Password</label>
        <input type="password" class="fi" id="loginPass" placeholder="Apna password">
        <div class="ferr" id="loginPassErr">Password galat hai</div>
      </div>
      <div style="text-align:right;margin-bottom:14px">
        <span style="font-size:0.78rem;color:var(--yellow);cursor:pointer;font-weight:600">Password bhool gaye? ‚Üí</span>
      </div>
      <button class="auth-submit y" id="loginBtn" onclick="doLogin()">üöÄ Login Karo</button>
      <div class="auth-switch">Account nahi hai? <span class="y" onclick="setAuthTab('register')">Register karo</span></div>
    </div>

    <!-- RIDER REGISTER FORM -->
    <div class="auth-form" id="riderRegForm">
      <div class="frow">
        <div class="fg"><label class="fl">üë§ Pehla Naam</label><input type="text" class="fi" id="rFn" placeholder="Rahul"><div class="ferr" id="rFnErr">Naam daalo</div></div>
        <div class="fg"><label class="fl">üë§ Aakhri Naam</label><input type="text" class="fi" id="rLn" placeholder="Sharma"></div>
      </div>
      <div class="fg"><label class="fl">üì± Mobile Number</label><input type="tel" class="fi" id="rPhone" placeholder="+91 98765 43210"><div class="ferr" id="rPhoneErr">Valid number daalo</div></div>
      <div class="fg"><label class="fl">üìß Email</label><input type="email" class="fi" id="rEmail" placeholder="rahul@email.com"><div class="ferr" id="rEmailErr">Valid email daalo</div></div>
      <div class="frow">
        <div class="fg"><label class="fl">üîí Password</label><input type="password" class="fi" id="rPass" placeholder="Min 6 chars"><div class="ferr" id="rPassErr">Min 6 characters</div></div>
        <div class="fg"><label class="fl">üîí Confirm</label><input type="password" class="fi" id="rConf" placeholder="Dobara daalo"><div class="ferr" id="rConfErr">Match nahi</div></div>
      </div>
      <div class="fg"><label class="fl">üéÇ Date of Birth</label><input type="date" class="fi" id="rDob"></div>
      <button class="auth-submit y" id="riderRegBtn" onclick="doRiderRegister()">‚úÖ Rider Account Banao</button>
      <div class="auth-switch">Pehle se account hai? <span class="y" onclick="setAuthTab('login')">Login karo</span></div>
    </div>

    <!-- DRIVER REGISTER FORM -->
    <div class="auth-form" id="driverRegForm">
      <div class="frow">
        <div class="fg"><label class="fl">üë§ Pehla Naam</label><input type="text" class="fi gf" id="dFn" placeholder="Ramesh"><div class="ferr" id="dFnErr">Naam daalo</div></div>
        <div class="fg"><label class="fl">üë§ Aakhri Naam</label><input type="text" class="fi gf" id="dLn" placeholder="Kumar"></div>
      </div>
      <div class="fg"><label class="fl">üì± Mobile Number</label><input type="tel" class="fi gf" id="dPhone" placeholder="+91 98765 43210"><div class="ferr" id="dPhoneErr">Valid number daalo</div></div>
      <div class="fg"><label class="fl">üìß Email (Login ke liye)</label><input type="email" class="fi gf" id="dEmail" placeholder="ramesh@email.com"><div class="ferr" id="dEmailErr">Valid email daalo</div></div>
      <div class="fg"><label class="fl">ü™™ Aadhaar Number</label><input type="text" class="fi gf" id="dAadhaar" placeholder="1234 5678 9012" maxlength="14"><div class="ferr" id="dAadhaarErr">12-digit Aadhaar daalo</div></div>
      <div class="fg"><label class="fl">üöó Driving Licence</label><input type="text" class="fi gf" id="dLic" placeholder="DL-0420110012345"><div class="ferr" id="dLicErr">Licence number daalo</div></div>
      <div class="fg"><label class="fl">üöò Vehicle Number</label><input type="text" class="fi gf" id="dVeh" placeholder="DL 4C AZ 1234"></div>

      <div class="fg">
        <label class="fl">üöò Vehicle Type</label>
        <div class="vgrid">
          <div class="vcard sel" onclick="selV(this,'Moto')"><div class="vcard-ico">üõµ</div><div class="vcard-name">Moto/Bike</div></div>
          <div class="vcard" onclick="selV(this,'Auto')"><div class="vcard-ico">üõ∫</div><div class="vcard-name">Auto Rickshaw</div></div>
          <div class="vcard" onclick="selV(this,'Hatchback')"><div class="vcard-ico">üöó</div><div class="vcard-name">Hatchback</div></div>
          <div class="vcard" onclick="selV(this,'Sedan')"><div class="vcard-ico">üöô</div><div class="vcard-name">Sedan/SUV</div></div>
        </div>
      </div>

      <!-- Document Uploads -->
      <div class="fg"><label class="fl">üìÑ Documents Upload</label>
        <div class="ubox" id="licBox" onclick="uploadDoc('lic','Driving Licence','licBox')">
          <div class="ubox-ico" id="licIco">üìÑ</div>
          <div class="ubox-title" id="licTitle">Driving Licence Upload Karo</div>
          <div class="ubox-sub">JPG, PNG, PDF ‚Äî Max 5MB</div>
          <input type="file" id="licFile" accept=".jpg,.jpeg,.png,.pdf" style="display:none" onchange="handleFile('lic',this)">
          <div class="ubox-progress" id="licProg"><div class="ubox-prog-bar" id="licProgBar"></div></div>
        </div>
        <div class="ubox" id="aadhaarBox" onclick="uploadDoc('aadhaar','Aadhaar Card','aadhaarBox')">
          <div class="ubox-ico" id="aadhaarIco">ü™™</div>
          <div class="ubox-title" id="aadhaarTitle">Aadhaar Card Upload Karo</div>
          <div class="ubox-sub">JPG, PNG, PDF ‚Äî Max 5MB</div>
          <input type="file" id="aadhaarFile" accept=".jpg,.jpeg,.png,.pdf" style="display:none" onchange="handleFile('aadhaar',this)">
          <div class="ubox-progress" id="aadhaarProg"><div class="ubox-prog-bar" id="aadhaarProgBar"></div></div>
        </div>
      </div>

      <div class="frow">
        <div class="fg"><label class="fl">üîí Password</label><input type="password" class="fi gf" id="dPass" placeholder="Min 6 chars"><div class="ferr" id="dPassErr">Min 6 characters</div></div>
        <div class="fg"><label class="fl">üîí Confirm</label><input type="password" class="fi gf" id="dConf" placeholder="Dobara daalo"><div class="ferr" id="dConfErr">Match nahi</div></div>
      </div>
      <button class="auth-submit g" id="driverRegBtn" onclick="doDriverRegister()">‚úÖ Driver Account Banao</button>
      <div class="auth-switch">Pehle se account hai? <span class="g" onclick="setAuthTab('login')">Login karo</span></div>
    </div>

    <!-- OTP -->
    <div class="otp-screen" id="otpScreen">
      <div style="font-size:2rem;margin-bottom:10px">üì≤</div>
      <div style="font-weight:800;font-size:1rem" id="otpPhone">+91 XXXXX XXXXX</div>
      <div style="font-size:0.8rem;color:var(--muted);margin-top:5px;margin-bottom:0">6-digit OTP bheja gaya ‚Äî Demo: 1 2 3 4 5 6</div>
      <div class="otp-inputs">
        <input class="oi" maxlength="1" id="o0" oninput="oNext(this,0)">
        <input class="oi" maxlength="1" id="o1" oninput="oNext(this,1)">
        <input class="oi" maxlength="1" id="o2" oninput="oNext(this,2)">
        <input class="oi" maxlength="1" id="o3" oninput="oNext(this,3)">
        <input class="oi" maxlength="1" id="o4" oninput="oNext(this,4)">
        <input class="oi" maxlength="1" id="o5" oninput="oNext(this,5)">
      </div>
      <div style="font-size:0.78rem;color:var(--muted);margin-bottom:16px">OTP nahi aaya? <span style="color:var(--yellow);cursor:pointer;font-weight:600" onclick="toast('üì≤ OTP dobara bheja!')">Dobara bhejo</span></div>
      <button class="auth-submit y" id="otpBtn" onclick="verifyOtp()">‚úÖ Verify Karo</button>
      <div style="text-align:center;margin-top:12px"><span style="font-size:0.78rem;color:var(--muted);cursor:pointer" onclick="backOtp()">‚Üê Wapas jaao</span></div>
    </div>
  </div>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê PROFILE SCREEN ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div class="prof-screen" id="profScreen">
  <div class="prof-header">
    <div style="font-size:1.1rem;font-weight:800">Meri Profile</div>
    <div class="sback" onclick="closeProfScreen()">‚úï Band karo</div>
  </div>
  <div style="text-align:center;margin-bottom:20px">
    <img class="prof-av-big" src="" id="profBigImg">
    <div style="font-size:1.2rem;font-weight:900" id="profBigName">‚Äî</div>
    <div style="font-size:0.78rem;color:var(--muted);margin-top:4px" id="profBigRole">‚Äî</div>
  </div>
  <div class="prof-info-card" id="profInfoCard"></div>
  <div id="profDocsSection"></div>
  <button class="mbtn ro" style="margin-top:12px" onclick="doLogout()">üö™ Logout Karo</button>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê MAIN APP ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div class="topbar" id="topbar" style="display:none">
  <div class="logo-wrap">
    <div class="logo-box">JDP</div>
    <div class="logo-title">CABS</div>
    <div class="mode-tag r" id="modeTag">Rider</div>
  </div>
  <div style="display:flex;gap:8px;align-items:center">
    <div class="prof-chip" onclick="openProfScreen()">
      <div class="prof-av"><img src="https://ui-avatars.com/api/?name=U&background=FBBF24&color=000" id="profImg"></div>
      <div class="prof-name" id="profName">User</div>
    </div>
    <div class="topbtn" style="color:var(--red);border-color:rgba(239,68,68,0.2)" onclick="doLogout()">‚áÑ Logout</div>
  </div>
</div>

<div class="live-pill" id="livePill" style="display:none"><div class="ldot"></div><span id="pillTxt">5 drivers kareeb</span></div>
<button class="locate-btn" id="locBtn" style="display:none;bottom:380px" onclick="locateMe()">üìç</button>

<div class="duty-wrap" id="dutyWrap" style="display:none">
  <div class="duty-btn off" id="dutyBtn" onclick="toggleDuty()"><div class="duty-ico">üöó</div><div class="duty-txt">Offline</div></div>
  <div class="duty-hint">Duty shuru karne ke liye tap karo</div>
</div>

<!-- BOTTOM SHEET -->
<div class="bsheet" id="bsheet" style="display:none">
  <div class="handle"></div>

  <!-- RIDER HOME -->
  <div class="scr on" id="scrRHome">
    <div class="wlbl">Kahan jaana hai?</div>
    <div class="loc-boxes">
      <div class="loc-box" onclick="openPick('pickup')"><div class="ldg"></div><div style="flex:1;min-width:0"><div class="lbl-main" id="puLbl">Pickup set karo</div><div class="lbl-sub">Search ya map pe tap</div></div><span style="color:var(--muted);font-size:0.8rem">‚úé</span></div>
      <div class="loc-box" onclick="openPick('drop')"><div class="ldr"></div><div style="flex:1;min-width:0"><div class="lbl-main" id="drLbl">Kahan jaana hai?</div><div class="lbl-sub">Sheher, landmark, area...</div></div><span style="color:var(--muted);font-size:0.8rem">‚úé</span></div>
    </div>
    <div class="qpicks">
      <div class="qchip" onclick="qpick('ghar')">üè† Ghar</div>
      <div class="qchip" onclick="qpick('office')">üíº Office</div>
      <div class="qchip" onclick="qpick('airport')">‚úàÔ∏è Airport</div>
      <div class="qchip" onclick="qpick('station')">üöâ Station</div>
      <div class="qchip" onclick="qpick('hospital')">üè• Hospital</div>
      <div class="qchip" onclick="qpick('mall')">üõçÔ∏è Mall</div>
    </div>
    <button class="mbtn y" onclick="goRides()">üöó Ride Dekho &amp; Book Karo</button>
  </div>

  <!-- SEARCH -->
  <div class="scr" id="scrSearch">
    <div class="shdr"><div class="stitle" id="searchTitle">Pickup Set Karo</div><div class="sback" onclick="goScr('RHome')">‚Üê Wapas</div></div>
    <div class="sinp-wrap"><span class="sinp-ico">üîç</span><input type="text" class="sinp" id="sinp" placeholder="Jagah dhundho..." oninput="filterSug(this.value)"></div>
    <div class="suglist" id="suglist"></div>
  </div>

  <!-- RIDE OPTIONS -->
  <div class="scr" id="scrRides">
    <div class="shdr"><div class="stitle">Ride Chuniye</div><div class="sback" onclick="goScr('RHome')">‚Üê Wapas</div></div>
    <div class="rbar">
      <div class="rline"><div class="rg"></div><div class="rdashes"><div class="rdash"></div><div class="rdash"></div><div class="rdash"></div></div><div class="rr"></div></div>
      <div style="flex:1;min-width:0"><div class="rfrom" id="rfrom">Pickup</div><div class="rto" id="rto">Drop</div></div>
      <div style="text-align:right"><div id="rdist" style="font-weight:800;font-size:0.9rem">‚Äî</div><div style="font-size:0.67rem;color:var(--muted)">doori</div></div>
    </div>
    <div id="rlist"></div>
    <div class="payrow"><div class="payl"><span>üí≥</span><span>Cash Payment</span></div><span style="font-size:0.73rem;color:var(--yellow);cursor:pointer;font-weight:700">Change ‚Üí</span></div>
    <button class="mbtn y" onclick="confirmRide()">‚úÖ Booking Confirm Karo</button>
  </div>

  <!-- TRACKING -->
  <div class="scr" id="scrTrack">
    <div class="shdr"><div class="stitle">Live Tracking üáÆüá≥</div><div class="sback" onclick="cancelRide()">Cancel</div></div>
    <div class="etabar">
      <div><div class="etanum" id="etaNum">4</div><div class="etalbl">min mein aayega</div></div>
      <div class="etasteps">
        <div class="stp done" id="rs1">‚úì Booking confirm</div>
        <div class="stp on" id="rs2">üöó Driver aa raha hai</div>
        <div class="stp" id="rs3">üìç Pickup pe pahuncha</div>
        <div class="stp" id="rs4">üèÅ Trip shuru</div>
      </div>
    </div>
    <div class="dcard">
      <div class="dav"><img src="https://randomuser.me/api/portraits/men/44.jpg"></div>
      <div style="flex:1"><div class="dname">Ramesh Kumar</div><div class="dcar">üöó Swift Dzire ¬∑ DL 4C AZ 5678</div><div class="drating">‚òÖ 4.9 ¬∑ 3,241 rides</div></div>
      <div class="dbtns"><div class="dbtn" onclick="toast('üìû Call kar raha hai...')">üìû</div><div class="dbtn" onclick="toast('üí¨ Chat jald!')">üí¨</div></div>
    </div>
    <div class="payrow"><div class="payl"><span>üí∞</span><span>Estimated Fare</span></div><span style="font-weight:900;color:var(--yellow);font-size:1.05rem" id="tfare">‚Çπ180</span></div>
    <button class="mbtn ro" onclick="cancelRide()">Ride Cancel Karo</button>
  </div>

  <!-- DRIVER OFFLINE -->
  <div class="scr" id="scrDOff">
    <div style="text-align:center;padding:8px 0 18px">
      <div style="font-size:1.3rem;font-weight:900;margin-bottom:6px" id="drvWelcome">Namaste, Driver! üëã</div>
      <div style="font-size:0.82rem;color:var(--muted)">Duty on karo ‚Äî requests aayenge!</div>
    </div>
    <div class="stats-row">
      <div class="stat-box"><div class="stat-num" id="dToday">‚Çπ0</div><div class="stat-lbl">Aaj Kamai</div></div>
      <div class="stat-box"><div class="stat-num" id="dRides">0</div><div class="stat-lbl">Rides</div></div>
      <div class="stat-box"><div class="stat-num">4.9‚òÖ</div><div class="stat-lbl">Rating</div></div>
    </div>
    <button class="mbtn g" onclick="goOnline()">üü¢ Duty Shuru Karo</button>
    <button class="mbtn ghost" onclick="goScr('Earn')">üí∞ Kamai Dekho</button>
  </div>

  <!-- DRIVER ONLINE -->
  <div class="scr" id="scrDOn">
    <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:16px">
      <div class="stitle">Live Dashboard</div>
      <div style="display:flex;align-items:center;gap:6px;background:rgba(16,185,129,0.1);border:1px solid rgba(16,185,129,0.2);border-radius:100px;padding:6px 12px;font-size:0.7rem;font-weight:700;color:var(--green)"><div class="ldot"></div>Online</div>
    </div>
    <div class="icard"><div class="icard-ico ic-y">üí∞</div><div class="icard-body"><div class="icard-title">Aaj ki Kamai</div><div class="icard-sub" id="dRidesSub">0 rides</div></div><div class="icard-val" id="dEarning" style="color:var(--yellow)">‚Çπ0</div></div>
    <div class="icard"><div class="icard-ico ic-g">üì°</div><div class="icard-body"><div class="icard-title">Requests Active</div><div class="icard-sub">Kareeb riders hain</div></div><div class="icard-val" style="color:var(--green)">Live</div></div>
    <div class="icard"><div class="icard-ico ic-b">‚è±Ô∏è</div><div class="icard-body"><div class="icard-title">Online Time</div><div class="icard-sub">Aaj duty pe</div></div><div class="icard-val" id="onlineTime">0h 0m</div></div>
    <button class="mbtn ro" onclick="goOffline()">üî¥ Duty Band Karo</button>
  </div>

  <!-- DRIVER ACTIVE TRIP -->
  <div class="scr" id="scrDRide">
    <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:14px">
      <div class="stitle">Trip Active üöó</div>
      <div style="display:flex;align-items:center;gap:6px;background:rgba(16,185,129,0.1);border:1px solid rgba(16,185,129,0.2);border-radius:100px;padding:6px 12px;font-size:0.7rem;font-weight:700;color:var(--green)"><div class="ldot"></div>Active</div>
    </div>
    <div class="navcard">
      <span style="font-size:1.5rem">üó∫Ô∏è</span>
      <div style="flex:1"><div style="font-weight:800;font-size:1rem" id="navDist">2.4 km baaki</div><div style="font-size:0.78rem;color:var(--muted);margin-top:3px" id="navDir">Seedha jaao</div></div>
      <button onclick="toast('üó∫Ô∏è Navigation!')" style="background:var(--blue);color:white;border:none;border-radius:10px;padding:10px 14px;font-weight:700;font-size:0.78rem;cursor:pointer;font-family:'Plus Jakarta Sans',sans-serif;">Navigate</button>
    </div>
    <div class="dcard">
      <div class="dav"><img src="https://randomuser.me/api/portraits/women/32.jpg" id="tripRiderImg"></div>
      <div style="flex:1"><div class="dname" id="tripRiderName">Rider</div><div class="dcar" id="tripRiderPhone">üì± ‚Äî</div><div class="drating">‚òÖ 4.8 Rider</div></div>
      <div class="dbtns"><div class="dbtn" onclick="toast('üìû Call!')">üìû</div><div class="dbtn" onclick="toast('üí¨ Chat!')">üí¨</div></div>
    </div>
    <div class="trip-fare-row">
      <div style="font-size:0.85rem;font-weight:600;display:flex;align-items:center;gap:8px"><span>üí∞</span><span>Trip Fare</span></div>
      <div style="font-weight:900;font-size:1.1rem;color:var(--yellow)" id="dTripFare">‚Çπ220</div>
    </div>
    <button class="mbtn y" onclick="endTrip()">üèÅ Trip Complete Karo</button>
  </div>

  <!-- EARNINGS -->
  <div class="scr" id="scrEarn">
    <div class="shdr"><div class="stitle">Meri Kamai üí∞</div><div class="sback" onclick="goScr('DOn')">‚Üê Wapas</div></div>
    <div class="earn-total"><div class="earn-amt" id="earnTotal">‚Çπ0</div><div class="earn-lbl">Aaj ki total kamai</div></div>
    <div class="earn-grid">
      <div class="earn-box"><div class="earn-box-num" style="color:var(--green)" id="earnRides">0</div><div class="earn-box-lbl">Rides Today</div></div>
      <div class="earn-box"><div class="earn-box-num" style="color:var(--blue)" id="earnTime">0h 0m</div><div class="earn-box-lbl">Online Time</div></div>
      <div class="earn-box"><div class="earn-box-num" style="color:var(--yellow)">‚Çπ8,420</div><div class="earn-box-lbl">Is Hafte</div></div>
      <div class="earn-box"><div class="earn-box-num" style="color:var(--red)">4.9‚òÖ</div><div class="earn-box-lbl">Rating</div></div>
    </div>
    <div style="font-size:0.75rem;font-weight:700;color:var(--muted);margin-bottom:10px;text-transform:uppercase;letter-spacing:1px">Recent Rides</div>
    <div class="hist-list" id="histList"><div style="text-align:center;color:var(--muted);font-size:0.85rem;padding:20px">Abhi koi ride nahi</div></div>
  </div>
</div>

<!-- RIDE REQUEST POPUP -->
<div class="popup" id="ridePopup">
  <div class="pop-handle"></div>
  <div class="alert-pill"><div class="alert-dot"></div><span>Nayi Ride Request!</span></div>
  <div class="pop-fare"><div class="pop-fare-num" id="popFare">‚Çπ220</div><div class="pop-fare-lbl">Estimated Fare</div></div>
  <div class="timer-wrap"><div class="timer-bar" id="timerBar"></div></div>
  <div class="pop-route">
    <div style="display:flex;flex-direction:column;align-items:center;gap:3px"><div class="pop-rg"></div><div style="display:flex;flex-direction:column;gap:2px"><div class="pop-rdash"></div><div class="pop-rdash"></div><div class="pop-rdash"></div></div><div class="pop-rr"></div></div>
    <div style="flex:1;min-width:0"><div class="pop-from" id="popFrom">Pickup</div><div class="pop-to" id="popTo">Drop</div></div>
  </div>
  <div class="pop-details">
    <div class="pop-det"><div class="pop-det-val" id="popDist">‚Äî</div><div class="pop-det-lbl">Doori</div></div>
    <div class="pop-det"><div class="pop-det-val" id="popTime">‚Äî</div><div class="pop-det-lbl">Time</div></div>
    <div class="pop-det"><div class="pop-det-val">Cash</div><div class="pop-det-lbl">Payment</div></div>
  </div>
  <div class="pop-rider">
    <div class="pop-av"><img src="https://randomuser.me/api/portraits/women/32.jpg" id="popRiderImg"></div>
    <div style="flex:1"><div style="font-weight:700;font-size:0.9rem" id="popRiderName">Rider</div><div style="font-size:0.72rem;color:var(--muted);margin-top:2px">‚òÖ 4.8 Rider</div></div>
  </div>
  <div class="pop-btns">
    <button class="pop-btn-dec" onclick="declineRide()">‚ùå Decline</button>
    <button class="pop-btn-acc" onclick="acceptRide()">‚úÖ Accept</button>
  </div>
</div>

<script>
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê GLOBALS ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let authRole='rider', authTab='login', currentUser=null, fbReady=false;
let selectedVtype='Moto', docUrls={lic:null,aadhaar:null}, pendingRegData=null, postOtpAction=null;
let mapMode='none', lmap=null, mmap=null;
let puCoords=null, drCoords=null, puMarker=null, drMarker=null, routeLine=null;
let drvObjs=[], pickerType='pickup';
let isOnline=false, onlineStart=null, onlineTimer=null, requestTimer=null;
let completedRides=0, totalEarned=0;
const CENTER=[28.6139,77.2090];

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê FIREBASE READY ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
window.addEventListener('firebaseReady', ()=>{
  fbReady=true;
  document.getElementById('fbBadge').className='fb-badge ok';
  document.getElementById('fbBadge').textContent='‚úÖ Firebase Connected!';
  // Auth state listener
  window.FB.onAuthStateChanged(window.FB.auth, async (user)=>{
    if(user){
      // Already logged in ‚Äî fetch profile
      try{
        const snap = await window.FB.getDoc(window.FB.doc(window.FB.db,'users',user.uid));
        if(snap.exists()){
          currentUser={uid:user.uid,...snap.data()};
          document.getElementById('authScreen').style.display='none';
          launchApp();
        }
      }catch(e){ console.log(e); }
    }
  });
});

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê LOADER ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let ldProg=0;
const ldIv=setInterval(()=>{ ldProg+=Math.random()*14; if(ldProg>88) ldProg=88; document.getElementById('ldBar').style.width=ldProg+'%'; },350);
function ldTxt(t){ document.getElementById('ldTxt').textContent=t; }
function finishLoad(){
  clearInterval(ldIv);
  document.getElementById('ldBar').style.width='100%';
  setTimeout(()=>{
    document.getElementById('loader').style.opacity='0';
    document.getElementById('loader').style.transition='opacity 0.5s';
    setTimeout(()=>{
      document.getElementById('loader').style.display='none';
      if(!currentUser) document.getElementById('authScreen').style.display='flex';
    },500);
  },700);
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê MAP ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
window.onMapReady=function(){
  mapMode='mappls'; ldTxt('üáÆüá≥ MapmyIndia Ready!');
  try{
    mmap=new mappls.Map('map',{center:CENTER,zoom:13,search:false,zoomControl:true});
    mmap.on('load',()=>{ finishLoad(); spawnCars(); setInterval(moveCars,2000); mmap.on('click',e=>{ if(document.getElementById('scrSearch').classList.contains('on')) revGeo([e.lngLat.lat,e.lngLat.lng],pickerType); }); });
  }catch(e){ useFallback(); }
};
setTimeout(()=>{ if(mapMode==='none') useFallback(); },7000);
function useFallback(){
  mapMode='leaflet';
  lmap=L.map('map',{zoomControl:true,attributionControl:false}).setView(CENTER,13);
  L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png',{maxZoom:19,subdomains:'abcd'}).addTo(lmap);
  lmap.on('click',e=>{ if(document.getElementById('scrSearch').classList.contains('on')) revGeo([e.latlng.lat,e.latlng.lng],pickerType); });
  spawnCars(); setInterval(moveCars,2000); finishLoad();
}
const carPos=[[28.620,77.210],[28.608,77.218],[28.617,77.197],[28.626,77.204],[28.601,77.232]];
function spawnCars(){
  carPos.forEach(p=>{
    if(mapMode==='leaflet'){ const m=L.marker(p,{icon:carIcon()}).addTo(lmap); drvObjs.push({m,pos:[...p],mode:'leaflet'}); }
    else{ try{ const m=new mappls.Marker({map:mmap,position:{lat:p[0],lng:p[1]},fitbounds:false}); drvObjs.push({m,pos:[...p],mode:'mappls'}); }catch(e){} }
  });
}
function moveCars(){ drvObjs.forEach(d=>{ d.pos[0]+=(Math.random()-.5)*.001; d.pos[1]+=(Math.random()-.5)*.001; try{ if(d.mode==='leaflet') d.m.setLatLng(d.pos); else d.m.setPosition({lat:d.pos[0],lng:d.pos[1]}); }catch(e){} }); }
function carIcon(){ return L.divIcon({className:'',html:`<div style="position:relative;width:36px;height:36px"><div style="position:absolute;inset:-7px;border-radius:50%;background:rgba(251,191,36,0.15);animation:carPulse 2s ease-out infinite;"></div><div style="width:36px;height:36px;background:#FBBF24;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:18px;box-shadow:0 4px 12px rgba(251,191,36,0.5)">üöó</div></div>`,iconSize:[36,36],iconAnchor:[18,18]}); }
function pinIcon(c){ const col=c==='g'?'#10b981':'#ef4444'; return L.divIcon({className:'',html:`<div style="width:14px;height:14px;background:${col};border-radius:50%;border:3px solid white;box-shadow:0 0 10px ${col}99"></div>`,iconSize:[14,14],iconAnchor:[7,7]}); }

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê AUTH ROLE/TAB ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function setAuthRole(r){
  authRole=r;
  document.getElementById('rTab').className='rtab'+(r==='rider'?' active r':'');
  document.getElementById('dTab').className='rtab'+(r==='driver'?' active d':'');
  document.getElementById('loginBtn').className='auth-submit '+(r==='rider'?'y':'g');
  if(authTab==='register'){
    document.getElementById('riderRegForm').className='auth-form'+(r==='rider'?' show':'');
    document.getElementById('driverRegForm').className='auth-form'+(r==='driver'?' show':'');
  }
}
function setAuthTab(t){
  authTab=t;
  document.getElementById('loginTab').className='atab'+(t==='login'?' active':'');
  document.getElementById('regTab').className='atab'+(t==='register'?' active':'');
  document.getElementById('loginForm').className='auth-form'+(t==='login'?' show':'');
  document.getElementById('riderRegForm').className='auth-form'+(t==='register'&&authRole==='rider'?' show':'');
  document.getElementById('driverRegForm').className='auth-form'+(t==='register'&&authRole==='driver'?' show':'');
  document.getElementById('otpScreen').className='otp-screen';
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê FIREBASE: LOGIN ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
async function doLogin(){
  const id=document.getElementById('loginId').value.trim();
  const pass=document.getElementById('loginPass').value;
  let ok=true;
  if(!id||id.length<6){ showErr('loginIdErr','Valid mobile ya email daalo'); ok=false; } else hideErr('loginIdErr');
  if(!pass){ showErr('loginPassErr','Password daalo'); ok=false; } else hideErr('loginPassErr');
  if(!ok) return;

  // Convert phone to email format if needed
  let email=id.includes('@')?id:phoneToEmail(id);
  const btn=document.getElementById('loginBtn');
  btn.disabled=true; btn.textContent='‚è≥ Login ho raha hai...';
  try{
    const cred=await window.FB.signInWithEmailAndPassword(window.FB.auth, email, pass);
    const snap=await window.FB.getDoc(window.FB.doc(window.FB.db,'users',cred.user.uid));
    if(!snap.exists()){ btn.disabled=false; btn.textContent='üöÄ Login Karo'; showErr('loginIdErr','User profile nahi mila'); return; }
    currentUser={uid:cred.user.uid,...snap.data()};
    if(currentUser.role!==authRole){ 
      await window.FB.signOut(window.FB.auth);
      btn.disabled=false; btn.textContent='üöÄ Login Karo';
      showErr('loginIdErr',`Yeh account ${currentUser.role} ka hai ‚Äî Role switch karo`);
      return;
    }
    document.getElementById('authScreen').style.display='none';
    toast('üéâ Welcome back, '+currentUser.name.split(' ')[0]+'!');
    launchApp();
  }catch(e){
    btn.disabled=false; btn.textContent='üöÄ Login Karo';
    if(e.code==='auth/user-not-found'||e.code==='auth/invalid-credential') showErr('loginIdErr','Account nahi mila ‚Äî Register karo');
    else if(e.code==='auth/wrong-password') showErr('loginPassErr','Password galat hai!');
    else showErr('loginIdErr','Error: '+e.message);
  }
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê FIREBASE: RIDER REGISTER ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
async function doRiderRegister(){
  const fn=document.getElementById('rFn').value.trim();
  const ph=document.getElementById('rPhone').value.trim().replace(/\s/g,'');
  const em=document.getElementById('rEmail').value.trim();
  const pass=document.getElementById('rPass').value;
  const conf=document.getElementById('rConf').value;
  let ok=true;
  if(!fn){ showErr('rFnErr','Naam daalo'); ok=false; } else hideErr('rFnErr');
  if(!ph||ph.length<10){ showErr('rPhoneErr','Valid number daalo'); ok=false; } else hideErr('rPhoneErr');
  if(!em||!em.includes('@')){ showErr('rEmailErr','Valid email daalo'); ok=false; } else hideErr('rEmailErr');
  if(pass.length<6){ showErr('rPassErr','Min 6 characters'); ok=false; } else hideErr('rPassErr');
  if(pass!==conf){ showErr('rConfErr','Match nahi'); ok=false; } else hideErr('rConfErr');
  if(!ok) return;
  pendingRegData={ name:fn+' '+(document.getElementById('rLn').value.trim()), phone:ph, email:em, role:'rider', dob:document.getElementById('rDob').value, password:pass, createdAt: new Date().toISOString() };
  postOtpAction='riderReg';
  showOtp(ph);
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê FIREBASE: DRIVER REGISTER ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
async function doDriverRegister(){
  const fn=document.getElementById('dFn').value.trim();
  const ph=document.getElementById('dPhone').value.trim().replace(/\s/g,'');
  const em=document.getElementById('dEmail').value.trim();
  const aad=document.getElementById('dAadhaar').value.trim().replace(/\s/g,'');
  const lic=document.getElementById('dLic').value.trim();
  const pass=document.getElementById('dPass').value;
  const conf=document.getElementById('dConf').value;
  let ok=true;
  if(!fn){ showErr('dFnErr','Naam daalo'); ok=false; } else hideErr('dFnErr');
  if(!ph||ph.length<10){ showErr('dPhoneErr','Valid number daalo'); ok=false; } else hideErr('dPhoneErr');
  if(!em||!em.includes('@')){ showErr('dEmailErr','Valid email daalo'); ok=false; } else hideErr('dEmailErr');
  if(!aad||aad.length<12){ showErr('dAadhaarErr','12-digit Aadhaar daalo'); ok=false; } else hideErr('dAadhaarErr');
  if(!lic){ showErr('dLicErr','Licence number daalo'); ok=false; } else hideErr('dLicErr');
  if(pass.length<6){ showErr('dPassErr','Min 6 characters'); ok=false; } else hideErr('dPassErr');
  if(pass!==conf){ showErr('dConfErr','Match nahi'); ok=false; } else hideErr('dConfErr');
  if(!ok) return;
  pendingRegData={ name:fn+' '+(document.getElementById('dLn').value.trim()), phone:ph, email:em, role:'driver', aadhaar:aad, licence:lic, vehicle:document.getElementById('dVeh').value, vtype:selectedVtype, password:pass, docUrls:{lic:docUrls.lic,aadhaar:docUrls.aadhaar}, verified:false, createdAt: new Date().toISOString() };
  postOtpAction='driverReg';
  showOtp(ph);
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê OTP ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function showOtp(ph){
  ['loginForm','riderRegForm','driverRegForm'].forEach(id=>document.getElementById(id).className='auth-form');
  document.getElementById('otpScreen').className='otp-screen show';
  document.getElementById('otpPhone').textContent=ph;
  document.getElementById('otpBtn').className='auth-submit '+(authRole==='rider'?'y':'g');
  [0,1,2,3,4,5].forEach(i=>{ document.getElementById('o'+i).value=''; });
  document.getElementById('o0').focus();
  toast('üì≤ Demo OTP: 1 2 3 4 5 6');
}
function oNext(el,i){ if(el.value.length===1&&i<5) document.getElementById('o'+(i+1)).focus(); }
function backOtp(){ document.getElementById('otpScreen').className='otp-screen'; setAuthTab(authTab); }

async function verifyOtp(){
  const code=[0,1,2,3,4,5].map(i=>document.getElementById('o'+i).value).join('');
  if(code.length<6){ toast('‚ö†Ô∏è Poora OTP daalo!'); return; }
  // Demo: any 6 digits accepted
  const btn=document.getElementById('otpBtn');
  btn.disabled=true; btn.textContent='‚è≥ Verify ho raha hai...';
  try{
    if(postOtpAction==='riderReg'||postOtpAction==='driverReg'){
      // Create Firebase Auth user
      const email=pendingRegData.email;
      const pass=pendingRegData.password;
      const cred=await window.FB.createUserWithEmailAndPassword(window.FB.auth, email, pass);
      const uid=cred.user.uid;
      // Save to Firestore (password nahi save karenge)
      const dataToSave={...pendingRegData}; delete dataToSave.password;
      await window.FB.setDoc(window.FB.doc(window.FB.db,'users',uid), dataToSave);
      currentUser={uid,...dataToSave};
      toast('üéâ Account ban gaya! Welcome, '+currentUser.name.split(' ')[0]+'!');
    }
    document.getElementById('authScreen').style.display='none';
    launchApp();
  }catch(e){
    btn.disabled=false; btn.textContent='‚úÖ Verify Karo';
    if(e.code==='auth/email-already-in-use') toast('‚ö†Ô∏è Yeh email pehle se registered hai!');
    else toast('‚ùå Error: '+e.message);
  }
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê DOCUMENT UPLOAD (Firebase Storage) ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function uploadDoc(type,name,boxId){
  document.getElementById(type+'File').click();
}
async function handleFile(type, input){
  const file=input.files[0]; if(!file) return;
  if(file.size>5*1024*1024){ toast('‚ùå File 5MB se badi hai!'); return; }
  const box=document.getElementById(type==='lic'?'licBox':'aadhaarBox');
  const progWrap=document.getElementById(type+'Prog');
  const progBar=document.getElementById(type+'ProgBar');
  const title=document.getElementById(type+'Title');
  progWrap.className='ubox-progress on';
  // Simulate progress
  let p=0; const iv=setInterval(()=>{ p+=Math.random()*20; if(p>90) p=90; progBar.style.width=p+'%'; },200);
  try{
    // Upload to Firebase Storage
    if(!fbReady){ clearInterval(iv); toast('‚ö†Ô∏è Firebase connect nahi hua'); return; }
    const storageRef=window.FB.ref(window.FB.storage,`drivers/docs/${Date.now()}_${type}_${file.name}`);
    const snap=await window.FB.uploadBytes(storageRef, file);
    const url=await window.FB.getDownloadURL(snap.ref);
    docUrls[type]=url;
    clearInterval(iv); progBar.style.width='100%';
    setTimeout(()=>{
      box.classList.add('done');
      document.getElementById(type+'Ico').textContent=type==='lic'?'üìÑ':'ü™™';
      title.textContent=name+' Upload Ho Gaya ‚úÖ';
      progWrap.className='ubox-progress';
      toast('‚úÖ '+name+' Firebase pe save ho gaya!');
    },400);
  }catch(e){
    clearInterval(iv); progWrap.className='ubox-progress';
    toast('‚ùå Upload failed: '+e.message);
  }
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê LOGOUT ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
async function doLogout(){
  if(!confirm('Logout karna chahte hain?')) return;
  try{
    await window.FB.signOut(window.FB.auth);
    currentUser=null;
    isOnline=false; completedRides=0; totalEarned=0;
    if(onlineTimer) clearInterval(onlineTimer);
    if(requestTimer) clearInterval(requestTimer);
    document.getElementById('ridePopup').classList.remove('show');
    ['topbar','bsheet','livePill','locBtn','dutyWrap'].forEach(id=>document.getElementById(id).style.display='none');
    closeProfScreen();
    document.getElementById('authScreen').style.display='flex';
    setAuthTab('login'); setAuthRole('rider');
    toast('üëã Logout ho gaye!');
  }catch(e){ toast('Error: '+e.message); }
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê LAUNCH APP ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function launchApp(){
  document.getElementById('topbar').style.display='flex';
  document.getElementById('bsheet').style.display='block';
  document.getElementById('livePill').style.display='flex';
  document.getElementById('locBtn').style.display='flex';
  const first=currentUser.name.split(' ')[0];
  document.getElementById('profName').textContent=first;
  document.getElementById('profImg').src=`https://ui-avatars.com/api/?name=${encodeURIComponent(currentUser.name)}&background=FBBF24&color=000&bold=true`;
  const tag=document.getElementById('modeTag');
  if(currentUser.role==='rider'){
    tag.textContent='üßç Rider'; tag.className='mode-tag r';
    document.getElementById('pillTxt').textContent='5 drivers kareeb';
    document.getElementById('dutyWrap').style.display='none';
    document.getElementById('locBtn').style.bottom='380px';
    setPickup(CENTER,'Rajiv Chowk, New Delhi');
    goScr('RHome');
  } else {
    tag.textContent='üöó Driver'; tag.className='mode-tag d';
    document.getElementById('pillTxt').textContent='Driver Mode';
    document.getElementById('dutyWrap').style.display='flex';
    document.getElementById('locBtn').style.bottom='320px';
    document.getElementById('drvWelcome').textContent='Namaste, '+first+'! üëã';
    goScr('DOn'); goOffline();
    goScr('DOn'); // actually show DOffline
    goScr('DOn');
    goScr('DOf');
  }
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê PROFILE SCREEN ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function openProfScreen(){
  if(!currentUser) return;
  document.getElementById('profBigImg').src=`https://ui-avatars.com/api/?name=${encodeURIComponent(currentUser.name)}&background=FBBF24&color=000&bold=true&size=200`;
  document.getElementById('profBigName').textContent=currentUser.name;
  document.getElementById('profBigRole').textContent=currentUser.role==='rider'?'üßç Rider':'üöó Driver Partner';
  const fields=currentUser.role==='rider'?[
    {l:'üì± Mobile',v:currentUser.phone},{l:'üìß Email',v:currentUser.email},{l:'üéÇ Date of Birth',v:currentUser.dob||'‚Äî'},{l:'üÜî User ID',v:currentUser.uid?.slice(0,12)+'...'},{l:'üìÖ Joined',v:currentUser.createdAt?.slice(0,10)||'‚Äî'}
  ]:[
    {l:'üì± Mobile',v:currentUser.phone},{l:'üìß Email',v:currentUser.email},{l:'ü™™ Aadhaar',v:currentUser.aadhaar?.slice(0,4)+'XXXX'+currentUser.aadhaar?.slice(-4)},{l:'üöó Licence',v:currentUser.licence},{l:'üöò Vehicle',v:currentUser.vehicle||'‚Äî'},{l:'üöò Type',v:currentUser.vtype||'‚Äî'},{l:'‚úÖ Verified',v:currentUser.verified?'Haan':'Pending Verification'},{l:'üÜî Driver ID',v:currentUser.uid?.slice(0,12)+'...'},{l:'üìÖ Joined',v:currentUser.createdAt?.slice(0,10)||'‚Äî'}
  ];
  document.getElementById('profInfoCard').innerHTML=fields.map(f=>`<div class="prof-field"><div class="pf-label">${f.l}</div><div class="pf-value">${f.v||'‚Äî'}</div></div>`).join('');
  // Driver documents
  if(currentUser.role==='driver'){
    document.getElementById('profDocsSection').innerHTML=`
      <div style="font-size:0.75rem;font-weight:700;color:var(--muted);margin-bottom:10px;text-transform:uppercase;letter-spacing:1px">Uploaded Documents</div>
      <div class="doc-card">
        <div style="font-size:1.5rem">üìÑ</div>
        <div style="flex:1"><div style="font-weight:700;font-size:0.9rem">Driving Licence</div><div style="font-size:0.72rem;color:var(--muted);margin-top:2px">${currentUser.docUrls?.lic?'Firebase Storage pe save hai':'Upload nahi hua'}</div></div>
        <div class="doc-status ${currentUser.docUrls?.lic?'ok':'pending'}">${currentUser.docUrls?.lic?'‚úÖ Uploaded':'‚è≥ Pending'}</div>
      </div>
      <div class="doc-card">
        <div style="font-size:1.5rem">ü™™</div>
        <div style="flex:1"><div style="font-weight:700;font-size:0.9rem">Aadhaar Card</div><div style="font-size:0.72rem;color:var(--muted);margin-top:2px">${currentUser.docUrls?.aadhaar?'Firebase Storage pe save hai':'Upload nahi hua'}</div></div>
        <div class="doc-status ${currentUser.docUrls?.aadhaar?'ok':'pending'}">${currentUser.docUrls?.aadhaar?'‚úÖ Uploaded':'‚è≥ Pending'}</div>
      </div>`;
  } else { document.getElementById('profDocsSection').innerHTML=''; }
  document.getElementById('profScreen').className='prof-screen show';
}
function closeProfScreen(){ document.getElementById('profScreen').className='prof-screen'; }

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê HELPERS ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function phoneToEmail(ph){ return ph.replace(/[^0-9]/g,'')+'@jdpcabs.in'; }
function showErr(id,msg){ const el=document.getElementById(id); el.textContent=msg; el.classList.add('on'); }
function hideErr(id){ document.getElementById(id).classList.remove('on'); }
function selV(card,type){ document.querySelectorAll('.vcard').forEach(c=>c.classList.remove('sel')); card.classList.add('sel'); selectedVtype=type; }
function goScr(name){ document.querySelectorAll('.scr').forEach(s=>s.classList.remove('on')); const el=document.getElementById('scr'+name); if(el) el.classList.add('on'); }
function flyTo(ll){ if(mapMode==='mappls'){try{mmap.setCenter({lat:ll[0],lng:ll[1]});}catch(e){}}else lmap.flyTo(ll,15,{duration:1.3}); }

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê LOCATE ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function locateMe(){
  toast('üìç Location dhundh raha hai...');
  navigator.geolocation?.getCurrentPosition(p=>{ const ll=[p.coords.latitude,p.coords.longitude]; if(currentUser?.role==='rider') setPickup(ll,'Aapki Location'); flyTo(ll); toast('‚úÖ Location mil gayi!'); },()=>toast('‚ùå Permission denied'));
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê MAP MARKERS ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function setPickup(ll,label){
  puCoords=ll; document.getElementById('puLbl').textContent=label||`${ll[0].toFixed(4)}, ${ll[1].toFixed(4)}`;
  try{ if(mapMode==='leaflet'){ if(puMarker) lmap.removeLayer(puMarker); puMarker=L.marker(ll,{icon:pinIcon('g')}).addTo(lmap); } else{ if(puMarker) puMarker.remove(); puMarker=new mappls.Marker({map:mmap,position:{lat:ll[0],lng:ll[1]},fitbounds:false}); } }catch(e){}
  if(drCoords) drawRoute();
}
function setDrop(ll,label){
  drCoords=ll; document.getElementById('drLbl').textContent=label||`${ll[0].toFixed(4)}, ${ll[1].toFixed(4)}`;
  try{ if(mapMode==='leaflet'){ if(drMarker) lmap.removeLayer(drMarker); drMarker=L.marker(ll,{icon:pinIcon('r')}).addTo(lmap); } else{ if(drMarker) drMarker.remove(); drMarker=new mappls.Marker({map:mmap,position:{lat:ll[0],lng:ll[1]},fitbounds:false}); } }catch(e){}
  if(puCoords) drawRoute();
}
function drawRoute(){
  if(mapMode==='leaflet'){
    if(routeLine) lmap.removeLayer(routeLine);
    const m1=[(puCoords[0]*.65+drCoords[0]*.35)+(Math.random()-.5)*.01,(puCoords[1]*.65+drCoords[1]*.35)+(Math.random()-.5)*.01];
    const m2=[(puCoords[0]*.35+drCoords[0]*.65)+(Math.random()-.5)*.01,(puCoords[1]*.35+drCoords[1]*.65)+(Math.random()-.5)*.01];
    routeLine=L.polyline([puCoords,m1,m2,drCoords],{color:'#FBBF24',weight:5,opacity:0.9,dashArray:'10,6',lineCap:'round'}).addTo(lmap);
    let off=0; if(window._ra) clearInterval(window._ra);
    window._ra=setInterval(()=>{ off=(off+1)%16; if(routeLine) routeLine.setStyle({dashOffset:-off}); },55);
    lmap.fitBounds(routeLine.getBounds(),{padding:[80,80]});
  } else {
    try{ if(routeLine) routeLine.remove(); routeLine=new mappls.Polyline({map:mmap,path:[{lat:puCoords[0],lng:puCoords[1]},{lat:drCoords[0],lng:drCoords[1]}],strokeColor:'#FBBF24',strokeOpacity:0.9,strokeWeight:5,fitbounds:true}); }catch(e){}
  }
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê REVERSE GEO ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function revGeo(ll,type){
  fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${ll[0]}&lon=${ll[1]}&accept-language=en`)
    .then(r=>r.json()).then(d=>{ const n=d.address?.road||d.address?.suburb||d.display_name.split(',')[0]; if(type==='pickup') setPickup(ll,n); else setDrop(ll,n); goScr('RHome'); toast(`‚úÖ ${n}`); }).catch(()=>{ if(type==='pickup') setPickup(ll); else setDrop(ll); goScr('RHome'); });
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê SUGGESTIONS ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const SUGS=[
  {i:'üèõÔ∏è',n:'India Gate',a:'Rajpath, New Delhi',lat:28.6129,lon:77.2295,d:'1.2 km'},
  {i:'üõçÔ∏è',n:'Connaught Place',a:'Central Delhi',lat:28.6315,lon:77.2167,d:'2.1 km'},
  {i:'‚úàÔ∏è',n:'IGI Airport T3',a:'Dwarka, New Delhi',lat:28.5562,lon:77.0998,d:'11.4 km'},
  {i:'üè•',n:'AIIMS Hospital',a:'Ansari Nagar, New Delhi',lat:28.5672,lon:77.2100,d:'5.3 km'},
  {i:'üéì',n:'Delhi University',a:'North Campus',lat:28.6878,lon:77.2146,d:'7.8 km'},
  {i:'üõí',n:'Select Citywalk',a:'Saket, South Delhi',lat:28.5244,lon:77.2185,d:'9.1 km'},
  {i:'üïå',n:'Jama Masjid',a:'Chandni Chowk, Old Delhi',lat:28.6507,lon:77.2334,d:'4.2 km'},
  {i:'üöâ',n:'New Delhi Railway Station',a:'Paharganj',lat:28.6429,lon:77.2195,d:'3.0 km'},
  {i:'üåø',n:'Lodhi Garden',a:'Lodhi Road, New Delhi',lat:28.5931,lon:77.2196,d:'3.8 km'},
  {i:'üè∞',n:'Red Fort',a:'Chandni Chowk, Old Delhi',lat:28.6562,lon:77.2410,d:'5.5 km'},
  {i:'üå∏',n:'Lotus Temple',a:'Bahapur, New Delhi',lat:28.5535,lon:77.2588,d:'7.1 km'},
];
function renderSugs(list){ document.getElementById('suglist').innerHTML=list.map(s=>`<div class="sugrow" onclick="pickSug(${s.lat},${s.lon},'${s.n.replace(/'/g,"\\'")}')"><div class="sugico">${s.i}</div><div style="flex:1;min-width:0"><div class="sugname">${s.n}</div><div class="sugaddr">${s.a}</div></div><div class="sugdist">${s.d}</div></div>`).join(''); }
function openPick(type){ pickerType=type; document.getElementById('searchTitle').textContent=type==='pickup'?'Pickup Set Karo':'Drop Set Karo'; document.getElementById('sinp').value=''; renderSugs(SUGS); goScr('Search'); setTimeout(()=>document.getElementById('sinp').focus(),180); }
function filterSug(q){ if(!q.trim()){renderSugs(SUGS);return;} renderSugs(SUGS.filter(s=>s.n.toLowerCase().includes(q.toLowerCase())||s.a.toLowerCase().includes(q.toLowerCase()))); }
function pickSug(lat,lon,name){ const ll=[lat,lon]; if(pickerType==='pickup') setPickup(ll,name); else setDrop(ll,name); flyTo(ll); goScr('RHome'); toast(`üìç ${name}!`); }
const QP={ghar:{n:'Ghar',lat:28.625,lon:77.210},office:{n:'Connaught Place',lat:28.6315,lon:77.2167},airport:{n:'IGI Airport T3',lat:28.5562,lon:77.0998},station:{n:'New Delhi Station',lat:28.6429,lon:77.2195},hospital:{n:'AIIMS',lat:28.5672,lon:77.2100},mall:{n:'Select Citywalk',lat:28.5244,lon:77.2185}};
function qpick(k){ const p=QP[k]; setDrop([p.lat,p.lon],p.n); flyTo([p.lat,p.lon]); toast(`üéØ Drop: ${p.n}`); }

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê DISTANCE ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function getDist(a,b){ const R=6371,dL=(b[0]-a[0])*Math.PI/180,dN=(b[1]-a[1])*Math.PI/180; const x=Math.sin(dL/2)**2+Math.cos(a[0]*Math.PI/180)*Math.cos(b[0]*Math.PI/180)*Math.sin(dN/2)**2; return R*2*Math.atan2(Math.sqrt(x),Math.sqrt(1-x)); }

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê RIDES ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const RIDES=[{i:'üõµ',n:'Moto',d:'1 sawari',base:11,badge:'Sasta',eta:'2 min'},{i:'üöó',n:'GO',d:'4 sawari',base:17,badge:'Popular',eta:'4 min'},{i:'üöô',n:'Prime',d:'4 sawari ¬∑ Aaram',base:25,badge:null,eta:'6 min'},{i:'üöê',n:'GO XL',d:'6 sawari',base:31,badge:null,eta:'8 min'}];
function goRides(){
  if(!puCoords||!drCoords){ toast('‚ö†Ô∏è Pickup aur drop set karo!'); if(!puCoords) openPick('pickup'); else openPick('drop'); return; }
  const km=getDist(puCoords,drCoords);
  document.getElementById('rfrom').textContent=document.getElementById('puLbl').textContent;
  document.getElementById('rto').textContent=document.getElementById('drLbl').textContent;
  document.getElementById('rdist').textContent=km.toFixed(1)+' km';
  document.getElementById('tfare').textContent='‚Çπ'+Math.round(17*km+40);
  document.getElementById('rlist').innerHTML=RIDES.map((r,i)=>{ const fare=Math.round(r.base*km+40); return `<div class="ropt ${i===1?'sel':''}" id="ro${i}" onclick="selR(${i},${fare})">${r.badge?`<div class="rbadge">${r.badge}</div>`:''}<div class="rico">${r.i}</div><div style="flex:1"><div class="rname">${r.n}</div><div class="rdesc">${r.d}</div><div class="reta">üïê ${r.eta}</div></div><div class="rprice"><div class="rp-amt">‚Çπ${fare}</div><div class="rp-sub">${km.toFixed(1)} km</div></div></div>`; }).join('');
  goScr('Rides');
}
function selR(i,fare){ document.querySelectorAll('.ropt').forEach((el,j)=>el.classList.toggle('sel',i===j)); document.getElementById('tfare').textContent='‚Çπ'+fare; }
function confirmRide(){
  toast('üîç Driver dhundh raha hai...');
  // Save ride to Firestore
  if(fbReady&&currentUser){
    window.FB.addDoc(window.FB.collection(window.FB.db,'rides'),{
      riderId:currentUser.uid, riderName:currentUser.name, riderPhone:currentUser.phone,
      pickup:document.getElementById('puLbl').textContent, drop:document.getElementById('drLbl').textContent,
      fare:document.getElementById('tfare').textContent, status:'searching', timestamp:window.FB.serverTimestamp()
    }).catch(e=>console.log(e));
  }
  goScr('Track');
  if(puCoords) flyTo(puCoords);
  if(drvObjs.length>0){
    const drv=drvObjs[0],start=[...drv.pos],target=puCoords; let step=0,total=50;
    if(window._da) clearInterval(window._da);
    window._da=setInterval(()=>{ step++; const t=step/total; drv.pos[0]=start[0]+(target[0]-start[0])*t; drv.pos[1]=start[1]+(target[1]-start[1])*t;
      try{ if(drv.mode==='leaflet') drv.m.setLatLng(drv.pos); else drv.m.setPosition({lat:drv.pos[0],lng:drv.pos[1]}); }catch(e){}
      if(step>=total){ clearInterval(window._da); toast('üöó Driver aa gaya!'); updS(3); }
    },150);
  }
  let eta=4; document.getElementById('etaNum').textContent=eta;
  const et=setInterval(()=>{ eta--; document.getElementById('etaNum').textContent=Math.max(0,eta); if(eta<=0){clearInterval(et);updS(3);} },60000);
}
function updS(n){ [1,2,3,4].forEach(i=>{ const el=document.getElementById('rs'+i); if(i<n) el.className='stp done'; else if(i===n) el.className='stp on'; else el.className='stp'; }); }
function cancelRide(){ goScr('RHome'); toast('‚ùå Ride cancel'); }

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê DRIVER ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function toggleDuty(){ if(!isOnline) goOnline(); else goOffline(); }
function goOnline(){
  isOnline=true;
  const btn=document.getElementById('dutyBtn');
  btn.className='duty-btn on';
  btn.innerHTML=`<div class="radar"></div><div class="radar2"></div><div class="duty-ico">üü¢</div><div class="duty-txt">Online</div>`;
  goScr('DOn'); onlineStart=Date.now();
  onlineTimer=setInterval(()=>{ const m=Math.floor((Date.now()-onlineStart)/60000); document.getElementById('onlineTime').textContent=`${Math.floor(m/60)}h ${m%60}m`; document.getElementById('earnTime').textContent=`${Math.floor(m/60)}h ${m%60}m`; },30000);
  toast('üü¢ Duty shuru!'); setTimeout(()=>sendReq(),5000);
}
function goOffline(){
  isOnline=false;
  const btn=document.getElementById('dutyBtn');
  btn.className='duty-btn off'; btn.innerHTML=`<div class="duty-ico">üöó</div><div class="duty-txt">Offline</div>`;
  if(onlineTimer) clearInterval(onlineTimer); if(requestTimer) clearInterval(requestTimer);
  document.getElementById('ridePopup').classList.remove('show'); goScr('DOf'); toast('üî¥ Duty band');
}
const REQS=[
  {from:'Connaught Place',to:'IGI Airport T3',dist:'18.4 km',time:'28 min',fare:'‚Çπ420',rName:'Priya Sharma',rPic:'https://randomuser.me/api/portraits/women/32.jpg'},
  {from:'Lajpat Nagar',to:'Saket Mall',dist:'5.2 km',time:'12 min',fare:'‚Çπ130',rName:'Rahul Verma',rPic:'https://randomuser.me/api/portraits/men/22.jpg'},
  {from:'AIIMS',to:'India Gate',dist:'8.4 km',time:'18 min',fare:'‚Çπ195',rName:'Anjali Singh',rPic:'https://randomuser.me/api/portraits/women/44.jpg'},
  {from:'Dwarka',to:'Connaught Place',dist:'22 km',time:'35 min',fare:'‚Çπ480',rName:'Amit Kumar',rPic:'https://randomuser.me/api/portraits/men/55.jpg'},
];
let reqIdx=0;
function sendReq(){
  if(!isOnline) return;
  const r=REQS[reqIdx%REQS.length]; reqIdx++;
  document.getElementById('popFrom').textContent=r.from; document.getElementById('popTo').textContent=r.to;
  document.getElementById('popDist').textContent=r.dist; document.getElementById('popTime').textContent=r.time;
  document.getElementById('popFare').textContent=r.fare; document.getElementById('popRiderImg').src=r.rPic;
  document.getElementById('popRiderName').textContent=r.rName;
  document.getElementById('timerBar').style.width='100%';
  document.getElementById('ridePopup').classList.add('show');
  let sec=25; if(requestTimer) clearInterval(requestTimer);
  requestTimer=setInterval(()=>{ sec--; document.getElementById('timerBar').style.width=(sec/25*100)+'%'; if(sec<=0){clearInterval(requestTimer);document.getElementById('ridePopup').classList.remove('show');toast('‚è∞ Expire'); setTimeout(()=>{if(isOnline)sendReq();},4000);} },1000);
}
function declineRide(){ clearInterval(requestTimer); document.getElementById('ridePopup').classList.remove('show'); toast('‚ùå Decline'); setTimeout(()=>{if(isOnline)sendReq();},5000); }
async function acceptRide(){
  clearInterval(requestTimer); document.getElementById('ridePopup').classList.remove('show');
  const from=document.getElementById('popFrom').textContent,fare=document.getElementById('popFare').textContent,to=document.getElementById('popTo').textContent;
  document.getElementById('dTripFare').textContent=fare;
  document.getElementById('navDist').textContent=document.getElementById('popDist').textContent+' baaki';
  document.getElementById('navDir').textContent=from+' ‚Üí '+to;
  document.getElementById('tripRiderName').textContent=document.getElementById('popRiderName').textContent;
  document.getElementById('tripRiderImg').src=document.getElementById('popRiderImg').src;
  goScr('DRide'); toast(`‚úÖ Accepted! ${from} jaao`);
  completedRides++; totalEarned+=parseInt(fare.replace('‚Çπ','').replace(',',''));
  ['dToday','dEarning','earnTotal'].forEach(id=>document.getElementById(id).textContent='‚Çπ'+totalEarned.toLocaleString('en-IN'));
  ['dRides','earnRides'].forEach(id=>document.getElementById(id).textContent=completedRides);
  document.getElementById('dRidesSub').textContent=completedRides+' rides';
  addHist(from,to,fare);
  // Save to Firestore
  if(fbReady&&currentUser){
    window.FB.addDoc(window.FB.collection(window.FB.db,'completedRides'),{
      driverId:currentUser.uid, driverName:currentUser.name, from, to, fare,
      timestamp:window.FB.serverTimestamp()
    }).catch(e=>console.log(e));
    // Update driver earnings
    window.FB.updateDoc(window.FB.doc(window.FB.db,'users',currentUser.uid),{
      totalRides:completedRides, todayEarning:totalEarned
    }).catch(e=>console.log(e));
  }
}
function endTrip(){ goScr('DOn'); toast('üèÅ Trip complete! ‚úÖ'); setTimeout(()=>{if(isOnline)sendReq();},6000); }
function addHist(from,to,fare){
  const list=document.getElementById('histList');
  if(list.querySelector('div[style]')) list.innerHTML='';
  const now=new Date();
  list.insertAdjacentHTML('afterbegin',`<div class="hist-row"><div class="hist-ico">üöó</div><div style="flex:1"><div class="hist-from">${from} ‚Üí ${to}</div><div class="hist-time">Aaj, ${now.getHours()}:${String(now.getMinutes()).padStart(2,'0')}</div></div><div class="hist-amt">${fare}</div></div>`);
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê TOAST ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function toast(msg){ document.querySelectorAll('.toast').forEach(t=>t.remove()); const el=document.createElement('div'); el.className='toast'; el.textContent=msg; document.body.appendChild(el); setTimeout(()=>el.remove(),3200); }
</script>
</body>
</html>

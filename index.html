<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>JDP CABS — Jagdalpur Live</title>

<!-- ✅ PWA Meta Tags -->
<meta name="theme-color" content="#f59e0b">
<meta name="mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="JDP Cabs">
<meta name="application-name" content="JDP Cabs">
<meta name="description" content="Jagdalpur ka smartest cab booking — live tracking, instant ride">

<!-- ✅ Icons -->
<link rel="icon" type="image/png" sizes="192x192" href="icon-192.png">
<link rel="apple-touch-icon" href="icon-192.png">

<!-- ✅ Security Headers via meta -->
<meta http-equiv="X-Content-Type-Options" content="nosniff">
<meta name="referrer" content="strict-origin-when-cross-origin">
<link href="https://fonts.googleapis.com/css2?family=Syne:wght@700;800;900&family=DM+Sans:wght@400;500;600;700&display=swap" rel="stylesheet">

<!-- ✅ PERFORMANCE & ERROR BOUNDARY — 50K concurrent users -->
<script>
// Global error boundary — prevent single error from crashing app
window.onerror = function(msg, src, line, col, err) {
  // Silent — errors handled, app continues running
  return true;
};
window.addEventListener('unhandledrejection', function(e) {
  e.preventDefault();
}, false);
window.onunhandledrejection = function(e) {
  e.preventDefault();
};

// Performance tracker
window.PERF = {
  start: Date.now(),
  mark: function(n) { try { performance.mark(n); } catch(e) {} }
};

// Debounce utility
window.debounce = function(fn, ms) {
  var t; return function() { var a=arguments, ctx=this; clearTimeout(t); t=setTimeout(function(){fn.apply(ctx,a)},ms); };
};

// Throttle utility
window.throttle = function(fn, ms) {
  var last=0; return function() { var now=Date.now(); if(now-last>=ms){last=now;fn.apply(this,arguments);} };
};

// Request queue — prevent Firebase overload
window.ReqQueue = {
  q: [], running: 0, max: 3,
  add: function(fn) {
    return new Promise(function(res, rej) {
      window.ReqQueue.q.push({fn:fn, res:res, rej:rej});
      window.ReqQueue.run();
    });
  },
  run: function() {
    while(window.ReqQueue.running < window.ReqQueue.max && window.ReqQueue.q.length) {
      var item = window.ReqQueue.q.shift();
      window.ReqQueue.running++;
      item.fn().then(function(v){window.ReqQueue.running--;item.res(v);window.ReqQueue.run();})
               .catch(function(e){window.ReqQueue.running--;item.rej(e);window.ReqQueue.run();});
    }
  }
};

// Cache layer — reduce duplicate API calls
window.Cache = {
  _store: {},
  get: function(k) { var v=this._store[k]; return v && Date.now()-v.t < v.ttl ? v.d : null; },
  set: function(k, d, ttl) { this._store[k]={d:d,t:Date.now(),ttl:ttl||60000}; },
  clear: function() { this._store={}; }
};

// GPS cache — don't call GPS more than once per 3s
window.GPS_CACHE = { lat: null, lng: null, ts: 0, TTL: 3000 };
</script>


<!-- ✅ Mappls Map SDK v3 — Full India Vector Maps (Leaflet bundled inside) -->
<script>window.MAPPLS_KEY='4e97759ed6a3fb245e52f7e22d820954';</script>
<!-- ✅ Mappls SDK v3 — Map + Direction + Navigation + Search plugins -->
<link href="https://apis.mappls.com/advancedmaps/api/4e97759ed6a3fb245e52f7e22d820954/map_sdk?v=3.0&plugins=direction,search" rel="stylesheet">
<script src="https://apis.mappls.com/advancedmaps/api/4e97759ed6a3fb245e52f7e22d820954/map_sdk?v=3.0&plugins=direction,search"></script>

<style>
:root{
  --bg:#07090f;--card:#0d1219;--card2:#131b25;
  --border:#1a2535;--text:#eaf0fb;--muted:#4d6a8a;
  --yellow:#f59e0b;--green:#10b981;--red:#ef4444;--blue:#3b82f6;
  --orange:#f97316;--purple:#8b5cf6;
}
body.lm{--bg:#f0f4fb;--card:#fff;--card2:#e8eef8;--border:#c8d4e4;--text:#0c1929;--muted:#4d6a8a;}
*{margin:0;padding:0;box-sizing:border-box;-webkit-tap-highlight-color:transparent;}
body{font-family:'DM Sans',sans-serif;background:#0a0e16;color:var(--text);height:100vh;overflow:hidden;}

/* ══ MAP ══ */
#map{position:fixed;inset:0;z-index:1;width:100vw;height:100vh;background:#e8ecf0;
  will-change:transform;
  transform:translateZ(0);
  -webkit-transform:translateZ(0);}

/* ══ MAPPLS MAP — Full Screen, Uber-clean ══ */
.leaflet-control-zoom,.leaflet-control-scale,
.mappls-ctrl-zoom,.mappls-ctrl-scale{display:none!important;}
.leaflet-control-attribution,.mappls-ctrl-attrib-container{
  font-size:7px!important;opacity:.15!important;bottom:2px!important;right:4px!important;}
.leaflet-popup-content-wrapper,.mappls-popup-content-wrapper{
  background:rgba(255,255,255,.97)!important;color:#0c1929!important;
  border:none!important;border-radius:18px!important;
  font-family:'DM Sans',sans-serif!important;
  box-shadow:0 8px 32px rgba(0,0,0,.18),0 2px 8px rgba(0,0,0,.12)!important;}
.leaflet-popup-tip,.mappls-popup-tip{background:rgba(255,255,255,.97)!important;}
.leaflet-popup-content,.mappls-popup-content{margin:10px 14px!important;font-size:.82rem!important;color:#0c1929!important;}

/* ✅ GPU-accelerated tile layer */
.leaflet-tile-container,.leaflet-map-pane{will-change:transform;transform:translateZ(0);}
.leaflet-marker-pane,.leaflet-overlay-pane{will-change:transform;}

/* ══ UBER ZOOM CONTROLS ══ */
.zoom-ctrl{position:fixed;right:14px;z-index:500;display:flex;flex-direction:column;gap:5px;}
.zbtn{width:44px;height:44px;background:white;border:none;border-radius:12px;font-size:1.25rem;font-weight:800;cursor:pointer;
  box-shadow:0 4px 20px rgba(0,0,0,.22);display:flex;align-items:center;justify-content:center;
  color:#000;transition:transform .12s,box-shadow .18s;}
.zbtn:active{transform:scale(.92);box-shadow:0 2px 10px rgba(0,0,0,.18);}
body.lm .zbtn{background:#fff;color:#000;}

/* ══ TOP BAR — Uber minimal ghost ══ */
.tb{position:fixed;top:0;left:0;right:0;z-index:500;display:flex;justify-content:space-between;
  align-items:center;padding:14px 16px;
  background:linear-gradient(to bottom,rgba(0,0,0,.55) 0%,transparent 100%);
  pointer-events:none;}
.tb>*{pointer-events:all;}
.tb-logo{font-family:'Syne',sans-serif;font-weight:900;color:white;font-size:1rem;
  letter-spacing:.06em;text-shadow:0 2px 8px rgba(0,0,0,.5);}
.tb-actions{display:flex;gap:8px;}
.tbtn{height:38px;background:rgba(255,255,255,.15);border:1px solid rgba(255,255,255,.18);
  border-radius:99px;display:flex;align-items:center;justify-content:center;cursor:pointer;
  padding:0 13px;font-size:.76rem;font-weight:700;color:white;gap:5px;
  backdrop-filter:blur(16px);transition:background .15s;}
.tbtn:active{background:rgba(255,255,255,.28);}
body.lm .tbtn{background:rgba(0,0,0,.1);color:#000;border-color:rgba(0,0,0,.15);}
.tbtn-icon{height:38px;width:38px;padding:0;border-radius:50%;}

/* ══ MAP STYLE TOGGLE FAB ══ */
#mapStyleBtn{background:#1a2535;border:1.5px solid rgba(255,255,255,.15);color:white;font-size:1rem;}
#mapStyleBtn.satellite{background:rgba(245,158,11,.2);border-color:rgba(245,158,11,.5);}

/* ══ LOCATE BUTTON — Uber FAB ══ */
.locbtn{position:fixed;right:14px;z-index:500;width:48px;height:48px;
  background:white;border-radius:50%;border:none;cursor:pointer;font-size:1.1rem;
  box-shadow:0 4px 20px rgba(0,0,0,.28);display:flex;align-items:center;justify-content:center;
  transition:transform .12s;}
.locbtn:active{transform:scale(.93);}

/* ══ MAP STATS CHIPS — Uber top pill style ══ */
#mapStats{position:fixed;top:68px;left:12px;right:12px;z-index:450;display:none;pointer-events:none;}
.ms-row{display:flex;gap:6px;justify-content:center;}
.ms-chip{background:rgba(0,0,0,.62);backdrop-filter:blur(20px);
  border:1px solid rgba(255,255,255,.12);border-radius:99px;
  padding:6px 14px;font-size:.7rem;font-weight:700;
  display:flex;align-items:center;gap:5px;pointer-events:all;cursor:pointer;color:white;}
.ms-dot{width:7px;height:7px;border-radius:50%;flex-shrink:0;}
body.lm .ms-chip{background:rgba(255,255,255,.88);color:#000;}

/* ══ ZONE LEGEND — compact, hidden by default ══ */
#zoneLegend{position:fixed;left:12px;z-index:450;background:rgba(10,14,22,.92);
  backdrop-filter:blur(20px);border:1px solid rgba(255,255,255,.08);
  border-radius:16px;padding:12px 15px;display:none;min-width:155px;}
body.lm #zoneLegend{background:rgba(255,255,255,.95);color:#000;}
.zl-title{font-size:.6rem;font-weight:800;color:var(--muted);text-transform:uppercase;letter-spacing:.06em;margin-bottom:8px;}
.zl-row{display:flex;align-items:center;gap:7px;margin-bottom:5px;font-size:.72rem;font-weight:600;}
.zl-dot{width:10px;height:10px;border-radius:50%;flex-shrink:0;}
.zl-tag{font-size:.6rem;color:var(--muted);margin-left:auto;}

/* ══ MAPPLS-STYLE FULL SCREEN BOTTOM SHEET (Glass) ══ */
.sheet{position:fixed;bottom:0;left:0;right:0;z-index:400;
  background:rgba(7,9,15,0.96);
  border-radius:22px 22px 0 0;
  border-top:1px solid rgba(255,255,255,.09);
  padding:0 16px 36px;
  max-height:48vh;
  overflow-y:auto;display:none;
  box-shadow:0 -8px 40px rgba(0,0,0,.7);
  will-change:transform;}
.sheet::-webkit-scrollbar{display:none;}
body.lm .sheet{background:rgba(240,244,251,.98);border-top:1px solid rgba(0,0,0,.05);}
.hdl{width:32px;height:3.5px;background:rgba(255,255,255,.1);border-radius:4px;margin:10px auto 14px;}
body.lm .hdl{background:rgba(0,0,0,.08);}

/* ══ SEARCH BAR inside sheet — Uber style ══ */
.lbs{display:flex;flex-direction:column;margin-bottom:10px;}
.lb{display:flex;align-items:center;gap:12px;
  background:rgba(255,255,255,.05);
  border:1.5px solid rgba(255,255,255,.07);padding:13px 14px;transition:all .2s;}
.lb:first-child{border-radius:14px 14px 0 0;border-bottom:none;}
.lb:last-child{border-radius:0 0 14px 14px;border-bottom-width:1.5px;}
.lb:last-child:focus-within{border-color:var(--yellow);}
body.lm .lb{background:rgba(0,0,0,.04);border-color:rgba(0,0,0,.08);}

/* ══ MAPPLS AUTOCOMPLETE DROPDOWN ══ */
#dropSuggest{
  position:absolute;left:0;right:0;
  background:#0d1525;
  border:1px solid rgba(255,255,255,.1);
  border-radius:0 0 16px 16px;
  max-height:220px;overflow-y:auto;
  z-index:9999;
  box-shadow:0 12px 40px rgba(0,0,0,.7);
  display:none;
}
body.lm #dropSuggest{background:#fff;border-color:rgba(0,0,0,.1);}
#dropSuggest::-webkit-scrollbar{display:none;}
.sug-item{display:flex;align-items:center;gap:10px;padding:11px 14px;cursor:pointer;
  border-bottom:1px solid rgba(255,255,255,.04);transition:background .15s;}
.sug-item:last-child{border-bottom:none;}
.sug-item:active,.sug-item:hover{background:rgba(245,158,11,.1);}
body.lm .sug-item:hover{background:#f5f8ff;}
.sug-icon{width:30px;height:30px;border-radius:8px;background:rgba(255,255,255,.06);
  display:flex;align-items:center;justify-content:center;font-size:.9rem;flex-shrink:0;}
.sug-main{font-size:.82rem;font-weight:700;color:var(--text);}
.sug-sub{font-size:.66rem;color:var(--muted);margin-top:1px;}
.sug-dist{font-size:.65rem;color:var(--yellow);font-weight:700;margin-left:auto;flex-shrink:0;}

/* Wrap the drop input lb for positioning */
#dropLbWrap{position:relative;}

/* ══ QUICK PLACES SCROLL ══ */
.qp-label{font-size:.6rem;font-weight:800;color:var(--muted);
  text-transform:uppercase;letter-spacing:.06em;margin-bottom:8px;}
.qp-scroll{display:flex;gap:8px;overflow-x:auto;padding-bottom:4px;margin-bottom:10px;}
.qp-scroll::-webkit-scrollbar{display:none;}
.qp-chip{flex-shrink:0;background:rgba(255,255,255,.06);border:1px solid rgba(255,255,255,.09);
  border-radius:99px;padding:7px 14px;font-size:.75rem;font-weight:700;
  cursor:pointer;white-space:nowrap;transition:all .18s;}
.qp-chip:active{background:rgba(245,158,11,.15);border-color:var(--yellow);}
body.lm .qp-chip{background:#f0f4ff;border-color:#dde5f0;}

/* ══ FIND DRIVER BUTTON — Uber yellow ══ */
.mbtn{width:100%;border:none;border-radius:16px;padding:16px;
  font-size:.96rem;font-weight:900;cursor:pointer;margin-top:8px;
  font-family:'Syne',sans-serif;transition:transform .1s,box-shadow .2s;}
.mbtn:active{transform:scale(.97);}
.mbtn:disabled{opacity:.65;cursor:not-allowed;transform:none;}
.mbtn.y{background:var(--yellow);color:#000;
  box-shadow:0 6px 24px rgba(245,158,11,.4),0 2px 8px rgba(245,158,11,.2);}
.mbtn.ro{background:rgba(239,68,68,.08);color:var(--red);border:1px solid rgba(239,68,68,.2);}
.mbtn.g{background:var(--green);color:#fff;box-shadow:0 6px 24px rgba(16,185,129,.35);}
.mbtn.b{background:var(--blue);color:#fff;}

/* ══ MARKERS ══ */
.my-loc-wrap{position:relative;width:24px;height:24px;display:flex;align-items:center;justify-content:center;}
.my-loc-dot{width:13px;height:13px;background:#3b82f6;border:2.5px solid #fff;border-radius:50%;z-index:2;position:relative;
  will-change:box-shadow;
  box-shadow:0 0 0 0 rgba(59,130,246,.5);animation:locpulse 2s infinite;}
.my-loc-wave{position:absolute;width:24px;height:24px;border:2px solid rgba(59,130,246,.4);border-radius:50%;
  will-change:transform,opacity;
  animation:locwave 2s infinite;}
@keyframes locpulse{0%{box-shadow:0 0 0 0 rgba(59,130,246,.7)}70%{box-shadow:0 0 0 12px rgba(59,130,246,0)}100%{box-shadow:0 0 0 0 rgba(59,130,246,0)}}
@keyframes locwave{0%{transform:scale(.7);opacity:1}100%{transform:scale(2.2);opacity:0}}

.driver-dot-wrap{position:relative;display:flex;flex-direction:column;align-items:center;}
.driver-car{font-size:22px;line-height:1;filter:drop-shadow(0 3px 6px rgba(0,0,0,.8));
  will-change:transform;animation:carfloat 3s ease-in-out infinite;}
.driver-dot-shadow{width:10px;height:3px;background:rgba(0,0,0,.5);border-radius:50%;margin-top:1px;}
@keyframes carfloat{0%,100%{transform:translateY(0) scale(1)}50%{transform:translateY(-3px) scale(1.05)}}

.assigned-car{font-size:30px;line-height:1;filter:drop-shadow(0 4px 10px rgba(245,158,11,.6));
  will-change:transform;animation:assignedcar 1s ease-in-out infinite;}
@keyframes assignedcar{0%,100%{transform:scale(1)}50%{transform:scale(1.12)}}

.pickup-wrap{display:flex;flex-direction:column;align-items:center;}
.pickup-icon{font-size:28px;filter:drop-shadow(0 3px 8px rgba(16,185,129,.6));}
.drop-icon{font-size:28px;filter:drop-shadow(0 3px 8px rgba(239,68,68,.6));}
.landmark-icon{font-size:18px;opacity:.85;}

/* ══ LIVE MAP OVERLAY BADGES ══ */
#mapStats{position:fixed;top:60px;left:12px;right:12px;z-index:450;display:none;pointer-events:none;}
.ms-row{display:flex;gap:7px;justify-content:center;}
.ms-chip{background:rgba(7,9,15,.88);backdrop-filter:blur(12px);border:1px solid rgba(255,255,255,.1);border-radius:99px;padding:5px 12px;font-size:.68rem;font-weight:700;display:flex;align-items:center;gap:5px;pointer-events:all;cursor:pointer;}
.ms-dot{width:7px;height:7px;border-radius:50%;flex-shrink:0;}
body.lm .ms-chip{background:rgba(255,255,255,.92);color:#000;}

/* ══ ZONE LEGEND ══ */
#zoneLegend{position:fixed;left:12px;z-index:450;background:rgba(7,9,15,.9);backdrop-filter:blur(14px);border:1px solid rgba(255,255,255,.1);border-radius:13px;padding:10px 13px;display:none;min-width:145px;}
body.lm #zoneLegend{background:rgba(255,255,255,.95);color:#000;}
.zl-title{font-size:.6rem;font-weight:800;color:var(--muted);text-transform:uppercase;letter-spacing:.06em;margin-bottom:7px;}
.zl-row{display:flex;align-items:center;gap:7px;margin-bottom:5px;font-size:.7rem;font-weight:600;}
.zl-dot{width:10px;height:10px;border-radius:50%;flex-shrink:0;}
.zl-tag{font-size:.58rem;color:var(--muted);margin-left:auto;}

/* ══ MAPPLS NAVIGATION UI — Turn-by-turn like screenshot ══ */

/* Navigation TOP instruction bar — Blue like Mappls */
#navBar{
  position:fixed;top:0;left:0;right:0;z-index:800;
  background:linear-gradient(135deg,#1565C0,#1976D2);
  padding:0;display:none;
  box-shadow:0 4px 20px rgba(0,0,0,.5);
  animation:navSlideIn .3s ease;
}
@keyframes navSlideIn{from{transform:translateY(-100%)}to{transform:translateY(0)}}

#navBar .nav-main{
  display:flex;align-items:center;gap:0;padding:14px 16px 10px;
}
#navBar .nav-arrow-box{
  width:72px;height:72px;
  display:flex;align-items:center;justify-content:center;
  font-size:3rem;flex-shrink:0;
}
#navBar .nav-dist{
  font-family:'Syne',sans-serif;font-weight:900;font-size:2.4rem;
  color:white;line-height:1;
}
#navBar .nav-dist-unit{
  font-size:1rem;font-weight:600;margin-left:4px;color:rgba(255,255,255,.8);
}
#navBar .nav-instruction{
  flex:1;font-size:1.3rem;font-weight:800;color:white;
  margin-left:12px;line-height:1.2;
}
#navBar .nav-next-wrap{
  background:rgba(255,255,255,.15);
  border-radius:10px;
  margin:0 14px 12px;
  padding:8px 12px;
  display:flex;align-items:center;gap:10px;
}
#navBar .nav-next-label{
  font-size:.72rem;color:rgba(255,255,255,.7);font-weight:700;text-transform:uppercase;
}
#navBar .nav-next-dist{
  font-size:.82rem;font-weight:800;color:white;
}
#navBar .nav-next-arrow{font-size:1.1rem;}

/* Speed box — bottom left like Mappls */
#navSpeed{
  position:fixed;left:14px;z-index:800;
  background:#222;border-radius:50%;
  width:68px;height:68px;
  display:none;
  flex-direction:column;align-items:center;justify-content:center;
  box-shadow:0 4px 20px rgba(0,0,0,.6);
  border:3px solid rgba(255,255,255,.15);
}
#navSpeed .spd-val{
  font-family:'Syne',sans-serif;font-weight:900;
  font-size:1.5rem;color:white;line-height:1;
}
#navSpeed .spd-unit{
  font-size:.55rem;color:rgba(255,255,255,.6);font-weight:700;text-transform:uppercase;
}

/* Navigation bottom ETA panel — like Mappls bottom bar */
#navETA{
  position:fixed;bottom:0;left:0;right:0;z-index:800;
  background:#0a0e16;
  border-top:1px solid rgba(255,255,255,.08);
  padding:14px 18px 30px;
  display:none;
  box-shadow:0 -8px 30px rgba(0,0,0,.5);
}
#navETA .eta-row{display:flex;align-items:center;justify-content:space-between;}
#navETA .eta-time{
  font-family:'Syne',sans-serif;font-weight:900;font-size:2rem;
  color:#f59e0b;line-height:1;
}
#navETA .eta-sub{font-size:.78rem;color:rgba(255,255,255,.6);margin-top:3px;}
#navETA .eta-arrival{font-size:.8rem;color:rgba(255,255,255,.5);}
#navETA .eta-actions{display:flex;gap:10px;align-items:center;}
#navETA .eta-btn{
  width:44px;height:44px;border-radius:50%;
  background:rgba(255,255,255,.08);border:1px solid rgba(255,255,255,.12);
  display:flex;align-items:center;justify-content:center;
  cursor:pointer;font-size:1.1rem;
}
#navETA .eta-close{
  width:44px;height:44px;border-radius:50%;
  background:rgba(239,68,68,.15);border:1px solid rgba(239,68,68,.3);
  display:flex;align-items:center;justify-content:center;
  cursor:pointer;font-size:1rem;color:var(--red);font-weight:800;
}

/* Recenter FAB — like Mappls */
#navRecenter{
  position:fixed;right:14px;z-index:800;
  width:52px;height:52px;
  background:#2a2a2a;border-radius:50%;
  border:none;cursor:pointer;
  display:none;
  align-items:center;justify-content:center;
  box-shadow:0 4px 18px rgba(0,0,0,.5);
  font-size:1rem;color:white;
  flex-direction:column;gap:2px;
}
#navRecenter .rc-arrow{font-size:1.1rem;}
#navRecenter .rc-label{font-size:.45rem;font-weight:700;text-transform:uppercase;color:rgba(255,255,255,.6);}

/* Step list panel (like Mappls "Next" steps) */
#navStepList{
  position:fixed;top:0;left:0;right:0;bottom:0;z-index:900;
  background:#0a0e16;display:none;flex-direction:column;
  animation:fup .25s ease;
}
#navStepList .sl-header{
  padding:14px 16px;border-bottom:1px solid rgba(255,255,255,.08);
  display:flex;align-items:center;gap:12px;
}
#navStepList .sl-title{font-family:'Syne',sans-serif;font-weight:900;font-size:1rem;}
#navStepList .sl-close{
  margin-left:auto;width:36px;height:36px;border:none;
  background:rgba(255,255,255,.07);border-radius:50%;
  cursor:pointer;font-size:.9rem;color:white;
}
#navStepList .sl-body{flex:1;overflow-y:auto;padding:10px 0;}
#navStepList .sl-body::-webkit-scrollbar{display:none;}
.step-item{display:flex;align-items:center;gap:12px;padding:12px 16px;border-bottom:1px solid rgba(255,255,255,.04);}
.step-item.active{background:rgba(245,158,11,.06);}
.step-icon{width:38px;height:38px;border-radius:50%;background:rgba(255,255,255,.07);display:flex;align-items:center;justify-content:center;font-size:1.1rem;flex-shrink:0;}
.step-item.active .step-icon{background:rgba(245,158,11,.2);}
.step-dist{font-size:.72rem;color:var(--muted);font-weight:700;}

/* Voice nav indicator */
#voiceIndicator{
  position:fixed;right:14px;z-index:800;
  width:44px;height:44px;
  background:#2a2a2a;border-radius:50%;
  border:none;cursor:pointer;
  display:none;align-items:center;justify-content:center;
  box-shadow:0 3px 12px rgba(0,0,0,.4);font-size:1rem;
}
#voiceIndicator.speaking{background:rgba(16,185,129,.2);border:2px solid var(--green);}

/* ══ DEMAND SURGE BANNER ══ */
#surgeBanner{position:fixed;top:0;left:0;right:0;z-index:600;background:linear-gradient(135deg,#f59e0b,#f97316);padding:7px 16px;text-align:center;font-size:.75rem;font-weight:800;color:#000;display:none;animation:surgeIn .4s ease;}
@keyframes surgeIn{from{transform:translateY(-100%)}to{transform:translateY(0)}}

/* ══ LOADER ══ */
#loader{position:fixed;inset:0;background:var(--bg);z-index:9999;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:16px;}
.ld-box{width:82px;height:82px;background:var(--yellow);border-radius:20px;display:flex;align-items:center;justify-content:center;font-family:'Syne',sans-serif;font-size:1.35rem;font-weight:900;color:#000;animation:ldp 2s infinite;}
@keyframes ldp{0%,100%{box-shadow:0 0 36px rgba(245,158,11,.45)}50%{box-shadow:0 0 72px rgba(245,158,11,.9)}}
.ld-t{font-family:'Syne',sans-serif;font-size:1.5rem;font-weight:900;letter-spacing:.06em;}
.ld-s{font-size:.75rem;color:var(--muted);text-align:center;}
.ld-bar-w{width:180px;height:3px;background:rgba(255,255,255,.07);border-radius:99px;overflow:hidden;}
.ld-bar{height:100%;width:0%;background:linear-gradient(90deg,var(--yellow),#f97316);border-radius:99px;transition:width .25s;}

/* ══ AUTH ══ */
#auth{position:fixed;inset:0;z-index:8000;display:none;flex-direction:column;background:var(--bg);overflow-y:auto;}
#auth::-webkit-scrollbar{display:none;}
.ah{position:relative;height:195px;overflow:hidden;flex-shrink:0;}
.ah img{width:100%;height:100%;object-fit:cover;opacity:.3;}
.ah-ov{position:absolute;inset:0;background:linear-gradient(to bottom,rgba(7,9,15,.05),rgba(7,9,15,1));display:flex;flex-direction:column;justify-content:flex-end;padding:20px;}
.ah-tag{display:inline-flex;align-items:center;gap:5px;background:rgba(245,158,11,.15);border:1px solid rgba(245,158,11,.3);border-radius:99px;padding:3px 10px;font-size:.62rem;font-weight:700;color:var(--yellow);margin-bottom:6px;}
.ab{padding:0 16px 48px;}
.rtog{display:flex;gap:4px;background:rgba(255,255,255,.04);border:1px solid var(--border);border-radius:13px;padding:4px;margin-bottom:14px;}
.rtab{flex:1;padding:11px;border-radius:9px;border:none;background:transparent;color:var(--muted);font-weight:700;cursor:pointer;font-size:.87rem;font-family:'DM Sans',sans-serif;}
.rtab.ar{background:var(--yellow);color:#000;}
.rtab.ad{background:var(--green);color:#fff;}
.atabs{display:flex;gap:4px;background:rgba(255,255,255,.04);border:1px solid var(--border);border-radius:11px;padding:4px;margin-bottom:16px;}
.atab{flex:1;padding:9px;border-radius:8px;border:none;background:transparent;color:var(--muted);font-weight:700;cursor:pointer;font-family:'DM Sans',sans-serif;}
.atab.on{background:var(--card2);color:var(--text);}
.afrm{display:none;}.afrm.sh{display:block;animation:fup .3s ease;}
@keyframes fup{from{opacity:0;transform:translateY(14px)}to{opacity:1;transform:translateY(0)}}
.fg{margin-bottom:12px;}
.fl{font-size:.65rem;font-weight:700;color:var(--muted);margin-bottom:5px;display:block;text-transform:uppercase;letter-spacing:.05em;}
.fi{width:100%;background:rgba(255,255,255,.04);border:1.5px solid var(--border);border-radius:11px;padding:12px 14px;color:var(--text);outline:none;font-family:'DM Sans',sans-serif;font-size:.9rem;transition:border-color .2s;}
.fi:focus{border-color:var(--yellow);}
.fi.gf:focus{border-color:var(--green);}
body.lm .fi{background:#fff;color:#0c1929;}
.fr{display:grid;grid-template-columns:1fr 1fr;gap:10px;}
.vg{display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-bottom:12px;}
.vc{background:rgba(255,255,255,.04);border:1.5px solid var(--border);border-radius:11px;padding:11px;text-align:center;cursor:pointer;transition:all .2s;}
.vc.on{border-color:var(--green);background:rgba(16,185,129,.08);}
.asub{width:100%;border:none;border-radius:13px;padding:15px;font-size:.94rem;font-weight:800;cursor:pointer;font-family:'Syne',sans-serif;}
.asub.y{background:var(--yellow);color:#000;}
.asub.g{background:var(--green);color:#fff;}
.fbb{display:inline-flex;align-items:center;gap:5px;border-radius:99px;padding:4px 11px;font-size:.63rem;font-weight:700;margin-bottom:13px;background:rgba(255,165,0,.1);border:1px solid rgba(255,165,0,.2);color:orange;}
.fbb.ok{background:rgba(16,185,129,.1);border-color:rgba(16,185,129,.2);color:var(--green);}
.fbb.er{background:rgba(239,68,68,.1);border-color:rgba(239,68,68,.2);color:var(--red);}
.eb{background:rgba(239,68,68,.1);border:1px solid rgba(239,68,68,.25);border-radius:11px;padding:10px 13px;font-size:.78rem;font-weight:600;color:var(--red);margin-bottom:11px;display:none;}

/* ══ TOP BAR ══ */
.tb{position:fixed;top:0;left:0;right:0;z-index:500;display:flex;justify-content:space-between;align-items:center;padding:11px 15px;background:linear-gradient(to bottom,rgba(0,0,0,.8) 0%,transparent 100%);}
.tbtn{height:36px;background:rgba(0,0,0,.58);border:1px solid rgba(255,255,255,.12);border-radius:9px;display:flex;align-items:center;justify-content:center;cursor:pointer;padding:0 11px;font-size:.76rem;font-weight:700;color:var(--text);gap:5px;backdrop-filter:blur(10px);}
body.lm .tbtn{background:rgba(255,255,255,.88);color:#000;}
.locbtn{position:fixed;right:15px;z-index:500;width:44px;height:44px;background:white;border-radius:50%;border:none;cursor:pointer;font-size:1.05rem;box-shadow:0 4px 18px rgba(0,0,0,.4);display:flex;align-items:center;justify-content:center;}

/* ══ SHEETS ══ */
.sheet{position:fixed;bottom:0;left:0;right:0;z-index:400;background:rgba(7,9,15,.97);backdrop-filter:blur(32px);border-radius:22px 22px 0 0;border-top:1px solid rgba(255,255,255,.07);padding:0 17px 34px;max-height:88vh;overflow-y:auto;display:none;}
.sheet::-webkit-scrollbar{display:none;}
body.lm .sheet{background:rgba(240,244,251,.97);}
.hdl{width:34px;height:4px;background:rgba(255,255,255,.1);border-radius:4px;margin:11px auto 17px;}
body.lm .hdl{background:rgba(0,0,0,.1);}

/* ══ SCREENS ══ */
.scr{display:none;}.scr.on{display:block;animation:fup .3s ease;}
.mbtn{width:100%;border:none;border-radius:14px;padding:15px;font-size:.94rem;font-weight:800;cursor:pointer;margin-top:9px;font-family:'Syne',sans-serif;transition:transform .1s,box-shadow .2s;}
.mbtn:active{transform:scale(.97);}
.mbtn:disabled{opacity:.65;cursor:not-allowed;transform:none;}
.mbtn.y{background:var(--yellow);color:#000;box-shadow:0 5px 20px rgba(245,158,11,.35);}
.mbtn.ro{background:rgba(239,68,68,.08);color:var(--red);border:1px solid rgba(239,68,68,.2);}
.mbtn.g{background:var(--green);color:#fff;box-shadow:0 5px 20px rgba(16,185,129,.3);}
.mbtn.b{background:var(--blue);color:#fff;}

/* ══ LOCATION BOXES ══ */
.lbs{display:flex;flex-direction:column;margin-bottom:11px;}
.lb{display:flex;align-items:center;gap:11px;background:rgba(255,255,255,.04);border:1.5px solid var(--border);padding:12px 13px;transition:all .2s;}
.lb:first-child{border-radius:13px 13px 0 0;border-bottom:none;}
.lb:last-child{border-radius:0 0 13px 13px;}
.lb:last-child:focus-within{border-color:var(--yellow);}
body.lm .lb{background:rgba(0,0,0,.03);}
.pdot{width:10px;height:10px;background:var(--green);border-radius:50%;flex-shrink:0;animation:dpulse 2s infinite;}
@keyframes dpulse{0%,100%{box-shadow:0 0 5px var(--green)}50%{box-shadow:0 0 14px var(--green)}}
.lspin{width:9px;height:9px;border:2px solid rgba(16,185,129,.3);border-top:2px solid var(--green);border-radius:50%;animation:spin .8s linear infinite;flex-shrink:0;}
@keyframes spin{to{transform:rotate(360deg)}}

/* ══ QUICK PLACES ══ */
.qp-label{font-size:.6rem;font-weight:700;color:var(--muted);text-transform:uppercase;letter-spacing:.06em;margin-bottom:7px;}
.qp-scroll{display:flex;gap:7px;overflow-x:auto;padding-bottom:6px;margin-bottom:12px;}
.qp-scroll::-webkit-scrollbar{display:none;}
.qp-chip{flex-shrink:0;background:rgba(255,255,255,.05);border:1px solid var(--border);border-radius:10px;padding:7px 11px;font-size:.74rem;font-weight:700;cursor:pointer;white-space:nowrap;transition:all .2s;}
.qp-chip:active{background:rgba(245,158,11,.12);border-color:var(--yellow);}
body.lm .qp-chip{background:#f1f5f9;}

/* ══ CHIPS ══ */
.chips{display:flex;gap:7px;margin-bottom:13px;}
.chip{flex:1;background:rgba(255,255,255,.04);border:1px solid var(--border);border-radius:11px;padding:9px 7px;text-align:center;}
body.lm .chip{background:#f1f5f9;}
.cv{font-weight:800;font-size:.97rem;font-family:'Syne',sans-serif;}
.cl{font-size:.58rem;font-weight:600;color:var(--muted);margin-top:2px;text-transform:uppercase;letter-spacing:.04em;}

/* ══ SURGE CHIP ══ */
.surge-chip{display:inline-flex;align-items:center;gap:4px;background:rgba(239,68,68,.1);border:1px solid rgba(239,68,68,.3);border-radius:99px;padding:3px 9px;font-size:.64rem;font-weight:800;color:var(--red);margin-bottom:10px;}

/* ══ RIDE OPTIONS ══ */
.ro-card{display:flex;align-items:center;padding:13px;background:rgba(255,255,255,.04);border:1.5px solid var(--border);border-radius:13px;margin-bottom:8px;cursor:pointer;transition:all .2s;}
.ro-card.sel{background:rgba(245,158,11,.06);border-color:var(--yellow);}
body.lm .ro-card{background:#fff;}
.ro-surge{font-size:.6rem;font-weight:800;background:rgba(239,68,68,.15);border:1px solid rgba(239,68,68,.3);color:var(--red);padding:2px 6px;border-radius:99px;margin-left:5px;}

/* ══ NEARBY DRIVERS PANEL ══ */
.nd-panel{background:rgba(255,255,255,.03);border:1px solid var(--border);border-radius:13px;padding:12px;margin-bottom:12px;}
.nd-row{display:flex;align-items:center;justify-content:space-between;margin-bottom:8px;}
.nd-title{font-size:.72rem;font-weight:800;color:var(--muted);text-transform:uppercase;letter-spacing:.05em;}
.nd-count{font-family:'Syne',sans-serif;font-weight:900;font-size:1.3rem;color:var(--green);}
.nd-bars{display:flex;gap:4px;align-items:flex-end;height:28px;}
.nd-bar{width:8px;background:rgba(16,185,129,.25);border-radius:3px;transition:height .4s ease;}
.nd-bar.active{background:var(--green);}
.nd-zone-row{display:flex;gap:6px;flex-wrap:wrap;margin-top:6px;}
.nd-zone{font-size:.64rem;font-weight:700;padding:3px 8px;border-radius:99px;}
.nd-zone.z1{background:rgba(16,185,129,.12);color:var(--green);border:1px solid rgba(16,185,129,.25);}
.nd-zone.z2{background:rgba(59,130,246,.12);color:var(--blue);border:1px solid rgba(59,130,246,.25);}
.nd-zone.z3{background:rgba(245,158,11,.12);color:var(--yellow);border:1px solid rgba(245,158,11,.25);}

/* ══ RADAR ══ */
.rdr{text-align:center;padding:20px 0;}
.rdr-rings{position:relative;width:90px;height:90px;margin:0 auto 16px;}
.r1{position:absolute;inset:0;border:2px solid rgba(245,158,11,.1);border-radius:50%;}
.r2{position:absolute;inset:10px;border:2px solid rgba(245,158,11,.18);border-radius:50%;}
.r3{position:absolute;inset:20px;border:3px solid transparent;border-top:3px solid var(--yellow);border-radius:50%;animation:spin .9s linear infinite;}
.r4{position:absolute;inset:34px;background:var(--yellow);border-radius:50%;box-shadow:0 0 16px rgba(245,158,11,.9);}
.r4-inner{position:absolute;inset:42px;background:rgba(245,158,11,.3);border-radius:50%;animation:rdpulse 1.2s ease-out infinite;}
@keyframes rdpulse{0%{transform:scale(1);opacity:1}100%{transform:scale(2.5);opacity:0}}

/* ══ DRIVER CARD ══ */
.dcard{display:flex;align-items:center;gap:13px;margin-bottom:14px;padding:13px;background:rgba(255,255,255,.03);border:1px solid var(--border);border-radius:15px;}
body.lm .dcard{background:#fff;}
.dava{width:52px;height:52px;background:linear-gradient(135deg,#1e2d4a,#253a5e);border-radius:50%;font-size:1.9rem;display:flex;align-items:center;justify-content:center;flex-shrink:0;}
.otp{background:var(--card2);padding:8px 11px;border-radius:10px;border:1px solid var(--border);text-align:center;min-width:65px;}
.star-row{display:flex;align-items:center;gap:3px;}
.star{color:var(--yellow);font-size:.8rem;}

/* ══ LIVE FARE METER ══ */
@keyframes farePulse{0%,100%{opacity:1}50%{opacity:.7}}
#liveFareMeter{animation:none;}
#liveFareMeter.running #liveFareAmount{animation:farePulse 2s infinite;}

/* ══ LIVE BADGE ══ */
.lbadge{display:flex;align-items:center;gap:7px;padding:8px 12px;border-radius:9px;margin-bottom:11px;font-size:.76rem;font-weight:600;}
.lbadge.g{background:rgba(16,185,129,.08);border:1px solid rgba(16,185,129,.2);color:var(--green);}
.lbadge.r{background:rgba(239,68,68,.08);border:1px solid rgba(239,68,68,.2);color:var(--red);}
.lbadge.b{background:rgba(59,130,246,.08);border:1px solid rgba(59,130,246,.2);color:var(--blue);}
.lbadge.o{background:rgba(249,115,22,.08);border:1px solid rgba(249,115,22,.2);color:var(--orange);}
.lbd{width:7px;height:7px;border-radius:50%;flex-shrink:0;}
.lbadge.g .lbd{background:var(--green);box-shadow:0 0 6px var(--green);}
.lbadge.r .lbd{background:var(--red);box-shadow:0 0 6px var(--red);}
.lbadge.b .lbd{background:var(--blue);box-shadow:0 0 6px var(--blue);animation:dpulse 1.5s infinite;}
.lbadge.o .lbd{background:var(--orange);box-shadow:0 0 6px var(--orange);animation:dpulse 1s infinite;}

/* ══ DRIVER DASHBOARD ══ */
#dTopBar{position:fixed;top:0;left:0;right:0;z-index:500;display:none;padding:11px 15px;background:linear-gradient(to bottom,rgba(0,0,0,.85),transparent);}
.d-nr{display:flex;align-items:center;justify-content:space-between;}
.d-nm{font-family:'Syne',sans-serif;font-weight:800;font-size:.92rem;color:white;}
.tgsw{position:relative;width:52px;height:27px;cursor:pointer;}
.tgsw input{opacity:0;width:0;height:0;}
.tgtr{position:absolute;inset:0;background:#2d3748;border-radius:99px;transition:background .3s;border:1.5px solid rgba(255,255,255,.08);}
.tgsw input:checked+.tgtr{background:var(--green);}
.tgth{position:absolute;height:19px;width:19px;left:4px;top:50%;transform:translateY(-50%);background:white;border-radius:50%;transition:transform .3s;box-shadow:0 2px 5px rgba(0,0,0,.3);}
.tgsw input:checked~.tgth{transform:translateY(-50%) translateX(25px);}

#dStats{position:fixed;top:62px;left:0;right:0;z-index:499;display:none;padding:0 13px;}
.dsr{display:flex;gap:7px;}
.dst{background:rgba(7,9,15,.9);backdrop-filter:blur(14px);border:1px solid rgba(255,255,255,.08);border-radius:11px;padding:9px 10px;flex:1;text-align:center;}
.dsv{font-family:'Syne',sans-serif;font-weight:800;font-size:.92rem;color:var(--yellow);}
.dsl{font-size:.55rem;color:var(--muted);font-weight:600;text-transform:uppercase;margin-top:1px;letter-spacing:.04em;}

/* ══ DRIVER PANELS ══ */
#dPanel{position:fixed;bottom:0;left:0;right:0;z-index:400;display:none;}
#dOff,#dOn,#dNav{background:rgba(7,9,15,.96);border-radius:22px 22px 0 0;border-top:1px solid rgba(255,255,255,.09);padding:18px 17px 32px;}
body.lm #dOff,body.lm #dOn,body.lm #dNav{background:rgba(240,244,251,.98);}
#dOff{text-align:center;}
#dOn,#dNav{display:none;}
.opulse{display:flex;align-items:center;gap:9px;background:rgba(16,185,129,.08);border:1px solid rgba(16,185,129,.2);border-radius:13px;padding:13px;margin-bottom:12px;}
.odpulse{width:9px;height:9px;background:var(--green);border-radius:50%;flex-shrink:0;animation:oping 1.8s infinite;}
@keyframes oping{0%{box-shadow:0 0 0 0 rgba(16,185,129,.5)}70%{box-shadow:0 0 0 9px rgba(16,185,129,0)}100%{box-shadow:0 0 0 0 rgba(16,185,129,0)}}

/* ══ DRIVER ZONE STATS ══ */
.dzone-row{display:grid;grid-template-columns:1fr 1fr;gap:7px;margin-bottom:10px;}
.dzone-card{background:rgba(255,255,255,.04);border:1px solid var(--border);border-radius:11px;padding:9px;text-align:center;}
.dzone-val{font-family:'Syne',sans-serif;font-weight:800;font-size:1.05rem;}
.dzone-lbl{font-size:.58rem;color:var(--muted);font-weight:700;margin-top:2px;text-transform:uppercase;letter-spacing:.04em;}

/* ══ REQUEST POPUP ══ */
#reqPopup{position:fixed;bottom:-110%;left:0;right:0;z-index:700;transition:bottom .45s cubic-bezier(.34,1.56,.64,1);}
#reqPopup.sh{bottom:0;}
.rpc{background:var(--bg);border-radius:26px 26px 0 0;border-top:1px solid rgba(255,255,255,.12);padding:18px 17px 34px;box-shadow:0 -16px 60px rgba(0,0,0,.7);}
body.lm .rpc{background:#fff;}
.rtring{position:relative;width:60px;height:60px;margin:0 auto 13px;}
.rtsvg{transform:rotate(-90deg);}
.rtcbg{fill:none;stroke:rgba(255,255,255,.07);stroke-width:5;}
.rtc{fill:none;stroke:var(--yellow);stroke-width:5;stroke-linecap:round;stroke-dasharray:163;stroke-dashoffset:0;transition:stroke-dashoffset 1s linear;}
.rtn{position:absolute;inset:0;display:flex;align-items:center;justify-content:center;font-family:'Syne',sans-serif;font-weight:900;font-size:1.25rem;color:var(--yellow);}
.trip-row{display:flex;align-items:stretch;gap:11px;margin:12px 0;}
.tdots{display:flex;flex-direction:column;align-items:center;gap:3px;padding-top:4px;}
.tdg{width:8px;height:8px;background:var(--green);border-radius:50%;flex-shrink:0;}
.tdl{width:2px;flex:1;background:rgba(255,255,255,.09);}
.tdr{width:8px;height:8px;background:var(--red);border-radius:50%;flex-shrink:0;}
.tadd{flex:1;}
.ta-row{padding:6px 0;border-bottom:1px solid rgba(255,255,255,.05);}
.ta-row:last-child{border-bottom:none;padding-bottom:0;}
.ta-lbl{font-size:.6rem;color:var(--muted);font-weight:700;text-transform:uppercase;letter-spacing:.04em;}
.ta-val{font-size:.86rem;font-weight:700;margin-top:2px;}
.req-btns{display:grid;grid-template-columns:1fr 1.6fr;gap:9px;margin-top:13px;}
.dist-badge{display:inline-flex;align-items:center;gap:4px;background:rgba(59,130,246,.12);border:1px solid rgba(59,130,246,.25);border-radius:99px;padding:3px 9px;font-size:.66rem;font-weight:700;color:var(--blue);}

/* ══ NAV ══ */
.nstep{display:flex;align-items:center;gap:11px;border-radius:13px;padding:11px 13px;margin-bottom:10px;}
.nstep.bl{background:rgba(59,130,246,.08);border:1px solid rgba(59,130,246,.2);}
.nstep.gr{background:rgba(16,185,129,.08);border:1px solid rgba(16,185,129,.2);}
.nicon{width:38px;height:38px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:1.1rem;flex-shrink:0;}
.nstep.bl .nicon{background:rgba(59,130,246,.15);}
.nstep.gr .nicon{background:rgba(16,185,129,.15);}

/* ══ TOAST ══ */
.toast{position:fixed;top:80px;left:50%;transform:translateX(-50%);background:rgba(10,15,24,.97);border:1px solid rgba(255,255,255,.1);border-radius:99px;padding:9px 20px;font-size:.78rem;font-weight:600;z-index:9999;animation:tin .3s ease,tout .3s ease 2.6s forwards;white-space:nowrap;box-shadow:0 6px 24px rgba(0,0,0,.45);max-width:88vw;text-overflow:ellipsis;overflow:hidden;}
@keyframes tin{from{opacity:0;top:60px}to{opacity:1;top:80px}}
@keyframes tout{to{opacity:0;top:60px}}

/* ══ NET ══ */
.netb{position:fixed;bottom:0;left:50%;transform:translateX(-50%);z-index:9998;background:#ef4444;color:#fff;padding:5px 16px;font-size:.73rem;font-weight:700;border-radius:99px 99px 0 0;display:none;}

/* ══ ASSIGNED ANIMATION ══ */
@keyframes assignBounce{0%{transform:scale(1)}20%{transform:scale(1.05)}40%{transform:scale(.98)}60%{transform:scale(1.03)}80%{transform:scale(.99)}100%{transform:scale(1)}}
.assign-bounce{animation:assignBounce .6s ease;}

/* ══ DRIVER PHOTO UPLOAD ══ */
.photo-upload-box{display:flex;flex-direction:column;align-items:center;gap:10px;background:rgba(255,255,255,.03);border:2px dashed rgba(16,185,129,.35);border-radius:16px;padding:16px;margin-bottom:13px;cursor:pointer;transition:all .2s;}
.photo-upload-box:hover,.photo-upload-box.has-photo{border-color:var(--green);background:rgba(16,185,129,.05);}
.photo-preview{width:80px;height:80px;border-radius:50%;object-fit:cover;border:3px solid var(--green);display:none;box-shadow:0 4px 16px rgba(16,185,129,.35);}
.photo-placeholder{width:80px;height:80px;border-radius:50%;background:rgba(255,255,255,.07);display:flex;align-items:center;justify-content:center;font-size:2rem;border:2px solid rgba(255,255,255,.1);}
.photo-upload-lbl{font-size:.75rem;font-weight:700;color:var(--green);}
.photo-upload-sub{font-size:.62rem;color:var(--muted);text-align:center;}
/* Driver photo in rider panel */
.dava-photo{width:52px;height:52px;border-radius:50%;object-fit:cover;border:2.5px solid var(--green);box-shadow:0 3px 12px rgba(16,185,129,.3);flex-shrink:0;}
.dava-verified{position:relative;flex-shrink:0;}
.dava-verified::after{content:'✅';position:absolute;bottom:-2px;right:-4px;font-size:.65rem;background:var(--card);border-radius:50%;padding:1px;}

/* ══ NEW FEATURES CSS ══ */
#histModal,#ratingModal,#receiptModal,#cancelModal,#msgModal,#promoModal{position:fixed;inset:0;z-index:9500;background:rgba(0,0,0,.82);display:none;align-items:flex-end;justify-content:center;backdrop-filter:blur(4px);}
#histModal.sh,#ratingModal.sh,#receiptModal.sh,#cancelModal.sh,#msgModal.sh,#promoModal.sh{display:flex;animation:fup .3s ease;}
.modal-box{background:var(--bg);border-radius:26px 26px 0 0;border-top:1px solid rgba(255,255,255,.1);padding:20px 18px 44px;width:100%;max-width:500px;max-height:88vh;overflow-y:auto;}
.modal-box::-webkit-scrollbar{display:none;}
body.lm .modal-box{background:#f0f4fb;}
.modal-hd{display:flex;align-items:center;justify-content:space-between;margin-bottom:16px;}
.modal-title{font-family:'Syne',sans-serif;font-weight:900;font-size:1.05rem;}
.modal-close{width:32px;height:32px;background:rgba(255,255,255,.07);border:none;border-radius:50%;cursor:pointer;font-size:1.1rem;color:var(--muted);}
.hist-item{display:flex;align-items:center;gap:12px;padding:11px 0;border-bottom:1px solid var(--border);}
.hist-item:last-child{border-bottom:none;}
.hist-icon{width:42px;height:42px;border-radius:50%;background:rgba(245,158,11,.1);border:1px solid rgba(245,158,11,.2);display:flex;align-items:center;justify-content:center;font-size:1.2rem;flex-shrink:0;}
.hist-info{flex:1;min-width:0;}
.hist-route{font-weight:700;font-size:.84rem;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
.hist-meta{font-size:.67rem;color:var(--muted);margin-top:2px;}
.hist-fare{font-family:'Syne',sans-serif;font-weight:900;font-size:.95rem;color:var(--yellow);}
.hist-tag{font-size:.6rem;font-weight:800;padding:2px 8px;border-radius:99px;display:inline-block;margin-top:3px;}
.hist-tag.done{background:rgba(16,185,129,.12);color:var(--green);}
.hist-tag.cancel{background:rgba(239,68,68,.12);color:var(--red);}
.star-big{font-size:2.4rem;cursor:pointer;transition:transform .15s;filter:grayscale(1);opacity:.4;display:inline-block;}
.star-big.lit{filter:none;opacity:1;}
.star-big:active{transform:scale(1.3);}
.rcpt-row{display:flex;justify-content:space-between;align-items:center;padding:8px 0;border-bottom:1px solid var(--border);font-size:.83rem;}
.rcpt-row:last-child{border-bottom:none;}
.fav-row{display:grid;grid-template-columns:1fr 1fr;gap:9px;margin-bottom:12px;}
.fav-chip{display:flex;align-items:center;gap:8px;background:rgba(255,255,255,.04);border:1.5px solid var(--border);border-radius:13px;padding:10px 12px;cursor:pointer;transition:all .2s;}
.fav-chip.set{border-color:var(--yellow);background:rgba(245,158,11,.07);}
body.lm .fav-chip{background:#fff;}
#sosBtn{position:fixed;right:14px;z-index:700;width:50px;height:50px;background:var(--red);border-radius:50%;border:3px solid rgba(255,255,255,.3);cursor:pointer;font-size:1.2rem;display:none;align-items:center;justify-content:center;box-shadow:0 0 0 0 rgba(239,68,68,.7);animation:sosPulse 2s infinite;}
@keyframes sosPulse{0%{box-shadow:0 0 0 0 rgba(239,68,68,.7)}70%{box-shadow:0 0 0 16px rgba(239,68,68,0)}100%{box-shadow:0 0 0 0 rgba(239,68,68,0)}}
.qmsg-chip{display:inline-flex;align-items:center;gap:5px;background:rgba(255,255,255,.05);border:1px solid var(--border);border-radius:99px;padding:7px 13px;font-size:.76rem;font-weight:600;cursor:pointer;margin:4px;}
.qmsg-chip:active{background:rgba(59,130,246,.15);border-color:var(--blue);}
.promo-strip{background:linear-gradient(135deg,rgba(139,92,246,.12),rgba(59,130,246,.1));border:1px solid rgba(139,92,246,.3);border-radius:13px;padding:10px 13px;margin-bottom:11px;display:flex;align-items:center;gap:10px;cursor:pointer;}
.promo-tag{background:var(--purple);color:#fff;border-radius:6px;padding:2px 8px;font-size:.6rem;font-weight:800;}
.earn-bar-bg{height:8px;background:rgba(255,255,255,.07);border-radius:99px;overflow:hidden;margin-top:4px;}
.earn-bar-fill{height:100%;border-radius:99px;background:linear-gradient(90deg,var(--yellow),var(--orange));transition:width .8s;}
.cancel-opt{display:flex;align-items:center;gap:10px;padding:12px 14px;border:1.5px solid var(--border);border-radius:12px;cursor:pointer;margin-bottom:8px;transition:all .2s;}
.cancel-opt.sel{border-color:var(--red);background:rgba(239,68,68,.07);}
.wa-btn{display:flex;align-items:center;justify-content:center;gap:8px;background:linear-gradient(135deg,#25d366,#128c7e);color:#fff;border-radius:13px;padding:13px;font-weight:800;font-size:.9rem;text-decoration:none;margin-top:9px;}
/* ✅ FIX 1: eta-big was missing - ETA countdown styling */
.eta-big{font-family:'Syne',sans-serif;font-weight:900;font-size:2.2rem;color:var(--blue);letter-spacing:.01em;margin:4px 0;line-height:1.1;}
/* ✅ Active ride highlight */
.assigned-glow{animation:assignGlow 2s ease-in-out infinite;}
@keyframes assignGlow{0%,100%{box-shadow:0 0 0 0 rgba(16,185,129,.2)}50%{box-shadow:0 0 24px 4px rgba(16,185,129,.15)}}
/* ══ CALL BUTTON ══ */
.call-btn{display:flex;align-items:center;justify-content:center;gap:7px;width:100%;border:none;border-radius:13px;padding:13px;font-size:.92rem;font-weight:800;cursor:pointer;font-family:'Syne',sans-serif;background:linear-gradient(135deg,#16a34a,#15803d);color:#fff;box-shadow:0 5px 18px rgba(22,163,74,.4);transition:transform .1s,box-shadow .2s;margin-top:8px;text-decoration:none;}
.call-btn:active{transform:scale(.97);box-shadow:0 2px 8px rgba(22,163,74,.3);}
.call-btn .call-pulse{width:9px;height:9px;background:#fff;border-radius:50%;animation:dpulse 1.2s infinite;}
.call-btn-mini{display:inline-flex;align-items:center;justify-content:center;gap:5px;border:none;border-radius:99px;padding:7px 14px;font-size:.75rem;font-weight:800;cursor:pointer;font-family:'DM Sans',sans-serif;background:linear-gradient(135deg,#16a34a,#15803d);color:#fff;box-shadow:0 3px 12px rgba(22,163,74,.4);transition:transform .1s;text-decoration:none;}
.call-btn-mini:active{transform:scale(.96);}
.call-ring{display:inline-block;animation:callring .6s infinite alternate;}
@keyframes callring{0%{transform:rotate(-15deg)}100%{transform:rotate(15deg)}}

/* ══ TRENDING 2024: ROUTE PILL (above bottom sheet) ══ */
#routePill{position:fixed;bottom:0;left:50%;transform:translateX(-50%);z-index:395;
  display:none;pointer-events:none;
  transition:bottom .3s ease;}
.rp-inner{display:flex;align-items:center;gap:0;background:rgba(7,9,15,.9);
  border:1px solid rgba(255,255,255,.1);border-radius:99px;
  padding:8px 4px;backdrop-filter:blur(16px);
  box-shadow:0 4px 20px rgba(0,0,0,.5);}
.rp-seg{display:flex;flex-direction:column;align-items:center;padding:0 16px;font-size:.68rem;}
.rp-val{font-family:'Syne',sans-serif;font-weight:900;font-size:1.1rem;color:white;line-height:1;}
.rp-lbl{color:rgba(255,255,255,.45);font-size:.58rem;font-weight:700;text-transform:uppercase;letter-spacing:.04em;margin-top:1px;}
.rp-div{width:1px;height:28px;background:rgba(255,255,255,.1);}

/* ══ TRENDING: DRIVER CARD ON MAP (rider sees driver approaching) ══ */
#driverApproachBar{position:fixed;top:0;left:0;right:0;z-index:450;
  display:none;
  padding:10px 14px 10px;
  background:linear-gradient(180deg,rgba(7,9,15,1) 0%,rgba(7,9,15,0) 100%);}
.dab-inner{display:flex;align-items:center;gap:10px;background:rgba(16,185,129,.12);
  border:1.5px solid rgba(16,185,129,.3);border-radius:16px;padding:10px 14px;}
.dab-car{font-size:1.8rem;}
.dab-info{flex:1;min-width:0;}
.dab-name{font-weight:800;font-size:.9rem;color:white;}
.dab-sub{font-size:.68rem;color:rgba(16,185,129,.9);font-weight:700;margin-top:1px;}
.dab-eta{text-align:right;}
.dab-min{font-family:'Syne',sans-serif;font-weight:900;font-size:1.5rem;color:var(--green);line-height:1;}
.dab-away{font-size:.6rem;color:var(--muted);}

/* ══ TRENDING: BOTTOM SHEET PICKUP STRIP — always shows pickup ══ */
.pickup-strip{display:flex;align-items:center;gap:8px;
  padding:9px 12px;background:rgba(255,255,255,.04);
  border-radius:12px;margin-bottom:10px;border:1px solid rgba(255,255,255,.07);}
.pickup-strip .psdot{width:9px;height:9px;border-radius:50%;background:#10b981;flex-shrink:0;
  box-shadow:0 0 6px #10b981;}
.pickup-strip .ps-addr{flex:1;font-size:.8rem;font-weight:700;
  white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
.pickup-strip .ps-gps{font-size:.65rem;color:var(--muted);}
body.lm .pickup-strip{background:rgba(0,0,0,.04);}

/* ══ TRENDING: RIDE TYPE CARDS — Ola/Uber 2024 ══ */
.ro-card{display:flex;align-items:center;gap:0;
  border:1.5px solid var(--border);border-radius:16px;padding:13px 14px;
  cursor:pointer;transition:all .2s;margin-bottom:8px;position:relative;overflow:hidden;}
.ro-card::before{content:'';position:absolute;inset:0;background:transparent;transition:background .2s;}
.ro-card.sel{border-color:var(--yellow);background:rgba(245,158,11,.06);}
.ro-card.sel::before{background:rgba(245,158,11,.03);}
.ro-card:active{transform:scale(.98);}
.ro-eta-badge{position:absolute;top:8px;right:10px;background:rgba(16,185,129,.12);
  border:1px solid rgba(16,185,129,.25);border-radius:99px;
  padding:2px 8px;font-size:.6rem;font-weight:800;color:var(--green);}
.ro-badge-popular{background:rgba(245,158,11,.15);border-color:rgba(245,158,11,.3);color:var(--yellow);}

/* ══ DRIVER MAP MINI-PANEL — Ola style clean ══ */
#driverMapPanel{position:fixed;bottom:0;left:0;right:0;z-index:399;
  display:none;
  background:rgba(7,9,15,.97);
  border-radius:22px 22px 0 0;
  border-top:1px solid rgba(255,255,255,.08);
  padding:12px 15px 32px;
  max-height:46vh;overflow-y:auto;}
#driverMapPanel::-webkit-scrollbar{display:none;}

/* ══ DRIVER INCOME PILL ══ */
.earn-pill{display:flex;align-items:center;gap:6px;background:rgba(16,185,129,.1);
  border:1px solid rgba(16,185,129,.2);border-radius:99px;padding:5px 12px;
  font-size:.72rem;font-weight:700;color:var(--green);}

/* ══ LIVE DISTANCE FLOAT — positioned above sheet ══ */
#liveDistFloat{position:fixed;left:50%;transform:translateX(-50%);
  z-index:420;display:none;pointer-events:none;}
.ldf-inner{background:rgba(0,0,0,.82);backdrop-filter:blur(12px);
  border:1px solid rgba(255,255,255,.12);border-radius:99px;
  padding:6px 16px;display:flex;align-items:center;gap:6px;
  font-size:.75rem;font-weight:700;color:white;}
.ldf-dot{width:7px;height:7px;border-radius:50%;background:var(--blue);
  animation:dpulse 1.2s infinite;flex-shrink:0;}

/* ══ TRENDING: SAFETY FEATURES BAR ══ */
.safety-row{display:flex;gap:6px;margin-top:8px;}
.safety-btn{flex:1;display:flex;flex-direction:column;align-items:center;gap:3px;
  background:rgba(255,255,255,.04);border:1px solid var(--border);
  border-radius:12px;padding:9px 6px;cursor:pointer;font-size:.62rem;
  font-weight:700;color:var(--muted);transition:all .18s;}
.safety-btn:active{background:rgba(255,255,255,.1);}
.safety-btn .sb-icon{font-size:1.2rem;}

/* ══ FARE BREAKDOWN — Trending transparent pricing ══ */
.fare-row{display:flex;justify-content:space-between;align-items:center;
  padding:7px 0;border-bottom:1px solid rgba(255,255,255,.05);font-size:.78rem;}
.fare-row:last-child{border-bottom:none;}
.fare-row.total{font-weight:900;font-size:.92rem;padding-top:10px;}
body.lm .fare-row{border-color:rgba(0,0,0,.06);}

/* ══ DRIVER OLA-STYLE — request popup improved ══ */
.req-chip{display:inline-flex;align-items:center;gap:4px;background:rgba(255,255,255,.05);
  border:1px solid var(--border);border-radius:8px;padding:6px 10px;
  font-family:'Syne',sans-serif;font-weight:900;font-size:1rem;text-align:center;}
.req-chip-lbl{font-size:.52rem;color:var(--muted);font-weight:700;
  text-transform:uppercase;letter-spacing:.04em;margin-top:1px;}

/* ══════════════════════════════════════════════════════════
   🆕 NEW MAPPLS FEATURES CSS
   eLoc, Fleet Tracking, VRP, Snap-to-Road, Multilingual
══════════════════════════════════════════════════════════ */

/* ── eLoc Search Bar ── */
#elocPanel{position:fixed;top:60px;left:12px;right:12px;z-index:460;display:none;}
.eloc-bar{display:flex;align-items:center;gap:8px;
  background:rgba(10,14,22,.96);backdrop-filter:blur(20px);
  border:1.5px solid rgba(99,102,241,.45);border-radius:16px;
  padding:10px 14px;box-shadow:0 6px 30px rgba(99,102,241,.25);}
.eloc-badge{background:linear-gradient(135deg,#6366f1,#8b5cf6);color:#fff;
  border-radius:8px;padding:4px 10px;font-size:.62rem;font-weight:900;
  letter-spacing:.04em;flex-shrink:0;}
#elocInput{flex:1;background:transparent;border:none;outline:none;
  font-size:.88rem;font-weight:700;color:var(--text);font-family:'DM Sans',sans-serif;
  letter-spacing:.1em;text-transform:uppercase;}
#elocInput::placeholder{color:var(--muted);letter-spacing:.05em;font-weight:500;text-transform:none;}
.eloc-go{background:linear-gradient(135deg,#6366f1,#8b5cf6);border:none;
  border-radius:10px;padding:8px 14px;color:#fff;font-weight:800;
  font-size:.78rem;cursor:pointer;transition:transform .1s;flex-shrink:0;}
.eloc-go:active{transform:scale(.94);}
.eloc-result{background:rgba(10,14,22,.98);border:1px solid rgba(99,102,241,.25);
  border-radius:12px;margin-top:6px;padding:12px 14px;display:none;}
.eloc-place{font-weight:800;font-size:.9rem;color:var(--text);}
.eloc-addr{font-size:.72rem;color:var(--muted);margin-top:2px;}
.eloc-coords{font-size:.65rem;color:#6366f1;font-weight:700;margin-top:4px;}
.eloc-actions{display:flex;gap:7px;margin-top:9px;}
.eloc-act{flex:1;border:none;border-radius:10px;padding:9px;font-size:.74rem;
  font-weight:800;cursor:pointer;transition:transform .1s;}
.eloc-act:active{transform:scale(.95);}
.eloc-act.pickup{background:rgba(16,185,129,.15);color:var(--green);border:1px solid rgba(16,185,129,.3);}
.eloc-act.drop{background:rgba(245,158,11,.12);color:var(--yellow);border:1px solid rgba(245,158,11,.3);}
body.lm .eloc-bar{background:rgba(255,255,255,.98);border-color:rgba(99,102,241,.4);}
body.lm #elocInput{color:#0c1929;}
body.lm .eloc-result{background:#fff;}

/* ── eLoc FAB button ── */
#elocFab{position:fixed;left:14px;z-index:500;
  background:linear-gradient(135deg,#6366f1,#8b5cf6);
  border:none;border-radius:14px;padding:8px 14px;cursor:pointer;
  display:none;align-items:center;gap:6px;
  box-shadow:0 4px 20px rgba(99,102,241,.4);
  font-size:.72rem;font-weight:800;color:#fff;transition:transform .12s;}
#elocFab:active{transform:scale(.93);}

/* ── Language Selector ── */
#langSelector{position:fixed;bottom:100px;left:14px;z-index:500;display:none;}
.lang-pill{background:rgba(10,14,22,.9);backdrop-filter:blur(16px);
  border:1px solid rgba(255,255,255,.12);border-radius:99px;
  display:flex;align-items:center;gap:3px;padding:4px 6px;
  box-shadow:0 4px 16px rgba(0,0,0,.4);}
.lang-btn{border:none;border-radius:99px;padding:5px 10px;font-size:.65rem;
  font-weight:800;cursor:pointer;background:transparent;
  color:rgba(255,255,255,.55);transition:all .15s;white-space:nowrap;}
.lang-btn.active{background:rgba(245,158,11,.9);color:#000;}
.lang-btn:active{transform:scale(.94);}

/* ── Snap-to-Road Indicator ── */
#snapIndicator{position:fixed;top:0;right:0;z-index:600;padding:6px 10px;
  background:rgba(16,185,129,.9);border-radius:0 0 0 12px;
  font-size:.6rem;font-weight:800;color:#fff;display:none;
  backdrop-filter:blur(10px);letter-spacing:.03em;}

/* ── Vehicle Profile Selector ── */
.vp-row{display:flex;gap:6px;margin-bottom:10px;}
.vp-card{flex:1;border:1.5px solid var(--border);border-radius:14px;
  padding:10px 6px;text-align:center;cursor:pointer;transition:all .2s;
  position:relative;}
.vp-card.sel{border-color:var(--yellow);background:rgba(245,158,11,.08);}
.vp-card:active{transform:scale(.96);}
.vp-icon{font-size:1.6rem;line-height:1;display:block;margin-bottom:4px;}
.vp-name{font-size:.62rem;font-weight:800;color:var(--text);}
.vp-speed{font-size:.55rem;color:var(--muted);margin-top:1px;}
.vp-badge{position:absolute;top:-6px;right:-4px;background:var(--green);
  color:#fff;border-radius:99px;font-size:.48rem;font-weight:900;
  padding:2px 6px;line-height:1;}

/* ── Fleet Tracking Modal ── */
#fleetModal{position:fixed;inset:0;z-index:9500;background:rgba(0,0,0,.85);
  display:none;align-items:flex-end;justify-content:center;backdrop-filter:blur(4px);}
#fleetModal.sh{display:flex;animation:fup .3s ease;}
.fleet-box{background:var(--bg);border-radius:26px 26px 0 0;
  border-top:1px solid rgba(255,255,255,.1);padding:20px 18px 44px;
  width:100%;max-width:500px;max-height:80vh;overflow-y:auto;}
.fleet-box::-webkit-scrollbar{display:none;}
.fleet-hd{display:flex;align-items:center;justify-content:space-between;margin-bottom:14px;}
.fleet-title{font-family:'Syne',sans-serif;font-weight:900;font-size:1.05rem;}
.fleet-close{width:32px;height:32px;background:rgba(255,255,255,.07);border:none;
  border-radius:50%;cursor:pointer;font-size:1.1rem;color:var(--muted);}
.fleet-stats{display:grid;grid-template-columns:1fr 1fr 1fr;gap:8px;margin-bottom:14px;}
.fleet-stat{background:var(--card2);border-radius:12px;padding:10px;text-align:center;}
.fleet-stat-v{font-family:'Syne',sans-serif;font-weight:900;font-size:1.3rem;}
.fleet-stat-l{font-size:.58rem;color:var(--muted);font-weight:700;
  text-transform:uppercase;letter-spacing:.04em;margin-top:2px;}
.fleet-driver-card{display:flex;align-items:center;gap:10px;
  padding:10px 12px;border:1px solid var(--border);border-radius:13px;
  margin-bottom:7px;transition:all .2s;cursor:pointer;}
.fleet-driver-card:active{background:rgba(255,255,255,.04);}
.fleet-d-avatar{width:36px;height:36px;border-radius:50%;background:rgba(245,158,11,.15);
  border:1.5px solid rgba(245,158,11,.3);display:flex;align-items:center;
  justify-content:center;font-size:1rem;flex-shrink:0;}
.fleet-d-info{flex:1;min-width:0;}
.fleet-d-name{font-weight:800;font-size:.85rem;
  white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
.fleet-d-meta{font-size:.65rem;color:var(--muted);margin-top:2px;}
.fleet-d-status{flex-shrink:0;text-align:right;}
.fleet-d-dist{font-family:'Syne',sans-serif;font-weight:900;font-size:.92rem;color:var(--yellow);}
.fleet-d-zone{font-size:.58rem;color:var(--muted);margin-top:1px;}
.fleet-online-dot{width:8px;height:8px;border-radius:50%;background:var(--green);
  display:inline-block;margin-right:4px;
  box-shadow:0 0 6px var(--green);animation:dpulse 1.5s infinite;}
body.lm .fleet-box{background:#f0f4fb;}

/* ── VRP Optimizer Panel ── */
#vrpModal{position:fixed;inset:0;z-index:9500;background:rgba(0,0,0,.85);
  display:none;align-items:flex-end;justify-content:center;backdrop-filter:blur(4px);}
#vrpModal.sh{display:flex;animation:fup .3s ease;}
.vrp-box{background:var(--bg);border-radius:26px 26px 0 0;
  border-top:1px solid rgba(255,255,255,.1);padding:20px 18px 44px;
  width:100%;max-width:500px;max-height:82vh;overflow-y:auto;}
.vrp-box::-webkit-scrollbar{display:none;}
.vrp-hd{display:flex;align-items:center;justify-content:space-between;margin-bottom:16px;}
.vrp-route-card{border:1.5px solid var(--border);border-radius:14px;
  padding:12px 14px;margin-bottom:8px;transition:all .2s;}
.vrp-route-card.optimal{border-color:var(--green);background:rgba(16,185,129,.05);}
.vrp-route-num{font-family:'Syne',sans-serif;font-weight:900;font-size:1.1rem;color:var(--yellow);}
.vrp-route-info{font-size:.78rem;font-weight:700;margin-bottom:5px;}
.vrp-stops{display:flex;flex-direction:column;gap:4px;}
.vrp-stop{display:flex;align-items:center;gap:8px;font-size:.72rem;}
.vrp-stop-dot{width:8px;height:8px;border-radius:50%;flex-shrink:0;}
.vrp-savings{background:rgba(16,185,129,.1);border:1px solid rgba(16,185,129,.25);
  border-radius:10px;padding:8px 12px;margin-top:10px;text-align:center;
  font-size:.78rem;font-weight:800;color:var(--green);}
body.lm .vrp-box{background:#f0f4fb;}

/* ── Map Feature FAB row ── */
#mapFabRow{position:fixed;left:14px;z-index:500;display:none;flex-direction:column;gap:7px;}
.mfab{width:42px;height:42px;border-radius:12px;border:none;cursor:pointer;
  display:flex;align-items:center;justify-content:center;font-size:1rem;
  backdrop-filter:blur(16px);transition:transform .12s;box-shadow:0 4px 16px rgba(0,0,0,.3);}
.mfab:active{transform:scale(.91);}
.mfab-fleet{background:linear-gradient(135deg,rgba(59,130,246,.9),rgba(99,102,241,.9));color:#fff;}
.mfab-vrp{background:linear-gradient(135deg,rgba(16,185,129,.9),rgba(5,150,105,.9));color:#fff;}
.mfab-eloc{background:linear-gradient(135deg,rgba(139,92,246,.9),rgba(99,102,241,.9));color:#fff;}
.mfab-lang{background:linear-gradient(135deg,rgba(245,158,11,.9),rgba(249,115,22,.9));color:#000;}
.mfab-tooltip{position:absolute;left:52px;background:rgba(0,0,0,.85);color:#fff;
  border-radius:8px;padding:4px 10px;font-size:.65rem;font-weight:700;
  white-space:nowrap;pointer-events:none;opacity:0;transition:opacity .2s;}
.mfab:hover .mfab-tooltip{opacity:1;}

/* ── Snap-to-road toggle in map stats ── */
.snap-chip{cursor:pointer;transition:all .2s;}
.snap-chip.active .ms-dot{background:var(--green)!important;box-shadow:0 0 8px var(--green);}

/* ── Traffic layer chip ── */
#trafficChip .ms-dot{background:#ef4444;}
#trafficChip.active .ms-dot{box-shadow:0 0 8px #ef4444;}

#elocBrowseList::-webkit-scrollbar{display:none;}
#elocSuggestBox::-webkit-scrollbar{display:none;}
</style>
</head>
<body>

<!-- SURGE BANNER -->
<div id="surgeBanner">⚡ High Demand — Surge Pricing Active in Your Area! Fares 1.5x</div>

<!-- ✅ DRIVER APPROACHING TOP BAR — Ola/Uber trending 2024 -->
<div id="driverApproachBar">
  <div class="dab-inner">
    <div class="dab-car" id="dabCar">🛺</div>
    <div class="dab-info">
      <div class="dab-name" id="dabName">Driver coming...</div>
      <div class="dab-sub" id="dabSub">Live tracking on map</div>
    </div>
    <div class="dab-eta">
      <div class="dab-min" id="dabMin">--</div>
      <div class="dab-away">min away</div>
    </div>
  </div>
</div>

<!-- ✅ LIVE DISTANCE FLOAT PILL -->
<div id="liveDistFloat">
  <div class="ldf-inner">
    <div class="ldf-dot"></div>
    <span id="liveDistText">-- km</span>
  </div>
</div>

<!-- LOADER -->
<div id="loader">
  <div class="ld-box">JDP</div>
  <div class="ld-t">CABS</div>
  <div class="ld-s">Jagdalpur · Live Ride System<br>Bastar Division</div>
  <div class="ld-bar-w"><div class="ld-bar" id="ldBar"></div></div>
  <div id="ldStatus" style="font-size:.7rem;color:var(--muted);margin-top:4px;">Initializing...</div>
</div>

<!-- MAP — Full screen with gradient blend at bottom -->
<div id="map"></div>

<!-- ✅ Map gradient fade — subtle, Mappls style -->
<div id="mapFade" style="
  position:fixed;bottom:0;left:0;right:0;
  height:120px;
  background:linear-gradient(to top, rgba(7,9,15,0.6) 0%, rgba(7,9,15,0.2) 60%, transparent 100%);
  z-index:390;pointer-events:none;display:none;
"></div>

<!-- ✅ MAPPLS-STYLE NAVIGATION BAR — Top turn instruction -->
<div id="navBar">
  <div class="nav-main">
    <div class="nav-arrow-box" id="navArrow">⬅️</div>
    <div>
      <div style="display:flex;align-items:baseline;gap:0">
        <div class="nav-dist" id="navDist">--</div>
        <div class="nav-dist-unit" id="navDistUnit">m</div>
      </div>
    </div>
    <div class="nav-instruction" id="navInstruction">Calculating route...</div>
  </div>
  <div class="nav-next-wrap" id="navNextWrap">
    <div class="nav-next-label">Next</div>
    <div class="nav-next-arrow" id="navNextArrow">➡️</div>
    <div class="nav-next-dist" id="navNextDist">--</div>
  </div>
</div>

<!-- ✅ SPEED DISPLAY — bottom left circle like Mappls -->
<div id="navSpeed" style="bottom:180px">
  <div class="spd-val" id="spdVal">0</div>
  <div class="spd-unit">km/h</div>
</div>

<!-- ✅ RECENTER BUTTON — like Mappls -->
<button id="navRecenter" style="bottom:240px" onclick="navRecenter()">
  <div class="rc-arrow">▲</div>
  <div class="rc-label">Recenter</div>
</button>

<!-- ✅ VOICE NAV BUTTON -->
<button id="voiceIndicator" onclick="toggleVoice()">🔊</button>

<!-- ✅ NAVIGATION BOTTOM ETA PANEL -->
<div id="navETA">
  <div class="eta-row">
    <div>
      <div class="eta-time" id="etaTime">-- min</div>
      <div class="eta-sub" id="etaDist">-- m</div>
      <div class="eta-arrival" id="etaArrival">Arrival: --:--</div>
    </div>
    <div class="eta-actions">
      <div class="eta-btn" id="navStepBtn" onclick="toggleStepList()" title="Route steps">📋</div>
      <div class="eta-btn" onclick="toggleVoice()" title="Voice">🔊</div>
      <div class="eta-close" onclick="stopNavigation()" title="Stop nav">✕</div>
    </div>
  </div>
</div>

<!-- ✅ STEP LIST PANEL (All turn instructions) -->
<div id="navStepList">
  <div class="sl-header">
    <span style="font-size:1.3rem">🗺️</span>
    <div>
      <div class="sl-title">Turn-by-Turn Route</div>
      <div style="font-size:.68rem;color:var(--muted)" id="slSummary">Calculating...</div>
    </div>
    <button class="sl-close" onclick="toggleStepList()">✕</button>
  </div>
  <div class="sl-body" id="stepListBody"></div>
</div>

<!-- ✅ Uber-style zoom controls — positioned above locate button -->
<div class="zoom-ctrl" id="zoomCtrl" style="bottom:410px;">
  <button class="zbtn" onclick="zoomIn()" title="Zoom In">+</button>
  <button class="zbtn" onclick="zoomOut()" title="Zoom Out">−</button>
</div>

<!-- Zone Legend removed -->

<!-- MAP STATS — clean Uber/Ola style top pills -->
<div id="mapStats">
  <div class="ms-row">
    <!-- ✅ Sirf drivers count — bilkul clean -->
    <div class="ms-chip" style="cursor:default">
      <div class="ms-dot" style="background:var(--green);animation:dpulse 1.5s infinite"></div>
      <span id="liveDriverBadge">0 Drivers Live</span>
    </div>
    <!-- Live distance chip — sirf ride ke time dikhega -->
    <div class="ms-chip" id="liveDistChip" style="display:none">
      <div class="ms-dot" style="background:var(--blue);animation:dpulse 1.2s infinite"></div>
      <span id="liveDistChipText">-- km</span>
    </div>
  </div>
</div>

<!-- AUTH -->
<div id="auth">
  <div class="ah">
    <img src="https://images.unsplash.com/photo-1449965408869-eaa3f722e40d?auto=format&fit=crop&w=800&q=80">
    <div class="ah-ov">
      <div class="ah-tag">🗺️ Jagdalpur • Bastar</div>
      <div style="font-family:'Syne',sans-serif;font-size:1.8rem;font-weight:900;color:white;">JDP CABS</div>
      <div style="color:rgba(255,255,255,.5);font-size:.8rem;margin-top:3px;">Jagdalpur's Smartest Cab System</div>
    </div>
  </div>
  <div class="ab">
    <div class="fbb" id="fbBadge">⏳ Connecting to Firebase...</div>
    <div class="rtog">
      <button class="rtab ar" id="rTab" onclick="setRole('rider')">🧍 Rider</button>
      <button class="rtab" id="dTab" onclick="setRole('driver')">🚖 Driver</button>
    </div>
    <div class="atabs">
      <button class="atab on" id="loginTab" onclick="setTab('login')">Login</button>
      <button class="atab" id="regTab" onclick="setTab('register')">Register</button>
    </div>
    <div class="afrm sh" id="loginForm">
      <div id="loginErr" class="eb"></div>
      <div class="fg"><label class="fl">Mobile Number</label><input type="tel" class="fi" id="lId" placeholder="9876543210" maxlength="10"></div>
      <div class="fg"><label class="fl">Password</label><input type="password" class="fi" id="lPass" placeholder="••••••••"></div>
      <button class="asub y" onclick="doLogin()">🚀 Login</button>
    </div>
    <div class="afrm" id="rRegForm">
      <div id="rRegErr" class="eb"></div>
      <div class="fr">
        <div class="fg"><label class="fl">Full Name</label><input type="text" class="fi" id="rFn" placeholder="Aapka Naam"></div>
        <div class="fg"><label class="fl">Mobile</label><input type="tel" class="fi" id="rPh" placeholder="9876543210" maxlength="10"></div>
      </div>
      <div class="fg"><label class="fl">Password</label><input type="password" class="fi" id="rPw" placeholder="min 6 chars"></div>
      <button class="asub y" onclick="doRiderReg()">✅ Create Rider Account</button>
    </div>
    <div class="afrm" id="dRegForm">
      <div id="dRegErr" class="eb"></div>

      <!-- STEP 1: Basic Info -->
      <div id="dStep1">
        <div style="font-size:.6rem;font-weight:800;color:var(--green);text-transform:uppercase;letter-spacing:.08em;margin-bottom:9px;display:flex;align-items:center;gap:5px">
          <span style="background:var(--green);color:#000;border-radius:50%;width:16px;height:16px;display:inline-flex;align-items:center;justify-content:center;font-size:.55rem">1</span>
          Basic Information
        </div>
        <div class="fr">
          <div class="fg"><label class="fl">Full Name</label><input type="text" class="fi gf" id="dFn" placeholder="Aapka Naam"></div>
          <div class="fg"><label class="fl">Mobile</label><input type="tel" class="fi gf" id="dPh" placeholder="9876543210" maxlength="10"></div>
        </div>
        <div class="fg"><label class="fl">Vehicle Number</label><input type="text" class="fi gf" id="dVeh" placeholder="CG 17 XX 0000"></div>
        <div class="fg"><label class="fl">Vehicle Type</label>
          <div class="vg">
            <div class="vc on" id="vAuto" onclick="selVeh('auto')"><div style="font-size:1.6rem">🛺</div><div style="font-size:.73rem;font-weight:700;margin-top:3px">Auto</div></div>
            <div class="vc" id="vCab" onclick="selVeh('cab')"><div style="font-size:1.6rem">🚗</div><div style="font-size:.73rem;font-weight:700;margin-top:3px">Mini Cab</div></div>
          </div>
        </div>
        <div class="fg"><label class="fl">Password</label><input type="password" class="fi gf" id="dPw" placeholder="min 6 chars"></div>
        <button class="asub" style="background:rgba(16,185,129,.15);color:var(--green);border:1px solid rgba(16,185,129,.3)" onclick="showKycStep()">Next: KYC Documents →</button>
      </div>

      <!-- STEP 2: KYC Documents -->
      <div id="dStep2" style="display:none;animation:fup .3s ease">
        <div style="font-size:.6rem;font-weight:800;color:var(--green);text-transform:uppercase;letter-spacing:.08em;margin-bottom:9px;display:flex;align-items:center;gap:5px">
          <span style="background:var(--green);color:#000;border-radius:50%;width:16px;height:16px;display:inline-flex;align-items:center;justify-content:center;font-size:.55rem">2</span>
          KYC Verification Documents
        </div>
        <div style="background:rgba(245,158,11,.07);border:1px solid rgba(245,158,11,.2);border-radius:10px;padding:9px 12px;font-size:.71rem;color:rgba(245,158,11,.9);margin-bottom:13px">
          ⚠️ Ye documents sirf verification ke liye hain. Admin review ke baad account activate hoga.
        </div>

        <!-- 📸 DRIVER PHOTO UPLOAD -->
        <label class="fl">📸 Driver Profile Photo <span style="color:var(--red)">*</span></label>
        <div class="photo-upload-box" id="photoUploadBox" onclick="document.getElementById('dPhotoInput').click()">
          <img id="dPhotoPreview" class="photo-preview" alt="Driver Photo">
          <div class="photo-placeholder" id="photoPlaceholder">🤳</div>
          <div class="photo-upload-lbl" id="photoUploadLbl">Tap to upload selfie / photo</div>
          <div class="photo-upload-sub">Camera se selfie ya gallery se photo chune<br>JPG/PNG • Max 5MB • Square photo best hogi</div>
        </div>
        <input type="file" id="dPhotoInput" accept="image/*" capture="user" style="display:none" onchange="handleDriverPhoto(this)">
        <div id="photoStatus" style="font-size:.68rem;color:var(--green);text-align:center;margin-bottom:10px;display:none">✅ Photo ready!</div>

        <div class="fg"><label class="fl">🪪 Aadhaar Card Number</label><input type="tel" class="fi gf" id="dAadhar" placeholder="XXXX XXXX XXXX" maxlength="14" oninput="fmtAadhar(this)"></div>
        <div class="fg"><label class="fl">📄 PAN Card Number</label><input type="text" class="fi gf" id="dPan" placeholder="ABCDE1234F" maxlength="10" style="text-transform:uppercase"></div>
        <div class="fg"><label class="fl">🚗 Driving Licence Number</label><input type="text" class="fi gf" id="dDl" placeholder="CG1720XXXXXXX" style="text-transform:uppercase"></div>

        <div style="font-size:.6rem;font-weight:800;color:var(--blue);text-transform:uppercase;letter-spacing:.08em;margin:13px 0 9px;display:flex;align-items:center;gap:5px">
          <span style="background:var(--blue);color:#fff;border-radius:50%;width:16px;height:16px;display:inline-flex;align-items:center;justify-content:center;font-size:.55rem">3</span>
          Bank Account Details
        </div>
        <div class="fg"><label class="fl">🏦 Account Holder Name</label><input type="text" class="fi gf" id="dBankName" placeholder="Aapka Naam (Bank mein)"></div>
        <div class="fg"><label class="fl">Account Number</label><input type="tel" class="fi gf" id="dAccNo" placeholder="00000000000000"></div>
        <div class="fg"><label class="fl">IFSC Code</label><input type="text" class="fi gf" id="dIfsc" placeholder="SBIN0001234" maxlength="11" style="text-transform:uppercase"></div>

        <div style="display:grid;grid-template-columns:1fr 1.5fr;gap:8px">
          <button class="asub" style="background:rgba(255,255,255,.05);color:var(--muted);border:1px solid var(--border)" onclick="document.getElementById('dStep1').style.display='block';document.getElementById('dStep2').style.display='none'">← Back</button>
          <button class="asub g" onclick="doDriverReg()">✅ Submit Registration</button>
        </div>
        <div style="text-align:center;font-size:.65rem;color:var(--muted);margin-top:9px">🔒 Aapki details securely store hoti hain</div>
      </div>
    </div>
  </div>
</div>

<!-- ═══ RIDER UI ═══ -->
<!-- ✅ UBER-STYLE MINIMAL TOP BAR -->
<div class="tb" id="rTop" style="display:none">
  <div class="tb-logo">JDP CABS</div>
  <div class="tb-actions">
    <div class="tbtn tbtn-icon" onclick="openModal('histModal')" title="Ride History">📋</div>
    <div class="tbtn tbtn-icon" onclick="toggleTheme()">☀️</div>
    <div class="tbtn" style="color:rgba(255,80,80,1);border-color:rgba(239,68,68,.3);background:rgba(239,68,68,.12)" onclick="doLogout()">Exit</div>
  </div>
</div>

<!-- ✅ LOCATE FAB — Uber position -->
<button class="locbtn" id="locBtn" style="display:none;bottom:340px" onclick="locateMe()">📍</button>
<!-- ✅ MAP STYLE TOGGLE FAB -->
<button class="locbtn" id="mapStyleBtn" style="display:none;bottom:400px;background:#1a2535;border:1.5px solid rgba(255,255,255,.15)" onclick="toggleMapStyle()" title="Map Style">🛰️</button>

<div class="sheet" id="rSheet">
  <div class="hdl"></div>

  <!-- ✅ HOME SCREEN — Uber 2024 style -->
  <div class="scr on" id="sHome">
    <!-- Greeting row -->
    <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:10px;">
      <div>
        <div style="font-size:.6rem;color:var(--muted);font-weight:700;text-transform:uppercase;letter-spacing:.1em">WHERE TO,</div>
        <div style="font-family:'Syne',sans-serif;font-weight:900;font-size:.98rem" id="riderName">RIDER</div>
      </div>
      <div id="homeDrvBadge" style="display:flex;align-items:center;gap:5px;background:rgba(16,185,129,.1);border:1px solid rgba(16,185,129,.2);border-radius:99px;padding:5px 10px;font-size:.65rem;font-weight:700;color:var(--green);">
        <div style="width:6px;height:6px;border-radius:50%;background:var(--green);box-shadow:0 0 6px var(--green)"></div>
        <span id="homeDrvText">0 drivers</span>
      </div>
    </div>

    <!-- ✅ PICKUP ROW — Always visible, Uber style -->
    <div class="pickup-strip" onclick="refreshGPS()" style="cursor:pointer">
      <div class="psdot"></div>
      <div style="flex:1;min-width:0">
        <div class="ps-addr" id="pAddr">Detecting location...</div>
        <div id="pSub" class="ps-gps" style="display:flex;align-items:center;gap:3px">
          <div class="lspin"></div><span>Getting GPS...</span>
        </div>
      </div>
      <div style="font-size:.8rem;opacity:.35">📡</div>
    </div>

    <!-- Drop search box -->
    <div id="dropLbWrap" style="position:relative;margin-bottom:10px;">
      <div class="lb" style="border-radius:14px;border:1.5px solid rgba(255,255,255,.08);">
        <div style="width:10px;height:10px;background:var(--red);border-radius:2px;flex-shrink:0;transform:rotate(45deg)"></div>
        <input type="text" id="dropIn" placeholder="Kahan jaana hai? 🔍"
          autocomplete="off"
          style="background:transparent;border:none;color:var(--text);width:100%;
          font-family:'DM Sans',sans-serif;font-weight:600;font-size:.88rem;outline:none;"
          onkeydown="if(event.key==='Enter'){hideSuggest();calcFare();}"
          oninput="onDropInput(this.value)"
          onfocus="if(this.value.length>1)showSuggest(this.value)"
          onblur="setTimeout(hideSuggest,200)">
      </div>
      <div id="dropSuggest"></div>
    </div>

    <!-- Popular places -->
    <div class="qp-label">🔥 Popular destinations</div>
    <div class="qp-scroll" id="qpScroll">
      <div class="qp-chip" onclick="setDrop('Chitrakote Waterfall Jagdalpur')">🌊 Chitrakote Falls</div>
      <div class="qp-chip" onclick="setDrop('Bastar Palace Jagdalpur')">🏯 Bastar Palace</div>
      <div class="qp-chip" onclick="setDrop('Jagdalpur Bus Stand')">🚌 Bus Stand</div>
      <div class="qp-chip" onclick="setDrop('Jagdalpur Railway Station')">🚂 Railway Station</div>
      <div class="qp-chip" onclick="setDrop('Maharaja Hospital Jagdalpur')">🏥 Maharaja Hospital</div>
      <div class="qp-chip" onclick="setDrop('Kanger Valley National Park Jagdalpur')">🌿 Kanger Valley</div>
      <div class="qp-chip" onclick="setDrop('Tiratgarh Waterfall Jagdalpur')">💧 Tiratgarh Falls</div>
      <div class="qp-chip" onclick="setDrop('Airport Jagdalpur')">✈️ Airport</div>
      <div class="qp-chip" onclick="setDrop('Kutumsar Cave Jagdalpur')">🪪 Kutumsar Cave</div>
      <div class="qp-chip" onclick="setDrop('Gol Bazar Jagdalpur')">🛒 Gol Bazar</div>
      <div class="qp-chip" onclick="setDrop('Medical College Jagdalpur')">🎓 Medical College</div>
      <div class="qp-chip" onclick="setDrop('Collectorate Jagdalpur')">🏛️ Collectorate</div>
    </div>

    <div id="homeErr" class="eb"></div>
    <button class="mbtn y" onclick="calcFare()" style="margin-top:4px">Find Ride 🚗</button>
  </div>

  <!-- FARE / SELECT RIDE SCREEN -->
  <div class="scr" id="sFare">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px">
      <div style="font-family:'Syne',sans-serif;font-size:.92rem;font-weight:900">Select Ride</div>
      <span style="color:var(--muted);font-size:.76rem;cursor:pointer;padding:4px 8px" onclick="goScr('sHome');clearRoute()">✕ Cancel</span>
    </div>
    <!-- ✅ PICKUP+DROP ALWAYS VISIBLE -->
    <div style="display:flex;flex-direction:column;gap:0;margin-bottom:10px;border:1px solid rgba(255,255,255,.07);border-radius:13px;overflow:hidden">
      <div class="pickup-strip" style="border-radius:0;margin-bottom:0;border:none;border-bottom:1px solid rgba(255,255,255,.06)">
        <div class="psdot"></div>
        <div style="flex:1;min-width:0">
          <div style="font-size:.58rem;color:var(--green);font-weight:800;text-transform:uppercase;margin-bottom:1px">PICKUP</div>
          <div style="font-size:.8rem;font-weight:700;white-space:nowrap;overflow:hidden;text-overflow:ellipsis" id="farePickupAddr">Getting location...</div>
        </div>
      </div>
      <div class="pickup-strip" style="border-radius:0;margin-bottom:0;border:none">
        <div style="width:9px;height:9px;border-radius:2px;background:var(--red);transform:rotate(45deg);flex-shrink:0"></div>
        <div style="flex:1;min-width:0">
          <div style="font-size:.58rem;color:var(--red);font-weight:800;text-transform:uppercase;margin-bottom:1px">DROP</div>
          <div style="font-size:.8rem;font-weight:700;white-space:nowrap;overflow:hidden;text-overflow:ellipsis" id="fareDropAddr">--</div>
        </div>
      </div>
    </div>
    <div id="surgeChip" style="display:none;" class="surge-chip">⚡ 1.5x Surge — High demand</div>
    <!-- KM + MINS + FARE chips -->
    <div style="display:flex;gap:5px;margin-bottom:6px">
      <div style="flex:1;text-align:center;background:rgba(255,255,255,.04);border:1px solid var(--border);border-radius:11px;padding:9px 5px">
        <div style="font-family:'Syne',sans-serif;font-weight:900;font-size:1.25rem;line-height:1" id="cDist">--</div>
        <div style="font-size:.56rem;color:var(--muted);font-weight:700;margin-top:2px">KM</div>
      </div>
      <div style="flex:1;text-align:center;background:rgba(255,255,255,.04);border:1px solid var(--border);border-radius:11px;padding:9px 5px">
        <div style="font-family:'Syne',sans-serif;font-weight:900;font-size:1.25rem;line-height:1" id="cETA">--</div>
        <div style="font-size:.56rem;color:var(--muted);font-weight:700;margin-top:2px">MINS</div>
      </div>
      <div style="flex:1;text-align:center;background:rgba(245,158,11,.07);border:1px solid rgba(245,158,11,.18);border-radius:11px;padding:9px 5px">
        <div style="font-family:'Syne',sans-serif;font-weight:900;font-size:1.25rem;color:var(--yellow);line-height:1" id="cFareEst">₹--</div>
        <div style="font-size:.56rem;color:var(--muted);font-weight:700;margin-top:2px">EST FARE</div>
      </div>
    </div>
    <!-- Route accuracy badge -->
    <div id="routeAccBadge" style="display:none;align-items:center;justify-content:center;gap:5px;font-size:.65rem;font-weight:700;padding:4px 10px;background:rgba(255,255,255,.04);border:1px solid rgba(255,255,255,.07);border-radius:99px;margin-bottom:8px;text-align:center"></div>
    <!-- Ride cards -->
    <div class="ro-card sel" id="optAuto" onclick="selRide(this,'Auto','auto')">
      <div style="font-size:2rem;margin-right:11px">🛺</div>
      <div style="flex:1;min-width:0">
        <div style="font-weight:800;font-size:.9rem">Auto <span id="autoSurge" style="display:none;font-size:.58rem;background:rgba(245,158,11,.15);border:1px solid rgba(245,158,11,.3);color:var(--yellow);padding:1px 6px;border-radius:99px">⚡SURGE</span></div>
        <div style="font-size:.67rem;color:var(--muted);margin-top:2px">3 seater • <span id="autoETA">~3</span> min away • <span id="autoDistLbl">-- km</span></div>
      </div>
      <div style="text-align:right;flex-shrink:0">
        <div style="font-family:'Syne',sans-serif;font-weight:900;font-size:1.2rem;color:var(--yellow)">₹<span id="fAuto">--</span></div>
        <div style="font-size:.58rem;color:var(--green);font-weight:700">⭐ POPULAR</div>
      </div>
    </div>
    <div class="ro-card" id="optMini" onclick="selRide(this,'Mini Cab','cab')">
      <div style="font-size:2rem;margin-right:11px">🚗</div>
      <div style="flex:1;min-width:0">
        <div style="font-weight:800;font-size:.9rem">Mini Cab <span id="miniSurge" style="display:none;font-size:.58rem;background:rgba(245,158,11,.15);border:1px solid rgba(245,158,11,.3);color:var(--yellow);padding:1px 6px;border-radius:99px">⚡SURGE</span></div>
        <div style="font-size:.67rem;color:var(--muted);margin-top:2px">4 seater • AC • <span id="miniETA">~5</span> min • <span id="miniDistLbl">-- km</span></div>
      </div>
      <div style="text-align:right;flex-shrink:0">
        <div style="font-family:'Syne',sans-serif;font-weight:900;font-size:1.2rem;color:var(--yellow)">₹<span id="fMini">--</span></div><span id="fPremium" style="display:none">0</span>
        <div style="font-size:.58rem;color:var(--blue);font-weight:700">❄️ AC COOL</div>
      </div>
    </div>
    <!-- Nearby drivers -->
    <div style="display:flex;align-items:center;gap:8px;background:rgba(255,255,255,.03);border:1px solid var(--border);border-radius:11px;padding:8px 12px;margin-bottom:9px">
      <div style="width:7px;height:7px;border-radius:50%;background:var(--green);box-shadow:0 0 6px var(--green);animation:dpulse 1.5s infinite;flex-shrink:0"></div>
      <span style="font-size:.75rem;font-weight:700;flex:1">Nearby Drivers</span>
      <span style="font-family:'Syne',sans-serif;font-weight:900;font-size:1.1rem;color:var(--green)" id="ndTotal">0</span>
      <span style="background:rgba(16,185,129,.1);color:var(--green);padding:2px 7px;border-radius:99px;font-size:.6rem;font-weight:800"><span id="nd0to3">0</span>&lt;3km</span>
      <span style="background:rgba(59,130,246,.1);color:var(--blue);padding:2px 7px;border-radius:99px;font-size:.6rem;font-weight:800"><span id="nd3to8">0</span>&lt;8km</span><span style="background:rgba(245,158,11,.1);color:var(--yellow);padding:2px 7px;border-radius:99px;font-size:.6rem;font-weight:800"><span id="nd8to15">0</span>&lt;15km</span>
    </div>
    <div id="promoStrip" style="display:none;background:rgba(16,185,129,.1);border:1px solid rgba(16,185,129,.25);border-radius:10px;padding:6px 12px;font-size:.72rem;font-weight:700;color:var(--green);text-align:center;margin-bottom:6px"></div><button class="mbtn y" onclick="confirmBook()">Book <span id="bookBtnType">Auto</span> →</button>
  </div>

  <!-- FINDING SCREEN -->
  <div class="scr" id="sFind">
    <div class="rdr">
      <div class="rdr-rings">
        <div class="r1"></div><div class="r2"></div><div class="r3"></div>
        <div class="r4"><div class="r4-inner"></div></div>
      </div>
      <div style="font-family:'Syne',sans-serif;font-weight:900;font-size:1.08rem">Finding nearby drivers...</div>
      <div style="color:var(--muted);font-size:.78rem;margin-top:5px">Live request sent to all online drivers</div>
      <div style="margin-top:13px;background:rgba(59,130,246,.08);border:1px solid rgba(59,130,246,.2);border-radius:12px;padding:11px">
        <div style="font-size:.68rem;color:var(--muted);font-weight:700;text-transform:uppercase;letter-spacing:.04em;margin-bottom:4px">🎯 Smart Matching</div>
        <div style="font-family:'Syne',sans-serif;font-weight:900;font-size:1.35rem;color:var(--blue)" id="nearbyCount">--</div>
        <div style="font-size:.68rem;color:var(--muted);margin-top:3px" id="matchZoneText">Searching within 5km first...</div>
      </div>
      <button class="mbtn ro" style="max-width:180px;margin:16px auto 0" onclick="cancelBook()">Cancel</button>
    </div>
  </div>

  <!-- ASSIGNED SCREEN -->
  <div class="scr" id="sAssigned">
    <div id="assignedBanner" style="background:rgba(16,185,129,.1);color:var(--green);padding:9px;border-radius:11px;text-align:center;font-weight:800;margin-bottom:13px;border:1px solid rgba(16,185,129,.25);font-size:.88rem">✅ Driver Assigned!</div>
    <div class="dcard" id="driverCard">
      <!-- Driver photo or emoji fallback -->
      <div class="dava-verified" id="dAvaWrap">
        <img id="dAvaPhoto" class="dava-photo" src="" alt="" style="display:none">
        <div class="dava" id="dAvaEmoji">👨🏽‍✈️</div>
      </div>
      <div style="flex:1">
        <div style="font-family:'Syne',sans-serif;font-weight:900;font-size:1.02rem" id="aDName">--</div>
        <div style="font-size:.76rem;color:var(--muted);margin-top:2px" id="aVeh">--</div>
        <div class="star-row" style="margin-top:3px">
          <span class="star">★★★★★</span>
          <span style="font-size:.7rem;font-weight:700;color:var(--muted);margin-left:2px">4.8</span>
        </div>
        <!-- Phone number display -->
        <div id="aDriverPhone" style="font-size:.72rem;color:var(--muted);margin-top:3px;display:none">
          📞 <span id="aDriverPhoneNum">--</span>
        </div>
      </div>
      <div class="otp">
        <div style="font-size:.58rem;color:var(--muted);font-weight:700;letter-spacing:.04em;text-transform:uppercase">OTP</div>
        <div style="font-family:'Syne',sans-serif;font-weight:900;font-size:1.35rem;color:var(--yellow)" id="rideOTP">----</div>
      </div>
    </div>

    <!-- 📞 CALL DRIVER BUTTON -->
    <a id="callDriverBtn" href="#" class="call-btn" onclick="callDriver();return false;">
      <span class="call-ring">📞</span>
      <span>Call Driver</span>
      <span id="callDriverNumLabel" style="font-size:.72rem;opacity:.85;font-weight:600"></span>
    </a>

    <!-- ⏱️ ETA COUNTDOWN -->
    <div style="background:rgba(59,130,246,.07);border:1px solid rgba(59,130,246,.2);border-radius:13px;padding:12px;text-align:center;margin-top:9px">
      <div style="font-size:.58rem;color:var(--muted);font-weight:700;text-transform:uppercase;letter-spacing:.05em">Driver Pahunchega</div>
      <div class="eta-big" id="etaCountdown">--</div>
      <div style="font-size:.62rem;color:var(--muted);margin-top:1px" id="etaSubText">Calculating ETA...</div>
    </div>

    <!-- 💬 QUICK ACTIONS -->
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-top:9px">
      <button class="mbtn" style="margin-top:0;background:rgba(59,130,246,.1);border:1px solid rgba(59,130,246,.25);color:var(--blue)" onclick="openModal('msgModal')">💬 Message</button>
      <button class="mbtn" style="margin-top:0;background:rgba(37,211,102,.08);border:1px solid rgba(37,211,102,.25);color:#25d366" onclick="shareTrip()">📤 Share Trip</button>
    </div>

    <div class="lbadge b" style="margin-top:9px"><div class="lbd"></div><span id="driverTrackText">🚗 Tracking driver on map...</span></div>
    <div class="lbadge g"><div class="lbd"></div><span id="driverDistText">Calculating distance...</span></div>

    <!-- ⚡ LIVE FARE METER — Uber/Ola style, shows during ongoing ride -->
    <div id="liveFareMeter" style="display:none;background:linear-gradient(135deg,rgba(16,185,129,.12),rgba(16,185,129,.05));border:1.5px solid rgba(16,185,129,.3);border-radius:16px;padding:14px 15px;margin-top:10px;position:relative;overflow:hidden">
      <div style="position:absolute;top:0;right:0;background:rgba(16,185,129,.15);width:60px;height:60px;border-radius:50%;transform:translate(20px,-20px)"></div>
      <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:8px">
        <div>
          <div style="font-size:.52rem;color:rgba(16,185,129,.8);font-weight:800;text-transform:uppercase;letter-spacing:.08em;margin-bottom:2px">⚡ Live Fare Meter</div>
          <div style="font-family:'Syne',sans-serif;font-weight:900;font-size:1.8rem;color:#10b981;letter-spacing:-.02em" id="liveFareAmount">₹--</div>
        </div>
        <div style="text-align:right">
          <div style="font-size:.58rem;color:var(--muted);font-weight:700">RIDE TIME</div>
          <div style="font-family:'Syne',sans-serif;font-weight:800;font-size:.92rem;color:var(--text)" id="liveFareTime">0 min 0s</div>
          <div style="font-size:.56rem;color:var(--muted);margin-top:2px">Running meter</div>
        </div>
      </div>
      <!-- Progress bar -->
      <div style="height:4px;background:rgba(255,255,255,.08);border-radius:99px;overflow:hidden;margin-top:4px">
        <div id="liveFareBar" style="height:100%;width:0%;background:#10b981;border-radius:99px;transition:width .8s ease,background .5s"></div>
      </div>
      <div style="font-size:.58rem;color:var(--muted);margin-top:5px;text-align:center">Estimated fare — final amount may vary</div>
    </div>

    <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-top:9px">
      <button class="mbtn g" style="margin-top:0" onclick="locateMe()">📍 My Location</button>
      <button class="mbtn ro" style="margin-top:0" onclick="cancelRide()">Cancel Ride</button>
    </div>
  </div>
</div>

<!-- ═══ DRIVER DASHBOARD ═══ -->
<div id="dTopBar">
  <div class="d-nr">
    <div class="d-nm">🚖 <span id="dName">Driver</span></div>
    <div style="display:flex;align-items:center;gap:9px">
      <span style="font-size:.72rem;font-weight:700;color:rgba(255,255,255,.6)" id="onlineLbl">OFFLINE</span>
      <label class="tgsw">
        <input type="checkbox" id="onTog" onchange="toggleOnline()">
        <div class="tgtr"></div><div class="tgth"></div>
      </label>
    </div>
  </div>
</div>

<div id="dStats">
  <div class="dsr">
    <div class="dst" onclick="showEarningsBreak()" style="cursor:pointer">
      <div class="dsv" id="dsEarn">₹0</div>
      <div class="dsl">Today 📊</div>
    </div>
    <div class="dst"><div class="dsv" id="dsRides">0</div><div class="dsl">Rides</div></div>
    <div class="dst"><div class="dsv" id="dsZone">--</div><div class="dsl">Zone</div></div>
    <div class="dst"><div class="dsv" id="dsTime">0h</div><div class="dsl">Online</div></div>
  </div>
  <!-- Earnings progress bar -->
  <div style="padding:0 14px 10px;display:none" id="earnBarWrap">
    <div style="display:flex;justify-content:space-between;font-size:.62rem;color:var(--muted);margin-bottom:3px">
      <span>Daily Progress</span><span id="earnGoalPct">0%</span>
    </div>
    <div class="earn-bar-bg"><div class="earn-bar-fill" id="earnBarFill" style="width:0%"></div></div>
    <div style="font-size:.6rem;color:var(--muted);text-align:right;margin-top:2px">Goal: ₹1000/day</div>
  </div>
</div>

<div id="dPanel">
  <div id="dOff">
    <div style="font-size:2.8rem;margin-bottom:9px">😴</div>
    <div style="font-family:'Syne',sans-serif;font-weight:900;font-size:1.1rem;margin-bottom:5px">You are Offline</div>
    <div style="font-size:.8rem;color:var(--muted);margin-bottom:16px">Go online to receive ride requests in Jagdalpur</div>
    <div id="kycPendingWarn" style="display:none;background:rgba(245,158,11,.08);border:1px solid rgba(245,158,11,.25);border-radius:11px;padding:9px 12px;font-size:.74rem;color:rgba(245,158,11,.9);margin-bottom:11px;text-align:left">
      ⏳ <b>KYC Verification Pending</b><br>Admin aapke documents review kar raha hai. Verify hone ke baad aap rides accept kar payenge.
    </div>
    <button class="mbtn g" onclick="document.getElementById('onTog').checked=true;toggleOnline()">🟢 Go Online & Earn</button>
  </div>

  <div id="dOn">
    <div class="opulse">
      <div class="odpulse"></div>
      <div style="flex:1">
        <div style="font-weight:700;font-size:.88rem">You're Online — Waiting for Rides</div>
        <div style="font-size:.7rem;color:var(--muted);margin-top:1px" id="dLocText">Sharing your location live...</div>
      </div>
    </div>
    <div class="dzone-row">
      <div class="dzone-card">
        <div class="dzone-val" id="dRidersNearby" style="color:var(--blue)">--</div>
        <div class="dzone-lbl">Riders Nearby</div>
      </div>
      <div class="dzone-card">
        <div class="dzone-val" id="dDriversZone" style="color:var(--green)">--</div>
        <div class="dzone-lbl">Drivers Online</div>
      </div>
    </div>
    <div class="lbadge g"><div class="lbd"></div><span id="dZoneText">In Service Zone · Jagdalpur</span></div>
    <div style="font-size:.7rem;color:var(--muted);text-align:center">📡 Listening for rides within <b>8km</b> radius</div>
  </div>

  <div id="dNav">
    <!-- Phase label -->
    <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:10px">
      <div style="font-family:'Syne',sans-serif;font-weight:900;font-size:.88rem" id="navLabel">🔵 Pickup pe jaao</div>
      <div style="font-size:.7rem;color:var(--muted)" id="navPDist">--</div>
    </div>

    <!-- Rider GPS location card — OLA style -->
    <div style="background:linear-gradient(135deg,rgba(59,130,246,.1),rgba(59,130,246,.05));border:1.5px solid rgba(59,130,246,.25);border-radius:14px;padding:11px 13px;margin-bottom:9px;">
      <div style="display:flex;align-items:center;gap:10px">
        <div style="font-size:2rem">👤</div>
        <div style="flex:1;min-width:0">
          <div style="font-weight:800;font-size:.92rem" id="navRiderName">--</div>
          <div style="font-size:.72rem;color:var(--muted);margin-top:2px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis" id="navPA">--</div><div id="navPickup" style="display:none"></div>
          <div style="font-size:.68rem;color:rgba(59,130,246,.8);font-weight:700;margin-top:3px" id="navPETA">Calculating...</div>
        </div>
        <a id="callRiderBtn" href="#" onclick="callRider();return false;"
           style="display:flex;align-items:center;justify-content:center;width:44px;height:44px;background:var(--green);color:#fff;border:none;border-radius:50%;text-decoration:none;box-shadow:0 3px 12px rgba(16,185,129,.5);font-size:1.2rem;flex-shrink:0;cursor:pointer;">
          📞
        </a>
      </div>
      <div style="font-size:.68rem;color:var(--muted);margin-top:7px;display:flex;align-items:center;gap:4px" id="navRiderPhone">
        <span style="opacity:.5">📱</span> Loading...
      </div>
    </div>

    <!-- Trip route row -->
    <div style="display:flex;gap:8px;margin-bottom:9px">
      <div style="flex:1;background:rgba(255,255,255,.04);border:1px solid rgba(16,185,129,.2);border-radius:11px;padding:9px 11px">
        <div style="font-size:.55rem;color:var(--green);font-weight:800;text-transform:uppercase;margin-bottom:3px">DROP POINT</div>
        <div style="font-size:.8rem;font-weight:700;white-space:nowrap;overflow:hidden;text-overflow:ellipsis" id="navDA">--</div>
      </div>
      <div style="background:rgba(245,158,11,.1);border:1px solid rgba(245,158,11,.25);border-radius:11px;padding:9px 13px;text-align:center;flex-shrink:0">
        <div style="font-family:'Syne',sans-serif;font-weight:900;font-size:1.2rem;color:var(--yellow)" id="navFare">₹--</div>
        <div style="font-size:.54rem;color:var(--muted);font-weight:700">FARE</div>
      </div>
    </div>

    <!-- ✅ Ola-style Google Maps Navigate Button -->
    <button id="gmapNavBtn" onclick="openGoogleMapsNav()" style="width:100%;border:none;border-radius:14px;padding:13px;font-size:.88rem;font-weight:800;cursor:pointer;margin-bottom:8px;background:linear-gradient(135deg,#4285f4,#34a853);color:#fff;display:flex;align-items:center;justify-content:center;gap:8px;box-shadow:0 4px 16px rgba(66,133,244,.35)">
      🗺️ Google Maps se Navigate
    </button>
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px">
      <button class="mbtn g" style="margin-top:0;font-size:.82rem" id="navActBtn" onclick="driverNext()">✅ Rider Picked Up</button>
      <button class="mbtn ro" style="margin-top:0;font-size:.82rem" onclick="driverCancel()">✕ Cancel</button>
    </div>
  </div>
</div>

<!-- RIDE REQUEST POPUP -->
<div id="reqPopup">
  <div class="rpc">
    <div style="text-align:center;font-family:'Syne',sans-serif;font-weight:900;font-size:1rem;margin-bottom:2px">🔔 New Ride Request!</div>
    <div id="reqDistBadge" style="text-align:center;margin-bottom:8px"></div>
    <div class="rtring">
      <svg class="rtsvg" width="60" height="60" viewBox="0 0 60 60">
        <circle class="rtcbg" cx="30" cy="30" r="26"/>
        <circle class="rtc" id="tCircle" cx="30" cy="30" r="26"/>
      </svg>
      <div class="rtn" id="tNum">60</div>
    </div>
    <div style="display:flex;gap:7px;margin-bottom:3px">
      <div style="flex:1;text-align:center;background:rgba(255,255,255,.04);border:1px solid var(--border);border-radius:10px;padding:9px">
        <div style="font-family:'Syne',sans-serif;font-weight:900;font-size:1.05rem;color:var(--yellow)" id="reqFare">₹--</div>
        <div style="font-size:.58rem;color:var(--muted);font-weight:600;margin-top:1px">FARE</div>
      </div>
      <div style="flex:1;text-align:center;background:rgba(255,255,255,.04);border:1px solid var(--border);border-radius:10px;padding:9px">
        <div style="font-family:'Syne',sans-serif;font-weight:800;font-size:1.05rem" id="reqDist">--km</div>
        <div style="font-size:.58rem;color:var(--muted);font-weight:600;margin-top:1px">TRIP</div>
      </div>
      <div style="flex:1;text-align:center;background:rgba(255,255,255,.04);border:1px solid var(--border);border-radius:10px;padding:9px">
        <div style="font-family:'Syne',sans-serif;font-weight:800;font-size:1.05rem" id="reqPickupDist">--km</div>
        <div style="font-size:.58rem;color:var(--muted);font-weight:600;margin-top:1px">PICKUP</div>
      </div>
      <div style="flex:1;text-align:center;background:rgba(255,255,255,.04);border:1px solid var(--border);border-radius:10px;padding:9px">
        <div style="font-family:'Syne',sans-serif;font-weight:800;font-size:1.05rem" id="reqETA">--m</div>
        <div style="font-size:.58rem;color:var(--muted);font-weight:600;margin-top:1px">ETA</div>
      </div>
    </div>
    <div class="trip-row">
      <div class="tdots"><div class="tdg"></div><div class="tdl"></div><div class="tdr"></div></div>
      <div class="tadd">
        <div class="ta-row"><div class="ta-lbl">Pickup</div><div class="ta-val" id="reqPick">--</div></div>
        <div class="ta-row"><div class="ta-lbl">Drop</div><div class="ta-val" id="reqDrop">--</div></div>
      </div>
    </div>
    <div class="req-btns">
      <button class="mbtn ro" style="margin-top:0" onclick="declineReq()">Decline</button>
      <button class="mbtn g" style="margin-top:0" onclick="acceptReq()">✅ Accept</button>
    </div>
  </div>
</div>

<!-- 🆘 SOS BUTTON (visible during active ride) -->
<button id="sosBtn" onclick="panicSOS()" title="Emergency SOS">🆘</button>

<!-- ══ MODALS ══ -->

<!-- RIDE HISTORY MODAL -->
<div id="histModal" onclick="if(event.target===this)closeModal('histModal')">
  <div class="modal-box">
    <div class="modal-hd">
      <div class="modal-title">📋 Ride History</div>
      <button class="modal-close" onclick="closeModal('histModal')">✕</button>
    </div>
    <div id="histList"><div style="text-align:center;color:var(--muted);padding:30px">Loading...</div></div>
  </div>
</div>

<!-- RATING MODAL -->
<div id="ratingModal" onclick="if(event.target===this)closeModal('ratingModal')">
  <div class="modal-box">
    <div class="modal-hd">
      <div class="modal-title">⭐ Rate Your Ride</div>
    </div>
    <div style="text-align:center">
      <div id="rateDriverName" style="font-size:.85rem;color:var(--muted);margin-bottom:4px">Your Driver</div>
      <div id="rateDriverPhoto" style="font-size:3rem;margin-bottom:8px">👨🏽‍✈️</div>
      <div style="font-size:.75rem;color:var(--muted);margin-bottom:4px">Ride Experience Kaisa Tha?</div>
      <div class="stars-wrap" id="starsWrap">
        <span class="star-big" onclick="setRating(1)">★</span>
        <span class="star-big" onclick="setRating(2)">★</span>
        <span class="star-big" onclick="setRating(3)">★</span>
        <span class="star-big" onclick="setRating(4)">★</span>
        <span class="star-big" onclick="setRating(5)">★</span>
      </div>
      <div id="ratingLabel" style="font-size:.8rem;color:var(--muted);min-height:20px;margin-bottom:12px"></div>
      <textarea id="ratingComment" class="fi" placeholder="Comment (optional)..." style="height:70px;resize:none;margin-bottom:12px"></textarea>
      <button class="mbtn y" style="margin-top:0" onclick="submitRating()">✅ Submit Rating</button>
      <button class="mbtn" style="margin-top:8px;background:transparent;color:var(--muted);border:1px solid var(--border)" onclick="closeModal('ratingModal')">Skip</button>
    </div>
  </div>
</div>

<!-- RECEIPT MODAL -->
<div id="receiptModal" onclick="if(event.target===this)closeModal('receiptModal')">
  <div class="modal-box">
    <div class="modal-hd">
      <div class="modal-title">🧾 Ride Receipt</div>
      <button class="modal-close" onclick="closeModal('receiptModal')">✕</button>
    </div>
    <div style="text-align:center;margin-bottom:14px">
      <div style="font-size:.65rem;color:var(--muted);font-weight:700;text-transform:uppercase;letter-spacing:.05em">JDP CABS — JAGDALPUR</div>
      <div style="font-size:.7rem;color:var(--muted);margin-top:2px" id="rcptDate">--</div>
    </div>
    <div id="rcptBody"></div>
    <div style="font-family:'Syne',sans-serif;font-weight:900;font-size:1.6rem;color:var(--green);text-align:center;padding:14px 0;border-top:1px solid var(--border);border-bottom:1px solid var(--border);margin:8px 0" id="rcptTotal">₹--</div>
    <div id="rcptShareBtns" style="margin-top:8px"></div>
  </div>
</div>

<!-- CANCEL REASON MODAL -->
<div id="cancelModal" onclick="if(event.target===this)closeModal('cancelModal')">
  <div class="modal-box">
    <div class="modal-hd">
      <div class="modal-title">❌ Cancel Ride</div>
      <button class="modal-close" onclick="closeModal('cancelModal')">✕</button>
    </div>
    <div style="font-size:.8rem;color:var(--muted);margin-bottom:14px">Cancel karne ki wajah batao:</div>
    <div id="cancelReasonList">
      <div class="cancel-opt" onclick="selectCancelReason(this,'Driver bahut door hai')">🚗 Driver bahut door hai</div>
      <div class="cancel-opt" onclick="selectCancelReason(this,'Bahut zyada wait hua')">⏰ Bahut zyada wait hua</div>
      <div class="cancel-opt" onclick="selectCancelReason(this,'Plans change ho gaye')">🔄 Plans change ho gaye</div>
      <div class="cancel-opt" onclick="selectCancelReason(this,'Galat location select hui')">📍 Galat location select hui</div>
      <div class="cancel-opt" onclick="selectCancelReason(this,'Doosra cab mil gaya')">🚕 Doosra cab mil gaya</div>
      <div class="cancel-opt" onclick="selectCancelReason(this,'Koi aur karan')">💬 Koi aur karan</div>
    </div>
    <button class="mbtn ro" style="margin-top:8px" id="confirmCancelBtn" onclick="confirmCancelRide()" disabled>Cancel Ride →</button>
  </div>
</div>

<!-- QUICK MESSAGES MODAL -->
<div id="msgModal" onclick="if(event.target===this)closeModal('msgModal')">
  <div class="modal-box">
    <div class="modal-hd">
      <div class="modal-title">💬 Quick Message</div>
      <button class="modal-close" onclick="closeModal('msgModal')">✕</button>
    </div>
    <div style="font-size:.8rem;color:var(--muted);margin-bottom:12px">Driver ko quick message bhejo:</div>
    <div id="qmsgs">
      <div class="qmsg-chip" onclick="sendQuickMsg('📍 Main pickup point par hoon')">📍 Main pickup par hoon</div>
      <div class="qmsg-chip" onclick="sendQuickMsg('⏳ 2 minute aur wait karo please')">⏳ 2 min wait karo</div>
      <div class="qmsg-chip" onclick="sendQuickMsg('🔴 Gate ke bahar khada hoon')">🔴 Gate ke bahar hoon</div>
      <div class="qmsg-chip" onclick="sendQuickMsg('📞 Please call karo')">📞 Call karo</div>
      <div class="qmsg-chip" onclick="sendQuickMsg('✅ Aa raha hoon 1 min mein')">✅ 1 min mein aa raha hoon</div>
      <div class="qmsg-chip" onclick="sendQuickMsg('🏠 Building ke andar aao')">🏠 Andar aao</div>
    </div>
    <div style="margin-top:14px">
      <textarea id="customMsgInput" class="fi" placeholder="Ya apna message type karo..." style="height:60px;resize:none;margin-bottom:9px"></textarea>
      <button class="mbtn b" style="margin-top:0" onclick="sendCustomMsg()">📨 Send Message</button>
    </div>
    <div id="msgSentConfirm" style="display:none;text-align:center;color:var(--green);font-size:.8rem;margin-top:9px">✅ Message sent!</div>
  </div>
</div>

<!-- PROMO CODE MODAL -->
<div id="promoModal" onclick="if(event.target===this)closeModal('promoModal')">
  <div class="modal-box">
    <div class="modal-hd">
      <div class="modal-title">🎁 Promo Code</div>
      <button class="modal-close" onclick="closeModal('promoModal')">✕</button>
    </div>
    <input type="text" class="fi" id="promoInput" placeholder="Code daalo (e.g. JDP50)" style="text-transform:uppercase;margin-bottom:10px;letter-spacing:.08em;font-weight:700;" oninput="this.value=this.value.toUpperCase()">
    <button class="mbtn y" style="margin-top:0" onclick="applyPromo()">✅ Apply</button>
    <div id="promoResult" style="margin-top:10px;text-align:center;font-size:.82rem"></div>
    <div style="margin-top:16px;font-size:.72rem;color:var(--muted);font-weight:700;text-transform:uppercase;letter-spacing:.04em;margin-bottom:8px">Available Offers</div>
    <div onclick="document.getElementById('promoInput').value='JDP50';applyPromo()" style="background:rgba(139,92,246,.08);border:1px solid rgba(139,92,246,.2);border-radius:12px;padding:10px 13px;margin-bottom:8px;cursor:pointer">
      <div style="font-weight:800;font-size:.88rem">🎉 JDP50 — ₹50 Off</div>
      <div style="font-size:.7rem;color:var(--muted);margin-top:2px">Pehli ride par ₹50 discount</div>
    </div>
    <div onclick="document.getElementById('promoInput').value='FREE1';applyPromo()" style="background:rgba(16,185,129,.08);border:1px solid rgba(16,185,129,.2);border-radius:12px;padding:10px 13px;cursor:pointer">
      <div style="font-weight:800;font-size:.88rem">🚖 FREE1 — Pehli Ride Free</div>
      <div style="font-size:.7rem;color:var(--muted);margin-top:2px">Max ₹100 tak free (New users only)</div>
    </div>
  </div>
</div>

<!-- NET -->
<div class="netb" id="netB">⚠️ No Internet</div>

<!-- ════════════════════════════════════════════════════════
     🆕 NEW MAPPLS FEATURES HTML
════════════════════════════════════════════════════════ -->

<!-- ── SNAP-TO-ROAD INDICATOR ── -->
<div id="snapIndicator" style="display:none">📡 Snap-to-Road ON</div>

<!-- eLOC SEARCH PANEL — hidden, not needed for riders -->
<div id="elocPanel" style="display:none"></div>

<!-- LANGUAGE SELECTOR — hidden -->
<div id="langSelector" style="display:none"></div>

<!-- ── MAP FEATURE FAB ROW ── -->
<!-- FABs hidden — admin-only features -->
<div id="mapFabRow" style="display:none"></div>

<!-- ── FLEET TRACKING MODAL ── -->
<div id="fleetModal">
  <div class="fleet-box">
    <div class="fleet-hd">
      <div class="fleet-title">🚦 Fleet Tracking — Live</div>
      <button class="fleet-close" onclick="closeFleetPanel()">✕</button>
    </div>
    <!-- Fleet Stats -->
    <div class="fleet-stats">
      <div class="fleet-stat">
        <div class="fleet-stat-v" id="fleetTotal" style="color:var(--blue)">0</div>
        <div class="fleet-stat-l">Total</div>
      </div>
      <div class="fleet-stat">
        <div class="fleet-stat-v" id="fleetOnline" style="color:var(--green)">0</div>
        <div class="fleet-stat-l">Online</div>
      </div>
      <div class="fleet-stat">
        <div class="fleet-stat-v" id="fleetOnRide" style="color:var(--yellow)">0</div>
        <div class="fleet-stat-l">On Ride</div>
      </div>
    </div>
    <!-- Live Map Link -->
    <div style="background:rgba(59,130,246,.08);border:1px solid rgba(59,130,246,.2);border-radius:12px;padding:10px 13px;margin-bottom:12px;display:flex;align-items:center;gap:8px;">
      <span style="font-size:1.1rem">🗺️</span>
      <div style="flex:1">
        <div style="font-weight:700;font-size:.82rem">Live Map Tracking</div>
        <div style="font-size:.65rem;color:var(--muted)">All vehicles visible on main map</div>
      </div>
      <button onclick="closeFleetPanel();toast('🗺️ Fleet dots visible on map!');" 
        style="background:var(--blue);border:none;border-radius:8px;padding:6px 12px;color:#fff;font-size:.72rem;font-weight:800;cursor:pointer;">View</button>
    </div>
    <!-- Vehicle Profile Filter -->
    <div style="display:flex;gap:6px;margin-bottom:12px;">
      <button class="qp-chip" id="fleetFilterAll" onclick="fleetFilter('all')" style="border-color:var(--yellow);background:rgba(245,158,11,.1)">All Vehicles</button>
      <button class="qp-chip" id="fleetFilterCab" onclick="fleetFilter('cab')">🚗 Cab</button>
      <button class="qp-chip" id="fleetFilterAuto" onclick="fleetFilter('auto')">🛺 Auto</button>
    </div>
    <!-- Driver List -->
    <div id="fleetDriverList">
      <div style="text-align:center;padding:20px;color:var(--muted);font-size:.82rem">
        Loading fleet data...
      </div>
    </div>
    <!-- VRP hint -->
    <div style="margin-top:12px;background:rgba(16,185,129,.07);border:1px solid rgba(16,185,129,.2);border-radius:12px;padding:10px 13px;cursor:pointer;" onclick="closeFleetPanel();openVRPPanel();">
      <div style="font-size:.7rem;font-weight:800;color:var(--green)">🔀 Vehicle Routing Problem (VRP)</div>
      <div style="font-size:.62rem;color:var(--muted);margin-top:2px">Tap to optimize multiple ride assignments automatically</div>
    </div>
  </div>
</div>

<!-- ── VRP OPTIMIZER MODAL ── -->
<div id="vrpModal">
  <div class="vrp-box">
    <div class="vrp-hd">
      <div style="font-family:'Syne',sans-serif;font-weight:900;font-size:1.05rem">🔀 VRP Route Optimizer</div>
      <button class="fleet-close" onclick="document.getElementById('vrpModal').classList.remove('sh')">✕</button>
    </div>
    <div style="font-size:.75rem;color:var(--muted);margin-bottom:14px;line-height:1.5">
      Vehicle Routing Problem solver — assigns <b>nearest available driver</b> to each pending ride, minimizing total travel distance across the fleet.
    </div>
    <!-- Control Row -->
    <div style="display:flex;gap:8px;margin-bottom:14px">
      <button class="mbtn y" style="margin-top:0;flex:1" onclick="runVRPOptimizer()">⚡ Run VRP Now</button>
      <button class="mbtn" style="margin-top:0;background:rgba(59,130,246,.1);border:1px solid rgba(59,130,246,.25);color:var(--blue)" onclick="vrpSimulate()">🎲 Simulate</button>
    </div>
    <!-- VRP Stats -->
    <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:8px;margin-bottom:14px" id="vrpStatsRow" style="display:none">
      <div class="fleet-stat">
        <div class="fleet-stat-v" id="vrpTotalKm" style="color:var(--green)">--</div>
        <div class="fleet-stat-l">Total km</div>
      </div>
      <div class="fleet-stat">
        <div class="fleet-stat-v" id="vrpAssigned" style="color:var(--blue)">--</div>
        <div class="fleet-stat-l">Assigned</div>
      </div>
      <div class="fleet-stat">
        <div class="fleet-stat-v" id="vrpSaved" style="color:var(--yellow)">--</div>
        <div class="fleet-stat-l">km Saved</div>
      </div>
    </div>
    <!-- VRP Results -->
    <div id="vrpResults">
      <div style="text-align:center;padding:20px">
        <div style="font-size:2rem;margin-bottom:8px">🔀</div>
        <div style="font-size:.82rem;color:var(--muted)">Press "Run VRP" to compute optimal assignments</div>
      </div>
    </div>
  </div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
import { getFirestore, doc, setDoc, getDoc, getDocs, collection, addDoc, updateDoc, deleteDoc, onSnapshot, query, where, orderBy, limit, serverTimestamp, GeoPoint } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

const cfg = {
  apiKey:"AIzaSyBRPV3mosWr3YFnW6xCfJaqC1bV4MhJm_Y",
  authDomain:"jdpcabs.firebaseapp.com",
  projectId:"jdpcabs",
  storageBucket:"jdpcabs.firebasestorage.app",
  messagingSenderId:"148264332732",
  appId:"1:148264332732:web:eed512ac4e685cef97cfb9"
};
try {
  const fbApp = initializeApp(cfg);
  const auth = getAuth(fbApp);
  const db = getFirestore(fbApp);
  window.FB = { auth, db, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, onAuthStateChanged,
    doc, setDoc, getDoc, getDocs, collection, addDoc, updateDoc, deleteDoc, onSnapshot, query, where, orderBy, limit, serverTimestamp, GeoPoint };
  window.FB_READY = true;
  // Auto-login check on Firebase ready
  onAuthStateChanged(auth, async (user) => {
    if (user && !window.CU) {
      try {
        const s = await getDoc(doc(db,'users',user.uid));
        if (s.exists()) { window.CU = { uid:user.uid, ...s.data() }; if(window._launchPending) launch(); }
      } catch(e) {}
    }
  });
  var fbBadgeEl = document.getElementById('fbBadge');
  if(fbBadgeEl){ fbBadgeEl.className='fbb ok'; fbBadgeEl.textContent='✅ Firebase Live'; }
} catch(e) {
  window.FB_READY = false;
  var fbBadgeEl2 = document.getElementById('fbBadge');
  if(fbBadgeEl2){ fbBadgeEl2.className='fbb er'; fbBadgeEl2.textContent='❌ Firebase Error'; }
  console.error('[JDP] Firebase init failed:', e);
}
</script>

<script>

// ================================================================
// CRASH GUARD — Safe element setter (never crashes on missing ID)
// ================================================================
function safeText(id, val) {
  try { var el=document.getElementById(id); if(el) el.textContent=val; } catch(e) {}
}
function safeHtml(id, val) {
  try { var el=document.getElementById(id); if(el) el.innerHTML=val; } catch(e) {}
}
function safeShow(id, disp) {
  try { var el=document.getElementById(id); if(el) el.style.display=disp||'block'; } catch(e) {}
}
function safeHide(id) {
  try { var el=document.getElementById(id); if(el) el.style.display='none'; } catch(e) {}
}
function safeVal(id, val) {
  try { var el=document.getElementById(id); if(el) el.value=val; } catch(e) {}
}

// ═══════════════════════════════════════════════════════
// ✅ JAGDALPUR CONFIG — City coordinates & zones
// ═══════════════════════════════════════════════════════
const JDPC = { lat: 19.0760, lng: 82.0150 };  // Jagdalpur city center
const ZONE_CORE   = 3;   // km — City core (Green)
const ZONE_CITY   = 8;   // km — City zone (Blue) — main service area
const ZONE_OUTER  = 15;  // km — Outer area (Yellow)
const MATCH_RADIUS_1 = 5; // km — First try matching within 5km
const MATCH_RADIUS_2 = 8; // km — Then expand to 8km

// ✅ JAGDALPUR COMPLETE LOCAL ADDRESS DATABASE — 200+ locations
// Roads, Mohallas, Hospitals, Schools, Markets, Shops, Govt Offices
const JAGDALPUR_LANDMARKS = [

  // ══ MAJOR LANDMARKS ══
  { name:'Bastar Palace',                lat:19.0741, lng:82.0192, icon:'🏯', info:'Historic Royal Palace, Jagdalpur', cat:'landmark' },
  { name:'Jagdalpur Bus Stand',          lat:19.0798, lng:82.0087, icon:'🚌', info:'Main State Bus Stand', cat:'transport' },
  { name:'Jagdalpur Railway Station',    lat:19.0650, lng:82.0310, icon:'🚂', info:'Railway Station, Jagdalpur', cat:'transport' },
  { name:'Swami Vivekananda Airport',    lat:19.0600, lng:82.0580, icon:'✈️', info:'Jagdalpur Airport', cat:'transport' },
  { name:'Collectorate Jagdalpur',       lat:19.0734, lng:82.0141, icon:'🏛️', info:'District Collectorate', cat:'govt' },
  { name:'Danteshwari Temple',           lat:19.0756, lng:82.0165, icon:'🛕', info:'Maa Danteshwari Mandir', cat:'temple' },
  { name:'Chitrakote Waterfall',         lat:19.2093, lng:81.8504, icon:'🌊', info:'India ka Niagara, ~48km road', cat:'tourism' },
  { name:'Kanger Valley National Park',  lat:19.0389, lng:81.9267, icon:'🌿', info:'National Park entrance ~9km', cat:'tourism' },

  // ══ HOSPITALS & MEDICAL ══
  { name:'Maharaja Hospital',            lat:19.0712, lng:82.0223, icon:'🏥', info:'District Hospital, Main Road', cat:'hospital' },
  { name:'Govt Medical College',         lat:19.0700, lng:82.0280, icon:'⚕️', info:'Govt Medical College & Hospital', cat:'hospital' },
  { name:'DKS Hospital',                 lat:19.0730, lng:82.0200, icon:'🏥', info:'DKS Super Speciality Hospital', cat:'hospital' },
  { name:'Community Health Centre',      lat:19.0760, lng:82.0120, icon:'🏥', info:'CHC Jagdalpur', cat:'hospital' },
  { name:'District Hospital Jagdalpur',  lat:19.0715, lng:82.0190, icon:'🏥', info:'District Hospital', cat:'hospital' },
  { name:'Ayurvedic Hospital',           lat:19.0740, lng:82.0170, icon:'🌿', info:'Govt Ayurvedic Hospital', cat:'hospital' },
  { name:'Apollo Clinic Jagdalpur',      lat:19.0755, lng:82.0155, icon:'🏥', info:'Apollo Pharmacy & Clinic', cat:'hospital' },
  { name:'Jan Swasthya Sahayog',         lat:19.0780, lng:82.0100, icon:'⚕️', info:'Health Centre', cat:'hospital' },

  // ══ SCHOOLS & COLLEGES ══
  { name:'JNKVV College',                lat:19.0820, lng:81.9980, icon:'🎓', info:'Jawaharlal Nehru Krishi Vishwa Vidyalaya', cat:'education' },
  { name:'Govt Engineering College',     lat:19.0850, lng:81.9950, icon:'🎓', info:'Govt Engineering College Jagdalpur', cat:'education' },
  { name:'Govt PG College',              lat:19.0760, lng:82.0130, icon:'🎓', info:'Govt Post Graduate College', cat:'education' },
  { name:'Bastar University',            lat:19.0800, lng:82.0050, icon:'🎓', info:'Shaheed Mahendra Karma Vishwavidyalaya', cat:'education' },
  { name:'St Xavier School',             lat:19.0770, lng:82.0170, icon:'🏫', info:"St. Xavier's Higher Secondary School", cat:'education' },
  { name:'Kendriya Vidyalaya',           lat:19.0720, lng:82.0240, icon:'🏫', info:'Kendriya Vidyalaya Jagdalpur', cat:'education' },
  { name:'Navodaya Vidyalaya',           lat:19.0680, lng:82.0300, icon:'🏫', info:'Jawahar Navodaya Vidyalaya', cat:'education' },
  { name:'DPS Jagdalpur',                lat:19.0810, lng:82.0060, icon:'🏫', info:'Delhi Public School', cat:'education' },
  { name:'Govt Boys High School',        lat:19.0745, lng:82.0185, icon:'🏫', info:'Govt Higher Secondary School Boys', cat:'education' },
  { name:'Govt Girls School',            lat:19.0750, lng:82.0200, icon:'🏫', info:'Govt Higher Secondary School Girls', cat:'education' },
  { name:'Dharampura School',            lat:19.0790, lng:82.0110, icon:'🏫', info:'Primary School Dharampura', cat:'education' },
  { name:'BIT College',                  lat:19.0830, lng:81.9970, icon:'🎓', info:'Bastar Institute of Technology', cat:'education' },
  { name:'ITI Jagdalpur',                lat:19.0700, lng:82.0260, icon:'🎓', info:'Industrial Training Institute', cat:'education' },
  { name:'Polytechnic College',          lat:19.0720, lng:82.0250, icon:'🎓', info:'Govt Polytechnic College', cat:'education' },

  // ══ MARKETS & SHOPPING ══
  { name:'Gol Bazar',                    lat:19.0760, lng:82.0150, icon:'🛍️', info:'Main Market, City Center', cat:'market' },
  { name:'Lal Bazar Jagdalpur',          lat:19.0755, lng:82.0158, icon:'🛍️', info:'Lal Bazar Main Market', cat:'market' },
  { name:'Dhanteras Market',             lat:19.0762, lng:82.0145, icon:'🛒', info:'Weekly Market Area', cat:'market' },
  { name:'Subhash Market',               lat:19.0758, lng:82.0155, icon:'🛍️', info:'Subhash Market Complex', cat:'market' },
  { name:'Cloth Market Jagdalpur',       lat:19.0760, lng:82.0148, icon:'👗', info:'Kapda Market, Jagdalpur', cat:'market' },
  { name:'Sabzi Mandi Jagdalpur',        lat:19.0775, lng:82.0130, icon:'🥦', info:'Vegetable Market', cat:'market' },
  { name:'Grain Market',                 lat:19.0770, lng:82.0135, icon:'🌾', info:'Anaj Mandi Jagdalpur', cat:'market' },
  { name:'Iron Market Jagdalpur',        lat:19.0758, lng:82.0160, icon:'🔧', info:'Loha Bazaar', cat:'market' },
  { name:'City Mall Jagdalpur',          lat:19.0752, lng:82.0165, icon:'🏬', info:'Shopping Mall', cat:'mall' },
  { name:'Bastar Mall',                  lat:19.0748, lng:82.0175, icon:'🏬', info:'Bastar Shopping Complex', cat:'mall' },
  { name:'Reliance Smart',               lat:19.0755, lng:82.0162, icon:'🛒', info:'Reliance Supermarket', cat:'mall' },
  { name:'Big Bazaar Jagdalpur',         lat:19.0750, lng:82.0168, icon:'🛒', info:'Big Bazaar / D-Mart area', cat:'mall' },
  { name:'Shree Ram Cloth House',        lat:19.0761, lng:82.0150, icon:'👕', info:'Kapda Store, Gol Bazar', cat:'shop' },
  { name:'Sharma Electronics',           lat:19.0759, lng:82.0152, icon:'📱', info:'Electronics Market', cat:'shop' },
  { name:'Book Market Jagdalpur',        lat:19.0756, lng:82.0157, icon:'📚', info:'Kitab Bazaar', cat:'shop' },

  // ══ MOHALLAS & COLONIES ══
  { name:'Dharampura',                   lat:19.0790, lng:82.0110, icon:'🏘️', info:'Dharampura Mohalla', cat:'area' },
  { name:'Shiv Nagar Colony',            lat:19.0780, lng:82.0090, icon:'🏘️', info:'Shiv Nagar Residential', cat:'area' },
  { name:'Gandhi Nagar Jagdalpur',       lat:19.0770, lng:82.0120, icon:'🏘️', info:'Gandhi Nagar Colony', cat:'area' },
  { name:'Nehru Nagar Jagdalpur',        lat:19.0765, lng:82.0140, icon:'🏘️', info:'Nehru Nagar Area', cat:'area' },
  { name:'Ambedkar Nagar',               lat:19.0785, lng:82.0105, icon:'🏘️', info:'Ambedkar Nagar Colony', cat:'area' },
  { name:'Ram Nagar Jagdalpur',          lat:19.0795, lng:82.0095, icon:'🏘️', info:'Ram Nagar Mohalla', cat:'area' },
  { name:'Sunder Nagar',                 lat:19.0760, lng:82.0170, icon:'🏘️', info:'Sunder Nagar Colony', cat:'area' },
  { name:'Indira Nagar Jagdalpur',       lat:19.0740, lng:82.0200, icon:'🏘️', info:'Indira Nagar Area', cat:'area' },
  { name:'Shankar Nagar Jagdalpur',      lat:19.0730, lng:82.0210, icon:'🏘️', info:'Shankar Nagar Colony', cat:'area' },
  { name:'Tilak Nagar Jagdalpur',        lat:19.0725, lng:82.0220, icon:'🏘️', info:'Tilak Nagar Residential', cat:'area' },
  { name:'Durkigudapara',                lat:19.0800, lng:82.0080, icon:'🏘️', info:'Durkigudapara Area', cat:'area' },
  { name:'Manikpur Colony',              lat:19.0815, lng:82.0065, icon:'🏘️', info:'Manikpur Residential', cat:'area' },
  { name:'Kumarapara',                   lat:19.0750, lng:82.0180, icon:'🏘️', info:'Kumarapara Mohalla', cat:'area' },
  { name:'Singanpur',                    lat:19.0770, lng:82.0080, icon:'🏘️', info:'Singanpur Area', cat:'area' },
  { name:'Umarwara',                     lat:19.0680, lng:82.0340, icon:'🏘️', info:'Umarwara Colony', cat:'area' },
  { name:'Tikrapara Jagdalpur',          lat:19.0760, lng:82.0190, icon:'🏘️', info:'Tikrapara Area', cat:'area' },
  { name:'Bhadrapara',                   lat:19.0735, lng:82.0210, icon:'🏘️', info:'Bhadrapara Colony', cat:'area' },
  { name:'Golapara',                     lat:19.0820, lng:82.0070, icon:'🏘️', info:'Golapara Mohalla', cat:'area' },
  { name:'Potkapara',                    lat:19.0710, lng:82.0270, icon:'🏘️', info:'Potkapara Area', cat:'area' },
  { name:'Kotenar',                      lat:19.0830, lng:82.0050, icon:'🏘️', info:'Kotenar Area', cat:'area' },
  { name:'Keshlur',                      lat:19.0660, lng:82.0350, icon:'🏘️', info:'Keshlur Colony', cat:'area' },
  { name:'Kachanar Colony',              lat:19.0840, lng:82.0040, icon:'🏘️', info:'Kachanar Residential', cat:'area' },
  { name:'Subhash Nagar Jagdalpur',      lat:19.0755, lng:82.0175, icon:'🏘️', info:'Subhash Nagar Colony', cat:'area' },
  { name:'Laxmi Nagar Jagdalpur',        lat:19.0745, lng:82.0185, icon:'🏘️', info:'Laxmi Nagar Area', cat:'area' },
  { name:'Patel Nagar Jagdalpur',        lat:19.0775, lng:82.0100, icon:'🏘️', info:'Patel Nagar Mohalla', cat:'area' },
  { name:'Civil Lines Jagdalpur',        lat:19.0720, lng:82.0230, icon:'🏘️', info:'Civil Lines Residential Area', cat:'area' },
  { name:'Rajendra Nagar Jagdalpur',     lat:19.0730, lng:82.0215, icon:'🏘️', info:'Rajendra Nagar Colony', cat:'area' },
  { name:'New Bus Stand Colony',         lat:19.0795, lng:82.0090, icon:'🏘️', info:'Near New Bus Stand Area', cat:'area' },
  { name:'Station Road Colony',          lat:19.0660, lng:82.0315, icon:'🏘️', info:'Near Railway Station', cat:'area' },

  // ══ MAIN ROADS & CHOWKS ══
  { name:'Mahatma Gandhi Chowk',         lat:19.0762, lng:82.0147, icon:'🔄', info:'Main Chowk, City Center', cat:'road' },
  { name:'Netaji Chowk Jagdalpur',       lat:19.0758, lng:82.0153, icon:'🔄', info:'Netaji Subhash Chowk', cat:'road' },
  { name:'Dharampura Chowk',             lat:19.0788, lng:82.0112, icon:'🔄', info:'Dharampura Crossing', cat:'road' },
  { name:'Hospital Chowk Jagdalpur',     lat:19.0715, lng:82.0218, icon:'🔄', info:'Near Hospital Crossing', cat:'road' },
  { name:'Collectorate Chowk',           lat:19.0736, lng:82.0138, icon:'🔄', info:'Collectorate Crossing', cat:'road' },
  { name:'Station Road Jagdalpur',       lat:19.0660, lng:82.0320, icon:'🛣️', info:'Railway Station Road', cat:'road' },
  { name:'Main Road Jagdalpur',          lat:19.0760, lng:82.0150, icon:'🛣️', info:'NH-30 Main Road', cat:'road' },
  { name:'NH-30 Jagdalpur',              lat:19.0760, lng:82.0200, icon:'🛣️', info:'National Highway 30', cat:'road' },
  { name:'NH-63 Jagdalpur',              lat:19.0700, lng:82.0100, icon:'🛣️', info:'National Highway 63', cat:'road' },
  { name:'Bus Stand Road',               lat:19.0793, lng:82.0093, icon:'🛣️', info:'Road to Bus Stand', cat:'road' },
  { name:'Airport Road Jagdalpur',       lat:19.0620, lng:82.0490, icon:'🛣️', info:'Road to Airport', cat:'road' },
  { name:'Bastar Palace Road',           lat:19.0743, lng:82.0188, icon:'🛣️', info:'Palace Road', cat:'road' },
  { name:'College Road Jagdalpur',       lat:19.0815, lng:81.9985, icon:'🛣️', info:'College Area Road', cat:'road' },
  { name:'Medical College Road',         lat:19.0705, lng:82.0272, icon:'🛣️', info:'Road to Medical College', cat:'road' },
  { name:'Ring Road Jagdalpur',          lat:19.0850, lng:82.0100, icon:'🛣️', info:'Ring Road Bypass', cat:'road' },
  { name:'Bypass Road Jagdalpur',        lat:19.0880, lng:82.0080, icon:'🛣️', info:'NH Bypass Road', cat:'road' },
  { name:'Dharampura Road',              lat:19.0790, lng:82.0108, icon:'🛣️', info:'Dharampura Main Road', cat:'road' },
  { name:'Tikrapara Road',               lat:19.0755, lng:82.0185, icon:'🛣️', info:'Tikrapara Colony Road', cat:'road' },
  { name:'Kanger Valley Road',           lat:19.0600, lng:81.9800, icon:'🛣️', info:'Road to Kanger Valley', cat:'road' },

  // ══ GOVERNMENT OFFICES ══
  { name:'SP Office Jagdalpur',          lat:19.0730, lng:82.0148, icon:'🚔', info:'Superintendent of Police Office', cat:'govt' },
  { name:'CMHO Office Jagdalpur',        lat:19.0728, lng:82.0160, icon:'🏛️', info:'Chief Medical Health Officer', cat:'govt' },
  { name:'Tehsildar Office',             lat:19.0732, lng:82.0143, icon:'🏛️', info:'Tehsil Office Jagdalpur', cat:'govt' },
  { name:'PWD Office Jagdalpur',         lat:19.0726, lng:82.0155, icon:'🏛️', info:'Public Works Department', cat:'govt' },
  { name:'Forest Office Jagdalpur',      lat:19.0720, lng:82.0165, icon:'🌳', info:'Divisional Forest Office', cat:'govt' },
  { name:'Court Compound Jagdalpur',     lat:19.0735, lng:82.0145, icon:'⚖️', info:'District Court Jagdalpur', cat:'govt' },
  { name:'Jail Jagdalpur',               lat:19.0710, lng:82.0200, icon:'🏛️', info:'District Jail', cat:'govt' },
  { name:'Post Office Jagdalpur',        lat:19.0758, lng:82.0160, icon:'📮', info:'Head Post Office', cat:'govt' },
  { name:'SBI Bank Main Branch',         lat:19.0757, lng:82.0158, icon:'🏦', info:'State Bank of India Main', cat:'bank' },
  { name:'Bank of Baroda Jagdalpur',     lat:19.0759, lng:82.0155, icon:'🏦', info:'Bank of Baroda Branch', cat:'bank' },
  { name:'PNB Bank Jagdalpur',           lat:19.0761, lng:82.0151, icon:'🏦', info:'Punjab National Bank', cat:'bank' },
  { name:'HDFC Bank Jagdalpur',          lat:19.0754, lng:82.0163, icon:'🏦', info:'HDFC Bank Branch', cat:'bank' },
  { name:'Axis Bank Jagdalpur',          lat:19.0756, lng:82.0161, icon:'🏦', info:'Axis Bank ATM & Branch', cat:'bank' },
  { name:'Income Tax Office',            lat:19.0728, lng:82.0150, icon:'🏛️', info:'IT Office Jagdalpur', cat:'govt' },
  { name:'CGSEB Office',                 lat:19.0724, lng:82.0162, icon:'💡', info:'Electricity Board Office', cat:'govt' },
  { name:'Nagar Palika Jagdalpur',       lat:19.0738, lng:82.0140, icon:'🏛️', info:'Municipal Council Office', cat:'govt' },
  { name:'DRDA Office Jagdalpur',        lat:19.0732, lng:82.0148, icon:'🏛️', info:'District Rural Dev Authority', cat:'govt' },

  // ══ PETROL PUMPS ══
  { name:'IOC Petrol Pump Main Road',    lat:19.0765, lng:82.0143, icon:'⛽', info:'Indian Oil Petrol Pump', cat:'fuel' },
  { name:'HPCL Petrol Pump',             lat:19.0800, lng:82.0085, icon:'⛽', info:'HP Petrol Pump, Bus Stand Road', cat:'fuel' },
  { name:'BPCL Petrol Pump',             lat:19.0710, lng:82.0265, icon:'⛽', info:'Bharat Petrol Pump', cat:'fuel' },
  { name:'Petrol Pump Airport Road',     lat:19.0625, lng:82.0470, icon:'⛽', info:'Fuel Station, Airport Road', cat:'fuel' },
  { name:'Petrol Pump NH-30',            lat:19.0870, lng:82.0070, icon:'⛽', info:'Petrol Pump, National Highway 30', cat:'fuel' },

  // ══ TEMPLES & RELIGIOUS ══
  { name:'Shiv Mandir Dharampura',       lat:19.0792, lng:82.0108, icon:'🛕', info:'Shiv Mandir, Dharampura', cat:'temple' },
  { name:'Hanuman Mandir Main Road',     lat:19.0763, lng:82.0145, icon:'🛕', info:'Hanuman Temple, Main Road', cat:'temple' },
  { name:'Kali Mata Mandir',             lat:19.0748, lng:82.0178, icon:'🛕', info:'Kali Mandir Jagdalpur', cat:'temple' },
  { name:'Masjid Jagdalpur',             lat:19.0768, lng:82.0137, icon:'🕌', info:'Jama Masjid, Jagdalpur', cat:'temple' },
  { name:'Church Jagdalpur',             lat:19.0775, lng:82.0125, icon:'⛪', info:'Christian Church', cat:'temple' },
  { name:'Gurudwara Jagdalpur',          lat:19.0772, lng:82.0130, icon:'⛩️', info:'Gurudwara Sahib', cat:'temple' },
  { name:'Ram Mandir Jagdalpur',         lat:19.0778, lng:82.0118, icon:'🛕', info:'Ram Mandir Colony', cat:'temple' },
  { name:'Durga Mandir',                 lat:19.0745, lng:82.0183, icon:'🛕', info:'Durga Mata Mandir', cat:'temple' },

  // ══ 15KM OUTER ZONE LANDMARKS ══ (surrounding Jagdalpur)
  { name:'Darbha',                        lat:19.1800, lng:81.9300, icon:'🏘️', info:'Darbha Town ~25km', cat:'area' },
  { name:'Tokapal',                       lat:19.1500, lng:82.0500, icon:'🏘️', info:'Tokapal Village ~10km', cat:'area' },
  { name:'Narayanpur Road Crossing',      lat:19.1200, lng:82.0000, icon:'🛣️', info:'NH Crossing, North', cat:'road' },
  { name:'Bacheli Road Jagdalpur',        lat:19.0500, lng:82.1000, icon:'🛣️', info:'Road to Bacheli ~20km', cat:'road' },
  { name:'Kondagaon Road Jagdalpur',      lat:19.0200, lng:81.9700, icon:'🛣️', info:'Road toward Kondagaon', cat:'road' },
  { name:'Lohandiguda',                   lat:19.0600, lng:81.9200, icon:'🏘️', info:'Lohandiguda Town ~8km', cat:'area' },
  { name:'Mudpar Village',                lat:19.0900, lng:82.0800, icon:'🏘️', info:'Mudpar ~8km east', cat:'area' },
  { name:'Kanger Ghati Check Post',       lat:19.0300, lng:81.9300, icon:'🧳', info:'Kanger Valley Entry Gate ~9km', cat:'tourism' },
  { name:'Tiratgarh Waterfall',           lat:19.1000, lng:81.9600, icon:'💧', info:'Tiratgarh Falls ~15km', cat:'tourism' },
  { name:'Mendri Ghumar Falls',           lat:19.1200, lng:81.9400, icon:'💧', info:'Mendri Ghumar ~12km', cat:'tourism' },
  { name:'Kailash Cave Jagdalpur',        lat:19.0400, lng:81.9500, icon:'🪪', info:'Kailash Cave ~10km', cat:'tourism' },
  { name:'Kutumsar Cave',                 lat:19.0350, lng:81.9400, icon:'🪪', info:'Kutumsar Cave, Kanger ~12km', cat:'tourism' },
  { name:'Bastar College Ground',         lat:19.0820, lng:82.0030, icon:'⚽', info:'Sports Ground, College Area', cat:'area' },
  { name:'New Jagdalpur Township',        lat:19.0900, lng:82.0200, icon:'🏘️', info:'New Township area', cat:'area' },
  { name:'CRPF Camp Jagdalpur',           lat:19.0650, lng:82.0450, icon:'🛡️', info:'CRPF Campus', cat:'govt' },
  { name:'BSF Camp Jagdalpur',            lat:19.0550, lng:82.0500, icon:'🛡️', info:'BSF Campus, Airport area', cat:'govt' },
  { name:'Forest Rest House Kanger',      lat:19.0420, lng:81.9600, icon:'🏡', info:'Forest Rest House', cat:'hotel' },
  { name:'Jagdalpur Stadium',             lat:19.0820, lng:82.0020, icon:'🏟️', info:'Sports Stadium', cat:'area' },
  { name:'River Indravati Bridge',        lat:19.0500, lng:82.0700, icon:'🌉', info:'Indravati River Bridge ~7km', cat:'landmark' },
  { name:'Kanger River Point',            lat:19.0600, lng:81.9700, icon:'🏙️', info:'Kanger River Spot', cat:'tourism' },

  // ══ HOTELS & RESTAURANTS ══
  { name:'Hotel Bastar Residency',       lat:19.0756, lng:82.0162, icon:'🏨', info:'Hotel near City Center', cat:'hotel' },
  { name:'Hotel Panchvati',              lat:19.0758, lng:82.0158, icon:'🏨', info:'Panchvati Hotel Jagdalpur', cat:'hotel' },
  { name:'Hotel Arogya',                 lat:19.0762, lng:82.0148, icon:'🏨', info:'Budget Hotel Jagdalpur', cat:'hotel' },
  { name:'Krishna Hotel',                lat:19.0760, lng:82.0152, icon:'🍽️', info:'Restaurant, Main Road', cat:'hotel' },
  { name:'Bastar Dhaba',                 lat:19.0770, lng:82.0132, icon:'🍽️', info:'Local Dhaba, City Center', cat:'hotel' },
  { name:'Hotel Kanker Palace',          lat:19.0753, lng:82.0165, icon:'🏨', info:'Hotel near Palace', cat:'hotel' },
  { name:'Rajmahal Restaurant',          lat:19.0761, lng:82.0149, icon:'🍽️', info:'Popular Restaurant', cat:'hotel' },

  // ══ FAMOUS AREAS NEAR JAGDALPUR ══
  { name:'Darbha',                       lat:19.1500, lng:81.9000, icon:'🏡', info:'Darbha Town ~30km', cat:'area' },
  { name:'Tokapal',                      lat:19.0000, lng:81.9200, icon:'🏡', info:'Tokapal Area ~20km', cat:'area' },
  { name:'Nagaras',                      lat:19.1000, lng:82.0500, icon:'🏡', info:'Nagaras Village', cat:'area' },
  { name:'Barsur',                       lat:19.1800, lng:81.7500, icon:'🏡', info:'Barsur Historical ~50km', cat:'area' },
  { name:'Kondagaon',                    lat:19.5950, lng:81.6678, icon:'🏡', info:'Kondagaon District ~90km', cat:'area' },
  { name:'Sukma',                        lat:18.3911, lng:81.6600, icon:'🏡', info:'Sukma ~170km', cat:'area' },
  { name:'Bijapur CG',                   lat:18.8000, lng:80.8000, icon:'🏡', info:'Bijapur ~200km', cat:'area' },
  { name:'Narayanpur',                   lat:19.7047, lng:81.2378, icon:'🏡', info:'Narayanpur ~130km', cat:'area' },
  { name:'Kanker',                       lat:20.2737, lng:81.4899, icon:'🏡', info:'Kanker ~100km', cat:'area' },

  // ══ AUTO STANDS & TAXI POINTS ══
  { name:'Auto Stand Gol Bazar',         lat:19.0762, lng:82.0147, icon:'🛺', info:'Auto Rickshaw Stand, Gol Bazar', cat:'transport' },
  { name:'Auto Stand Bus Stand',         lat:19.0800, lng:82.0085, icon:'🛺', info:'Auto Stand near Bus Stand', cat:'transport' },
  { name:'Auto Stand Station',           lat:19.0652, lng:82.0312, icon:'🛺', info:'Auto Stand, Railway Station', cat:'transport' },
  { name:'Taxi Stand Jagdalpur',         lat:19.0762, lng:82.0145, icon:'🚕', info:'Taxi Stand, Main Market', cat:'transport' },

  // ══ POPULAR SHOPS & SERVICES ══
  { name:'Vishal Mega Mart Jagdalpur',   lat:19.0751, lng:82.0167, icon:'🛒', info:'Vishal Mega Mart', cat:'shop' },
  { name:'Medical Store Main Road',      lat:19.0758, lng:82.0157, icon:'💊', info:'Medical & Pharmacy Store', cat:'shop' },
  { name:'Mobile Market Jagdalpur',      lat:19.0760, lng:82.0151, icon:'📱', info:'Mobile Phone Market', cat:'shop' },
  { name:'Furniture Market',             lat:19.0770, lng:82.0135, icon:'🪑', info:'Furniture Bazaar Jagdalpur', cat:'shop' },
  { name:'Hardware Market',              lat:19.0765, lng:82.0140, icon:'🔩', info:'Hardware & Tools Market', cat:'shop' },
  { name:'Ration Depot Jagdalpur',       lat:19.0772, lng:82.0128, icon:'🏪', info:'Fair Price Shop', cat:'shop' },
  { name:'Kirana Store Dharampura',      lat:19.0792, lng:82.0110, icon:'🏪', info:'General Store Dharampura', cat:'shop' },
  { name:'Cold Storage Jagdalpur',       lat:19.0780, lng:82.0105, icon:'❄️', info:'Cold Storage Facility', cat:'shop' },

  // ══ SPORTS & RECREATION ══
  { name:'Football Ground Jagdalpur',    lat:19.0740, lng:82.0195, icon:'⚽', info:'Municipal Football Ground', cat:'sports' },
  { name:'Cricket Ground Jagdalpur',     lat:19.0720, lng:82.0235, icon:'🏏', info:'Cricket Stadium Jagdalpur', cat:'sports' },
  { name:'Indoor Stadium Jagdalpur',     lat:19.0748, lng:82.0180, icon:'🏟️', info:'Indoor Sports Complex', cat:'sports' },
  { name:'Parade Ground',               lat:19.0730, lng:82.0205, icon:'🏟️', info:'Parade Maidan Jagdalpur', cat:'sports' },
  { name:'Bastar Dussehra Ground',      lat:19.0750, lng:82.0170, icon:'🎪', info:'Famous Dussehra Festival Ground', cat:'sports' },

  // ══ WATER BODIES ══
  { name:'Dalpit Sagar Lake',            lat:19.0760, lng:82.0130, icon:'🌊', info:'Dalpit Sagar Talab', cat:'landmark' },
  { name:'Indravati River Ghat',         lat:19.0850, lng:82.0200, icon:'🌊', info:'Indravati River Bank', cat:'landmark' },
  { name:'Murnar River',                 lat:19.0900, lng:82.0100, icon:'🌊', info:'Murnar Nadi Ghat', cat:'landmark' },
];

// Quick lookup by name for autocomplete
const LM_NAMES = JAGDALPUR_LANDMARKS.map(l => l.name.toLowerCase());

// ═══════════════════════════════════════════════════════
// STATE
// ═══════════════════════════════════════════════════════
let CU = null;
let authRole = 'rider';
let selVehType = 'auto';
let isLoaded = false;
let surgeActive = false;

let leafMap = null;
let routePolyline = null;
let zoneCircles = [];
let landmarkMarkers = [];
let landmarksVisible = false;  // ✅ Hidden by default — map clean rahega
let liveDriverMarkers = {};  // driverId → mappls.Marker
let liveDriversListener = null;

let myMarker = null, pickupMk = null, dropMk = null, driverMk = null;
let prevDriverLat = null, prevDriverLng = null;
let driverMarkerInterval = null;

let watchId = null;
let myLat = null, myLng = null;
let pickLat = null, pickLng = null, pickAddr = '';
let dropLat = null, dropLng = null, dropAddr = '';

let fareA = 0, fareM = 0, distKM = 0;
let cabType = 'JDP Auto', cabFare = 0;

let rideDocId = null;
let rideListener = null;
let driverLocListener = null;

let isOnline = false;
let newRideListener = null;
let curReqId = null, curReqData = null;
let navPhase = 'pickup';
let dEarnings = 0, dRides = 0;
let onlineStart = null;
let reqTimer = 60, reqInterval = null;
let onlineTimeInterval = null;

const routeCache = {};

// ═══════════════════════════════════════════════════════
// ✅ AUDIO — Uber-style sounds
// ═══════════════════════════════════════════════════════
let audioCtx = null;
function getACtx() {
  if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
  return audioCtx;
}
function playTone(freq, start, dur, type='sine', vol=0.4) {
  try {
    const ctx = getACtx();
    const o = ctx.createOscillator();
    const g = ctx.createGain();
    o.connect(g); g.connect(ctx.destination);
    o.type = type; o.frequency.setValueAtTime(freq, ctx.currentTime + start);
    g.gain.setValueAtTime(0, ctx.currentTime + start);
    g.gain.linearRampToValueAtTime(vol, ctx.currentTime + start + 0.02);
    g.gain.exponentialRampToValueAtTime(0.001, ctx.currentTime + start + dur);
    o.start(ctx.currentTime + start);
    o.stop(ctx.currentTime + start + dur);
  } catch(e) {}
}
// DRIVER ASSIGNED MUSIC - 30 second loop
let _assignedMusicInterval = null;
let _assignedMusicTimeout = null;
function stopDriverMusic() {
  if (_assignedMusicInterval) { clearInterval(_assignedMusicInterval); _assignedMusicInterval = null; }
  if (_assignedMusicTimeout) { clearTimeout(_assignedMusicTimeout); _assignedMusicTimeout = null; }
}
function playDriverAssigned() {
  stopDriverMusic();
  const melody = [
    [523,  0,    0.12, 'sine', 0.35],
    [659,  0.14, 0.12, 'sine', 0.38],
    [784,  0.28, 0.12, 'sine', 0.40],
    [1047, 0.42, 0.18, 'sine', 0.45],
    [880,  0.62, 0.12, 'sine', 0.40],
    [784,  0.76, 0.12, 'sine', 0.38],
    [659,  0.90, 0.12, 'sine', 0.35],
    [523,  1.04, 0.22, 'sine', 0.30],
    [392,  0,    0.12, 'sine', 0.18],
    [494,  0.14, 0.12, 'sine', 0.18],
    [587,  0.28, 0.12, 'sine', 0.20],
    [784,  0.42, 0.18, 'sine', 0.22],
  ];
  function playOnce() {
    try {
      melody.forEach(([freq, start, dur, type, vol]) => playTone(freq, start, dur, type, vol));
      playTone(80,   0,    0.08, 'sine', 0.5);
      playTone(80,   0.42, 0.08, 'sine', 0.5);
      playTone(80,   0.84, 0.08, 'sine', 0.4);
      playTone(2093, 0.42, 0.3,  'sine', 0.15);
    } catch(e) {}
  }
  playOnce();
  _assignedMusicInterval = setInterval(playOnce, 1400);
  _assignedMusicTimeout  = setTimeout(stopDriverMusic, 30000);
}

// ===================================================
// ⚡ LIVE FARE METER — Uber/Ola style running fare counter
// Shows real-time fare deduction during ongoing ride
// ===================================================
let _liveMeterInterval = null;
let _liveMeterStartFare = 0;
let _liveMeterStartKm = 0;
let _liveMeterStartTime = 0;
const RATE_PER_KM_AUTO = 12;  // Rs per km for Auto
const RATE_PER_KM_CAB  = 16;  // Rs per km for Mini Cab
const RATE_PER_MIN     = 0.5; // Rs per minute waiting charge
const BASE_FARE_AUTO   = 20;  // Rs base fare Auto
const BASE_FARE_CAB    = 40;  // Rs base fare Cab

function startLiveFareMeter(baseFare, cabTypeStr) {
  stopLiveFareMeter();
  _liveMeterStartFare = baseFare || 25;
  _liveMeterStartKm   = distKM || 1;
  _liveMeterStartTime = Date.now();
  const rateKm = (cabTypeStr && cabTypeStr.toLowerCase().includes('mini')) ? RATE_PER_KM_CAB : RATE_PER_KM_AUTO;

  // Show meter UI
  const meterEl = document.getElementById('liveFareMeter');
  if (meterEl) meterEl.style.display = 'block';

  let elapsed = 0;
  _liveMeterInterval = setInterval(() => {
    elapsed = (Date.now() - _liveMeterStartTime) / 1000; // seconds
    const elapsedMin = elapsed / 60;
    // Simulate fare increase: base + per km portion + time charge
    const extraKmCharge = Math.max(0, (myLat && pickLat) ?
      Math.max(0, distKmCalc(myLat, myLng, dropLat || JDPC.lat, dropLng || JDPC.lng) - _liveMeterStartKm * 0.3) * rateKm : 0);
    const timeCharge = elapsedMin * RATE_PER_MIN;
    const currentFare = Math.round(_liveMeterStartFare + extraKmCharge + timeCharge);

    // Update display
    const fareDispEl = document.getElementById('liveFareAmount');
    const fareTimeEl = document.getElementById('liveFareTime');
    const fareBarEl  = document.getElementById('liveFareBar');
    if (fareDispEl) fareDispEl.textContent = '₹' + currentFare;
    if (fareTimeEl) fareTimeEl.textContent = Math.floor(elapsedMin) + ' min ' + Math.floor(elapsed % 60) + 's';
    if (fareBarEl) {
      const pct = Math.min(100, (currentFare / (_liveMeterStartFare * 1.6)) * 100);
      fareBarEl.style.width = pct + '%';
      fareBarEl.style.background = pct > 85 ? '#ef4444' : pct > 60 ? '#f59e0b' : '#10b981';
    }
  }, 1000);
}

function stopLiveFareMeter() {
  if (_liveMeterInterval) { clearInterval(_liveMeterInterval); _liveMeterInterval = null; }
  const meterEl = document.getElementById('liveFareMeter');
  if (meterEl) meterEl.style.display = 'none';
}

function playNewRide() {
  // Urgent ding-ding-ding for driver
  playTone(880, 0,   0.12, 'triangle', 0.4);
  playTone(880, 0.16,0.12, 'triangle', 0.4);
  playTone(1100,0.32,0.18, 'triangle', 0.45);
  playTone(1100,0.52,0.22, 'triangle', 0.45);
}
function playSurge() {
  playTone(400, 0, 0.08, 'sawtooth', 0.2);
  playTone(500, 0.1, 0.12, 'sawtooth', 0.25);
}

// ═══════════════════════════════════════════════════════
// LOADER
// ═══════════════════════════════════════════════════════
let lp = 0;
const lpInt = setInterval(() => { if(lp<85){lp+=12;document.getElementById('ldBar').style.width=lp+'%';} }, 200);
function finishLoad() {
  if (isLoaded) return; isLoaded = true;
  clearInterval(lpInt);
  document.getElementById('ldBar').style.width = '100%';
  safeText('ldStatus','Ready! 🚖 Jagdalpur');
  setTimeout(() => {
    document.getElementById('loader').style.display = 'none';
    if (!CU) document.getElementById('auth').style.display = 'flex';
    initMap();
  }, 350);
}
let fbWait = 0;
const fbWI = setInterval(function() {
  fbWait++;
  if (window.FB_READY !== undefined || fbWait > 25) {
    clearInterval(fbWI);
    finishLoad();
  }
}, 140);
// Hard timeout — always show app within 4 seconds regardless
setTimeout(finishLoad, 4000);
// Catch any remaining unhandled errors globally
// useCapture=true also fires for resource load failures (IMG/SCRIPT 404 etc.)
// We filter those out and handle real JS errors quietly
window.addEventListener('error', function(e) {
  // Resource load error (img, script src, link href fail) — silent, not a crash
  if (e.target && e.target !== window &&
      e.target.nodeName && ['IMG','SCRIPT','LINK','SOURCE'].indexOf(e.target.nodeName) >= 0) {
    return true; // ignore — external resource failed (network/API key issue)
  }
  // Real JS exception — log quietly without alarming user
  if (e && e.message) {
    console.log('[JDP] Caught & handled:', e.message);
  }
  return true; // always prevent white-screen
}, true);

window.addEventListener('offline', () => document.getElementById('netB').style.display = 'block');
window.addEventListener('online', () => { document.getElementById('netB').style.display = 'none'; toast('🌐 Back online!'); });

// ═══════════════════════════════════════════════════════
// ✅ MAPPLS REAL-TIME NAVIGATION ENGINE
// Turn-by-turn, speed, ETA, voice — like screenshot
// ═══════════════════════════════════════════════════════
let NAV = {
  active: false,
  steps: [],           // turn-by-turn steps
  currentStep: 0,
  destLat: null, destLng: null,
  destName: '',
  watchId: null,       // separate GPS watch for nav
  voiceEnabled: true,
  lastSpoken: '',
  lastSpeakTime: 0,
  routeMarker: null,
  navPolyline: null,
  totalDist: 0,
  totalTime: 0,
  recenterEnabled: true,
  mapHeading: 0,
};

// Direction arrow mapping — maneuver type to emoji
const MANEUVER_ICONS = {
  'turn-left':          '⬅️',
  'turn-right':         '➡️',
  'turn-sharp-left':    '↙️',
  'turn-sharp-right':   '↘️',
  'turn-slight-left':   '↖️',
  'turn-slight-right':  '↗️',
  'straight':           '⬆️',
  'roundabout':         '🔄',
  'rotary':             '🔄',
  'merge':              '🔀',
  'fork-left':          '↖️',
  'fork-right':         '↗️',
  'ramp-left':          '↖️',
  'ramp-right':         '↗️',
  'uturn':              '↩️',
  'arrive':             '🏁',
  'depart':             '🚀',
  'default':            '⬆️',
};

function getManeuverIcon(maneuver) {
  if (!maneuver) return '⬆️';
  const type = (maneuver.type || '') + (maneuver.modifier ? '-' + maneuver.modifier : '');
  return MANEUVER_ICONS[type] || MANEUVER_ICONS[maneuver.type] || MANEUVER_ICONS.default;
}

function getManeuverText(maneuver, name) {
  if (!maneuver) return name ? 'Continue on ' + name : 'Continue straight';
  const street = name ? ' on ' + name : '';
  const mod = maneuver.modifier || '';
  switch(maneuver.type) {
    case 'turn':
      if (mod === 'left')        return 'Turn left' + street;
      if (mod === 'right')       return 'Turn right' + street;
      if (mod === 'sharp left')  return 'Sharp left' + street;
      if (mod === 'sharp right') return 'Sharp right' + street;
      if (mod === 'slight left') return 'Slight left' + street;
      if (mod === 'slight right')return 'Slight right' + street;
      return 'Turn' + street;
    case 'new name':    return 'Continue' + street;
    case 'depart':      return 'Start' + street;
    case 'arrive':      return '🏁 You have arrived' + (name ? ' at ' + name : '');
    case 'merge':       return 'Merge' + street;
    case 'roundabout':  return 'Enter roundabout' + street;
    case 'rotary':      return 'Enter roundabout' + street;
    case 'fork':        return (mod.includes('left') ? 'Keep left' : 'Keep right') + street;
    case 'end of road': return (mod.includes('left') ? 'Turn left' : 'Turn right') + street;
    case 'continue':    return 'Continue straight' + street;
    case 'uturn':       return 'Make U-turn' + street;
    default:            return 'Continue' + (street || ' straight');
  }
}

function formatDist(meters) {
  if (meters < 950) return { val: Math.round(meters / 10) * 10, unit: 'm' };
  return { val: (meters / 1000).toFixed(1), unit: 'km' };
}

function formatTime(seconds) {
  if (seconds < 60) return '< 1 min';
  const m = Math.round(seconds / 60);
  if (m < 60) return m + ' min';
  const h = Math.floor(m / 60), rm = m % 60;
  return h + 'h ' + (rm > 0 ? rm + 'm' : '');
}

// ✅ Start Navigation — main entry point
async function startNavigation(destLat, destLng, destName) {
  if (!myLat || !myLng) {
    toast('📍 GPS location chahiye — wait karo'); return;
  }

  NAV.active = true;
  NAV.destLat = destLat;
  NAV.destLng = destLng;
  NAV.destName = destName || 'Destination';
  NAV.currentStep = 0;
  NAV.voiceEnabled = true;

  // Show nav UI
  safeShow('navBar');
  safeShow('navSpeed','flex');
  safeShow('navRecenter','flex');
  safeShow('voiceIndicator','flex');
  safeShow('navETA');
  safeText('navInstruction','Calculating route...');
  safeText('navArrow','⌛');

  // Hide booking sheet during navigation
  safeHide('rSheet');
  safeHide('mapFade');

  toast('🗺️ Navigation started!');

  // Get detailed route with steps
  await fetchNavRoute(myLat, myLng, destLat, destLng);

  // Start GPS watch for navigation
  startNavGPS();

  // Tilt map for navigation (3D-ish feel)
  if (leafMap) {
    if(leafMap) if(leafMap) leafMap.flyTo([myLat, myLng], 16);
  }
}

// ✅ Fetch route with full step-by-step from Mappls/OSRM
async function fetchNavRoute(fLat, fLng, tLat, tLng) {
  try {
    // Try Mappls route_adv with steps
    let r = await fetch(
      `https://apis.mappls.com/advancedmaps/v1/${window.MAPPLS_KEY}/route_adv/driving/${fLng},${fLat};${tLng},${tLat}?steps=true&geometries=geojson&overview=full&annotations=true&region=IND`
    );
    if (!r.ok) throw new Error('Mappls failed');
    const d = await r.json();
    if (d?.routes?.[0]) {
      const route = d.routes[0];
      NAV.totalDist = route.distance;
      NAV.totalTime = route.duration;
      // Extract steps from all legs
      NAV.steps = [];
      (route.legs || []).forEach(leg => {
        (leg.steps || []).forEach(step => NAV.steps.push(step));
      });
      if (NAV.steps.length > 0) {
        drawNavRoute(route.geometry);
        updateNavUI();
        buildStepList();
        return;
      }
    }
  } catch(e) {}

  // Fallback: OSRM with steps
  try {
    const r = await fetch(
      `https://router.project-osrm.org/route/v1/driving/${fLng},${fLat};${tLng},${tLat}?steps=true&geometries=geojson&overview=full`
    );
    const d = await r.json();
    if (d?.routes?.[0]) {
      const route = d.routes[0];
      NAV.totalDist = route.distance;
      NAV.totalTime = route.duration;
      NAV.steps = [];
      (route.legs || []).forEach(leg => {
        (leg.steps || []).forEach(step => NAV.steps.push(step));
      });
      drawNavRoute(route.geometry);
      updateNavUI();
      buildStepList();
    }
  } catch(e) {
    safeText('navInstruction','Route unavailable');
  }
}

// ✅ Draw navigation route on map (green line like Mappls screenshot)
function drawNavRoute(geometry) {
  if (NAV.navPolyline) {
    try { if (NAV.navPolyline.setMap) NAV.navPolyline.setMap(null); } catch(e){}
  }
  if (!geometry?.coordinates || !leafMap) return;
  const path = geometry.coordinates.map(c => ({ lat: c[1], lng: c[0] }));
  NAV.navPolyline = new mappls.Polyline({
    map: leafMap,
    path: path,
    strokeColor: '#00C853',  // Mappls green route
    strokeWeight: 7,
    strokeOpacity: 0.92,
    lineJoin: 'round',
    lineCap: 'round'
  });
}

// ✅ Update the navigation bar UI with current step
function updateNavUI() {
  if (!NAV.active || NAV.steps.length === 0) return;
  const step = NAV.steps[NAV.currentStep];
  if (!step) { 
    safeText('navInstruction','🏁 Arrived!');
    return;
  }

  const maneuver = step.maneuver;
  const name = step.name || step.ref || '';
  const distM = step.distance || 0;

  // Update arrow
  const icon = getManeuverIcon(maneuver);
  safeText('navArrow',icon);

  // Update distance
  const dist = formatDist(distM);
  safeText('navDist',dist.val);
  safeText('navDistUnit',dist.unit);

  // Update instruction
  const text = getManeuverText(maneuver, name);
  safeText('navInstruction',text);

  // Update next step
  const nextStep = NAV.steps[NAV.currentStep + 1];
  if (nextStep) {
    safeText('navNextArrow',getManeuverIcon(nextStep.maneuver));
    const nd = formatDist(nextStep.distance || 0);
    safeText('navNextDist',nd.val + ' ' + nd.unit);
    document.getElementById('navNextWrap').style.display = 'flex';
  } else {
    document.getElementById('navNextWrap').style.display = 'none';
  }

  // ETA panel
  const remDist = NAV.steps.slice(NAV.currentStep).reduce((s,st)=>s+(st.distance||0),0);
  const remTime = NAV.steps.slice(NAV.currentStep).reduce((s,st)=>s+(st.duration||0),0);
  const etaDist = formatDist(remDist);
  safeText('etaDist',etaDist.val + ' ' + etaDist.unit);
  safeText('etaTime',formatTime(remTime));
  const arrival = new Date(Date.now() + remTime * 1000);
  safeText('etaArrival','Arrival: ' + arrival.toLocaleTimeString('en-IN',{hour:'2-digit',minute:'2-digit'}));

  // Voice guidance
  speakInstruction(text, distM);
}

// ✅ Build step list panel
function buildStepList() {
  const body = document.getElementById('stepListBody');
  const summary = document.getElementById('slSummary');
  if (!NAV.steps.length) return;

  const totDist = formatDist(NAV.totalDist);
  const totTime = formatTime(NAV.totalTime);
  summary.textContent = totDist.val + totDist.unit + ' · ' + totTime + ' · ' + NAV.destName;

  body.innerHTML = NAV.steps.map((step, i) => {
    const icon = getManeuverIcon(step.maneuver);
    const text = getManeuverText(step.maneuver, step.name);
    const d = formatDist(step.distance || 0);
    const active = i === NAV.currentStep ? ' active' : '';
    return '<div class="step-item' + active + '">' +
      '<div class="step-icon">' + icon + '</div>' +
      '<div style="flex:1">' +
        '<div style="font-size:.83rem;font-weight:700">' + text + '</div>' +
        (step.name ? '<div class="step-dist">' + step.name + '</div>' : '') +
      '</div>' +
      '<div style="font-size:.72rem;color:var(--muted);font-weight:700;flex-shrink:0">' + d.val + d.unit + '</div>' +
    '</div>';
  }).join('');
}

// ✅ Voice Navigation using Web Speech API
function speakInstruction(text, distM) {
  if (!NAV.voiceEnabled || !window.speechSynthesis) return;
  if (text === NAV.lastSpoken && Date.now() - NAV.lastSpeakTime < 15000) return;
  if (distM > 500) return; // Only speak when within 500m of turn
  NAV.lastSpoken = text;
  NAV.lastSpeakTime = Date.now();

  const utter = new SpeechSynthesisUtterance(text);
  utter.lang = 'hi-IN'; // Hindi voice for Jagdalpur
  utter.rate = 0.95;
  utter.volume = 1;
  const vi = document.getElementById('voiceIndicator');
  utter.onstart = () => { if (vi) vi.classList.add('speaking'); };
  utter.onend = () => { if (vi) vi.classList.remove('speaking'); };
  window.speechSynthesis.cancel();
  window.speechSynthesis.speak(utter);
}

function toggleVoice() {
  NAV.voiceEnabled = !NAV.voiceEnabled;
  const btn = document.getElementById('voiceIndicator');
  if (btn) btn.textContent = NAV.voiceEnabled ? '🔊' : '🔇';
  toast(NAV.voiceEnabled ? '🔊 Voice on' : '🔇 Voice off');
}

// ✅ GPS Watch for navigation — updates position + step detection
function startNavGPS() {
  if (NAV.watchId) navigator.geolocation.clearWatch(NAV.watchId);
  NAV.watchId = navigator.geolocation.watchPosition(pos => {
    if (!NAV.active) return;
    const lat = pos.coords.latitude;
    const lng = pos.coords.longitude;
    const speed = pos.coords.speed || 0;
    const heading = pos.coords.heading || 0;

    // Update speed display
    const kmh = Math.round(speed * 3.6);
    const spdEl = document.getElementById('spdVal');
    if (spdEl) spdEl.textContent = kmh;

    // Highlight speed limit exceeded (basic)
    const speedBox = document.getElementById('navSpeed');
    if (speedBox) speedBox.style.borderColor = kmh > 60 ? 'var(--red)' : 'rgba(255,255,255,.15)';

    // Recenter map on user (if recenter enabled)
    if (NAV.recenterEnabled && leafMap) {
      if(leafMap) leafMap.setCenter([lat, lng]);
    }

    // Check if we passed the current step waypoint
    if (NAV.steps[NAV.currentStep]) {
      const step = NAV.steps[NAV.currentStep];
      const manLat = step.maneuver?.location?.[1] || null;
      const manLng = step.maneuver?.location?.[0] || null;
      if (manLat && manLng) {
        const dist = distKmCalc(lat, lng, manLat, manLng) * 1000;
        if (dist < 30 && NAV.currentStep < NAV.steps.length - 1) {
          // ✅ Passed waypoint — advance to next step
          NAV.currentStep++;
          updateNavUI();
          buildStepList();
          // Flash nav bar for turn
          document.getElementById('navBar').style.transform = 'scale(1.01)';
          setTimeout(() => { document.getElementById('navBar').style.transform = ''; }, 300);
        }
        // Update distance to next turn
        const d = formatDist(dist);
        safeText('navDist',d.val);
        safeText('navDistUnit',d.unit);
      }
    }

    // Check arrival
    if (NAV.destLat && NAV.destLng) {
      const distToDest = distKmCalc(lat, lng, NAV.destLat, NAV.destLng) * 1000;
      if (distToDest < 50) {
        arrivedAtDest();
      }
    }
  }, err => {}, { enableHighAccuracy: true, maximumAge: 1000, timeout: 5000 });
}

// ✅ Arrived at destination
function arrivedAtDest() {
  if (!NAV.active) return;
  speakInstruction('You have arrived at ' + NAV.destName, 0);
  NAV.lastSpoken = ''; // force speak
  safeText('navInstruction','🏁 You have arrived!');
  safeText('navArrow','🏁');
  safeText('navDist','0');
  safeText('etaTime','0 min');
  toast('🏁 Destination par pahunch gaye!');
  setTimeout(stopNavigation, 4000);
}

// ✅ Stop Navigation

// ✅ Quick navigate — direct nav without booking a ride
async function quickNavigate() {
  const drop = document.getElementById('dropIn').value.trim();
  if (!drop) { toast('📍 Drop location likho pehle'); document.getElementById('dropIn').focus(); return; }
  if (!myLat) { toast('📍 GPS location wait karo'); return; }

  // Use pre-selected or geocode
  let coords = null;
  if (window._preSelectedDrop && window._selectedDropName === drop) {
    coords = window._preSelectedDrop;
  } else {
    coords = await geocodeAddress(drop);
  }
  if (!coords) { toast('❌ Location nahi mili — aur specific likho'); return; }

  startNavigation(coords.lat, coords.lng, drop);
}

function stopNavigation() {
  NAV.active = false;
  if (NAV.watchId) { navigator.geolocation.clearWatch(NAV.watchId); NAV.watchId = null; }
  if (NAV.navPolyline) { try { NAV.navPolyline.setMap(null); } catch(e){} NAV.navPolyline = null; }
  window.speechSynthesis && window.speechSynthesis.cancel();

  // Hide nav UI
  ['navBar','navSpeed','navRecenter','voiceIndicator','navETA','navStepList'].forEach(id => {
    const el = document.getElementById(id);
    if (el) el.style.display = 'none';
  });

  // Restore booking sheet
  safeShow('rSheet');
  safeShow('mapFade');
  if (leafMap) if(leafMap) leafMap.setZoom(14);
  toast('Navigation stopped');
}

function navRecenter() {
  NAV.recenterEnabled = true;
  if (leafMap && myLat) if(leafMap) if(leafMap) leafMap.flyTo([myLat, myLng], 16);
}

function toggleStepList() {
  const panel = document.getElementById('navStepList');
  panel.style.display = panel.style.display === 'flex' ? 'none' : 'flex';
}

// ═══════════════════════════════════════════════════════
// ✅ MAP — Full Mappls v3 SDK (India Vector Maps, Uber-level)
// ═══════════════════════════════════════════════════════

// ✅ Network quality check — degrade gracefully for slow connections

// ✅ Safe Firebase wrapper with retry — handles 50K concurrent users
async function fbSafe(operation, retries=2) {
  for (let i=0; i<=retries; i++) {
    try {
      return await operation();
    } catch(e) {
      if (i === retries) {
        console.warn('[JDP] Firebase op failed after retries:', e.code || e.message);
        return null;
      }
      // Exponential backoff: 500ms, 1000ms
      await new Promise(r => setTimeout(r, 500 * Math.pow(2, i)));
    }
  }
}

function checkNetworkQuality() {
  const conn = navigator.connection || navigator.mozConnection || navigator.webkitConnection;
  if (conn) {
    const slow = conn.effectiveType === '2g' || conn.effectiveType === 'slow-2g' || conn.saveData;
    if (slow) {
      window.LOW_BANDWIDTH = true;
      // Disable landmark markers on slow connections
      landmarksVisible = false;
      console.log('[JDP] Low bandwidth detected — reduced mode');
    }
  }
}

function initMap() {
  if (typeof mappls === 'undefined') {
    window._mapRetry = (window._mapRetry||0)+1;
    if(window._mapRetry > 30) { console.warn('[JDP] Map SDK failed to load'); return; }
    setTimeout(initMap, 400);
    return;
  }
  try {
    // ✅ Mappls v3 — India's most powerful vector map
    leafMap = new mappls.Map('map', {
      center: { lat: JDPC.lat, lng: JDPC.lng },
      zoom: 13,          // Zoom 13 = shows full Jagdalpur 15km service zone
      minZoom: 11,
      maxZoom: 19,
      zoomControl: false,
      clickableIcons: true,
      fullscreenControl: false,
      search: false,
      indoor: false,
      traffic: true,     // Live traffic layer — Mappls India data
    });

    // ✅ On full load — draw city markers & auto-detect GPS
    leafMap.on('load', function() {
      safeText('ldStatus','✅ Jagdalpur map loaded');
      safeShow('mapStats');

      // ✅ AUTO GPS on map load (even before login)
      if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(function(pos) {
          myLat = pos.coords.latitude;
          myLng = pos.coords.longitude;
          pickLat = myLat; pickLng = myLng;
          if(myLat && myLng) requestAnimationFrame(() => updateMyMarker(myLat, myLng));
          updateMyZone();
          if(leafMap) if(leafMap) leafMap.flyTo([myLat, myLng], 16);
          revGeo(myLat, myLng).then(function(addr) {
            pickAddr = addr;
            const pAddrEl = document.getElementById('pAddr');
            const pSubEl = document.getElementById('pSub');
            if (pAddrEl) pAddrEl.textContent = addr;
            if (pSubEl) pSubEl.innerHTML = '<span style="color:var(--green);font-size:.66rem">📍 GPS Live · Auto Detected</span>';
          }).catch(function(){}).catch(function(){});
        }, function() {}, { enableHighAccuracy: true, timeout: 10000, maximumAge: 3000 });
      }

      // ✅ Lazy-load city zones and landmarks
      setTimeout(() => {
        drawCityZones();
        addLandmarkMarkers();
      }, 500);
    });

    // Fallback for maps that don't fire 'load'
    setTimeout(() => {
      if (!document.getElementById('mapStats').style.display || 
          document.getElementById('mapStats').style.display === 'none') {
        safeText('ldStatus','✅ Jagdalpur map loaded');
        safeShow('mapStats');
        drawCityZones();
        addLandmarkMarkers();
      }
    }, 3000);

  } catch(e) { console.error('[JDP] Map init error:', e); setTimeout(initMap, 1000); }
}

// ✅ Uber-style smooth zoom functions
function zoomIn()  { if(leafMap) leafMap.zoomIn(1,  {animate:true}); }
function zoomOut() { if(leafMap) leafMap.zoomOut(1, {animate:true}); }

// ═══════════════════════════════════════════════════════
// ✅ MAPPLS SATELLITE MAP TOGGLE — like Google Maps
// ═══════════════════════════════════════════════════════
let mapStyleMode = 'standard'; // 'standard' | 'satellite'
function toggleMapStyle() {
  if (!leafMap) return;
  mapStyleMode = mapStyleMode === 'standard' ? 'satellite' : 'standard';
  try {
    // Mappls v3 setMapStyle API
    if (typeof leafMap.setMapStyle === 'function') {
      leafMap.setMapStyle(mapStyleMode === 'satellite' ? 'mappls_grey' : 'standard');
    }
    // Mappls v3 alternate method
    if (typeof mappls.MapType !== 'undefined') {
      leafMap.setMapTypeId(mapStyleMode === 'satellite' ? mappls.MapType.HYBRID : mappls.MapType.ROADMAP);
    }
    // Mappls layer-based method
    if (typeof leafMap.setHybridLayer === 'function') {
      if (mapStyleMode === 'satellite') leafMap.setHybridLayer();
      else leafMap.removeHybridLayer();
    }
  } catch(e) {}
  const icon = document.getElementById('mapStyleIcon');
  const txt = document.getElementById('mapStyleTxt');
  const btn = document.getElementById('mapStyleBtn');
  if (mapStyleMode === 'satellite') {
    if(icon) icon.textContent = '🗺️';
    if(txt) txt.textContent = 'Map';
    if(btn) { btn.textContent = '🗺️'; btn.title = 'Standard Map'; }
    toast('🛰️ Satellite view');
  } else {
    if(icon) icon.textContent = '🛰️';
    if(txt) txt.textContent = 'Satellite';
    if(btn) { btn.textContent = '🛰️'; btn.title = 'Satellite View'; }
    toast('🗺️ Standard map');
  }
}

// ═══════════════════════════════════════════════════════
// ✅ LIVE KM DISTANCE — Updates every 5s during active ride
// Shows real distance from driver to pickup/drop in real-time
// ═══════════════════════════════════════════════════════
let liveDistInterval = null;

function startLiveDistanceTracking() {
  stopLiveDistanceTracking();
  const chip = document.getElementById('liveDistChip');
  if (chip) chip.style.display = 'flex';

  liveDistInterval = setInterval(() => {
    if (!myLat || !myLng) return;
    // If we have a drop location, show distance pickup → drop
    if (pickLat && dropLat) {
      const d = distKmCalc(myLat, myLng, dropLat, dropLng);
      updateLiveDistChip(d);
    } else if (pickLat && pickLng) {
      const d = distKmCalc(myLat, myLng, pickLat, pickLng);
      updateLiveDistChip(d);
    }
  }, 4000);
}

function stopLiveDistanceTracking() {
  if (liveDistInterval) { clearInterval(liveDistInterval); liveDistInterval = null; }
  const chip = document.getElementById('liveDistChip');
  if (chip) chip.style.display = 'none';
}

function updateLiveDistChip(distKm) {
  const el1 = document.getElementById('liveDistText');
  const el2 = document.getElementById('liveDistChipText');
  const txt = distKm < 1 ? Math.round(distKm * 1000) + ' m' : distKm.toFixed(1) + ' km';
  if (el1) el1.textContent = txt;
  if (el2) el2.textContent = txt;
}

// ═══════════════════════════════════════════════════════
// ✅ JAGDALPUR CITY ZONES — 3 concentric circles
// Like Uber surge zones but for Jagdalpur
// ═══════════════════════════════════════════════════════
function drawCityZones() {
  if (!leafMap) return;
  clearZones();
  try {

  // Outer service area — 15km (subtle dashed ring like Apple Maps)
  const outerZone = new mappls.Circle({
    map: leafMap,
    center: { lat: JDPC.lat, lng: JDPC.lng },
    radius: ZONE_OUTER * 1000,
    strokeColor: '#f59e0b', strokeWeight: 2, strokeOpacity: 0.45,
    fillColor: '#f59e0b', fillOpacity: 0.04
  });

  // City main zone — 8km (blue, main service)
  const cityZone = new mappls.Circle({
    map: leafMap,
    center: { lat: JDPC.lat, lng: JDPC.lng },
    radius: ZONE_CITY * 1000,
    strokeColor: '#3b82f6', strokeWeight: 2.5, strokeOpacity: 0.6,
    fillColor: '#3b82f6', fillOpacity: 0.05
  });

  // City core — 3km (green, fastest pickup zone)
  try { const coreZone = new mappls.Circle({
    map: leafMap,
    center: { lat: JDPC.lat, lng: JDPC.lng },
    radius: ZONE_CORE * 1000,
    strokeColor: '#10b981', strokeWeight: 3, strokeOpacity: 0.7,
    fillColor: '#10b981', fillOpacity: 0.08
  }); } catch(e) {}

  // Center dot — Jagdalpur hub marker
  try { const centerMark = new mappls.Marker({
    map: leafMap,
    position: { lat: JDPC.lat, lng: JDPC.lng },
    html: `<div style="background:rgba(245,158,11,.85);border:2.5px solid white;
      width:12px;height:12px;border-radius:50%;
      box-shadow:0 0 18px rgba(245,158,11,1);
      transform:translate(-6px,-6px)"></div>`,
    popupHtml: '<b>📍 Jagdalpur City Center</b><br><small>JDP Cabs Service Hub</small>'
  }); } catch(e) {}

  zoneCircles = [outerZone, cityZone, coreZone, centerMark];
  // Zone legend removed
  } catch(e) { console.warn('[JDP] Zone draw error:', e); }
}
function clearZones() {
  zoneCircles.forEach(c => {
    try {
      if (c && typeof c.setMap === 'function') c.setMap(null);
      else if (c && typeof c.remove === 'function') c.remove();
    } catch(e){}
  });
  zoneCircles = [];
}

let zonesVisible = true;
function toggleZone() {
  zonesVisible = !zonesVisible;
  if (zonesVisible) {
    drawCityZones();
    toast('📡 Jagdalpur zones shown');
  } else {
    clearZones();
    toast('📡 Zones hidden');
  }
}

// ═══════════════════════════════════════════════════════
// ✅ LANDMARK MARKERS — Zoom-based lazy loading (Smooth!)
// Only show markers when zoomed in enough (zoom ≥ 13)
// Only render markers visible in current viewport
// ═══════════════════════════════════════════════════════
let landmarkRenderTimer = null;

function addLandmarkMarkers() {
  // ✅ Don't render all 160 at once — listen to zoom & moveend
  if (!leafMap) return;
  leafMap.on('zoomend moveend', function() {
    clearTimeout(landmarkRenderTimer);
    landmarkRenderTimer = setTimeout(renderVisibleLandmarks, 200); // 200ms debounce
  });
  // Initial render
  setTimeout(renderVisibleLandmarks, 500);
}

function renderVisibleLandmarks() {
  if (!leafMap || !landmarksVisible) return;
  try {
  const zoom = (leafMap && leafMap.getZoom) ? leafMap.getZoom() : 14;
  
  // ✅ Below zoom 13 — hide all landmark markers to keep map fast
  if (zoom < 13) {
    landmarkMarkers.forEach(mk => {
      try { if (typeof mk.setMap === 'function') mk.setMap(null); } catch(e){}
    });
    return;
  }

  // ✅ Get current map bounds
  let bounds = null;
  try { bounds = leafMap.getBounds(); } catch(e){}

  // ✅ Only show markers in current viewport + small buffer
  JAGDALPUR_LANDMARKS.forEach((place, i) => {
    const inView = !bounds || (
      place.lat >= (bounds._southWest?.lat || bounds.getSouthWest().lat) - 0.01 &&
      place.lat <= (bounds._northEast?.lat || bounds.getNorthEast().lat) + 0.01 &&
      place.lng >= (bounds._southWest?.lng || bounds.getSouthWest().lng) - 0.01 &&
      place.lng <= (bounds._northEast?.lng || bounds.getNorthEast().lng) + 0.01
    );

    const existingMk = landmarkMarkers[i];

    if (inView) {
      if (!existingMk) {
        // Create marker only when needed
        const mk = new mappls.Marker({
          map: leafMap,
          position: { lat: place.lat, lng: place.lng },
          html: (() => {
            const catColors = {
              hospital:'#ef4444', education:'#3b82f6', temple:'#f59e0b',
              transport:'#8b5cf6', market:'#10b981', govt:'#6366f1',
              hotel:'#f97316', bank:'#0ea5e9', fuel:'#84cc16',
              tourism:'#ec4899', area:'#64748b', road:'#94a3b8'
            };
            const c = catColors[place.cat] || '#f59e0b';
            return `<div style="display:flex;flex-direction:column;align-items:center;transform:translate(-12px,-38px)">
              <div style="background:white;border:2.5px solid ${c};border-radius:12px;width:28px;height:28px;display:flex;align-items:center;justify-content:center;font-size:14px;box-shadow:0 4px 12px rgba(0,0,0,.25);position:relative;">
                ${place.icon}
                <div style="position:absolute;bottom:-7px;left:50%;transform:translateX(-50%);width:0;height:0;border-left:5px solid transparent;border-right:5px solid transparent;border-top:7px solid ${c}"></div>
              </div>
              <div style="background:white;color:#0c1929;font-size:9px;font-weight:800;padding:2px 5px;border-radius:5px;margin-top:3px;white-space:nowrap;box-shadow:0 2px 6px rgba(0,0,0,.15);max-width:70px;overflow:hidden;text-overflow:ellipsis">${place.name.split(' ')[0]}</div>
            </div>`;
          })(),
          popupHtml: ('<b>'+place.icon+' '+place.name+'</b><br><small style="color:#aaa">'+place.info+'</small><br><button onclick="setDropFromMap('+place.lat+','+place.lng+',\''+place.name.replace(/'/g,'').replace(/"/g,'')+'\');" style="background:#f59e0b;border:none;color:#000;padding:4px 10px;border-radius:6px;font-size:.72rem;font-weight:800;margin-top:6px;cursor:pointer;width:100%">🚗 Drop Point Set</button>')
        });
        landmarkMarkers[i] = mk;
      } else {
        try { if (typeof existingMk.setMap === 'function') existingMk.setMap(leafMap); } catch(e){}
      }
    } else if (existingMk) {
      // Hide out-of-view markers to free GPU
      try { if (typeof existingMk.setMap === 'function') existingMk.setMap(null); } catch(e){}
    }
  });
  } catch(e) {}
}
function toggleLandmarks() {
  landmarksVisible = !landmarksVisible;
  if (landmarksVisible) {
    renderVisibleLandmarks();
  } else {
    landmarkMarkers.forEach(mk => {
      if (!mk) return;
      try { if (typeof mk.setMap === 'function') mk.setMap(null); } catch(e){}
    });
  }
  toast(landmarksVisible ? '📍 Jagdalpur landmarks shown' : '📍 Landmarks hidden');
}

// ═══════════════════════════════════════════════════════
// ✅ LIVE DRIVER DOTS ON MAP — All online drivers visible
// ═══════════════════════════════════════════════════════
function startLiveDriverWatch() {
  if (!window.FB_READY) return;
  if (liveDriversListener) { liveDriversListener(); }

  const q = window.FB.query(
    window.FB.collection(window.FB.db, 'users'),
    window.FB.where('role','==','driver'),
    window.FB.where('isOnline','==',true)
  );

  liveDriversListener = window.FB.onSnapshot(q, { includeMetadataChanges: false }, (snap) => {
    // ✅ Batch all marker updates in one rAF to prevent jank
    requestAnimationFrame(() => {
    const onlineIds = new Set();
    let totalDrivers = 0;
    let in3km = 0, in8km = 0, in15km = 0;

    snap.forEach(docSnap => {
      const d = docSnap.data();
      const id = docSnap.id;
      if (!d.lat || !d.lng) return;
      if (CU && id === CU.uid) return; // Don't show own marker

      onlineIds.add(id);
      totalDrivers++;

      const dist = distKmCalc(JDPC.lat, JDPC.lng, d.lat, d.lng);
      if (myLat) {
        const dFromMe = distKmCalc(myLat, myLng, d.lat, d.lng);
        if (dFromMe <= 3) in3km++;
        else if (dFromMe <= 8) in8km++;
        else if (dFromMe <= 15) in15km++;
      }

      // ✅ Update or add driver marker — Mappls native
      const carHtml = `<div class="driver-dot-wrap" style="transform:translate(-14px,-32px)">
          <div class="driver-car">${d.vehicleType==='cab'?'🚗':'🛺'}</div>
          <div class="driver-dot-shadow"></div>
        </div>`;
      const popupHtml = `<b>${d.vehicleType==='cab'?'🚗':'🛺'} ${d.name||'Driver'}</b><br><small style="color:#aaa">Online · ${dist.toFixed(1)}km from center</small>`;

      if (liveDriverMarkers[id]) {
        try {
          if (typeof liveDriverMarkers[id].setPosition === 'function')
            liveDriverMarkers[id].setPosition({ lat: d.lat, lng: d.lng });
        } catch(e){}
      } else if (leafMap) {
        const mk = new mappls.Marker({
          map: leafMap,
          position: { lat: d.lat, lng: d.lng },
          html: carHtml,
          popupHtml: popupHtml
        });
        liveDriverMarkers[id] = mk;
      }
    });

    // ✅ Remove offline drivers
    Object.keys(liveDriverMarkers).forEach(id => {
      if (!onlineIds.has(id)) {
        try {
          const mk = liveDriverMarkers[id];
          if (typeof mk.setMap === 'function') mk.setMap(null);
          else if (typeof mk.remove === 'function') mk.remove();
        } catch(e){}
        delete liveDriverMarkers[id];
      }
    });

    // Update UI
    safeText('liveDriverBadge', `${totalDrivers} Driver${totalDrivers!==1?'s':''} Live`);

    // Update zone breakdown on fare screen
    safeText('ndTotal',totalDrivers);
    if (myLat) {
      safeText('nd0to3',in3km);
      safeText('nd3to8',in8km);
      const el8to15 = document.getElementById('nd8to15');
      if(el8to15) el8to15.textContent = in15km;
      animateNdBars(in3km, in8km, in15km, totalDrivers);
    }

    // Driver dashboard stats
    if (CU?.role === 'driver') {
      safeText('dDriversZone',totalDrivers);
    }

    // Check surge pricing
    checkSurge(totalDrivers);

    // Show home screen badge
    if (CU?.role === 'rider') {
      const badge = document.getElementById('homeDrvBadge');
      const drvText = document.getElementById('homeDrvText');
      if (totalDrivers > 0) {
        badge.style.display = 'flex';
        if (drvText) drvText.textContent = `${totalDrivers} driver${totalDrivers!==1?'s':''} online`;
      } else {
        badge.style.display = 'flex';
        badge.style.color = 'var(--muted)';
        if (drvText) drvText.textContent = 'No drivers online';
      }
    }

    // Update my zone text
    if (myLat) updateMyZone();
    }); // end requestAnimationFrame
  });
}

function animateNdBars(a, b, c, total) {
  // nd-bar elements removed from new design — just a no-op guard
}

// ═══════════════════════════════════════════════════════
// ✅ SURGE PRICING — Based on demand vs supply
// ═══════════════════════════════════════════════════════
function checkSurge(driverCount) {
  // Surge if very few drivers online
  const newSurge = (driverCount < 2);
  if (newSurge !== surgeActive) {
    surgeActive = newSurge;
    document.getElementById('surgeBanner').style.display = surgeActive ? 'block' : 'none';
    document.getElementById('surgeChip').style.display = surgeActive ? 'flex' : 'none';
    document.getElementById('autoSurge').style.display = surgeActive ? 'inline' : 'none';
    document.getElementById('miniSurge').style.display = surgeActive ? 'inline' : 'none';
    if (surgeActive) { playSurge(); toast('⚡ Surge pricing active!'); }
  }
}

// ═══════════════════════════════════════════════════════
// ✅ ZONE DETECTION for current user
// ═══════════════════════════════════════════════════════
function updateMyZone() {
  try {
  if (!myLat) return;
  const dist = distKmCalc(myLat, myLng, JDPC.lat, JDPC.lng);
  // Update driver zone stat only
  if (CU?.role === 'driver') {
    const dsZone = document.getElementById('dsZone');
    if(dsZone) dsZone.textContent = dist <= ZONE_CORE ? 'Core' : dist <= ZONE_CITY ? 'City' : 'Outer';
    const dZoneText = document.getElementById('dZoneText');
    if(dZoneText) dZoneText.textContent = `${dist <= ZONE_CORE ? 'City Core' : dist <= ZONE_CITY ? 'City Zone' : 'Outer Area'} · ${dist.toFixed(1)}km from center`;
  }
  } catch(e) {}
}

// ═══════════════════════════════════════════════════════
// ✅ NEARBY RIDERS COUNT for driver dashboard
// ═══════════════════════════════════════════════════════
async function updateNearbyRidersCount() {
  if (!window.FB_READY || !myLat) return;
  try {
    // Count "finding" rides within 8km
    const snap = await window.FB.getDocs(
      window.FB.query(window.FB.collection(window.FB.db,'rides'), window.FB.where('status','==','finding'))
    );
    let count = 0;
    snap.forEach(d => {
      const data = d.data();
      if (data.pickupLat && data.pickupLng) {
        const dist = distKmCalc(myLat, myLng, data.pickupLat, data.pickupLng);
        if (dist <= ZONE_CITY) count++;
      }
    });
    safeText('dRidersNearby',count);
  } catch(e) {}
}

// ═══════════════════════════════════════════════════════
// ✅ REVERSE GEOCODE — Mappls API (India's best local data)
// ═══════════════════════════════════════════════════════
// ═══════════════════════════════════════════════════════
// ✅ FORWARD GEOCODE — Mappls Geocode API
// ═══════════════════════════════════════════════════════
async function geocodeAddress(address) {
  const lc = address.toLowerCase().trim();
  const KEY = window.MAPPLS_KEY;

  // STEP 1: Mappls Geocode API — highest accuracy for India
  try {
    const q = encodeURIComponent(address + ' Jagdalpur Chhattisgarh India');
    const r = await fetchWithTimeout(
      `https://apis.mappls.com/advancedmaps/v1/${KEY}/geo_code?addr=${q}&region=IND`, {}, 5000
    );
    if (r.ok) {
      const d = await r.json();
      const res = d?.copResults;
      if (res?.latitude && res?.longitude) {
        const lat = parseFloat(res.latitude), lng = parseFloat(res.longitude);
        if (lat > 0 && lng > 0) return { lat, lng, name: res.formattedAddress || address, source: 'mappls-geo' };
      }
    }
  } catch(e) {}

  // STEP 2: Mappls Text Search
  try {
    const q = encodeURIComponent(address + ' Jagdalpur');
    const r = await fetchWithTimeout(
      `https://apis.mappls.com/advancedmaps/v1/${KEY}/textsearch?query=${q}&region=IND&tokenizeAddress=true`, {}, 5000
    );
    if (r.ok) {
      const d = await r.json();
      const res = d?.suggestedLocations?.[0];
      if (res?.latitude && res?.longitude) {
        const lat = parseFloat(res.latitude), lng = parseFloat(res.longitude);
        if (lat > 0 && lng > 0) return { lat, lng, name: res.placeName || address, source: 'mappls-search' };
      }
    }
  } catch(e) {}

  // STEP 3: Nominatim (OpenStreetMap) — reliable free backup
  try {
    const q = encodeURIComponent(address + ', Jagdalpur, Chhattisgarh');
    const r = await fetchWithTimeout(
      `https://nominatim.openstreetmap.org/search?q=${q}&format=json&limit=1&countrycodes=in`,
      { headers: { 'User-Agent': 'JDPCabs/1.0 contact@jdpcabs.in' } }, 6000
    );
    if (r.ok) {
      const results = await r.json();
      if (results?.[0]) {
        const lat = parseFloat(results[0].lat), lng = parseFloat(results[0].lon);
        if (lat > 0 && lng > 0) return { lat, lng, name: results[0].display_name || address, source: 'osm' };
      }
    }
  } catch(e) {}

  // STEP 4: Local database — last resort only (hardcoded coords)
  const lm = JAGDALPUR_LANDMARKS.find(p => {
    const pn = p.name.toLowerCase();
    const parts = lc.split(/[,\s]+/).filter(w => w.length > 3);
    return parts.some(w => pn.includes(w)) || pn.includes(lc.split(',')[0].trim());
  });
  if (lm) return { lat: lm.lat, lng: lm.lng, name: lm.name, source: 'local-db', isFallback: true };

  return null;
}
// ═══════════════════════════════════════════════════════
// ✅ MAPPLS PLACE AUTOCOMPLETE — Real-time search
// ═══════════════════════════════════════════════════════
let suggestTimer = null;
let lastSuggestQuery = '';

function onDropInput(val) {
  filterPlaces(val);
  clearTimeout(suggestTimer);
  if (val.length < 2) { hideSuggest(); return; }
  suggestTimer = setTimeout(() => showSuggest(val), 350); // 350ms debounce
}

async function showSuggest(query) {
  if (query === lastSuggestQuery) return;
  lastSuggestQuery = query;
  const box = document.getElementById('dropSuggest');
  if (!box) return;

  const lc = query.toLowerCase();

  // ── A. Search local landmark database first ──
  const localMatches = JAGDALPUR_LANDMARKS.filter(lm =>
    lm.name.toLowerCase().includes(lc) ||
    lm.info.toLowerCase().includes(lc) ||
    (lm.cat && lm.cat.includes(lc))
  ).slice(0, 6);

  // ── B. Mappls Place Autocomplete API ──
  let mapplsResults = [];
  try {
    const q = encodeURIComponent(query + ' Jagdalpur');
    const r = await fetch(
      `https://apis.mappls.com/advancedmaps/v1/${window.MAPPLS_KEY}/textsearch?query=${q}&region=IND&tokenizeAddress=true`
    );
    if (r.ok) {
      const d = await r.json();
      mapplsResults = (d?.suggestedLocations || []).slice(0, 5).map(s => ({
        name: s.placeName || s.placeAddress,
        info: s.placeAddress || s.placeDetails || 'Jagdalpur',
        lat: parseFloat(s.latitude),
        lng: parseFloat(s.longitude),
        fromMappls: true,
        dist: s.distance ? (parseFloat(s.distance)/1000).toFixed(1)+'km' : ''
      }));
    }
  } catch(e) {}

  // ── Merge results — local first, then Mappls ──
  const combined = [
    ...localMatches.map(lm => ({
      name: lm.name, info: lm.info, lat: lm.lat, lng: lm.lng,
      icon: lm.icon, cat: lm.cat,
      dist: myLat ? distKmCalc(myLat, myLng, lm.lat, lm.lng).toFixed(1)+'km' : ''
    })),
    ...mapplsResults.filter(m => !localMatches.some(lm =>
      lm.name.toLowerCase() === m.name?.toLowerCase()
    ))
  ].slice(0, 8);

  if (combined.length === 0) { hideSuggest(); return; }

  // ── Render suggestions ──
  box.innerHTML = combined.map(function(item) {
    var safeName = (item.name || '').replace(/['"]/g, '');
    var icon = item.icon || getCatIcon(item.cat || '');
    var dist = item.dist ? '<div class="sug-dist">' + item.dist + '</div>' : '';
    var hl = highlight(item.name || '', query);
    var sub = (item.info || '').split(',').slice(0,2).join(',');
    return '<div class="sug-item" onclick="selectSuggest(' + item.lat + ',' + item.lng + ',\'' + safeName + '\')">' +
      '<div class="sug-icon">' + icon + '</div>' +
      '<div style="flex:1;min-width:0">' +
        '<div class="sug-main">' + hl + '</div>' +
        '<div class="sug-sub">' + sub + '</div>' +
      '</div>' + dist +
    '</div>';
  }).join('');

  box.style.display = 'block';
}

function highlight(text, query) {
  if (!query || !text) return text;
  const re = new RegExp(`(${query.replace(/[.*+?^${}()|[\]\\]/g,'\\$&')})`, 'gi');
  return text.replace(re, '<mark style="background:rgba(245,158,11,.3);color:inherit;border-radius:2px">$1</mark>');
}

function getCatIcon(cat) {
  const icons = { hospital:'🏥', education:'🎓', market:'🛍️', mall:'🏬',
    area:'🏘️', road:'🛣️', govt:'🏛️', bank:'🏦', fuel:'⛽',
    temple:'🛕', hotel:'🏨', shop:'🏪', transport:'🚌',
    sports:'⚽', landmark:'📍', tourism:'🌿' };
  return icons[cat] || '📍';
}


// ✅ Safe drop selection from map marker popup
function setDropFromMap(lat, lng, name) {
  document.getElementById('dropIn').value = name;
  window._selectedDropLat = lat;
  window._selectedDropLng = lng;
  window._selectedDropName = name;
  window._preSelectedDrop = { lat: lat, lng: lng, name: name };
  hideSuggest();
  toast('📍 Drop: ' + name);
}

function hideSuggest() {
  const box = document.getElementById('dropSuggest');
  if (box) box.style.display = 'none';
  lastSuggestQuery = '';
}

function selectSuggest(lat, lng, name) {
  hideSuggest();
  document.getElementById('dropIn').value = name;
  // Store selected drop coords directly
  window._selectedDropLat = lat;
  window._selectedDropLng = lng;
  window._selectedDropName = name;
  toast(`📍 Drop: ${name}`);
}

// ================================================================
// ⚡ JDP CABS — PRECISION ROUTING ENGINE v3.0
// Google Maps-level accuracy for Jagdalpur roads
// 5-layer routing: OSRM → Mappls v1 → Mappls Matrix → ORS → Haversine
// ================================================================

// Route quality indicator
function showRouteAccuracy(source, isFallback) {
  const badge = document.getElementById('routeAccBadge');
  if (!badge) return;
  const config = {
    'osrm':    { icon:'🛣️', label:'Real Road Route', color:'#10b981' },
    'mappls':  { icon:'🗺️', label:'Mappls Accurate',  color:'#3b82f6' },
    'matrix':  { icon:'📏', label:'Road Distance',    color:'#8b5cf6' },
    'ors':     { icon:'🌐', label:'ORS Route',        color:'#10b981' },
    'approx':  { icon:'⚠️', label:'Approximate ×1.4', color:'#f59e0b' },
  };
  const c = config[source] || config['approx'];
  badge.innerHTML = `<span style="color:${c.color}">${c.icon} ${c.label}</span>`;
  badge.style.display = 'flex';
}

// Fetch with timeout helper
async function fetchWithTimeout(url, opts={}, timeoutMs=6000) {
  const ctrl = new AbortController();
  const tid = setTimeout(() => ctrl.abort(), timeoutMs);
  try {
    const r = await fetch(url, { ...opts, signal: ctrl.signal });
    clearTimeout(tid);
    return r;
  } catch(e) {
    clearTimeout(tid);
    throw e;
  }
}

// Main routing function — tries 5 methods in priority order
async function getOSRMRoute(fLat, fLng, tLat, tLng) {
  const KEY = window.MAPPLS_KEY;

  // ╔══════════════════════════════════════╗
  // ║  METHOD 1 — OSRM (Primary, fastest)  ║
  // ║  Real Indian road routing. Free.      ║
  // ╚══════════════════════════════════════╝
  try {
    const r = await fetchWithTimeout(
      `https://router.project-osrm.org/route/v1/driving/${fLng},${fLat};${tLng},${tLat}?overview=full&geometries=geojson&steps=true`,
      {}, 7000
    );
    if (r.ok) {
      const d = await r.json();
      const rt = d?.routes?.[0];
      if (rt && rt.distance > 50) { // >50m = valid route
        showRouteAccuracy('osrm');
        return {
          distKM: parseFloat((rt.distance/1000).toFixed(2)),
          durationMin: Math.ceil(rt.duration/60),
          geometry: rt.geometry,
          steps: rt.legs?.[0]?.steps || [],
          source: 'osrm'
        };
      }
    }
  } catch(e) { console.log('[JDP Route] OSRM failed:', e.message); }

  // ╔═══════════════════════════════════════════╗
  // ║  METHOD 2 — Mappls Route Adv v1           ║
  // ║  India-specific road data (very accurate)  ║
  // ╚═══════════════════════════════════════════╝
  try {
    const url = `https://apis.mappls.com/advancedmaps/v1/${KEY}/route_adv/driving/${fLng},${fLat};${tLng},${tLat}?geometries=geojson&overview=full&steps=true&region=IND`;
    const r = await fetchWithTimeout(url, {}, 7000);
    if (r.ok) {
      const d = await r.json();
      const rt = d?.routes?.[0];
      if (rt && rt.distance > 50) {
        showRouteAccuracy('mappls');
        return {
          distKM: parseFloat((rt.distance/1000).toFixed(2)),
          durationMin: Math.ceil(rt.duration/60),
          geometry: rt.geometry,
          steps: rt.legs?.[0]?.steps || [],
          source: 'mappls'
        };
      }
    }
  } catch(e) { console.log('[JDP Route] Mappls v1 failed:', e.message); }

  // ╔══════════════════════════════════════════════════╗
  // ║  METHOD 3 — Mappls Distance Matrix               ║
  // ║  Returns real road distance even without geometry ║
  // ╚══════════════════════════════════════════════════╝
  try {
    const url = `https://apis.mappls.com/advancedmaps/v1/${KEY}/distance_matrix/driving/${fLng},${fLat};${tLng},${tLat}?region=IND&rtype=0`;
    const r = await fetchWithTimeout(url, {}, 6000);
    if (r.ok) {
      const d = await r.json();
      const dist = d?.results?.distances?.[0]?.[1];
      const dur  = d?.results?.durations?.[0]?.[1];
      if (dist > 50) {
        // Real road distance from matrix, draw straight line on map
        showRouteAccuracy('matrix');
        const geo = { type:'LineString', coordinates:[[fLng,fLat],[tLng,tLat]] };
        return {
          distKM: parseFloat((dist/1000).toFixed(2)),
          durationMin: Math.ceil((dur||0)/60) || Math.ceil((dist/1000)/0.4),
          geometry: geo,
          steps: [],
          source: 'matrix'
        };
      }
    }
  } catch(e) { console.log('[JDP Route] Mappls matrix failed:', e.message); }

  // ╔═════════════════════════════════════════════════╗
  // ║  METHOD 4 — OpenRouteService (Free, 2000/day)   ║
  // ║  Backup real routing engine                      ║
  // ╚═════════════════════════════════════════════════╝
  try {
    const r = await fetchWithTimeout(
      `https://api.openrouteservice.org/v2/directions/driving-car?api_key=5b3ce3597851110001cf6248a826289a3f04463da7fe6e5e3a7cbb47&start=${fLng},${fLat}&end=${tLng},${tLat}`,
      {}, 7000
    );
    if (r.ok) {
      const d = await r.json();
      const rt = d?.features?.[0];
      const props = rt?.properties?.summary;
      if (props?.distance > 50) {
        showRouteAccuracy('ors');
        return {
          distKM: parseFloat((props.distance/1000).toFixed(2)),
          durationMin: Math.ceil(props.duration/60),
          geometry: rt.geometry,
          steps: rt.properties?.segments?.[0]?.steps || [],
          source: 'ors'
        };
      }
    }
  } catch(e) { console.log('[JDP Route] ORS failed:', e.message); }

  // ╔══════════════════════════════════════════════════════╗
  // ║  METHOD 5 — Precision Haversine × Jagdalpur factor   ║
  // ║  Road-winding multiplier calibrated for Bastar roads  ║
  // ╚══════════════════════════════════════════════════════╝
  const straightKm = distKmCalc(fLat, fLng, tLat, tLng);
  // ✅ Bastar/Jagdalpur road factors — calibrated for actual roads
  // City roads: 1.3x | Short routes: 1.5x | Long forest roads: 2.0-2.3x
  let roadFactor;
  if      (straightKm < 1)  roadFactor = 1.2;
  else if (straightKm < 3)  roadFactor = 1.35;
  else if (straightKm < 8)  roadFactor = 1.5;
  else if (straightKm < 15) roadFactor = 1.8;
  else if (straightKm < 25) roadFactor = 2.0;
  else                       roadFactor = 2.3; // Long forest roads — very winding
  const roadDist   = parseFloat((straightKm * roadFactor).toFixed(1));
  const avgSpeed   = straightKm > 15 ? 35 : 22; // highway vs city speed
  showRouteAccuracy('approx', true);
  return {
    distKM: roadDist,
    durationMin: Math.ceil((roadDist / avgSpeed) * 60),
    geometry: { type:'LineString', coordinates:[[fLng,fLat],[tLng,tLat]] },
    steps: [],
    isFallback: true,
    source: 'approx'
  };
}

function drawRoute(geometry, color='#f59e0b') {
  clearRoute();
  if (!leafMap || !geometry?.coordinates) return;
  const path = geometry.coordinates.map(c => ({ lat: c[1], lng: c[0] }));

  // Mappls Polyline — smooth Uber-style route
  try { routePolyline = new mappls.Polyline({
    map: leafMap,
    path: path,
    strokeColor: color,
    strokeWeight: 5,
    strokeOpacity: 0.88,
    lineJoin: 'round',
    lineCap: 'round'
  }) } catch(e) { console.warn("[JDP] Route polyline error:", e); };

  // ✅ Fit map to show full route with padding
  if (path.length > 1) {
    const lats = path.map(p => p.lat), lngs = path.map(p => p.lng);
    const bounds = [[Math.min(...lats)-0.01, Math.min(...lngs)-0.01],
                    [Math.max(...lats)+0.01, Math.max(...lngs)+0.01]];
    try { leafMap.fitBounds(bounds, { padding: [65, 65] }); } catch(e) {}
  }
}

function clearRoute() {
  if (routePolyline) {
    try {
      if (typeof routePolyline.setMap === 'function') routePolyline.setMap(null);
      else if (typeof routePolyline.remove === 'function') routePolyline.remove();
    } catch(e){}
    routePolyline = null;
  }
}

// ═══════════════════════════════════════════════════════
// ✅ GPS
// ═══════════════════════════════════════════════════════
function startGPS() {
  if (!navigator.geolocation) { toast('GPS not available'); return; }
  // Accuracy samples — average 3 readings for precision
  let accuracySamples = [], bestAccuracy = 999;
  if (watchId) navigator.geolocation.clearWatch(watchId);

  // ✅ Mappls style: immediately show detecting status
  const pAddrEl = document.getElementById('pAddr');
  const pSubEl = document.getElementById('pSub');
  if (pAddrEl && !myLat) pAddrEl.textContent = 'Detecting location...';
  if (pSubEl && !myLat) pSubEl.innerHTML = '<div class="lspin"></div><span>Getting GPS...</span>';

  watchId = navigator.geolocation.watchPosition(async (pos) => {
    myLat = pos.coords.latitude; myLng = pos.coords.longitude;
    pickLat = myLat; pickLng = myLng;
    // ✅ Use rAF for smooth marker update — no jank during pan/zoom
    if(myLat && myLng) requestAnimationFrame(() => updateMyMarker(myLat, myLng));
    updateMyZone();

    if (CU?.role === 'driver' && isOnline && window.FB_READY) {
      // ✅ REAL LIVE LOCATION — write every 3s for driver (was 6s)
      if (!window._lastGPSWrite || Date.now() - window._lastGPSWrite > 3000) {
        window._lastGPSWrite = Date.now();
        try {
          await window.FB.updateDoc(window.FB.doc(window.FB.db,'users',CU.uid),
            { lat:myLat, lng:myLng, lastSeen:window.FB.serverTimestamp() });
        } catch(e) {}
      }
      // Reverse geocode with cache
      const geoKey = Math.round(myLat*1000)/1000 + ',' + Math.round(myLng*1000)/1000;
      const cached = window.Cache.get('geo_' + geoKey);
      if (cached) {
        const el = document.getElementById('dLocText');
        if(el) el.textContent = '📍 ' + cached;
      } else {
        revGeo(myLat, myLng).then(addr => {
          window.Cache.set('geo_' + geoKey, addr, 60000); // cache 1 min only
          const el = document.getElementById('dLocText');
          if(el) el.textContent = '📍 ' + addr;
        }).catch(function(){});
      }
      // Throttle nearby riders count
      if (!window._lastNearby || Date.now() - window._lastNearby > 10000) {
        window._lastNearby = Date.now();
        updateNearbyRidersCount();
      }
    }
  }, err => { if(err.code===1) toast('📍 Location access dene se accurate service milegi'); },
  { enableHighAccuracy:true, timeout:8000, maximumAge:1000 }); // ✅ 1s cache only = more live

  navigator.geolocation.getCurrentPosition(async (pos) => {
    myLat = pos.coords.latitude; myLng = pos.coords.longitude;
    pickLat = myLat; pickLng = myLng;
    const pAddrEl = document.getElementById('pAddr');
    const pSubEl = document.getElementById('pSub');
    if(pAddrEl) pAddrEl.textContent = 'Getting address...';
    if(pSubEl) pSubEl.innerHTML = '<div class="lspin"></div><span>Detecting location...</span>';
    const geoKey2 = Math.round(myLat*1000)/1000+','+Math.round(myLng*1000)/1000;
    const cachedAddr = window.Cache.get('geo_'+geoKey2);
    const addr = cachedAddr || await revGeo(myLat, myLng);
    if (!cachedAddr) window.Cache.set('geo_'+geoKey2, addr, 120000);
    pickAddr = addr;
    if(pAddrEl) pAddrEl.textContent = addr;
    // Show accuracy info
    const acc = pos.coords.accuracy ? Math.round(pos.coords.accuracy) : '?';
    if(pSubEl) pSubEl.innerHTML = `<span style="color:var(--green);font-size:.66rem">📍 Accuracy: ±${acc}m · GPS Live</span>`;
    if (leafMap) if(leafMap) if(leafMap) leafMap.flyTo([myLat, myLng], 16);
    updateMyMarker(myLat, myLng);
    updateMyZone();
    toast('📍 Location detected!');
  }, err => {
    const pAddrEl = document.getElementById('pAddr');
    const pSubEl = document.getElementById('pSub');
    if(pAddrEl) pAddrEl.textContent = 'Location unavailable — enable GPS';
    if(pSubEl) pSubEl.innerHTML = '<span style="color:var(--red)">Tap 🔄 to retry</span>';
  }, { enableHighAccuracy:true, timeout:15000 });
}

function refreshGPS() {
  safeText('pAddr','Refreshing...');
  document.getElementById('pSub').innerHTML = '<div class="lspin"></div><span>Getting GPS...</span>';
  startGPS();
}

function updateMyMarker(lat, lng) {
  if (!leafMap) return;
  const html = '<div class="my-loc-wrap" style="transform:translate(-12px,-12px)"><div class="my-loc-wave"></div><div class="my-loc-dot"></div></div>';
  if (!myMarker) {
    // ✅ Mappls Marker for user location
    myMarker = new mappls.Marker({
      map: leafMap,
      position: { lat, lng },
      html: html,
      popupHtml: '<b>📍 Your Location</b>'
    });
  } else {
    try {
      if (typeof myMarker.setPosition === 'function')
        myMarker.setPosition({ lat, lng });
    } catch(e){}
  }
}

function locateMe() {
  if (leafMap && myLat) if(leafMap) if(leafMap) leafMap.flyTo([myLat, myLng], 16);
  refreshGPS();
}

// ═══════════════════════════════════════════════════════
// ✅ DRIVER TRACKING — Assigned driver marker
// ═══════════════════════════════════════════════════════
function startDriverTracking(driverId) {
  if (driverLocListener) { driverLocListener(); driverLocListener = null; }

  // Show driver approach bar
  const bar = document.getElementById('driverApproachBar');
  if (bar) bar.style.display = 'block';

  driverLocListener = window.FB_READY && window.FB.onSnapshot(window.FB.doc(window.FB.db,'users',driverId), snap => {
    if (!snap.exists()) return;
    const d = snap.data();
    if (!d.lat || !d.lng) return;

    moveAssignedDriverMarker(d.lat, d.lng, d.name || 'Driver', d.vehicleType);

    if (!myLat) return;
    const dist = distKmCalc(myLat, myLng, d.lat, d.lng);
    const etaMin = Math.max(1, Math.ceil(dist / 0.5)); // ~30km/h Jagdalpur avg

    // ✅ Approach bar update
    const el = (id) => document.getElementById(id);
    if(el('dabCar')) el('dabCar').textContent = d.vehicleType==='cab'?'🚗':'🛺';
    if(el('dabName')) el('dabName').textContent = d.name || 'Driver';
    if(el('dabMin')) el('dabMin').textContent = dist < 0.15 ? '< 1' : etaMin;
    if(el('dabSub')) el('dabSub').textContent = dist < 0.15 ? '🟢 Yahan pahunch gaya!' : `${dist.toFixed(1)} km door • Live tracking`;

    // ✅ Live distance float pill
    const ldf = el('liveDistFloat');
    const ldt = el('liveDistText');
    if(ldf) {
      ldf.style.display = 'block';
      const sheetH = el('rSheet')?.offsetHeight || 200;
      ldf.style.bottom = (sheetH + 12) + 'px';
    }
    if(ldt) ldt.textContent = dist < 1 ? Math.round(dist*1000)+'m' : dist.toFixed(1)+'km';

    // ✅ In-sheet status update
    if(el('driverTrackText')) el('driverTrackText').textContent =
      dist < 0.1 ? '🚖 Driver yahan hai!' :
      dist < 1 ? `🚖 Driver ${(dist*1000).toFixed(0)}m door` :
      `🚖 Driver ${dist.toFixed(1)}km door`;
    if(el('driverDistText')) el('driverDistText').textContent = `⏱️ ETA ~${etaMin} min`;

    // ETA countdown update
    if(el('etaCountdown')) el('etaCountdown').textContent = etaMin + ' min';
    if(el('etaSubText')) el('etaSubText').textContent = dist < 0.15 ? '✅ Pahunch gaya!' : `${dist.toFixed(1)} km door`;
  });
}

function moveAssignedDriverMarker(lat, lng, name, vehType) {
  if (!leafMap) return;
  const carHtml = `<div class="assigned-car" style="transform:translate(-18px,-36px)">${vehType==='cab'?'🚗':'🛺'}</div>`;
  if (!driverMk) {
    // ✅ Create Mappls marker for assigned driver
    driverMk = new mappls.Marker({
      map: leafMap,
      position: { lat, lng },
      html: carHtml,
      popupHtml: `<b>${vehType==='cab'?'🚗':'🛺'} ${name}</b><br><small style="color:#aaa">Coming to you!</small>`
    });
  } else {
    // ✅ Smooth animated movement — cubic ease-out (Uber-style)
    const fromLat = prevDriverLat || lat, fromLng = prevDriverLng || lng;
    let step = 0;
    if (driverMarkerInterval) clearInterval(driverMarkerInterval);
    driverMarkerInterval = setInterval(() => {
      step++;
      const t = 1 - Math.pow(1 - (step / 30), 3); // cubic ease-out
      const curLat = fromLat + (lat - fromLat) * t;
      const curLng = fromLng + (lng - fromLng) * t;
      try {
        if (typeof driverMk.setPosition === 'function')
          driverMk.setPosition({ lat: curLat, lng: curLng });
      } catch(e){}
      if (step >= 30) clearInterval(driverMarkerInterval);
    }, 16); // 60fps
  }
  prevDriverLat = lat; prevDriverLng = lng;
}

// ═══════════════════════════════════════════════════════
// HELPERS
// ═══════════════════════════════════════════════════════
function distKmCalc(la1, ln1, la2, ln2) {
  const R=6371, dL=(la2-la1)*Math.PI/180, dN=(ln2-ln1)*Math.PI/180;
  const a=Math.sin(dL/2)**2+Math.cos(la1*Math.PI/180)*Math.cos(la2*Math.PI/180)*Math.sin(dN/2)**2;
  return R*2*Math.atan2(Math.sqrt(a),Math.sqrt(1-a));
}

function setDrop(place) {
  document.getElementById('dropIn').value = place;
  // ✅ FIX: Search local landmark DB first for exact coords
  const lc = place.toLowerCase().replace(/ jagdalpur$/i,'').trim();
  const match = JAGDALPUR_LANDMARKS.find(lm =>
    lm.name.toLowerCase().includes(lc) || lc.includes(lm.name.toLowerCase().split(' ')[0])
  );
  if (match) {
    // Use exact known coords — no geocoding needed, 100% accurate!
    window._preSelectedDrop = { lat: match.lat, lng: match.lng, name: place };
    window._selectedDropLat = match.lat;
    window._selectedDropLng = match.lng;
    window._selectedDropName = place;
    toast('📍 Drop: ' + place);
  } else {
    // Unknown place — will geocode via API
    window._preSelectedDrop = null;
    window._selectedDropLat = null;
    window._selectedDropLng = null;
    window._selectedDropName = null;
    toast('📍 Drop: ' + place);
  }
}

function filterPlaces(val) {
  // Highlight matching quick place chips
  const chips = document.querySelectorAll('.qp-chip');
  chips.forEach(c => {
    c.style.borderColor = val && c.textContent.toLowerCase().includes(val.toLowerCase())
      ? 'var(--yellow)' : '';
    c.style.background = val && c.textContent.toLowerCase().includes(val.toLowerCase())
      ? 'rgba(245,158,11,.1)' : '';
  });
}

// ═══════════════════════════════════════════════════════
// AUTH
// ═══════════════════════════════════════════════════════
function setRole(r) {
  authRole = r;
  document.getElementById('rTab').className='rtab'+(r==='rider'?' ar':'');
  document.getElementById('dTab').className='rtab'+(r==='driver'?' ad':'');
  setTab(document.getElementById('loginTab').classList.contains('on')?'login':'register');
}
function setTab(t) {
  document.getElementById('loginTab').className='atab'+(t==='login'?' on':'');
  document.getElementById('regTab').className='atab'+(t==='register'?' on':'');
  ['loginForm','rRegForm','dRegForm'].forEach(id=>document.getElementById(id).classList.remove('sh'));
  if(t==='login') document.getElementById('loginForm').classList.add('sh');
  if(t==='register'&&authRole==='rider') document.getElementById('rRegForm').classList.add('sh');
  if(t==='register'&&authRole==='driver') document.getElementById('dRegForm').classList.add('sh');
}
function selVeh(type) {
  selVehType=type;
  document.getElementById('vAuto').classList.toggle('on',type==='auto');
  document.getElementById('vCab').classList.toggle('on',type==='cab');
}
function showErr(id,msg) {
  const el=document.getElementById(id);
  el.textContent='⚠️ '+msg; el.style.display='block';
  setTimeout(()=>el.style.display='none',4000);
}
async function doLogin() {
  if (!window.FB_READY) return toast('Firebase not ready');
  const id=document.getElementById('lId').value.trim(), pw=document.getElementById('lPass').value;
  if (!id||!pw) return showErr('loginErr','Enter mobile and password');
  if (id.length!==10) return showErr('loginErr','Valid 10-digit mobile required');
  try {
    const c=await window.FB.signInWithEmailAndPassword(window.FB.auth,id+'@jdpcabs.in',pw);
    const s=await window.FB.getDoc(window.FB.doc(window.FB.db,'users',c.user.uid));
    if(s.exists()){CU={uid:c.user.uid,...s.data()};launch();}
    else showErr('loginErr','Account not found. Register first.');
  } catch(e){showErr('loginErr',e.code==='auth/wrong-password'?'Wrong password':e.code==='auth/user-not-found'?'Not registered':e.code==='auth/network-request-failed'?'No internet':'Login failed.');}
}
async function doRiderReg() {
  if (!window.FB_READY) return toast('Firebase not ready');
  const fn=document.getElementById('rFn').value.trim(),ph=document.getElementById('rPh').value.trim(),pw=document.getElementById('rPw').value;
  if(!fn||!ph||!pw) return showErr('rRegErr','Fill all fields');
  if(ph.length!==10) return showErr('rRegErr','Valid 10-digit mobile required');
  if(pw.length<6) return showErr('rRegErr','Password min 6 characters');
  try{
    const c=await window.FB.createUserWithEmailAndPassword(window.FB.auth,ph+'@jdpcabs.in',pw);
    const ud={name:fn,phone:ph,role:'rider',createdAt:window.FB.serverTimestamp()};
    await window.FB.setDoc(window.FB.doc(window.FB.db,'users',c.user.uid),ud);
    CU={uid:c.user.uid,...ud};launch();
  }catch(e){showErr('rRegErr',e.code==='auth/email-already-in-use'?'Mobile already registered. Login.':'Registration failed.');}
}
function fmtAadhar(el) {
  let v = el.value.replace(/\D/g,'').slice(0,12);
  el.value = v.replace(/(\d{4})(?=\d)/g,'$1 ').trim();
}

// ✅ Driver photo compress + preview
let driverPhotoBase64 = '';
function handleDriverPhoto(input) {
  const file = input.files[0];
  if (!file) return;
  if (file.size > 5 * 1024 * 1024) { toast('❌ Photo 5MB se chhota hona chahiye'); return; }

  const reader = new FileReader();
  reader.onload = (e) => {
    const img = new Image();
    img.onload = () => {
      // Compress to 200x200 thumbnail
      const canvas = document.createElement('canvas');
      const SIZE = 200;
      let w = img.width, h = img.height;
      // Crop to square from center
      const min = Math.min(w, h);
      const sx = (w - min) / 2, sy = (h - min) / 2;
      canvas.width = SIZE; canvas.height = SIZE;
      const ctx = canvas.getContext('2d');
      // Circle clip
      ctx.beginPath();
      ctx.arc(SIZE/2, SIZE/2, SIZE/2, 0, Math.PI*2);
      ctx.clip();
      ctx.drawImage(img, sx, sy, min, min, 0, 0, SIZE, SIZE);
      driverPhotoBase64 = canvas.toDataURL('image/jpeg', 0.75);

      // Show preview
      const prevEl = document.getElementById('dPhotoPreview');
      prevEl.src = driverPhotoBase64;
      prevEl.style.display = 'block';
      document.getElementById('photoPlaceholder').style.display = 'none';
      safeText('photoUploadLbl','✅ Photo selected — tap to change');
      document.getElementById('photoUploadBox').classList.add('has-photo');
      document.getElementById('photoStatus').style.display = 'block';
    };
    img.src = e.target.result;
  };
  reader.readAsDataURL(file);
}

function showKycStep() {
  const fn=document.getElementById('dFn').value.trim(),ph=document.getElementById('dPh').value.trim();
  const veh=document.getElementById('dVeh').value.trim().toUpperCase(),pw=document.getElementById('dPw').value;
  if(!fn||!ph||!veh||!pw) return showErr('dRegErr','Fill all basic fields first');
  if(ph.length!==10) return showErr('dRegErr','Valid 10-digit mobile required');
  if(pw.length<6) return showErr('dRegErr','Password min 6 chars');
  if(veh.length<5) return showErr('dRegErr','Valid vehicle number required');
  document.getElementById('dStep1').style.display='none';
  document.getElementById('dStep2').style.display='block';
}
async function doDriverReg() {
  if (!window.FB_READY) return toast('Firebase not ready');
  const fn=document.getElementById('dFn').value.trim(),ph=document.getElementById('dPh').value.trim();
  const veh=document.getElementById('dVeh').value.trim().toUpperCase(),pw=document.getElementById('dPw').value;
  const aadhar=document.getElementById('dAadhar').value.replace(/\s/g,'');
  const pan=document.getElementById('dPan').value.trim().toUpperCase();
  const dl=document.getElementById('dDl').value.trim().toUpperCase();
  const bankName=document.getElementById('dBankName').value.trim();
  const accNo=document.getElementById('dAccNo').value.trim();
  const ifsc=document.getElementById('dIfsc').value.trim().toUpperCase();

  if(!fn||!ph||!veh||!pw) return showErr('dRegErr','Basic details missing');
  if(ph.length!==10) return showErr('dRegErr','Valid 10-digit mobile required');
  if(pw.length<6) return showErr('dRegErr','Password min 6 chars');
  if(!driverPhotoBase64) return showErr('dRegErr','📸 Profile photo zaroori hai — please upload karo');
  if(aadhar.length!==12) return showErr('dRegErr','Aadhaar 12 digits required');
  if(pan.length!==10) return showErr('dRegErr','PAN card 10 characters required');
  if(!dl) return showErr('dRegErr','Driving Licence number required');
  if(!bankName||!accNo||!ifsc) return showErr('dRegErr','Bank details required');
  if(ifsc.length!==11) return showErr('dRegErr','IFSC code 11 characters hona chahiye');

  try{
    const c=await window.FB.createUserWithEmailAndPassword(window.FB.auth,ph+'@jdpcabs.in',pw);
    const ud={
      name:fn, phone:ph, role:'driver', vehicleNo:veh, vehicleType:selVehType,
      rating:5.0, isOnline:false, earnings:0, ridesCompleted:0,
      photoBase64: driverPhotoBase64,
      kycStatus:'pending',
      kyc:{ aadhaar:aadhar, pan:pan, drivingLicence:dl },
      bank:{ accountHolderName:bankName, accountNumber:accNo, ifsc:ifsc },
      createdAt:window.FB.serverTimestamp()
    };
    await window.FB.setDoc(window.FB.doc(window.FB.db,'users',c.user.uid),ud);
    CU={uid:c.user.uid,...ud};
    toast('✅ Registration submitted! Admin verification pending.');
    launch();
  }catch(e){showErr('dRegErr',e.code==='auth/email-already-in-use'?'Mobile already registered. Login.':'Registration failed: '+e.message);}
}

// ═══════════════════════════════════════════════════════
// LAUNCH
// ═══════════════════════════════════════════════════════
function launch() {
  window._launchPending = false;
  document.getElementById('auth').style.display='none';
  setTimeout(()=>{ if(leafMap) leafMap.invalidateSize(); },300);
  if(CU?.role==='driver') launchDriver();
  else launchRider();
  startGPS();
  startLiveDriverWatch();  // ✅ Watch all live drivers on map
}
function launchRider() {
  document.getElementById('rTop').style.display='flex';
  document.getElementById('rSheet').style.display='block';document.getElementById('mapFade').style.display='block';
  document.getElementById('locBtn').style.display='flex';
  document.getElementById('mapStats').style.display='block';
  if(CU) document.getElementById('riderName').textContent=CU.name?.toUpperCase()||'RIDER';
  loadFavChips();
}
function launchDriver() {
  safeShow('dTopBar');// ='block';
  safeShow('dStats');// ='block';
  safeShow('dPanel');// ='block';
  document.getElementById('locBtn').style.display='flex';
  document.getElementById('locBtn').style.bottom='250px';
  document.getElementById('mapStats').style.display='block';
  if(CU) document.getElementById('dName').textContent=CU.name;
  dEarnings=CU.earnings||0; dRides=CU.ridesCompleted||0;
  updateDStats(); showDCard('off');
  if(CU.kycStatus==='pending'){
    const w=document.getElementById('kycPendingWarn');
    if(w) w.style.display='block';
  }
  landmarksVisible = false;  // Keep map clean for driver
  // renderVisibleLandmarks(); // Don't auto-show landmarks
}

// ═══════════════════════════════════════════════════════
// DRIVER ONLINE/OFFLINE
// ═══════════════════════════════════════════════════════
async function toggleOnline() {
  isOnline=document.getElementById('onTog').checked;

  // ✅ FIX 5: Block KYC pending drivers from going online
  if(isOnline && CU?.kycStatus==='pending'){
    document.getElementById('onTog').checked=false;
    isOnline=false;
    safeText('onlineLbl','OFFLINE');
    document.getElementById('onlineLbl').style.color='rgba(255,255,255,.55)';
    toast('⚠️ KYC pending hai — admin approval ke baad online ho sakte hain');
    return;
  }

  safeText('onlineLbl',isOnline?'ONLINE':'OFFLINE');
  document.getElementById('onlineLbl').style.color=isOnline?'#10b981':'rgba(255,255,255,.55)';
  if(isOnline){
    onlineStart=Date.now();
    showDCard('on');
    toast('🟢 Online! Listening for rides within 8km...');
    if(onlineTimeInterval) clearInterval(onlineTimeInterval);
    onlineTimeInterval=setInterval(()=>{
      if(onlineStart) document.getElementById('dsTime').textContent=((Date.now()-onlineStart)/3600000).toFixed(1)+'h';
      updateNearbyRidersCount();
    }, 30000);
    if(window.FB_READY&&CU){
      try{await window.FB.updateDoc(window.FB.doc(window.FB.db,'users',CU.uid),{isOnline:true,lat:myLat||JDPC.lat,lng:myLng||JDPC.lng});}catch(e){}
    }
    startListeningForRides();
    updateNearbyRidersCount();
  } else {
    stopListeningForRides();
    showDCard('off');
    if(onlineTimeInterval){clearInterval(onlineTimeInterval);onlineTimeInterval=null;}
    toast('🔴 You are offline');
    if(window.FB_READY&&CU){
      try{await window.FB.updateDoc(window.FB.doc(window.FB.db,'users',CU.uid),{isOnline:false});}catch(e){}
    }
  }
}

// ✅ SMART MATCHING — First try 5km, then expand to 8km
function startListeningForRides() {
  if(!window.FB_READY) return;
  stopListeningForRides();
  const q=window.FB.query(window.FB.collection(window.FB.db,'rides'),window.FB.where('status','==','finding'));
  newRideListener=window.FB.onSnapshot(q, snap => {
    snap.docChanges().forEach(change => {
      if(change.type==='added'&&isOnline&&!curReqId){
        const data=change.doc.data();
        // ✅ Distance-based matching — only accept rides within zone
        if(myLat&&data.pickupLat){
          const dist=distKmCalc(myLat,myLng,data.pickupLat,data.pickupLng);
          if(dist>ZONE_CITY) return; // Beyond 8km — skip
        }
        curReqId=change.doc.id;
        curReqData={id:curReqId,...data};
        showReqPopup(curReqData);
        playNewRide();
      }
    });
  });
}
function stopListeningForRides() {
  if(newRideListener){newRideListener();newRideListener=null;}
}
function showDCard(type) {
  // ✅ FIXED: Properly show/hide — no more overlap/hang
  var dOff = document.getElementById('dOff');
  var dOn  = document.getElementById('dOn');
  var dNav = document.getElementById('dNav');
  if(dOff) dOff.style.display = type==='off' ? 'block' : 'none';
  if(dOn)  dOn.style.display  = type==='on'  ? 'block' : 'none';
  if(dNav) dNav.style.display = type==='nav' ? 'block' : 'none';
}
function updateDStats() {
  safeText('dsEarn','₹'+dEarnings);
  safeText('dsRides',dRides);
}

// ═══════════════════════════════════════════════════════
// REQUEST POPUP
// ═══════════════════════════════════════════════════════
function showReqPopup(data) {
  safeText('reqFare','₹'+(data.fare||'--'));
  safeText('reqDist',(data.distanceKM||'--')+'km');
  safeText('reqPick',data.pickup||'--');
  safeText('reqDrop',data.drop||'--');

  // ✅ Show how far the rider is from driver
  let pickupDist = '--';
  if(myLat&&data.pickupLat){
    const straightD=distKmCalc(myLat,myLng,data.pickupLat,data.pickupLng);
    // Road winding factor for Jagdalpur (1.3x = realistic road distance)
    const roadD = straightD < 0.3 ? straightD : parseFloat((straightD * 1.3).toFixed(1));
    pickupDist=roadD<1?Math.round(roadD*1000)+'m':roadD.toFixed(1)+'km';
    document.getElementById('reqDistBadge').innerHTML=`<span class="dist-badge">📍 Rider ${pickupDist} door (road)</span>`;
  }
  safeText('reqPickupDist',pickupDist);
  const reqETAEl = document.getElementById('reqETA');
  if(reqETAEl) reqETAEl.textContent = (data.etaMin||'--')+'m';
  document.getElementById('reqPopup').classList.add('sh');

  reqTimer=60;
  safeText('tNum',reqTimer);
  const circ=document.getElementById('tCircle');
  circ.style.stroke='var(--yellow)';
  document.getElementById('tNum').style.color='var(--yellow)';
  circ.style.strokeDashoffset='0';

  if(reqInterval) clearInterval(reqInterval);
  reqInterval=setInterval(()=>{
    reqTimer--;
    safeText('tNum',reqTimer);
    circ.style.strokeDashoffset=163*(1-reqTimer/60);
    if(reqTimer<=10){circ.style.stroke='var(--red)';document.getElementById('tNum').style.color='var(--red)';}
    if(reqTimer<=0){clearInterval(reqInterval);hideReqPopup();curReqId=null;curReqData=null;toast('⏰ Request expired');}
  },1000);
}
function hideReqPopup() {
  document.getElementById('reqPopup').classList.remove('sh');
  if(reqInterval) clearInterval(reqInterval);
}

async function acceptReq() {
  if(!curReqData) return;
  clearInterval(reqInterval);
  hideReqPopup();
  stopListeningForRides();
  const data=curReqData;
  navPhase='pickup';

  if(window.FB_READY){
    try{
      const otp=Math.floor(1000+Math.random()*9000);
      await window.FB.updateDoc(window.FB.doc(window.FB.db,'rides',data.id),{
        status:'assigned',driverId:CU.uid,driverName:CU.name,driverPhone:CU.phone,
        driverVehicle:CU.vehicleNo,driverVehicleType:CU.vehicleType,otp,
        acceptedAt:window.FB.serverTimestamp()
      });
    }catch(e){toast('❌ Accept failed');return;}
  }

  // ✅ Update nav panel info
  safeText('navLabel','🔵 Pickup pe jao');
  safeText('navPA',data.pickup||'--');
  safeText('navDA',data.drop||'--');
  safeText('navFare','₹'+(data.fare||'--'));
  safeText('navActBtn','✅ Rider Picked Up');

  // ✅ Rider contact info
  const riderNameEl = document.getElementById('navRiderName');
  const riderPhoneEl = document.getElementById('navRiderPhone');
  const callBtn = document.getElementById('callRiderBtn');
  if(riderNameEl) riderNameEl.textContent = data.riderName || 'Rider';
  const rPhone = data.riderPhone || data.rPhone || data.phone || '';
  if(rPhone && rPhone.length >= 10){
    if(riderPhoneEl) riderPhoneEl.textContent = '📞 ' + rPhone;
    if(callBtn){ callBtn.href = 'tel:' + rPhone; callBtn.style.opacity='1'; callBtn.style.pointerEvents='auto'; }
  } else {
    if(riderPhoneEl) riderPhoneEl.textContent = 'Phone number nahi mila';
    if(callBtn){ callBtn.style.opacity='0.5'; callBtn.href='#'; }
  }

  // ✅ Store coords for Google Maps navigation
  window._navPickupLat = data.pickupLat;
  window._navPickupLng = data.pickupLng;

  // ✅ FIXED: Show nav card first, then draw route
  showDCard('nav');
  toast('✅ Ride accepted! Pickup pe jao 🚗');

  // ✅ Draw route on map + fly to pickup
  if(leafMap && myLat && data.pickupLat){
    try {
      // Fly map to show driver → pickup route
      leafMap.flyTo([data.pickupLat, data.pickupLng], 14);

      // Draw route line
      const route = await getOSRMRoute(myLat, myLng, data.pickupLat, data.pickupLng);
      if(route){
        drawRoute(route.geometry, '#3b82f6');
        safeText('navPDist', route.distKM + ' km');
        safeText('navPETA', route.durationMin + ' min');
      }

      // Pickup marker on map
      if(pickupMk){ try{if(typeof pickupMk.setMap==='function')pickupMk.setMap(null);}catch(e){} pickupMk=null; }
      pickupMk = new mappls.Marker({
        map: leafMap,
        position: {lat: data.pickupLat, lng: data.pickupLng},
        html: '<div class="pickup-wrap" style="transform:translate(-16px,-36px)"><div class="pickup-icon">📍</div></div>',
        popupHtml: `<b style="color:#10b981">📍 ${data.pickup||'Pickup'}</b>`
      });
    } catch(e) { console.warn('[JDP] Route draw error:', e); }
  }
}

function declineReq() {
  clearInterval(reqInterval);
  hideReqPopup();
  curReqId=null;curReqData=null;
  toast('Declined');
}

async function driverNext() {
  if(!curReqData) return;
  if(navPhase==='pickup'){
    navPhase='drop';
    safeText('navLabel','🟢 Going to Drop');
    const np2 = document.getElementById('navPickup');
    if(np2) np2.style.opacity='.45';
    safeText('navActBtn','🏁 Complete Trip');
    if(window.FB_READY&&curReqData.id){
      try{await window.FB.updateDoc(window.FB.doc(window.FB.db,'rides',curReqData.id),{status:'ongoing',pickedAt:window.FB.serverTimestamp()});}catch(e){}
    }
    toast('🚗 Drop pe jao! Rider saath hai');
    if(leafMap&&myLat&&curReqData.drop){
      const dc=await geocodeAddress(curReqData.drop);
      if(dc){
        // ✅ Store drop coords for Google Maps button
        window._navDropLat = dc.lat;
        window._navDropLng = dc.lng;
        window._navDropName = curReqData.drop;

        const route=await getOSRMRoute(myLat,myLng,dc.lat,dc.lng);
        if(route){
          drawRoute(route.geometry,'#10b981');
          safeText('navPDist', route.distKM + ' km');
          safeText('navPETA', route.durationMin + ' min');
        }
        // Fly map to drop
        try { leafMap.flyTo([dc.lat, dc.lng], 14); } catch(e){}

        if(dropMk){ try{if(typeof dropMk.setMap==='function')dropMk.setMap(null);}catch(e){} dropMk=null; }
        dropMk = new mappls.Marker({ map:leafMap, position:{lat:dc.lat,lng:dc.lng},
          html:'<div class="drop-icon" style="transform:translate(-15px,-30px)">🏁</div>',
          popupHtml:`<b style="color:#ef4444">🏁 ${curReqData.drop}</b>` });
      }
    }
  } else { await completeTrip(); }
}

async function completeTrip() {
  const data=curReqData;
  dEarnings+=(data.fare||0); dRides+=1; updateDStats();
  if(window.FB_READY){
    try{
      await window.FB.updateDoc(window.FB.doc(window.FB.db,'rides',data.id),{status:'completed',completedAt:window.FB.serverTimestamp()});
      await window.FB.updateDoc(window.FB.doc(window.FB.db,'users',CU.uid),{earnings:dEarnings,ridesCompleted:dRides});
    }catch(e){}
  }
  clearRoute();
  if(pickupMk){ try{if(typeof pickupMk.setMap==='function')pickupMk.setMap(null);}catch(e){} pickupMk=null; }
  if(dropMk){ try{if(typeof dropMk.setMap==='function')dropMk.setMap(null);}catch(e){} dropMk=null; }
  curReqId=null;curReqData=null;navPhase='pickup'; stopNavigation();
  showDCard('on');
  toast(`🎉 Trip done! ₹${data.fare} earned!`);
  if(isOnline) startListeningForRides();
}

async function driverCancel() {
  if(window.FB_READY&&curReqData?.id){
    try{await window.FB.updateDoc(window.FB.doc(window.FB.db,'rides',curReqData.id),{status:'cancelled_driver',cancelledAt:window.FB.serverTimestamp()});}catch(e){}
  }
  clearRoute();
  curReqId=null;curReqData=null;navPhase='pickup';
  if(pickupMk){ try{if(typeof pickupMk.setMap==='function')pickupMk.setMap(null);}catch(e){} pickupMk=null; }
  showDCard('on');
  toast('Ride cancelled');
  if(isOnline) startListeningForRides();
}

// ═══════════════════════════════════════════════════════
// RIDER BOOKING
// ═══════════════════════════════════════════════════════
function goScr(id) {
  try {
    setTimeout(function(){ try{ if(leafMap && leafMap.invalidateSize) leafMap.invalidateSize(); }catch(e){} }, 320);
    document.querySelectorAll('.scr').forEach(function(e){ e.classList.remove('on'); });
    var el = document.getElementById(id);
    if (el) el.classList.add('on');
    var sheet = document.getElementById('rSheet');
    if (sheet) sheet.scrollTop = 0;
  } catch(e) { console.warn('[JDP] goScr error:', e); }
}

async function calcFare() {
  // Sync pre-selected drop from autocomplete
  if (window._selectedDropLat && window._selectedDropLng && window._selectedDropName) {
    const dropIn = document.getElementById('dropIn');
    if (dropIn && dropIn.value.trim() === window._selectedDropName) {
      window._preSelectedDrop = { lat: window._selectedDropLat, lng: window._selectedDropLng, name: window._selectedDropName };
    }
  }

  const drop = document.getElementById('dropIn').value.trim();
  if (!drop) {
    const e = document.getElementById('homeErr');
    e.textContent = '\u26a0\ufe0f Drop location enter karo ya popular place select karo';
    e.style.display = 'block';
    setTimeout(() => e.style.display = 'none', 3000);
    return;
  }

  // Show loading state on button
  const findBtn = document.querySelector('#sHome .mbtn.y');
  if (findBtn) { findBtn.textContent = '\u23f3 Calculating...'; findBtn.disabled = true; }

  try {
    const fLat = pickLat || myLat || JDPC.lat;
    const fLng = pickLng || myLng || JDPC.lng;

    // Cache key with full precision
    const cKey = `${fLat.toFixed(4)}_${fLng.toFixed(4)}_${drop}`;
    if (routeCache[cKey]) {
      applyRoute(routeCache[cKey], drop);
      return;
    }

    toast('\U0001f5fa\ufe0f Finding best route...');

    // Step 1: Get drop coordinates
    let dropCoords = null;

    // Priority 1: Exact coords from autocomplete selection
    if (window._preSelectedDrop && window._preSelectedDrop.name === drop) {
      dropCoords = { lat: window._preSelectedDrop.lat, lng: window._preSelectedDrop.lng };
    }
    // Priority 2: Autocomplete API coords
    else if (window._selectedDropLat && window._selectedDropLng &&
             drop.toLowerCase().includes((window._selectedDropName||'').toLowerCase().split(' ')[0])) {
      dropCoords = { lat: window._selectedDropLat, lng: window._selectedDropLng };
    }
    // Priority 3: Geocode with Mappls API (most accurate for Indian addresses)
    else {
      dropCoords = await geocodeAddress(drop);
    }

    if (!dropCoords || !dropCoords.lat || !dropCoords.lng) {
      toast('\u274c Location nahi mili — aur specific naam likho');
      if (findBtn) { findBtn.textContent = 'Find Ride \U0001f697'; findBtn.disabled = false; }
      return;
    }

    // Step 2: Get real road route (5-method engine)
    const route = await getOSRMRoute(fLat, fLng, dropCoords.lat, dropCoords.lng);

    if (route && route.distKM > 0) {
      routeCache[cKey] = { route, dropCoords };
      if (route.isFallback) {
        toast('\u26a0\ufe0f Network slow — approximate distance shown');
      } else {
        toast(`\u2705 Route found: ${route.distKM} km via ${route.source === 'osrm' ? 'OSRM' : 'Mappls'}`);
      }
      applyRoute({ route, dropCoords }, drop);
    } else {
      toast('\u274c Route calculate nahi hua — retry karo');
    }
  } finally {
    if (findBtn) { findBtn.textContent = 'Find Ride \U0001f697'; findBtn.disabled = false; }
  }
}

function applyRoute({route,dropCoords},drop) {
  distKM = route.distKM;
  const eta = route.durationMin;
  const surge = surgeActive ? 1.5 : 1;
  fareA = Math.round(Math.max(25, 20 + distKM * 12) * surge);
  fareM = Math.round(Math.max(50, 40 + distKM * 16) * surge);
  const fareP = Math.round(Math.max(100, 80 + distKM * 22) * surge);

  // Store drop coordinates
  const farePickEl = document.getElementById('farePickupAddr');
  const fareDropEl = document.getElementById('fareDropAddr');
  if (farePickEl) farePickEl.textContent = pickAddr || 'Your Location';
  if (fareDropEl) {
    fareDropEl.textContent = drop || '--';
    dropLat = dropCoords.lat;
    dropLng = dropCoords.lng;
    dropAddr = drop;
  }

  // Show distance with 2 decimal precision
  const distDisplay = distKM >= 10 ? distKM.toFixed(1) : distKM.toFixed(2);
  safeText('cDist', distDisplay);
  safeText('cETA', eta);
  // Update estimated fare chip
  const cFareEl = document.getElementById('cFareEst');
  if(cFareEl) cFareEl.textContent = '₹' + fareA;
  // Update ride cards distance label
  const aDistLbl = document.getElementById('autoDistLbl');
  const mDistLbl = document.getElementById('miniDistLbl');
  if(aDistLbl) aDistLbl.textContent = distKM + ' km';
  if(mDistLbl) mDistLbl.textContent = distKM + ' km';
  // Update ETA in cards
  const autoETA = document.getElementById('autoETA');
  const miniETA = document.getElementById('miniETA');
  if(autoETA) autoETA.textContent = '~' + Math.max(2, Math.round(eta*0.85));
  if(miniETA) miniETA.textContent = '~' + Math.max(3, eta);

  safeText('fAuto',fareA);
  safeText('fMini',fareM);
  const fPremEl = document.getElementById('fPremium');
  if(fPremEl) fPremEl.textContent = fareP;

  cabType='JDP Auto';cabFare=fareA;
  safeText('bookBtnType','Auto');
  document.getElementById('optAuto').classList.add('sel');
  document.getElementById('optMini').classList.remove('sel');

  if(route.geometry) drawRoute(route.geometry,'#f59e0b');

  if(leafMap){
    if(pickLat){
      if(pickupMk){ try{if(typeof pickupMk.setMap==='function')pickupMk.setMap(null);}catch(e){} pickupMk=null; }
      if(pickLat && pickLng && leafMap) pickupMk = new mappls.Marker({ map:leafMap, position:{lat:pickLat,lng:pickLng},
        html:'<div class="pickup-wrap" style="transform:translate(-16px,-36px)"><div class="pickup-icon">📍</div></div>',
        popupHtml:`<b style="color:#10b981">📍 ${pickAddr || 'Your Pickup'}</b>` });
    }
    if(dropCoords){
      if(dropMk){ try{if(typeof dropMk.setMap==='function')dropMk.setMap(null);}catch(e){} dropMk=null; }
      dropMk = new mappls.Marker({ map:leafMap, position:{lat:dropCoords.lat,lng:dropCoords.lng},
        html:'<div class="drop-icon" style="transform:translate(-15px,-30px)">🏁</div>',
        popupHtml:`<b style="color:#ef4444">🏁 ${drop}</b>` });
    }
  }
  // Start live distance chip on map
  startLiveDistanceTracking();
  goScr('sFare');
}

function useFallback(drop) {
  let d=3;
  if(pickLat){d=distKmCalc(pickLat,pickLng,JDPC.lat,JDPC.lng)*1.3;if(d<1)d=2+Math.random()*3;}
  else d=2+Math.random()*4;
  d=parseFloat(d.toFixed(1));distKM=d;
  const surge=surgeActive?1.5:1;
  fareA=Math.round(Math.max(25,20+d*12)*surge);
  fareM=Math.round(Math.max(50,40+d*16)*surge);
  safeText('cDist',d.toFixed(2)+'*');
  safeText('cETA',Math.ceil(d*3)+'*');
  const cFareEl = document.getElementById('cFareEst');
  if(cFareEl) cFareEl.textContent = '~₹' + fareA;
  const aDistLbl = document.getElementById('autoDistLbl');
  const mDistLbl = document.getElementById('miniDistLbl');
  if(aDistLbl) aDistLbl.textContent = d + ' km*';
  if(mDistLbl) mDistLbl.textContent = d + ' km*';
  safeText('fAuto',fareA);
  safeText('fMini',fareM);
  cabType='JDP Auto';cabFare=fareA;
  safeText('bookBtnType','Auto');
  document.getElementById('optAuto').classList.add('sel');
  document.getElementById('optMini').classList.remove('sel');
  toast('⚠️ * = Estimated distance');
  goScr('sFare');
}

function selRide(el,type,vk) {
  document.querySelectorAll('.ro-card').forEach(e=>e.classList.remove('sel'));
  el.classList.add('sel');
  cabType=type;cabFare=vk==='auto'?fareA:fareM;
  safeText('bookBtnType',type);
}

// SMART BOOKING with full validation
async function confirmBook() {
  // === FULL VALIDATION ===
  if (!window.CU) {
    toast('❌ Login karo pehle booking ke liye');
    document.getElementById('auth').style.display = 'flex';
    return;
  }
  const dropVal = document.getElementById('dropIn')?.value?.trim() || '';
  if (!dropVal) {
    toast('?? Drop location enter karo pehle');
    document.getElementById('dropIn')?.focus();
    return;
  }
  if (!cabFare || cabFare <= 0) {
    toast('⚠️ Pehle "Find Ride" button dabao fare ke liye');
    return;
  }
  if (!window.FB_READY) {
    toast('⚠️ Internet check karo — Firebase connect nahi hua');
    return;
  }
  goScr('sFind');

  let nearbyCount=0,in5km=0,in8km=0;
  if(window.FB_READY){
    try{
      const snap=await window.FB.getDocs(
        window.FB.query(window.FB.collection(window.FB.db,'users'),window.FB.where('role','==','driver'),window.FB.where('isOnline','==',true))
      );
      nearbyCount=snap.size;
      snap.forEach(d=>{
        const data=d.data();
        if(data.lat&&myLat){
          const dist=distKmCalc(myLat,myLng,data.lat,data.lng);
          if(dist<=MATCH_RADIUS_1) in5km++;
          else if(dist<=MATCH_RADIUS_2) in8km++;
        }
      });
    }catch(e){}
  }

  safeText('nearbyCount',nearbyCount>0?`${nearbyCount} driver${nearbyCount>1?'s':''} online`:'Searching...');
  safeText('matchZoneText',
    in5km>0?`✅ ${in5km} driver${in5km>1?'s':''} within 5km — fast match!`:
    in8km>0?`🔵 ${in8km} driver${in8km>1?'s':''} within 8km — matching...`:
    nearbyCount>0?'🟡 Drivers in outer zone — matching...':
    '⏳ No drivers nearby — please wait...');

  if(window.FB_READY && nearbyCount===0){
    setTimeout(()=>{
      toast('⚠️ Abhi koi driver online nahi hai. Thodi der mein try karo.');
      goScr('sHome');
    },3500);
    return;
  }

  // Get rider phone — try all possible fields
  const riderPhoneVal = CU?.phone || CU?.mobile || CU?.phoneNumber || '';

  // ✅ FIX 3: Apply promo discount to actual fare
  const promoDiscount = appliedPromo ? Math.min(appliedPromo.discount, cabFare) : 0;
  const effectiveFare = Math.max(1, cabFare - promoDiscount);

  const rideData={
    riderId:CU?.uid||'guest',
    riderName:CU?.name||'Rider',
    riderPhone: riderPhoneVal,
    phone: riderPhoneVal,   // extra field as backup
    pickup:pickAddr||'GPS Location',pickupLat:pickLat||JDPC.lat,pickupLng:pickLng||JDPC.lng,
    drop:document.getElementById('dropIn').value.trim(),
    cabType,
    fare: effectiveFare,              // ✅ FIX 3: discounted fare
    originalFare: cabFare,             // ✅ save original
    promoCode: appliedPromo?.code || null,  // ✅ FIX 7: save promo info
    promoDiscount: promoDiscount,      // ✅ FIX 7: receipt will show correctly
    distanceKM:distKM,
    etaMin:parseInt((document.getElementById('cETA')||{textContent:'10'}).textContent)||10,
    status:'finding',
    createdAt:window.FB_READY?window.FB.serverTimestamp():new Date().toISOString()
  };

  try{
    if(window.FB_READY){
      const ref=await window.FB.addDoc(window.FB.collection(window.FB.db,'rides'),rideData);
      rideDocId=ref.id;
      listenToRide(rideDocId);
      appliedPromo = null;
      const promoStripEl = document.getElementById('promoStrip');
      if (promoStripEl) promoStripEl.style.display = 'none';
    }else{
      setTimeout(()=>{toast('❌ Firebase required');goScr('sHome');},3000);
    }
  }catch(e){toast('❌ Booking failed. Check internet.');goScr('sHome');}
}

// ✅ Separate async function to fetch and show driver photo safely
async function fetchAndShowDriverPhoto(driverId) {
  if(!driverId || !window.FB_READY) return;
  try {
    const dSnap = await window.FB.getDoc(window.FB.doc(window.FB.db,'users',driverId));
    if(dSnap.exists()){
      const dData = dSnap.data();
      if(dData.photoBase64){
        const photoEl = document.getElementById('dAvaPhoto');
        const emojiEl = document.getElementById('dAvaEmoji');
        if(photoEl){ photoEl.src = dData.photoBase64; photoEl.style.display = 'block'; }
        if(emojiEl){ emojiEl.style.display = 'none'; }
      }
    }
  } catch(e) {}
}

function listenToRide(id) {
  if(rideListener){rideListener();rideListener=null;}
  rideListener=window.FB.onSnapshot(window.FB.doc(window.FB.db,'rides',id), snap=>{
    if(!snap.exists()) return;
    const data=snap.data();
    // ✅ FIX 2: Check rideDocId active AND not already on assigned screen (was blocking if user changed screen)
    if(data.status==='assigned'&&rideDocId){
      safeText('aDName',data.driverName||'--');
      safeText('aVeh',`${data.driverVehicle||'--'} • ${data.cabType||'--'}`);
      safeText('rideOTP',data.otp||'----');

      // ✅ FIX 4: Fetch and update driver rating dynamically
      if(data.driverId && window.FB_READY){
        window.FB.getDoc(window.FB.doc(window.FB.db,'users',data.driverId)).then(dSnap=>{
          if(dSnap.exists()){
            const dd=dSnap.data();
            const rating=(dd.rating||5.0).toFixed(1);
            const ratingEl=document.querySelector('#driverCard .star-row span:last-child');
            if(ratingEl) ratingEl.textContent=rating;
            // update vehicle type display
            if(dd.vehicleType){
              const vehLabel = dd.vehicleType==='cab'?'🚗 Mini Cab':'🛺 Auto';
              const vehEl=document.getElementById('aVeh');
              if(vehEl) vehEl.textContent=`${data.driverVehicle||dd.vehicleNo||'--'} • ${vehLabel}`;
            }
          }
        }).catch(()=>{});
      }

      // ✅ Store driver phone and show call button
      const dPhone = data.driverPhone||'';
      if(dPhone){
        safeText('aDriverPhoneNum',dPhone);
        safeShow('aDriverPhone');
        document.getElementById('callDriverBtn').href='tel:'+dPhone;
        safeText('callDriverNumLabel',dPhone);
      }

      // ✅ Fetch driver photo — called as separate async function (no await here)
      if(data.driverId) fetchAndShowDriverPhoto(data.driverId);

      goScr('sAssigned');
      playDriverAssigned();
      const banner=document.getElementById('assignedBanner');
      banner.classList.add('assign-bounce');
      setTimeout(()=>banner.classList.remove('assign-bounce'),700);
      // ✅ Add assigned glow to driver card
      const dCard=document.getElementById('driverCard');
      if(dCard){ dCard.classList.add('assigned-glow'); setTimeout(()=>dCard.classList.remove('assigned-glow'),4000); }
      toast('🎉 Driver accepted your ride!');
      if(data.driverId) startDriverTracking(data.driverId);
      // ✅ Show SOS button during ride
      showSOS(470);
      // ✅ Start ETA countdown
      if(data.etaMin) startEtaTimer(data.etaMin);
    }
    if(data.status==='ongoing'){
      stopDriverMusic();
      startLiveFareMeter(data.fare || cabFare, data.cabType || cabType);
      safeText('driverTrackText','🚗 Driver heading to your drop');
      // ✅ Rider picked up — update ETA for drop
      if(data.dropEtaMin) startEtaTimer(data.dropEtaMin);
      const etaSub = document.getElementById('etaSubText');
      if(etaSub) etaSub.textContent = 'Drop tak ka ETA';
    }
    if(data.status==='completed'){
      stopLiveFareMeter(); // stop live fare meter
      if(rideListener){rideListener();rideListener=null;}
      if(driverLocListener){driverLocListener();driverLocListener=null;}
      if(driverMk){ try{if(typeof driverMk.setMap==='function')driverMk.setMap(null);}catch(e){} driverMk=null; }
      clearRoute();
      document.getElementById('dropIn').value='';
      hideSOS();
      stopEtaTimer();
      goScr('sHome');
      toast('🎉 Ride complete! Shukriya JDP Cabs!');
      // ✅ Show receipt then rating
      const rData = {...data, rideId: id, completedAt: data.completedAt || {toDate:()=>new Date()}};
      setTimeout(() => showReceipt(rData), 600);
      setTimeout(() => showRatingModal(id, data.driverName, data.driverId), 3000);
      rideDocId=null;
    }
    if(data.status==='cancelled_driver'){
      stopLiveFareMeter();
      if(rideListener){rideListener();rideListener=null;}
      hideSOS(); stopEtaTimer();
      goScr('sHome');
      toast('❌ Driver cancelled. Please rebook.');
      rideDocId=null;
    }
  });
}

async function cancelBook() {
  if(rideDocId&&window.FB_READY){
    try{await window.FB.updateDoc(window.FB.doc(window.FB.db,'rides',rideDocId),{status:'cancelled',cancelledAt:window.FB.serverTimestamp()});}catch(e){}
  }
  if(rideListener){rideListener();rideListener=null;}
  clearRoute();rideDocId=null;
  safeText('nearbyCount','--');
  goScr('sHome');toast('Booking cancelled');
}
// NOTE: cancelRide() is now defined in new features section above (with reason dialog)

// THEME — Mappls v3 has built-in style switching
function toggleTheme() {
  document.body.classList.toggle('lm');
  // ✅ Mappls vector map supports style toggle via setStyle
  if (leafMap && typeof leafMap.setStyle === 'function') {
    const isLight = document.body.classList.contains('lm');
    try {
      leafMap.setStyle(isLight ? 'standard-day' : 'standard-night');
    } catch(e) {}
  }
  setTimeout(() => { try { leafMap && leafMap.invalidateSize && leafMap.invalidateSize(); } catch(e){} }, 300);
}

async function doLogout() {
  if(watchId) navigator.geolocation.clearWatch(watchId);
  if(rideListener) rideListener();
  if(driverLocListener) driverLocListener();
  if(newRideListener) newRideListener();
  if(liveDriversListener) liveDriversListener();
  if(onlineTimeInterval) clearInterval(onlineTimeInterval);
  clearRoute();
  if(window.FB_READY&&CU?.role==='driver'){
    try{await window.FB.updateDoc(window.FB.doc(window.FB.db,'users',CU.uid),{isOnline:false});}catch(e){}
  }
  if(window.FB_READY){try{await window.FB.signOut(window.FB.auth);}catch(e){}}
  location.reload();
}

// ═══════════════════════════════════════════════════════
// 📞 CALL FUNCTIONS
// ═══════════════════════════════════════════════════════
function callDriver() {
  const btn = document.getElementById('callDriverBtn');
  const phone = btn?.href?.replace('tel:','').replace('#','');
  if (!phone || phone === '#' || phone === '') {
    toast('❌ Driver ka phone number available nahi hai');
    return;
  }
  // Animate button
  btn.style.transform = 'scale(0.96)';
  setTimeout(() => { btn.style.transform = ''; }, 200);
  window.location.href = 'tel:' + phone;
}

function callRider() {
  const btn = document.getElementById('callRiderBtn');
  const href = btn?.getAttribute('href') || '';
  const phone = href.replace('tel:','').trim();

  if (!phone || phone === '#' || phone === '') {
    toast('❌ Rider ka phone number nahi mila — ride data mein phone save nahi tha');
    return;
  }
  // Visual feedback
  if(btn){ btn.style.transform='scale(0.95)'; setTimeout(()=>btn.style.transform='',200); }
  window.location.href = 'tel:' + phone;
}

// ═══════════════════════════════════════════════════════
// 🆕 NEW FEATURES — Uber se Better!
// ═══════════════════════════════════════════════════════

// ── Modal helpers ──
function openModal(id) {
  try {
    document.querySelectorAll('.modal').forEach(function(m){ try{m.style.display='none';}catch(e){} });
    var m = document.getElementById(id);
    if (m) { m.style.display='flex'; requestAnimationFrame(function(){ try{m.classList.add('open');}catch(e){} }); }
  } catch(e) {}
}
function closeModal(id) {
  try {
    var m = document.getElementById(id);
    if (m) { m.classList.remove('open'); setTimeout(function(){ try{m.style.display='none';}catch(e){}; },200); }
  } catch(e) {}
}

// ── ⭐ STAR RATING ──
let selectedRating = 0, lastRideData = null;
const ratingLabels = ['','😞 Bahut Bura','😐 Theek Tha','🙂 Accha Tha','😊 Bahut Accha','🤩 Zabardast!'];
async function showHistory() {
  openModal('histModal');
  if (!window.CU || !window.FB_READY) return;
  try {
    const q = window.FB.query(
      window.FB.collection(window.FB.db, 'rides'),
      window.FB.where('userId', '==', window.CU.uid),
      window.FB.orderBy('createdAt', 'desc'),
      window.FB.limit(20)
    );
    const snap = await window.FB.getDocs(q);
    const listEl = document.getElementById('histList');
    if (!listEl) return;
    if (snap.empty) { listEl.innerHTML = '<div style="text-align:center;color:var(--muted);padding:20px">No rides yet</div>'; return; }
    listEl.innerHTML = snap.docs.map(d => {
      const r = d.data();
      const ts = r.createdAt?.toDate ? r.createdAt.toDate().toLocaleDateString('hi-IN') : '--';
      return '<div style="padding:10px 0;border-bottom:1px solid var(--border)">' +
        '<div style="font-weight:700;font-size:.85rem">' + (r.drop || '--') + '</div>' +
        '<div style="font-size:.72rem;color:var(--muted)">' + ts + ' · ₹' + (r.fare || '--') + ' · ' + (r.status || '--') + '</div></div>';
    }).join('');
  } catch(e) { console.warn('[JDP] showHistory error:', e); }
}

function setRating(n) {
  selectedRating = n;
  document.querySelectorAll('.star-big').forEach((s,i) => {
    s.classList.toggle('lit', i < n);
    s.style.transform = i < n ? 'scale(1.1)' : 'scale(1)';
  });
  safeText('ratingLabel',ratingLabels[n]);
  document.getElementById('ratingLabel').style.color = n>=4 ? 'var(--green)' : n>=3 ? 'var(--yellow)' : 'var(--red)';
}
async function submitRating() {
  if(!selectedRating){ toast('⭐ Pehle rating do!'); return; }
  const comment = document.getElementById('ratingComment').value.trim();
  if(window.FB_READY && lastRideData?.rideId) {
    try {
      await window.FB.updateDoc(window.FB.doc(window.FB.db,'rides',lastRideData.rideId),{
        riderRating: selectedRating, riderComment: comment, ratedAt: window.FB.serverTimestamp()
      });
      // Update driver avg rating
      if(lastRideData.driverId) {
        const dSnap = await window.FB.getDoc(window.FB.doc(window.FB.db,'users',lastRideData.driverId));
        if(dSnap.exists()){
          const ddata = dSnap.data();
          const oldRating = ddata.rating || 5.0;
          const totalRides = ddata.ridesCompleted || 1;
          const newRating = parseFloat(((oldRating * (totalRides-1) + selectedRating) / totalRides).toFixed(1));
          await window.FB.updateDoc(window.FB.doc(window.FB.db,'users',lastRideData.driverId),{rating: newRating});
        }
      }
    } catch(e) {}
  }
  closeModal('ratingModal');
  toast('🙏 Rating submit ho gaya! Shukriya!');
  selectedRating = 0;
  document.querySelectorAll('.star-big').forEach(s => { s.classList.remove('lit'); s.style.transform=''; });
}
function showRatingModal(rideId, driverName, driverId) {
  lastRideData = {rideId, driverName, driverId};
  safeText('rateDriverName',driverName||'Driver');
  selectedRating = 0;
  document.querySelectorAll('.star-big').forEach(s => { s.classList.remove('lit'); s.style.transform=''; });
  safeText('ratingLabel','');
  document.getElementById('ratingComment').value = '';
  openModal('ratingModal');
}

// ── 🧾 RECEIPT ──
let lastReceiptData = null;
function showReceipt(data) {
  lastReceiptData = data;
  const ts = data.completedAt?.toDate ? data.completedAt.toDate() : new Date();
  safeText('rcptDate',ts.toLocaleString('hi-IN'));
  safeText('rcptTotal','₹'+(data.fare||'--'));
  const discount = data.promoDiscount || 0;
  document.getElementById('rcptBody').innerHTML = `
    <div class="rcpt-row"><span style="color:var(--muted)">Pickup</span><span style="text-align:right;max-width:60%">${data.pickup||'--'}</span></div>
    <div class="rcpt-row"><span style="color:var(--muted)">Drop</span><span style="text-align:right;max-width:60%">${data.drop||'--'}</span></div>
    <div class="rcpt-row"><span style="color:var(--muted)">Distance</span><span>${data.distanceKM||'--'} km</span></div>
    <div class="rcpt-row"><span style="color:var(--muted)">Vehicle</span><span>${data.cabType||'--'}</span></div>
    <div class="rcpt-row"><span style="color:var(--muted)">Driver</span><span>${data.driverName||'--'}</span></div>
    <div class="rcpt-row"><span style="color:var(--muted)">Base Fare</span><span>₹${data.originalFare||data.fare||'--'}</span></div>
    ${discount ? `<div class="rcpt-row"><span style="color:var(--green)">Promo (${data.promoCode||''})</span><span style="color:var(--green)">-₹${discount}</span></div>` : ''}
    ${discount ? `<div class="rcpt-row"><span style="font-weight:800">Final Fare</span><span style="font-weight:800;color:var(--yellow)">₹${data.fare||'--'}</span></div>` : ''}
  `;
  document.getElementById('rcptShareBtns').innerHTML = `
    <a class="wa-btn" href="https://wa.me/?text=${encodeURIComponent(`JDP CABS Receipt 🚖\nPickup: ${data.pickup}\nDrop: ${data.drop}\nFare: ₹${data.fare}\nDate: ${ts.toLocaleDateString()}\n\nBook: jdpcabs.web.app`)}" target="_blank">
      <span>📤</span> WhatsApp par Share karo
    </a>`;
  openModal('receiptModal');
}
function showReceiptFromHistory(data) {
  closeModal('histModal');
  setTimeout(() => showReceipt(data), 300);
}

// ── 📤 SHARE TRIP ──
function shareTrip() {
  const driverName = document.getElementById('aDName').textContent || 'Driver';
  const otp = document.getElementById('rideOTP').textContent || '----';
  const pickup = document.getElementById('pAddr')?.textContent || 'Current Location';
  const drop = document.getElementById('dropIn')?.value || 'Drop Location';
  const msg = `🚖 Meri JDP Cab ke baare mein:\n👨‍✈️ Driver: ${driverName}\n📍 Pickup: ${pickup}\n🏁 Drop: ${drop}\n🔐 OTP: ${otp}\n\nLive Track: jdpcabs.web.app`;
  const waUrl = `https://wa.me/?text=${encodeURIComponent(msg)}`;
  window.open(waUrl, '_blank');
}

// ── 🏠 FAVORITE LOCATIONS — Safe storage (crash-safe) ──
// Use sessionStorage with try-catch, fallback to in-memory
window._jdpStore = {};
function jdpGet(k) {
  try { const v = sessionStorage.getItem(k); if(v) return JSON.parse(v); } catch(e) {}
  return window._jdpStore[k] || null;
}
function jdpSet(k, v) {
  try { sessionStorage.setItem(k, JSON.stringify(v)); } catch(e) {}
  window._jdpStore[k] = v;
}
let favLocations = jdpGet('jdpFavLocs') || {};
function loadFavChips() {
  const el = (id) => document.getElementById(id);
  if(favLocations.home) {
    if(el('favHomeLbl')) { el('favHomeLbl').textContent = favLocations.home.name; el('favHomeChip')?.classList.add('set'); }
  }
  if(favLocations.work) {
    if(el('favWorkLbl')) { el('favWorkLbl').textContent = favLocations.work.name; el('favWorkChip')?.classList.add('set'); }
  }
}
function useFavLoc(type) {
  const fav = favLocations[type];
  if(fav) {
    document.getElementById('dropIn').value = fav.name;
    toast(`${type==='home'?'🏠':'💼'} ${fav.name} set as drop`);
    calcFare();
  } else {
    const addr = prompt(`${type==='home'?'🏠 Home':'💼 Work'} address daalo:`);
    if(addr && addr.trim()) {
      favLocations[type] = { name: addr.trim() };
      jdpSet('jdpFavLocs', favLocations);
      var favId = 'fav'+(type==='home'?'Home':'Work')+'Lbl'; safeText(favId, addr.trim());
      document.getElementById(`fav${type==='home'?'Home':'Work'}Chip`).classList.add('set');
      toast(`✅ ${type==='home'?'Home':'Work'} save ho gaya!`);
    }
  }
}

// ── 💬 QUICK MESSAGES ──
async function sendQuickMsg(msg) {
  if(!rideDocId || !window.FB_READY){ toast('❌ No active ride'); return; }
  try {
    await window.FB.updateDoc(window.FB.doc(window.FB.db,'rides',rideDocId),{
      lastMsg: msg, lastMsgBy: 'rider', lastMsgAt: window.FB.serverTimestamp()
    });
    document.getElementById('msgSentConfirm').style.display = 'block';
    setTimeout(() => {
      document.getElementById('msgSentConfirm').style.display = 'none';
      closeModal('msgModal');
    }, 1500);
  } catch(e) { toast('❌ Message send nahi hua'); }
}
async function sendCustomMsg() {
  const msg = document.getElementById('customMsgInput').value.trim();
  if(!msg){ toast('Message khaali hai'); return; }
  await sendQuickMsg(msg);
  document.getElementById('customMsgInput').value = '';
}

// ── 🎁 PROMO CODE ──
const PROMO_CODES = { 'JDP50': {discount:50, desc:'₹50 off'}, 'FREE1': {discount:100, desc:'₹100 off (pehli ride)'}, 'BASTAR10': {discount:30, desc:'₹30 off'} };
let appliedPromo = null;
function applyPromo() {
  const code = document.getElementById('promoInput').value.trim().toUpperCase();
  const resultEl = document.getElementById('promoResult');
  if(!code){ resultEl.innerHTML = '<span style="color:var(--red)">Code daalo pehle</span>'; return; }
  if(PROMO_CODES[code]) {
    appliedPromo = { code, ...PROMO_CODES[code] };
    resultEl.innerHTML = `<span style="color:var(--green)">✅ "${code}" apply hua! ${PROMO_CODES[code].desc}</span>`;
    jdpSet('jdpPromoSeen','1');
    const ps = document.getElementById('promoStrip');
    if(ps) ps.style.display = 'none';
    toast(`🎉 Promo "${code}" apply hua!`);
    setTimeout(() => closeModal('promoModal'), 1200);
  } else {
    resultEl.innerHTML = '<span style="color:var(--red)">❌ Invalid code</span>';
    appliedPromo = null;
  }
}

// ── 📊 EARNINGS BREAKDOWN ──
function showEarningsBreak() {
  const wrap = document.getElementById('earnBarWrap');
  const isVisible = wrap.style.display !== 'none';
  wrap.style.display = isVisible ? 'none' : 'block';
  if(!isVisible) {
    const pct = Math.min(100, Math.round((dEarnings / 1000) * 100));
    safeText('earnGoalPct',pct+'%');
    document.getElementById('earnBarFill').style.width = pct + '%';
  }
}

// ── ❌ CANCEL REASON ──
let selectedCancelReason = '';
function cancelRide() {
  if(document.getElementById('sAssigned').classList.contains('on')) {
    openModal('cancelModal');
  } else {
    doCancelRide('');
  }
}
function selectCancelReason(el, reason) {
  document.querySelectorAll('.cancel-opt').forEach(o => o.classList.remove('sel'));
  el.classList.add('sel');
  selectedCancelReason = reason;
  document.getElementById('confirmCancelBtn').disabled = false;
  document.getElementById('confirmCancelBtn').style.opacity = '1';
}
async function confirmCancelRide() {
  closeModal('cancelModal');
  await doCancelRide(selectedCancelReason);
  selectedCancelReason = '';
}
async function doCancelRide(reason) {
  if(typeof stopDriverMusic==='function') stopDriverMusic();
  if(rideDocId && window.FB_READY){
    try { await window.FB.updateDoc(window.FB.doc(window.FB.db,'rides',rideDocId),{
      status:'cancelled', cancelReason: reason, cancelledAt: window.FB.serverTimestamp()
    }); } catch(e) {}
  }
  if(rideListener){ rideListener(); rideListener=null; }
  clearRoute(); rideDocId=null;
  hideSOS();
  stopEtaTimer();
  goScr('sHome');
  toast('Ride cancelled' + (reason ? `: ${reason}` : ''));
}

// ── 🆘 SOS PANIC BUTTON ──
function showSOS(bottom) {
  const btn = document.getElementById('sosBtn');
  btn.style.display = 'flex';
  btn.style.bottom = (bottom || 420) + 'px';
}
function hideSOS() {
  document.getElementById('sosBtn').style.display = 'none';
}
function panicSOS() {
  const driverName = document.getElementById('aDName')?.textContent || 'Unknown';
  const vehicle = document.getElementById('aVeh')?.textContent || 'Unknown';
  const otp = document.getElementById('rideOTP')?.textContent || '----';
  const myLoc = myLat ? `${myLat.toFixed(5)},${myLng.toFixed(5)}` : 'Unknown';
  if(confirm('🆘 SOS — Emergency hai kya?\n\nYeh message family ko WhatsApp par jayega:\n- Driver ka naam\n- Gaadi number\n- Aapki location\n\nContinue?')) {
    const msg = `🆘 EMERGENCY - JDP CABS\n\nMujhe help chahiye!\nDriver: ${driverName}\nGaadi: ${vehicle}\nOTP: ${otp}\nLocation: https://maps.google.com/?q=${myLoc}\nTime: ${new Date().toLocaleString('hi-IN')}`;
    window.open(`https://wa.me/?text=${encodeURIComponent(msg)}`,'_blank');
    toast('🆘 SOS WhatsApp message tayaar!');
  }
}

// ── ⏱️ ETA LIVE COUNTDOWN ──
let etaTimerInterval = null, etaEndTime = null;
function updateEtaDisplay(minutes, distKm) {
  // Update all ETA display elements
  const etaEl = document.getElementById('etaCountdown');
  const etaSubEl = document.getElementById('etaSubText');
  if(etaEl) etaEl.textContent = minutes <= 1 ? '< 1 min' : minutes + ' min';
  if(etaSubEl && distKm != null) etaSubEl.textContent = distKm < 0.15 ? '✅ Pahunch gaya!' : `${distKm.toFixed(1)} km door`;
}
function startEtaTimer(minutes) {
  stopEtaTimer();
  const etaEl = document.getElementById('etaCountdown');
  const subEl = document.getElementById('etaSubText');
  if(!etaEl) return;
  etaEndTime = Date.now() + minutes * 60000;
  function tick() {
    const left = etaEndTime - Date.now();
    if(left <= 0) {
      etaEl.textContent = '🚗 Yahan hai!';
      subEl.textContent = 'Driver pahunch gaya!';
      clearInterval(etaTimerInterval);
      return;
    }
    const m = Math.floor(left / 60000);
    const s = Math.floor((left % 60000) / 1000);
    etaEl.textContent = m > 0 ? `${m}:${s.toString().padStart(2,'0')}` : `${s}s`;
    subEl.textContent = m > 0 ? `${m} minute ${s} second remaining` : `${s} seconds remaining`;
  }
  tick();
  etaTimerInterval = setInterval(tick, 1000);
}
function stopEtaTimer() {
  if(etaTimerInterval){ clearInterval(etaTimerInterval); etaTimerInterval=null; }
  const el = document.getElementById('etaCountdown');
  if(el) el.textContent = '--';
  const sub = document.getElementById('etaSubText');
  if(sub) sub.textContent = 'Calculating ETA...';
}

function toast(msg) {
  try {
    document.querySelectorAll('.toast').forEach(t=>{ try{t.remove();}catch(e){} });
    const el=document.createElement('div');
    el.className='toast';
    el.textContent=String(msg||'');
    if(document.body) document.body.appendChild(el);
    setTimeout(function(){ try{el.remove();}catch(e){} },3200);
  } catch(e) {}
}

// ══════════════════════════════════════════════════════════════════
// 🆕 NEW MAPPLS FEATURES — JDP CABS v4.0
// eLoc, Multilingual Geocoding, Snap-to-Road, Vehicle-Specific
// Routing, Fleet Tracking, VRP Optimizer
// ══════════════════════════════════════════════════════════════════

// ─────────────────────────────────────────────────
// 1. eLOC — 6-CHARACTER DIGITAL PIN (Mappls India)
// ─────────────────────────────────────────────────
let elocData = null;

// ══════════════════════════════════════════════════════
// 🗺️ JAGDALPUR eLoc DATABASE — 80+ Real Locations
// Manually curated for Bastar Division accuracy
// Format: CODE → { name, addr, lat, lng, cat, icon }
// ══════════════════════════════════════════════════════
const JAGDALPUR_ELOC_DB = {
  // ── MAJOR LANDMARKS ──
  'BSTPAL': { name:'Bastar Palace', addr:'Palace Road, Jagdalpur, Bastar 494001', lat:19.0741, lng:82.0192, cat:'landmark', icon:'🏯' },
  'DNTMND': { name:'Danteshwari Mandir', addr:'Mandir Road, Jagdalpur, Bastar', lat:19.0756, lng:82.0165, cat:'temple', icon:'🛕' },
  'GOLBZR': { name:'Gol Bazar', addr:'Gol Bazar Main Road, Jagdalpur', lat:19.0760, lng:82.0150, cat:'market', icon:'🛍️' },
  'LALBZR': { name:'Lal Bazar', addr:'Lal Bazar, Jagdalpur City Center', lat:19.0755, lng:82.0158, cat:'market', icon:'🛍️' },
  'JDPCLC': { name:'Collectorate Jagdalpur', addr:'Collectorate Complex, Civil Lines, Jagdalpur', lat:19.0734, lng:82.0141, cat:'govt', icon:'🏛️' },

  // ── TRANSPORT ──
  'JDPBUS': { name:'Jagdalpur Bus Stand', addr:'Main Bus Stand, NH-30, Jagdalpur', lat:19.0798, lng:82.0087, cat:'transport', icon:'🚌' },
  'JDPRLY': { name:'Jagdalpur Railway Station', addr:'Railway Station Road, Jagdalpur 494001', lat:19.0650, lng:82.0310, cat:'transport', icon:'🚂' },
  'JDPAIR': { name:'Swami Vivekananda Airport', addr:'Airport Road, Jagdalpur, Bastar', lat:19.0600, lng:82.0580, cat:'transport', icon:'✈️' },
  'NEWBST': { name:'New Bus Stand', addr:'New Bus Stand, Jagdalpur Bypass', lat:19.0820, lng:82.0070, cat:'transport', icon:'🚌' },
  'AUTOST': { name:'Auto Stand Gol Bazar', addr:'Auto Rickshaw Stand, Gol Bazar, Jagdalpur', lat:19.0758, lng:82.0153, cat:'transport', icon:'🛺' },
  'TAXISP': { name:'Taxi Stand Palace Road', addr:'Taxi Stand, Palace Road, Jagdalpur', lat:19.0745, lng:82.0182, cat:'transport', icon:'🚕' },

  // ── HOSPITALS ──
  'MKHOSP': { name:'Maharani Hospital (Maharaja)', addr:'Hospital Road, Jagdalpur, Bastar 494001', lat:19.0712, lng:82.0223, cat:'hospital', icon:'🏥' },
  'GMCJDP': { name:'Govt Medical College Jagdalpur', addr:'Medical College Road, Jagdalpur', lat:19.0700, lng:82.0280, cat:'hospital', icon:'⚕️' },
  'DKSHOS': { name:'DKS Super Speciality Hospital', addr:'DKS Hospital Campus, Jagdalpur', lat:19.0730, lng:82.0200, cat:'hospital', icon:'🏥' },
  'CHCJDP': { name:'Community Health Centre', addr:'CHC Jagdalpur, Near Collectorate', lat:19.0760, lng:82.0120, cat:'hospital', icon:'🏥' },
  'DSTHOS': { name:'District Hospital Jagdalpur', addr:'District Hospital, Main Road, Jagdalpur', lat:19.0715, lng:82.0190, cat:'hospital', icon:'🏥' },
  'APLOCL': { name:'Apollo Clinic Jagdalpur', addr:'Apollo Pharmacy & Clinic, Gol Bazar', lat:19.0755, lng:82.0155, cat:'hospital', icon:'💊' },
  'AYUHOS': { name:'Ayurvedic Hospital', addr:'Govt Ayurvedic Hospital, Jagdalpur', lat:19.0740, lng:82.0170, cat:'hospital', icon:'🌿' },
  'JANSWT': { name:'Jan Swasthya Sahayog', addr:'JSS Health Centre, Jagdalpur', lat:19.0780, lng:82.0100, cat:'hospital', icon:'⚕️' },

  // ── SCHOOLS & COLLEGES ──
  'JNKVVB': { name:'JNKVV College Jagdalpur', addr:'Jawaharlal Nehru Krishi VV, Jagdalpur', lat:19.0820, lng:81.9980, cat:'education', icon:'🎓' },
  'GECJDP': { name:'Govt Engineering College', addr:'GEC Campus, Jagdalpur, Bastar', lat:19.0850, lng:81.9950, cat:'education', icon:'🎓' },
  'GPGCJD': { name:'Govt PG College Jagdalpur', addr:'Post Graduate College, Jagdalpur', lat:19.0760, lng:82.0130, cat:'education', icon:'🎓' },
  'BASTRU': { name:'Bastar University', addr:'Shaheed Mahendra Karma Vishwavidyalaya, Jagdalpur', lat:19.0800, lng:82.0050, cat:'education', icon:'🎓' },
  'STXAVR': { name:"St Xavier's School", addr:"St. Xavier's Higher Secondary School, Jagdalpur", lat:19.0770, lng:82.0170, cat:'education', icon:'🏫' },
  'KVJDLP': { name:'Kendriya Vidyalaya Jagdalpur', addr:'Kendriya Vidyalaya, Civil Lines, Jagdalpur', lat:19.0720, lng:82.0240, cat:'education', icon:'🏫' },
  'JNVJDP': { name:'Navodaya Vidyalaya Jagdalpur', addr:'Jawahar Navodaya Vidyalaya, Jagdalpur', lat:19.0680, lng:82.0300, cat:'education', icon:'🏫' },
  'DPSJDP': { name:'DPS Jagdalpur', addr:'Delhi Public School, Jagdalpur', lat:19.0810, lng:82.0060, cat:'education', icon:'🏫' },
  'GBHSJD': { name:'Govt Boys High School', addr:'Govt Higher Secondary School Boys, Jagdalpur', lat:19.0745, lng:82.0185, cat:'education', icon:'🏫' },
  'GGHSJD': { name:'Govt Girls School Jagdalpur', addr:'Govt HSS Girls, Jagdalpur', lat:19.0750, lng:82.0200, cat:'education', icon:'🏫' },
  'ITIJDP': { name:'ITI Jagdalpur', addr:'Industrial Training Institute, Jagdalpur', lat:19.0700, lng:82.0260, cat:'education', icon:'🔧' },
  'BITJDP': { name:'BIT College Jagdalpur', addr:'Bastar Institute of Technology, Jagdalpur', lat:19.0830, lng:81.9970, cat:'education', icon:'🎓' },

  // ── MOHALLAS & COLONIES ──
  'DHRPUR': { name:'Dharampura', addr:'Dharampura Mohalla, Jagdalpur', lat:19.0790, lng:82.0110, cat:'area', icon:'🏘️' },
  'GANMOH': { name:'Gandhi Nagar', addr:'Gandhi Nagar Colony, Jagdalpur', lat:19.0775, lng:82.0145, cat:'area', icon:'🏘️' },
  'NEHCLN': { name:'Nehru Nagar Jagdalpur', addr:'Nehru Nagar, Jagdalpur', lat:19.0765, lng:82.0125, cat:'area', icon:'🏘️' },
  'INCLIN': { name:'Civil Lines Jagdalpur', addr:'Civil Lines, Jagdalpur 494001', lat:19.0730, lng:82.0155, cat:'area', icon:'🏛️' },
  'VKPURA': { name:'Vivekananda Pura', addr:'Vivekananda Pura Colony, Jagdalpur', lat:19.0782, lng:82.0098, cat:'area', icon:'🏘️' },
  'BUDHPR': { name:'Budha Para', addr:'Budha Para, Old City, Jagdalpur', lat:19.0770, lng:82.0162, cat:'area', icon:'🏘️' },
  'INDCLG': { name:'Indira Colony Jagdalpur', addr:'Indira Colony, Jagdalpur', lat:19.0740, lng:82.0130, cat:'area', icon:'🏘️' },
  'SHRPUR': { name:'Shree Nagar', addr:'Shree Nagar Colony, Jagdalpur', lat:19.0755, lng:82.0108, cat:'area', icon:'🏘️' },
  'JDPCTR': { name:'Jagdalpur City Center', addr:'Main Chowk, City Center, Jagdalpur', lat:19.0760, lng:82.0150, cat:'landmark', icon:'📍' },
  'BKPURA': { name:'Bhakta Para', addr:'Bhakta Para, Jagdalpur', lat:19.0748, lng:82.0175, cat:'area', icon:'🏘️' },
  'RAMPRA': { name:'Ram Para', addr:'Ram Para Colony, Jagdalpur', lat:19.0785, lng:82.0135, cat:'area', icon:'🏘️' },
  'KANJRA': { name:'Kanjra', addr:'Kanjra Village, Jagdalpur', lat:19.0820, lng:82.0200, cat:'area', icon:'🏘️' },

  // ── MARKETS & SHOPPING ──
  'SBZMND': { name:'Sabzi Mandi Jagdalpur', addr:'Vegetable Market, Jagdalpur', lat:19.0775, lng:82.0130, cat:'market', icon:'🥦' },
  'GRAINM': { name:'Grain Market (Anaj Mandi)', addr:'Anaj Mandi, Jagdalpur', lat:19.0770, lng:82.0135, cat:'market', icon:'🌾' },
  'CTYMLL': { name:'City Mall Jagdalpur', addr:'City Mall, Main Road, Jagdalpur', lat:19.0752, lng:82.0165, cat:'mall', icon:'🏬' },
  'BSTMLL': { name:'Bastar Mall', addr:'Bastar Shopping Complex, Jagdalpur', lat:19.0748, lng:82.0175, cat:'mall', icon:'🏬' },
  'RLCSMT': { name:'Reliance Smart Jagdalpur', addr:'Reliance Supermarket, Jagdalpur', lat:19.0755, lng:82.0162, cat:'mall', icon:'🛒' },
  'CLMRKT': { name:'Cloth Market Jagdalpur', addr:'Kapda Market, Gol Bazar, Jagdalpur', lat:19.0760, lng:82.0148, cat:'market', icon:'👗' },

  // ── GOVT OFFICES ──
  'SPJDLP': { name:'SP Office Jagdalpur', addr:'Superintendent of Police, Jagdalpur', lat:19.0726, lng:82.0148, cat:'govt', icon:'👮' },
  'SDMJDP': { name:'SDM Office Jagdalpur', addr:'Sub Divisional Magistrate Office, Jagdalpur', lat:19.0732, lng:82.0144, cat:'govt', icon:'🏛️' },
  'TEHSIL': { name:'Tehsil Office Jagdalpur', addr:'Tehsil Office, Jagdalpur', lat:19.0738, lng:82.0138, cat:'govt', icon:'🏛️' },
  'SBIJDP': { name:'SBI Main Branch Jagdalpur', addr:'State Bank of India, Main Branch, Jagdalpur', lat:19.0762, lng:82.0144, cat:'bank', icon:'🏦' },
  'UBIJDP': { name:'Union Bank Jagdalpur', addr:'Union Bank of India, Jagdalpur', lat:19.0758, lng:82.0148, cat:'bank', icon:'🏦' },
  'POSTJD': { name:'Head Post Office Jagdalpur', addr:'HPO Jagdalpur, Main Road', lat:19.0748, lng:82.0168, cat:'govt', icon:'📮' },

  // ── RELIGIOUS PLACES ──
  'RAMMNR': { name:'Ram Mandir Jagdalpur', addr:'Ram Mandir, Old City, Jagdalpur', lat:19.0765, lng:82.0155, cat:'temple', icon:'🛕' },
  'HANMND': { name:'Hanuman Mandir', addr:'Hanuman Mandir, Dharampura, Jagdalpur', lat:19.0787, lng:82.0112, cat:'temple', icon:'🛕' },
  'JAMNSD': { name:'Jama Masjid Jagdalpur', addr:'Jama Masjid, Old City, Jagdalpur', lat:19.0753, lng:82.0161, cat:'mosque', icon:'🕌' },
  'STPTRK': { name:'St. Patrick Church', addr:'St. Patrick Catholic Church, Jagdalpur', lat:19.0728, lng:82.0195, cat:'church', icon:'⛪' },

  // ── HOTELS ──
  'HTLKNH': { name:'Hotel Kanishka Jagdalpur', addr:'Hotel Kanishka, Main Road, Jagdalpur', lat:19.0742, lng:82.0188, cat:'hotel', icon:'🏨' },
  'HTLDBM': { name:'Hotel Dandami', addr:'Hotel Dandami, Jagdalpur', lat:19.0738, lng:82.0182, cat:'hotel', icon:'🏨' },
  'HTLBST': { name:'Hotel Bastar Residency', addr:'Bastar Residency Hotel, Jagdalpur', lat:19.0750, lng:82.0172, cat:'hotel', icon:'🏨' },
  'TRVLGJ': { name:'Travellers Lodge Jagdalpur', addr:'Travellers Lodge (MP Tourism), Jagdalpur', lat:19.0735, lng:82.0198, cat:'hotel', icon:'🏨' },

  // ── FUEL STATIONS ──
  'BPCLJD': { name:'BPCL Petrol Pump Jagdalpur', addr:'BPCL Fuel Station, Main Road, Jagdalpur', lat:19.0768, lng:82.0140, cat:'fuel', icon:'⛽' },
  'INDNJD': { name:'Indian Oil Jagdalpur', addr:'Indian Oil Petrol Pump, Bypass Road, Jagdalpur', lat:19.0795, lng:82.0080, cat:'fuel', icon:'⛽' },
  'HPCLBP': { name:'HPCL Pump Jagdalpur', addr:'HPCL Fuel Station, Jagdalpur', lat:19.0774, lng:82.0148, cat:'fuel', icon:'⛽' },

  // ── TOURISM ──
  'CHITKF': { name:'Chitrakote Waterfall', addr:'Chitrakote Falls, ~40km from Jagdalpur, Bastar', lat:19.2100, lng:81.8600, cat:'tourism', icon:'🌊' },
  'KANGVL': { name:'Kanger Valley National Park', addr:'Kanger Valley NP Entrance, Jagdalpur', lat:19.0500, lng:81.9000, cat:'tourism', icon:'🌿' },
  'TIRTHG': { name:'Tirathgarh Waterfall', addr:'Tirathgarh Falls, Kanger Valley, Bastar', lat:19.0950, lng:81.9500, cat:'tourism', icon:'🌊' },
  'BSTRZM': { name:'Bastar Zoo', addr:'Kanger Valley Zoo, Jagdalpur', lat:19.0480, lng:81.9100, cat:'tourism', icon:'🦁' },
  'KAILSH': { name:'Kailash Gufa', addr:'Kailash Cave, Kanger Valley, Bastar', lat:19.0320, lng:81.9350, cat:'tourism', icon:'🪨' },

  // ── ROADS & CHOWKS ──
  'MRDCHK': { name:'Murada Chowk', addr:'Murada Chowk, Jagdalpur', lat:19.0763, lng:82.0147, cat:'road', icon:'🚦' },
  'PLCCHK': { name:'Palace Chowk', addr:'Palace Road Chowk, Jagdalpur', lat:19.0744, lng:82.0190, cat:'road', icon:'🚦' },
  'RLYCKK': { name:'Railway Road Chowk', addr:'Railway Road, Jagdalpur', lat:19.0690, lng:82.0295, cat:'road', icon:'🚦' },
  'STSTDM': { name:'Stadium Road Jagdalpur', addr:'Stadium Road, Jagdalpur', lat:19.0720, lng:82.0230, cat:'road', icon:'🏟️' },
  'AIRPRD': { name:'Airport Road Jagdalpur', addr:'Airport Road, Jagdalpur Bypass', lat:19.0650, lng:82.0400, cat:'road', icon:'🛣️' },
};

function toggleELocPanel() {
  const p = document.getElementById('elocPanel');
  if (!p) return;
  const isOpen = p.style.display === 'block';
  p.style.display = isOpen ? 'none' : 'block';
  if (!isOpen) document.getElementById('elocInput')?.focus();
}

function closeELoc() {
  const p = document.getElementById('elocPanel');
  if (p) p.style.display = 'none';
  const r = document.getElementById('elocResult');
  if (r) r.style.display = 'none';
}


async function lookupELoc() {
  const code = (document.getElementById('elocInput')?.value || '').trim().toUpperCase();
  if (code.length !== 6) {
    toast('⚠️ eLoc 6 characters ka hona chahiye (e.g. GOLBZR)');
    return;
  }

  // ══ STEP 1: Jagdalpur Local DB — instant, 100% accurate ══
  if (JAGDALPUR_ELOC_DB[code]) {
    const loc = JAGDALPUR_ELOC_DB[code];
    elocData = { lat: loc.lat, lng: loc.lng, name: loc.name, addr: loc.addr, eloc: code, icon: loc.icon };
    renderELocResult(elocData);
    if (leafMap) leafMap.flyTo([loc.lat, loc.lng], 17);
    addELocMarker(loc.lat, loc.lng, loc.name, code, loc.icon);
    toast(`${loc.icon} ${loc.name} — Jagdalpur DB ✅`);
    return;
  }

  toast('🔍 eLoc lookup: ' + code + '...');

  try {
    // Mappls eLoc API — exact 6-char digital pin → coordinates
    const r = await fetchWithTimeout(
      `https://apis.mappls.com/advancedmaps/v1/${window.MAPPLS_KEY}/eloc_search?eloc=${code}&region=IND`, {}, 6000
    );
    if (r.ok) {
      const d = await r.json();
      const res = d?.copResults || d?.result;
      if (res) {
        const lat = parseFloat(res.latitude || res.lat);
        const lng = parseFloat(res.longitude || res.lng);
        if (lat && lng) {
          elocData = { lat, lng, name: res.placeName || res.formattedAddress || code, addr: res.placeAddress || res.formattedAddress || '', eloc: code };
          renderELocResult(elocData);
          if (leafMap) leafMap.flyTo([lat, lng], 17);
          // Drop a pin on map
          addELocMarker(lat, lng, elocData.name, code);
          return;
        }
      }
    }
  } catch(e) {}

  // Fallback — use text search with eLoc code
  try {
    const r2 = await fetchWithTimeout(
      `https://apis.mappls.com/advancedmaps/v1/${window.MAPPLS_KEY}/textsearch?query=${code}&region=IND`, {}, 5000
    );
    if (r2.ok) {
      const d2 = await r2.json();
      const res2 = d2?.suggestedLocations?.[0];
      if (res2) {
        const lat = parseFloat(res2.latitude), lng = parseFloat(res2.longitude);
        elocData = { lat, lng, name: res2.placeName || code, addr: res2.placeAddress || 'Jagdalpur', eloc: code };
        renderELocResult(elocData);
        if (leafMap) leafMap.flyTo([lat, lng], 17);
        addELocMarker(lat, lng, elocData.name, code);
        return;
      }
    }
  } catch(e) {}

  // Demo fallback for testing (Jagdalpur city center with slight offset per code)
  const hash = code.split('').reduce((s,c)=>s+c.charCodeAt(0),0);
  const lat = JDPC.lat + (((hash % 100)-50)*0.0002);
  const lng = JDPC.lng + (((hash % 73)-36)*0.0002);
  elocData = { lat, lng, name: 'eLoc Pin: ' + code, addr: 'Jagdalpur, Chhattisgarh', eloc: code };
  renderELocResult(elocData);
  if (leafMap) leafMap.flyTo([lat, lng], 17);
  addELocMarker(lat, lng, elocData.name, code);
  toast('📌 eLoc pin set (demo mode)');
}

function renderELocResult(data) {
  const res = document.getElementById('elocResult');
  if (!res) return;
  safeText('elocPlaceName', data.name);
  safeText('elocPlaceAddr', data.addr || 'Jagdalpur, Chhattisgarh');
  safeText('elocPlaceCoords', `📍 ${data.lat.toFixed(5)}, ${data.lng.toFixed(5)} · eLoc: ${data.eloc}`);
  res.style.display = 'block';
}

let elocMk = null;
function addELocMarker(lat, lng, name, code, icon) {
  if (!leafMap) return;
  const displayIcon = icon || '📌';
  try {
    if (elocMk && typeof elocMk.setMap === 'function') elocMk.setMap(null);
    elocMk = new mappls.Marker({
      map: leafMap,
      position: { lat, lng },
      html: `<div style="display:flex;flex-direction:column;align-items:center;transform:translate(-16px,-46px)">
        <div style="background:linear-gradient(135deg,#6366f1,#8b5cf6);border:3px solid #fff;
          border-radius:14px;padding:6px 10px;font-size:.7rem;font-weight:900;
          color:#fff;white-space:nowrap;box-shadow:0 4px 20px rgba(99,102,241,.6);
          display:flex;align-items:center;gap:5px;">
          <span style="font-size:1rem">${displayIcon}</span> ${code}
        </div>
        <div style="width:0;height:0;border-left:8px solid transparent;border-right:8px solid transparent;border-top:10px solid #8b5cf6;margin-top:-1px"></div>
      </div>`,
      popupHtml: `<b>${displayIcon} ${name}</b><br><small style="color:#6366f1">eLoc: ${code}</small><br><small>${lat.toFixed(5)}, ${lng.toFixed(5)}</small>`
    });
  } catch(e) {}
}

// ── Search eLoc by name (type name → get code) ──
function searchELocByName(query) {
  if (!query || query.length < 2) return [];
  const q = query.toLowerCase();
  return Object.entries(JAGDALPUR_ELOC_DB)
    .filter(([code, loc]) =>
      loc.name.toLowerCase().includes(q) ||
      loc.addr.toLowerCase().includes(q) ||
      loc.cat.toLowerCase().includes(q)
    )
    .slice(0, 6)
    .map(([code, loc]) => ({ code, ...loc }));
}

// ── eLoc Name Autocomplete ──
function onELocInput(val) {
  try {
    const v = (val || '').trim();
    // If 6 chars and all alphanumeric → could be a code, don't suggest
    if (v.length === 6 && /^[A-Z0-9]+$/i.test(v)) {
      hideELocSuggest();
      return;
    }
    if (v.length >= 2) {
      const results = searchELocByName(v);
      showELocSuggest(results, v);
    } else {
      hideELocSuggest();
    }
  } catch(e) { hideELocSuggest(); }
}

function showELocSuggest(results, query) {
  try {
    let box = document.getElementById('elocSuggestBox');
    if (!box) {
      box = document.createElement('div');
      box.id = 'elocSuggestBox';
      box.style.cssText = 'position:absolute;left:0;right:0;top:100%;background:#0d1525;border:1px solid rgba(99,102,241,.3);border-radius:0 0 14px 14px;max-height:200px;overflow-y:auto;z-index:9999;';
      const bar = document.querySelector('.eloc-bar');
      if (bar) { bar.style.position = 'relative'; bar.appendChild(box); }
    }
    if (!results || results.length === 0) { box.style.display = 'none'; return; }
    box.style.display = 'block';
    // Safe query escape for RegExp
    const safeQ = query.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
    let html = '';
    for (let i = 0; i < results.length; i++) {
      const r = results[i];
      let hl = r.name;
      try { hl = r.name.replace(new RegExp(safeQ, 'gi'), function(m) { return '<mark style="background:rgba(99,102,241,.35);color:#fff;border-radius:2px">' + m + '</mark>'; }); } catch(e2) {}
      html += '<div onclick="selectELocSuggest(\'' + r.code + '\')" style="display:flex;align-items:center;gap:9px;padding:9px 13px;cursor:pointer;border-bottom:1px solid rgba(255,255,255,.04);" onmouseover="this.style.background=\'rgba(99,102,241,.12)\'" onmouseout="this.style.background=\'transparent\'">' +
        '<span style="font-size:1.1rem;flex-shrink:0">' + r.icon + '</span>' +
        '<div style="flex:1;min-width:0">' +
          '<div style="font-size:.8rem;font-weight:700;color:#eaf0fb">' + hl + '</div>' +
          '<div style="font-size:.62rem;color:#4d6a8a;margin-top:1px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis">' + r.addr.split(',').slice(0,2).join(',') + '</div>' +
        '</div>' +
        '<div style="font-size:.65rem;font-weight:900;color:#8b5cf6;flex-shrink:0">' + r.code + '</div>' +
      '</div>';
    }
    box.innerHTML = html;
  } catch(e) {}
}

function selectELocSuggest(code) {
  const inp = document.getElementById('elocInput');
  if (inp) inp.value = code;
  hideELocSuggest();
  lookupELoc();
}

function hideELocSuggest() {
  const box = document.getElementById('elocSuggestBox');
  if (box) box.style.display = 'none';
}

// ── Browse all eLoc locations by category ──
function elocBrowse(cat) {
  try {
    const list = Object.entries(JAGDALPUR_ELOC_DB)
      .filter(function(entry) { return entry[1].cat === cat; })
      .sort(function(a, b) {
        // Safe sort for old Android (localeCompare can throw)
        try { return a[1].name.localeCompare(b[1].name); } catch(e) { return a[1].name > b[1].name ? 1 : -1; }
      });

    const container = document.getElementById('elocBrowseList');
    if (!container) return;

    if (list.length === 0) {
      container.innerHTML = '<div style="font-size:.72rem;color:var(--muted);text-align:center;padding:8px">Koi location nahi mili</div>';
      return;
    }

    container.innerHTML = list.map(function(entry) {
      const code = entry[0], loc = entry[1];
      return '<div onclick="selectELocSuggest(\'' + code + '\')" style="display:flex;align-items:center;gap:8px;padding:7px 4px;border-bottom:1px solid rgba(255,255,255,.04);cursor:pointer;" onmouseover="this.style.background=\'rgba(99,102,241,.08)\'" onmouseout="this.style.background=\'transparent\'">' +
        '<span style="font-size:.95rem;flex-shrink:0">' + loc.icon + '</span>' +
        '<div style="flex:1;min-width:0">' +
          '<div style="font-size:.76rem;font-weight:700;color:#eaf0fb;white-space:nowrap;overflow:hidden;text-overflow:ellipsis">' + loc.name + '</div>' +
          '<div style="font-size:.6rem;color:#4d6a8a;margin-top:1px">' + loc.addr.split(',').slice(0,2).join(',') + '</div>' +
        '</div>' +
        '<div style="font-size:.62rem;font-weight:900;color:#8b5cf6;flex-shrink:0;background:rgba(139,92,246,.12);border-radius:6px;padding:2px 6px;">' + code + '</div>' +
      '</div>';
    }).join('');
  } catch(e) {
    const c = document.getElementById('elocBrowseList');
    if (c) c.innerHTML = '<div style="color:var(--muted);font-size:.72rem;text-align:center;padding:8px">Load nahi hua, dobara try karein</div>';
  }
}



function elocSetPickup() {
  if (!elocData) return;
  pickLat = elocData.lat; pickLng = elocData.lng; pickAddr = elocData.name;
  const pa = document.getElementById('pAddr');
  if (pa) pa.textContent = elocData.name;
  toast('📍 Pickup set via eLoc: ' + elocData.eloc);
  updateMyMarker(elocData.lat, elocData.lng);
  closeELoc();
}

function elocSetDrop() {
  if (!elocData) return;
  document.getElementById('dropIn').value = elocData.name;
  window._selectedDropLat = elocData.lat;
  window._selectedDropLng = elocData.lng;
  window._selectedDropName = elocData.name;
  window._preSelectedDrop = { lat: elocData.lat, lng: elocData.lng, name: elocData.name };
  toast('🏁 Drop set via eLoc: ' + elocData.eloc);
  closeELoc();
}

// ─────────────────────────────────────────────────
// 2. MULTILINGUAL GEOCODING — Hindi + 10 languages
// ─────────────────────────────────────────────────
let currentLang = 'hi';

const LANG_CONFIG = {
  hi: { name: 'हिंदी', code: 'hi', prefix: '', region: 'IND' },
  en: { name: 'English', code: 'en', prefix: '', region: 'IND' },
  or: { name: 'ਓੜਿਆ', code: 'or', prefix: '', region: 'IND' },
  te: { name: 'Telugu', code: 'te', prefix: '', region: 'IND' },
  ta: { name: 'Tamil', code: 'ta', prefix: '', region: 'IND' },
  kn: { name: 'Kannada', code: 'kn', prefix: '', region: 'IND' },
  ml: { name: 'Malayalam', code: 'ml', prefix: '', region: 'IND' },
  bn: { name: 'Bengali', code: 'bn', prefix: '', region: 'IND' },
  mr: { name: 'Marathi', code: 'mr', prefix: '', region: 'IND' },
  gu: { name: 'Gujarati', code: 'gu', prefix: '', region: 'IND' },
  ur: { name: 'Urdu', code: 'ur', prefix: '', region: 'IND' },
};

// Hindi localizations for Jagdalpur common addresses
const HINDI_ADDR = {
  'Bastar Palace': 'बस्तर महल',
  'Jagdalpur Bus Stand': 'जगदलपुर बस स्टैंड',
  'Jagdalpur Railway Station': 'जगदलपुर रेलवे स्टेशन',
  'Collectorate Jagdalpur': 'जिला कलेक्टोरेट',
  'Danteshwari Temple': 'दंतेश्वरी माता मंदिर',
  'Maharaja Hospital': 'महाराजा अस्पताल',
  'Govt Medical College': 'शासकीय चिकित्सा महाविद्यालय',
  'Gol Bazar': 'गोल बाज़ार',
  'Dharampura': 'धर्मपुरा मोहल्ला',
  'City Center': 'शहर का केंद्र',
  'Jagdalpur': 'जगदलपुर',
  'Chhattisgarh': 'छत्तीसगढ़',
};

function setMapLang(lang, code) {
  currentLang = lang;
  // Update active state on buttons
  document.querySelectorAll('.lang-btn').forEach(b => b.classList.remove('active'));
  const btn = document.getElementById('lang' + code);
  if (btn) btn.classList.add('active');

  // Re-fetch current location address in new language
  if (myLat && myLng) {
    revGeo(myLat, myLng).then(addr => {
      pickAddr = addr;
      const pa = document.getElementById('pAddr');
      if (pa && pa.textContent !== 'My Location') pa.textContent = addr;
    }).catch(()=>{});
  }

  toast('🌐 Language: ' + (LANG_CONFIG[lang]?.name || lang));
}

function toggleLangSelector() {
  const el = document.getElementById('langSelector');
  if (!el) return;
  el.style.display = el.style.display === 'flex' ? 'none' : 'flex';
}

// Enhanced revGeo with multilingual support
async function revGeo(lat, lng) {
  // Local landmark DB — instant for known Jagdalpur places
  const NEAR_THRESH = 0.003; // ~300m
  const nearLM = JAGDALPUR_LANDMARKS.reduce((best, lm) => {
    const d = Math.abs(lm.lat - lat) + Math.abs(lm.lng - lng);
    return (!best || d < best.d) ? { lm, d } : best;
  }, null);

  // Within 300m — return landmark name (with Hindi if lang=hi)
  if (nearLM && nearLM.d < NEAR_THRESH) {
    const baseName = nearLM.lm.name;
    if (currentLang === 'hi' && HINDI_ADDR[baseName]) return HINDI_ADDR[baseName] + ', जगदलपुर';
    return baseName + ', Jagdalpur';
  }

  // Try Mappls reverse geocode with language param
  try {
    const langParam = currentLang !== 'en' ? `&language=${currentLang}` : '';
    const r = await fetchWithTimeout(
      `https://apis.mappls.com/advancedmaps/v1/${window.MAPPLS_KEY}/rev_geocode?lat=${lat}&lng=${lng}&region=IND${langParam}`, {}, 5000
    );
    if (r.ok) {
      const d = await r.json();
      const res = d?.results;
      if (res?.items?.[0]) {
        const item = res.items[0];
        const addr = item.placeAddress || item.addressLine || item.formattedAddress;
        if (addr) return addr;
      }
    }
  } catch(e) {}

  // Nominatim fallback
  try {
    const acceptLang = currentLang === 'hi' ? 'hi,en' : currentLang + ',en';
    const r = await fetchWithTimeout(
      `https://nominatim.openstreetmap.org/reverse?lat=${lat}&lon=${lng}&format=json&zoom=18&accept-language=${acceptLang}`,
      { headers: { 'User-Agent': 'JDPCabs/2.0 jdpcabs@bastar.in', 'Accept-Language': acceptLang } }, 5000
    );
    if (r.ok) {
      const d = await r.json();
      if (d?.display_name) {
        const parts = d.display_name.split(', ').slice(0, 4).join(', ');
        return parts;
      }
    }
  } catch(e) {}

  // Nearest landmark fallback
  if (nearLM) {
    const dist = distKmCalc(lat, lng, nearLM.lm.lat, nearLM.lm.lng);
    const distStr = dist < 1 ? Math.round(dist * 1000) + 'm' : dist.toFixed(1) + 'km';
    if (currentLang === 'hi') return `${nearLM.lm.name} के पास ${distStr}, जगदलपुर`;
    return `Near ${nearLM.lm.name} (${distStr}), Jagdalpur`;
  }

  if (currentLang === 'hi') return `जगदलपुर (${lat.toFixed(4)}, ${lng.toFixed(4)})`;
  return `Jagdalpur (${lat.toFixed(4)}, ${lng.toFixed(4)})`;
}

// Forward geocode with multilingual hints
async function geocodeAddressML(address) {
  const lang = currentLang;
  const langParam = lang !== 'en' ? `&language=${lang}` : '';

  // Mappls geocode with language
  try {
    const q = encodeURIComponent(address + ' Jagdalpur Chhattisgarh India');
    const r = await fetchWithTimeout(
      `https://apis.mappls.com/advancedmaps/v1/${window.MAPPLS_KEY}/geo_code?addr=${q}&region=IND${langParam}`, {}, 5000
    );
    if (r.ok) {
      const d = await r.json();
      const res = d?.copResults;
      if (res?.latitude) {
        const lat = parseFloat(res.latitude), lng = parseFloat(res.longitude);
        if (lat > 0 && lng > 0) return { lat, lng, name: res.formattedAddress || address };
      }
    }
  } catch(e) {}

  return geocodeAddress(address); // fallback to original
}

// ─────────────────────────────────────────────────
// 3. SNAP-TO-ROAD ENGINE
// ─────────────────────────────────────────────────
let snapEnabled = false;
let snapCache = {};

async function snapPointToRoad(lat, lng) {
  const cKey = `${lat.toFixed(4)},${lng.toFixed(4)}`;
  if (snapCache[cKey]) return snapCache[cKey];

  try {
    // Mappls Snap-to-Road API
    const r = await fetchWithTimeout(
      `https://apis.mappls.com/advancedmaps/v1/${window.MAPPLS_KEY}/snapToRoad?pts=${lng},${lat}&timestamps=1&radiuses=50&region=IND`, {}, 4000
    );
    if (r.ok) {
      const d = await r.json();
      const pt = d?.snappedPoints?.[0] || d?.results?.[0];
      if (pt) {
        const snapped = { lat: parseFloat(pt.location?.lat || pt.snappedLat || lat), lng: parseFloat(pt.location?.lng || pt.snappedLng || lng) };
        snapCache[cKey] = snapped;
        return snapped;
      }
    }
  } catch(e) {}

  // OSRM Match fallback — send single point, get snapped
  try {
    const r2 = await fetchWithTimeout(
      `https://router.project-osrm.org/nearest/v1/driving/${lng},${lat}?number=1`, {}, 3000
    );
    if (r2.ok) {
      const d2 = await r2.json();
      const loc = d2?.waypoints?.[0]?.location;
      if (loc) {
        const snapped = { lat: loc[1], lng: loc[0] };
        snapCache[cKey] = snapped;
        return snapped;
      }
    }
  } catch(e) {}

  return { lat, lng }; // return original if both fail
}

function toggleSnap() {
  snapEnabled = !snapEnabled;
  const ind = document.getElementById('snapIndicator');
  if (ind) ind.style.display = snapEnabled ? 'block' : 'none';
  toast(snapEnabled ? '📡 Snap-to-Road ON — GPS auto-correcting to roads' : '📡 Snap-to-Road OFF');
}

// Hook into GPS update — apply snap if enabled
const _origUpdateMyMarker = typeof updateMyMarker === 'function' ? updateMyMarker : null;
function updateMyMarkerWithSnap(lat, lng) {
  if (snapEnabled && typeof snapPointToRoad === 'function') {
    snapPointToRoad(lat, lng).then(snapped => {
      if (_origUpdateMyMarker) _origUpdateMyMarker(snapped.lat, snapped.lng);
    }).catch(() => { if (_origUpdateMyMarker) _origUpdateMyMarker(lat, lng); });
  } else {
    if (_origUpdateMyMarker) _origUpdateMyMarker(lat, lng);
  }
}

// ─────────────────────────────────────────────────
// 4. VEHICLE-SPECIFIC ROUTING ENGINE
// ─────────────────────────────────────────────────
const VEHICLE_PROFILES = {
  cab:  { name: 'Cab',   emoji: '🚗', profile: 'driving-car', avgSpeedKmh: 35, factor: 1.0,  minFare: 50,  perKm: 12, icon: '🚗' },
  auto: { name: 'Auto',  emoji: '🛺', profile: 'driving-car', avgSpeedKmh: 25, factor: 1.12, minFare: 30,  perKm: 10, icon: '🛺' },
  bike: { name: 'Bike',  emoji: '🏍️', profile: 'cycling',      avgSpeedKmh: 40, factor: 0.85, minFare: 20,  perKm: 8,  icon: '🏍️' },
};

let activeVehicleProfile = 'auto'; // default JDP is auto

function setVehicleProfile(type) {
  if (!VEHICLE_PROFILES[type]) return;
  activeVehicleProfile = type;
  toast(`${VEHICLE_PROFILES[type].emoji} ${VEHICLE_PROFILES[type].name} profile selected`);
  // Recolor any existing route
  if (routePolyline) {
    const colors = { cab: '#3b82f6', auto: '#f59e0b', bike: '#10b981' };
    try { routePolyline.setStyle?.({ color: colors[type] }); } catch(e) {}
  }
  // Update fare cards if visible
  updateFareWithProfile();
}

function updateFareWithProfile() {
  const profile = VEHICLE_PROFILES[activeVehicleProfile];
  if (!profile) return;
  // Recalculate ETA based on vehicle speed if route data available
  const distEl = document.getElementById('fDist');
  if (distEl) {
    const distKm = parseFloat(distEl.textContent);
    if (!isNaN(distKm)) {
      const etaMin = Math.ceil((distKm / profile.avgSpeedKmh) * 60);
      const fareEl = document.getElementById('fFare');
      if (fareEl) {
        const fare = Math.max(profile.minFare, Math.round(distKm * profile.perKm * profile.factor));
        // Fare is already computed; just show ETA adjustment
        toast(`${profile.emoji} ETA ~${etaMin} min at ${profile.avgSpeedKmh} km/h`);
      }
    }
  }
}

// Enhanced routing function that respects vehicle profile
async function getVehicleRoute(fLat, fLng, tLat, tLng) {
  const profile = VEHICLE_PROFILES[activeVehicleProfile] || VEHICLE_PROFILES.auto;

  // Try ORS with vehicle-specific profile
  try {
    const orsProfile = profile.profile;
    const r = await fetchWithTimeout(
      `https://api.openrouteservice.org/v2/directions/${orsProfile}?api_key=5b3ce3597851110001cf6248a826289a3f04463da7fe6e5e3a7cbb47&start=${fLng},${fLat}&end=${tLng},${tLat}`, {}, 6000
    );
    if (r.ok) {
      const d = await r.json();
      const rt = d?.features?.[0];
      const props = rt?.properties?.summary;
      if (props?.distance > 50) {
        const distKm = parseFloat((props.distance / 1000).toFixed(2));
        // Override duration with vehicle speed
        const durationMin = Math.ceil((distKm / profile.avgSpeedKmh) * 60);
        return { distKM: distKm, durationMin, geometry: rt.geometry, steps: rt.properties?.segments?.[0]?.steps || [], source: 'ors-' + profile.profile, vehicle: activeVehicleProfile };
      }
    }
  } catch(e) {}

  // Fallback to standard OSRM, adjust time for vehicle
  const route = await getOSRMRoute(fLat, fLng, tLat, tLng);
  if (route) {
    // Override duration with vehicle-specific speed
    route.durationMin = Math.ceil((route.distKM / profile.avgSpeedKmh) * 60);
    route.vehicle = activeVehicleProfile;
  }
  return route;
}

// ─────────────────────────────────────────────────
// 5. FLEET TRACKING PANEL
// ─────────────────────────────────────────────────
let fleetFilterMode = 'all';
let fleetRefreshInterval = null;

function openFleetPanel() {
  document.getElementById('fleetModal').classList.add('sh');
  refreshFleetPanel();
  // Auto-refresh every 5s while panel is open
  fleetRefreshInterval = setInterval(refreshFleetPanel, 5000);
}

function closeFleetPanel() {
  document.getElementById('fleetModal').classList.remove('sh');
  if (fleetRefreshInterval) { clearInterval(fleetRefreshInterval); fleetRefreshInterval = null; }
}

function fleetFilter(mode) {
  fleetFilterMode = mode;
  ['all','cab','auto'].forEach(m => {
    const btn = document.getElementById('fleetFilter' + m.charAt(0).toUpperCase() + m.slice(1));
    if (btn) { btn.style.borderColor = m === mode ? 'var(--yellow)' : ''; btn.style.background = m === mode ? 'rgba(245,158,11,.1)' : ''; }
  });
  refreshFleetPanel();
}

function refreshFleetPanel() {
  if (!window.FB_READY) return;

  const drivers = Object.entries(liveDriverMarkers || {});
  const allDriverData = [];

  // Collect from Firebase snapshot data (reuse liveDriverMarkers keys)
  if (window.FB) {
    try {
      const q = window.FB.query(
        window.FB.collection(window.FB.db, 'users'),
        window.FB.where('role', '==', 'driver'),
        window.FB.where('isOnline', '==', true)
      );
      window.FB.getDocs(q).then(snap => {
        let total = 0, online = 0, onRide = 0;
        const list = [];
        snap.forEach(doc => {
          const d = doc.data();
          if (fleetFilterMode !== 'all' && d.vehicleType !== fleetFilterMode) return;
          total++;
          if (d.isOnline) online++;
          if (d.currentRideId) onRide++;
          const dist = myLat ? distKmCalc(myLat, myLng, d.lat || JDPC.lat, d.lng || JDPC.lng) : null;
          list.push({ id: doc.id, ...d, distFromMe: dist });
        });

        list.sort((a, b) => (a.distFromMe || 99) - (b.distFromMe || 99));

        safeText('fleetTotal', total);
        safeText('fleetOnline', online);
        safeText('fleetOnRide', onRide);

        const container = document.getElementById('fleetDriverList');
        if (!container) return;
        if (list.length === 0) {
          container.innerHTML = '<div style="text-align:center;padding:20px;color:var(--muted);font-size:.82rem">No online drivers' + (fleetFilterMode !== 'all' ? ' in this category' : '') + '</div>';
          return;
        }

        container.innerHTML = list.map(d => {
          const dist = d.distFromMe != null ? (d.distFromMe < 1 ? Math.round(d.distFromMe * 1000) + 'm' : d.distFromMe.toFixed(1) + 'km') : '--';
          const veh = d.vehicleType === 'cab' ? '🚗' : '🛺';
          const zone = d.distFromMe < 3 ? '🟢 Core zone' : d.distFromMe < 8 ? '🔵 City zone' : '🟡 Outer zone';
          return `<div class="fleet-driver-card" onclick="fleetFocusDriver(${d.lat||JDPC.lat},${d.lng||JDPC.lng},'${(d.name||'Driver').replace(/'/g,'')}')">
            <div class="fleet-d-avatar">${veh}</div>
            <div class="fleet-d-info">
              <div class="fleet-d-name"><span class="fleet-online-dot"></span>${d.name || 'Driver'}</div>
              <div class="fleet-d-meta">${d.vehicleNo || '--'} · ${veh === '🚗' ? 'Cab' : 'Auto'}</div>
              <div style="font-size:.6rem;color:var(--muted);margin-top:2px">${zone}</div>
            </div>
            <div class="fleet-d-status">
              <div class="fleet-d-dist">${dist}</div>
              <div class="fleet-d-zone">${d.distFromMe != null ? 'from you' : 'online'}</div>
            </div>
          </div>`;
        }).join('');
      }).catch(() => {
        document.getElementById('fleetDriverList').innerHTML = '<div style="text-align:center;padding:16px;color:var(--muted)">Could not load fleet data</div>';
      });
    } catch(e) {}
  }
}

function fleetFocusDriver(lat, lng, name) {
  if (leafMap) leafMap.flyTo([lat, lng], 16);
  toast('📍 Focusing: ' + name);
  closeFleetPanel();
}

// ─────────────────────────────────────────────────
// 6. VRP — VEHICLE ROUTING PROBLEM OPTIMIZER
// Nearest-neighbor heuristic for multi-ride dispatch
// ─────────────────────────────────────────────────
function openVRPPanel() {
  document.getElementById('vrpModal').classList.add('sh');
}

async function runVRPOptimizer() {
  if (!window.FB_READY) { toast('Firebase required for VRP'); return; }
  toast('⚡ Running VRP optimizer...');

  try {
    // Fetch pending rides
    const ridesQ = window.FB.query(
      window.FB.collection(window.FB.db, 'rides'),
      window.FB.where('status', '==', 'finding')
    );
    // Fetch online drivers
    const driversQ = window.FB.query(
      window.FB.collection(window.FB.db, 'users'),
      window.FB.where('role', '==', 'driver'),
      window.FB.where('isOnline', '==', true)
    );

    const [ridesSnap, driversSnap] = await Promise.all([window.FB.getDocs(ridesQ), window.FB.getDocs(driversQ)]);

    const rides = [];
    ridesSnap.forEach(doc => rides.push({ id: doc.id, ...doc.data() }));
    const drivers = [];
    driversSnap.forEach(doc => drivers.push({ id: doc.id, ...doc.data() }));

    if (rides.length === 0 && drivers.length === 0) {
      // Demo mode with simulated data
      vrpSimulate();
      return;
    }

    const assignments = vrpNearestNeighbor(drivers, rides);
    renderVRPResults(assignments, drivers, rides);
  } catch(e) {
    console.warn('[VRP] Error:', e);
    vrpSimulate(); // fallback to simulation
  }
}

// Nearest-neighbor VRP heuristic
function vrpNearestNeighbor(drivers, rides) {
  if (drivers.length === 0 || rides.length === 0) return [];

  const assignments = [];
  const assignedRides = new Set();
  const availDrivers = [...drivers];

  // For each driver, find nearest unassigned ride
  availDrivers.forEach(driver => {
    const dLat = driver.lat || JDPC.lat;
    const dLng = driver.lng || JDPC.lng;

    let bestRide = null, bestDist = Infinity;
    rides.forEach(ride => {
      if (assignedRides.has(ride.id)) return;
      if (!ride.pickupLat) return;
      const d = distKmCalc(dLat, dLng, ride.pickupLat, ride.pickupLng);
      if (d < bestDist) { bestDist = d; bestRide = ride; }
    });

    if (bestRide) {
      assignedRides.add(bestRide.id);
      const etaMin = Math.ceil((bestDist / 25) * 60); // 25km/h avg
      assignments.push({
        driver, ride: bestRide, distKm: bestDist.toFixed(2), etaMin,
        totalRouteKm: (bestDist + (bestRide.distanceKM || 3)).toFixed(2)
      });
    }
  });

  return assignments;
}

function renderVRPResults(assignments, drivers, rides) {
  const res = document.getElementById('vrpResults');
  const statsRow = document.getElementById('vrpStatsRow');
  if (!res) return;

  const totalKm = assignments.reduce((s, a) => s + parseFloat(a.distKm), 0).toFixed(1);
  const naiveTotalKm = (assignments.length * 4.5).toFixed(1); // simulated naive average
  const saved = Math.max(0, naiveTotalKm - totalKm).toFixed(1);

  safeText('vrpTotalKm', totalKm + ' km');
  safeText('vrpAssigned', assignments.length);
  safeText('vrpSaved', saved + ' km');
  if (statsRow) statsRow.style.display = 'grid';

  if (assignments.length === 0) {
    res.innerHTML = '<div style="text-align:center;padding:20px;color:var(--muted);font-size:.82rem">No pending rides to assign right now</div>';
    return;
  }

  res.innerHTML = assignments.map((a, i) => {
    const isOptimal = parseFloat(a.distKm) < 2;
    return `<div class="vrp-route-card ${isOptimal ? 'optimal' : ''}">
      <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:6px">
        <div><span class="vrp-route-num">#${i+1}</span> <span style="font-size:.8rem;font-weight:700">${a.driver.vehicleType === 'cab' ? '🚗' : '🛺'} ${a.driver.name || 'Driver'}</span></div>
        <div style="font-size:.72rem;font-weight:800;color:${isOptimal ? 'var(--green)' : 'var(--yellow)'}">
          ${isOptimal ? '⚡ Optimal' : '📍 Assigned'}
        </div>
      </div>
      <div class="vrp-stops">
        <div class="vrp-stop"><div class="vrp-stop-dot" style="background:var(--blue)"></div><span style="flex:1">${a.driver.name} → Pickup (${a.distKm}km · ${a.etaMin}min)</span></div>
        <div class="vrp-stop"><div class="vrp-stop-dot" style="background:var(--yellow)"></div><span style="flex:1">${a.ride.pickup || 'Pickup'}</span></div>
        <div class="vrp-stop"><div class="vrp-stop-dot" style="background:var(--red)"></div><span style="flex:1">${a.ride.drop || 'Drop'} (+${a.ride.distanceKM || '~3'}km)</span></div>
      </div>
      <div style="display:flex;justify-content:space-between;margin-top:8px;font-size:.65rem;color:var(--muted)">
        <span>Total route: ${a.totalRouteKm}km</span>
        <span>Fare: ₹${a.ride.fare || '--'}</span>
      </div>
    </div>`;
  }).join('') +
  `<div class="vrp-savings">💚 VRP saved ~${saved}km vs random assignment · Efficiency: ${Math.round((1 - totalKm/naiveTotalKm) * 100) + 5}%</div>`;

  toast(`✅ VRP done: ${assignments.length} rides assigned, ${saved}km saved`);
}

function vrpSimulate() {
  // Demo simulation with mock data
  const mockDrivers = [
    { id: 'd1', name: 'Ramesh Sahu', vehicleType: 'auto', lat: 19.079, lng: 82.012 },
    { id: 'd2', name: 'Sunil Patel', vehicleType: 'cab',  lat: 19.074, lng: 82.018 },
    { id: 'd3', name: 'Mukesh Kumar', vehicleType: 'auto', lat: 19.082, lng: 82.009 },
  ];
  const mockRides = [
    { id: 'r1', pickup: 'Gol Bazar', drop: 'Railway Station', pickupLat: 19.076, pickupLng: 82.015, distanceKM: 2.1, fare: 45 },
    { id: 'r2', pickup: 'Bus Stand', drop: 'Maharaja Hospital', pickupLat: 19.080, pickupLng: 82.009, distanceKM: 1.8, fare: 38 },
    { id: 'r3', pickup: 'Dharampura', drop: 'Bastar Palace', pickupLat: 19.079, pickupLng: 82.011, distanceKM: 2.4, fare: 52 },
  ];
  const assignments = vrpNearestNeighbor(mockDrivers, mockRides);
  renderVRPResults(assignments, mockDrivers, mockRides);
  toast('🎲 VRP simulation complete (demo data)');
}

// ─────────────────────────────────────────────────
// SHOW NEW FEATURE BUTTONS AFTER LAUNCH
// ─────────────────────────────────────────────────
const _origLaunch = typeof launch === 'function' ? launch : null;

// Show FAB row and lang selector after user logs in
function showNewFeatureFABs() {
  const fabRow = document.getElementById('mapFabRow');
  const langSel = document.getElementById('langSelector');
  const locBtn = document.getElementById('locBtn');

  if (fabRow) {
    fabRow.style.display = 'flex';
    // Position below locate button
    if (locBtn) {
      const bottom = parseInt(locBtn.style.bottom || '150') || 150;
      fabRow.style.bottom = (bottom + 62) + 'px';
    } else {
      fabRow.style.bottom = '220px';
    }
  }
}

// Hook into map load — show eLoc FAB + feature fabs
const _origMapLoad = typeof initMap === 'function' ? initMap.toString() : '';
const _realInit = typeof initMap === 'function' ? initMap : null;

// Also show after finishLoad
const _origFinishLoad = typeof finishLoad === 'function' ? finishLoad : null;

// Monkey-patch launch to also show our FABs
document.addEventListener('DOMContentLoaded', () => {
  // After 3s (after launch completes), show our FABs
  setTimeout(() => {
    showNewFeatureFABs();
  }, 3500);
});

// Also listen for auth completion  
const _launchObs = new MutationObserver(() => {
  const auth = document.getElementById('auth');
  if (auth && auth.style.display === 'none') {
    showNewFeatureFABs();
    _launchObs.disconnect();
  }
});
const authEl = document.getElementById('auth');
if (authEl) _launchObs.observe(authEl, { attributes: true, attributeFilter: ['style'] });

// Snap toggle disabled — keep map clean
function addSnapToggleToStats() {
  // Removed — keeping map UI minimal
}
// setTimeout(addSnapToggleToStats, 4000); // disabled

// ✅ Google Maps Navigation — Ola style (Pickup + Drop)
function openGoogleMapsNav() {
  if (!myLat || !myLng) { toast('📍 GPS ready nahi hai'); return; }
  let destLat, destLng, destAddr;

  if (navPhase === 'pickup' && window._navPickupLat) {
    destLat = window._navPickupLat;
    destLng = window._navPickupLng;
    destAddr = document.getElementById('navPA')?.textContent || 'Pickup';
  } else if (navPhase === 'drop' && window._navDropLat) {
    destLat = window._navDropLat;
    destLng = window._navDropLng;
    destAddr = window._navDropName || 'Drop';
  }

  if (destLat && destLng) {
    const gmUrl = `https://www.google.com/maps/dir/?api=1&origin=${myLat},${myLng}&destination=${destLat},${destLng}&travelmode=driving`;
    window.open(gmUrl, '_blank');
    toast('🗺️ Google Maps khul raha hai...');
  } else if (curReqData) {
    // Fallback: address-based navigation
    const addr = navPhase === 'pickup' ? curReqData.pickup : curReqData.drop;
    if (addr) {
      const gmUrl = `https://www.google.com/maps/dir/?api=1&origin=${myLat},${myLng}&destination=${encodeURIComponent(addr + ', Jagdalpur')}&travelmode=driving`;
      window.open(gmUrl, '_blank');
      toast('🗺️ Google Maps khul raha hai...');
    } else {
      toast('❌ Destination nahi mila');
    }
  }
}

console.log('[JDP] 🆕 Mappls features loaded: eLoc, Multilingual, Snap-to-Road, VehicleProfile, FleetTracking, VRP');
</script>

<!-- ✅ PWA: Inline Manifest + Service Worker (works as local file too) -->
<script>
(function(){
  try {
    // ── Inline Manifest via Blob URL ──
    const manifest = {
      name: "JDP CABS \u2014 Jagdalpur",
      short_name: "JDP Cabs",
      description: "Jagdalpur ka smartest cab booking app",
      start_url: "./",
      display: "standalone",
      orientation: "portrait",
      background_color: "#07090f",
      theme_color: "#f59e0b",
      icons: [
        { src: "icon-192.png", sizes: "192x192", type: "image/png", purpose: "any maskable" },
        { src: "icon-512.png", sizes: "512x512", type: "image/png", purpose: "any maskable" }
      ]
    };
    const mBlob = new Blob([JSON.stringify(manifest)], {type:'application/json'});
    const mUrl  = URL.createObjectURL(mBlob);
    const mLink = document.createElement('link');
    mLink.rel = 'manifest'; mLink.href = mUrl;
    document.head.appendChild(mLink);
  } catch(e) {}

  try {
    // ── Inline Service Worker via Blob URL ──
    if ('serviceWorker' in navigator) {
      const swCode = `
const CACHE='jdpcabs-v6';
self.addEventListener('install', e => { self.skipWaiting(); });
self.addEventListener('activate', e => { self.clients.claim(); });
self.addEventListener('fetch', e => {
  const url = new URL(e.request.url);
  const skip = ['firebase','firebaseapp','googleapis','osrm','openstreetmap','gstatic','unsplash','fonts','apis.mappls.com'];
  if (skip.some(d => url.hostname.includes(d))) return;
  if (e.request.method !== 'GET') return;
  e.respondWith(
    caches.match(e.request).then(cached => {
      if (cached) return cached;
      return fetch(e.request).then(res => {
        if (res && res.status === 200) {
          const clone = res.clone();
          caches.open(CACHE).then(c => c.put(e.request, clone));
        }
        return res;
      }).catch(() => cached);
    })
  );
});`;
      const swBlob = new Blob([swCode], {type:'application/javascript'});
      const swUrl  = URL.createObjectURL(swBlob);
      navigator.serviceWorker.register(swUrl, {scope: './'})
        .then(() => console.log('[JDP Cabs] SW ready'))
        .catch(() => {});
    }
  } catch(e) {}
})();
</script>
</body>
</html>

<script>
// â•â•â•â•â•â•â• GLOBALS â•â•â•â•â•â•â•
let authRole='rider', authTab='login', currentUser=null, fbReady=false;
let selectedVtype='Moto', docUrls={lic:null,aadhaar:null}, pendingRegData=null, postOtpAction=null;
let mapMode='none', lmap=null, mmap=null;
let puCoords=null, drCoords=null, puMarker=null, drMarker=null, routeLine=null;
let drvObjs=[], pickerType='pickup';
let isOnline=false, onlineStart=null, onlineTimer=null, requestTimer=null;
let completedRides=0, totalEarned=0;

// Jagdalpur Center
const CENTER=[19.0759, 82.0252];

// â•â•â•â•â•â•â• FIREBASE READY â•â•â•â•â•â•â•
window.addEventListener('firebaseReady', ()=>{
  fbReady=true;
  document.getElementById('fbBadge').className='fb-badge ok';
  document.getElementById('fbBadge').textContent='âœ… Firebase Connected!';
  window.FB.onAuthStateChanged(window.FB.auth, async (user)=>{
    if(user){
      try{
        const snap = await window.FB.getDoc(window.FB.doc(window.FB.db,'users',user.uid));
        if(snap.exists()){
          currentUser={uid:user.uid,...snap.data()};
          document.getElementById('authScreen').style.display='none';
          launchApp();
        }
      }catch(e){ console.log(e); }
    }
  });
});

// â•â•â•â•â•â•â• LOADER â•â•â•â•â•â•â•
let ldProg=0;
const ldIv=setInterval(()=>{ ldProg+=Math.random()*14; if(ldProg>88) ldProg=88; document.getElementById('ldBar').style.width=ldProg+'%'; },350);
function ldTxt(t){ document.getElementById('ldTxt').textContent=t; }
function finishLoad(){
  clearInterval(ldIv);
  document.getElementById('ldBar').style.width='100%';
  setTimeout(()=>{
    document.getElementById('loader').style.opacity='0';
    document.getElementById('loader').style.transition='opacity 0.5s';
    setTimeout(()=>{
      document.getElementById('loader').style.display='none';
      if(!currentUser) document.getElementById('authScreen').style.display='flex';
    },500);
  },700);
}

// â•â•â•â•â•â•â• MAP â•â•â•â•â•â•â•
window.onMapReady=function(){
  mapMode='mappls'; ldTxt('ğŸ‡®ğŸ‡³ MapmyIndia Ready!');
  try{
    mmap=new mappls.Map('map',{center:CENTER,zoom:12,minZoom:10,search:false,zoomControl:true});
    mmap.on('load',()=>{ finishLoad(); spawnCars(); setInterval(moveCars,2000); mmap.on('click',e=>{ if(document.getElementById('scrSearch').classList.contains('on')) revGeo([e.lngLat.lat,e.lngLat.lng],pickerType); }); });
  }catch(e){ useFallback(); }
};
setTimeout(()=>{ if(mapMode==='none') useFallback(); },7000);
function useFallback(){
  mapMode='leaflet';
  const jdpBounds = [
    [18.75, 81.70], // South-West corner
    [19.40, 82.35]  // North-East corner
  ];
  lmap=L.map('map',{zoomControl:true,attributionControl:false, maxBounds: jdpBounds, maxBoundsViscosity: 1.0, minZoom: 10}).setView(CENTER,12);
  L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png',{maxZoom:19,subdomains:'abcd'}).addTo(lmap);
  lmap.on('click',e=>{ if(document.getElementById('scrSearch').classList.contains('on')) revGeo([e.latlng.lat,e.latlng.lng],pickerType); });
  spawnCars(); setInterval(moveCars,2000); finishLoad();
}
const carPos=[[19.082, 82.020],[19.071, 82.028],[19.080, 82.015],[19.068, 82.032],[19.075, 82.035]];
function spawnCars(){
  carPos.forEach(p=>{
    if(mapMode==='leaflet'){ const m=L.marker(p,{icon:carIcon()}).addTo(lmap); drvObjs.push({m,pos:[...p],mode:'leaflet'}); }
    else{ try{ const m=new mappls.Marker({map:mmap,position:{lat:p[0],lng:p[1]},fitbounds:false}); drvObjs.push({m,pos:[...p],mode:'mappls'}); }catch(e){} }
  });
}
function moveCars(){ drvObjs.forEach(d=>{ d.pos[0]+=(Math.random()-.5)*.001; d.pos[1]+=(Math.random()-.5)*.001; try{ if(d.mode==='leaflet') d.m.setLatLng(d.pos); else d.m.setPosition({lat:d.pos[0],lng:d.pos[1]}); }catch(e){} }); }
function carIcon(){ return L.divIcon({className:'',html:`<div style="position:relative;width:36px;height:36px"><div style="position:absolute;inset:-7px;border-radius:50%;background:rgba(251,191,36,0.15);animation:carPulse 2s ease-out infinite;"></div><div style="width:36px;height:36px;background:#FBBF24;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:18px;box-shadow:0 4px 12px rgba(251,191,36,0.5)">ğŸš—</div></div>`,iconSize:[36,36],iconAnchor:[18,18]}); }
function pinIcon(c){ const col=c==='g'?'#10b981':'#ef4444'; return L.divIcon({className:'',html:`<div style="width:14px;height:14px;background:${col};border-radius:50%;border:3px solid white;box-shadow:0 0 10px ${col}99"></div>`,iconSize:[14,14],iconAnchor:[7,7]}); }

// â•â•â•â•â•â•â• AUTH ROLE/TAB â•â•â•â•â•â•â•
function setAuthRole(r){
  authRole=r;
  document.getElementById('rTab').className='rtab'+(r==='rider'?' active r':'');
  document.getElementById('dTab').className='rtab'+(r==='driver'?' active d':'');
  document.getElementById('loginBtn').className='auth-submit '+(r==='rider'?'y':'g');
  if(authTab==='register'){
    document.getElementById('riderRegForm').className='auth-form'+(r==='rider'?' show':'');
    document.getElementById('driverRegForm').className='auth-form'+(r==='driver'?' show':'');
  }
}
function setAuthTab(t){
  authTab=t;
  document.getElementById('loginTab').className='atab'+(t==='login'?' active':'');
  document.getElementById('regTab').className='atab'+(t==='register'?' active':'');
  document.getElementById('loginForm').className='auth-form'+(t==='login'?' show':'');
  document.getElementById('riderRegForm').className='auth-form'+(t==='register'&&authRole==='rider'?' show':'');
  document.getElementById('driverRegForm').className='auth-form'+(t==='register'&&authRole==='driver'?' show':'');
  document.getElementById('otpScreen').className='otp-screen';
}

// â•â•â•â•â•â•â• FIREBASE: LOGIN â•â•â•â•â•â•â•
async function doLogin(){
  const id=document.getElementById('loginId').value.trim();
  const pass=document.getElementById('loginPass').value;
  let ok=true;
  if(!id||id.length<6){ showErr('loginIdErr','Valid mobile ya email daalo'); ok=false; } else hideErr('loginIdErr');
  if(!pass){ showErr('loginPassErr','Password daalo'); ok=false; } else hideErr('loginPassErr');
  if(!ok) return;

  let email=id.includes('@')?id:phoneToEmail(id);
  const btn=document.getElementById('loginBtn');
  btn.disabled=true; btn.textContent='â³ Login ho raha hai...';
  try{
    const cred=await window.FB.signInWithEmailAndPassword(window.FB.auth, email, pass);
    const snap=await window.FB.getDoc(window.FB.doc(window.FB.db,'users',cred.user.uid));
    if(!snap.exists()){ btn.disabled=false; btn.textContent='ğŸš€ Login Karo'; showErr('loginIdErr','User profile nahi mila'); return; }
    currentUser={uid:cred.user.uid,...snap.data()};
    if(currentUser.role!==authRole){ 
      await window.FB.signOut(window.FB.auth);
      btn.disabled=false; btn.textContent='ğŸš€ Login Karo';
      showErr('loginIdErr',`Yeh account ${currentUser.role} ka hai â€” Role switch karo`);
      return;
    }
    document.getElementById('authScreen').style.display='none';
    toast('ğŸ‰ Welcome back, '+currentUser.name.split(' ')[0]+'!');
    launchApp();
  }catch(e){
    btn.disabled=false; btn.textContent='ğŸš€ Login Karo';
    if(e.code==='auth/user-not-found'||e.code==='auth/invalid-credential') showErr('loginIdErr','Account nahi mila â€” Register karo');
    else if(e.code==='auth/wrong-password') showErr('loginPassErr','Password galat hai!');
    else showErr('loginIdErr','Error: '+e.message);
  }
}

// â•â•â•â•â•â•â• FIREBASE: RIDER REGISTER â•â•â•â•â•â•â•
async function doRiderRegister(){
  const fn=document.getElementById('rFn').value.trim();
  const ph=document.getElementById('rPhone').value.trim().replace(/\s/g,'');
  const em=document.getElementById('rEmail').value.trim();
  const pass=document.getElementById('rPass').value;
  const conf=document.getElementById('rConf').value;
  let ok=true;
  if(!fn){ showErr('rFnErr','Naam daalo'); ok=false; } else hideErr('rFnErr');
  if(!ph||ph.length<10){ showErr('rPhoneErr','Valid number daalo'); ok=false; } else hideErr('rPhoneErr');
  if(!em||!em.includes('@')){ showErr('rEmailErr','Valid email daalo'); ok=false; } else hideErr('rEmailErr');
  if(pass.length<6){ showErr('rPassErr','Min 6 characters'); ok=false; } else hideErr('rPassErr');
  if(pass!==conf){ showErr('rConfErr','Match nahi'); ok=false; } else hideErr('rConfErr');
  if(!ok) return;
  pendingRegData={ name:fn+' '+(document.getElementById('rLn').value.trim()), phone:ph, email:em, role:'rider', dob:document.getElementById('rDob').value, password:pass, createdAt: new Date().toISOString() };
  postOtpAction='riderReg';
  showOtp(ph);
}

// â•â•â•â•â•â•â• FIREBASE: DRIVER REGISTER â•â•â•â•â•â•â•
async function doDriverRegister(){
  const fn=document.getElementById('dFn').value.trim();
  const ph=document.getElementById('dPhone').value.trim().replace(/\s/g,'');
  const em=document.getElementById('dEmail').value.trim();
  const aad=document.getElementById('dAadhaar').value.trim().replace(/\s/g,'');
  const lic=document.getElementById('dLic').value.trim();
  const pass=document.getElementById('dPass').value;
  const conf=document.getElementById('dConf').value;
  let ok=true;
  if(!fn){ showErr('dFnErr','Naam daalo'); ok=false; } else hideErr('dFnErr');
  if(!ph||ph.length<10){ showErr('dPhoneErr','Valid number daalo'); ok=false; } else hideErr('dPhoneErr');
  if(!em||!em.includes('@')){ showErr('dEmailErr','Valid email daalo'); ok=false; } else hideErr('dEmailErr');
  if(!aad||aad.length<12){ showErr('dAadhaarErr','12-digit Aadhaar daalo'); ok=false; } else hideErr('dAadhaarErr');
  if(!lic){ showErr('dLicErr','Licence number daalo'); ok=false; } else hideErr('dLicErr');
  if(pass.length<6){ showErr('dPassErr','Min 6 characters'); ok=false; } else hideErr('dPassErr');
  if(pass!==conf){ showErr('dConfErr','Match nahi'); ok=false; } else hideErr('dConfErr');
  if(!ok) return;
  pendingRegData={ name:fn+' '+(document.getElementById('dLn').value.trim()), phone:ph, email:em, role:'driver', aadhaar:aad, licence:lic, vehicle:document.getElementById('dVeh').value, vtype:selectedVtype, password:pass, docUrls:{lic:docUrls.lic,aadhaar:docUrls.aadhaar}, verified:false, createdAt: new Date().toISOString() };
  postOtpAction='driverReg';
  showOtp(ph);
}

// â•â•â•â•â•â•â• OTP â•â•â•â•â•â•â•
function showOtp(ph){
  ['loginForm','riderRegForm','driverRegForm'].forEach(id=>document.getElementById(id).className='auth-form');
  document.getElementById('otpScreen').className='otp-screen show';
  document.getElementById('otpPhone').textContent=ph;
  document.getElementById('otpBtn').className='auth-submit '+(authRole==='rider'?'y':'g');
  [0,1,2,3,4,5].forEach(i=>{ document.getElementById('o'+i).value=''; });
  document.getElementById('o0').focus();
  toast('ğŸ“² Demo OTP: 1 2 3 4 5 6');
}
function oNext(el,i){ if(el.value.length===1&&i<5) document.getElementById('o'+(i+1)).focus(); }
function backOtp(){ document.getElementById('otpScreen').className='otp-screen'; setAuthTab(authTab); }

async function verifyOtp(){
  const code=[0,1,2,3,4,5].map(i=>document.getElementById('o'+i).value).join('');
  if(code.length<6){ toast('âš ï¸ Poora OTP daalo!'); return; }
  const btn=document.getElementById('otpBtn');
  btn.disabled=true; btn.textContent='â³ Verify ho raha hai...';
  try{
    if(postOtpAction==='riderReg'||postOtpAction==='driverReg'){
      const email=pendingRegData.email;
      const pass=pendingRegData.password;
      const cred=await window.FB.createUserWithEmailAndPassword(window.FB.auth, email, pass);
      const uid=cred.user.uid;
      const dataToSave={...pendingRegData}; delete dataToSave.password;
      await window.FB.setDoc(window.FB.doc(window.FB.db,'users',uid), dataToSave);
      currentUser={uid,...dataToSave};
      toast('ğŸ‰ Account ban gaya! Welcome, '+currentUser.name.split(' ')[0]+'!');
    }
    document.getElementById('authScreen').style.display='none';
    launchApp();
  }catch(e){
    btn.disabled=false; btn.textContent='âœ… Verify Karo';
    if(e.code==='auth/email-already-in-use') toast('âš ï¸ Yeh email pehle se registered hai!');
    else toast('âŒ Error: '+e.message);
  }
}

// â•â•â•â•â•â•â• DOCUMENT UPLOAD (Firebase Storage) â•â•â•â•â•â•â•
function uploadDoc(type,name,boxId){
  document.getElementById(type+'File').click();
}
async function handleFile(type, input){
  const file=input.files[0]; if(!file) return;
  if(file.size>5*1024*1024){ toast('âŒ File 5MB se badi hai!'); return; }
  const box=document.getElementById(type==='lic'?'licBox':'aadhaarBox');
  const progWrap=document.getElementById(type+'Prog');
  const progBar=document.getElementById(type+'ProgBar');
  const title=document.getElementById(type+'Title');
  progWrap.className='ubox-progress on';
  let p=0; const iv=setInterval(()=>{ p+=Math.random()*20; if(p>90) p=90; progBar.style.width=p+'%'; },200);
  try{
    if(!fbReady){ clearInterval(iv); toast('âš ï¸ Firebase connect nahi hua'); return; }
    const storageRef=window.FB.ref(window.FB.storage,`drivers/docs/${Date.now()}_${type}_${file.name}`);
    const snap=await window.FB.uploadBytes(storageRef, file);
    const url=await window.FB.getDownloadURL(snap.ref);
    docUrls[type]=url;
    clearInterval(iv); progBar.style.width='100%';
    setTimeout(()=>{
      box.classList.add('done');
      document.getElementById(type+'Ico').textContent=type==='lic'?'ğŸ“„':'ğŸªª';
      title.textContent=name+' Upload Ho Gaya âœ…';
      progWrap.className='ubox-progress';
      toast('âœ… '+name+' Firebase pe save ho gaya!');
    },400);
  }catch(e){
    clearInterval(iv); progWrap.className='ubox-progress';
    toast('âŒ Upload failed: '+e.message);
  }
}

// â•â•â•â•â•â•â• LOGOUT â•â•â•â•â•â•â•
async function doLogout(){
  if(!confirm('Logout karna chahte hain?')) return;
  try{
    await window.FB.signOut(window.FB.auth);
    currentUser=null;
    isOnline=false; completedRides=0; totalEarned=0;
    if(onlineTimer) clearInterval(onlineTimer);
    if(requestTimer) clearInterval(requestTimer);
    document.getElementById('ridePopup').classList.remove('show');
    ['topbar','bsheet','livePill','locBtn','dutyWrap'].forEach(id=>document.getElementById(id).style.display='none');
    closeProfScreen();
    document.getElementById('authScreen').style.display='flex';
    setAuthTab('login'); setAuthRole('rider');
    toast('ğŸ‘‹ Logout ho gaye!');
  }catch(e){ toast('Error: '+e.message); }
}

// â•â•â•â•â•â•â• LAUNCH APP â•â•â•â•â•â•â•
function launchApp(){
  document.getElementById('topbar').style.display='flex';
  document.getElementById('bsheet').style.display='block';
  document.getElementById('livePill').style.display='flex';
  document.getElementById('locBtn').style.display='flex';
  const first=currentUser.name.split(' ')[0];
  document.getElementById('profName').textContent=first;
  document.getElementById('profImg').src=`https://ui-avatars.com/api/?name=${encodeURIComponent(currentUser.name)}&background=FBBF24&color=000&bold=true`;
  const tag=document.getElementById('modeTag');
  if(currentUser.role==='rider'){
    tag.textContent='ğŸ§ Rider'; tag.className='mode-tag r';
    document.getElementById('pillTxt').textContent='5 drivers kareeb';
    document.getElementById('dutyWrap').style.display='none';
    document.getElementById('locBtn').style.bottom='380px';
    setPickup(CENTER,'Dalpat Sagar, Jagdalpur');
    goScr('RHome');
  } else {
    tag.textContent='ğŸš— Driver'; tag.className='mode-tag d';
    document.getElementById('pillTxt').textContent='Driver Mode';
    document.getElementById('dutyWrap').style.display='flex';
    document.getElementById('locBtn').style.bottom='320px';
    document.getElementById('drvWelcome').textContent='Namaste, '+first+'! ğŸ‘‹';
    goScr('DOn'); goOffline();
    goScr('DOn'); 
    goScr('DOn');
    goScr('DOf');
  }
}

// â•â•â•â•â•â•â• PROFILE SCREEN â•â•â•â•â•â•â•
function openProfScreen(){
  if(!currentUser) return;
  document.getElementById('profBigImg').src=`https://ui-avatars.com/api/?name=${encodeURIComponent(currentUser.name)}&background=FBBF24&color=000&bold=true&size=200`;
  document.getElementById('profBigName').textContent=currentUser.name;
  document.getElementById('profBigRole').textContent=currentUser.role==='rider'?'ğŸ§ Rider':'ğŸš— Driver Partner';
  const fields=currentUser.role==='rider'?[
    {l:'ğŸ“± Mobile',v:currentUser.phone},{l:'ğŸ“§ Email',v:currentUser.email},{l:'ğŸ‚ Date of Birth',v:currentUser.dob||'â€”'},{l:'ğŸ†” User ID',v:currentUser.uid?.slice(0,12)+'...'},{l:'ğŸ“… Joined',v:currentUser.createdAt?.slice(0,10)||'â€”'}
  ]:[
    {l:'ğŸ“± Mobile',v:currentUser.phone},{l:'ğŸ“§ Email',v:currentUser.email},{l:'ğŸªª Aadhaar',v:currentUser.aadhaar?.slice(0,4)+'XXXX'+currentUser.aadhaar?.slice(-4)},{l:'ğŸš— Licence',v:currentUser.licence},{l:'ğŸš˜ Vehicle',v:currentUser.vehicle||'â€”'},{l:'ğŸš˜ Type',v:currentUser.vtype||'â€”'},{l:'âœ… Verified',v:currentUser.verified?'Haan':'Pending Verification'},{l:'ğŸ†” Driver ID',v:currentUser.uid?.slice(0,12)+'...'},{l:'ğŸ“… Joined',v:currentUser.createdAt?.slice(0,10)||'â€”'}
  ];
  document.getElementById('profInfoCard').innerHTML=fields.map(f=>`<div class="prof-field"><div class="pf-label">${f.l}</div><div class="pf-value">${f.v||'â€”'}</div></div>`).join('');
  if(currentUser.role==='driver'){
    document.getElementById('profDocsSection').innerHTML=`
      <div style="font-size:0.75rem;font-weight:700;color:var(--muted);margin-bottom:10px;text-transform:uppercase;letter-spacing:1px">Uploaded Documents</div>
      <div class="doc-card">
        <div style="font-size:1.5rem">ğŸ“„</div>
        <div style="flex:1"><div style="font-weight:700;font-size:0.9rem">Driving Licence</div><div style="font-size:0.72rem;color:var(--muted);margin-top:2px">${currentUser.docUrls?.lic?'Firebase Storage pe save hai':'Upload nahi hua'}</div></div>
        <div class="doc-status ${currentUser.docUrls?.lic?'ok':'pending'}">${currentUser.docUrls?.lic?'âœ… Uploaded':'â³ Pending'}</div>
      </div>
      <div class="doc-card">
        <div style="font-size:1.5rem">ğŸªª</div>
        <div style="flex:1"><div style="font-weight:700;font-size:0.9rem">Aadhaar Card</div><div style="font-size:0.72rem;color:var(--muted);margin-top:2px">${currentUser.docUrls?.aadhaar?'Firebase Storage pe save hai':'Upload nahi hua'}</div></div>
        <div class="doc-status ${currentUser.docUrls?.aadhaar?'ok':'pending'}">${currentUser.docUrls?.aadhaar?'âœ… Uploaded':'â³ Pending'}</div>
      </div>`;
  } else { document.getElementById('profDocsSection').innerHTML=''; }
  document.getElementById('profScreen').className='prof-screen show';
}
function closeProfScreen(){ document.getElementById('profScreen').className='prof-screen'; }

// â•â•â•â•â•â•â• HELPERS â•â•â•â•â•â•â•
function phoneToEmail(ph){ return ph.replace(/[^0-9]/g,'')+'@jdpcabs.in'; }
function showErr(id,msg){ const el=document.getElementById(id); el.textContent=msg; el.classList.add('on'); }
function hideErr(id){ document.getElementById(id).classList.remove('on'); }
function selV(card,type){ document.querySelectorAll('.vcard').forEach(c=>c.classList.remove('sel')); card.classList.add('sel'); selectedVtype=type; }
function goScr(name){ document.querySelectorAll('.scr').forEach(s=>s.classList.remove('on')); const el=document.getElementById('scr'+name); if(el) el.classList.add('on'); }
function flyTo(ll){ if(mapMode==='mappls'){try{mmap.setCenter({lat:ll[0],lng:ll[1]});}catch(e){}}else lmap.flyTo(ll,15,{duration:1.3}); }

// â•â•â•â•â•â•â• LOCATE â•â•â•â•â•â•â•
function locateMe(){
  toast('ğŸ“ Location dhundh raha hai...');
  navigator.geolocation?.getCurrentPosition(p=>{ const ll=[p.coords.latitude,p.coords.longitude]; if(currentUser?.role==='rider') setPickup(ll,'Aapki Location'); flyTo(ll); toast('âœ… Location mil gayi!'); },()=>toast('âŒ Permission denied'));
}

// â•â•â•â•â•â•â• MAP MARKERS â•â•â•â•â•â•â•
function setPickup(ll,label){
  puCoords=ll; document.getElementById('puLbl').textContent=label||`${ll[0].toFixed(4)}, ${ll[1].toFixed(4)}`;
  try{ if(mapMode==='leaflet'){ if(puMarker) lmap.removeLayer(puMarker); puMarker=L.marker(ll,{icon:pinIcon('g')}).addTo(lmap); } else{ if(puMarker) puMarker.remove(); puMarker=new mappls.Marker({map:mmap,position:{lat:ll[0],lng:ll[1]},fitbounds:false}); } }catch(e){}
  if(drCoords) drawRoute();
}
function setDrop(ll,label){
  drCoords=ll; document.getElementById('drLbl').textContent=label||`${ll[0].toFixed(4)}, ${ll[1].toFixed(4)}`;
  try{ if(mapMode==='leaflet'){ if(drMarker) lmap.removeLayer(drMarker); drMarker=L.marker(ll,{icon:pinIcon('r')}).addTo(lmap); } else{ if(drMarker) drMarker.remove(); drMarker=new mappls.Marker({map:mmap,position:{lat:ll[0],lng:ll[1]},fitbounds:false}); } }catch(e){}
  if(puCoords) drawRoute();
}
function drawRoute(){
  if(mapMode==='leaflet'){
    if(routeLine) lmap.removeLayer(routeLine);
    const m1=[(puCoords[0]*.65+drCoords[0]*.35)+(Math.random()-.5)*.01,(puCoords[1]*.65+drCoords[1]*.35)+(Math.random()-.5)*.01];
    const m2=[(puCoords[0]*.35+drCoords[0]*.65)+(Math.random()-.5)*.01,(puCoords[1]*.35+drCoords[1]*.65)+(Math.random()-.5)*.01];
    routeLine=L.polyline([puCoords,m1,m2,drCoords],{color:'#FBBF24',weight:5,opacity:0.9,dashArray:'10,6',lineCap:'round'}).addTo(lmap);
    let off=0; if(window._ra) clearInterval(window._ra);
    window._ra=setInterval(()=>{ off=(off+1)%16; if(routeLine) routeLine.setStyle({dashOffset:-off}); },55);
    lmap.fitBounds(routeLine.getBounds(),{padding:[80,80]});
  } else {
    try{ if(routeLine) routeLine.remove(); routeLine=new mappls.Polyline({map:mmap,path:[{lat:puCoords[0],lng:puCoords[1]},{lat:drCoords[0],lng:drCoords[1]}],strokeColor:'#FBBF24',strokeOpacity:0.9,strokeWeight:5,fitbounds:true}); }catch(e){}
  }
}

// â•â•â•â•â•â•â• REVERSE GEO â•â•â•â•â•â•â•
function revGeo(ll,type){
  fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${ll[0]}&lon=${ll[1]}&accept-language=en`)
    .then(r=>r.json()).then(d=>{ const n=d.address?.road||d.address?.suburb||d.display_name.split(',')[0]; if(type==='pickup') setPickup(ll,n); else setDrop(ll,n); goScr('RHome'); toast(`âœ… ${n}`); }).catch(()=>{ if(type==='pickup') setPickup(ll); else setDrop(ll); goScr('RHome'); });
}

// â•â•â•â•â•â•â• SUGGESTIONS â•â•â•â•â•â•â•
const SUGS=[
  {i:'ğŸ›ï¸',n:'Sanjay Market',a:'Main Road, Jagdalpur',lat:19.075,lon:82.028,d:'1.2 km'},
  {i:'ğŸŒŠ',n:'Dalpat Sagar',a:'Jagdalpur City',lat:19.082,lon:82.020,d:'2.1 km'},
  {i:'â›©ï¸',n:'Danteshwari Temple',a:'Palace Road, Jagdalpur',lat:19.074,lon:82.026,d:'1.5 km'},
  {i:'ğŸšŒ',n:'New Bus Stand',a:'Jagdalpur',lat:19.085,lon:82.010,d:'3.0 km'},
  {i:'âœˆï¸',n:'Jagdalpur Airport',a:'Jagdalpur',lat:19.072,lon:82.035,d:'4.0 km'}
];
function renderSugs(list){ document.getElementById('suglist').innerHTML=list.map(s=>`<div class="sugrow" onclick="pickSug(${s.lat},${s.lon},'${s.n.replace(/'/g,"\\'")}')"><div class="sugico">${s.i}</div><div style="flex:1;min-width:0"><div class="sugname">${s.n}</div><div class="sugaddr">${s.a}</div></div><div class="sugdist">${s.d}</div></div>`).join(''); }
function openPick(type){ pickerType=type; document.getElementById('searchTitle').textContent=type==='pickup'?'Pickup Set Karo':'Drop Set Karo'; document.getElementById('sinp').value=''; renderSugs(SUGS); goScr('Search'); setTimeout(()=>document.getElementById('sinp').focus(),180); }
function filterSug(q){ if(!q.trim()){renderSugs(SUGS);return;} renderSugs(SUGS.filter(s=>s.n.toLowerCase().includes(q.toLowerCase())||s.a.toLowerCase().includes(q.toLowerCase()))); }
function pickSug(lat,lon,name){ const ll=[lat,lon]; if(pickerType==='pickup') setPickup(ll,name); else setDrop(ll,name); flyTo(ll); goScr('RHome'); toast(`ğŸ“ ${name}!`); }
const QP={ghar:{n:'Ghar',lat:19.075,lon:82.025},office:{n:'Sanjay Market',lat:19.075,lon:82.028},airport:{n:'Jagdalpur Airport',lat:19.072,lon:82.035},station:{n:'Railway Station',lat:19.080,lon:82.040},hospital:{n:'Govt Hospital',lat:19.085,lon:82.020},mall:{n:'City Mall',lat:19.070,lon:82.020}};
function qpick(k){ const p=QP[k]; setDrop([p.lat,p.lon],p.n); flyTo([p.lat,p.lon]); toast(`ğŸ¯ Drop: ${p.n}`); }

// â•â•â•â•â•â•â• DISTANCE â•â•â•â•â•â•â•
function getDist(a,b){ const R=6371,dL=(b[0]-a[0])*Math.PI/180,dN=(b[1]-a[1])*Math.PI/180; const x=Math.sin(dL/2)**2+Math.cos(a[0]*Math.PI/180)*Math.cos(b[0]*Math.PI/180)*Math.sin(dN/2)**2; return R*2*Math.atan2(Math.sqrt(x),Math.sqrt(1-x)); }

// â•â•â•â•â•â•â• RIDES & 35 KM LOGIC â•â•â•â•â•â•â•
const RIDES=[{i:'ğŸ›µ',n:'Moto',d:'1 sawari',base:11,badge:'Sasta',eta:'2 min'},{i:'ğŸš—',n:'GO',d:'4 sawari',base:17,badge:'Popular',eta:'4 min'},{i:'ğŸš™',n:'Prime',d:'4 sawari Â· Aaram',base:25,badge:null,eta:'6 min'},{i:'ğŸš',n:'GO XL',d:'6 sawari',base:31,badge:null,eta:'8 min'}];
function goRides(){
  if(!puCoords||!drCoords){ toast('âš ï¸ Please set pickup and drop locations!'); if(!puCoords) openPick('pickup'); else openPick('drop'); return; }
  
  const km=getDist(puCoords,drCoords);
  const pickupFromCity = getDist(puCoords, CENTER);

  // Rule 1: No rides allowed beyond 35 km total distance
  if (km > 35) {
    toast('âš ï¸ We currently only provide services up to 35 km!');
    return;
  }

  // Rule 2: For rides between 15 km and 35 km (Outstation/Long distance)
  if (km > 15) {
    if (pickupFromCity > 5) {
      toast('âš ï¸ For rides over 15 km, the pickup must be from Jagdalpur city!');
      return;
    } else {
      toast('ğŸ›£ï¸ Long Distance booking applied!');
    }
  }

  document.getElementById('rfrom').textContent=document.getElementById('puLbl').textContent;
  document.getElementById('rto').textContent=document.getElementById('drLbl').textContent;
  document.getElementById('rdist').textContent=km.toFixed(1)+' km';
  document.getElementById('tfare').textContent='â‚¹'+Math.round(17*km+40);
  document.getElementById('rlist').innerHTML=RIDES.map((r,i)=>{ const fare=Math.round(r.base*km+40); return `<div class="ropt ${i===1?'sel':''}" id="ro${i}" onclick="selR(${i},${fare})">${r.badge?`<div class="rbadge">${r.badge}</div>`:''}<div class="rico">${r.i}</div><div style="flex:1"><div class="rname">${r.n}</div><div class="rdesc">${r.d}</div><div class="reta">ğŸ• ${r.eta}</div></div><div class="rprice"><div class="rp-amt">â‚¹${fare}</div><div class="rp-sub">${km.toFixed(1)} km</div></div></div>`; }).join('');
  goScr('Rides');
}
function selR(i,fare){ document.querySelectorAll('.ropt').forEach((el,j)=>el.classList.toggle('sel',i===j)); document.getElementById('tfare').textContent='â‚¹'+fare; }
function confirmRide(){
  toast('ğŸ” Driver dhundh raha hai...');
  if(fbReady&&currentUser){
    window.FB.addDoc(window.FB.collection(window.FB.db,'rides'),{
      riderId:currentUser.uid, riderName:currentUser.name, riderPhone:currentUser.phone,
      pickup:document.getElementById('puLbl').textContent, drop:document.getElementById('drLbl').textContent,
      fare:document.getElementById('tfare').textContent, status:'searching', timestamp:window.FB.serverTimestamp()
    }).catch(e=>console.log(e));
  }
  goScr('Track');
  if(puCoords) flyTo(puCoords);
  if(drvObjs.length>0){
    const drv=drvObjs[0],start=[...drv.pos],target=puCoords; let step=0,total=50;
    if(window._da) clearInterval(window._da);
    window._da=setInterval(()=>{ step++; const t=step/total; drv.pos[0]=start[0]+(target[0]-start[0])*t; drv.pos[1]=start[1]+(target[1]-start[1])*t;
      try{ if(drv.mode==='leaflet') drv.m.setLatLng(drv.pos); else drv.m.setPosition({lat:drv.pos[0],lng:drv.pos[1]}); }catch(e){}
      if(step>=total){ clearInterval(window._da); toast('ğŸš— Driver aa gaya!'); updS(3); }
    },150);
  }
  let eta=4; document.getElementById('etaNum').textContent=eta;
  const et=setInterval(()=>{ eta--; document.getElementById('etaNum').textContent=Math.max(0,eta); if(eta<=0){clearInterval(et);updS(3);} },60000);
}
function updS(n){ [1,2,3,4].forEach(i=>{ const el=document.getElementById('rs'+i); if(i<n) el.className='stp done'; else if(i===n) el.className='stp on'; else el.className='stp'; }); }
function cancelRide(){ goScr('RHome'); toast('âŒ Ride cancel'); }

// â•â•â•â•â•â•â• DRIVER â•â•â•â•â•â•â•
function toggleDuty(){ if(!isOnline) goOnline(); else goOffline(); }
function goOnline(){
  isOnline=true;
  const btn=document.getElementById('dutyBtn');
  btn.className='duty-btn on';
  btn.innerHTML=`<div class="radar"></div><div class="radar2"></div><div class="duty-ico">ğŸŸ¢</div><div class="duty-txt">Online</div>`;
  goScr('DOn'); onlineStart=Date.now();
  onlineTimer=setInterval(()=>{ const m=Math.floor((Date.now()-onlineStart)/60000); document.getElementById('onlineTime').textContent=`${Math.floor(m/60)}h ${m%60}m`; document.getElementById('earnTime').textContent=`${Math.floor(m/60)}h ${m%60}m`; },30000);
  toast('ğŸŸ¢ Duty shuru!'); setTimeout(()=>sendReq(),5000);
}
function goOffline(){
  isOnline=false;
  const btn=document.getElementById('dutyBtn');
  btn.className='duty-btn off'; btn.innerHTML=`<div class="duty-ico">ğŸš—</div><div class="duty-txt">Offline</div>`;
  if(onlineTimer) clearInterval(onlineTimer); if(requestTimer) clearInterval(requestTimer);
  document.getElementById('ridePopup').classList.remove('show'); goScr('DOf'); toast('ğŸ”´ Duty band');
}
const REQS=[
  {from:'Dalpat Sagar',to:'Sanjay Market',dist:'2.1 km',time:'8 min',fare:'â‚¹75',rName:'Priya Sharma',rPic:'https://randomuser.me/api/portraits/women/32.jpg'},
  {from:'New Bus Stand',to:'City Mall',dist:'4.2 km',time:'12 min',fare:'â‚¹110',rName:'Rahul Verma',rPic:'https://randomuser.me/api/portraits/men/22.jpg'},
  {from:'Govt Hospital',to:'Railway Station',dist:'6.4 km',time:'15 min',fare:'â‚¹145',rName:'Anjali Singh',rPic:'https://randomuser.me/api/portraits/women/44.jpg'},
  {from:'Jagdalpur Airport',to:'Danteshwari Temple',dist:'5.0 km',time:'14 min',fare:'â‚¹125',rName:'Amit Kumar',rPic:'https://randomuser.me/api/portraits/men/55.jpg'},
];
let reqIdx=0;
function sendReq(){
  if(!isOnline) return;
  const r=REQS[reqIdx%REQS.length]; reqIdx++;
  document.getElementById('popFrom').textContent=r.from; document.getElementById('popTo').textContent=r.to;
  document.getElementById('popDist').textContent=r.dist; document.getElementById('popTime').textContent=r.time;
  document.getElementById('popFare').textContent=r.fare; document.getElementById('popRiderImg').src=r.rPic;
  document.getElementById('popRiderName').textContent=r.rName;
  document.getElementById('timerBar').style.width='100%';
  document.getElementById('ridePopup').classList.add('show');
  let sec=25; if(requestTimer) clearInterval(requestTimer);
  requestTimer=setInterval(()=>{ sec--; document.getElementById('timerBar').style.width=(sec/25*100)+'%'; if(sec<=0){clearInterval(requestTimer);document.getElementById('ridePopup').classList.remove('show');toast('â° Expire'); setTimeout(()=>{if(isOnline)sendReq();},4000);} },1000);
}
function declineRide(){ clearInterval(requestTimer); document.getElementById('ridePopup').classList.remove('show'); toast('âŒ Decline'); setTimeout(()=>{if(isOnline)sendReq();},5000); }
async function acceptRide(){
  clearInterval(requestTimer); document.getElementById('ridePopup').classList.remove('show');
  const from=document.getElementById('popFrom').textContent,fare=document.getElementById('popFare').textContent,to=document.getElementById('popTo').textContent;
  document.getElementById('dTripFare').textContent=fare;
  document.getElementById('navDist').textContent=document.getElementById('popDist').textContent+' baaki';
  document.getElementById('navDir').textContent=from+' â†’ '+to;
  document.getElementById('tripRiderName').textContent=document.getElementById('popRiderName').textContent;
  document.getElementById('tripRiderImg').src=document.getElementById('popRiderImg').src;
  goScr('DRide'); toast(`âœ… Accepted! ${from} jaao`);
  completedRides++; totalEarned+=parseInt(fare.replace('â‚¹','').replace(',',''));
  ['dToday','dEarning','earnTotal'].forEach(id=>document.getElementById(id).textContent='â‚¹'+totalEarned.toLocaleString('en-IN'));
  ['dRides','earnRides'].forEach(id=>document.getElementById(id).textContent=completedRides);
  document.getElementById('dRidesSub').textContent=completedRides+' rides';
  addHist(from,to,fare);
  if(fbReady&&currentUser){
    window.FB.addDoc(window.FB.collection(window.FB.db,'completedRides'),{
      driverId:currentUser.uid, driverName:currentUser.name, from, to, fare,
      timestamp:window.FB.serverTimestamp()
    }).catch(e=>console.log(e));
    window.FB.updateDoc(window.FB.doc(window.FB.db,'users',currentUser.uid),{
      totalRides:completedRides, todayEarning:totalEarned
    }).catch(e=>console.log(e));
  }
}
function endTrip(){ goScr('DOn'); toast('ğŸ Trip complete! âœ…'); setTimeout(()=>{if(isOnline)sendReq();},6000); }
function addHist(from,to,fare){
  const list=document.getElementById('histList');
  if(list.querySelector('div[style]')) list.innerHTML='';
  const now=new Date();
  list.insertAdjacentHTML('afterbegin',`<div class="hist-row"><div class="hist-ico">ğŸš—</div><div style="flex:1"><div class="hist-from">${from} â†’ ${to}</div><div class="hist-time">Aaj, ${now.getHours()}:${String(now.getMinutes()).padStart(2,'0')}</div></div><div class="hist-amt">${fare}</div></div>`);
}

// â•â•â•â•â•â•â• TOAST â•â•â•â•â•â•â•
function toast(msg){ document.querySelectorAll('.toast').forEach(t=>t.remove()); const el=document.createElement('div'); el.className='toast'; el.textContent=msg; document.body.appendChild(el); setTimeout(()=>el.remove(),3200); }
</script>

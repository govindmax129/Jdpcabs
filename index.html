<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>JDP CABS â€” Firebase Live</title>
<link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800;900&display=swap" rel="stylesheet">

<script src="https://apis.mappls.com/advancedmaps/api/kwzjopzmxtgmraerxyxpsrqqrxhdivkycqnc/map_sdk?layer=vector&v=3.0&callback=onMapReady" defer async></script>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
import { getFirestore, doc, setDoc, getDoc, updateDoc, collection, addDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-storage.js";

const firebaseConfig = {
  apiKey: "AIzaSyBRPV3mosWr3YFnW6xCfJaqC1bV4MhJm_Y",
  authDomain: "jdpcabs.firebaseapp.com",
  projectId: "jdpcabs",
  storageBucket: "jdpcabs.firebasestorage.app",
  messagingSenderId: "148264332732",
  appId: "1:148264332732:web:eed512ac4e685cef97cfb9",
  measurementId: "G-68X79DK95F"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);
const storage = getStorage(app);

window.FB = { auth, db, storage, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, onAuthStateChanged, doc, setDoc, getDoc, updateDoc, collection, addDoc, serverTimestamp, ref, uploadBytes, getDownloadURL };
window.dispatchEvent(new Event('firebaseReady'));
</script>

<style>
/* â•â• THEME VARIABLES (Dark default, Light added) â•â• */
:root {
  --bg:#0a0a0a; --card:#141414; --card2:#1c1c1c;
  --border:#252525; --text:#f1f5f9; --muted:#64748b;
  --yellow:#FBBF24; --yd:#d97706;
  --green:#10b981; --red:#ef4444; --blue:#3b82f6;
}
body.light-mode {
  --bg:#f8fafc; --card:#ffffff; --card2:#f1f5f9;
  --border:#cbd5e1; --text:#0f172a; --muted:#475569;
}
*{margin:0;padding:0;box-sizing:border-box;-webkit-tap-highlight-color:transparent;}
body{font-family:'Plus Jakarta Sans',sans-serif;background:var(--bg);color:var(--text);height:100vh;overflow:hidden;transition:background 0.3s, color 0.3s;}
#map{width:100vw;height:100vh;position:absolute;inset:0;z-index:1;}

/* Light Mode Overrides */
body.light-mode .bsheet, body.light-mode .popup, body.light-mode .prof-screen { background: rgba(255,255,255,0.97); }
body.light-mode .topbar { background: linear-gradient(to bottom, rgba(255,255,255,0.95) 0%, transparent 100%); }
body.light-mode .topbtn { background: rgba(255,255,255,0.9); color: #000; border-color: #cbd5e1; }
body.light-mode .logo-title { color: #000; }
body.light-mode .sinp, body.light-mode .fi, body.light-mode .oi { background: #fff; color: #000; border-color: #cbd5e1; }
body.light-mode .loc-box, body.light-mode .qchip, body.light-mode .ropt, body.light-mode .dcard { background: #fff; border-color: #cbd5e1; }
body.light-mode .auth-hero-ov { background: linear-gradient(to bottom,rgba(255,255,255,0.2),rgba(255,255,255,1)); }
body.light-mode .auth-logo-name { color: #000; }
body.light-mode .auth-tagline { color: #475569; }

/* â•â• LOADER â•â• */
#loader{position:fixed;inset:0;background:var(--bg);z-index:9000;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:16px;}
.ld-icon{width:72px;height:72px;background:var(--yellow);border-radius:20px;display:flex;align-items:center;justify-content:center;font-size:2rem;font-weight:900;color:#000;box-shadow:0 12px 40px rgba(251,191,36,0.4);animation:ldP 2s infinite;}
@keyframes ldP{0%,100%{box-shadow:0 12px 40px rgba(251,191,36,0.4)}50%{box-shadow:0 12px 60px rgba(251,191,36,0.7)}}
.ld-name{font-size:2rem;font-weight:900;}
.ld-badge{display:flex;align-items:center;gap:6px;background:rgba(255,153,51,0.1);border:1px solid rgba(255,153,51,0.2);border-radius:100px;padding:5px 14px;font-size:0.72rem;font-weight:700;color:#FF9933;}
.ld-bar-wrap{width:220px;height:4px;background:rgba(255,255,255,0.07);border-radius:100px;overflow:hidden;}
.ld-bar{height:100%;width:0%;background:linear-gradient(90deg,var(--yellow),#f97316);border-radius:100px;transition:width 0.4s;}
.ld-txt{font-size:0.75rem;color:var(--muted);}

/* â•â• AUTH â•â• */
#authScreen{position:fixed;inset:0;z-index:8000;display:none;flex-direction:column;background:var(--bg);overflow-y:auto;}
#authScreen::-webkit-scrollbar{display:none;}
.auth-hero{position:relative;width:100%;height:200px;overflow:hidden;flex-shrink:0;}
.auth-hero img{width:100%;height:100%;object-fit:cover;opacity:0.45;}
.auth-hero-ov{position:absolute;inset:0;background:linear-gradient(to bottom,rgba(10,10,10,0.2),rgba(10,10,10,1));display:flex;flex-direction:column;justify-content:flex-end;padding:20px 22px 22px;}
.auth-logo{display:flex;align-items:center;gap:12px;margin-bottom:8px;}
.auth-logo-box{width:44px;height:44px;background:var(--yellow);border-radius:13px;display:flex;align-items:center;justify-content:center;font-weight:900;font-size:13px;color:#000;}
.auth-logo-name{font-size:1.5rem;font-weight:900;}
.auth-tagline{font-size:0.8rem;color:rgba(255,255,255,0.6);}
.auth-body{padding:0 18px 40px;}

.role-toggle{display:flex;background:rgba(255,255,255,0.05);border:1px solid var(--border);border-radius:14px;padding:4px;margin-bottom:16px;}
.rtab{flex:1;padding:11px;border-radius:10px;border:none;background:transparent;color:var(--muted);font-family:'Plus Jakarta Sans',sans-serif;font-size:0.85rem;font-weight:700;cursor:pointer;transition:all 0.25s;display:flex;align-items:center;justify-content:center;gap:6px;}
.rtab.active.r{background:var(--yellow);color:#000;}
.rtab.active.d{background:var(--green);color:#fff;}

.auth-tabs{display:flex;gap:4px;margin-bottom:18px;background:rgba(255,255,255,0.04);border:1px solid var(--border);border-radius:12px;padding:4px;}
.atab{flex:1;padding:10px;border-radius:9px;border:none;background:transparent;color:var(--muted);font-family:'Plus Jakarta Sans',sans-serif;font-size:0.84rem;font-weight:700;cursor:pointer;}
.atab.active{background:var(--card2);color:var(--text);box-shadow:0 2px 8px rgba(0,0,0,0.3);}

.auth-form{display:none;}
.auth-form.show{display:block;animation:fUp 0.3s ease;}
@keyframes fUp{from{opacity:0;transform:translateY(12px)}to{opacity:1;transform:translateY(0)}}

.fg{margin-bottom:13px;}
.fl{font-size:0.68rem;font-weight:700;letter-spacing:1.5px;text-transform:uppercase;color:var(--muted);margin-bottom:6px;display:block;}
.fi{width:100%;background:rgba(255,255,255,0.05);border:1.5px solid var(--border);border-radius:12px;padding:13px 15px;color:var(--text);font-family:'Plus Jakarta Sans',sans-serif;font-size:0.9rem;font-weight:500;outline:none;}
.fi:focus{border-color:var(--yellow);}
.fi.gf:focus{border-color:var(--green);}
.frow{display:grid;grid-template-columns:1fr 1fr;gap:11px;}
.ferr{display:none;font-size:0.73rem;color:var(--red);margin-top:5px;font-weight:600;}
.ferr.on{display:block;}

.vgrid{display:grid;grid-template-columns:1fr 1fr;gap:9px;margin-bottom:13px;}
.vcard{background:rgba(255,255,255,0.04);border:1.5px solid var(--border);border-radius:12px;padding:12px;text-align:center;cursor:pointer;}
.vcard.sel{border-color:var(--green);background:rgba(16,185,129,0.07);}
.vcard-ico{font-size:1.7rem;margin-bottom:5px;}
.vcard-name{font-size:0.76rem;font-weight:700;}

.auth-submit{width:100%;border:none;border-radius:14px;padding:16px;font-size:0.97rem;font-weight:800;cursor:pointer;font-family:'Plus Jakarta Sans',sans-serif;}
.auth-submit.y{background:var(--yellow);color:#000;}
.auth-submit.g{background:var(--green);color:#fff;}
.auth-switch{text-align:center;margin-top:14px;font-size:0.8rem;color:var(--muted);}
.auth-switch span{font-weight:700;cursor:pointer;}

.otp-screen{display:none;text-align:center;padding:8px 0;}
.otp-screen.show{display:block;animation:fUp 0.3s ease;}
.otp-inputs{display:flex;gap:9px;justify-content:center;margin:18px 0;}
.oi{width:50px;height:54px;background:rgba(255,255,255,0.06);border:1.5px solid var(--border);border-radius:12px;text-align:center;font-size:1.4rem;font-weight:800;color:var(--text);outline:none;font-family:'Plus Jakarta Sans',sans-serif;}

.fb-badge{display:inline-flex;align-items:center;gap:5px;background:rgba(255,165,0,0.1);border:1px solid rgba(255,165,0,0.2);border-radius:100px;padding:4px 10px;font-size:0.65rem;font-weight:700;color:orange;margin-bottom:14px;}
.fb-badge.ok{background:rgba(16,185,129,0.1);border-color:rgba(16,185,129,0.2);color:var(--green);}

/* â•â• TOP BAR â•â• */
.topbar{position:fixed;top:0;left:0;right:0;z-index:500;display:flex;justify-content:space-between;align-items:center;padding:12px 16px;background:linear-gradient(to bottom,rgba(0,0,0,0.85) 0%,transparent 100%);}
.logo-wrap{display:flex;align-items:center;gap:9px;}
.logo-box{width:40px;height:40px;background:var(--yellow);border-radius:12px;display:flex;align-items:center;justify-content:center;font-weight:900;font-size:12px;color:#000;}
.logo-title{font-size:1.1rem;font-weight:900;color:white;}
.mode-tag{border-radius:100px;padding:3px 9px;font-size:0.6rem;font-weight:800;letter-spacing:0.5px;text-transform:uppercase;}
.mode-tag.r{background:rgba(251,191,36,0.15);border:1px solid rgba(251,191,36,0.3);color:var(--yellow);}
.mode-tag.d{background:rgba(16,185,129,0.15);border:1px solid rgba(16,185,129,0.3);color:var(--green);}
.topbtn{height:38px;background:rgba(0,0,0,0.5);backdrop-filter:blur(12px);border:1px solid rgba(255,255,255,0.1);border-radius:10px;display:flex;align-items:center;justify-content:center;cursor:pointer;font-size:0.85rem;padding:0 12px;font-weight:700;margin-right:6px;}
.prof-chip{display:flex;align-items:center;gap:8px;background:rgba(255,255,255,0.06);border:1px solid var(--border);border-radius:100px;padding:4px 12px 4px 4px;cursor:pointer;}
.prof-av{width:30px;height:30px;border-radius:50%;overflow:hidden;border:2px solid var(--yellow);}
.prof-av img{width:100%;height:100%;object-fit:cover;}
.prof-name{font-size:0.76rem;font-weight:700;max-width:80px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}

/* â•â• LIVE PILL â•â• */
.live-pill{position:fixed;top:72px;left:50%;transform:translateX(-50%);z-index:500;background:rgba(16,185,129,0.12);border:1px solid rgba(16,185,129,0.25);border-radius:100px;padding:6px 14px;font-size:0.68rem;font-weight:700;color:var(--green);display:flex;align-items:center;gap:6px;backdrop-filter:blur(12px);white-space:nowrap;}
.ldot{width:6px;height:6px;background:var(--green);border-radius:50%;animation:blink 1s infinite;}
@keyframes blink{0%,100%{opacity:1}50%{opacity:0.2}}

.locate-btn{position:fixed;right:16px;z-index:500;width:46px;height:46px;background:white;border-radius:50%;border:none;cursor:pointer;font-size:1.1rem;box-shadow:0 4px 18px rgba(0,0,0,0.35);display:flex;align-items:center;justify-content:center;}

/* â•â• DUTY BTN â•â• */
.duty-wrap{position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:500;display:flex;flex-direction:column;align-items:center;gap:12px;pointer-events:none;}
.duty-btn{width:130px;height:130px;border-radius:50%;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:6px;cursor:pointer;pointer-events:all;transition:all 0.4s;position:relative;border:none;font-family:'Plus Jakarta Sans',sans-serif;}
.duty-btn.off{background:rgba(20,20,20,0.9);border:3px solid #333;color:var(--muted);}
.duty-btn.on{background:var(--green);border:3px solid rgba(255,255,255,0.2);color:white;transform:scale(1.05);}
.duty-ico{font-size:2rem;}.duty-txt{font-size:0.68rem;font-weight:800;letter-spacing:2px;text-transform:uppercase;}
.radar{position:absolute;inset:-14px;border-radius:50%;border:2px solid rgba(16,185,129,0.4);animation:radar 1.8s ease-out infinite;}
@keyframes radar{0%{transform:scale(0.8);opacity:1}100%{transform:scale(1.35);opacity:0}}

/* â•â• BOTTOM SHEET â•â• */
.bsheet{position:fixed;bottom:0;left:0;right:0;z-index:400;background:rgba(10,10,10,0.97);backdrop-filter:blur(28px);border-radius:24px 24px 0 0;border-top:1px solid rgba(255,255,255,0.07);padding:0 18px 30px;max-height:80vh;overflow-y:auto;}
.bsheet::-webkit-scrollbar{display:none;}
.handle{width:36px;height:4px;background:rgba(255,255,255,0.12);border-radius:4px;margin:12px auto 18px;}
.scr{display:none;}.scr.on{display:block;animation:fUp 0.3s ease;}

.shdr{display:flex;justify-content:space-between;align-items:center;margin-bottom:16px;}
.stitle{font-size:1.05rem;font-weight:800;}
.sback{font-size:0.8rem;color:var(--muted);cursor:pointer;padding:6px 12px;}
.mbtn{width:100%;border:none;border-radius:15px;padding:16px;font-size:0.96rem;font-weight:800;cursor:pointer;font-family:'Plus Jakarta Sans',sans-serif;}
.mbtn.y{background:var(--yellow);color:#000;}.mbtn.g{background:var(--green);color:#fff;}
.mbtn.ro{background:rgba(239,68,68,0.08);color:var(--red);border:1px solid rgba(239,68,68,0.2);}

.wlbl{font-size:0.65rem;font-weight:800;letter-spacing:2px;text-transform:uppercase;color:var(--muted);margin-bottom:12px;}
.loc-boxes{display:flex;flex-direction:column;gap:9px;margin-bottom:15px;}
.loc-box{display:flex;align-items:center;gap:12px;background:rgba(255,255,255,0.04);border:1.5px solid rgba(255,255,255,0.07);border-radius:14px;padding:12px 14px;cursor:pointer;}
.ldg{width:10px;height:10px;border-radius:50%;background:var(--green);}.ldr{width:10px;height:10px;border-radius:50%;background:var(--red);}
.lbl-main{font-weight:600;font-size:0.87rem;}.lbl-sub{font-size:0.7rem;color:var(--muted);margin-top:2px;}
.qpicks{display:flex;gap:7px;margin-bottom:15px;overflow-x:auto;padding-bottom:2px;}
.qpicks::-webkit-scrollbar{display:none;}
.qchip{background:rgba(255,255,255,0.05);border:1px solid rgba(255,255,255,0.08);border-radius:100px;padding:7px 12px;font-size:0.75rem;font-weight:600;white-space:nowrap;cursor:pointer;}

.sinp-wrap{position:relative;margin-bottom:12px;}
.sinp-ico{position:absolute;left:13px;top:50%;transform:translateY(-50%);}
.sinp{width:100%;background:rgba(255,255,255,0.06);border:1.5px solid rgba(255,255,255,0.09);border-radius:13px;padding:13px 14px 13px 38px;color:white;font-family:'Plus Jakarta Sans',sans-serif;font-size:0.9rem;font-weight:500;outline:none;}
.suglist{display:flex;flex-direction:column;gap:1px;}
.sugrow{display:flex;align-items:center;gap:12px;padding:11px 10px;border-radius:11px;cursor:pointer;}
.sugico{width:40px;height:40px;background:rgba(255,255,255,0.05);border-radius:10px;display:flex;align-items:center;justify-content:center;font-size:1rem;}
.sugname{font-weight:600;font-size:0.86rem;}.sugaddr{font-size:0.71rem;color:var(--muted);}.sugdist{font-size:0.7rem;color:var(--yellow);font-weight:700;}

.rbar{display:flex;align-items:center;gap:10px;background:rgba(255,255,255,0.04);border-radius:12px;padding:12px 14px;margin-bottom:13px;}
.rline{display:flex;flex-direction:column;align-items:center;gap:2px;}
.rg{width:8px;height:8px;border-radius:50%;background:var(--green);}.rr{width:8px;height:8px;border-radius:50%;background:var(--red);}
.rdash{width:2px;height:4px;background:var(--muted);border-radius:1px;}
.rfrom{font-size:0.82rem;font-weight:600;}.rto{font-size:0.82rem;color:var(--muted);margin-top:7px;}
.ropt{display:flex;align-items:center;gap:13px;padding:12px;border:1.5px solid rgba(255,255,255,0.06);border-radius:15px;cursor:pointer;margin-bottom:8px;}
.ropt.sel{border-color:var(--yellow);background:rgba(251,191,36,0.05);}
.rico{width:52px;height:40px;background:rgba(255,255,255,0.05);border-radius:10px;display:flex;align-items:center;justify-content:center;font-size:1.4rem;}
.rname{font-weight:700;font-size:0.9rem;}.rdesc{font-size:0.71rem;color:var(--muted);}.reta{font-size:0.71rem;color:var(--green);font-weight:700;}
.rprice{text-align:right;}
.rp-amt{font-size:1.05rem;font-weight:800;}.rp-sub{font-size:0.67rem;color:var(--muted);}
.payrow{display:flex;align-items:center;justify-content:space-between;background:rgba(255,255,255,0.04);border-radius:12px;padding:12px 14px;margin:12px 0;}

.etabar{display:flex;justify-content:space-between;align-items:center;background:rgba(16,185,129,0.09);border:1px solid rgba(16,185,129,0.2);border-radius:14px;padding:16px;margin-bottom:13px;}
.etanum{font-size:2.4rem;font-weight:900;color:var(--green);line-height:1;}
.etalbl{font-size:0.7rem;color:var(--muted);margin-top:4px;}
.etasteps{display:flex;flex-direction:column;gap:5px;text-align:right;}
.stp{font-size:0.74rem;color:var(--muted);}.stp.on{color:var(--text);font-weight:700;}.stp.done{color:var(--green);text-decoration:line-through;}
.dcard{display:flex;align-items:center;gap:13px;background:rgba(255,255,255,0.04);border:1px solid rgba(255,255,255,0.06);border-radius:15px;padding:14px;margin-bottom:13px;}
.dav{width:50px;height:50px;border-radius:50%;overflow:hidden;border:2px solid var(--yellow);}
.dav img{width:100%;height:100%;object-fit:cover;}

.icard{display:flex;align-items:center;gap:12px;background:rgba(255,255,255,0.04);border:1px solid rgba(255,255,255,0.06);border-radius:14px;padding:14px;margin-bottom:10px;}
.icard-ico{width:44px;height:44px;border-radius:12px;display:flex;align-items:center;justify-content:center;font-size:1.3rem;}
.ic-y{background:rgba(251,191,36,0.12);}

.popup{position:fixed;bottom:0;left:0;right:0;z-index:700;background:rgba(8,8,8,0.99);backdrop-filter:blur(28px);border-radius:24px 24px 0 0;border-top:2px solid var(--yellow);padding:0 18px 32px;transform:translateY(100%);transition:transform 0.4s;}
.popup.show{transform:translateY(0);}
.pop-handle{width:36px;height:4px;background:rgba(255,255,255,0.15);border-radius:4px;margin:12px auto 16px;}
.alert-pill{display:flex;align-items:center;gap:8px;background:rgba(251,191,36,0.1);border:1px solid rgba(251,191,36,0.25);border-radius:100px;padding:7px 14px;margin-bottom:14px;width:fit-content;}
.alert-dot{width:8px;height:8px;background:var(--yellow);border-radius:50%;animation:blink 0.6s infinite;}
.alert-pill span{font-size:0.72rem;font-weight:800;color:var(--yellow);text-transform:uppercase;}
.pop-fare-num{font-size:3rem;font-weight:900;color:var(--yellow);text-align:center;}
.pop-fare-lbl{font-size:0.73rem;color:var(--muted);text-align:center;margin-bottom:16px;}
.timer-wrap{background:rgba(255,255,255,0.05);border-radius:100px;height:5px;margin-bottom:16px;overflow:hidden;}
.timer-bar{height:100%;background:var(--yellow);width:100%;transition:width 0.5s linear;}
.pop-btns{display:flex;gap:12px;margin-top:16px;}
.pop-btn-dec{flex:1;background:rgba(239,68,68,0.08);color:var(--red);border:1px solid rgba(239,68,68,0.2);border-radius:13px;padding:15px;font-weight:700;cursor:pointer;}
.pop-btn-acc{flex:2;background:var(--green);color:white;border:none;border-radius:13px;padding:15px;font-weight:800;cursor:pointer;}

.prof-screen{display:none;position:fixed;inset:0;z-index:600;background:rgba(10,10,10,0.98);backdrop-filter:blur(20px);overflow-y:auto;padding:20px;}
.prof-screen.show{display:block;}

.toast{position:fixed;top:84px;left:50%;transform:translateX(-50%);background:rgba(20,20,20,0.97);border:1px solid rgba(255,255,255,0.09);border-radius:100px;padding:10px 20px;font-size:0.8rem;font-weight:600;z-index:9999;backdrop-filter:blur(16px);animation:tin 0.3s ease,tout 0.3s ease 2.6s forwards;white-space:nowrap;pointer-events:none;}
@keyframes tin{from{opacity:0;top:64px}to{opacity:1;top:84px}}
@keyframes tout{to{opacity:0}}
@keyframes carPulse{0%{transform:scale(0.8);opacity:1}100%{transform:scale(2.2);opacity:0}}
</style>
</head>
<body>

<div id="loader">
  <div class="ld-icon">JDP</div>
  <div class="ld-name">CABS</div>
  <div class="ld-badge">ğŸ”¥ Firebase + ğŸ‡®ğŸ‡³ MapmyIndia</div>
  <div class="ld-bar-wrap"><div class="ld-bar" id="ldBar"></div></div>
  <div class="ld-txt" id="ldTxt">Firebase se connect ho raha hai...</div>
</div>

<div id="map"></div>

<div id="authScreen">
  <div class="auth-hero">
    <img src="https://images.unsplash.com/photo-1449965408869-eaa3f722e40d?auto=format&fit=crop&w=800&q=80">
    <div class="auth-hero-ov">
      <div class="auth-logo"><div class="auth-logo-box">JDP</div><div class="auth-logo-name">CABS</div></div>
      <div class="auth-tagline">ğŸ‡®ğŸ‡³ India ka best cab app â€” Firebase Powered ğŸ”¥</div>
    </div>
  </div>

  <div class="auth-body">
    <div class="fb-badge" id="fbBadge">â³ Firebase connect ho raha hai...</div>

    <div class="role-toggle">
      <button class="rtab active r" id="rTab" onclick="setAuthRole('rider')">ğŸ§ Rider hoon</button>
      <button class="rtab d" id="dTab" onclick="setAuthRole('driver')">ğŸš— Driver hoon</button>
    </div>

    <div class="auth-tabs">
      <button class="atab active" id="loginTab" onclick="setAuthTab('login')">Login Karo</button>
      <button class="atab" id="regTab" onclick="setAuthTab('register')">Naya Account</button>
    </div>

    <div class="auth-form show" id="loginForm">
      <div class="fg">
        <label class="fl">ğŸ“± Mobile Number / Email</label>
        <input type="text" class="fi" id="loginId" placeholder="+91 98765 43210 ya email">
        <div class="ferr" id="loginIdErr">Valid mobile ya email daalo</div>
      </div>
      <div class="fg">
        <label class="fl">ğŸ”’ Password</label>
        <input type="password" class="fi" id="loginPass" placeholder="Apna password">
        <div class="ferr" id="loginPassErr">Password galat hai</div>
      </div>
      <button class="auth-submit y" id="loginBtn" onclick="doLogin()">ğŸš€ Login Karo</button>
      <div class="auth-switch">Account nahi hai? <span class="y" onclick="setAuthTab('register')">Register karo</span></div>
    </div>

    <div class="auth-form" id="riderRegForm">
      <div class="frow">
        <div class="fg"><label class="fl">ğŸ‘¤ Pehla Naam</label><input type="text" class="fi" id="rFn" placeholder="Rahul"></div>
        <div class="fg"><label class="fl">ğŸ‘¤ Aakhri Naam</label><input type="text" class="fi" id="rLn" placeholder="Sharma"></div>
      </div>
      <div class="fg"><label class="fl">ğŸ“± Mobile Number</label><input type="tel" class="fi" id="rPhone" placeholder="+91 98765 43210"></div>
      <div class="fg"><label class="fl">ğŸ“§ Email</label><input type="email" class="fi" id="rEmail" placeholder="rahul@email.com"></div>
      <div class="frow">
        <div class="fg"><label class="fl">ğŸ”’ Password</label><input type="password" class="fi" id="rPass" placeholder="Min 6 chars"></div>
        <div class="fg"><label class="fl">ğŸ”’ Confirm</label><input type="password" class="fi" id="rConf" placeholder="Dobara daalo"></div>
      </div>
      <div class="fg"><label class="fl">ğŸ‚ Date of Birth</label><input type="date" class="fi" id="rDob"></div>
      <button class="auth-submit y" id="riderRegBtn" onclick="doRiderRegister()">âœ… Rider Account Banao</button>
      <div class="auth-switch">Pehle se account hai? <span class="y" onclick="setAuthTab('login')">Login karo</span></div>
    </div>

    <div class="auth-form" id="driverRegForm">
      <div class="frow">
        <div class="fg"><label class="fl">ğŸ‘¤ Pehla Naam</label><input type="text" class="fi gf" id="dFn" placeholder="Ramesh"></div>
        <div class="fg"><label class="fl">ğŸ‘¤ Aakhri Naam</label><input type="text" class="fi gf" id="dLn" placeholder="Kumar"></div>
      </div>
      <div class="fg"><label class="fl">ğŸ“± Mobile Number</label><input type="tel" class="fi gf" id="dPhone" placeholder="+91 98765 43210"></div>
      <div class="fg"><label class="fl">ğŸ“§ Email</label><input type="email" class="fi gf" id="dEmail" placeholder="ramesh@email.com"></div>
      <div class="fg"><label class="fl">ğŸš˜ Vehicle Number</label><input type="text" class="fi gf" id="dVeh" placeholder="CG 17 AZ 1234"></div>

      <div class="fg">
        <label class="fl">ğŸš˜ Vehicle Type</label>
        <div class="vgrid">
          <div class="vcard sel" onclick="selV(this,'Moto')"><div class="vcard-ico">ğŸ›µ</div><div class="vcard-name">Moto/Bike</div></div>
          <div class="vcard" onclick="selV(this,'Auto')"><div class="vcard-ico">ğŸ›º</div><div class="vcard-name">Auto Rickshaw</div></div>
          <div class="vcard" onclick="selV(this,'Hatchback')"><div class="vcard-ico">ğŸš—</div><div class="vcard-name">Hatchback</div></div>
          <div class="vcard" onclick="selV(this,'Sedan')"><div class="vcard-ico">ğŸš™</div><div class="vcard-name">Sedan/SUV</div></div>
        </div>
      </div>
      <div class="frow">
        <div class="fg"><label class="fl">ğŸ”’ Password</label><input type="password" class="fi gf" id="dPass" placeholder="Min 6 chars"></div>
        <div class="fg"><label class="fl">ğŸ”’ Confirm</label><input type="password" class="fi gf" id="dConf" placeholder="Dobara daalo"></div>
      </div>
      <button class="auth-submit g" id="driverRegBtn" onclick="doDriverRegister()">âœ… Driver Account Banao</button>
      <div class="auth-switch">Pehle se account hai? <span class="g" onclick="setAuthTab('login')">Login karo</span></div>
    </div>

    <div class="otp-screen" id="otpScreen">
      <div style="font-size:2rem;margin-bottom:10px">ğŸ“²</div>
      <div style="font-weight:800;font-size:1rem" id="otpPhone">+91 XXXXX XXXXX</div>
      <div style="font-size:0.8rem;color:var(--muted);margin-top:5px;margin-bottom:0">6-digit OTP bheja gaya â€” Demo: 1 2 3 4 5 6</div>
      <div class="otp-inputs">
        <input class="oi" maxlength="1" id="o0" oninput="oNext(this,0)">
        <input class="oi" maxlength="1" id="o1" oninput="oNext(this,1)">
        <input class="oi" maxlength="1" id="o2" oninput="oNext(this,2)">
        <input class="oi" maxlength="1" id="o3" oninput="oNext(this,3)">
        <input class="oi" maxlength="1" id="o4" oninput="oNext(this,4)">
        <input class="oi" maxlength="1" id="o5" oninput="oNext(this,5)">
      </div>
      <button class="auth-submit y" id="otpBtn" onclick="verifyOtp()">âœ… Verify Karo</button>
      <div style="text-align:center;margin-top:12px"><span style="font-size:0.78rem;color:var(--muted);cursor:pointer" onclick="backOtp()">â† Wapas jaao</span></div>
    </div>
  </div>
</div>

<div class="topbar" id="topbar" style="display:none">
  <div class="logo-wrap">
    <div class="logo-box">JDP</div>
    <div class="logo-title">CABS</div>
    <div class="mode-tag r" id="modeTag">Rider</div>
  </div>
  <div style="display:flex;gap:8px;align-items:center">
    <div class="topbtn" onclick="toggleTheme()">â˜€ï¸/ğŸŒ™</div>
    <div class="prof-chip" onclick="openProfScreen()">
      <div class="prof-av"><img src="https://ui-avatars.com/api/?name=U&background=FBBF24&color=000" id="profImg"></div>
      <div class="prof-name" id="profName">User</div>
    </div>
    <div class="topbtn" style="color:var(--red);border-color:rgba(239,68,68,0.2)" onclick="doLogout()">â‡„</div>
  </div>
</div>

<div class="live-pill" id="livePill" style="display:none"><div class="ldot"></div><span id="pillTxt">5 drivers kareeb</span></div>
<button class="locate-btn" id="locBtn" style="display:none;bottom:380px" onclick="locateMe()">ğŸ“</button>

<div class="duty-wrap" id="dutyWrap" style="display:none">
  <div class="duty-btn off" id="dutyBtn" onclick="toggleDuty()"><div class="duty-ico">ğŸš—</div><div class="duty-txt">Offline</div></div>
  <div class="duty-hint">Duty shuru karne ke liye tap karo</div>
</div>

<div class="bsheet" id="bsheet" style="display:none">
  <div class="handle"></div>

  <div class="scr on" id="scrRHome">
    <div class="wlbl">Kahan jaana hai?</div>
    <div class="loc-boxes">
      <div class="loc-box" onclick="openPick('pickup')"><div class="ldg"></div><div style="flex:1;min-width:0"><div class="lbl-main" id="puLbl">Pickup set karo</div><div class="lbl-sub">Search ya map pe tap</div></div><span style="color:var(--muted);font-size:0.8rem">âœ</span></div>
      <div class="loc-box" onclick="openPick('drop')"><div class="ldr"></div><div style="flex:1;min-width:0"><div class="lbl-main" id="drLbl">Kahan jaana hai?</div><div class="lbl-sub">Sheher, landmark, area...</div></div><span style="color:var(--muted);font-size:0.8rem">âœ</span></div>
    </div>
    <div class="qpicks">
      <div class="qchip" onclick="qpick('mall')">ğŸ›ï¸ Binaka Mall</div>
      <div class="qchip" onclick="qpick('station')">ğŸš‰ Station</div>
      <div class="qchip" onclick="qpick('lake')">ğŸŒŠ Dalpat Sagar</div>
      <div class="qchip" onclick="qpick('palace')">ğŸ° Bastar Palace</div>
    </div>
    <button class="mbtn y" onclick="goRides()">ğŸš— Ride Dekho &amp; Book Karo</button>
  </div>

  <div class="scr" id="scrSearch">
    <div class="shdr"><div class="stitle" id="searchTitle">Pickup Set Karo</div><div class="sback" onclick="goScr('RHome')">â† Wapas</div></div>
    <div class="sinp-wrap"><span class="sinp-ico">ğŸ”</span><input type="text" class="sinp" id="sinp" placeholder="Jagah dhundho..." oninput="filterSug(this.value)"></div>
    <div class="suglist" id="suglist"></div>
  </div>

  <div class="scr" id="scrRides">
    <div class="shdr"><div class="stitle">Ride Chuniye</div><div class="sback" onclick="goScr('RHome')">â† Wapas</div></div>
    <div class="rbar">
      <div class="rline"><div class="rg"></div><div class="rdash"></div><div class="rdash"></div><div class="rdash"></div><div class="rr"></div></div>
      <div style="flex:1;min-width:0"><div class="rfrom" id="rfrom">Pickup</div><div class="rto" id="rto">Drop</div></div>
      <div style="text-align:right"><div id="rdist" style="font-weight:800;font-size:0.9rem">â€”</div><div style="font-size:0.67rem;color:var(--muted)">doori</div></div>
    </div>
    <div id="rlist"></div>
    <div class="payrow"><div class="payl"><span>ğŸ’³</span><span>Cash Payment</span></div><span style="font-size:0.73rem;color:var(--yellow);cursor:pointer;font-weight:700">Change â†’</span></div>
    <button class="mbtn y" onclick="confirmRide()">âœ… Booking Confirm Karo</button>
  </div>

  <div class="scr" id="scrTrack">
    <div class="shdr"><div class="stitle">Live Tracking ğŸ‡®ğŸ‡³</div><div class="sback" onclick="cancelRide()">Cancel</div></div>
    <div class="etabar">
      <div><div class="etanum" id="etaNum">4</div><div class="etalbl">min mein aayega</div></div>
      <div class="etasteps">
        <div class="stp done" id="rs1">âœ“ Booking confirm</div>
        <div class="stp on" id="rs2">ğŸš— Driver aa raha hai</div>
        <div class="stp" id="rs3">ğŸ“ Pickup pe pahuncha</div>
        <div class="stp" id="rs4">ğŸ Trip shuru</div>
      </div>
    </div>
    <div class="dcard">
      <div class="dav"><img src="https://randomuser.me/api/portraits/men/44.jpg"></div>
      <div style="flex:1"><div class="dname">Ramesh Kumar</div><div class="dcar">ğŸš— Swift Dzire Â· CG 17 AZ 5678</div></div>
    </div>
    <button class="mbtn ro" onclick="cancelRide()">Ride Cancel Karo</button>
  </div>

  <div class="scr" id="scrDOff">
    <div style="text-align:center;padding:8px 0 18px">
      <div style="font-size:1.3rem;font-weight:900;margin-bottom:6px" id="drvWelcome">Namaste, Driver! ğŸ‘‹</div>
      <div style="font-size:0.82rem;color:var(--muted)">Duty on karo â€” requests aayenge!</div>
    </div>
    <button class="mbtn g" onclick="goOnline()">ğŸŸ¢ Duty Shuru Karo</button>
  </div>

  <div class="scr" id="scrDOn">
    <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:16px">
      <div class="stitle">Live Dashboard</div>
      <div style="display:flex;align-items:center;gap:6px;background:rgba(16,185,129,0.1);border:1px solid rgba(16,185,129,0.2);border-radius:100px;padding:6px 12px;font-size:0.7rem;font-weight:700;color:var(--green)"><div class="ldot"></div>Online</div>
    </div>
    <div class="icard"><div class="icard-ico ic-y">ğŸ’°</div><div class="icard-body"><div class="icard-title">Aaj ki Kamai</div></div><div class="icard-val" style="color:var(--yellow)">â‚¹0</div></div>
    <button class="mbtn ro" onclick="goOffline()">ğŸ”´ Duty Band Karo</button>
  </div>
  
  <div class="scr" id="scrDRide">
    <div class="stitle" style="margin-bottom:14px">Trip Active ğŸš—</div>
    <button class="mbtn y" onclick="endTrip()">ğŸ Trip Complete Karo</button>
  </div>
</div>

<div class="popup" id="ridePopup">
  <div class="pop-handle"></div>
  <div class="alert-pill"><div class="alert-dot"></div><span>Nayi Ride Request!</span></div>
  <div class="pop-fare"><div class="pop-fare-num" id="popFare">â‚¹220</div><div class="pop-fare-lbl">Estimated Fare</div></div>
  <div class="timer-wrap"><div class="timer-bar" id="timerBar"></div></div>
  <div style="display:flex;gap:10px;margin-bottom:14px;background:rgba(255,255,255,0.04);padding:10px;border-radius:10px;">
    <div style="flex:1"><div style="font-weight:800;font-size:0.95rem" id="popDist">â€”</div><div style="font-size:0.67rem;color:var(--muted);">Doori</div></div>
    <div style="flex:1"><div style="font-weight:800;font-size:0.95rem" id="popFrom">Pickup</div></div>
  </div>
  <div class="pop-btns">
    <button class="pop-btn-dec" onclick="declineRide()">âŒ Decline</button>
    <button class="pop-btn-acc" onclick="acceptRide()">âœ… Accept</button>
  </div>
</div>

<div class="prof-screen" id="profScreen">
  <div style="display:flex;justify-content:space-between;margin-bottom:24px"><div style="font-size:1.1rem;font-weight:800">Meri Profile</div><div class="sback" onclick="closeProfScreen()">âœ• Band karo</div></div>
  <div style="text-align:center;margin-bottom:20px"><img style="width:80px;height:80px;border-radius:50%;border:3px solid var(--yellow)" src="" id="profBigImg"></div>
  <button class="mbtn ro" onclick="doLogout()">ğŸšª Logout Karo</button>
</div>

<script>
// â•â•â•â•â•â•â• GLOBALS â•â•â•â•â•â•â•
let authRole='rider', authTab='login', currentUser=null, fbReady=false;
let mapMode='none', lmap=null, mmap=null;
let puCoords=null, drCoords=null, puMarker=null, drMarker=null, routeLine=null;
let drvObjs=[], pickerType='pickup';
let isOnline=false, onlineStart=null, onlineTimer=null, requestTimer=null;

// ğŸŸ¢ NEW: Uber jaisi premium notification sound aur Jagdalpur Map Center
const notifySound = new Audio('https://assets.mixkit.co/active_storage/sfx/2869/2869-preview.mp3');
const CENTER = [19.0775, 82.0240]; // Jagdalpur Center

// ğŸŸ¢ NEW: Day/Night Theme Toggle
function toggleTheme() {
  document.body.classList.toggle('light-mode');
}

window.addEventListener('firebaseReady', ()=>{
  fbReady=true;
  document.getElementById('fbBadge').className='fb-badge ok';
  document.getElementById('fbBadge').textContent='âœ… Firebase Connected!';
  window.FB.onAuthStateChanged(window.FB.auth, async (user)=>{
    if(user){
      try{
        const snap = await window.FB.getDoc(window.FB.doc(window.FB.db,'users',user.uid));
        if(snap.exists()){
          currentUser={uid:user.uid,...snap.data()};
          document.getElementById('authScreen').style.display='none';
          launchApp();
        }
      }catch(e){ console.log(e); }
    }
  });
});

let ldProg=0;
const ldIv=setInterval(()=>{ ldProg+=Math.random()*14; if(ldProg>88) ldProg=88; document.getElementById('ldBar').style.width=ldProg+'%'; },350);
function finishLoad(){
  clearInterval(ldIv); document.getElementById('ldBar').style.width='100%';
  setTimeout(()=>{ document.getElementById('loader').style.display='none'; if(!currentUser) document.getElementById('authScreen').style.display='flex'; },700);
}

// â•â•â•â•â•â•â• MAP INITIALIZATION â•â•â•â•â•â•â•
window.onMapReady=function(){
  mapMode='mappls'; 
  try{
    mmap=new mappls.Map('map',{center:CENTER,zoom:14,search:false});
    mmap.on('load',()=>{ finishLoad(); spawnCars(); setInterval(moveCars,2000); });
  }catch(e){ useFallback(); }
};
setTimeout(()=>{ if(mapMode==='none') useFallback(); },7000);

function useFallback(){
  mapMode='leaflet';
  // ğŸŸ¢ NEW: Jagdalpur Map Boundary Lock
  const southWest = L.latLng(19.0000, 81.9500);
  const northEast = L.latLng(19.1500, 82.1000);
  const jdpBounds = L.latLngBounds(southWest, northEast);
  
  lmap=L.map('map',{zoomControl:true, maxBounds: jdpBounds, maxBoundsViscosity: 1.0, minZoom: 13}).setView(CENTER,14);
  L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png',{maxZoom:19}).addTo(lmap);
  spawnCars(); setInterval(moveCars,2000); finishLoad();
}

// ğŸŸ¢ NEW: Cars spawn around Jagdalpur Center
const carPos=[[19.078, 82.025], [19.075, 82.022], [19.080, 82.020], [19.072, 82.028], [19.082, 82.026]];
function spawnCars(){
  carPos.forEach(p=>{
    if(mapMode==='leaflet'){ const m=L.marker(p,{icon:carIcon()}).addTo(lmap); drvObjs.push({m,pos:[...p],mode:'leaflet'}); }
    else{ try{ const m=new mappls.Marker({map:mmap,position:{lat:p[0],lng:p[1]}}); drvObjs.push({m,pos:[...p],mode:'mappls'}); }catch(e){} }
  });
}
function moveCars(){ drvObjs.forEach(d=>{ d.pos[0]+=(Math.random()-.5)*.0005; d.pos[1]+=(Math.random()-.5)*.0005; try{ if(d.mode==='leaflet') d.m.setLatLng(d.pos); else d.m.setPosition({lat:d.pos[0],lng:d.pos[1]}); }catch(e){} }); }
function carIcon(){ return L.divIcon({className:'',html:`<div style="font-size:20px;">ğŸš—</div>`,iconSize:[20,20],iconAnchor:[10,10]}); }
function pinIcon(c){ const col=c==='g'?'#10b981':'#ef4444'; return L.divIcon({className:'',html:`<div style="width:14px;height:14px;background:${col};border-radius:50%;border:3px solid white;"></div>`,iconSize:[14,14],iconAnchor:[7,7]}); }

function setAuthRole(r){
  authRole=r;
  document.getElementById('rTab').className='rtab'+(r==='rider'?' active r':'');
  document.getElementById('dTab').className='rtab'+(r==='driver'?' active d':'');
  if(authTab==='register'){
    document.getElementById('riderRegForm').className='auth-form'+(r==='rider'?' show':'');
    document.getElementById('driverRegForm').className='auth-form'+(r==='driver'?' show':'');
  }
}
function setAuthTab(t){
  authTab=t;
  document.getElementById('loginTab').className='atab'+(t==='login'?' active':'');
  document.getElementById('regTab').className='atab'+(t==='register'?' active':'');
  document.getElementById('loginForm').className='auth-form'+(t==='login'?' show':'');
  document.getElementById('riderRegForm').className='auth-form'+(t==='register'&&authRole==='rider'?' show':'');
  document.getElementById('driverRegForm').className='auth-form'+(t==='register'&&authRole==='driver'?' show':'');
}

async function doLogin(){
  const id=document.getElementById('loginId').value.trim(); const pass=document.getElementById('loginPass').value;
  if(!id || !pass) return;
  let email=id.includes('@')?id:id.replace(/[^0-9]/g,'')+'@jdpcabs.in';
  try{
    const cred=await window.FB.signInWithEmailAndPassword(window.FB.auth, email, pass);
    const snap=await window.FB.getDoc(window.FB.doc(window.FB.db,'users',cred.user.uid));
    currentUser={uid:cred.user.uid,...snap.data()};
    document.getElementById('authScreen').style.display='none'; launchApp();
  }catch(e){ alert('Error: ' + e.message); }
}
async function doRiderRegister(){ /* Omitted for brevity, use existing Firebase login logic */ }
async function doDriverRegister(){ /* Omitted for brevity */ }
function verifyOtp(){ document.getElementById('authScreen').style.display='none'; launchApp(); }
async function doLogout(){
  await window.FB.signOut(window.FB.auth);
  currentUser=null; document.getElementById('authScreen').style.display='flex';
}

function launchApp(){
  document.getElementById('topbar').style.display='flex';
  document.getElementById('bsheet').style.display='block';
  if(currentUser.role==='rider'){
    document.getElementById('modeTag').textContent='Rider';
    setPickup(CENTER,'Aapki Location'); goScr('RHome');
  } else {
    document.getElementById('modeTag').textContent='Driver';
    document.getElementById('dutyWrap').style.display='flex'; goScr('DOff');
  }
}

function goScr(name){ document.querySelectorAll('.scr').forEach(s=>s.classList.remove('on')); const el=document.getElementById('scr'+name); if(el) el.classList.add('on'); }
function flyTo(ll){ if(mapMode==='leaflet') lmap.flyTo(ll,15); }

function setPickup(ll,label){ puCoords=ll; document.getElementById('puLbl').textContent=label; if(mapMode==='leaflet'){ if(puMarker) lmap.removeLayer(puMarker); puMarker=L.marker(ll,{icon:pinIcon('g')}).addTo(lmap); } }
function setDrop(ll,label){ drCoords=ll; document.getElementById('drLbl').textContent=label; if(mapMode==='leaflet'){ if(drMarker) lmap.removeLayer(drMarker); drMarker=L.marker(ll,{icon:pinIcon('r')}).addTo(lmap); } }

// â•â•â•â•â•â•â• REPAIRED: Search & Suggestions Functions â•â•â•â•â•â•â•
const SUGS=[
  {i:'ğŸ›ï¸',n:'Binaka Mall',a:'Jagdalpur',lat:19.0750,lon:82.0210,d:'1.2 km'},
  {i:'ğŸŒŠ',n:'Dalpat Sagar',a:'Jagdalpur',lat:19.0850,lon:82.0150,d:'2.1 km'},
  {i:'ğŸ°',n:'Bastar Palace',a:'Jagdalpur',lat:19.0810,lon:82.0280,d:'1.4 km'},
  {i:'ğŸš‰',n:'Railway Station',a:'Jagdalpur',lat:19.0650,lon:82.0250,d:'3.0 km'},
  {i:'ğŸ›•',n:'Maa Danteshwari Temple',a:'Jagdalpur',lat:19.0820,lon:82.0290,d:'1.5 km'},
  {i:'âœˆï¸',n:'Maa Danteshwari Airport',a:'Jagdalpur',lat:19.0600,lon:82.0350,d:'4.0 km'},
];

function openPick(type){ 
  pickerType=type; 
  document.getElementById('searchTitle').textContent=type==='pickup'?'Pickup Set Karo':'Drop Set Karo'; 
  document.getElementById('sinp').value=''; 
  renderSugs(SUGS); 
  goScr('Search'); 
}

function renderSugs(list){ 
  document.getElementById('suglist').innerHTML=list.map(s=>`<div class="sugrow" onclick="pickSug(${s.lat},${s.lon},'${s.n.replace(/'/g,"\\'")}')"><div class="sugico">${s.i}</div><div style="flex:1;min-width:0"><div class="sugname">${s.n}</div><div class="sugaddr">${s.a}</div></div><div class="sugdist">${s.d}</div></div>`).join(''); 
}

function filterSug(q){ 
  if(!q.trim()){renderSugs(SUGS);return;} 
  renderSugs(SUGS.filter(s=>s.n.toLowerCase().includes(q.toLowerCase())||s.a.toLowerCase().includes(q.toLowerCase()))); 
}

function pickSug(lat,lon,name){ 
  const ll=[lat,lon]; 
  if(pickerType==='pickup') setPickup(ll,name); else setDrop(ll,name); 
  flyTo(ll); goScr('RHome'); toast(`ğŸ“ ${name} set ho gaya!`); 
}

const QP={mall:{n:'Binaka Mall',lat:19.0750,lon:82.0210},station:{n:'Railway Station',lat:19.0650,lon:82.0250},lake:{n:'Dalpat Sagar',lat:19.0850,lon:82.0150},palace:{n:'Bastar Palace',lat:19.0810,lon:82.0280}};
function qpick(k){ const p=QP[k]; setDrop([p.lat,p.lon],p.n); flyTo([p.lat,p.lon]); toast(`ğŸ¯ Drop: ${p.n}`); }

function getDist(a,b){ const R=6371,dL=(b[0]-a[0])*Math.PI/180,dN=(b[1]-a[1])*Math.PI/180; const x=Math.sin(dL/2)**2+Math.cos(a[0]*Math.PI/180)*Math.cos(b[0]*Math.PI/180)*Math.sin(dN/2)**2; return R*2*Math.atan2(Math.sqrt(x),Math.sqrt(1-x)); }

const RIDES=[{i:'ğŸ›µ',n:'Moto',base:11},{i:'ğŸš—',n:'GO',base:17},{i:'ğŸš™',n:'Prime',base:25}];
function goRides(){
  if(!puCoords||!drCoords){ toast('Pickup/Drop set karo!'); return; }
  const km=getDist(puCoords,drCoords);
  document.getElementById('rlist').innerHTML=RIDES.map((r,i)=>`<div class="ropt ${i===1?'sel':''}" onclick="selR(this, ${Math.round(r.base*km+40)})"><div class="rico">${r.i}</div><div style="flex:1"><b>${r.n}</b></div><div style="font-weight:bold; color:var(--yellow)">â‚¹${Math.round(r.base*km+40)}</div></div>`).join('');
  goScr('Rides');
}
function selR(el, f){ document.querySelectorAll('.ropt').forEach(e=>e.classList.remove('sel')); el.classList.add('sel'); }

function confirmRide(){
  // ğŸŸ¢ NEW: 2.5km Perfect Radius Driver Search Logic
  const MAX_RADIUS = 2.5; 
  let nearestDriver = null;
  let minDistance = 999;
  
  drvObjs.forEach(driver => {
    let dist = getDist(puCoords, driver.pos);
    if(dist < minDistance) { minDistance = dist; nearestDriver = driver; }
  });

  if(minDistance > MAX_RADIUS) {
    toast('âš ï¸ Cabs 2.5km se door hain, thoda wait lag sakta hai!');
  } else {
    toast('âœ… Driver mil gaya!');
  }

  // Play notification chime for rider (simulate assignment)
  notifySound.play().catch(e => console.log('Audio autoplay blocked by browser.'));

  goScr('Track');
  
  let eta=4; document.getElementById('etaNum').textContent=eta;
  document.getElementById('rs1').className='stp done';
  document.getElementById('rs2').className='stp on';
}

function cancelRide(){ goScr('RHome'); toast('âŒ Cancelled'); }

// â•â•â•â•â•â•â• DRIVER â•â•â•â•â•â•â•
function toggleDuty(){ if(!isOnline) goOnline(); else goOffline(); }
function goOnline(){ isOnline=true; document.getElementById('dutyBtn').className='duty-btn on'; goScr('DOn'); setTimeout(()=>sendReq(), 3000); }
function goOffline(){ isOnline=false; document.getElementById('dutyBtn').className='duty-btn off'; goScr('DOff'); }

function sendReq(){
  if(!isOnline) return;
  document.getElementById('ridePopup').classList.add('show');
  document.getElementById('popFrom').textContent = 'Binaka Mall';
  
  // ğŸŸ¢ NEW: Uber Style Sound Alert for Driver
  notifySound.play().catch(e => console.log('Driver alert sound blocked by browser.'));
}
function declineRide(){ document.getElementById('ridePopup').classList.remove('show'); setTimeout(()=>sendReq(), 5000); }
function acceptRide(){ document.getElementById('ridePopup').classList.remove('show'); goScr('DRide'); }
function endTrip(){ goScr('DOn'); setTimeout(()=>sendReq(), 4000); }

function toast(msg){ const el=document.createElement('div'); el.className='toast'; el.textContent=msg; document.body.appendChild(el); setTimeout(()=>el.remove(),3000); }
function openProfScreen(){ document.getElementById('profScreen').className='prof-screen show'; }
function closeProfScreen(){ document.getElementById('profScreen').className='prof-screen'; }
function locateMe(){ toast('ğŸ“ Location dhundh raha hai...'); navigator.geolocation?.getCurrentPosition(p=>{ const ll=[p.coords.latitude,p.coords.longitude]; setPickup(ll,'Aapki Location'); flyTo(ll); toast('âœ… Location mil gayi!'); }); }
</script>
</body>
</html>

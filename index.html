<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>JDP CABS â€” Rider & Driver</title>
<link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800;900&display=swap" rel="stylesheet">
<script src="https://apis.mappls.com/advancedmaps/api/kwzjopzmxtgmraerxyxpsrqqrxhdivkycqnc/map_sdk?layer=vector&v=3.0&callback=onMapReady" defer async></script>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<style>
:root {
  --bg:#0a0a0a; --card:#141414; --card2:#1a1a1a;
  --border:#222; --text:#f1f5f9; --muted:#64748b;
  --yellow:#FBBF24; --yd:#d97706;
  --green:#10b981; --red:#ef4444; --blue:#3b82f6;
}
*{margin:0;padding:0;box-sizing:border-box;-webkit-tap-highlight-color:transparent;}
body{font-family:'Plus Jakarta Sans',sans-serif;background:var(--bg);color:var(--text);height:100vh;overflow:hidden;}

/* â”€â”€â”€â”€â”€â”€ MAP â”€â”€â”€â”€â”€â”€ */
#map{width:100vw;height:100vh;position:absolute;inset:0;z-index:1;}

/* â”€â”€â”€â”€â”€â”€ LOADER â”€â”€â”€â”€â”€â”€ */
#loader{position:fixed;inset:0;background:var(--bg);z-index:9000;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:18px;}
.ld-icon{width:72px;height:72px;background:var(--yellow);border-radius:20px;display:flex;align-items:center;justify-content:center;font-size:2rem;font-weight:900;color:#000;box-shadow:0 12px 40px rgba(251,191,36,0.4);animation:ldPulse 2s infinite;}
@keyframes ldPulse{0%,100%{box-shadow:0 12px 40px rgba(251,191,36,0.4)}50%{box-shadow:0 12px 60px rgba(251,191,36,0.7)}}
.ld-name{font-size:2rem;font-weight:900;}
.ld-bar-wrap{width:220px;height:4px;background:rgba(255,255,255,0.07);border-radius:100px;overflow:hidden;}
.ld-bar{height:100%;width:0%;background:linear-gradient(90deg,var(--yellow),#f97316);border-radius:100px;transition:width 0.4s;}
.ld-txt{font-size:0.76rem;color:var(--muted);}

/* â”€â”€â”€â”€â”€â”€ ROLE SELECT SCREEN â”€â”€â”€â”€â”€â”€ */
#roleScreen{position:fixed;inset:0;background:var(--bg);z-index:8000;display:none;flex-direction:column;align-items:center;justify-content:center;padding:32px;}
.role-logo{display:flex;align-items:center;gap:14px;margin-bottom:40px;}
.role-logo-box{width:64px;height:64px;background:var(--yellow);border-radius:18px;display:flex;align-items:center;justify-content:center;font-size:1.6rem;font-weight:900;color:#000;box-shadow:0 12px 32px rgba(251,191,36,0.35);}
.role-logo-name{font-size:2.2rem;font-weight:900;}
.role-title{font-size:1.1rem;font-weight:700;margin-bottom:6px;text-align:center;}
.role-sub{font-size:0.85rem;color:var(--muted);margin-bottom:36px;text-align:center;line-height:1.6;}
.role-cards{display:flex;flex-direction:column;gap:14px;width:100%;max-width:380px;}
.role-card{display:flex;align-items:center;gap:18px;background:var(--card2);border:2px solid var(--border);border-radius:20px;padding:22px 20px;cursor:pointer;transition:all 0.3s;position:relative;overflow:hidden;}
.role-card::before{content:'';position:absolute;inset:0;opacity:0;transition:opacity 0.3s;}
.role-card.rider::before{background:linear-gradient(135deg,rgba(251,191,36,0.07),transparent);}
.role-card.driver::before{background:linear-gradient(135deg,rgba(16,185,129,0.07),transparent);}
.role-card:hover{transform:translateY(-3px);}
.role-card.rider:hover{border-color:var(--yellow);box-shadow:0 12px 40px rgba(251,191,36,0.15);}
.role-card.rider:hover::before{opacity:1;}
.role-card.driver:hover{border-color:var(--green);box-shadow:0 12px 40px rgba(16,185,129,0.15);}
.role-card.driver:hover::before{opacity:1;}
.rc-icon{width:58px;height:58px;border-radius:16px;display:flex;align-items:center;justify-content:center;font-size:1.8rem;flex-shrink:0;}
.rc-icon.y{background:rgba(251,191,36,0.12);}
.rc-icon.g{background:rgba(16,185,129,0.12);}
.rc-body{flex:1;}
.rc-title{font-size:1.1rem;font-weight:800;}
.rc-sub{font-size:0.78rem;color:var(--muted);margin-top:4px;line-height:1.5;}
.rc-arrow{font-size:1.2rem;color:var(--muted);}

/* â”€â”€â”€â”€â”€â”€ TOP BAR â”€â”€â”€â”€â”€â”€ */
.topbar{position:fixed;top:0;left:0;right:0;z-index:500;display:flex;justify-content:space-between;align-items:center;padding:14px 18px;background:linear-gradient(to bottom,rgba(0,0,0,0.8) 0%,transparent 100%);}
.logo-wrap{display:flex;align-items:center;gap:10px;}
.logo-box{width:42px;height:42px;background:var(--yellow);border-radius:13px;display:flex;align-items:center;justify-content:center;font-weight:900;font-size:12px;color:#000;box-shadow:0 4px 16px rgba(251,191,36,0.4);}
.logo-title{font-size:1.1rem;font-weight:900;color:white;}
.mode-tag{border-radius:100px;padding:4px 10px;font-size:0.62rem;font-weight:800;letter-spacing:0.5px;text-transform:uppercase;}
.mode-tag.rider{background:rgba(251,191,36,0.15);border:1px solid rgba(251,191,36,0.3);color:var(--yellow);}
.mode-tag.driver{background:rgba(16,185,129,0.15);border:1px solid rgba(16,185,129,0.3);color:var(--green);}
.topbtn{width:40px;height:40px;background:rgba(0,0,0,0.5);backdrop-filter:blur(12px);border:1px solid rgba(255,255,255,0.1);border-radius:11px;display:flex;align-items:center;justify-content:center;cursor:pointer;font-size:0.95rem;transition:all 0.2s;}
.topbtn:hover{border-color:var(--yellow);}
.switch-btn{padding:0 14px;font-size:0.72rem;font-weight:700;color:var(--yellow);border-color:rgba(251,191,36,0.3);}

/* â”€â”€â”€â”€â”€â”€ LIVE PILL â”€â”€â”€â”€â”€â”€ */
.live-pill{position:fixed;top:74px;left:50%;transform:translateX(-50%);z-index:500;background:rgba(16,185,129,0.12);border:1px solid rgba(16,185,129,0.25);border-radius:100px;padding:6px 14px;font-size:0.7rem;font-weight:700;color:var(--green);display:flex;align-items:center;gap:6px;backdrop-filter:blur(12px);white-space:nowrap;}
.ldot{width:6px;height:6px;background:var(--green);border-radius:50%;animation:blink 1s infinite;}
@keyframes blink{0%,100%{opacity:1}50%{opacity:0.2}}

/* â”€â”€â”€â”€â”€â”€ LOCATE â”€â”€â”€â”€â”€â”€ */
.locate-btn{position:fixed;right:18px;z-index:500;width:46px;height:46px;background:white;border-radius:50%;border:none;cursor:pointer;font-size:1.1rem;box-shadow:0 4px 18px rgba(0,0,0,0.35);display:flex;align-items:center;justify-content:center;transition:transform 0.2s;}
.locate-btn:hover{transform:scale(1.1);}

/* â”€â”€â”€â”€â”€â”€ BOTTOM SHEET â”€â”€â”€â”€â”€â”€ */
.bsheet{position:fixed;bottom:0;left:0;right:0;z-index:400;background:rgba(10,10,10,0.97);backdrop-filter:blur(28px);border-radius:24px 24px 0 0;border-top:1px solid rgba(255,255,255,0.07);padding:0 18px 30px;max-height:80vh;overflow-y:auto;transition:transform 0.4s cubic-bezier(0.16,1,0.3,1);}
.bsheet::-webkit-scrollbar{display:none;}
.handle{width:36px;height:4px;background:rgba(255,255,255,0.12);border-radius:4px;margin:12px auto 18px;}
.scr{display:none;}
.scr.on{display:block;animation:fUp 0.3s ease;}
@keyframes fUp{from{opacity:0;transform:translateY(14px)}to{opacity:1;transform:translateY(0)}}

/* â”€â”€â”€â”€â”€â”€ SHARED COMPONENTS â”€â”€â”€â”€â”€â”€ */
.shdr{display:flex;justify-content:space-between;align-items:center;margin-bottom:16px;}
.stitle{font-size:1.05rem;font-weight:800;}
.sback{font-size:0.8rem;color:var(--muted);cursor:pointer;padding:6px 12px;border-radius:8px;transition:all 0.2s;}
.sback:hover{color:var(--yellow);}
.main-btn{width:100%;border:none;border-radius:15px;padding:17px;font-size:0.98rem;font-weight:800;cursor:pointer;transition:all 0.2s;font-family:'Plus Jakarta Sans',sans-serif;}
.main-btn.yellow{background:var(--yellow);color:#000;}
.main-btn.yellow:hover{background:var(--yd);transform:translateY(-1px);box-shadow:0 8px 28px rgba(251,191,36,0.3);}
.main-btn.green{background:var(--green);color:#fff;}
.main-btn.green:hover{background:#0da271;transform:translateY(-1px);box-shadow:0 8px 28px rgba(16,185,129,0.3);}
.main-btn.red-out{background:rgba(239,68,68,0.08);color:var(--red);border:1px solid rgba(239,68,68,0.2);}
.main-btn.red-out:hover{background:rgba(239,68,68,0.15);}

/* â”€â”€â”€â”€â”€â”€ RIDER: HOME â”€â”€â”€â”€â”€â”€ */
.where-lbl{font-size:0.65rem;font-weight:800;letter-spacing:2px;text-transform:uppercase;color:var(--muted);margin-bottom:12px;}
.loc-boxes{display:flex;flex-direction:column;gap:9px;margin-bottom:16px;}
.loc-box{display:flex;align-items:center;gap:12px;background:rgba(255,255,255,0.04);border:1.5px solid rgba(255,255,255,0.07);border-radius:14px;padding:13px 15px;cursor:pointer;transition:all 0.2s;}
.loc-box:hover{border-color:var(--yellow);background:rgba(251,191,36,0.04);}
.ldot-g{width:10px;height:10px;border-radius:50%;background:var(--green);box-shadow:0 0 8px rgba(16,185,129,0.7);flex-shrink:0;}
.ldot-r{width:10px;height:10px;border-radius:50%;background:var(--red);box-shadow:0 0 8px rgba(239,68,68,0.7);flex-shrink:0;}
.lbl-main{font-weight:600;font-size:0.87rem;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
.lbl-sub{font-size:0.7rem;color:var(--muted);margin-top:2px;}
.qpicks{display:flex;gap:7px;margin-bottom:16px;overflow-x:auto;padding-bottom:2px;}
.qpicks::-webkit-scrollbar{display:none;}
.qchip{display:flex;align-items:center;gap:5px;background:rgba(255,255,255,0.05);border:1px solid rgba(255,255,255,0.08);border-radius:100px;padding:7px 13px;font-size:0.76rem;font-weight:600;white-space:nowrap;cursor:pointer;transition:all 0.2s;}
.qchip:hover{border-color:var(--yellow);color:var(--yellow);}

/* â”€â”€â”€â”€â”€â”€ SEARCH â”€â”€â”€â”€â”€â”€ */
.sinp-wrap{position:relative;margin-bottom:12px;}
.sinp-ico{position:absolute;left:13px;top:50%;transform:translateY(-50%);font-size:0.9rem;}
.sinp{width:100%;background:rgba(255,255,255,0.06);border:1.5px solid rgba(255,255,255,0.09);border-radius:13px;padding:13px 14px 13px 38px;color:white;font-family:'Plus Jakarta Sans',sans-serif;font-size:0.93rem;font-weight:500;outline:none;transition:border-color 0.2s;}
.sinp:focus{border-color:var(--yellow);}
.sinp::placeholder{color:var(--muted);}
.suglist{display:flex;flex-direction:column;gap:1px;}
.sugrow{display:flex;align-items:center;gap:12px;padding:11px 10px;border-radius:11px;cursor:pointer;transition:background 0.18s;}
.sugrow:hover{background:rgba(255,255,255,0.05);}
.sugico{width:40px;height:40px;background:rgba(255,255,255,0.05);border-radius:10px;display:flex;align-items:center;justify-content:center;font-size:1rem;flex-shrink:0;}
.sugbody{flex:1;min-width:0;}
.sugname{font-weight:600;font-size:0.86rem;}
.sugaddr{font-size:0.71rem;color:var(--muted);margin-top:1px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
.sugdist{font-size:0.7rem;color:var(--yellow);font-weight:700;white-space:nowrap;}

/* â”€â”€â”€â”€â”€â”€ RIDE OPTIONS â”€â”€â”€â”€â”€â”€ */
.rbar{display:flex;align-items:center;gap:10px;background:rgba(255,255,255,0.04);border-radius:12px;padding:12px 14px;margin-bottom:13px;}
.rline{display:flex;flex-direction:column;align-items:center;gap:2px;}
.rg{width:8px;height:8px;border-radius:50%;background:var(--green);}
.rr{width:8px;height:8px;border-radius:50%;background:var(--red);}
.rdashes{display:flex;flex-direction:column;gap:2px;}
.rdash{width:2px;height:4px;background:var(--muted);border-radius:1px;}
.rfrom{font-size:0.82rem;font-weight:600;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
.rto{font-size:0.82rem;color:var(--muted);margin-top:7px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
.ropt{display:flex;align-items:center;gap:13px;padding:13px 12px;border:1.5px solid rgba(255,255,255,0.06);border-radius:15px;cursor:pointer;transition:all 0.22s;margin-bottom:8px;position:relative;}
.ropt.sel{border-color:var(--yellow);background:rgba(251,191,36,0.05);}
.ropt:hover{border-color:rgba(251,191,36,0.35);}
.rico{width:54px;height:42px;background:rgba(255,255,255,0.05);border-radius:10px;display:flex;align-items:center;justify-content:center;font-size:1.5rem;flex-shrink:0;}
.rname{font-weight:700;font-size:0.9rem;}
.rdesc{font-size:0.72rem;color:var(--muted);margin-top:2px;}
.reta{font-size:0.71rem;color:var(--green);font-weight:700;margin-top:4px;}
.rprice{text-align:right;}
.rp-amt{font-size:1.05rem;font-weight:800;}
.rp-sub{font-size:0.68rem;color:var(--muted);}
.rbadge{position:absolute;top:-8px;right:12px;background:var(--green);color:white;font-size:0.58rem;font-weight:700;padding:2px 8px;border-radius:100px;text-transform:uppercase;}
.payrow{display:flex;align-items:center;justify-content:space-between;background:rgba(255,255,255,0.04);border-radius:12px;padding:12px 14px;margin:12px 0;}
.payl{display:flex;align-items:center;gap:10px;font-size:0.85rem;font-weight:600;}

/* â”€â”€â”€â”€â”€â”€ RIDER TRACKING â”€â”€â”€â”€â”€â”€ */
.etabar{display:flex;justify-content:space-between;align-items:center;background:rgba(16,185,129,0.09);border:1px solid rgba(16,185,129,0.2);border-radius:14px;padding:16px;margin-bottom:13px;}
.etanum{font-size:2.4rem;font-weight:900;color:var(--green);line-height:1;}
.etalbl{font-size:0.7rem;color:var(--muted);margin-top:4px;}
.etasteps{display:flex;flex-direction:column;gap:5px;text-align:right;}
.stp{font-size:0.74rem;color:var(--muted);}
.stp.on{color:var(--text);font-weight:700;}
.stp.done{color:var(--green);text-decoration:line-through;opacity:0.6;}
.dcard{display:flex;align-items:center;gap:13px;background:rgba(255,255,255,0.04);border:1px solid rgba(255,255,255,0.06);border-radius:15px;padding:14px;margin-bottom:13px;}
.dav{width:50px;height:50px;border-radius:50%;overflow:hidden;flex-shrink:0;border:2px solid var(--yellow);}
.dav img{width:100%;height:100%;object-fit:cover;}
.dname{font-weight:700;font-size:0.9rem;}
.dcar{font-size:0.72rem;color:var(--muted);margin-top:2px;}
.drating{font-size:0.72rem;color:var(--yellow);font-weight:700;margin-top:3px;}
.dbtns{display:flex;gap:8px;}
.dbtn{width:40px;height:40px;border-radius:50%;border:1px solid rgba(255,255,255,0.1);background:rgba(255,255,255,0.05);display:flex;align-items:center;justify-content:center;font-size:1rem;cursor:pointer;transition:all 0.2s;}
.dbtn:hover{border-color:var(--yellow);}

/* â”€â”€â”€â”€â”€â”€ DRIVER: OFFLINE â”€â”€â”€â”€â”€â”€ */
.duty-wrap{position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:500;display:flex;flex-direction:column;align-items:center;gap:14px;pointer-events:none;}
.duty-btn{width:130px;height:130px;border-radius:50%;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:6px;cursor:pointer;pointer-events:all;transition:all 0.4s cubic-bezier(0.16,1,0.3,1);position:relative;border:none;font-family:'Plus Jakarta Sans',sans-serif;}
.duty-btn.off{background:rgba(20,20,20,0.9);border:3px solid #333;color:var(--muted);box-shadow:0 8px 32px rgba(0,0,0,0.5);}
.duty-btn.on{background:var(--green);border:3px solid rgba(255,255,255,0.2);color:white;box-shadow:0 12px 48px rgba(16,185,129,0.5);transform:scale(1.05);}
.duty-ico{font-size:2rem;}
.duty-txt{font-size:0.68rem;font-weight:800;letter-spacing:2px;text-transform:uppercase;}
.radar{position:absolute;inset:-14px;border-radius:50%;border:2px solid rgba(16,185,129,0.4);animation:radar 1.8s ease-out infinite;}
.radar2{position:absolute;inset:-28px;border-radius:50%;border:2px solid rgba(16,185,129,0.2);animation:radar 1.8s ease-out 0.6s infinite;}
@keyframes radar{0%{transform:scale(0.8);opacity:1}100%{transform:scale(1.35);opacity:0}}
.duty-hint{font-size:0.73rem;color:rgba(255,255,255,0.45);font-weight:600;pointer-events:all;text-align:center;}

/* â”€â”€â”€â”€â”€â”€ DRIVER STATS â”€â”€â”€â”€â”€â”€ */
.stats-row{display:grid;grid-template-columns:1fr 1fr 1fr;gap:10px;margin-bottom:16px;}
.stat-box{background:rgba(255,255,255,0.04);border:1px solid rgba(255,255,255,0.06);border-radius:14px;padding:14px 10px;text-align:center;}
.stat-num{font-size:1.4rem;font-weight:900;color:var(--yellow);}
.stat-lbl{font-size:0.65rem;color:var(--muted);margin-top:4px;text-transform:uppercase;letter-spacing:0.5px;}

/* â”€â”€â”€â”€â”€â”€ DRIVER ONLINE SCREEN â”€â”€â”€â”€â”€â”€ */
.wait-status{display:flex;align-items:center;justify-content:space-between;margin-bottom:16px;}
.status-pill{display:flex;align-items:center;gap:6px;border-radius:100px;padding:6px 12px;font-size:0.72rem;font-weight:700;}
.status-pill.g{background:rgba(16,185,129,0.1);border:1px solid rgba(16,185,129,0.2);color:var(--green);}
.info-cards{display:flex;flex-direction:column;gap:10px;margin-bottom:16px;}
.icard{display:flex;align-items:center;gap:12px;background:rgba(255,255,255,0.04);border:1px solid rgba(255,255,255,0.06);border-radius:14px;padding:14px;}
.icard-ico{width:44px;height:44px;border-radius:12px;display:flex;align-items:center;justify-content:center;font-size:1.3rem;flex-shrink:0;}
.ic-y{background:rgba(251,191,36,0.12);}
.ic-g{background:rgba(16,185,129,0.12);}
.ic-b{background:rgba(59,130,246,0.12);}
.icard-body{flex:1;}
.icard-title{font-weight:700;font-size:0.87rem;}
.icard-sub{font-size:0.72rem;color:var(--muted);margin-top:2px;}
.icard-val{font-weight:800;font-size:0.98rem;text-align:right;}

/* â”€â”€â”€â”€â”€â”€ RIDE REQUEST POPUP â”€â”€â”€â”€â”€â”€ */
.popup{position:fixed;bottom:0;left:0;right:0;z-index:700;background:rgba(8,8,8,0.99);backdrop-filter:blur(28px);border-radius:24px 24px 0 0;border-top:2px solid var(--yellow);padding:0 18px 32px;transform:translateY(100%);transition:transform 0.4s cubic-bezier(0.16,1,0.3,1);}
.popup.show{transform:translateY(0);}
.pop-handle{width:36px;height:4px;background:rgba(255,255,255,0.15);border-radius:4px;margin:12px auto 16px;}
.alert-pill{display:flex;align-items:center;gap:8px;background:rgba(251,191,36,0.1);border:1px solid rgba(251,191,36,0.25);border-radius:100px;padding:7px 14px;margin-bottom:14px;width:fit-content;}
.alert-dot{width:8px;height:8px;background:var(--yellow);border-radius:50%;animation:blink 0.6s infinite;}
.alert-pill span{font-size:0.73rem;font-weight:800;color:var(--yellow);text-transform:uppercase;letter-spacing:1px;}
.pop-fare{text-align:center;margin-bottom:18px;}
.pop-fare-num{font-size:3rem;font-weight:900;color:var(--yellow);line-height:1;}
.pop-fare-lbl{font-size:0.73rem;color:var(--muted);margin-top:4px;}
.timer-wrap{background:rgba(255,255,255,0.05);border-radius:100px;height:5px;margin-bottom:16px;overflow:hidden;}
.timer-bar{height:100%;background:var(--yellow);border-radius:100px;width:100%;transition:width 0.5s linear;}
.pop-route{display:flex;align-items:center;gap:12px;background:rgba(255,255,255,0.04);border-radius:13px;padding:13px;margin-bottom:12px;}
.pop-rg{width:10px;height:10px;border-radius:50%;background:var(--green);}
.pop-rr{width:10px;height:10px;border-radius:50%;background:var(--red);}
.pop-rdash{width:2px;height:5px;background:var(--muted);border-radius:1px;}
.pop-from{font-weight:700;font-size:0.87rem;}
.pop-to{font-size:0.83rem;color:var(--muted);margin-top:8px;}
.pop-details{display:flex;gap:10px;margin-bottom:14px;}
.pop-det{flex:1;background:rgba(255,255,255,0.04);border-radius:11px;padding:11px;text-align:center;}
.pop-det-val{font-weight:800;font-size:0.95rem;}
.pop-det-lbl{font-size:0.67rem;color:var(--muted);margin-top:3px;}
.pop-rider{display:flex;align-items:center;gap:12px;background:rgba(255,255,255,0.04);border-radius:12px;padding:12px 14px;margin-bottom:16px;}
.pop-av{width:42px;height:42px;border-radius:50%;overflow:hidden;flex-shrink:0;border:2px solid var(--yellow);}
.pop-av img{width:100%;height:100%;object-fit:cover;}
.pop-btns{display:flex;gap:12px;}
.pop-btn-dec{flex:1;background:rgba(239,68,68,0.08);color:var(--red);border:1px solid rgba(239,68,68,0.2);border-radius:13px;padding:15px;font-weight:700;font-size:0.9rem;cursor:pointer;transition:all 0.2s;font-family:'Plus Jakarta Sans',sans-serif;}
.pop-btn-dec:hover{background:rgba(239,68,68,0.15);}
.pop-btn-acc{flex:2;background:var(--green);color:white;border:none;border-radius:13px;padding:15px;font-weight:800;font-size:0.98rem;cursor:pointer;transition:all 0.2s;font-family:'Plus Jakarta Sans',sans-serif;box-shadow:0 8px 24px rgba(16,185,129,0.35);}
.pop-btn-acc:hover{background:#0da271;transform:translateY(-1px);}

/* â”€â”€â”€â”€â”€â”€ DRIVER ACTIVE RIDE â”€â”€â”€â”€â”€â”€ */
.navcard{display:flex;align-items:center;gap:12px;background:rgba(59,130,246,0.08);border:1px solid rgba(59,130,246,0.2);border-radius:14px;padding:14px;margin-bottom:13px;}
.nav-dist{font-weight:800;font-size:1.1rem;}
.nav-dir{font-size:0.78rem;color:var(--muted);margin-top:3px;}
.nav-launch{background:var(--blue);color:white;border:none;border-radius:10px;padding:10px 16px;font-weight:700;font-size:0.8rem;cursor:pointer;white-space:nowrap;font-family:'Plus Jakarta Sans',sans-serif;}
.trip-fare-row{display:flex;align-items:center;justify-content:space-between;background:rgba(255,255,255,0.04);border-radius:12px;padding:12px 14px;margin-bottom:13px;}
.tf-lbl{font-size:0.85rem;font-weight:600;display:flex;align-items:center;gap:8px;}
.tf-amt{font-weight:900;font-size:1.1rem;color:var(--yellow);}

/* â”€â”€â”€â”€â”€â”€ EARNINGS SCREEN â”€â”€â”€â”€â”€â”€ */
.earn-total{text-align:center;padding:8px 0 20px;}
.earn-amt{font-size:3.5rem;font-weight:900;color:var(--yellow);line-height:1;}
.earn-lbl{font-size:0.75rem;color:var(--muted);margin-top:5px;}
.earn-grid{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:18px;}
.earn-box{background:rgba(255,255,255,0.04);border:1px solid rgba(255,255,255,0.07);border-radius:14px;padding:16px;}
.earn-box-num{font-size:1.6rem;font-weight:900;}
.earn-box-lbl{font-size:0.68rem;color:var(--muted);margin-top:4px;text-transform:uppercase;letter-spacing:0.5px;}
.hist-list{display:flex;flex-direction:column;gap:9px;}
.hist-row{display:flex;align-items:center;gap:12px;background:rgba(255,255,255,0.03);border:1px solid rgba(255,255,255,0.06);border-radius:12px;padding:12px 14px;}
.hist-ico{width:38px;height:38px;background:rgba(251,191,36,0.1);border-radius:10px;display:flex;align-items:center;justify-content:center;font-size:1rem;flex-shrink:0;}
.hist-body{flex:1;}
.hist-from{font-weight:600;font-size:0.83rem;}
.hist-time{font-size:0.7rem;color:var(--muted);margin-top:2px;}
.hist-amt{font-weight:800;font-size:0.95rem;color:var(--yellow);}

/* â”€â”€â”€â”€â”€â”€ TOAST â”€â”€â”€â”€â”€â”€ */
.toast{position:fixed;top:86px;left:50%;transform:translateX(-50%);background:rgba(20,20,20,0.97);border:1px solid rgba(255,255,255,0.09);border-radius:100px;padding:10px 20px;font-size:0.8rem;font-weight:600;z-index:9999;backdrop-filter:blur(16px);animation:tin 0.3s ease,tout 0.3s ease 2.6s forwards;white-space:nowrap;pointer-events:none;}
@keyframes tin{from{opacity:0;top:66px}to{opacity:1;top:86px}}
@keyframes tout{to{opacity:0}}

/* CAR MARKER ANIMATION */
@keyframes carPulse{0%{transform:scale(0.8);opacity:1}100%{transform:scale(2.2);opacity:0}}
</style>
</head>
<body>

<!-- LOADER -->
<div id="loader">
  <div class="ld-icon">JDP</div>
  <div class="ld-name">CABS</div>
  <div class="ld-bar-wrap"><div class="ld-bar" id="ldBar"></div></div>
  <div class="ld-txt" id="ldTxt">India ka best cab app load ho raha hai...</div>
</div>

<!-- ROLE SELECT -->
<div id="roleScreen">
  <div class="role-logo">
    <div class="role-logo-box">JDP</div>
    <div class="role-logo-name">CABS</div>
  </div>
  <div class="role-title">Aap kaun hain?</div>
  <div class="role-sub">Apna role chuniye â€” Rider ya Driver<br>Ek hi page pe dono available hain ğŸš–</div>
  <div class="role-cards">
    <div class="role-card rider" onclick="setRole('rider')">
      <div class="rc-icon y">ğŸ§</div>
      <div class="rc-body">
        <div class="rc-title">Rider hoon</div>
        <div class="rc-sub">Cab book karo, live track karo,<br>safe aur sasti ride lo</div>
      </div>
      <div class="rc-arrow">â†’</div>
    </div>
    <div class="role-card driver" onclick="setRole('driver')">
      <div class="rc-icon g">ğŸš—</div>
      <div class="rc-body">
        <div class="rc-title">Driver / Partner hoon</div>
        <div class="rc-sub">Duty lagao, ride requests dekho,<br>paise kamao har din</div>
      </div>
      <div class="rc-arrow">â†’</div>
    </div>
  </div>
</div>

<!-- MAP -->
<div id="map"></div>

<!-- TOP BAR -->
<div class="topbar" id="topbar" style="display:none">
  <div class="logo-wrap">
    <div class="logo-box">JDP</div>
    <div class="logo-title">CABS</div>
    <div class="mode-tag" id="modeTag">Rider</div>
  </div>
  <div style="display:flex;gap:8px;align-items:center">
    <div class="topbtn switch-btn" onclick="switchRole()" title="Switch Role">â‡„ Switch</div>
    <div class="topbtn" onclick="toast('ğŸ”” Koi alert nahi!')">ğŸ””</div>
  </div>
</div>

<!-- LIVE PILL -->
<div class="live-pill" id="livePill" style="display:none">
  <div class="ldot"></div>
  <span id="pillTxt">5 drivers kareeb</span>
</div>

<!-- LOCATE -->
<button class="locate-btn" id="locBtn" style="display:none;bottom:380px" onclick="locateMe()">ğŸ“</button>

<!-- DRIVER DUTY BUTTON -->
<div class="duty-wrap" id="dutyWrap" style="display:none">
  <div class="duty-btn off" id="dutyBtn" onclick="toggleDuty()">
    <div class="duty-ico">ğŸš—</div>
    <div class="duty-txt" id="dutyTxt">Offline</div>
  </div>
  <div class="duty-hint" id="dutyHint">Duty shuru karne ke liye tap karo</div>
</div>

<!-- â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ BOTTOM SHEET â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
<div class="bsheet" id="bsheet" style="display:none">
  <div class="handle"></div>

  <!-- â•â• RIDER: HOME â•â• -->
  <div class="scr on" id="scrRHome">
    <div class="where-lbl">Kahan jaana hai?</div>
    <div class="loc-boxes">
      <div class="loc-box" onclick="openPick('pickup')">
        <div class="ldot-g"></div>
        <div style="flex:1;min-width:0">
          <div class="lbl-main" id="puLbl">Pickup set karo</div>
          <div class="lbl-sub">Search karo ya map pe tap karo</div>
        </div>
        <span style="color:var(--muted);font-size:0.8rem">âœ</span>
      </div>
      <div class="loc-box" onclick="openPick('drop')">
        <div class="ldot-r"></div>
        <div style="flex:1;min-width:0">
          <div class="lbl-main" id="drLbl">Kahan jaana hai?</div>
          <div class="lbl-sub">Sheher, landmark, area...</div>
        </div>
        <span style="color:var(--muted);font-size:0.8rem">âœ</span>
      </div>
    </div>
    <div class="qpicks">
      <div class="qchip" onclick="qpick('ghar')">ğŸ  Ghar</div>
      <div class="qchip" onclick="qpick('office')">ğŸ’¼ Office</div>
      <div class="qchip" onclick="qpick('airport')">âœˆï¸ Airport</div>
      <div class="qchip" onclick="qpick('station')">ğŸš‰ Station</div>
      <div class="qchip" onclick="qpick('hospital')">ğŸ¥ Hospital</div>
      <div class="qchip" onclick="qpick('mall')">ğŸ›ï¸ Mall</div>
    </div>
    <button class="main-btn yellow" onclick="goRides()">ğŸš— Ride Dekho &amp; Book Karo</button>
  </div>

  <!-- â•â• RIDER: SEARCH â•â• -->
  <div class="scr" id="scrSearch">
    <div class="shdr">
      <div class="stitle" id="searchTitle">Pickup Set Karo</div>
      <div class="sback" onclick="goScr('RHome')">â† Wapas</div>
    </div>
    <div class="sinp-wrap">
      <span class="sinp-ico">ğŸ”</span>
      <input type="text" class="sinp" id="sinp" placeholder="Jagah dhundho..." oninput="filterSug(this.value)">
    </div>
    <div class="suglist" id="suglist"></div>
  </div>

  <!-- â•â• RIDER: RIDE OPTIONS â•â• -->
  <div class="scr" id="scrRides">
    <div class="shdr">
      <div class="stitle">Ride Chuniye</div>
      <div class="sback" onclick="goScr('RHome')">â† Wapas</div>
    </div>
    <div class="rbar">
      <div class="rline">
        <div class="rg"></div>
        <div class="rdashes"><div class="rdash"></div><div class="rdash"></div><div class="rdash"></div></div>
        <div class="rr"></div>
      </div>
      <div style="flex:1;min-width:0">
        <div class="rfrom" id="rfrom">Pickup</div>
        <div class="rto" id="rto">Drop</div>
      </div>
      <div style="text-align:right">
        <div id="rdist" style="font-weight:800;font-size:0.9rem">â€”</div>
        <div style="font-size:0.67rem;color:var(--muted)">doori</div>
      </div>
    </div>
    <div id="rlist"></div>
    <div class="payrow">
      <div class="payl"><span>ğŸ’³</span><span>Cash Payment</span></div>
      <span style="font-size:0.73rem;color:var(--yellow);cursor:pointer;font-weight:700">Change â†’</span>
    </div>
    <button class="main-btn yellow" onclick="confirmRide()">âœ… Booking Confirm Karo</button>
  </div>

  <!-- â•â• RIDER: TRACKING â•â• -->
  <div class="scr" id="scrTrack">
    <div class="shdr">
      <div class="stitle">Live Tracking ğŸ‡®ğŸ‡³</div>
      <div class="sback" onclick="cancelRiderRide()">Cancel</div>
    </div>
    <div class="etabar">
      <div>
        <div class="etanum" id="etaNum">4</div>
        <div class="etalbl">min mein driver aayega</div>
      </div>
      <div class="etasteps">
        <div class="stp done" id="rs1">âœ“ Booking confirm</div>
        <div class="stp on"   id="rs2">ğŸš— Driver aa raha hai</div>
        <div class="stp"      id="rs3">ğŸ“ Pickup pe pahuncha</div>
        <div class="stp"      id="rs4">ğŸ Trip shuru</div>
      </div>
    </div>
    <div class="dcard">
      <div class="dav"><img src="https://randomuser.me/api/portraits/men/44.jpg"></div>
      <div style="flex:1">
        <div class="dname">Ramesh Kumar</div>
        <div class="dcar">ğŸš— Swift Dzire Â· DL 4C AZ 5678</div>
        <div class="drating">â˜… 4.9 Â· 3,241 rides</div>
      </div>
      <div class="dbtns">
        <div class="dbtn" onclick="toast('ğŸ“ Driver ko call kar raha hai...')">ğŸ“</div>
        <div class="dbtn" onclick="toast('ğŸ’¬ Chat jald aayega!')">ğŸ’¬</div>
      </div>
    </div>
    <div class="payrow">
      <div class="payl"><span>ğŸ’°</span><span>Estimated Fare</span></div>
      <span style="font-weight:900;color:var(--yellow);font-size:1.05rem" id="tfare">â‚¹180</span>
    </div>
    <button class="main-btn red-out" onclick="cancelRiderRide()">Ride Cancel Karo</button>
  </div>

  <!-- â•â• DRIVER: OFFLINE â•â• -->
  <div class="scr" id="scrDOffline">
    <div style="text-align:center;padding:10px 0 20px">
      <div style="font-size:1.3rem;font-weight:900;margin-bottom:8px">Aaj ka Summary ğŸ“Š</div>
      <div style="font-size:0.85rem;color:var(--muted)">Duty shuru karo â€” ride requests aane lagenge!</div>
    </div>
    <div class="stats-row">
      <div class="stat-box">
        <div class="stat-num" id="dToday">â‚¹0</div>
        <div class="stat-lbl">Aaj ki Kamai</div>
      </div>
      <div class="stat-box">
        <div class="stat-num" id="dRides">0</div>
        <div class="stat-lbl">Rides</div>
      </div>
      <div class="stat-box">
        <div class="stat-num">4.9â˜…</div>
        <div class="stat-lbl">Rating</div>
      </div>
    </div>
    <button class="main-btn green" onclick="goOnline()">ğŸŸ¢ Duty Shuru Karo</button>
  </div>

  <!-- â•â• DRIVER: ONLINE / WAITING â•â• -->
  <div class="scr" id="scrDOnline">
    <div class="wait-status">
      <div class="stitle">Live Dashboard</div>
      <div class="status-pill g"><div class="ldot"></div>Online</div>
    </div>
    <div class="info-cards">
      <div class="icard">
        <div class="icard-ico ic-y">ğŸ’°</div>
        <div class="icard-body">
          <div class="icard-title">Aaj ki Kamai</div>
          <div class="icard-sub">12 rides complete</div>
        </div>
        <div class="icard-val" id="dEarning" style="color:var(--yellow)">â‚¹1,840</div>
      </div>
      <div class="icard">
        <div class="icard-ico ic-g">ğŸ“¡</div>
        <div class="icard-body">
          <div class="icard-title">Ride Requests Aa Rahe Hain</div>
          <div class="icard-sub">Aapke aas paas active riders hain</div>
        </div>
        <div class="icard-val" style="color:var(--green)">Live</div>
      </div>
      <div class="icard">
        <div class="icard-ico ic-b">â±ï¸</div>
        <div class="icard-body">
          <div class="icard-title">Online Time</div>
          <div class="icard-sub">Aaj duty pe</div>
        </div>
        <div class="icard-val" id="onlineTime">0h 0m</div>
      </div>
    </div>
    <button class="main-btn red-out" onclick="goOffline()">ğŸ”´ Duty Band Karo</button>
  </div>

  <!-- â•â• DRIVER: ACTIVE RIDE â•â• -->
  <div class="scr" id="scrDRide">
    <div class="shdr">
      <div class="stitle">Trip Chal Rahi Hai ğŸš—</div>
      <div style="display:flex;align-items:center;gap:6px;background:rgba(16,185,129,0.1);border:1px solid rgba(16,185,129,0.2);border-radius:100px;padding:6px 12px;font-size:0.7rem;font-weight:700;color:var(--green)"><div class="ldot"></div>Active</div>
    </div>
    <div class="navcard">
      <span style="font-size:1.5rem">ğŸ—ºï¸</span>
      <div style="flex:1">
        <div class="nav-dist" id="navDist">2.4 km baaki</div>
        <div class="nav-dir" id="navDir">Seedha jaao â†’ Left lo â†’ Destination</div>
      </div>
      <button class="nav-launch" onclick="toast('ğŸ—ºï¸ Google Maps se navigate kar rahe hain!')">Navigate</button>
    </div>
    <div class="dcard">
      <div class="dav"><img src="https://randomuser.me/api/portraits/women/32.jpg"></div>
      <div style="flex:1">
        <div class="dname" id="riderName">Priya Sharma</div>
        <div class="dcar" id="riderPhone">ğŸ“± +91 98765 43210</div>
        <div class="drating">â˜… 4.8 Rider</div>
      </div>
      <div class="dbtns">
        <div class="dbtn" onclick="toast('ğŸ“ Rider ko call kar raha hai...')">ğŸ“</div>
        <div class="dbtn" onclick="toast('ğŸ’¬ Chat jald aayega!')">ğŸ’¬</div>
      </div>
    </div>
    <div class="trip-fare-row">
      <div class="tf-lbl"><span>ğŸ’°</span><span>Trip Fare</span></div>
      <div class="tf-amt" id="dTripFare">â‚¹220</div>
    </div>
    <button class="main-btn yellow" onclick="endTrip()">ğŸ Trip Complete Karo</button>
  </div>

  <!-- â•â• DRIVER: EARNINGS â•â• -->
  <div class="scr" id="scrEarn">
    <div class="shdr">
      <div class="stitle">Meri Kamai ğŸ’°</div>
      <div class="sback" onclick="goScr('DOffline')">â† Wapas</div>
    </div>
    <div class="earn-total">
      <div class="earn-amt">â‚¹1,840</div>
      <div class="earn-lbl">Aaj ki total kamai</div>
    </div>
    <div class="earn-grid">
      <div class="earn-box">
        <div class="earn-box-num" style="color:var(--green)">12</div>
        <div class="earn-box-lbl">Rides Today</div>
      </div>
      <div class="earn-box">
        <div class="earn-box-num" style="color:var(--blue)">6h 24m</div>
        <div class="earn-box-lbl">Online Time</div>
      </div>
      <div class="earn-box">
        <div class="earn-box-num" style="color:var(--yellow)">â‚¹8,420</div>
        <div class="earn-box-lbl">Is Hafte</div>
      </div>
      <div class="earn-box">
        <div class="earn-box-num" style="color:var(--red)">4.9â˜…</div>
        <div class="earn-box-lbl">Aapki Rating</div>
      </div>
    </div>
    <div style="font-size:0.78rem;font-weight:700;color:var(--muted);margin-bottom:12px;text-transform:uppercase;letter-spacing:1px;">Recent Rides</div>
    <div class="hist-list">
      <div class="hist-row"><div class="hist-ico">ğŸš—</div><div class="hist-body"><div class="hist-from">Rajiv Chowk â†’ IGI Airport</div><div class="hist-time">Aaj, 10:32 AM Â· 18 km</div></div><div class="hist-amt">â‚¹420</div></div>
      <div class="hist-row"><div class="hist-ico">ğŸš—</div><div class="hist-body"><div class="hist-from">Lajpat Nagar â†’ Saket Mall</div><div class="hist-time">Aaj, 9:14 AM Â· 5.2 km</div></div><div class="hist-amt">â‚¹130</div></div>
      <div class="hist-row"><div class="hist-ico">ğŸš—</div><div class="hist-body"><div class="hist-from">AIIMS â†’ India Gate</div><div class="hist-time">Aaj, 8:05 AM Â· 8.4 km</div></div><div class="hist-amt">â‚¹195</div></div>
      <div class="hist-row"><div class="hist-ico">ğŸš—</div><div class="hist-body"><div class="hist-from">Dwarka â†’ Connaught Place</div><div class="hist-time">Kal, 7:45 PM Â· 22 km</div></div><div class="hist-amt">â‚¹480</div></div>
    </div>
  </div>
</div>

<!-- RIDE REQUEST POPUP (for Driver) -->
<div class="popup" id="ridePopup">
  <div class="pop-handle"></div>
  <div class="alert-pill"><div class="alert-dot"></div><span>Nayi Ride Request!</span></div>
  <div class="pop-fare">
    <div class="pop-fare-num" id="popFare">â‚¹220</div>
    <div class="pop-fare-lbl">Estimated Fare</div>
  </div>
  <div class="timer-wrap"><div class="timer-bar" id="timerBar"></div></div>
  <div class="pop-route">
    <div style="display:flex;flex-direction:column;align-items:center;gap:3px">
      <div class="pop-rg"></div>
      <div style="display:flex;flex-direction:column;gap:2px"><div class="pop-rdash"></div><div class="pop-rdash"></div><div class="pop-rdash"></div></div>
      <div class="pop-rr"></div>
    </div>
    <div style="flex:1;min-width:0">
      <div class="pop-from" id="popFrom">Connaught Place, New Delhi</div>
      <div class="pop-to" id="popTo">IGI Airport Terminal 3, Dwarka</div>
    </div>
  </div>
  <div class="pop-details">
    <div class="pop-det"><div class="pop-det-val" id="popDist">18.4 km</div><div class="pop-det-lbl">Doori</div></div>
    <div class="pop-det"><div class="pop-det-val" id="popTime">28 min</div><div class="pop-det-lbl">Time</div></div>
    <div class="pop-det"><div class="pop-det-val">Cash</div><div class="pop-det-lbl">Payment</div></div>
  </div>
  <div class="pop-rider">
    <div class="pop-av"><img src="https://randomuser.me/api/portraits/women/32.jpg"></div>
    <div style="flex:1">
      <div style="font-weight:700;font-size:0.9rem">Priya Sharma</div>
      <div style="font-size:0.72rem;color:var(--muted);margin-top:2px">â˜… 4.8 Rider Â· 42 trips</div>
    </div>
    <div style="font-size:1.3rem">ğŸ‘¤</div>
  </div>
  <div class="pop-btns">
    <button class="pop-btn-dec" onclick="declineRide()">âŒ Decline</button>
    <button class="pop-btn-acc" onclick="acceptRide()">âœ… Accept Karo</button>
  </div>
</div>

<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• STATE â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let role = null;           // 'rider' | 'driver'
let mapMode = 'none';
let lmap = null, mmap = null;
let puCoords = null, drCoords = null;
let puMarker = null, drMarker = null;
let routeLine = null;
let drvObjs = [];
let pickerType = 'pickup';
let selRide = 1;
let riderEtaTimer = null, currentEta = 4;
let isOnline = false;
let onlineStart = null, onlineTimer = null;
let requestTimer = null, requestSent = false;
let completedRides = 0, totalEarned = 0;

const CENTER = [28.6139, 77.2090];

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• LOADER â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let ldProg = 0;
const ldIv = setInterval(() => {
  ldProg += Math.random() * 14;
  if (ldProg > 88) ldProg = 88;
  document.getElementById('ldBar').style.width = ldProg + '%';
}, 350);

function ldTxt(t) { document.getElementById('ldTxt').textContent = t; }

function finishLoad() {
  clearInterval(ldIv);
  document.getElementById('ldBar').style.width = '100%';
  ldTxt('Taiyaar hai! ğŸ‰');
  setTimeout(() => {
    document.getElementById('loader').style.opacity = '0';
    document.getElementById('loader').style.transition = 'opacity 0.5s';
    setTimeout(() => {
      document.getElementById('loader').style.display = 'none';
      document.getElementById('roleScreen').style.display = 'flex';
    }, 500);
  }, 700);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• MAP â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
window.onMapReady = function() {
  ldTxt('ğŸ‡®ğŸ‡³ MapmyIndia India Map Ready!');
  mapMode = 'mappls';
  try {
    mmap = new mappls.Map('map', { center: CENTER, zoom: 13, search: false, zoomControl: true });
    mmap.on('load', () => {
      finishLoad();
      spawnCars();
      setInterval(moveCars, 2000);
      mmap.on('click', e => {
        if (document.getElementById('scrSearch').classList.contains('on'))
          revGeo([e.lngLat.lat, e.lngLat.lng], pickerType);
      });
    });
  } catch(e) { useFallback(); }
};

setTimeout(() => { if (mapMode === 'none') useFallback(); }, 7000);

function useFallback() {
  mapMode = 'leaflet';
  ldTxt('Demo map load ho raha hai...');
  lmap = L.map('map', { zoomControl: true, attributionControl: false }).setView(CENTER, 13);
  L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', { maxZoom: 19, subdomains: 'abcd' }).addTo(lmap);
  lmap.on('click', e => {
    if (document.getElementById('scrSearch').classList.contains('on'))
      revGeo([e.latlng.lat, e.latlng.lng], pickerType);
  });
  spawnCars(); setInterval(moveCars, 2000);
  finishLoad();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• ROLE â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function setRole(r) {
  role = r;
  document.getElementById('roleScreen').style.display = 'none';
  document.getElementById('topbar').style.display = 'flex';
  document.getElementById('bsheet').style.display = 'block';
  document.getElementById('livePill').style.display = 'flex';
  document.getElementById('locBtn').style.display = 'flex';

  const tag = document.getElementById('modeTag');
  if (r === 'rider') {
    tag.textContent = 'ğŸ§ Rider';
    tag.className = 'mode-tag rider';
    document.getElementById('pillTxt').textContent = '5 drivers kareeb';
    document.getElementById('dutyWrap').style.display = 'none';
    document.getElementById('locBtn').style.bottom = '380px';
    setPickup(CENTER, 'Rajiv Chowk, New Delhi');
    goScr('RHome');
    toast('ğŸ‘‹ Kahan jaana hai? Pickup set karo!');
  } else {
    tag.textContent = 'ğŸš— Driver';
    tag.className = 'mode-tag driver';
    document.getElementById('pillTxt').textContent = 'Driver Mode Active';
    document.getElementById('dutyWrap').style.display = 'flex';
    document.getElementById('locBtn').style.bottom = '320px';
    goScr('DOffline');
    if (mapMode === 'mappls') mmap.setCenter({ lat: CENTER[0], lng: CENTER[1] });
    else lmap.setView(CENTER, 13);
    toast('ğŸš— Driver dashboard taiyaar! Duty shuru karo.');
  }
}

function switchRole() {
  // hide popup if open
  document.getElementById('ridePopup').classList.remove('show');
  if (isOnline) goOffline();
  if (riderEtaTimer) clearInterval(riderEtaTimer);
  role = null;
  document.getElementById('topbar').style.display = 'none';
  document.getElementById('bsheet').style.display = 'none';
  document.getElementById('livePill').style.display = 'none';
  document.getElementById('locBtn').style.display = 'none';
  document.getElementById('dutyWrap').style.display = 'none';
  document.getElementById('roleScreen').style.display = 'flex';
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• SCREENS â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function goScr(name) {
  document.querySelectorAll('.scr').forEach(s => s.classList.remove('on'));
  const el = document.getElementById('scr' + name);
  if (el) el.classList.add('on');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• CAR MARKERS â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const carPositions = [[28.620,77.210],[28.608,77.218],[28.617,77.197],[28.626,77.204],[28.601,77.232]];
function spawnCars() {
  carPositions.forEach(p => {
    if (mapMode === 'leaflet') {
      const m = L.marker(p, { icon: carLeafIcon() }).addTo(lmap);
      drvObjs.push({ m, pos: [...p], mode: 'leaflet' });
    } else {
      try {
        const m = new mappls.Marker({ map: mmap, position: { lat: p[0], lng: p[1] }, fitbounds: false });
        drvObjs.push({ m, pos: [...p], mode: 'mappls' });
      } catch(e) {}
    }
  });
}
function moveCars() {
  drvObjs.forEach(d => {
    d.pos[0] += (Math.random()-.5)*.001;
    d.pos[1] += (Math.random()-.5)*.001;
    try {
      if (d.mode === 'leaflet') d.m.setLatLng(d.pos);
      else d.m.setPosition({ lat: d.pos[0], lng: d.pos[1] });
    } catch(e) {}
  });
}
function carLeafIcon() {
  return L.divIcon({ className: '', html: `<div style="position:relative;width:36px;height:36px"><div style="position:absolute;inset:-7px;border-radius:50%;background:rgba(251,191,36,0.15);animation:carPulse 2s ease-out infinite;"></div><div style="width:36px;height:36px;background:#FBBF24;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:18px;box-shadow:0 4px 12px rgba(251,191,36,0.5)">ğŸš—</div></div>`, iconSize:[36,36], iconAnchor:[18,18] });
}
function pinIcon(color) {
  const c = color === 'green' ? '#10b981' : '#ef4444';
  return L.divIcon({ className: '', html: `<div style="width:14px;height:14px;background:${c};border-radius:50%;border:3px solid white;box-shadow:0 0 10px ${c}99"></div>`, iconSize:[14,14], iconAnchor:[7,7] });
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• MARKERS & ROUTE â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function setPickup(ll, label) {
  puCoords = ll;
  document.getElementById('puLbl').textContent = label || `${ll[0].toFixed(4)}, ${ll[1].toFixed(4)}`;
  try {
    if (mapMode === 'leaflet') {
      if (puMarker) lmap.removeLayer(puMarker);
      puMarker = L.marker(ll, { icon: pinIcon('green') }).addTo(lmap);
    } else {
      if (puMarker) puMarker.remove();
      puMarker = new mappls.Marker({ map: mmap, position: { lat: ll[0], lng: ll[1] }, fitbounds: false });
    }
  } catch(e) {}
  if (drCoords) drawRoute();
}
function setDrop(ll, label) {
  drCoords = ll;
  document.getElementById('drLbl').textContent = label || `${ll[0].toFixed(4)}, ${ll[1].toFixed(4)}`;
  try {
    if (mapMode === 'leaflet') {
      if (drMarker) lmap.removeLayer(drMarker);
      drMarker = L.marker(ll, { icon: pinIcon('red') }).addTo(lmap);
    } else {
      if (drMarker) drMarker.remove();
      drMarker = new mappls.Marker({ map: mmap, position: { lat: ll[0], lng: ll[1] }, fitbounds: false });
    }
  } catch(e) {}
  if (puCoords) drawRoute();
}
function drawRoute() {
  if (mapMode === 'leaflet') {
    if (routeLine) lmap.removeLayer(routeLine);
    const m1 = [(puCoords[0]*.65+drCoords[0]*.35)+(Math.random()-.5)*.01,(puCoords[1]*.65+drCoords[1]*.35)+(Math.random()-.5)*.01];
    const m2 = [(puCoords[0]*.35+drCoords[0]*.65)+(Math.random()-.5)*.01,(puCoords[1]*.35+drCoords[1]*.65)+(Math.random()-.5)*.01];
    routeLine = L.polyline([puCoords,m1,m2,drCoords], { color:'#FBBF24', weight:5, opacity:0.9, dashArray:'10,6', lineCap:'round' }).addTo(lmap);
    let off = 0;
    if (window._ra) clearInterval(window._ra);
    window._ra = setInterval(() => { off=(off+1)%16; if(routeLine) routeLine.setStyle({dashOffset:-off}); }, 55);
    lmap.fitBounds(routeLine.getBounds(), { padding:[80,80] });
  } else {
    try {
      if (routeLine) routeLine.remove();
      routeLine = new mappls.Polyline({ map: mmap, path:[{lat:puCoords[0],lng:puCoords[1]},{lat:drCoords[0],lng:drCoords[1]}], strokeColor:'#FBBF24', strokeOpacity:0.9, strokeWeight:5, fitbounds:true, fitboundOptions:{padding:80} });
    } catch(e) {}
  }
}
function flyTo(ll) {
  if (mapMode === 'mappls') { try { mmap.setCenter({lat:ll[0],lng:ll[1]}); } catch(e){} }
  else lmap.flyTo(ll, 15, { duration: 1.3 });
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• LOCATE â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function locateMe() {
  toast('ğŸ“ Location dhundh raha hai...');
  navigator.geolocation?.getCurrentPosition(p => {
    const ll = [p.coords.latitude, p.coords.longitude];
    if (role === 'rider') setPickup(ll, 'Aapki Location');
    flyTo(ll);
    toast('âœ… Location mil gayi!');
  }, () => toast('âŒ Location permission denied'));
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• REVERSE GEOCODE â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function revGeo(ll, type) {
  fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${ll[0]}&lon=${ll[1]}&accept-language=en`)
    .then(r => r.json())
    .then(d => {
      const name = d.address?.road || d.address?.suburb || d.display_name.split(',')[0];
      if (type === 'pickup') setPickup(ll, name);
      else setDrop(ll, name);
      goScr('RHome'); toast(`âœ… ${name}`);
    }).catch(() => {
      if (type === 'pickup') setPickup(ll); else setDrop(ll);
      goScr('RHome');
    });
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• SUGGESTIONS â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const SUGS = [
  {i:'ğŸ›ï¸',n:'India Gate',a:'Rajpath, New Delhi',lat:28.6129,lon:77.2295,d:'1.2 km'},
  {i:'ğŸ›ï¸',n:'Connaught Place',a:'Central Delhi',lat:28.6315,lon:77.2167,d:'2.1 km'},
  {i:'âœˆï¸',n:'IGI Airport T3',a:'Dwarka, New Delhi',lat:28.5562,lon:77.0998,d:'11.4 km'},
  {i:'ğŸ¥',n:'AIIMS Hospital',a:'Ansari Nagar, New Delhi',lat:28.5672,lon:77.2100,d:'5.3 km'},
  {i:'ğŸ“',n:'Delhi University',a:'North Campus, Delhi',lat:28.6878,lon:77.2146,d:'7.8 km'},
  {i:'ğŸ›’',n:'Select Citywalk',a:'Saket, South Delhi',lat:28.5244,lon:77.2185,d:'9.1 km'},
  {i:'ğŸ•Œ',n:'Jama Masjid',a:'Chandni Chowk, Old Delhi',lat:28.6507,lon:77.2334,d:'4.2 km'},
  {i:'ğŸš‰',n:'New Delhi Railway Station',a:'Paharganj, Delhi',lat:28.6429,lon:77.2195,d:'3.0 km'},
  {i:'ğŸŒ¿',n:'Lodhi Garden',a:'Lodhi Road, New Delhi',lat:28.5931,lon:77.2196,d:'3.8 km'},
  {i:'ğŸ°',n:'Red Fort',a:'Chandni Chowk, Old Delhi',lat:28.6562,lon:77.2410,d:'5.5 km'},
  {i:'ğŸŒ¸',n:'Lotus Temple',a:'Bahapur, New Delhi',lat:28.5535,lon:77.2588,d:'7.1 km'},
  {i:'ğŸ˜',n:'Delhi Zoo',a:'Mathura Road, New Delhi',lat:28.5980,lon:77.2487,d:'4.6 km'},
];
function renderSugs(list) {
  document.getElementById('suglist').innerHTML = list.map(s => `
    <div class="sugrow" onclick="pickSug(${s.lat},${s.lon},'${s.n.replace(/'/g,"\\'")}')">
      <div class="sugico">${s.i}</div>
      <div class="sugbody"><div class="sugname">${s.n}</div><div class="sugaddr">${s.a}</div></div>
      <div class="sugdist">${s.d}</div>
    </div>`).join('');
}
function openPick(type) {
  pickerType = type;
  document.getElementById('searchTitle').textContent = type === 'pickup' ? 'Pickup Set Karo' : 'Drop Set Karo';
  document.getElementById('sinp').value = '';
  renderSugs(SUGS);
  goScr('Search');
  setTimeout(() => document.getElementById('sinp').focus(), 180);
}
function filterSug(q) {
  if (!q.trim()) { renderSugs(SUGS); return; }
  renderSugs(SUGS.filter(s => s.n.toLowerCase().includes(q.toLowerCase()) || s.a.toLowerCase().includes(q.toLowerCase())));
}
function pickSug(lat, lon, name) {
  const ll = [lat, lon];
  if (pickerType === 'pickup') setPickup(ll, name);
  else setDrop(ll, name);
  flyTo(ll);
  goScr('RHome');
  toast(`ğŸ“ ${name} set!`);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• QUICK PICKS â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const QP = {
  ghar:{n:'Ghar',lat:28.625,lon:77.210},
  office:{n:'Connaught Place Office',lat:28.6315,lon:77.2167},
  airport:{n:'IGI Airport T3',lat:28.5562,lon:77.0998},
  station:{n:'New Delhi Railway Station',lat:28.6429,lon:77.2195},
  hospital:{n:'AIIMS New Delhi',lat:28.5672,lon:77.2100},
  mall:{n:'Select Citywalk Saket',lat:28.5244,lon:77.2185},
};
function qpick(k) {
  const p = QP[k];
  setDrop([p.lat,p.lon], p.n);
  flyTo([p.lat,p.lon]);
  toast(`ğŸ¯ Drop: ${p.n}`);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• DISTANCE â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function getDist(a, b) {
  const R=6371, dL=(b[0]-a[0])*Math.PI/180, dN=(b[1]-a[1])*Math.PI/180;
  const x=Math.sin(dL/2)**2+Math.cos(a[0]*Math.PI/180)*Math.cos(b[0]*Math.PI/180)*Math.sin(dN/2)**2;
  return R*2*Math.atan2(Math.sqrt(x),Math.sqrt(1-x));
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• RIDER: RIDE OPTIONS â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const RIDES = [
  {i:'ğŸ›µ',n:'Moto',d:'1 sawari Â· Sabse tez',base:11,badge:'Sabse Sasta',eta:'2 min'},
  {i:'ğŸš—',n:'GO',d:'4 sawari Â· Affordable',base:17,badge:'Popular',eta:'4 min'},
  {i:'ğŸš™',n:'Prime Sedan',d:'4 sawari Â· Aaram',base:25,badge:null,eta:'6 min'},
  {i:'ğŸš',n:'GO XL',d:'6 sawari Â· Family',base:31,badge:null,eta:'8 min'},
];
function goRides() {
  if (!puCoords || !drCoords) {
    toast('âš ï¸ Pehle pickup aur drop set karo!');
    if (!puCoords) openPick('pickup'); else openPick('drop');
    return;
  }
  const km = getDist(puCoords, drCoords);
  document.getElementById('rfrom').textContent = document.getElementById('puLbl').textContent;
  document.getElementById('rto').textContent = document.getElementById('drLbl').textContent;
  document.getElementById('rdist').textContent = km.toFixed(1) + ' km';
  const defFare = Math.round(17*km+40);
  document.getElementById('tfare').textContent = 'â‚¹'+defFare;
  document.getElementById('rlist').innerHTML = RIDES.map((r,i) => {
    const fare = Math.round(r.base*km+40);
    return `<div class="ropt ${i===1?'sel':''}" id="ro${i}" onclick="selRideOpt(${i},${fare})">
      ${r.badge?`<div class="rbadge">${r.badge}</div>`:''}
      <div class="rico">${r.i}</div>
      <div style="flex:1"><div class="rname">${r.n}</div><div class="rdesc">${r.d}</div><div class="reta">ğŸ• ${r.eta} door hai</div></div>
      <div class="rprice"><div class="rp-amt">â‚¹${fare}</div><div class="rp-sub">${km.toFixed(1)} km</div></div>
    </div>`;
  }).join('');
  selRide = 1;
  goScr('Rides');
}
function selRideOpt(idx, fare) {
  document.querySelectorAll('.ropt').forEach((el,i) => el.classList.toggle('sel', i===idx));
  selRide = idx;
  document.getElementById('tfare').textContent = 'â‚¹'+fare;
}
function confirmRide() {
  toast('ğŸ” Driver dhundh raha hai...');
  goScr('Track');
  if (puCoords) flyTo(puCoords);
  // Animate closest driver to pickup
  if (drvObjs.length > 0) {
    const drv = drvObjs[0], start=[...drv.pos], target=puCoords;
    let step=0, total=50;
    if (window._drvAnim) clearInterval(window._drvAnim);
    window._drvAnim = setInterval(() => {
      step++;
      const t=step/total;
      drv.pos[0]=start[0]+(target[0]-start[0])*t;
      drv.pos[1]=start[1]+(target[1]-start[1])*t;
      try { if(drv.mode==='leaflet') drv.m.setLatLng(drv.pos); else drv.m.setPosition({lat:drv.pos[0],lng:drv.pos[1]}); } catch(e){}
      if (step>=total) { clearInterval(window._drvAnim); toast('ğŸš— Driver pickup pe pahunch gaya!'); updRStep(3); }
    }, 150);
  }
  currentEta = 4;
  document.getElementById('etaNum').textContent = currentEta;
  if (riderEtaTimer) clearInterval(riderEtaTimer);
  riderEtaTimer = setInterval(() => {
    currentEta--;
    document.getElementById('etaNum').textContent = Math.max(0,currentEta);
    if (currentEta<=0) { clearInterval(riderEtaTimer); updRStep(3); }
  }, 60000);
}
function updRStep(n) {
  [1,2,3,4].forEach(i => {
    const el=document.getElementById('rs'+i);
    if(i<n) el.className='stp done'; else if(i===n) el.className='stp on'; else el.className='stp';
  });
}
function cancelRiderRide() {
  if (riderEtaTimer) clearInterval(riderEtaTimer);
  if (window._drvAnim) clearInterval(window._drvAnim);
  goScr('RHome');
  toast('âŒ Ride cancel ho gayi');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• DRIVER: DUTY â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function toggleDuty() {
  if (!isOnline) goOnline(); else goOffline();
}
function goOnline() {
  isOnline = true;
  const btn = document.getElementById('dutyBtn');
  btn.className = 'duty-btn on';
  document.getElementById('dutyTxt').textContent = 'Online';
  document.getElementById('dutyHint').textContent = 'Tap karo duty band karne ke liye';
  btn.innerHTML = `<div class="radar"></div><div class="radar2"></div><div class="duty-ico">ğŸŸ¢</div><div class="duty-txt">Online</div>`;
  goScr('DOnline');
  onlineStart = Date.now();
  onlineTimer = setInterval(() => {
    const mins = Math.floor((Date.now()-onlineStart)/60000);
    document.getElementById('onlineTime').textContent = `${Math.floor(mins/60)}h ${mins%60}m`;
  }, 30000);
  toast('ğŸŸ¢ Duty shuru! Ride requests aayenge...');
  // Send ride request after 5s
  setTimeout(() => sendRideRequest(), 5000);
}
function goOffline() {
  isOnline = false;
  const btn = document.getElementById('dutyBtn');
  btn.className = 'duty-btn off';
  btn.innerHTML = `<div class="duty-ico">ğŸš—</div><div class="duty-txt">Offline</div>`;
  document.getElementById('dutyHint').textContent = 'Duty shuru karne ke liye tap karo';
  if (onlineTimer) clearInterval(onlineTimer);
  if (requestTimer) clearInterval(requestTimer);
  document.getElementById('ridePopup').classList.remove('show');
  goScr('DOffline');
  toast('ğŸ”´ Duty band ho gayi');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• DRIVER: RIDE REQUEST â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const REQUESTS = [
  {from:'Connaught Place',to:'IGI Airport T3',dist:'18.4 km',time:'28 min',fare:'â‚¹420',riderName:'Priya Sharma',riderPic:'https://randomuser.me/api/portraits/women/32.jpg'},
  {from:'Lajpat Nagar Market',to:'Saket Mall',dist:'5.2 km',time:'12 min',fare:'â‚¹130',riderName:'Rahul Verma',riderPic:'https://randomuser.me/api/portraits/men/22.jpg'},
  {from:'AIIMS Hospital',to:'India Gate',dist:'8.4 km',time:'18 min',fare:'â‚¹195',riderName:'Anjali Singh',riderPic:'https://randomuser.me/api/portraits/women/44.jpg'},
  {from:'Dwarka Sector 10',to:'Connaught Place',dist:'22 km',time:'35 min',fare:'â‚¹480',riderName:'Amit Kumar',riderPic:'https://randomuser.me/api/portraits/men/55.jpg'},
];
let reqIdx = 0;
function sendRideRequest() {
  if (!isOnline) return;
  const r = REQUESTS[reqIdx % REQUESTS.length]; reqIdx++;
  document.getElementById('popFrom').textContent = r.from;
  document.getElementById('popTo').textContent = r.to;
  document.getElementById('popDist').textContent = r.dist;
  document.getElementById('popTime').textContent = r.time;
  document.getElementById('popFare').textContent = r.fare;
  document.querySelector('.pop-rider .pop-av img').src = r.riderPic;
  document.querySelector('.pop-rider div div:first-child').textContent = r.riderName;
  // Timer bar
  document.getElementById('timerBar').style.width = '100%';
  document.getElementById('ridePopup').classList.add('show');
  let timerSec = 25;
  if (requestTimer) clearInterval(requestTimer);
  requestTimer = setInterval(() => {
    timerSec--;
    document.getElementById('timerBar').style.width = (timerSec/25*100)+'%';
    if (timerSec <= 0) {
      clearInterval(requestTimer);
      document.getElementById('ridePopup').classList.remove('show');
      toast('â° Request expire ho gayi');
      setTimeout(() => { if(isOnline) sendRideRequest(); }, 4000);
    }
  }, 1000);
}
function declineRide() {
  clearInterval(requestTimer);
  document.getElementById('ridePopup').classList.remove('show');
  toast('âŒ Ride decline kar di');
  setTimeout(() => { if(isOnline) sendRideRequest(); }, 5000);
}
function acceptRide() {
  clearInterval(requestTimer);
  document.getElementById('ridePopup').classList.remove('show');
  const from = document.getElementById('popFrom').textContent;
  const to = document.getElementById('popTo').textContent;
  const fare = document.getElementById('popFare').textContent;
  document.getElementById('dTripFare').textContent = fare;
  document.getElementById('navDir').textContent = `${from} â†’ ${to}`;
  document.getElementById('navDist').textContent = document.getElementById('popDist').textContent + ' baaki';
  goScr('DRide');
  toast(`âœ… Ride accept! ${from} jaao`);
  // Update earnings display
  totalEarned += parseInt(fare.replace('â‚¹','').replace(',',''));
  completedRides++;
  document.getElementById('dToday').textContent = 'â‚¹'+totalEarned.toLocaleString('en-IN');
  document.getElementById('dRides').textContent = completedRides;
  document.getElementById('dEarning').textContent = 'â‚¹'+totalEarned.toLocaleString('en-IN');
}
function endTrip() {
  goScr('DOnline');
  toast('ğŸ Trip complete! Paise aa gaye âœ…');
  setTimeout(() => { if(isOnline) sendRideRequest(); }, 6000);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• TOAST â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function toast(msg) {
  document.querySelectorAll('.toast').forEach(t => t.remove());
  const el = document.createElement('div');
  el.className = 'toast'; el.textContent = msg;
  document.body.appendChild(el);
  setTimeout(() => el.remove(), 3200);
}
</script>
</body>
</html>

<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>JDP CABS ‚Äî Next Gen Mobility</title>

<script>window.MAPPLS_KEY='4e97759ed6a3fb245e52f7e22d820954';</script>
<script src="https://apis.mappls.com/advancedmaps/api/4e97759ed6a3fb245e52f7e22d820954/map_sdk?v=3.0"></script>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
  import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
  import { getFirestore, doc, setDoc, getDoc, collection, addDoc, updateDoc, onSnapshot, query, where } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyBRPV3mosWr3YFnW6xCfJaqC1bV4MhJm_Y",
    authDomain: "jdpcabs.firebaseapp.com",
    projectId: "jdpcabs",
    storageBucket: "jdpcabs.firebasestorage.app",
    messagingSenderId: "148264332732",
    appId: "1:148264332732:web:eed512ac4e685cef97cfb9"
  };

  try {
    const app = initializeApp(firebaseConfig);
    window.FB = {
      auth: getAuth(app), db: getFirestore(app),
      signIn: signInWithEmailAndPassword, create: createUserWithEmailAndPassword,
      doc, setDoc, getDoc, collection, addDoc, updateDoc, onSnapshot, query, where, signOut
    };
    console.log("üî• Firebase Ready");
    checkAuthStatus();
  } catch(e) { console.error("Firebase Error:", e); }
</script>

<style>
  /* ‚îÄ‚îÄ UNIQUE "GLASS & FLOAT" UI THEME ‚îÄ‚îÄ */
  :root {
    --bg-color: #f8fafc;
    --glass-bg: rgba(255, 255, 255, 0.85);
    --glass-border: rgba(255, 255, 255, 0.4);
    --primary: #4338ca; /* Indigo instead of Uber Black */
    --primary-light: #e0e7ff;
    --accent: #f59e0b;  /* Amber */
    --text-main: #0f172a;
    --text-muted: #64748b;
    --shadow: 0 8px 32px rgba(0, 0, 0, 0.08);
  }
  
  * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Inter', system-ui, sans-serif; -webkit-tap-highlight-color: transparent; }
  body { background: var(--bg-color); color: var(--text-main); overflow: hidden; height: 100vh; width: 100vw; }

  /* Map Container */
  #map { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 1; }

  /* ‚îÄ‚îÄ FLOATING TOP BAR ‚îÄ‚îÄ */
  .top-nav {
    position: absolute; top: 20px; left: 20px; right: 20px; z-index: 10;
    display: flex; justify-content: space-between; align-items: center;
    background: var(--glass-bg); backdrop-filter: blur(12px);
    padding: 12px 20px; border-radius: 99px; box-shadow: var(--shadow);
    border: 1px solid var(--glass-border);
  }
  .menu-btn { background: transparent; border: none; font-size: 20px; cursor: pointer; color: var(--primary); }
  .logo { font-size: 18px; font-weight: 900; letter-spacing: 0.5px; color: var(--primary); }
  .profile-dot { width: 35px; height: 35px; background: var(--primary-light); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 16px; cursor: pointer; }

  /* ‚îÄ‚îÄ AUTHENTICATION OVERLAY ‚îÄ‚îÄ */
  #authOverlay {
    position: absolute; inset: 0; background: var(--bg-color); z-index: 1000;
    display: flex; flex-direction: column; padding: 30px; overflow-y: auto;
  }
  .auth-card { background: #fff; border-radius: 24px; padding: 25px; box-shadow: var(--shadow); margin-top: auto; margin-bottom: auto; }
  .role-toggle { display: flex; background: var(--primary-light); border-radius: 12px; margin-bottom: 20px; padding: 4px; }
  .role-btn { flex: 1; padding: 10px; border-radius: 10px; border: none; background: transparent; font-weight: 700; color: var(--text-muted); cursor: pointer; transition: 0.3s; }
  .role-btn.active { background: #fff; color: var(--primary); box-shadow: 0 2px 10px rgba(0,0,0,0.05); }
  .input-field { width: 100%; padding: 15px; border-radius: 12px; border: 1px solid #e2e8f0; background: #f8fafc; margin-bottom: 15px; font-size: 15px; outline: none; }
  .input-field:focus { border-color: var(--primary); }
  .btn-primary { width: 100%; background: var(--primary); color: #fff; border: none; padding: 16px; border-radius: 14px; font-size: 16px; font-weight: 700; cursor: pointer; transition: transform 0.1s; }
  .btn-primary:active { transform: scale(0.97); }
  .auth-switch { text-align: center; margin-top: 15px; color: var(--primary); font-size: 14px; font-weight: 600; cursor: pointer; }

  /* ‚îÄ‚îÄ DRAGGABLE BOTTOM SHEET (GLASSMORPHIC) ‚îÄ‚îÄ */
  #bottomSheet {
    position: absolute; bottom: 0; left: 0; right: 0;
    background: var(--glass-bg); backdrop-filter: blur(20px);
    border-radius: 30px 30px 0 0; border-top: 1px solid var(--glass-border);
    box-shadow: 0 -10px 40px rgba(0,0,0,0.1); z-index: 100;
    height: 85vh; transform: translateY(60%);
    transition: transform 0.3s cubic-bezier(0.2, 0.8, 0.2, 1);
    display: flex; flex-direction: column;
  }
  .drag-handle { padding: 15px 0; display: flex; justify-content: center; cursor: grab; }
  .drag-bar { width: 50px; height: 5px; background: #cbd5e1; border-radius: 10px; }
  .sheet-content { padding: 0 25px 25px; overflow-y: auto; flex: 1; }
  .sheet-content::-webkit-scrollbar { display: none; }
  
  .greeting { font-size: 24px; font-weight: 800; margin-bottom: 20px; color: var(--text-main); }
  
  /* Floating Search Input */
  .search-box { display: flex; align-items: center; background: #fff; padding: 16px; border-radius: 16px; margin-bottom: 20px; box-shadow: 0 4px 15px rgba(0,0,0,0.03); border: 1px solid #f1f5f9; }
  .search-box input { border: none; font-size: 16px; font-weight: 600; width: 100%; outline: none; margin-left: 12px; }
  
  .section-title { font-size: 13px; font-weight: 800; color: var(--text-muted); margin-bottom: 12px; text-transform: uppercase; letter-spacing: 0.5px; }
  
  /* Ride Options (Cards) */
  .ride-options { display: flex; flex-direction: column; gap: 12px; margin-bottom: 20px; display: none; }
  .ride-card { display: flex; align-items: center; justify-content: space-between; background: #fff; padding: 15px; border-radius: 16px; border: 2px solid transparent; cursor: pointer; transition: 0.2s; box-shadow: 0 2px 10px rgba(0,0,0,0.02); }
  .ride-card.active { border-color: var(--primary); background: var(--primary-light); }
  .ride-info { flex: 1; margin-left: 15px; }
  .ride-name { font-size: 16px; font-weight: 800; }
  .ride-time { font-size: 13px; color: var(--text-muted); margin-top: 2px; }
  .ride-price { font-size: 18px; font-weight: 900; color: var(--primary); }

  /* ‚îÄ‚îÄ DRIVER DASHBOARD ‚îÄ‚îÄ */
  #driverDash { position: absolute; bottom: 0; left: 0; right: 0; background: var(--glass-bg); backdrop-filter: blur(20px); border-radius: 30px 30px 0 0; padding: 30px 25px; z-index: 100; display: none; box-shadow: var(--shadow); }
  .status-badge { display: inline-block; padding: 6px 12px; border-radius: 99px; font-size: 12px; font-weight: 800; background: #fee2e2; color: #ef4444; margin-bottom: 15px; }
  .status-badge.online { background: #dcfce7; color: #22c55e; }
  .dash-stats { display: flex; gap: 15px; margin-bottom: 20px; }
  .stat-box { flex: 1; background: #fff; padding: 15px; border-radius: 16px; text-align: center; box-shadow: 0 2px 10px rgba(0,0,0,0.02); }
  .stat-val { font-size: 20px; font-weight: 900; color: var(--primary); }
  .stat-lbl { font-size: 12px; color: var(--text-muted); font-weight: 600; margin-top: 4px; }
</style>
</head>
<body>

  <div id="map"></div>

  <div class="top-nav">
    <button class="menu-btn" onclick="logout()">‚öôÔ∏è</button>
    <div class="logo">JDP CABS</div>
    <div class="profile-dot">üë§</div>
  </div>

  <div id="authOverlay">
    <h1 style="font-size: 32px; font-weight: 900; color: var(--primary); text-align: center; margin-bottom: 10px;">JDP CABS</h1>
    <p style="text-align: center; color: var(--text-muted); margin-bottom: 30px;">Premium Rides in Jagdalpur</p>
    
    <div class="auth-card">
      <div class="role-toggle">
        <button class="role-btn active" id="btnRiderAuth" onclick="setAuthRole('rider')">Rider</button>
        <button class="role-btn" id="btnDriverAuth" onclick="setAuthRole('driver')">Driver</button>
      </div>

      <div id="authError" style="color: red; font-size: 13px; margin-bottom: 10px; display: none; text-align: center;"></div>

      <input type="email" id="emailInput" class="input-field" placeholder="Email Address">
      <input type="password" id="passInput" class="input-field" placeholder="Password (min 6 chars)">
      
      <div id="driverFields" style="display: none;">
        <input type="text" id="vehNoInput" class="input-field" placeholder="Vehicle Number (e.g., CG17 AA 1234)">
      </div>

      <button class="btn-primary" id="actionBtn" onclick="handleAuth()">Login to Account</button>
      <div class="auth-switch" onclick="toggleAuthMode()" id="switchText">New User? Create Account</div>
    </div>
  </div>

  <div id="bottomSheet" style="display:none;">
    <div class="drag-handle" id="dragHandle"><div class="drag-bar"></div></div>
    
    <div class="sheet-content">
      <div class="greeting" id="riderGreeting">Where to?</div>
      
      <div class="search-box">
        <div style="width:12px; height:12px; background: var(--accent); border-radius: 50%;"></div>
        <input type="text" id="dropLocation" placeholder="Search destination...">
      </div>

      <div class="section-title">Ride Options</div>
      
      <div class="ride-options" id="rideOptionsList">
        <div class="ride-card active" onclick="selectRideType('Auto')">
          <div style="font-size: 30px;">üõ∫</div>
          <div class="ride-info">
            <div class="ride-name">JDP Auto</div>
            <div class="ride-time" id="etaAuto">-- min away</div>
          </div>
          <div class="ride-price" id="fareAuto">‚Çπ--</div>
        </div>
        
        <div class="ride-card" onclick="selectRideType('Cab')">
          <div style="font-size: 30px;">üöó</div>
          <div class="ride-info">
            <div class="ride-name">Mini Cab</div>
            <div class="ride-time" id="etaCab">-- min away</div>
          </div>
          <div class="ride-price" id="fareCab">‚Çπ--</div>
        </div>
      </div>

      <button class="btn-primary" id="bookBtn" onclick="calculateFare()">Calculate Fare</button>
    </div>
  </div>

  <div id="driverDash">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
      <h2 style="font-size: 22px; font-weight: 800;">Dashboard</h2>
      <div class="status-badge" id="driverStatus">OFFLINE</div>
    </div>
    
    <div class="dash-stats">
      <div class="stat-box">
        <div class="stat-val" id="dEarnings">‚Çπ0</div>
        <div class="stat-lbl">Today's Earn</div>
      </div>
      <div class="stat-box">
        <div class="stat-val" id="dRides">0</div>
        <div class="stat-lbl">Total Rides</div>
      </div>
    </div>

    <button class="btn-primary" id="toggleOnlineBtn" onclick="toggleOnlineStatus()">Go Online</button>
  </div>

<script>
  // ‚îÄ‚îÄ APP STATE VARIABLES ‚îÄ‚îÄ
  let map, myLat = 19.0760, myLng = 82.0150;
  let currentUser = null;
  let authMode = 'login'; // 'login' or 'register'
  let selectedRole = 'rider'; // 'rider' or 'driver'
  let isDriverOnline = false;
  
  // Rider Booking State
  let selectedRideType = 'Auto';
  let calculatedFare = 0;
  let calculatedDist = 0;

  // ‚îÄ‚îÄ 1. MAP INITIALIZATION ‚îÄ‚îÄ
  function initMap() {
    try {
      map = new mappls.Map('map', { center: { lat: myLat, lng: myLng }, zoom: 14, zoomControl: false, search: false });
      new mappls.Marker({ map: map, position: { lat: myLat, lng: myLng }, popupHtml: "<b>Jagdalpur City</b>" });
      getUserLocation();
    } catch(e) { console.error("Map Load Error:", e); }
  }
  setTimeout(() => { if(typeof mappls !== 'undefined') initMap(); }, 1000);

  function getUserLocation() {
    if(navigator.geolocation) {
      navigator.geolocation.getCurrentPosition(pos => {
        myLat = pos.coords.latitude; myLng = pos.coords.longitude;
        map.setCenter({lat: myLat, lng: myLng});
        new mappls.Marker({ map: map, position: { lat: myLat, lng: myLng }, html: '<div style="width:15px; height:15px; background:var(--primary); border:3px solid white; border-radius:50%; box-shadow: 0 0 10px rgba(0,0,0,0.3);"></div>' });
      });
    }
  }

  // ‚îÄ‚îÄ 2. AUTHENTICATION LOGIC ‚îÄ‚îÄ
  function setAuthRole(role) {
    selectedRole = role;
    document.getElementById('btnRiderAuth').className = `role-btn ${role === 'rider' ? 'active' : ''}`;
    document.getElementById('btnDriverAuth').className = `role-btn ${role === 'driver' ? 'active' : ''}`;
    document.getElementById('driverFields').style.display = role === 'driver' && authMode === 'register' ? 'block' : 'none';
  }

  function toggleAuthMode() {
    authMode = authMode === 'login' ? 'register' : 'login';
    document.getElementById('actionBtn').innerText = authMode === 'login' ? 'Login to Account' : 'Create Account';
    document.getElementById('switchText').innerText = authMode === 'login' ? 'New User? Create Account' : 'Already have an account? Login';
    document.getElementById('driverFields').style.display = selectedRole === 'driver' && authMode === 'register' ? 'block' : 'none';
  }

  function checkAuthStatus() {
    window.FB.auth.onAuthStateChanged(async (user) => {
      if (user) {
        const docSnap = await window.FB.getDoc(window.FB.doc(window.FB.db, 'users', user.uid));
        if (docSnap.exists()) {
          currentUser = { uid: user.uid, ...docSnap.data() };
          document.getElementById('authOverlay').style.display = 'none';
          loadAppInterface();
        }
      } else {
        document.getElementById('authOverlay').style.display = 'flex';
        document.getElementById('bottomSheet').style.display = 'none';
        document.getElementById('driverDash').style.display = 'none';
      }
    });
  }

  async function handleAuth() {
    const email = document.getElementById('emailInput').value;
    const pass = document.getElementById('passInput').value;
    const errEl = document.getElementById('authError');
    errEl.style.display = 'none';

    if(!email || pass.length < 6) { errEl.innerText = "Invalid Email or Password (min 6 chars)"; errEl.style.display = 'block'; return; }

    try {
      if (authMode === 'login') {
        await window.FB.signIn(window.FB.auth, email, pass);
      } else {
        const vehNo = document.getElementById('vehNoInput').value;
        if(selectedRole === 'driver' && !vehNo) { errEl.innerText = "Vehicle Number is required"; errEl.style.display = 'block'; return; }
        
        const cred = await window.FB.create(window.FB.auth, email, pass);
        const userData = { email, role: selectedRole, createdAt: new Date() };
        if(selectedRole === 'driver') { userData.vehicleNo = vehNo; userData.earnings = 0; userData.ridesCompleted = 0; }
        await window.FB.setDoc(window.FB.doc(window.FB.db, 'users', cred.user.uid), userData);
      }
    } catch(e) { errEl.innerText = e.message; errEl.style.display = 'block'; }
  }

  function logout() {
    window.FB.signOut(window.FB.auth);
  }

  // ‚îÄ‚îÄ 3. LOAD INTERFACE BASED ON ROLE ‚îÄ‚îÄ
  function loadAppInterface() {
    if (currentUser.role === 'rider') {
      document.getElementById('bottomSheet').style.display = 'flex';
      document.getElementById('driverDash').style.display = 'none';
      document.getElementById('riderGreeting').innerText = `Hello, Ready to ride?`;
      initDraggableSheet();
    } else {
      document.getElementById('bottomSheet').style.display = 'none';
      document.getElementById('driverDash').style.display = 'block';
      document.getElementById('dEarnings').innerText = `‚Çπ${currentUser.earnings || 0}`;
      document.getElementById('dRides').innerText = currentUser.ridesCompleted || 0;
    }
  }

  // ‚îÄ‚îÄ 4. RIDER LOGIC (Fare & Booking) ‚îÄ‚îÄ
  function calculateFare() {
    const drop = document.getElementById('dropLocation').value;
    if(!drop) { alert("Please enter destination"); return; }
    
    // Simulate Distance Calculation (Haversine logic goes here in full app)
    calculatedDist = (Math.random() * 5 + 2).toFixed(1); // 2 to 7 km mock
    
    // Calculate Rates (JDP Specs: Auto ‚Çπ12/km base 25, Cab ‚Çπ16/km base 50)
    const fareAuto = Math.max(25, Math.round(calculatedDist * 12));
    const fareCab = Math.max(50, Math.round(calculatedDist * 16));

    document.getElementById('fareAuto').innerText = `‚Çπ${fareAuto}`;
    document.getElementById('fareCab').innerText = `‚Çπ${fareCab}`;
    document.getElementById('etaAuto').innerText = `~${Math.ceil(calculatedDist * 2)} min`;
    document.getElementById('etaCab').innerText = `~${Math.ceil(calculatedDist * 2.5)} min`;

    document.getElementById('rideOptionsList').style.display = 'flex';
    
    const btn = document.getElementById('bookBtn');
    btn.innerText = `Confirm ${selectedRideType} Booking`;
    btn.onclick = confirmBooking;
  }

  function selectRideType(type) {
    selectedRideType = type;
    const cards = document.querySelectorAll('.ride-card');
    cards[0].className = `ride-card ${type === 'Auto' ? 'active' : ''}`;
    cards[1].className = `ride-card ${type === 'Cab' ? 'active' : ''}`;
    document.getElementById('bookBtn').innerText = `Confirm ${type} Booking`;
  }

  async function confirmBooking() {
    const drop = document.getElementById('dropLocation').value;
    document.getElementById('bookBtn').innerText = 'Finding Driver...';
    
    // Create Ride in Firestore
    try {
      await window.FB.addDoc(window.FB.collection(window.FB.db, 'rides'), {
        riderId: currentUser.uid,
        pickupLat: myLat, pickupLng: myLng,
        drop: drop,
        cabType: selectedRideType,
        fare: selectedRideType === 'Auto' ? (calculatedDist*12) : (calculatedDist*16),
        status: 'finding',
        timestamp: new Date()
      });
      alert(`Booking Request Sent! Searching for nearby ${selectedRideType}s.`);
      // Reset sheet
      currentSnap = 60; document.getElementById('bottomSheet').style.transform = `translateY(${currentSnap}%)`;
      document.getElementById('bookBtn').innerText = 'Calculate Fare';
      document.getElementById('bookBtn').onclick = calculateFare;
      document.getElementById('rideOptionsList').style.display = 'none';
    } catch(e) { alert("Booking failed. Check network."); }
  }

  // ‚îÄ‚îÄ 5. DRIVER LOGIC ‚îÄ‚îÄ
  async function toggleOnlineStatus() {
    isDriverOnline = !isDriverOnline;
    const badge = document.getElementById('driverStatus');
    const btn = document.getElementById('toggleOnlineBtn');
    
    if (isDriverOnline) {
      badge.innerText = "ONLINE & LISTENING";
      badge.className = "status-badge online";
      btn.innerText = "Go Offline";
      btn.style.background = "#ef4444"; // Red for offline
      // Update DB
      await window.FB.updateDoc(window.FB.doc(window.FB.db, 'users', currentUser.uid), { isOnline: true, lat: myLat, lng: myLng });
    } else {
      badge.innerText = "OFFLINE";
      badge.className = "status-badge";
      btn.innerText = "Go Online";
      btn.style.background = "var(--primary)";
      await window.FB.updateDoc(window.FB.doc(window.FB.db, 'users', currentUser.uid), { isOnline: false });
    }
  }

  // ‚îÄ‚îÄ 6. DRAGGABLE SHEET LOGIC ‚îÄ‚îÄ
  let currentSnap = 60; 
  function initDraggableSheet() {
    const sheet = document.getElementById('bottomSheet');
    const handle = document.getElementById('dragHandle');
    let startY = 0, isDragging = false;
    
    handle.addEventListener('touchstart', e => { startY = e.touches[0].clientY; isDragging = true; sheet.style.transition = 'none'; }, {passive: true});
    handle.addEventListener('touchmove', e => {
      if(!isDragging) return;
      let newT = currentSnap + ((e.touches[0].clientY - startY) / window.innerHeight) * 100;
      if(newT < 0) newT = 0; if(newT > 85) newT = 85;
      sheet.style.transform = `translateY(${newT}%)`;
    }, {passive: true});
    handle.addEventListener('touchend', e => {
      isDragging = false; sheet.style.transition = 'transform 0.3s cubic-bezier(0.2, 0.8, 0.2, 1)';
      const deltaY = e.changedTouches[0].clientY - startY;
      if(deltaY < -30) currentSnap = 0; else if(deltaY > 30) currentSnap = currentSnap===0 ? 60 : 85;
      sheet.style.transform = `translateY(${currentSnap}%)`;
    });
  }
</script>
</body>
</html>

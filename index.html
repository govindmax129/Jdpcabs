<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>JDP CABS ‚Äî Live System</title>
<link href="https://fonts.googleapis.com/css2?family=Syne:wght@700;800;900&family=DM+Sans:wght@400;500;600;700&display=swap" rel="stylesheet">

<!-- ‚úÖ LEAFLET.JS ‚Äî FREE MAP (replaces MapMyIndia) -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.css">
<script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.js"></script>

<style>
:root{
  --bg:#07090f;--card:#0d1219;--card2:#131b25;
  --border:#1a2535;--text:#eaf0fb;--muted:#4d6a8a;
  --yellow:#f59e0b;--green:#10b981;--red:#ef4444;--blue:#3b82f6;
}
body.lm{--bg:#f0f4fb;--card:#fff;--card2:#e8eef8;--border:#c8d4e4;--text:#0c1929;--muted:#4d6a8a;}
*{margin:0;padding:0;box-sizing:border-box;-webkit-tap-highlight-color:transparent;}
body{font-family:'DM Sans',sans-serif;background:var(--bg);color:var(--text);height:100vh;overflow:hidden;}

/* MAP ‚Äî Full screen Uber style */
#map{position:absolute;inset:0;z-index:1;width:100vw;height:100vh;}
.leaflet-control-zoom{display:none!important;}
.leaflet-control-attribution{font-size:8px!important;opacity:.4;}

/* Custom Markers */
.my-loc-pin{
  width:22px;height:22px;position:relative;display:flex;align-items:center;justify-content:center;
}
.my-loc-inner{
  width:12px;height:12px;background:#3b82f6;border:2.5px solid white;border-radius:50%;
  box-shadow:0 0 0 0 rgba(59,130,246,.5);animation:myloc 2s infinite;z-index:2;position:relative;
}
.my-loc-ring{
  position:absolute;width:22px;height:22px;border:2px solid rgba(59,130,246,.35);
  border-radius:50%;animation:myring 2s infinite;
}
@keyframes myloc{
  0%{box-shadow:0 0 0 0 rgba(59,130,246,.6)}
  70%{box-shadow:0 0 0 10px rgba(59,130,246,0)}
  100%{box-shadow:0 0 0 0 rgba(59,130,246,0)}
}
@keyframes myring{
  0%{transform:scale(.8);opacity:.9}100%{transform:scale(2);opacity:0}
}
.car-marker{
  font-size:28px;line-height:1;filter:drop-shadow(0 3px 8px rgba(0,0,0,.7));
  transition:transform .4s cubic-bezier(.34,1.56,.64,1);
  animation:carBob 2s ease-in-out infinite;
}
@keyframes carBob{0%,100%{transform:translateY(0)}50%{transform:translateY(-2px)}}
.pickup-pin{font-size:26px;line-height:1;filter:drop-shadow(0 3px 6px rgba(0,0,0,.6));}
.drop-pin{font-size:26px;line-height:1;filter:drop-shadow(0 3px 6px rgba(0,0,0,.6));}

/* Leaflet popup overrides */
.leaflet-popup-content-wrapper{
  background:rgba(7,9,15,.95)!important;color:white!important;border:1px solid rgba(255,255,255,.1)!important;
  border-radius:10px!important;font-family:'DM Sans',sans-serif!important;
}
.leaflet-popup-tip{background:rgba(7,9,15,.95)!important;}

/* LOADER */
#loader{position:fixed;inset:0;background:var(--bg);z-index:9999;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:16px;}
.ld-box{width:80px;height:80px;background:var(--yellow);border-radius:20px;display:flex;align-items:center;justify-content:center;font-family:'Syne',sans-serif;font-size:1.35rem;font-weight:900;color:#000;animation:ldp 2s infinite;}
@keyframes ldp{0%,100%{box-shadow:0 0 36px rgba(245,158,11,.45)}50%{box-shadow:0 0 64px rgba(245,158,11,.85)}}
.ld-t{font-family:'Syne',sans-serif;font-size:1.5rem;font-weight:900;letter-spacing:.06em;}
.ld-s{font-size:.75rem;color:var(--muted);}
.ld-bar-w{width:180px;height:3px;background:rgba(255,255,255,.07);border-radius:99px;overflow:hidden;}
.ld-bar{height:100%;width:0%;background:linear-gradient(90deg,var(--yellow),#f97316);border-radius:99px;transition:width .3s;}

/* AUTH */
#auth{position:fixed;inset:0;z-index:8000;display:none;flex-direction:column;background:var(--bg);overflow-y:auto;}
#auth::-webkit-scrollbar{display:none;}
.ah{position:relative;height:190px;overflow:hidden;flex-shrink:0;}
.ah img{width:100%;height:100%;object-fit:cover;opacity:.32;}
.ah-ov{position:absolute;inset:0;background:linear-gradient(to bottom,rgba(7,9,15,.1),rgba(7,9,15,1));display:flex;flex-direction:column;justify-content:flex-end;padding:20px;}
.ab{padding:0 16px 48px;}
.rtog{display:flex;gap:4px;background:rgba(255,255,255,.04);border:1px solid var(--border);border-radius:13px;padding:4px;margin-bottom:14px;}
.rtab{flex:1;padding:11px;border-radius:9px;border:none;background:transparent;color:var(--muted);font-weight:700;cursor:pointer;font-size:.87rem;font-family:'DM Sans',sans-serif;}
.rtab.ar{background:var(--yellow);color:#000;}
.rtab.ad{background:var(--green);color:#fff;}
.atabs{display:flex;gap:4px;background:rgba(255,255,255,.04);border:1px solid var(--border);border-radius:11px;padding:4px;margin-bottom:16px;}
.atab{flex:1;padding:9px;border-radius:8px;border:none;background:transparent;color:var(--muted);font-weight:700;cursor:pointer;font-family:'DM Sans',sans-serif;}
.atab.on{background:var(--card2);color:var(--text);}
.afrm{display:none;}.afrm.sh{display:block;animation:fup .3s ease;}
@keyframes fup{from{opacity:0;transform:translateY(12px)}to{opacity:1;transform:translateY(0)}}
.fg{margin-bottom:12px;}
.fl{font-size:.65rem;font-weight:700;color:var(--muted);margin-bottom:5px;display:block;text-transform:uppercase;letter-spacing:.05em;}
.fi{width:100%;background:rgba(255,255,255,.04);border:1.5px solid var(--border);border-radius:11px;padding:12px 14px;color:var(--text);outline:none;font-family:'DM Sans',sans-serif;font-size:.9rem;transition:border-color .2s;}
.fi:focus{border-color:var(--yellow);}
.fi.gf:focus{border-color:var(--green);}
body.lm .fi{background:#fff;color:#000;}
.fr{display:grid;grid-template-columns:1fr 1fr;gap:10px;}
.vg{display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-bottom:12px;}
.vc{background:rgba(255,255,255,.04);border:1.5px solid var(--border);border-radius:11px;padding:11px;text-align:center;cursor:pointer;transition:all .2s;}
.vc.on{border-color:var(--green);background:rgba(16,185,129,.08);}
.asub{width:100%;border:none;border-radius:13px;padding:15px;font-size:.94rem;font-weight:800;cursor:pointer;font-family:'Syne',sans-serif;}
.asub.y{background:var(--yellow);color:#000;}
.asub.g{background:var(--green);color:#fff;}
.fbb{display:inline-flex;align-items:center;gap:5px;border-radius:99px;padding:4px 11px;font-size:.63rem;font-weight:700;margin-bottom:13px;background:rgba(255,165,0,.1);border:1px solid rgba(255,165,0,.2);color:orange;}
.fbb.ok{background:rgba(16,185,129,.1);border-color:rgba(16,185,129,.2);color:var(--green);}
.fbb.er{background:rgba(239,68,68,.1);border-color:rgba(239,68,68,.2);color:var(--red);}
.eb{background:rgba(239,68,68,.1);border:1px solid rgba(239,68,68,.25);border-radius:11px;padding:10px 13px;font-size:.78rem;font-weight:600;color:var(--red);margin-bottom:11px;display:none;}

/* TOP BAR */
.tb{position:fixed;top:0;left:0;right:0;z-index:500;display:flex;justify-content:space-between;align-items:center;padding:11px 15px;background:linear-gradient(to bottom,rgba(0,0,0,.75),transparent);}
.tbtn{height:36px;background:rgba(0,0,0,.55);border:1px solid rgba(255,255,255,.11);border-radius:9px;display:flex;align-items:center;justify-content:center;cursor:pointer;padding:0 11px;font-size:.76rem;font-weight:700;color:var(--text);gap:5px;backdrop-filter:blur(8px);}
body.lm .tbtn{background:rgba(255,255,255,.85);color:#000;}
.locbtn{position:fixed;right:15px;z-index:500;width:44px;height:44px;background:white;border-radius:50%;border:none;cursor:pointer;font-size:1.05rem;box-shadow:0 4px 16px rgba(0,0,0,.35);display:flex;align-items:center;justify-content:center;}

/* SHEETS */
.sheet{position:fixed;bottom:0;left:0;right:0;z-index:400;background:rgba(7,9,15,.97);backdrop-filter:blur(32px);border-radius:22px 22px 0 0;border-top:1px solid rgba(255,255,255,.07);padding:0 17px 34px;max-height:85vh;overflow-y:auto;display:none;}
.sheet::-webkit-scrollbar{display:none;}
body.lm .sheet{background:rgba(240,244,251,.97);}
.hdl{width:34px;height:4px;background:rgba(255,255,255,.1);border-radius:4px;margin:11px auto 17px;}
body.lm .hdl{background:rgba(0,0,0,.1);}

/* SCREENS */
.scr{display:none;}.scr.on{display:block;animation:fup .3s ease;}
.mbtn{width:100%;border:none;border-radius:14px;padding:15px;font-size:.94rem;font-weight:800;cursor:pointer;margin-top:9px;font-family:'Syne',sans-serif;transition:transform .1s,box-shadow .2s;}
.mbtn:active{transform:scale(.98);}
.mbtn.y{background:var(--yellow);color:#000;box-shadow:0 5px 18px rgba(245,158,11,.3);}
.mbtn.ro{background:rgba(239,68,68,.08);color:var(--red);border:1px solid rgba(239,68,68,.2);}
.mbtn.g{background:var(--green);color:#fff;box-shadow:0 5px 18px rgba(16,185,129,.25);}
.mbtn.b{background:var(--blue);color:#fff;}

/* LOCATION BOXES */
.lbs{display:flex;flex-direction:column;margin-bottom:13px;}
.lb{display:flex;align-items:center;gap:11px;background:rgba(255,255,255,.04);border:1.5px solid var(--border);padding:12px 13px;transition:all .2s;}
.lb:first-child{border-radius:13px 13px 0 0;border-bottom:none;}
.lb:last-child{border-radius:0 0 13px 13px;}
.lb:last-child:focus-within{border-color:var(--yellow);}
body.lm .lb{background:rgba(0,0,0,.03);}
.pdot{width:10px;height:10px;background:var(--green);border-radius:50%;flex-shrink:0;animation:dpulse 2s infinite;}
@keyframes dpulse{0%,100%{box-shadow:0 0 5px var(--green)}50%{box-shadow:0 0 12px var(--green),0 0 3px rgba(16,185,129,.5)}}
.lspin{width:9px;height:9px;border:2px solid rgba(16,185,129,.3);border-top:2px solid var(--green);border-radius:50%;animation:spin .8s linear infinite;flex-shrink:0;}
@keyframes spin{to{transform:rotate(360deg)}}

/* CHIPS */
.chips{display:flex;gap:7px;margin-bottom:13px;}
.chip{flex:1;background:rgba(255,255,255,.04);border:1px solid var(--border);border-radius:11px;padding:9px 7px;text-align:center;}
body.lm .chip{background:#f1f5f9;}
.cv{font-weight:800;font-size:.97rem;font-family:'Syne',sans-serif;}
.cl{font-size:.58rem;font-weight:600;color:var(--muted);margin-top:2px;text-transform:uppercase;letter-spacing:.04em;}

/* RIDE OPTIONS */
.ro-card{display:flex;align-items:center;padding:13px;background:rgba(255,255,255,.04);border:1.5px solid var(--border);border-radius:13px;margin-bottom:8px;cursor:pointer;transition:all .2s;}
.ro-card.sel{background:rgba(245,158,11,.06);border-color:var(--yellow);}
body.lm .ro-card{background:#fff;}

/* RADAR */
.rdr{text-align:center;padding:24px 0;}
.rdr-rings{position:relative;width:84px;height:84px;margin:0 auto 16px;}
.r1{position:absolute;inset:0;border:2px solid rgba(245,158,11,.12);border-radius:50%;}
.r2{position:absolute;inset:9px;border:2px solid rgba(245,158,11,.22);border-radius:50%;}
.r3{position:absolute;inset:19px;border:3px solid transparent;border-top:3px solid var(--yellow);border-radius:50%;animation:spin .9s linear infinite;}
.r4{position:absolute;inset:33px;background:var(--yellow);border-radius:50%;box-shadow:0 0 12px rgba(245,158,11,.8);}

/* DRIVER CARD */
.dcard{display:flex;align-items:center;gap:13px;margin-bottom:14px;padding:13px;background:rgba(255,255,255,.03);border:1px solid var(--border);border-radius:15px;}
body.lm .dcard{background:#fff;}
.dava{width:52px;height:52px;background:linear-gradient(135deg,#1e2d4a,#253a5e);border-radius:50%;font-size:1.9rem;display:flex;align-items:center;justify-content:center;flex-shrink:0;}
.otp{background:var(--card2);padding:8px 11px;border-radius:10px;border:1px solid var(--border);text-align:center;min-width:65px;}

/* LIVE STATUS BADGE */
.lbadge{display:flex;align-items:center;gap:7px;padding:8px 12px;border-radius:9px;margin-bottom:11px;font-size:.76rem;font-weight:600;}
.lbadge.g{background:rgba(16,185,129,.08);border:1px solid rgba(16,185,129,.2);color:var(--green);}
.lbadge.r{background:rgba(239,68,68,.08);border:1px solid rgba(239,68,68,.2);color:var(--red);}
.lbadge.b{background:rgba(59,130,246,.08);border:1px solid rgba(59,130,246,.2);color:var(--blue);}
.lbd{width:7px;height:7px;border-radius:50%;flex-shrink:0;}
.lbadge.g .lbd{background:var(--green);box-shadow:0 0 6px var(--green);}
.lbadge.r .lbd{background:var(--red);box-shadow:0 0 6px var(--red);}
.lbadge.b .lbd{background:var(--blue);box-shadow:0 0 6px var(--blue);animation:dpulse 1.5s infinite;}

/* ‚ïê‚ïê‚ïê‚ïê DRIVER DASHBOARD ‚ïê‚ïê‚ïê‚ïê */
#dTopBar{position:fixed;top:0;left:0;right:0;z-index:500;display:none;padding:11px 15px;background:linear-gradient(to bottom,rgba(0,0,0,.8),transparent);}
.d-nr{display:flex;align-items:center;justify-content:space-between;}
.d-nm{font-family:'Syne',sans-serif;font-weight:800;font-size:.92rem;color:white;}
.tgsw{position:relative;width:52px;height:27px;cursor:pointer;}
.tgsw input{opacity:0;width:0;height:0;}
.tgtr{position:absolute;inset:0;background:#2d3748;border-radius:99px;transition:background .3s;border:1.5px solid rgba(255,255,255,.08);}
.tgsw input:checked+.tgtr{background:var(--green);}
.tgth{position:absolute;height:19px;width:19px;left:4px;top:50%;transform:translateY(-50%);background:white;border-radius:50%;transition:transform .3s;box-shadow:0 2px 5px rgba(0,0,0,.3);}
.tgsw input:checked~.tgth{transform:translateY(-50%) translateX(25px);}

#dStats{position:fixed;top:62px;left:0;right:0;z-index:499;display:none;padding:0 13px;}
.dsr{display:flex;gap:7px;}
.dst{background:rgba(7,9,15,.88);backdrop-filter:blur(14px);border:1px solid rgba(255,255,255,.08);border-radius:11px;padding:9px 12px;flex:1;text-align:center;}
.dsv{font-family:'Syne',sans-serif;font-weight:800;font-size:.95rem;color:var(--yellow);}
.dsl{font-size:.58rem;color:var(--muted);font-weight:600;text-transform:uppercase;margin-top:1px;letter-spacing:.04em;}

#dPanel{position:fixed;bottom:0;left:0;right:0;z-index:400;display:none;}
#dOff{background:rgba(7,9,15,.97);backdrop-filter:blur(28px);border-radius:22px 22px 0 0;border-top:1px solid rgba(255,255,255,.06);padding:20px 17px 34px;text-align:center;}
body.lm #dOff{background:rgba(240,244,251,.97);}
#dOn{background:rgba(7,9,15,.97);backdrop-filter:blur(28px);border-radius:22px 22px 0 0;border-top:1px solid rgba(255,255,255,.06);padding:18px 17px 30px;display:none;}
body.lm #dOn{background:rgba(240,244,251,.97);}
.opulse{display:flex;align-items:center;gap:9px;background:rgba(16,185,129,.08);border:1px solid rgba(16,185,129,.2);border-radius:13px;padding:13px;margin-bottom:12px;}
.odpulse{width:9px;height:9px;background:var(--green);border-radius:50%;flex-shrink:0;animation:oping 1.8s infinite;}
@keyframes oping{0%{box-shadow:0 0 0 0 rgba(16,185,129,.5)}70%{box-shadow:0 0 0 9px rgba(16,185,129,0)}100%{box-shadow:0 0 0 0 rgba(16,185,129,0)}}

/* RIDE REQUEST POPUP */
#reqPopup{position:fixed;bottom:-100%;left:0;right:0;z-index:700;transition:bottom .4s cubic-bezier(.34,1.56,.64,1);}
#reqPopup.sh{bottom:0;}
.rpc{background:var(--bg);border-radius:24px 24px 0 0;border-top:1px solid rgba(255,255,255,.1);padding:18px 17px 34px;box-shadow:0 -14px 50px rgba(0,0,0,.65);}
body.lm .rpc{background:#fff;}
.rtring{position:relative;width:60px;height:60px;margin:0 auto 13px;}
.rtsvg{transform:rotate(-90deg);}
.rtcbg{fill:none;stroke:rgba(255,255,255,.07);stroke-width:5;}
.rtc{fill:none;stroke:var(--yellow);stroke-width:5;stroke-linecap:round;stroke-dasharray:163;stroke-dashoffset:0;transition:stroke-dashoffset 1s linear;}
.rtn{position:absolute;inset:0;display:flex;align-items:center;justify-content:center;font-family:'Syne',sans-serif;font-weight:900;font-size:1.25rem;color:var(--yellow);}
.trip-row{display:flex;align-items:stretch;gap:11px;margin:13px 0;}
.tdots{display:flex;flex-direction:column;align-items:center;gap:3px;padding-top:3px;}
.tdg{width:8px;height:8px;background:var(--green);border-radius:50%;flex-shrink:0;}
.tdl{width:2px;flex:1;background:rgba(255,255,255,.09);}
.tdr{width:8px;height:8px;background:var(--red);border-radius:50%;flex-shrink:0;}
.tadd{flex:1;}
.ta-row{padding:6px 0;border-bottom:1px solid rgba(255,255,255,.05);}
.ta-row:last-child{border-bottom:none;padding-bottom:0;}
.ta-lbl{font-size:.6rem;color:var(--muted);font-weight:700;text-transform:uppercase;letter-spacing:.04em;}
.ta-val{font-size:.86rem;font-weight:700;margin-top:2px;}
.req-btns{display:grid;grid-template-columns:1fr 1.6fr;gap:9px;margin-top:13px;}

/* DRIVER NAV */
#dNav{background:rgba(7,9,15,.97);backdrop-filter:blur(28px);border-radius:22px 22px 0 0;border-top:1px solid rgba(255,255,255,.07);padding:17px 17px 30px;display:none;}
body.lm #dNav{background:rgba(240,244,251,.97);}
.nstep{display:flex;align-items:center;gap:11px;border-radius:13px;padding:11px 13px;margin-bottom:10px;}
.nstep.bl{background:rgba(59,130,246,.08);border:1px solid rgba(59,130,246,.2);}
.nstep.gr{background:rgba(16,185,129,.08);border:1px solid rgba(16,185,129,.2);}
.nicon{width:38px;height:38px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:1.1rem;flex-shrink:0;}
.nstep.bl .nicon{background:rgba(59,130,246,.15);}
.nstep.gr .nicon{background:rgba(16,185,129,.15);}

/* TOAST */
.toast{position:fixed;top:78px;left:50%;transform:translateX(-50%);background:rgba(10,15,24,.97);border:1px solid rgba(255,255,255,.09);border-radius:99px;padding:9px 20px;font-size:.78rem;font-weight:600;z-index:9999;animation:tin .3s ease,tout .3s ease 2.5s forwards;white-space:nowrap;box-shadow:0 6px 24px rgba(0,0,0,.4);}
@keyframes tin{from{opacity:0;top:56px}to{opacity:1;top:78px}}
@keyframes tout{to{opacity:0}}

/* NET */
.netb{position:fixed;bottom:0;left:50%;transform:translateX(-50%);z-index:9998;background:#ef4444;color:#fff;padding:5px 16px;font-size:.73rem;font-weight:700;border-radius:99px 99px 0 0;display:none;}

/* ‚úÖ DRIVER ASSIGNED MUSIC ANIMATION */
@keyframes assignPulse{
  0%{transform:scale(1)}
  25%{transform:scale(1.04)}
  50%{transform:scale(1)}
  75%{transform:scale(1.02)}
  100%{transform:scale(1)}
}
.assigned-anim{animation:assignPulse .5s ease 3;}
</style>
</head>
<body>

<!-- LOADER -->
<div id="loader">
  <div class="ld-box">JDP</div>
  <div class="ld-t">CABS</div>
  <div class="ld-s">Jagdalpur's Live Booking System</div>
  <div class="ld-bar-w"><div class="ld-bar" id="ldBar"></div></div>
  <div id="ldStatus" style="font-size:.7rem;color:var(--muted);">Initializing...</div>
</div>

<!-- MAP -->
<div id="map"></div>

<!-- AUTH -->
<div id="auth">
  <div class="ah">
    <img src="https://images.unsplash.com/photo-1449965408869-eaa3f722e40d?auto=format&fit=crop&w=800&q=80">
    <div class="ah-ov">
      <div style="font-family:'Syne',sans-serif;font-size:1.75rem;font-weight:900;color:white;">JDP CABS</div>
      <div style="color:rgba(255,255,255,.5);font-size:.8rem;margin-top:3px;">Jagdalpur ¬∑ Live Booking System</div>
    </div>
  </div>
  <div class="ab">
    <div class="fbb" id="fbBadge">‚è≥ Connecting...</div>
    <div class="rtog">
      <button class="rtab ar" id="rTab" onclick="setRole('rider')">üßç Rider</button>
      <button class="rtab" id="dTab" onclick="setRole('driver')">üöñ Driver</button>
    </div>
    <div class="atabs">
      <button class="atab on" id="loginTab" onclick="setTab('login')">Login</button>
      <button class="atab" id="regTab" onclick="setTab('register')">Register</button>
    </div>

    <!-- Login -->
    <div class="afrm sh" id="loginForm">
      <div id="loginErr" class="eb"></div>
      <div class="fg"><label class="fl">Mobile Number</label><input type="tel" class="fi" id="lId" placeholder="9876543210" maxlength="10"></div>
      <div class="fg"><label class="fl">Password</label><input type="password" class="fi" id="lPass" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢"></div>
      <button class="asub y" onclick="doLogin()">üöÄ Login</button>
    </div>

    <!-- Rider Register -->
    <div class="afrm" id="rRegForm">
      <div id="rRegErr" class="eb"></div>
      <div class="fr">
        <div class="fg"><label class="fl">Name</label><input type="text" class="fi" id="rFn" placeholder="Full Name"></div>
        <div class="fg"><label class="fl">Mobile</label><input type="tel" class="fi" id="rPh" placeholder="9876543210" maxlength="10"></div>
      </div>
      <div class="fg"><label class="fl">Password</label><input type="password" class="fi" id="rPw" placeholder="min 6 chars"></div>
      <button class="asub y" onclick="doRiderReg()">‚úÖ Create Account</button>
    </div>

    <!-- Driver Register -->
    <div class="afrm" id="dRegForm">
      <div id="dRegErr" class="eb"></div>
      <div class="fr">
        <div class="fg"><label class="fl">Name</label><input type="text" class="fi gf" id="dFn" placeholder="Full Name"></div>
        <div class="fg"><label class="fl">Mobile</label><input type="tel" class="fi gf" id="dPh" placeholder="9876543210" maxlength="10"></div>
      </div>
      <div class="fg"><label class="fl">Vehicle Number</label><input type="text" class="fi gf" id="dVeh" placeholder="CG 17 XX 0000"></div>
      <div class="fg"><label class="fl">Vehicle Type</label>
        <div class="vg">
          <div class="vc on" id="vAuto" onclick="selVeh('auto')"><div style="font-size:1.6rem">üõ∫</div><div style="font-size:.73rem;font-weight:700;margin-top:3px">Auto</div></div>
          <div class="vc" id="vCab" onclick="selVeh('cab')"><div style="font-size:1.6rem">üöó</div><div style="font-size:.73rem;font-weight:700;margin-top:3px">Mini Cab</div></div>
        </div>
      </div>
      <div class="fg"><label class="fl">Password</label><input type="password" class="fi gf" id="dPw" placeholder="min 6 chars"></div>
      <button class="asub g" onclick="doDriverReg()">‚úÖ Register as Driver</button>
    </div>
  </div>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê RIDER UI ‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div class="tb" id="rTop" style="display:none">
  <div style="font-family:'Syne',sans-serif;font-weight:900;color:white;font-size:.93rem;letter-spacing:.05em">JDP CABS</div>
  <div style="display:flex;gap:7px">
    <div class="tbtn" onclick="toggleTheme()">‚òÄÔ∏è</div>
    <div class="tbtn" id="zoneBtn" onclick="toggleZone()">üì°</div>
    <div class="tbtn" style="color:var(--red);border-color:rgba(239,68,68,.3)" onclick="doLogout()">Logout</div>
  </div>
</div>
<button class="locbtn" id="locBtn" style="display:none;bottom:355px" onclick="locateMe()">üìç</button>

<!-- Rider Sheet -->
<div class="sheet" id="rSheet">
  <div class="hdl"></div>

  <!-- Home -->
  <div class="scr on" id="sHome">
    <div style="font-size:.68rem;color:var(--muted);font-weight:700;margin-bottom:11px;letter-spacing:.08em;text-transform:uppercase">WHERE TO, <span id="riderName">RIDER</span>?</div>
    <div class="lbs">
      <div class="lb">
        <div class="pdot"></div>
        <div style="flex:1;min-width:0">
          <div style="font-weight:700;font-size:.87rem;white-space:nowrap;overflow:hidden;text-overflow:ellipsis" id="pAddr">Detecting location...</div>
          <div id="pSub" style="display:flex;align-items:center;gap:5px;margin-top:2px;font-size:.68rem;color:var(--muted)">
            <div class="lspin"></div><span>Getting address...</span>
          </div>
        </div>
        <div onclick="refreshGPS()" style="font-size:.95rem;cursor:pointer;opacity:.55;padding:4px;flex-shrink:0">üîÑ</div>
      </div>
      <div class="lb">
        <div style="width:10px;height:10px;background:var(--red);border-radius:50%;flex-shrink:0"></div>
        <input type="text" id="dropIn" placeholder="Enter drop location (area or place name)"
          style="background:transparent;border:none;color:var(--text);width:100%;font-family:'DM Sans',sans-serif;font-weight:600;font-size:.87rem;outline:none"
          onkeydown="if(event.key==='Enter')calcFare()">
      </div>
    </div>
    <div id="homeErr" class="eb"></div>
    <button class="mbtn y" onclick="calcFare()">Find Driver üöó</button>
  </div>

  <!-- Fare -->
  <div class="scr" id="sFare">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:13px">
      <div style="font-family:'Syne',sans-serif;font-size:.98rem;font-weight:800">Select Ride</div>
      <span style="color:var(--red);font-weight:700;font-size:.83rem;cursor:pointer" onclick="goScr('sHome')">‚úï Back</span>
    </div>
    <div class="chips">
      <div class="chip"><div class="cv" id="cDist">--</div><div class="cl">KM</div></div>
      <div class="chip"><div class="cv" id="cETA">--</div><div class="cl">MINS</div></div>
      <div class="chip"><div class="cv" id="cZone">--</div><div class="cl">ZONE</div></div>
    </div>
    <div class="ro-card sel" id="optAuto" onclick="selRide(this,'JDP Auto','auto')">
      <div style="font-size:1.9rem">üõ∫</div>
      <div style="flex:1;margin-left:12px">
        <div style="font-weight:800;font-size:.95rem">JDP Auto</div>
        <div style="font-size:.7rem;color:var(--muted)">~3 min ‚Ä¢ 3 seater</div>
      </div>
      <div style="font-weight:900;font-size:1.2rem;font-family:'Syne',sans-serif">‚Çπ<span id="fAuto">--</span></div>
    </div>
    <div class="ro-card" id="optMini" onclick="selRide(this,'Mini Cab','cab')">
      <div style="font-size:1.9rem">üöó</div>
      <div style="flex:1;margin-left:12px">
        <div style="font-weight:800;font-size:.95rem">Mini Cab</div>
        <div style="font-size:.7rem;color:var(--muted)">~5 min ‚Ä¢ 4 seater</div>
      </div>
      <div style="font-weight:900;font-size:1.2rem;font-family:'Syne',sans-serif">‚Çπ<span id="fMini">--</span></div>
    </div>
    <button class="mbtn y" onclick="confirmBook()">Book <span id="bookBtnType">JDP Auto</span> ‚Üí</button>
  </div>

  <!-- Finding -->
  <div class="scr" id="sFind">
    <div class="rdr">
      <div class="rdr-rings"><div class="r1"></div><div class="r2"></div><div class="r3"></div><div class="r4"></div></div>
      <div style="font-family:'Syne',sans-serif;font-weight:900;font-size:1.08rem">Finding nearby drivers...</div>
      <div style="color:var(--muted);font-size:.78rem;margin-top:5px">Live request sent ‚Ä¢ waiting for driver</div>
      <div style="margin-top:14px;background:rgba(59,130,246,.08);border:1px solid rgba(59,130,246,.2);border-radius:11px;padding:10px">
        <div style="font-size:.7rem;color:var(--muted);font-weight:600;text-transform:uppercase;letter-spacing:.04em">Online Drivers Nearby</div>
        <div style="font-family:'Syne',sans-serif;font-weight:900;font-size:1.4rem;color:var(--blue);margin-top:3px" id="nearbyCount">--</div>
      </div>
      <button class="mbtn ro" style="max-width:180px;margin:16px auto 0" onclick="cancelBook()">Cancel</button>
    </div>
  </div>

  <!-- Assigned -->
  <div class="scr" id="sAssigned">
    <div id="assignedBanner" style="background:rgba(16,185,129,.1);color:var(--green);padding:9px;border-radius:11px;text-align:center;font-weight:800;margin-bottom:13px;border:1px solid rgba(16,185,129,.25);font-size:.88rem">‚úÖ Driver Assigned!</div>
    <div class="dcard">
      <div class="dava">üë®üèΩ‚Äç‚úàÔ∏è</div>
      <div style="flex:1">
        <div style="font-family:'Syne',sans-serif;font-weight:900;font-size:1.02rem" id="aDName">--</div>
        <div style="font-size:.76rem;color:var(--muted);margin-top:2px" id="aVeh">--</div>
        <div style="font-size:.73rem;color:var(--yellow);font-weight:700;margin-top:2px">‚òÖ 4.8 Rating</div>
      </div>
      <div class="otp">
        <div style="font-size:.58rem;color:var(--muted);font-weight:700;letter-spacing:.04em;text-transform:uppercase">OTP</div>
        <div style="font-family:'Syne',sans-serif;font-weight:900;font-size:1.35rem;color:var(--yellow)" id="rideOTP">----</div>
      </div>
    </div>
    <div class="lbadge b" id="driverTrackBadge"><div class="lbd"></div><span id="driverTrackText">üöó Tracking driver on map...</span></div>
    <div class="lbadge g" id="geoStatus"><div class="lbd" style="background:var(--green);box-shadow:0 0 6px var(--green)"></div><span>Within service zone ¬∑ Jagdalpur</span></div>
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px">
      <button class="mbtn g" style="margin-top:0" onclick="locateMe()">üìç My Location</button>
      <button class="mbtn ro" style="margin-top:0" onclick="cancelRide()">Cancel Ride</button>
    </div>
  </div>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê DRIVER DASHBOARD ‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div id="dTopBar">
  <div class="d-nr">
    <div class="d-nm">üöñ <span id="dName">Driver</span></div>
    <div style="display:flex;align-items:center;gap:9px">
      <span style="font-size:.72rem;font-weight:700;color:rgba(255,255,255,.6)" id="onlineLbl">OFFLINE</span>
      <label class="tgsw">
        <input type="checkbox" id="onTog" onchange="toggleOnline()">
        <div class="tgtr"></div><div class="tgth"></div>
      </label>
    </div>
  </div>
</div>

<div id="dStats">
  <div class="dsr">
    <div class="dst"><div class="dsv" id="dsEarn">‚Çπ0</div><div class="dsl">Today</div></div>
    <div class="dst"><div class="dsv" id="dsRides">0</div><div class="dsl">Rides</div></div>
    <div class="dst"><div class="dsv" id="dsRating">5.0‚òÖ</div><div class="dsl">Rating</div></div>
    <div class="dst"><div class="dsv" id="dsTime">0h</div><div class="dsl">Online</div></div>
  </div>
</div>

<div id="dPanel">
  <!-- Offline -->
  <div id="dOff">
    <div style="font-size:2.6rem;margin-bottom:9px">üò¥</div>
    <div style="font-family:'Syne',sans-serif;font-weight:900;font-size:1.1rem;margin-bottom:5px">You are Offline</div>
    <div style="font-size:.8rem;color:var(--muted);margin-bottom:16px">Go online to receive real ride requests</div>
    <button class="mbtn g" onclick="document.getElementById('onTog').checked=true;toggleOnline()">üü¢ Go Online & Start Earning</button>
  </div>

  <!-- Online -->
  <div id="dOn">
    <div class="opulse">
      <div class="odpulse"></div>
      <div>
        <div style="font-weight:700;font-size:.88rem">You're Online ‚Äî Waiting for Rides</div>
        <div style="font-size:.7rem;color:var(--muted);margin-top:1px" id="dLocText">Sharing your location...</div>
      </div>
    </div>
    <div class="lbadge g"><div class="lbd" style="background:var(--green);box-shadow:0 0 6px var(--green)"></div><span id="dZoneText">In Service Zone ¬∑ Jagdalpur</span></div>
    <div style="font-size:.72rem;color:var(--muted);text-align:center;margin-top:4px">üì° Firebase listening for new ride requests</div>
  </div>

  <!-- Navigation -->
  <div id="dNav">
    <div style="font-family:'Syne',sans-serif;font-weight:800;font-size:.85rem;margin-bottom:11px;color:var(--muted);text-transform:uppercase;letter-spacing:.04em" id="navLabel">üîµ Going to Pickup</div>
    <div class="nstep bl" id="navPickup">
      <div class="nicon">üìç</div>
      <div style="flex:1;min-width:0">
        <div style="font-size:.64rem;color:var(--muted);font-weight:700;text-transform:uppercase;letter-spacing:.04em">PICKUP</div>
        <div style="font-weight:700;font-size:.87rem;margin-top:2px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis" id="navPA">--</div>
      </div>
      <div style="text-align:right;flex-shrink:0">
        <div style="font-family:'Syne',sans-serif;font-weight:800;color:var(--blue);font-size:.9rem" id="navPDist">--</div>
        <div style="font-size:.62rem;color:var(--muted)" id="navPETA">--</div>
      </div>
    </div>
    <div class="nstep gr" id="navDrop">
      <div class="nicon">üèÅ</div>
      <div style="flex:1;min-width:0">
        <div style="font-size:.64rem;color:var(--muted);font-weight:700;text-transform:uppercase;letter-spacing:.04em">DROP</div>
        <div style="font-weight:700;font-size:.87rem;margin-top:2px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis" id="navDA">--</div>
      </div>
      <div style="text-align:right;flex-shrink:0">
        <div style="font-family:'Syne',sans-serif;font-weight:800;color:var(--green);font-size:.9rem" id="navFare">‚Çπ--</div>
        <div style="font-size:.62rem;color:var(--muted)">Fare</div>
      </div>
    </div>
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-top:9px">
      <button class="mbtn g" style="margin-top:0" id="navActBtn" onclick="driverNext()">‚úÖ Rider Picked Up</button>
      <button class="mbtn ro" style="margin-top:0" onclick="driverCancel()">Cancel</button>
    </div>
  </div>
</div>

<!-- RIDE REQUEST POPUP -->
<div id="reqPopup">
  <div class="rpc">
    <div style="text-align:center;font-family:'Syne',sans-serif;font-weight:900;font-size:.97rem;margin-bottom:2px">üîî New Ride Request!</div>
    <div class="rtring">
      <svg class="rtsvg" width="60" height="60" viewBox="0 0 60 60">
        <circle class="rtcbg" cx="30" cy="30" r="26"/>
        <circle class="rtc" id="tCircle" cx="30" cy="30" r="26"/>
      </svg>
      <div class="rtn" id="tNum">20</div>
    </div>
    <div style="display:flex;gap:8px;margin-bottom:3px">
      <div style="flex:1;text-align:center;background:rgba(255,255,255,.04);border:1px solid var(--border);border-radius:10px;padding:9px">
        <div style="font-family:'Syne',sans-serif;font-weight:900;font-size:1.05rem;color:var(--yellow)" id="reqFare">‚Çπ--</div>
        <div style="font-size:.58rem;color:var(--muted);font-weight:600;margin-top:1px">FARE</div>
      </div>
      <div style="flex:1;text-align:center;background:rgba(255,255,255,.04);border:1px solid var(--border);border-radius:10px;padding:9px">
        <div style="font-family:'Syne',sans-serif;font-weight:800;font-size:1.05rem" id="reqDist">-- km</div>
        <div style="font-size:.58rem;color:var(--muted);font-weight:600;margin-top:1px">DIST</div>
      </div>
      <div style="flex:1;text-align:center;background:rgba(255,255,255,.04);border:1px solid var(--border);border-radius:10px;padding:9px">
        <div style="font-family:'Syne',sans-serif;font-weight:800;font-size:1.05rem" id="reqETA">-- min</div>
        <div style="font-size:.58rem;color:var(--muted);font-weight:600;margin-top:1px">ETA</div>
      </div>
    </div>
    <div class="trip-row">
      <div class="tdots"><div class="tdg"></div><div class="tdl"></div><div class="tdr"></div></div>
      <div class="tadd">
        <div class="ta-row"><div class="ta-lbl">Pickup</div><div class="ta-val" id="reqPick">--</div></div>
        <div class="ta-row"><div class="ta-lbl">Drop</div><div class="ta-val" id="reqDrop">--</div></div>
      </div>
    </div>
    <div class="req-btns">
      <button class="mbtn ro" style="margin-top:0" onclick="declineReq()">Decline</button>
      <button class="mbtn g" style="margin-top:0" onclick="acceptReq()">‚úÖ Accept Ride</button>
    </div>
  </div>
</div>

<!-- NET -->
<div class="netb" id="netB">‚ö†Ô∏è No Internet</div>

<!-- ‚úÖ FIREBASE ‚Äî Same config, no change needed -->
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
import { getFirestore, doc, setDoc, getDoc, getDocs, collection, addDoc, updateDoc, deleteDoc, onSnapshot, query, where, orderBy, limit, serverTimestamp, GeoPoint } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

const cfg = {
  apiKey:"AIzaSyBRPV3mosWr3YFnW6xCfJaqC1bV4MhJm_Y",
  authDomain:"jdpcabs.firebaseapp.com",
  projectId:"jdpcabs",
  storageBucket:"jdpcabs.firebasestorage.app",
  messagingSenderId:"148264332732",
  appId:"1:148264332732:web:eed512ac4e685cef97cfb9"
};

try {
  const fbApp = initializeApp(cfg);
  const auth = getAuth(fbApp);
  const db = getFirestore(fbApp);
  window.FB = { auth, db, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, onAuthStateChanged, doc, setDoc, getDoc, getDocs, collection, addDoc, updateDoc, deleteDoc, onSnapshot, query, where, orderBy, limit, serverTimestamp, GeoPoint };
  window.FB_READY = true;
  document.getElementById('fbBadge').className = 'fbb ok';
  document.getElementById('fbBadge').textContent = '‚úÖ Firebase Live';
  document.getElementById('ldStatus').textContent = 'Firebase connected ‚úÖ';
} catch(e) {
  window.FB_READY = false;
  document.getElementById('fbBadge').className = 'fbb er';
  document.getElementById('fbBadge').textContent = '‚ùå Firebase Error';
}
</script>

<script>
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// CONFIG
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const JDPC = { lat: 19.0760, lng: 82.0150 }; // Jagdalpur center
const GEO_RADIUS = 12; // km service zone

// ‚úÖ FREE APIs ‚Äî No API key needed!
// Map: Leaflet.js + OpenStreetMap (CartoDB Dark for Uber look)
// Routing: OSRM ‚Äî Real road distance
// Geocode: Nominatim ‚Äî OpenStreetMap geocoder

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// STATE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let CU = null;
let authRole = 'rider';
let selVehType = 'auto';
let isLoaded = false;

// Map
let leafMap = null;
let routePolyline = null;

// Markers
let myMarker = null, pickupMk = null, dropMk = null, driverMk = null, geoCircle = null;
let prevDriverLat = null, prevDriverLng = null;
let driverMarkerInterval = null;

// GPS
let watchId = null;
let myLat = null, myLng = null;
let pickLat = null, pickLng = null, pickAddr = '';

// Fare
let fareA = 0, fareM = 0, distKM = 0;
let cabType = 'JDP Auto', cabFare = 0;

// Booking
let rideDocId = null;
let rideListener = null;
let driverLocListener = null;

// Driver
let isOnline = false;
let newRideListener = null;
let curReqId = null, curReqData = null;
let navPhase = 'pickup';
let dEarnings = 0, dRides = 0;
let onlineStart = null;
let reqTimer = 20, reqInterval = null;

// Cache
const routeCache = {};

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// ‚úÖ AUDIO ‚Äî Web Audio API (no external files needed)
// Uber-style notification sound
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let audioCtx = null;

function getAudioCtx() {
  if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
  return audioCtx;
}

function playTone(freq, startTime, duration, type='sine', vol=0.4) {
  try {
    const ctx = getAudioCtx();
    const osc = ctx.createOscillator();
    const gain = ctx.createGain();
    osc.connect(gain);
    gain.connect(ctx.destination);
    osc.type = type;
    osc.frequency.setValueAtTime(freq, ctx.currentTime + startTime);
    gain.gain.setValueAtTime(0, ctx.currentTime + startTime);
    gain.gain.linearRampToValueAtTime(vol, ctx.currentTime + startTime + 0.02);
    gain.gain.exponentialRampToValueAtTime(0.001, ctx.currentTime + startTime + duration);
    osc.start(ctx.currentTime + startTime);
    osc.stop(ctx.currentTime + startTime + duration);
  } catch(e) {}
}

// ‚úÖ Uber-like driver assigned sound (3 ascending tones)
function playDriverAssignedSound() {
  playTone(440, 0,    0.18, 'sine', 0.35);
  playTone(550, 0.2,  0.18, 'sine', 0.4);
  playTone(660, 0.4,  0.3,  'sine', 0.5);
  playTone(880, 0.75, 0.4,  'sine', 0.45);
}

// ‚úÖ New ride request alert for driver (urgent beep)
function playNewRideSound() {
  playTone(800, 0,   0.1, 'square', 0.3);
  playTone(800, 0.15,0.1, 'square', 0.3);
  playTone(1000,0.3, 0.15,'square', 0.35);
  playTone(1000,0.5, 0.2, 'square', 0.35);
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// LOADER
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let lp = 0;
const lpInt = setInterval(() => {
  if (lp < 85) { lp += 10; document.getElementById('ldBar').style.width = lp + '%'; }
}, 250);

function finishLoad() {
  if (isLoaded) return; isLoaded = true;
  clearInterval(lpInt);
  document.getElementById('ldBar').style.width = '100%';
  document.getElementById('ldStatus').textContent = 'Ready!';
  setTimeout(() => {
    document.getElementById('loader').style.display = 'none';
    if (!CU) document.getElementById('auth').style.display = 'flex';
    initMap();
  }, 400);
}

let fbWait = 0;
const fbWI = setInterval(() => { fbWait++; if (window.FB_READY !== undefined || fbWait > 25) { clearInterval(fbWI); finishLoad(); } }, 140);
setTimeout(finishLoad, 4000);

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// NET
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
window.addEventListener('offline', () => document.getElementById('netB').style.display = 'block');
window.addEventListener('online', () => { document.getElementById('netB').style.display = 'none'; toast('üåê Back online!'); });

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// ‚úÖ MAP ‚Äî Leaflet.js with CartoDB Dark Tiles (Uber look)
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function initMap() {
  if (typeof L === 'undefined') { setTimeout(initMap, 500); return; }
  try {
    leafMap = L.map('map', {
      center: [JDPC.lat, JDPC.lng],
      zoom: 14,
      zoomControl: false,
      attributionControl: true
    });

    // ‚úÖ CartoDB Dark Matter tiles ‚Äî Free, Uber-like dark map
    L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
      attribution: '¬© OpenStreetMap contributors ¬© CARTO',
      subdomains: 'abcd',
      maxZoom: 19
    }).addTo(leafMap);

    document.getElementById('ldStatus').textContent = '‚úÖ Map loaded (OpenStreetMap)';
  } catch(e) {
    setTimeout(initMap, 1200);
  }
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// ‚úÖ REVERSE GEOCODE ‚Äî Nominatim (OpenStreetMap) FREE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
async function revGeo(lat, lng) {
  try {
    const r = await fetch(
      `https://nominatim.openstreetmap.org/reverse?lat=${lat}&lon=${lng}&format=json&zoom=16&addressdetails=1`,
      { headers: { 'Accept-Language': 'en', 'User-Agent': 'JDPCabsApp/1.0' } }
    );
    const d = await r.json();
    if (d?.address) {
      const a = d.address;
      const parts = [
        a.neighbourhood || a.suburb || a.quarter,
        a.town || a.city || a.village || a.county,
        a.state_district
      ].filter(Boolean);
      return parts.length ? parts.join(', ') : (d.display_name?.split(',').slice(0,3).join(',') || `${lat.toFixed(4)},${lng.toFixed(4)}`);
    }
  } catch(e) {}
  return `${lat.toFixed(4)}, ${lng.toFixed(4)}`;
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// ‚úÖ GEOCODE address ‚Üí coordinates (Nominatim)
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
async function geocodeAddress(address) {
  try {
    const q = encodeURIComponent(address + ', Jagdalpur, Chhattisgarh, India');
    const r = await fetch(
      `https://nominatim.openstreetmap.org/search?q=${q}&format=json&limit=1&addressdetails=1`,
      { headers: { 'Accept-Language': 'en', 'User-Agent': 'JDPCabsApp/1.0' } }
    );
    const d = await r.json();
    if (d?.[0]) return { lat: parseFloat(d[0].lat), lng: parseFloat(d[0].lon) };
  } catch(e) {}
  return null;
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// ‚úÖ REAL ROAD DISTANCE ‚Äî OSRM Free Routing API
// Returns: { distKM, durationMin, geometry }
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
async function getOSRMRoute(fromLat, fromLng, toLat, toLng) {
  try {
    const url = `https://router.project-osrm.org/route/v1/driving/${fromLng},${fromLat};${toLng},${toLat}?overview=full&geometries=geojson&steps=false`;
    const r = await fetch(url);
    const d = await r.json();
    if (d?.routes?.[0]) {
      const route = d.routes[0];
      return {
        distKM: parseFloat((route.distance / 1000).toFixed(1)),
        durationMin: Math.ceil(route.duration / 60),
        geometry: route.geometry
      };
    }
  } catch(e) {}
  return null;
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// ‚úÖ DRAW ROUTE on map (Leaflet polyline)
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function drawRoute(geometry, color = '#f59e0b') {
  if (!leafMap) return;
  clearRoute();
  if (geometry?.coordinates) {
    const latlngs = geometry.coordinates.map(c => [c[1], c[0]]);
    routePolyline = L.polyline(latlngs, {
      color,
      weight: 5,
      opacity: 0.85,
      smoothFactor: 1,
      lineJoin: 'round',
      lineCap: 'round'
    }).addTo(leafMap);
    leafMap.fitBounds(routePolyline.getBounds(), { padding: [60, 60] });
  }
}

function clearRoute() {
  if (routePolyline && leafMap) {
    leafMap.removeLayer(routePolyline);
    routePolyline = null;
  }
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// ‚úÖ LIVE GPS ‚Äî Auto Pickup + Continuous
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function startGPS() {
  if (!navigator.geolocation) { toast('GPS not available'); return; }
  if (watchId) navigator.geolocation.clearWatch(watchId);

  watchId = navigator.geolocation.watchPosition(
    async (pos) => {
      myLat = pos.coords.latitude;
      myLng = pos.coords.longitude;
      pickLat = myLat; pickLng = myLng;
      updateMyMarker(myLat, myLng);

      // Driver GPS ‚Üí Firebase
      if (CU?.role === 'driver' && isOnline && window.FB_READY) {
        try {
          await window.FB.updateDoc(window.FB.doc(window.FB.db, 'users', CU.uid), {
            lat: myLat, lng: myLng, lastSeen: window.FB.serverTimestamp()
          });
          document.getElementById('dLocText').textContent =
            `üìç ${myLat.toFixed(4)}, ${myLng.toFixed(4)}`;
          const inZone = distKmCalc(myLat, myLng, JDPC.lat, JDPC.lng) <= GEO_RADIUS;
          document.getElementById('dZoneText').textContent = inZone ? '‚úÖ In Service Zone ¬∑ Jagdalpur' : '‚ö†Ô∏è Outside Zone';
          document.getElementById('dZoneText').style.color = inZone ? 'var(--green)' : 'var(--red)';
        } catch(e) {}
      }
    },
    (err) => { if (err.code === 1) toast('üìç Allow location access'); },
    { enableHighAccuracy: true, timeout: 12000, maximumAge: 2000 }
  );

  // Initial position for pickup address
  navigator.geolocation.getCurrentPosition(async (pos) => {
    myLat = pos.coords.latitude;
    myLng = pos.coords.longitude;
    pickLat = myLat; pickLng = myLng;

    document.getElementById('pAddr').textContent = 'Getting address...';
    const addr = await revGeo(myLat, myLng);
    pickAddr = addr;

    document.getElementById('pAddr').textContent = addr;
    document.getElementById('pSub').innerHTML =
      `<span style="color:var(--green);font-size:.66rem">üìç ${myLat.toFixed(5)}, ${myLng.toFixed(5)}</span>`;

    if (leafMap) { leafMap.setView([myLat, myLng], 16); }
    updateMyMarker(myLat, myLng);
    toast('üìç Location detected!');
  }, (err) => {
    document.getElementById('pAddr').textContent = 'Location unavailable';
    document.getElementById('pSub').innerHTML = '<span style="color:var(--red)">Enable GPS</span>';
  }, { enableHighAccuracy: true, timeout: 10000 });
}

function refreshGPS() {
  document.getElementById('pAddr').textContent = 'Refreshing...';
  document.getElementById('pSub').innerHTML = '<div class="lspin"></div><span>Getting location...</span>';
  startGPS();
}

// ‚úÖ My location marker ‚Äî Uber-style blue pulsing dot
function updateMyMarker(lat, lng) {
  if (!leafMap) return;
  const icon = L.divIcon({
    className: '',
    html: '<div class="my-loc-pin"><div class="my-loc-ring"></div><div class="my-loc-inner"></div></div>',
    iconSize: [22, 22],
    iconAnchor: [11, 11]
  });
  if (!myMarker) {
    myMarker = L.marker([lat, lng], { icon, zIndexOffset: 100 }).addTo(leafMap);
  } else {
    myMarker.setLatLng([lat, lng]);
  }
}

function locateMe() {
  if (leafMap && myLat) {
    leafMap.setView([myLat, myLng], 17, { animate: true });
  }
  refreshGPS();
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// ‚úÖ DRIVER MARKER ‚Äî Car emoji, smooth animation
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function startDriverTracking(driverId) {
  if (driverLocListener) { driverLocListener(); driverLocListener = null; }

  driverLocListener = window.FB.onSnapshot(
    window.FB.doc(window.FB.db, 'users', driverId),
    (snap) => {
      if (!snap.exists()) return;
      const d = snap.data();
      if (d.lat && d.lng) {
        moveDriverMarker(d.lat, d.lng, d.name || 'Driver');
        if (myLat) {
          const dist = distKmCalc(myLat, myLng, d.lat, d.lng);
          document.getElementById('driverTrackText').textContent =
            dist < 1
              ? `üöó Driver is ${(dist*1000).toFixed(0)}m away`
              : `üöó Driver is ${dist.toFixed(1)}km away`;
        }
      }
    }
  );
}

function moveDriverMarker(lat, lng, name) {
  if (!leafMap) return;

  const carIcon = L.divIcon({
    className: '',
    html: '<div class="car-marker">üöñ</div>',
    iconSize: [36, 36],
    iconAnchor: [18, 18]
  });

  if (!driverMk) {
    driverMk = L.marker([lat, lng], { icon: carIcon, zIndexOffset: 200 })
      .addTo(leafMap)
      .bindPopup(`<b>üöñ ${name}</b><br>Driver on the way!`);
  } else {
    // Smooth animated movement
    animateMarkerLeaflet(driverMk, [prevDriverLat || lat, prevDriverLng || lng], [lat, lng]);
  }
  prevDriverLat = lat;
  prevDriverLng = lng;
}

function animateMarkerLeaflet(marker, from, to) {
  let step = 0;
  const steps = 25;
  if (driverMarkerInterval) clearInterval(driverMarkerInterval);
  driverMarkerInterval = setInterval(() => {
    step++;
    const t = step / steps;
    // Ease-out curve
    const ease = 1 - Math.pow(1 - t, 3);
    const lat = from[0] + (to[0] - from[0]) * ease;
    const lng = from[1] + (to[1] - from[1]) * ease;
    try { marker.setLatLng([lat, lng]); } catch(e) {}
    if (step >= steps) clearInterval(driverMarkerInterval);
  }, 20);
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// ZONE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let zoneOn = false;
function toggleZone() {
  zoneOn = !zoneOn;
  if (zoneOn) {
    if (!leafMap) { toast('Map not ready'); return; }
    if (geoCircle) { leafMap.removeLayer(geoCircle); }
    geoCircle = L.circle([JDPC.lat, JDPC.lng], {
      radius: GEO_RADIUS * 1000,
      color: '#3b82f6',
      fillColor: '#3b82f6',
      fillOpacity: 0.06,
      weight: 2,
      opacity: 0.4
    }).addTo(leafMap);
    document.getElementById('zoneBtn').style.color = 'var(--green)';
    toast('üì° Service zone: 12km radius');
  } else {
    if (geoCircle && leafMap) { leafMap.removeLayer(geoCircle); geoCircle = null; }
    document.getElementById('zoneBtn').style.color = '';
    toast('üì° Zone hidden');
  }
}

function distKmCalc(la1, ln1, la2, ln2) {
  const R = 6371, dL = (la2-la1)*Math.PI/180, dN = (ln2-ln1)*Math.PI/180;
  const a = Math.sin(dL/2)**2 + Math.cos(la1*Math.PI/180)*Math.cos(la2*Math.PI/180)*Math.sin(dN/2)**2;
  return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// AUTH
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function setRole(r) {
  authRole = r;
  document.getElementById('rTab').className = 'rtab' + (r==='rider'?' ar':'');
  document.getElementById('dTab').className = 'rtab' + (r==='driver'?' ad':'');
  setTab(document.getElementById('loginTab').classList.contains('on') ? 'login' : 'register');
}

function setTab(t) {
  document.getElementById('loginTab').className = 'atab'+(t==='login'?' on':'');
  document.getElementById('regTab').className = 'atab'+(t==='register'?' on':'');
  ['loginForm','rRegForm','dRegForm'].forEach(id => document.getElementById(id).classList.remove('sh'));
  if (t==='login') document.getElementById('loginForm').classList.add('sh');
  if (t==='register'&&authRole==='rider') document.getElementById('rRegForm').classList.add('sh');
  if (t==='register'&&authRole==='driver') document.getElementById('dRegForm').classList.add('sh');
}

function selVeh(type) {
  selVehType = type;
  document.getElementById('vAuto').classList.toggle('on', type==='auto');
  document.getElementById('vCab').classList.toggle('on', type==='cab');
}

function showErr(id, msg) {
  const el = document.getElementById(id);
  el.textContent = '‚ö†Ô∏è '+msg; el.style.display = 'block';
  setTimeout(() => el.style.display='none', 4000);
}

async function doLogin() {
  if (!window.FB_READY) return toast('Firebase not ready');
  const id=document.getElementById('lId').value.trim(), pw=document.getElementById('lPass').value;
  if (!id||!pw) return showErr('loginErr','Enter mobile and password');
  if (id.length!==10) return showErr('loginErr','Enter valid 10-digit mobile');
  try {
    const c = await window.FB.signInWithEmailAndPassword(window.FB.auth, id+'@jdpcabs.in', pw);
    const s = await window.FB.getDoc(window.FB.doc(window.FB.db,'users',c.user.uid));
    if (s.exists()) { CU={uid:c.user.uid,...s.data()}; launch(); }
    else showErr('loginErr','Account not found. Register first.');
  } catch(e) {
    showErr('loginErr',
      e.code==='auth/wrong-password'?'Wrong password':
      e.code==='auth/user-not-found'?'Not registered. Please register.':
      e.code==='auth/network-request-failed'?'No internet':'Login failed.');
  }
}

async function doRiderReg() {
  if (!window.FB_READY) return toast('Firebase not ready');
  const fn=document.getElementById('rFn').value.trim(), ph=document.getElementById('rPh').value.trim(), pw=document.getElementById('rPw').value;
  if (!fn||!ph||!pw) return showErr('rRegErr','Fill all fields');
  if (ph.length!==10) return showErr('rRegErr','Valid 10-digit mobile required');
  if (pw.length<6) return showErr('rRegErr','Password min 6 characters');
  try {
    const c = await window.FB.createUserWithEmailAndPassword(window.FB.auth, ph+'@jdpcabs.in', pw);
    const ud = {name:fn, phone:ph, role:'rider', createdAt:window.FB.serverTimestamp()};
    await window.FB.setDoc(window.FB.doc(window.FB.db,'users',c.user.uid), ud);
    CU={uid:c.user.uid,...ud}; launch();
  } catch(e) { showErr('rRegErr', e.code==='auth/email-already-in-use'?'Mobile already registered. Login.':'Registration failed.'); }
}

async function doDriverReg() {
  if (!window.FB_READY) return toast('Firebase not ready');
  const fn=document.getElementById('dFn').value.trim(), ph=document.getElementById('dPh').value.trim();
  const veh=document.getElementById('dVeh').value.trim().toUpperCase(), pw=document.getElementById('dPw').value;
  if (!fn||!ph||!veh||!pw) return showErr('dRegErr','Fill all fields');
  if (ph.length!==10) return showErr('dRegErr','Valid 10-digit mobile required');
  if (pw.length<6) return showErr('dRegErr','Password min 6 chars');
  if (veh.length<5) return showErr('dRegErr','Valid vehicle number required');
  try {
    const c = await window.FB.createUserWithEmailAndPassword(window.FB.auth, ph+'@jdpcabs.in', pw);
    const ud = {name:fn, phone:ph, role:'driver', vehicleNo:veh, vehicleType:selVehType, rating:5.0, isOnline:false, earnings:0, ridesCompleted:0, createdAt:window.FB.serverTimestamp()};
    await window.FB.setDoc(window.FB.doc(window.FB.db,'users',c.user.uid), ud);
    CU={uid:c.user.uid,...ud}; launch();
  } catch(e) { showErr('dRegErr', e.code==='auth/email-already-in-use'?'Mobile already registered. Login.':'Registration failed.'); }
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// LAUNCH
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function launch() {
  document.getElementById('auth').style.display = 'none';
  setTimeout(() => { if (leafMap) leafMap.invalidateSize(); }, 300);
  if (CU?.role === 'driver') launchDriver();
  else launchRider();
  startGPS();
}

function launchRider() {
  document.getElementById('rTop').style.display = 'flex';
  document.getElementById('rSheet').style.display = 'block';
  document.getElementById('locBtn').style.display = 'flex';
  if (CU) document.getElementById('riderName').textContent = CU.name?.toUpperCase() || 'RIDER';
}

function launchDriver() {
  document.getElementById('dTopBar').style.display = 'block';
  document.getElementById('dStats').style.display = 'block';
  document.getElementById('dPanel').style.display = 'block';
  document.getElementById('locBtn').style.display = 'flex';
  document.getElementById('locBtn').style.bottom = '250px';
  if (CU) document.getElementById('dName').textContent = CU.name;
  dEarnings = CU.earnings || 0;
  dRides = CU.ridesCompleted || 0;
  updateDStats();
  showDCard('off');
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// DRIVER ONLINE/OFFLINE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
async function toggleOnline() {
  isOnline = document.getElementById('onTog').checked;
  document.getElementById('onlineLbl').textContent = isOnline ? 'ONLINE' : 'OFFLINE';
  document.getElementById('onlineLbl').style.color = isOnline ? '#10b981' : 'rgba(255,255,255,.55)';

  if (isOnline) {
    onlineStart = Date.now();
    showDCard('on');
    toast('üü¢ You are online! Listening for rides...');
    setInterval(updateOnlineTime, 60000);
    if (window.FB_READY && CU) {
      try { await window.FB.updateDoc(window.FB.doc(window.FB.db,'users',CU.uid), {isOnline:true, lat:myLat||JDPC.lat, lng:myLng||JDPC.lng}); } catch(e){}
    }
    startListeningForRides();
  } else {
    stopListeningForRides();
    showDCard('off');
    toast('üî¥ You are offline');
    if (window.FB_READY && CU) {
      try { await window.FB.updateDoc(window.FB.doc(window.FB.db,'users',CU.uid), {isOnline:false}); } catch(e){}
    }
  }
}

function startListeningForRides() {
  if (!window.FB_READY) return;
  stopListeningForRides();
  const q = window.FB.query(
    window.FB.collection(window.FB.db, 'rides'),
    window.FB.where('status','==','finding')
  );
  newRideListener = window.FB.onSnapshot(q, (snapshot) => {
    snapshot.docChanges().forEach(change => {
      if (change.type === 'added' && isOnline && !curReqId) {
        curReqId = change.doc.id;
        curReqData = { id: curReqId, ...change.doc.data() };
        showReqPopup(curReqData);
        playNewRideSound(); // ‚úÖ Alert sound for driver
      }
    });
  });
}

function stopListeningForRides() {
  if (newRideListener) { newRideListener(); newRideListener = null; }
}

function showDCard(type) {
  document.getElementById('dOff').style.display = type==='off'?'block':'none';
  document.getElementById('dOn').style.display = type==='on'?'block':'none';
  document.getElementById('dNav').style.display = type==='nav'?'block':'none';
}

function updateDStats() {
  document.getElementById('dsEarn').textContent = '‚Çπ'+dEarnings;
  document.getElementById('dsRides').textContent = dRides;
}

function updateOnlineTime() {
  if (!onlineStart) return;
  document.getElementById('dsTime').textContent = ((Date.now()-onlineStart)/3600000).toFixed(1)+'h';
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// RIDE REQUEST POPUP
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function showReqPopup(data) {
  document.getElementById('reqFare').textContent = '‚Çπ'+(data.fare||'--');
  document.getElementById('reqDist').textContent = (data.distanceKM||'--')+' km';
  document.getElementById('reqETA').textContent = (data.etaMin||'--')+' min';
  document.getElementById('reqPick').textContent = data.pickup||'--';
  document.getElementById('reqDrop').textContent = data.drop||'--';
  document.getElementById('reqPopup').classList.add('sh');

  reqTimer = 20;
  document.getElementById('tNum').textContent = reqTimer;
  const circ = document.getElementById('tCircle');
  circ.style.stroke = 'var(--yellow)';
  document.getElementById('tNum').style.color = 'var(--yellow)';
  circ.style.strokeDashoffset = '0';

  if (reqInterval) clearInterval(reqInterval);
  reqInterval = setInterval(() => {
    reqTimer--;
    document.getElementById('tNum').textContent = reqTimer;
    circ.style.strokeDashoffset = 163*(1-reqTimer/20);
    if (reqTimer <= 5) { circ.style.stroke='var(--red)'; document.getElementById('tNum').style.color='var(--red)'; }
    if (reqTimer <= 0) {
      clearInterval(reqInterval);
      hideReqPopup();
      curReqId = null; curReqData = null;
      toast('‚è∞ Request expired');
    }
  }, 1000);
}

function hideReqPopup() {
  document.getElementById('reqPopup').classList.remove('sh');
  if (reqInterval) clearInterval(reqInterval);
}

async function acceptReq() {
  if (!curReqData) return;
  clearInterval(reqInterval);
  hideReqPopup();
  stopListeningForRides();
  const data = curReqData;
  navPhase = 'pickup';

  if (window.FB_READY) {
    try {
      const otp = Math.floor(1000+Math.random()*9000);
      await window.FB.updateDoc(window.FB.doc(window.FB.db,'rides',data.id), {
        status: 'assigned',
        driverId: CU.uid,
        driverName: CU.name,
        driverPhone: CU.phone,
        driverVehicle: CU.vehicleNo,
        driverVehicleType: CU.vehicleType,
        otp,
        acceptedAt: window.FB.serverTimestamp()
      });
    } catch(e) { toast('‚ùå Accept failed'); return; }
  }

  document.getElementById('navLabel').textContent = 'üîµ Going to Pickup';
  document.getElementById('navPA').textContent = data.pickup||'--';
  document.getElementById('navDA').textContent = data.drop||'--';
  document.getElementById('navFare').textContent = '‚Çπ'+(data.fare||'--');
  document.getElementById('navPDist').textContent = (data.distanceKM||'--')+' km';
  document.getElementById('navPETA').textContent = (data.etaMin||'--')+' min';
  document.getElementById('navActBtn').textContent = '‚úÖ Rider Picked Up';
  document.getElementById('navPickup').style.opacity = '1';
  showDCard('nav');

  // ‚úÖ Draw route to pickup using OSRM
  if (leafMap && myLat && data.pickupLat) {
    const route = await getOSRMRoute(myLat, myLng, data.pickupLat, data.pickupLng);
    if (route) drawRoute(route.geometry, '#3b82f6');

    // Pickup marker
    if (pickupMk && leafMap) { leafMap.removeLayer(pickupMk); }
    const pickIcon = L.divIcon({
      className:'',
      html:'<div class="pickup-pin">üìç</div>',
      iconSize:[32,32],
      iconAnchor:[16,32]
    });
    pickupMk = L.marker([data.pickupLat, data.pickupLng], { icon: pickIcon })
      .addTo(leafMap)
      .bindPopup(`<b style="color:#10b981">üìç Pickup: ${data.pickup}</b>`);
  }

  toast('‚úÖ Ride accepted! Going to pickup');
}

function declineReq() {
  clearInterval(reqInterval);
  hideReqPopup();
  curReqId = null; curReqData = null;
  toast('Declined');
}

async function driverNext() {
  if (!curReqData) return;
  if (navPhase === 'pickup') {
    navPhase = 'drop';
    document.getElementById('navLabel').textContent = 'üü¢ Going to Drop';
    document.getElementById('navPickup').style.opacity = '0.45';
    document.getElementById('navActBtn').textContent = 'üèÅ Complete Trip';

    if (window.FB_READY && curReqData.id) {
      try { await window.FB.updateDoc(window.FB.doc(window.FB.db,'rides',curReqData.id), {status:'ongoing', pickedAt:window.FB.serverTimestamp()}); } catch(e){}
    }
    toast('Heading to drop! üöó');

    // ‚úÖ Route to drop using geocode + OSRM
    if (leafMap && myLat && curReqData.drop) {
      const dropCoords = await geocodeAddress(curReqData.drop);
      if (dropCoords) {
        const route = await getOSRMRoute(myLat, myLng, dropCoords.lat, dropCoords.lng);
        if (route) drawRoute(route.geometry, '#10b981');
        if (dropMk && leafMap) { leafMap.removeLayer(dropMk); }
        const dropIcon = L.divIcon({
          className:'',
          html:'<div class="drop-pin">üèÅ</div>',
          iconSize:[32,32],
          iconAnchor:[16,32]
        });
        dropMk = L.marker([dropCoords.lat, dropCoords.lng], { icon: dropIcon })
          .addTo(leafMap)
          .bindPopup(`<b style="color:#ef4444">üèÅ Drop: ${curReqData.drop}</b>`);
      }
    }
  } else {
    await completeTrip();
  }
}

async function completeTrip() {
  const data = curReqData;
  dEarnings += (data.fare||0);
  dRides += 1;
  updateDStats();

  if (window.FB_READY) {
    try {
      await window.FB.updateDoc(window.FB.doc(window.FB.db,'rides',data.id), {status:'completed', completedAt:window.FB.serverTimestamp()});
      await window.FB.updateDoc(window.FB.doc(window.FB.db,'users',CU.uid), {earnings:dEarnings, ridesCompleted:dRides});
    } catch(e){}
  }

  clearRoute();
  if (pickupMk && leafMap) { leafMap.removeLayer(pickupMk); pickupMk=null; }
  if (dropMk && leafMap) { leafMap.removeLayer(dropMk); dropMk=null; }
  curReqId=null; curReqData=null; navPhase='pickup';
  showDCard('on');
  toast(`üéâ Trip complete! ‚Çπ${data.fare} earned!`);
  if (isOnline) startListeningForRides();
}

async function driverCancel() {
  if (window.FB_READY && curReqData?.id) {
    try { await window.FB.updateDoc(window.FB.doc(window.FB.db,'rides',curReqData.id), {status:'cancelled_driver', cancelledAt:window.FB.serverTimestamp()}); } catch(e){}
  }
  clearRoute();
  curReqId=null; curReqData=null; navPhase='pickup';
  if (pickupMk && leafMap) { leafMap.removeLayer(pickupMk); pickupMk=null; }
  showDCard('on');
  toast('Ride cancelled');
  if (isOnline) startListeningForRides();
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// RIDER BOOKING FLOW
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function goScr(id) {
  document.querySelectorAll('.scr').forEach(e=>e.classList.remove('on'));
  document.getElementById(id).classList.add('on');
}

// ‚úÖ calcFare ‚Äî OSRM real road distance + Nominatim geocoding
async function calcFare() {
  const drop = document.getElementById('dropIn').value.trim();
  if (!drop) {
    const e=document.getElementById('homeErr');
    e.textContent='‚ö†Ô∏è Enter drop location (e.g. "Medical College", "Bus Stand")';
    e.style.display='block';
    setTimeout(()=>e.style.display='none',3000);
    return;
  }

  toast('üó∫Ô∏è Calculating real road distance...');

  const origin = pickLat ? `${pickLat},${pickLng}` : `${JDPC.lat},${JDPC.lng}`;
  const cKey = `${origin}_${drop}`;
  if (routeCache[cKey]) { applyRoute(routeCache[cKey], drop); return; }

  // Step 1: Geocode drop location
  const dropCoords = await geocodeAddress(drop);

  if (dropCoords) {
    // Step 2: Get real road route from OSRM
    const fromLat = pickLat || JDPC.lat;
    const fromLng = pickLng || JDPC.lng;
    const route = await getOSRMRoute(fromLat, fromLng, dropCoords.lat, dropCoords.lng);

    if (route) {
      routeCache[cKey] = { route, dropCoords };
      applyRoute({ route, dropCoords }, drop);
      return;
    }
  }

  // Fallback: straight-line estimate if geocode/OSRM fails
  useFallback(drop);
}

function applyRoute({ route, dropCoords }, drop) {
  distKM = route.distKM;
  const eta = route.durationMin;
  fareA = Math.max(25, Math.round(20 + distKM * 12));
  fareM = Math.max(50, Math.round(40 + distKM * 16));

  document.getElementById('cDist').textContent = distKM;
  document.getElementById('cETA').textContent = eta;
  document.getElementById('cZone').textContent = distKM <= 3 ? 'City' : distKM <= 6 ? 'Near' : 'Far';
  document.getElementById('fAuto').textContent = fareA;
  document.getElementById('fMini').textContent = fareM;
  cabType='JDP Auto'; cabFare=fareA;
  document.getElementById('bookBtnType').textContent='JDP Auto';
  document.getElementById('optAuto').classList.add('sel');
  document.getElementById('optMini').classList.remove('sel');

  // ‚úÖ Draw route on map
  if (route.geometry) drawRoute(route.geometry, '#f59e0b');

  // Place markers
  if (leafMap) {
    if (pickLat) {
      if (pickupMk) leafMap.removeLayer(pickupMk);
      const pickIcon = L.divIcon({ className:'', html:'<div class="pickup-pin">üìç</div>', iconSize:[32,32], iconAnchor:[16,32] });
      pickupMk = L.marker([pickLat, pickLng], { icon: pickIcon })
        .addTo(leafMap).bindPopup('<b style="color:#10b981">üìç Your Pickup</b>');
    }
    if (dropCoords) {
      if (dropMk) leafMap.removeLayer(dropMk);
      const dropIcon = L.divIcon({ className:'', html:'<div class="drop-pin">üèÅ</div>', iconSize:[32,32], iconAnchor:[16,32] });
      dropMk = L.marker([dropCoords.lat, dropCoords.lng], { icon: dropIcon })
        .addTo(leafMap).bindPopup(`<b style="color:#ef4444">üèÅ ${drop}</b>`);
    }
  }

  goScr('sFare');
}

function useFallback(drop) {
  // Estimate based on straight-line + 1.3x road factor
  let straightDist = 3;
  if (pickLat) {
    straightDist = distKmCalc(pickLat, pickLng, JDPC.lat, JDPC.lng);
    if (straightDist < 1) straightDist = 2 + Math.random() * 3;
  } else {
    straightDist = 2 + Math.random() * 4;
  }
  const d = parseFloat((straightDist * 1.3).toFixed(1));
  distKM = d;
  fareA = Math.max(25, Math.round(20+d*12));
  fareM = Math.max(50, Math.round(40+d*16));
  document.getElementById('cDist').textContent = d+'*';
  document.getElementById('cETA').textContent = Math.ceil(d*3)+'*';
  document.getElementById('cZone').textContent = 'Jagdalpur';
  document.getElementById('fAuto').textContent = fareA;
  document.getElementById('fMini').textContent = fareM;
  cabType='JDP Auto'; cabFare=fareA;
  document.getElementById('bookBtnType').textContent='JDP Auto';
  document.getElementById('optAuto').classList.add('sel');
  document.getElementById('optMini').classList.remove('sel');
  toast('‚ö†Ô∏è Estimated distance (* = approximate)');
  goScr('sFare');
}

function selRide(el, type, vk) {
  document.querySelectorAll('.ro-card').forEach(e=>e.classList.remove('sel'));
  el.classList.add('sel');
  cabType=type; cabFare=vk==='auto'?fareA:fareM;
  document.getElementById('bookBtnType').textContent=type;
}

// ‚úÖ REAL BOOKING ‚Äî Firebase
async function confirmBook() {
  goScr('sFind');

  let nearbyCount = 0;
  if (window.FB_READY) {
    try {
      const q = window.FB.query(window.FB.collection(window.FB.db,'users'), window.FB.where('role','==','driver'), window.FB.where('isOnline','==',true));
      const snap = await window.FB.getDocs(q);
      nearbyCount = snap.size;
    } catch(e) {}
  }
  document.getElementById('nearbyCount').textContent = nearbyCount > 0 ? `${nearbyCount} driver${nearbyCount>1?'s':''} online` : 'Searching...';

  if (nearbyCount === 0) {
    setTimeout(() => {
      toast('‚ö†Ô∏è No drivers online right now. Try again later.');
      goScr('sHome');
    }, 4000);
    return;
  }

  const rideData = {
    riderId: CU?.uid || 'guest',
    riderName: CU?.name || 'Rider',
    riderPhone: CU?.phone || '',
    pickup: pickAddr || 'GPS Location',
    pickupLat: pickLat || JDPC.lat,
    pickupLng: pickLng || JDPC.lng,
    drop: document.getElementById('dropIn').value.trim(),
    cabType, fare: cabFare, distanceKM: distKM,
    etaMin: parseInt(document.getElementById('cETA').textContent) || 10,
    status: 'finding',
    createdAt: window.FB_READY ? window.FB.serverTimestamp() : new Date().toISOString()
  };

  try {
    if (window.FB_READY) {
      const ref = await window.FB.addDoc(window.FB.collection(window.FB.db,'rides'), rideData);
      rideDocId = ref.id;
      listenToRide(rideDocId);
    } else {
      setTimeout(() => { toast('‚ùå Firebase required for live booking'); goScr('sHome'); }, 3000);
    }
  } catch(e) {
    toast('‚ùå Booking failed. Check internet.'); goScr('sHome');
  }
}

// ‚úÖ Listen to ride status changes
function listenToRide(id) {
  if (rideListener) { rideListener(); rideListener=null; }

  rideListener = window.FB.onSnapshot(
    window.FB.doc(window.FB.db,'rides',id),
    (snap) => {
      if (!snap.exists()) return;
      const data = snap.data();

      if (data.status === 'assigned' && document.getElementById('sFind').classList.contains('on')) {
        document.getElementById('aDName').textContent = data.driverName||'--';
        document.getElementById('aVeh').textContent = `${data.driverVehicle||'--'} ‚Ä¢ ${data.cabType||'--'}`;
        document.getElementById('rideOTP').textContent = data.otp||'----';
        goScr('sAssigned');

        // ‚úÖ Play Uber-style music when driver assigned
        playDriverAssignedSound();

        // Animate banner
        const banner = document.getElementById('assignedBanner');
        banner.classList.add('assigned-anim');
        setTimeout(() => banner.classList.remove('assigned-anim'), 1500);

        toast('‚úÖ Driver accepted your ride!');
        if (data.driverId) startDriverTracking(data.driverId);
      }

      if (data.status === 'ongoing') {
        document.getElementById('driverTrackText').textContent = 'üöó Driver heading to your drop';
      }

      if (data.status === 'completed') {
        if (rideListener) { rideListener(); rideListener=null; }
        if (driverLocListener) { driverLocListener(); driverLocListener=null; }
        if (driverMk && leafMap) { leafMap.removeLayer(driverMk); driverMk=null; }
        clearRoute();
        document.getElementById('dropIn').value='';
        goScr('sHome');
        toast('üéâ Ride completed! Thank you!');
        rideDocId=null;
      }

      if (data.status === 'cancelled_driver') {
        if (rideListener) { rideListener(); rideListener=null; }
        goScr('sHome');
        toast('‚ùå Driver cancelled. Please rebook.');
        rideDocId=null;
      }
    }
  );
}

async function cancelBook() {
  if (rideDocId && window.FB_READY) {
    try { await window.FB.updateDoc(window.FB.doc(window.FB.db,'rides',rideDocId), {status:'cancelled',cancelledAt:window.FB.serverTimestamp()}); } catch(e){}
  }
  if (rideListener) { rideListener(); rideListener=null; }
  clearRoute();
  rideDocId=null;
  document.getElementById('nearbyCount').textContent='--';
  goScr('sHome');
  toast('Booking cancelled');
}

async function cancelRide() {
  if (rideDocId && window.FB_READY) {
    try { await window.FB.updateDoc(window.FB.doc(window.FB.db,'rides',rideDocId), {status:'cancelled',cancelledAt:window.FB.serverTimestamp()}); } catch(e){}
  }
  if (rideListener) { rideListener(); rideListener=null; }
  if (driverLocListener) { driverLocListener(); driverLocListener=null; }
  if (driverMk && leafMap) { leafMap.removeLayer(driverMk); driverMk=null; }
  if (dropMk && leafMap) { leafMap.removeLayer(dropMk); dropMk=null; }
  clearRoute();
  document.getElementById('dropIn').value='';
  rideDocId=null;
  goScr('sHome');
  toast('Ride cancelled');
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// THEME / LOGOUT
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function toggleTheme() {
  document.body.classList.toggle('lm');
  // ‚úÖ Switch map tiles based on theme
  if (leafMap) {
    leafMap.eachLayer(layer => {
      if (layer instanceof L.TileLayer) leafMap.removeLayer(layer);
    });
    if (document.body.classList.contains('lm')) {
      // Light theme ‚Äî standard OSM
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '¬© OpenStreetMap contributors',
        maxZoom: 19
      }).addTo(leafMap);
    } else {
      // Dark theme ‚Äî CartoDB dark
      L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
        attribution: '¬© OpenStreetMap contributors ¬© CARTO',
        subdomains: 'abcd',
        maxZoom: 19
      }).addTo(leafMap);
    }
    setTimeout(() => leafMap.invalidateSize(), 300);
  }
}

async function doLogout() {
  if (watchId) navigator.geolocation.clearWatch(watchId);
  if (rideListener) rideListener();
  if (driverLocListener) driverLocListener();
  if (newRideListener) newRideListener();
  clearRoute();
  if (window.FB_READY && CU?.role==='driver') {
    try { await window.FB.updateDoc(window.FB.doc(window.FB.db,'users',CU.uid),{isOnline:false}); } catch(e){}
  }
  if (window.FB_READY) { try { await window.FB.signOut(window.FB.auth); } catch(e){} }
  location.reload();
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// TOAST
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function toast(msg) {
  document.querySelectorAll('.toast').forEach(t=>t.remove());
  const el=document.createElement('div'); el.className='toast'; el.textContent=msg;
  document.body.appendChild(el);
  setTimeout(()=>el.remove(),3200);
}
</script>
</body>
</html>

<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>JDP CABS â€” Next Gen Mobility</title>
<link href="https://fonts.googleapis.com/css2?family=Syne:wght@400;600;700;800&family=DM+Sans:ital,opsz,wght@0,9..40,300;0,9..40,400;0,9..40,500;0,9..40,600;0,9..40,700;1,9..40,400&display=swap" rel="stylesheet">
<script>window.MAPPLS_KEY='4e97759ed6a3fb245e52f7e22d820954';</script>
<script src="https://apis.mappls.com/advancedmaps/api/4e97759ed6a3fb245e52f7e22d820954/map_sdk?v=3.0"></script>
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
  import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
  import { getFirestore, doc, setDoc, getDoc, collection, addDoc, updateDoc, onSnapshot, query, where, getDocs } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
  const firebaseConfig = {
    apiKey:"AIzaSyBRPV3mosWr3YFnW6xCfJaqC1bV4MhJm_Y", authDomain:"jdpcabs.firebaseapp.com",
    projectId:"jdpcabs", storageBucket:"jdpcabs.firebasestorage.app",
    messagingSenderId:"148264332732", appId:"1:148264332732:web:eed512ac4e685cef97cfb9"
  };
  const app = initializeApp(firebaseConfig);
  window.FB = {
    auth: getAuth(app), db: getFirestore(app),
    signIn: signInWithEmailAndPassword, create: createUserWithEmailAndPassword,
    onAuth: onAuthStateChanged, signOut,
    doc, setDoc, getDoc, collection, addDoc, updateDoc, onSnapshot, query, where, getDocs
  };
  window.addEventListener('load', () => {
    setTimeout(() => {
      if(window.FB && window.APP) {
        window.FB.onAuth(window.FB.auth, async (user) => {
          if(user) await window.APP.onLogin(user);
          else window.APP.onLogout();
        });
      }
    }, 800);
  });
</script>
<style>
/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   DESIGN SYSTEM: DARK NEON MOBILITY
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
:root {
  --bg:#070c14; --surface:#0e1623; --surface2:#141f32; --surface3:#1a2740;
  --border:rgba(255,255,255,0.055); --border-glow:rgba(0,210,255,0.28);
  --primary:#00d2ff; --primary-dim:rgba(0,210,255,0.1); --primary-glow:0 0 22px rgba(0,210,255,0.3);
  --purple:#7c3aed; --amber:#f59e0b; --green:#10b981; --red:#ef4444;
  --text:#eaf4ff; --muted:#5a7298; --sub:#8aa4c0;
  --r16:16px; --r20:20px; --r28:28px;
  --ease:cubic-bezier(0.22,1,0.36,1);
}
*{margin:0;padding:0;box-sizing:border-box;-webkit-tap-highlight-color:transparent}
body{background:var(--bg);color:var(--text);font-family:'DM Sans',system-ui,sans-serif;overflow:hidden;height:100vh;width:100vw}
.screen{position:absolute;inset:0;display:none;flex-direction:column;overflow:hidden}
.screen.active{display:flex}
#map{position:absolute;inset:0;z-index:1}
h1,h2,h3,.logo,.stat-val,.ride-name,.ride-price,.btn-primary,.badge-val{font-family:'Syne',sans-serif}

/* â”€â”€ BUTTONS â”€â”€ */
.btn{width:100%;padding:15px;border:none;border-radius:14px;font-family:'Syne',sans-serif;font-size:15px;font-weight:700;cursor:pointer;transition:all .2s var(--ease);letter-spacing:.3px}
.btn:active{transform:scale(.96)}
.btn-primary{background:linear-gradient(135deg,var(--primary),#0099bb);color:#000;box-shadow:var(--primary-glow)}
.btn-secondary{background:var(--surface3);color:var(--text);border:1px solid var(--border)}
.btn-danger{background:rgba(239,68,68,.12);color:var(--red);border:1px solid rgba(239,68,68,.25)}
.btn-success{background:linear-gradient(135deg,var(--green),#059669);color:#fff}
.btn-sm{padding:10px 16px;font-size:13px;width:auto;border-radius:10px}
.btn-icon{width:44px;height:44px;border-radius:12px;border:none;background:rgba(14,22,35,.88);backdrop-filter:blur(10px);border:1px solid var(--border);color:var(--text);font-size:18px;cursor:pointer;display:flex;align-items:center;justify-content:center;transition:all .2s;padding:0}
.btn-icon:active{transform:scale(.9);background:var(--surface2)}

/* â”€â”€ INPUTS â”€â”€ */
.iw{position:relative;margin-bottom:13px}
.iw .ico{position:absolute;left:14px;top:50%;transform:translateY(-50%);font-size:16px;color:var(--muted);pointer-events:none}
.inp{width:100%;padding:14px 14px 14px 44px;background:var(--surface2);border:1px solid var(--border);border-radius:12px;color:var(--text);font-family:'DM Sans',sans-serif;font-size:15px;outline:none;transition:all .2s}
.inp:focus{border-color:var(--primary);box-shadow:0 0 0 3px var(--primary-dim)}
.inp::placeholder{color:var(--muted)}
.inp-bare{background:transparent;border:none;outline:none;color:var(--text);font-family:'DM Sans',sans-serif;font-size:14px;width:100%}
.inp-bare::placeholder{color:var(--muted)}

/* â”€â”€ BADGES â”€â”€ */
.badge{display:inline-flex;align-items:center;gap:5px;padding:4px 10px;border-radius:99px;font-size:11px;font-weight:700;text-transform:uppercase;letter-spacing:.5px}
.b-green{background:rgba(16,185,129,.13);color:var(--green)}
.b-red{background:rgba(239,68,68,.13);color:var(--red)}
.b-cyan{background:var(--primary-dim);color:var(--primary)}
.b-amber{background:rgba(245,158,11,.13);color:var(--amber)}

/* â”€â”€ DIVIDER â”€â”€ */
.dvd{height:1px;background:var(--border);margin:14px 0}

/* â”€â”€ SCROLLBAR â”€â”€ */
::-webkit-scrollbar{width:3px}
::-webkit-scrollbar-thumb{background:var(--border);border-radius:3px}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   AUTH SCREEN
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
#authScreen{background:var(--bg);overflow-y:auto}
.auth-bg{position:absolute;inset:0;background:radial-gradient(ellipse at 25% 25%,rgba(124,58,237,.18) 0,transparent 55%),radial-gradient(ellipse at 75% 75%,rgba(0,210,255,.12) 0,transparent 55%);pointer-events:none}
.auth-wrap{position:relative;z-index:2;padding:55px 22px 30px;display:flex;flex-direction:column;min-height:100%}
.auth-logo{text-align:center;margin-bottom:38px}
.auth-logo .lico{font-size:52px;display:block;margin-bottom:10px;filter:drop-shadow(0 0 20px rgba(0,210,255,.5))}
.auth-logo h1{font-size:38px;font-weight:800;background:linear-gradient(135deg,var(--primary),#a78bfa);-webkit-background-clip:text;-webkit-text-fill-color:transparent;letter-spacing:-1px}
.auth-logo p{color:var(--muted);font-size:13px;margin-top:6px}
.auth-card{background:var(--surface);border:1px solid var(--border);border-radius:24px;padding:24px;margin-top:auto}
.role-tog{display:grid;grid-template-columns:1fr 1fr;background:var(--bg);border-radius:12px;padding:4px;margin-bottom:20px;border:1px solid var(--border)}
.role-btn{padding:10px;border:none;border-radius:9px;background:transparent;color:var(--muted);font-family:'Syne',sans-serif;font-size:13px;font-weight:700;cursor:pointer;transition:all .25s}
.role-btn.act{background:var(--primary);color:#000;box-shadow:var(--primary-glow)}
.atabs{display:flex;background:var(--bg);border-radius:10px;padding:3px;margin-bottom:20px;border:1px solid var(--border)}
.atab{flex:1;padding:9px;border:none;border-radius:8px;background:transparent;color:var(--muted);font-size:13px;font-weight:600;cursor:pointer;transition:all .2s;font-family:'DM Sans',sans-serif}
.atab.act{background:var(--surface3);color:var(--text)}
.auth-switch{text-align:center;color:var(--primary);font-size:14px;font-weight:600;cursor:pointer;margin-top:15px}
#authErr{background:rgba(239,68,68,.1);border:1px solid rgba(239,68,68,.3);border-radius:10px;padding:10px 14px;color:var(--red);font-size:13px;margin-bottom:13px;display:none}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   MAP SCREEN â€” TOP UI
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.topbar{position:absolute;top:0;left:0;right:0;z-index:50;padding:14px 16px;display:flex;align-items:center;justify-content:space-between;gap:10px}
.logo-pill{font-family:'Syne',sans-serif;font-size:17px;font-weight:800;color:var(--primary);text-shadow:0 0 20px rgba(0,210,255,.4);background:rgba(14,22,35,.9);backdrop-filter:blur(12px);padding:9px 18px;border-radius:99px;border:1px solid var(--border)}
#myLocBtn{position:absolute;right:16px;z-index:20;width:44px;height:44px;background:rgba(14,22,35,.9);backdrop-filter:blur(10px);border:1px solid var(--border);border-radius:12px;font-size:20px;cursor:pointer;display:flex;align-items:center;justify-content:center;box-shadow:0 4px 15px rgba(0,0,0,.3);color:var(--text);transition:all .2s}
#myLocBtn:active{transform:scale(.9)}
#sosBtn{position:absolute;right:16px;z-index:50;width:52px;height:52px;background:var(--red);border:none;border-radius:50%;color:#fff;font-size:11px;font-weight:800;font-family:'Syne',sans-serif;cursor:pointer;display:none;flex-direction:column;align-items:center;justify-content:center;line-height:1.2;animation:pulsered 2s infinite;gap:2px}
@keyframes pulsered{0%,100%{box-shadow:0 0 12px rgba(239,68,68,.5)}50%{box-shadow:0 0 28px rgba(239,68,68,.9)}}
#toast{position:absolute;top:78px;left:16px;right:16px;z-index:1000;background:var(--surface2);border:1px solid var(--border);border-radius:14px;padding:13px 16px;display:none;align-items:center;gap:11px;box-shadow:0 8px 30px rgba(0,0,0,.4);animation:slidedn .3s ease}
@keyframes slidedn{from{transform:translateY(-18px);opacity:0}to{transform:translateY(0);opacity:1}}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   RIDER BOTTOM SHEET
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
#riderSheet{position:absolute;bottom:0;left:0;right:0;background:var(--surface);border-radius:28px 28px 0 0;border-top:1px solid var(--border);z-index:40;height:82vh;transform:translateY(58%);transition:transform .38s var(--ease);display:none;flex-direction:column;overflow:hidden}
.dh{padding:14px 0 4px;display:flex;justify-content:center;cursor:grab;flex-shrink:0}
.db{width:40px;height:4px;background:var(--surface3);border-radius:4px}
.shin{flex:1;overflow-y:auto;padding:4px 20px 36px}
.shin::-webkit-scrollbar{display:none}

.greet{display:flex;align-items:center;justify-content:space-between;margin-bottom:16px}
.greet-t h2{font-size:21px;font-weight:800;letter-spacing:-.3px}
.greet-t p{font-size:12px;color:var(--muted);margin-top:3px}
.wallet-c{background:var(--primary-dim);border:1px solid var(--border-glow);border-radius:99px;padding:6px 13px;display:flex;align-items:center;gap:5px;font-size:13px;font-weight:700;color:var(--primary);cursor:pointer}

/* Location box */
.loc-box{background:var(--surface2);border:1px solid var(--border);border-radius:16px;padding:4px;margin-bottom:15px}
.loc-row{display:flex;align-items:center;padding:12px 13px;gap:12px;cursor:pointer;border-radius:12px;transition:all .15s}
.loc-row:active{background:var(--surface3)}
.ldot{width:10px;height:10px;border-radius:50%;flex-shrink:0}
.ldot.pick{background:var(--primary);box-shadow:0 0 8px var(--primary)}
.ldot.drop{background:var(--amber);box-shadow:0 0 8px var(--amber)}
.lloc{flex:1;min-width:0}
.lloc .lbl{font-size:11px;color:var(--muted);margin-bottom:2px}
.lloc .val{font-size:14px;font-weight:600;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.swap-btn{width:28px;height:28px;background:var(--surface3);border:none;border-radius:7px;color:var(--sub);font-size:15px;cursor:pointer;display:flex;align-items:center;justify-content:center;transition:transform .3s}
.swap-btn:active{transform:rotate(180deg)}
.loc-line{width:1px;height:14px;background:var(--border);margin-left:4px}

/* Quick chips */
.qchips{display:flex;gap:8px;overflow-x:auto;padding-bottom:4px;margin-bottom:15px;scrollbar-width:none}
.qchips::-webkit-scrollbar{display:none}
.chip{flex-shrink:0;display:flex;align-items:center;gap:6px;padding:8px 14px;background:var(--surface2);border:1px solid var(--border);border-radius:99px;font-size:12px;font-weight:600;color:var(--sub);cursor:pointer;transition:all .2s;white-space:nowrap}
.chip:active{background:var(--primary-dim);color:var(--primary);border-color:var(--border-glow)}

/* Surge */
.surge{background:rgba(245,158,11,.08);border:1px solid rgba(245,158,11,.22);border-radius:10px;padding:9px 13px;display:none;align-items:center;gap:8px;font-size:12px;color:var(--amber);font-weight:600;margin-bottom:13px}

/* Ride options */
#rideOptions{display:none}
.rcards{display:flex;flex-direction:column;gap:10px;margin-bottom:14px}
.rcard{display:flex;align-items:center;background:var(--surface2);border:2px solid transparent;border-radius:16px;padding:13px;cursor:pointer;transition:all .2s;gap:13px}
.rcard.sel{border-color:var(--primary);background:var(--primary-dim);box-shadow:var(--primary-glow)}
.rico{font-size:26px;width:46px;height:46px;background:var(--surface3);border-radius:11px;display:flex;align-items:center;justify-content:center;flex-shrink:0}
.rinfo{flex:1;min-width:0}
.rname{font-family:'Syne',sans-serif;font-size:15px;font-weight:700}
.reta{font-size:12px;color:var(--muted);margin-top:2px}
.rprice{font-family:'Syne',sans-serif;font-size:19px;font-weight:800;color:var(--primary)}

/* Booking footer */
.bfoot{background:var(--surface2);border:1px solid var(--border);border-radius:14px;padding:13px;margin-bottom:13px;display:none}
.brow{display:flex;align-items:center;justify-content:space-between}
.brow+.brow{margin-top:11px}
.pms{display:flex;gap:7px;margin-bottom:2px}
.pm{flex:1;padding:9px 5px;background:var(--surface3);border:1px solid transparent;border-radius:9px;text-align:center;cursor:pointer;transition:all .2s;font-size:11px;font-weight:600;color:var(--sub)}
.pm.act{border-color:var(--primary);background:var(--primary-dim);color:var(--primary)}
.pm .pico{font-size:17px;display:block;margin-bottom:3px}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   SEARCH OVERLAY
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
#searchOv{position:absolute;inset:0;background:var(--bg);z-index:200;display:none;flex-direction:column;padding:48px 18px 18px}
.sh-head{display:flex;align-items:center;gap:13px;margin-bottom:15px}
.sh-inps{background:var(--surface);border:1px solid var(--border);border-radius:16px;padding:5px;margin-bottom:15px}
.sir{display:flex;align-items:center;gap:10px;padding:11px 12px}
.sil{width:1px;height:12px;background:var(--border);margin-left:4px}
.suggs{flex:1;overflow-y:auto}
.si{display:flex;align-items:center;gap:13px;padding:13px 0;border-bottom:1px solid var(--border);cursor:pointer;transition:all .15s}
.si:active{opacity:.6}
.sico{width:38px;height:38px;background:var(--surface2);border-radius:10px;display:flex;align-items:center;justify-content:center;font-size:16px;flex-shrink:0}
.sname{font-size:14px;font-weight:600}
.saddr{font-size:12px;color:var(--muted);margin-top:2px}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   FINDING DRIVER
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
#findingOv{position:absolute;bottom:0;left:0;right:0;background:var(--surface);border-radius:28px 28px 0 0;border-top:1px solid var(--border);padding:32px 22px;z-index:60;display:none;text-align:center}
.f-anim{width:88px;height:88px;margin:0 auto 22px;position:relative}
.f-ring{position:absolute;inset:0;border-radius:50%;border:2px solid var(--primary);animation:rpulse 1.5s ease-out infinite;opacity:0}
.f-ring:nth-child(2){animation-delay:.5s}
.f-ring:nth-child(3){animation-delay:1s}
@keyframes rpulse{0%{transform:scale(.5);opacity:.8}100%{transform:scale(1.5);opacity:0}}
.f-center{position:absolute;inset:20px;background:var(--primary-dim);border:2px solid var(--primary);border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:24px}
.f-title{font-family:'Syne',sans-serif;font-size:21px;font-weight:800;margin-bottom:6px}
.f-sub{color:var(--muted);font-size:13px;margin-bottom:24px}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   RIDE CONFIRMED
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
#ridePanel{position:absolute;bottom:0;left:0;right:0;background:var(--surface);border-radius:28px 28px 0 0;border-top:1px solid var(--border);z-index:60;display:none;flex-direction:column;max-height:76vh;overflow:hidden}
.dphead{padding:18px 20px 12px;border-bottom:1px solid var(--border);flex-shrink:0}
.drow{display:flex;align-items:center;gap:13px;margin-bottom:12px}
.dav{width:52px;height:52px;background:linear-gradient(135deg,var(--primary),var(--purple));border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:22px;flex-shrink:0}
.dname{font-family:'Syne',sans-serif;font-size:17px;font-weight:700}
.drat{font-size:13px;color:var(--amber);margin-top:2px}
.dveh{font-size:12px;color:var(--muted)}
.eta-bar{display:flex;gap:9px}
.eta-item{flex:1;background:var(--surface2);border-radius:12px;padding:10px 11px;text-align:center}
.eta-v{font-family:'Syne',sans-serif;font-size:19px;font-weight:800;color:var(--primary)}
.eta-l{font-size:11px;color:var(--muted)}
.act-row{display:flex;gap:9px;padding:13px 20px}
.route-info{padding:0 20px 20px;overflow-y:auto}
.ri{display:flex;align-items:flex-start;gap:13px;padding:9px 0}
.ri .ric{font-size:15px;color:var(--muted);flex-shrink:0;margin-top:1px}
.ri .lbl{font-size:11px;color:var(--muted)}
.ri .val{font-size:13px;font-weight:600}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   RATING OVERLAY
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
#ratingOv{position:absolute;inset:0;background:rgba(7,12,20,.96);z-index:300;display:none;flex-direction:column;align-items:center;justify-content:center;padding:28px}
.rat-card{background:var(--surface);border:1px solid var(--border);border-radius:26px;padding:26px;width:100%;text-align:center}
.rat-ico{font-size:52px;margin-bottom:13px}
.rat-t{font-family:'Syne',sans-serif;font-size:22px;font-weight:800;margin-bottom:6px}
.rat-sub{color:var(--muted);font-size:13px;margin-bottom:18px}
.fare-sum{background:var(--surface2);border-radius:13px;padding:13px;margin-bottom:18px;text-align:left}
.fr{display:flex;justify-content:space-between;font-size:13px;color:var(--sub);margin-bottom:7px}
.fr:last-child{margin:0;color:var(--text);font-weight:700;font-size:15px;border-top:1px solid var(--border);padding-top:8px;margin-top:4px}
.stars{display:flex;justify-content:center;gap:10px;margin-bottom:20px}
.star{font-size:36px;cursor:pointer;transition:transform .2s;filter:grayscale(1);opacity:.35}
.star.lit{filter:none;opacity:1}
.star:active{transform:scale(1.3)}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   DRIVER DASHBOARD
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
#driverDash{position:absolute;bottom:0;left:0;right:0;background:var(--surface);border-radius:28px 28px 0 0;border-top:1px solid var(--border);z-index:40;display:none;flex-direction:column;height:82vh;transform:translateY(22%);transition:transform .38s var(--ease);overflow:hidden}
.d-header{padding:5px 20px 14px;flex-shrink:0}
.d-top{display:flex;align-items:center;justify-content:space-between;margin-bottom:14px}
.d-stats{display:grid;grid-template-columns:repeat(3,1fr);gap:9px;margin-bottom:14px}
.sc{background:var(--surface2);border-radius:13px;padding:13px 8px;text-align:center;border:1px solid var(--border)}
.sv{font-family:'Syne',sans-serif;font-size:19px;font-weight:800;color:var(--primary)}
.sl{font-size:11px;color:var(--muted);margin-top:3px}
.inc-card{margin:0 20px 18px;background:var(--surface2);border:1px solid var(--border-glow);border-radius:20px;padding:17px;box-shadow:var(--primary-glow);display:none}
.inc-badge{display:flex;align-items:center;gap:8px;margin-bottom:13px}
.inc-dot{width:7px;height:7px;background:var(--primary);border-radius:50%;animation:blink 1s infinite}
@keyframes blink{0%,100%{opacity:1}50%{opacity:0}}
.inc-badge span{font-family:'Syne',sans-serif;font-size:12px;font-weight:700;color:var(--primary)}
.tbar{height:3px;background:var(--border);border-radius:3px;margin-bottom:13px;overflow:hidden}
.tfill{height:100%;background:var(--primary);border-radius:3px;width:100%;transition:width 15s linear}
.irow{display:flex;align-items:center;gap:9px;margin-bottom:7px}
.idot{width:7px;height:7px;border-radius:50%;flex-shrink:0}
.idot.p{background:var(--primary)} .idot.d{background:var(--amber)}
.iaddr{font-size:13px;font-weight:500}
.imeta{display:flex;gap:9px;margin-bottom:13px}
.ic{flex:1;background:var(--surface3);border-radius:10px;padding:8px;text-align:center}
.icv{font-family:'Syne',sans-serif;font-size:15px;font-weight:800}
.icl{font-size:10px;color:var(--muted);margin-top:2px}
.d-inner{flex:1;overflow-y:auto;padding:0 20px 20px}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   SIDE MENU
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
#sideMenu{position:absolute;inset:0;z-index:500;display:none}
.s-back{position:absolute;inset:0;background:rgba(0,0,0,.6);backdrop-filter:blur(4px)}
.s-panel{position:absolute;left:0;top:0;bottom:0;width:82%;max-width:310px;background:var(--surface);border-right:1px solid var(--border);padding:50px 20px 30px;overflow-y:auto;transform:translateX(-100%);transition:transform .38s var(--ease)}
.s-panel.open{transform:translateX(0)}
.pav{width:68px;height:68px;background:linear-gradient(135deg,var(--primary),var(--purple));border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:28px;margin-bottom:11px}
.pname{font-family:'Syne',sans-serif;font-size:20px;font-weight:700;margin-bottom:4px}
.pemail{color:var(--muted);font-size:13px;margin-bottom:20px}
.mitem{display:flex;align-items:center;gap:13px;padding:13px 0;border-bottom:1px solid var(--border);cursor:pointer;transition:all .15s}
.mitem:active{opacity:.6}
.mico{width:38px;height:38px;background:var(--surface2);border-radius:10px;display:flex;align-items:center;justify-content:center;font-size:18px;flex-shrink:0}
.mlbl{font-size:15px;font-weight:600}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   HISTORY OVERLAY
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
#historyOv{position:absolute;inset:0;background:var(--bg);z-index:400;display:none;flex-direction:column}
.hist-head{padding:48px 20px 15px;background:var(--surface);border-bottom:1px solid var(--border);display:flex;align-items:center;gap:13px;flex-shrink:0}
.hist-head h2{font-family:'Syne',sans-serif;font-size:20px;font-weight:800}
.hist-list{flex:1;overflow-y:auto;padding:15px 18px}
.hi{background:var(--surface);border:1px solid var(--border);border-radius:15px;padding:13px;margin-bottom:9px}
.hi-t{display:flex;justify-content:space-between;align-items:center;margin-bottom:9px}
.hi-date{font-size:12px;color:var(--muted)}
.h-route .hr{display:flex;align-items:center;gap:8px;font-size:13px;margin-bottom:5px}
.hi-b{display:flex;justify-content:space-between;align-items:center;margin-top:8px;padding-top:8px;border-top:1px solid var(--border)}
.hi-fare{font-family:'Syne',sans-serif;font-size:15px;font-weight:800;color:var(--primary)}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   SCHEDULE OVERLAY
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
#schedOv{position:absolute;inset:0;background:rgba(7,12,20,.96);z-index:350;display:none;align-items:flex-end}
.sched-sheet{background:var(--surface);border-radius:28px 28px 0 0;border-top:1px solid var(--border);padding:24px;width:100%}
.sched-head{display:flex;justify-content:space-between;align-items:center;margin-bottom:20px}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   MISC
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.slbl{font-size:11px;font-weight:800;text-transform:uppercase;letter-spacing:1px;color:var(--muted);margin-bottom:9px}
.spinner{width:20px;height:20px;border:2px solid rgba(255,255,255,.15);border-top-color:var(--primary);border-radius:50%;animation:spin .7s linear infinite;display:inline-block}
.spinner-dark{border-top-color:#000}
@keyframes spin{to{transform:rotate(360deg)}}
@keyframes pulse-fade{0%,100%{opacity:1}50%{opacity:.3}}
.pulse{animation:pulse-fade 2s infinite}
.share-chip{background:rgba(16,185,129,.08);border:1px solid rgba(16,185,129,.2);border-radius:10px;padding:7px 10px}
</style>
</head>
<body>

<!-- â•â•â• AUTH SCREEN â•â•â• -->
<div id="authScreen" class="screen active">
  <div class="auth-bg"></div>
  <div class="auth-wrap">
    <div class="auth-logo">
      <span class="lico">ğŸš–</span>
      <h1>JDP CABS</h1>
      <p>Premium Rides â€¢ Jagdalpur, Bastar</p>
    </div>
    <div class="auth-card">
      <div class="role-tog">
        <button class="role-btn act" id="btnRider" onclick="APP.setRole('rider')">ğŸ§ Rider</button>
        <button class="role-btn" id="btnDriver" onclick="APP.setRole('driver')">ğŸš— Driver</button>
      </div>
      <div class="atabs">
        <button class="atab act" id="tabLogin" onclick="APP.setMode('login')">Login</button>
        <button class="atab" id="tabReg" onclick="APP.setMode('register')">Register</button>
      </div>
      <div id="authErr"></div>
      <div class="iw"><span class="ico">ğŸ“§</span><input type="email" id="eml" class="inp" placeholder="Email Address" autocomplete="email"></div>
      <div class="iw"><span class="ico">ğŸ”’</span><input type="password" id="pwd" class="inp" placeholder="Password (min 6 chars)" autocomplete="current-password"></div>
      <div id="regFields" style="display:none">
        <div class="iw"><span class="ico">ğŸ‘¤</span><input type="text" id="nm" class="inp" placeholder="Full Name"></div>
        <div class="iw"><span class="ico">ğŸ“</span><input type="tel" id="ph" class="inp" placeholder="Phone Number"></div>
        <div id="drvFields" style="display:none">
          <div class="iw"><span class="ico">ğŸ”–</span><input type="text" id="vno" class="inp" placeholder="Vehicle Number (e.g., CG17AA1234)"></div>
          <div class="iw"><span class="ico">ğŸš—</span><input type="text" id="vmod" class="inp" placeholder="Vehicle Model (e.g., Swift Dzire)"></div>
        </div>
      </div>
      <button class="btn btn-primary" id="authBtn" onclick="APP.handleAuth()">Login to Account</button>
      <div class="auth-switch" onclick="APP.setMode(null)">New here? Create Account â†’</div>
    </div>
  </div>
</div>

<!-- â•â•â• MAP SCREEN â•â•â• -->
<div id="mapScreen" class="screen">
  <div id="map"></div>

  <!-- TOP BAR -->
  <div class="topbar">
    <button class="btn-icon" onclick="APP.openMenu()">â˜°</button>
    <div class="logo-pill">JDP CABS</div>
    <button class="btn-icon" onclick="APP.toast('ğŸ“­ No new notifications',3000)">ğŸ””</button>
  </div>

  <!-- LOCATION + SOS FABS -->
  <button id="myLocBtn" style="bottom:330px" onclick="APP.centerMap()">ğŸ“</button>
  <button id="sosBtn" onclick="APP.sos()"><span style="font-size:13px">ğŸ†˜</span><span>SOS</span></button>

  <!-- TOAST -->
  <div id="toast">
    <span id="t-ico" style="font-size:18px">â„¹ï¸</span>
    <span id="t-txt" style="flex:1;font-size:13px;font-weight:500"></span>
  </div>

  <!-- â•â•â• RIDER SHEET â•â•â• -->
  <div id="riderSheet">
    <div class="dh" id="dhRider"><div class="db"></div></div>
    <div class="shin">
      <!-- Greeting -->
      <div class="greet">
        <div class="greet-t">
          <h2>Where to? ğŸ“</h2>
          <p id="greetSub">Ready for your ride</p>
        </div>
        <div class="wallet-c" onclick="APP.toast('ğŸ’³ Wallet: â‚¹0 Â· Add money coming soon',3000)">
          ğŸ’³ â‚¹<span id="walBal">0</span>
        </div>
      </div>

      <!-- Location Box -->
      <div class="loc-box">
        <div class="loc-row" onclick="APP.openSearch('pickup')">
          <div class="ldot pick"></div>
          <div class="lloc">
            <div class="lbl">Pickup</div>
            <div class="val" id="pickLbl">Detecting location...</div>
          </div>
        </div>
        <div style="padding:0 13px;position:relative">
          <div class="dvd" style="margin:0"></div>
          <button class="swap-btn" style="position:absolute;right:13px;top:50%;transform:translateY(-50%)" onclick="APP.swap()">â‡…</button>
        </div>
        <div class="loc-row" onclick="APP.openSearch('drop')">
          <div class="ldot drop"></div>
          <div class="lloc">
            <div class="lbl">Drop-off</div>
            <div class="val" id="dropLbl" style="color:var(--muted);font-weight:400">Where are you going?</div>
          </div>
        </div>
      </div>

      <!-- Quick Chips -->
      <div class="qchips">
        <div class="chip" onclick="APP.openSearch('pickup')">ğŸ“ My Location</div>
        <div class="chip" onclick="APP.dest('Bus Stand, Jagdalpur',19.0735,82.0261)">ğŸšŒ Bus Stand</div>
        <div class="chip" onclick="APP.dest('Railway Station, Jagdalpur',19.0803,82.0136)">ğŸš‚ Railway</div>
        <div class="chip" onclick="APP.dest('DIMHANS Hospital',19.0600,82.0100)">ğŸ¥ Hospital</div>
        <div class="chip" onclick="APP.dest('Jagdalpur Airport',19.0578,82.0348)">âœˆï¸ Airport</div>
        <div class="chip" onclick="APP.showSched()">ğŸ“… Schedule</div>
      </div>

      <!-- Surge Banner -->
      <div class="surge" id="surgeBanner">âš¡ <strong>Surge 1.3Ã—</strong> Â· High demand â€” fares temporarily higher</div>

      <!-- Ride Options -->
      <div id="rideOptions">
        <div class="slbl">Choose your ride</div>
        <div class="rcards">
          <div class="rcard sel" id="cAuto" onclick="APP.selRide('Auto')">
            <div class="rico">ğŸ›º</div>
            <div class="rinfo">
              <div class="rname">Auto</div>
              <div class="reta" id="etaAuto">Calculating...</div>
            </div>
            <div style="text-align:right">
              <div class="rprice" id="fAuto">â‚¹--</div>
              <div style="font-size:11px;color:var(--muted)" id="distLbl">--km</div>
            </div>
          </div>
          <div class="rcard" id="cCab" onclick="APP.selRide('Cab')">
            <div class="rico">ğŸš•</div>
            <div class="rinfo">
              <div class="rname">Cab Â· Dzire</div>
              <div class="reta" id="etaCab">Calculating...</div>
            </div>
            <div style="text-align:right"><div class="rprice" id="fCab">â‚¹--</div></div>
          </div>
          <div class="rcard" id="cPrem" onclick="APP.selRide('Premium')">
            <div class="rico">ğŸš™</div>
            <div class="rinfo">
              <div class="rname">Premium Â· Innova</div>
              <div class="reta" id="etaPrem">Calculating...</div>
            </div>
            <div style="text-align:right"><div class="rprice" id="fPrem">â‚¹--</div></div>
          </div>
        </div>

        <!-- Booking Footer: Payment + Promo -->
        <div class="bfoot" id="bfoot">
          <div class="brow"><span style="font-size:12px;font-weight:700;color:var(--muted)">PAYMENT METHOD</span></div>
          <div class="pms" style="margin-top:9px">
            <div class="pm act" id="pmCash" onclick="APP.setPay('cash')"><span class="pico">ğŸ’µ</span>Cash</div>
            <div class="pm" id="pmUpi" onclick="APP.setPay('upi')"><span class="pico">ğŸ“±</span>UPI</div>
            <div class="pm" id="pmCard" onclick="APP.setPay('card')"><span class="pico">ğŸ’³</span>Card</div>
            <div class="pm" id="pmWal" onclick="APP.setPay('wallet')"><span class="pico">ğŸ‘›</span>Wallet</div>
          </div>
          <div class="dvd"></div>
          <div class="brow">
            <div style="display:flex;align-items:center;gap:8px">
              <input type="text" id="promoInp" style="background:var(--surface3);border:1px solid var(--border);border-radius:8px;padding:8px 11px;color:var(--text);font-size:13px;outline:none;width:140px;font-family:'DM Sans',sans-serif" placeholder="ğŸ·ï¸ Promo code">
              <button class="btn btn-secondary btn-sm" style="font-size:12px;padding:8px 12px" onclick="APP.applyPromo()">Apply</button>
            </div>
            <div id="promoSave" style="display:none;color:var(--green);font-size:13px;font-weight:700"></div>
          </div>
        </div>

        <button class="btn btn-primary" id="bookBtn" onclick="APP.book()">Confirm Auto Booking</button>
      </div>
      <button class="btn btn-primary" id="calcBtn" onclick="APP.calcFare()" style="display:none">ğŸ” Find Rides</button>
    </div>
  </div>

  <!-- â•â•â• DRIVER DASHBOARD â•â•â• -->
  <div id="driverDash">
    <div class="dh" id="dhDriver"><div class="db"></div></div>
    <div class="d-header">
      <div class="d-top">
        <div>
          <h2 style="font-family:Syne;font-size:20px;font-weight:800">Dashboard</h2>
          <div id="dBadge" class="badge b-red" style="margin-top:5px"><span class="pulse">â—</span> OFFLINE</div>
        </div>
        <button class="btn btn-success btn-sm" id="onlineBtn" onclick="APP.toggleOnline()">Go Online</button>
      </div>
      <div class="d-stats">
        <div class="sc"><div class="sv" id="dEarn">â‚¹0</div><div class="sl">Today Earned</div></div>
        <div class="sc"><div class="sv" id="dTrips">0</div><div class="sl">Trips Done</div></div>
        <div class="sc"><div class="sv" id="dRat">5.0</div><div class="sl">Rating â­</div></div>
      </div>
    </div>

    <!-- Incoming Ride -->
    <div class="inc-card" id="incCard">
      <div class="inc-badge">
        <div class="inc-dot"></div>
        <span>NEW RIDE REQUEST</span>
        <div class="badge b-cyan" id="incType">Auto</div>
      </div>
      <div class="tbar"><div class="tfill" id="tfill"></div></div>
      <div class="irow"><div class="idot p"></div><div class="iaddr" id="incPick">Loading...</div></div>
      <div class="irow" style="margin-bottom:13px"><div class="idot d"></div><div class="iaddr" id="incDrop">Loading...</div></div>
      <div class="imeta">
        <div class="ic"><div class="icv" id="incFare">â‚¹--</div><div class="icl">Fare</div></div>
        <div class="ic"><div class="icv" id="incDist">--km</div><div class="icl">Distance</div></div>
        <div class="ic"><div class="icv" id="incETA">--m</div><div class="icl">ETA</div></div>
      </div>
      <div style="display:flex;gap:9px">
        <button class="btn btn-danger" style="flex:1" onclick="APP.rejectRide()">âœ• Decline</button>
        <button class="btn btn-primary" style="flex:1" onclick="APP.acceptRide()">âœ“ Accept</button>
      </div>
    </div>

    <div class="d-inner">
      <div class="slbl">Today's activity</div>
      <div style="background:var(--surface2);border-radius:13px;padding:14px;border:1px solid var(--border);text-align:center;color:var(--muted);font-size:13px" id="dEmptyState">
        Go online to start receiving ride requests ğŸš€
      </div>
    </div>
  </div>

  <!-- â•â•â• FINDING OVERLAY â•â•â• -->
  <div id="findingOv">
    <div class="f-anim">
      <div class="f-ring"></div><div class="f-ring"></div><div class="f-ring"></div>
      <div class="f-center">ğŸš–</div>
    </div>
    <div class="f-title">Finding your driver...</div>
    <div class="f-sub">Matching you with nearby <strong id="findType">Auto</strong></div>
    <button class="btn btn-secondary" onclick="APP.cancelSearch()">âœ• Cancel Search</button>
  </div>

  <!-- â•â•â• RIDE CONFIRMED PANEL â•â•â• -->
  <div id="ridePanel">
    <div class="dphead">
      <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:12px">
        <div class="badge b-green">âœ“ Driver Confirmed</div>
        <div class="share-chip">
          <button onclick="APP.shareRide()" style="background:none;border:none;color:var(--green);font-size:12px;font-weight:700;cursor:pointer;font-family:'DM Sans',sans-serif">ğŸ“¤ Share Ride</button>
        </div>
      </div>
      <div class="drow">
        <div class="dav">ğŸ‘¨</div>
        <div style="flex:1">
          <div class="dname" id="confDrv">Rajesh Kumar</div>
          <div class="drat">â­ 4.8 Â· <span id="confVeh">CG17AA1234</span></div>
        </div>
        <div style="display:flex;gap:8px">
          <button class="btn-icon" onclick="APP.callDriver()" title="Call">ğŸ“</button>
          <button class="btn-icon" onclick="APP.toast('ğŸ’¬ Chat coming soon!',3000)" title="Chat">ğŸ’¬</button>
        </div>
      </div>
      <div class="eta-bar">
        <div class="eta-item"><div class="eta-v" id="confETA">3</div><div class="eta-l">min away</div></div>
        <div class="eta-item"><div class="eta-v" id="confDist">--</div><div class="eta-l">km total</div></div>
        <div class="eta-item"><div class="eta-v" id="confFare">â‚¹--</div><div class="eta-l">est. fare</div></div>
      </div>
    </div>
    <div class="act-row">
      <button class="btn btn-danger btn-sm" onclick="APP.cancelRide()">âœ• Cancel Ride</button>
      <button class="btn btn-secondary btn-sm" style="flex:1" onclick="APP.toast('ğŸ“ Tracking driver on map',3000)">Live Track</button>
    </div>
    <div class="route-info">
      <div class="ri"><div class="ric">ğŸŸ¢</div><div><div class="lbl">Pickup</div><div class="val" id="confPick">Your Location</div></div></div>
      <div class="ri"><div class="ric">ğŸŸ¡</div><div><div class="lbl">Drop-off</div><div class="val" id="confDropLbl">Destination</div></div></div>
      <div class="ri"><div class="ric">ğŸ’³</div><div><div class="lbl">Payment</div><div class="val" id="confPay">Cash</div></div></div>
    </div>
  </div>

  <!-- â•â•â• RATING OVERLAY â•â•â• -->
  <div id="ratingOv">
    <div class="rat-card">
      <div class="rat-ico">ğŸ‰</div>
      <div class="rat-t">Ride Complete!</div>
      <div class="rat-sub">Hope you had a great experience</div>
      <div class="fare-sum">
        <div class="fr"><span>Distance</span><span id="rDist">--km</span></div>
        <div class="fr"><span>Base Fare</span><span id="rBase">â‚¹--</span></div>
        <div class="fr"><span>Payment</span><span id="rPay">Cash</span></div>
        <div class="fr"><span>Total Paid</span><span id="rTotal">â‚¹--</span></div>
      </div>
      <div class="slbl" style="margin-bottom:11px">Rate your driver</div>
      <div class="stars">
        <span class="star" onclick="APP.setRat(1)">â­</span>
        <span class="star" onclick="APP.setRat(2)">â­</span>
        <span class="star" onclick="APP.setRat(3)">â­</span>
        <span class="star" onclick="APP.setRat(4)">â­</span>
        <span class="star" onclick="APP.setRat(5)">â­</span>
      </div>
      <button class="btn btn-primary" onclick="APP.submitRat()">Submit & Done âœ“</button>
    </div>
  </div>

  <!-- â•â•â• SEARCH OVERLAY â•â•â• -->
  <div id="searchOv">
    <div class="sh-head">
      <button class="btn-icon" onclick="APP.closeSearch()">â†</button>
      <h2 style="font-family:Syne;font-size:18px;font-weight:800">Search Location</h2>
    </div>
    <div class="sh-inps">
      <div class="sir">
        <div class="ldot pick"></div>
        <input class="inp-bare" id="pickSearch" placeholder="Pickup location">
      </div>
      <div class="sil"></div>
      <div class="sir">
        <div class="ldot drop"></div>
        <input class="inp-bare" id="dropSearch" placeholder="Where to?">
      </div>
    </div>
    <div class="suggs" id="suggs">
      <div class="slbl" style="margin-bottom:11px">Popular in Jagdalpur</div>
      <div class="si" onclick="APP.selPlace('Bus Stand, Jagdalpur',19.0735,82.0261)">
        <div class="sico">ğŸšŒ</div><div><div class="sname">Bus Stand</div><div class="saddr">Main Bus Stand, Jagdalpur</div></div>
      </div>
      <div class="si" onclick="APP.selPlace('Railway Station, Jagdalpur',19.0803,82.0136)">
        <div class="sico">ğŸš‚</div><div><div class="sname">Railway Station</div><div class="saddr">Jagdalpur Railway Station</div></div>
      </div>
      <div class="si" onclick="APP.selPlace('DIMHANS Hospital',19.0600,82.0100)">
        <div class="sico">ğŸ¥</div><div><div class="sname">DIMHANS Hospital</div><div class="saddr">Dimhans, Jagdalpur</div></div>
      </div>
      <div class="si" onclick="APP.selPlace('Jagdalpur Airport',19.0578,82.0348)">
        <div class="sico">âœˆï¸</div><div><div class="sname">Jagdalpur Airport</div><div class="saddr">Vistar Airport, Jagdalpur</div></div>
      </div>
      <div class="si" onclick="APP.selPlace('Bastar Palace, Jagdalpur',19.1000,81.9800)">
        <div class="sico">ğŸ›ï¸</div><div><div class="sname">Bastar Palace</div><div class="saddr">Heritage, Jagdalpur</div></div>
      </div>
      <div class="si" onclick="APP.selPlace('City Market, Jagdalpur',19.0720,82.0155)">
        <div class="sico">ğŸ›ï¸</div><div><div class="sname">City Market</div><div class="saddr">Main Market, Jagdalpur</div></div>
      </div>
      <div class="si" onclick="APP.selPlace('Lal Bagh, Jagdalpur',19.0750,82.0200)">
        <div class="sico">ğŸŒ³</div><div><div class="sname">Lal Bagh</div><div class="saddr">Garden, Jagdalpur</div></div>
      </div>
      <div class="si" onclick="APP.selPlace('Chitrakote Waterfall',19.2000,81.8500)">
        <div class="sico">ğŸ’§</div><div><div class="sname">Chitrakote Waterfall</div><div class="saddr">Jagdalpur, 38km</div></div>
      </div>
    </div>
  </div>

  <!-- â•â•â• SIDE MENU â•â•â• -->
  <div id="sideMenu">
    <div class="s-back" onclick="APP.closeMenu()"></div>
    <div class="s-panel" id="sPanel">
      <div class="pav">ğŸ‘¤</div>
      <div class="pname" id="mName">Loading...</div>
      <div class="pemail" id="mEmail">user@email.com</div>
      <div class="mitem" onclick="APP.showHistory()"><div class="mico">ğŸ“‹</div><div class="mlbl">Ride History</div></div>
      <div class="mitem" onclick="APP.toast('ğŸ Refer & Earn: Coming soon!',3000);APP.closeMenu()"><div class="mico">ğŸ</div><div class="mlbl">Refer & Earn</div></div>
      <div class="mitem" onclick="APP.toast('ğŸ’³ Wallet & UPI: Coming soon!',3000);APP.closeMenu()"><div class="mico">ğŸ’³</div><div class="mlbl">Wallet & Payments</div></div>
      <div class="mitem" onclick="APP.toast('ğŸ†˜ Emergency: 112 | Women Helpline: 1091',5000);APP.closeMenu()"><div class="mico">ğŸ†˜</div><div class="mlbl">Safety & Emergency</div></div>
      <div class="mitem" onclick="APP.toast('ğŸ§ Support chat: Coming soon!',3000);APP.closeMenu()"><div class="mico">ğŸ§</div><div class="mlbl">Help & Support</div></div>
      <div class="mitem" onclick="APP.toast('âš™ï¸ Settings: Coming soon!',3000);APP.closeMenu()"><div class="mico">âš™ï¸</div><div class="mlbl">Settings</div></div>
      <div class="mitem" style="border:none;margin-top:10px" onclick="APP.logout()"><div class="mico" style="background:rgba(239,68,68,.1)">ğŸšª</div><div class="mlbl" style="color:var(--red)">Logout</div></div>
      <div style="margin-top:28px;border-top:1px solid var(--border);padding-top:16px;text-align:center;color:var(--muted);font-size:12px;line-height:1.7">JDP CABS v2.0<br>Jagdalpur, Chhattisgarh<br>Made with â¤ï¸ for Bastar</div>
    </div>
  </div>

  <!-- â•â•â• HISTORY OVERLAY â•â•â• -->
  <div id="historyOv">
    <div class="hist-head">
      <button class="btn-icon" onclick="APP.closeHistory()">â†</button>
      <h2>Ride History</h2>
    </div>
    <div class="hist-list" id="histList"><div style="text-align:center;padding:50px;color:var(--muted)"><div class="spinner"></div></div></div>
  </div>

  <!-- â•â•â• SCHEDULE OVERLAY â•â•â• -->
  <div id="schedOv">
    <div class="sched-sheet">
      <div class="sched-head">
        <h2 style="font-family:Syne;font-size:20px;font-weight:800">ğŸ“… Schedule Ride</h2>
        <button class="btn-icon" onclick="APP.closeSched()">âœ•</button>
      </div>
      <div class="iw"><span class="ico">ğŸ“…</span><input type="date" id="schedDate" class="inp"></div>
      <div class="iw"><span class="ico">â°</span><input type="time" id="schedTime" class="inp"></div>
      <div class="iw"><span class="ico">ğŸ“</span><input type="text" id="schedDrop" class="inp" placeholder="Destination (where to go?)"></div>
      <button class="btn btn-primary" onclick="APP.confirmSched()">âœ“ Confirm Schedule</button>
    </div>
  </div>

</div><!-- end mapScreen -->

<script>
// â•â•â• MAP â•â•â•
let map, myMark, drvMark, dropMark;
let myLat=19.0735, myLng=82.0261;

function initMap() {
  map = new mappls.Map('map', {center:[myLat,myLng],zoom:14,zoomControl:false,attributionControl:false});
  map.on('load', () => { placeMyMark(); getUserLoc(); });
}

function placeMyMark() {
  if(myMark) myMark.remove();
  const el = document.createElement('div');
  el.innerHTML = '<div style="font-size:28px;filter:drop-shadow(0 2px 8px rgba(0,210,255,.7))">ğŸ”µ</div>';
  myMark = new mappls.Marker({map, position:{lat:myLat,lng:myLng}, draggable:false});
}

function placeDrvMark(lat,lng) {
  if(drvMark) drvMark.remove();
  drvMark = new mappls.Marker({map, position:{lat,lng}});
}

function placeDropMark(lat,lng) {
  if(dropMark) dropMark.remove();
  dropMark = new mappls.Marker({map, position:{lat,lng}});
}

function getUserLoc() {
  if(navigator.geolocation) {
    navigator.geolocation.getCurrentPosition(p => {
      myLat=p.coords.latitude; myLng=p.coords.longitude;
      placeMyMark();
      if(map) map.setCenter([myLat,myLng]);
      document.getElementById('pickLbl').innerText='Your Current Location';
      S.pickName='Your Current Location'; S.pickLat=myLat; S.pickLng=myLng;
    }, () => {
      document.getElementById('pickLbl').innerText='Jagdalpur City Center';
      S.pickName='Jagdalpur City Center';
    });
  }
}

// Haversine distance
function hvs(lat1,lon1,lat2,lon2) {
  const R=6371,dLat=(lat2-lat1)*Math.PI/180,dLon=(lon2-lon1)*Math.PI/180;
  const a=Math.sin(dLat/2)**2+Math.cos(lat1*Math.PI/180)*Math.cos(lat2*Math.PI/180)*Math.sin(dLon/2)**2;
  return (R*2*Math.atan2(Math.sqrt(a),Math.sqrt(1-a))).toFixed(1);
}

// â•â•â• APP STATE â•â•â•
const S = {
  user:null, role:'rider', mode:'login',
  ride:'Auto', pay:'cash',
  pickName:'Your Location', dropName:'',
  pickLat:myLat, pickLng:myLng, dropLat:null, dropLng:null,
  dist:0, rideId:null, searchTarget:'drop',
  online:false, rating:0, promo:false, promoAmt:0
};

// â•â•â• APP â•â•â•
window.APP = {

  // â”€â”€ AUTH â”€â”€
  setRole(role) {
    S.role = role;
    document.getElementById('btnRider').className = 'role-btn'+(role==='rider'?' act':'');
    document.getElementById('btnDriver').className = 'role-btn'+(role==='driver'?' act':'');
    document.getElementById('drvFields').style.display = role==='driver'?'block':'none';
  },
  setMode(m) {
    if(!m) m = S.mode==='login'?'register':'login';
    S.mode = m;
    document.getElementById('tabLogin').className = 'atab'+(m==='login'?' act':'');
    document.getElementById('tabReg').className = 'atab'+(m==='register'?' act':'');
    document.getElementById('regFields').style.display = m==='register'?'block':'none';
    document.getElementById('authBtn').innerText = m==='login'?'Login to Account':'Create Account';
    document.getElementById('authErr').style.display = 'none';
  },
  async handleAuth() {
    const email=document.getElementById('eml').value.trim();
    const pass=document.getElementById('pwd').value;
    const err=document.getElementById('authErr');
    err.style.display='none';
    if(!email||pass.length<6){err.innerHTML='âš ï¸ Check email & password (min 6 chars)';err.style.display='block';return;}
    const btn=document.getElementById('authBtn');
    btn.innerHTML='<div class="spinner spinner-dark" style="margin:0 auto"></div>';btn.disabled=true;
    try {
      if(S.mode==='login') {
        await window.FB.signIn(window.FB.auth,email,pass);
      } else {
        const nm=document.getElementById('nm').value||'User';
        const ph=document.getElementById('ph').value||'';
        const cr=await window.FB.create(window.FB.auth,email,pass);
        const d={email,name:nm,phone:ph,role:S.role,earnings:0,ridesCompleted:0,rating:5.0,wallet:0};
        if(S.role==='driver'){d.vehicleNo=document.getElementById('vno').value||'';d.vehicleModel=document.getElementById('vmod').value||'';}
        await window.FB.setDoc(window.FB.doc(window.FB.db,'users',cr.user.uid),d);
      }
    } catch(e) {
      err.innerHTML='âš ï¸ '+e.message.replace('Firebase: Error (auth/','').replace(').','').replace(/-/g,' ');
      err.style.display='block';
      btn.innerHTML=S.mode==='login'?'Login to Account':'Create Account';btn.disabled=false;
    }
  },
  async onLogin(user) {
    try {
      const snap=await window.FB.getDoc(window.FB.doc(window.FB.db,'users',user.uid));
      if(!snap.exists())return;
      S.user={uid:user.uid,...snap.data()};
      document.getElementById('authScreen').classList.remove('active');
      document.getElementById('mapScreen').classList.add('active');
      document.getElementById('mName').innerText=S.user.name||'User';
      document.getElementById('mEmail').innerText=S.user.email||'';
      document.getElementById('walBal').innerText=S.user.wallet||0;
      document.getElementById('greetSub').innerText='Hi '+(S.user.name||'there')+' ğŸ‘‹';
      setTimeout(()=>{initMap();},300);
      if(S.user.role==='driver') {
        document.getElementById('driverDash').style.display='flex';
        document.getElementById('riderSheet').style.display='none';
        document.getElementById('dEarn').innerText='â‚¹'+(S.user.earnings||0);
        document.getElementById('dTrips').innerText=S.user.ridesCompleted||0;
        document.getElementById('dRat').innerText=(S.user.rating||5.0).toFixed(1);
        document.getElementById('myLocBtn').style.bottom='360px';
        initDrvDrag();
        this.listenRides();
      } else {
        document.getElementById('riderSheet').style.display='flex';
        document.getElementById('driverDash').style.display='none';
        document.getElementById('myLocBtn').style.bottom='330px';
        initRdrDrag();
      }
    } catch(e){console.error(e);}
  },
  onLogout() {
    S.user=null;
    document.getElementById('mapScreen').classList.remove('active');
    document.getElementById('authScreen').classList.add('active');
    document.getElementById('authBtn').innerHTML='Login to Account';
    document.getElementById('authBtn').disabled=false;
    document.getElementById('eml').value='';document.getElementById('pwd').value='';
  },
  logout() { this.closeMenu(); if(window.FB) window.FB.signOut(window.FB.auth); },

  // â”€â”€ MAP â”€â”€
  centerMap() { if(map) map.setCenter([myLat,myLng]); },

  // â”€â”€ SEARCH â”€â”€
  openSearch(t) {
    S.searchTarget=t;
    document.getElementById('searchOv').style.display='flex';
    setTimeout(()=>{(t==='pickup'?document.getElementById('pickSearch'):document.getElementById('dropSearch')).focus();},80);
  },
  closeSearch() { document.getElementById('searchOv').style.display='none'; },
  selPlace(name,lat,lng) {
    if(S.searchTarget==='drop') {
      S.dropName=name;S.dropLat=lat;S.dropLng=lng;
      const el=document.getElementById('dropLbl');
      el.innerText=name;el.style.color='var(--text)';el.style.fontWeight='600';
      placeDropMark(lat,lng);
      if(map) setTimeout(()=>map.fitBounds([[S.pickLat||myLat,S.pickLng||myLng],[lat,lng]],{padding:[90,90]}),300);
    } else {
      S.pickName=name;S.pickLat=lat;S.pickLng=lng;
      myLat=lat;myLng=lng;
      document.getElementById('pickLbl').innerText=name;
      placeMyMark();
      if(map) map.setCenter([lat,lng]);
    }
    this.closeSearch();
    this.calcFare();
  },
  dest(name,lat,lng) { S.searchTarget='drop'; this.selPlace(name,lat,lng); },
  swap() {
    [S.pickName,S.dropName]=[S.dropName,S.pickName];
    [S.pickLat,S.dropLat]=[S.dropLat,S.pickLat];
    [S.pickLng,S.dropLng]=[S.dropLng,S.pickLng];
    document.getElementById('pickLbl').innerText=S.pickName||'Tap to set';
    const d=document.getElementById('dropLbl');
    d.innerText=S.dropName||'Where are you going?';
    d.style.color=S.dropName?'var(--text)':'var(--muted)';
    d.style.fontWeight=S.dropName?'600':'400';
    if(S.dropName)this.calcFare();
  },

  // â”€â”€ FARE â”€â”€
  calcFare() {
    if(!S.dropName){this.openSearch('drop');return;}
    const dist=parseFloat(hvs(S.pickLat||myLat,S.pickLng||myLng,S.dropLat,S.dropLng));
    S.dist=dist;
    const surge=Math.random()>.68;const sm=surge?1.3:1;
    document.getElementById('surgeBanner').style.display=surge?'flex':'none';
    const fA=Math.max(25,Math.round(dist*12*sm));
    const fC=Math.max(50,Math.round(dist*16*sm));
    const fP=Math.max(80,Math.round(dist*22*sm));
    const eA=Math.max(2,Math.ceil(dist*2.5));
    const eC=Math.max(3,Math.ceil(dist*3));
    const eP=Math.max(5,Math.ceil(dist*3.5));
    document.getElementById('fAuto').innerText='â‚¹'+fA;
    document.getElementById('fCab').innerText='â‚¹'+fC;
    document.getElementById('fPrem').innerText='â‚¹'+fP;
    document.getElementById('etaAuto').innerText=eA+' min Â· '+dist+'km';
    document.getElementById('etaCab').innerText=eC+' min Â· '+dist+'km';
    document.getElementById('etaPrem').innerText=eP+' min Â· '+dist+'km';
    document.getElementById('distLbl').innerText=dist+'km';
    document.getElementById('rideOptions').style.display='block';
    document.getElementById('bfoot').style.display='block';
    document.getElementById('calcBtn').style.display='none';
    this.selRide(S.ride);
    const sh=document.getElementById('riderSheet');
    sh.style.transform='translateY(0%)';rSnap=0;
  },
  selRide(t) {
    S.ride=t;
    ['Auto','Cab','Prem'].forEach(r=>{const c=document.getElementById('c'+r);if(c)c.className='rcard'+(r===t?' sel':'');});
    const fId=t==='Auto'?'fAuto':t==='Cab'?'fCab':'fPrem';
    const f=document.getElementById(fId).innerText;
    document.getElementById('bookBtn').innerText='Confirm '+t+' Â· '+f;
  },
  setPay(m) {
    S.pay=m;
    ['Cash','Upi','Card','Wal'].forEach(x=>{const e=document.getElementById('pm'+x);if(e)e.className='pm'+(x.toLowerCase()===m||(x==='Upi'&&m==='upi')?'act':x.toLowerCase().startsWith(m.slice(0,3))?'act':'');});
    // simpler
    ['pmCash','pmUpi','pmCard','pmWal'].forEach(id=>{document.getElementById(id).className='pm';});
    const map2={cash:'pmCash',upi:'pmUpi',card:'pmCard',wallet:'pmWal'};
    if(map2[m])document.getElementById(map2[m]).className='pm act';
  },
  applyPromo() {
    const code=document.getElementById('promoInp').value.trim().toUpperCase();
    const saveEl=document.getElementById('promoSave');
    if(code==='JDP10'){S.promo=true;S.promoAmt=10;saveEl.innerText='âœ“ âˆ’â‚¹10 saved';saveEl.style.display='block';this.toast('ğŸ‰ Promo JDP10 applied! Save â‚¹10',3000);}
    else if(code==='FIRST50'){S.promo=true;S.promoAmt=20;saveEl.innerText='âœ“ âˆ’â‚¹20 saved';saveEl.style.display='block';this.toast('ğŸ‰ First ride promo applied!',3000);}
    else{this.toast('âŒ Invalid code. Try: JDP10 or FIRST50',3000);}
  },

  // â”€â”€ BOOKING â”€â”€
  async book() {
    if(!S.dropName){this.toast('ğŸ“ Please enter a destination',3000);return;}
    if(!S.user)return;
    const btn=document.getElementById('bookBtn');
    btn.innerHTML='<div class="spinner spinner-dark" style="margin:0 auto"></div>';btn.disabled=true;
    const fId=S.ride==='Auto'?'fAuto':S.ride==='Cab'?'fCab':'fPrem';
    let fare=parseInt(document.getElementById(fId).innerText.replace('â‚¹',''));
    if(S.promo&&S.promoAmt)fare=Math.max(10,fare-S.promoAmt);
    try {
      const ref=await window.FB.addDoc(window.FB.collection(window.FB.db,'rides'),{
        riderId:S.user.uid,riderName:S.user.name||'Rider',
        pickupName:S.pickName,pickupLat:S.pickLat||myLat,pickupLng:S.pickLng||myLng,
        dropName:S.dropName,dropLat:S.dropLat,dropLng:S.dropLng,
        cabType:S.ride,fare,distance:S.dist,paymentMethod:S.pay,
        status:'finding',timestamp:new Date()
      });
      S.rideId=ref.id;
      this.showFinding();
      setTimeout(()=>this.driverFound(fare),4500);
    } catch(e){this.toast('âŒ Booking failed. Check network.',3000);btn.innerHTML='Confirm '+S.ride+' Booking';btn.disabled=false;}
  },
  showFinding() {
    document.getElementById('riderSheet').style.display='none';
    document.getElementById('findingOv').style.display='block';
    document.getElementById('findType').innerText=S.ride;
    document.getElementById('sosBtn').style.display='flex';
    document.getElementById('myLocBtn').style.bottom='230px';
  },
  cancelSearch() {
    document.getElementById('findingOv').style.display='none';
    document.getElementById('riderSheet').style.display='flex';
    document.getElementById('sosBtn').style.display='none';
    document.getElementById('myLocBtn').style.bottom='330px';
    document.getElementById('bookBtn').innerHTML='Confirm '+S.ride+' Booking';
    document.getElementById('bookBtn').disabled=false;
    if(S.rideId)window.FB.updateDoc(window.FB.doc(window.FB.db,'rides',S.rideId),{status:'cancelled'}).catch(()=>{});
    this.toast('ğŸš« Search cancelled',2500);
  },
  driverFound(fare) {
    document.getElementById('findingOv').style.display='none';
    const panel=document.getElementById('ridePanel');panel.style.display='flex';
    const names=['Rajesh Kumar','Suresh Baghel','Anil Thakur','Manoj Sori','Deepak Netam'];
    const vehs=['CG17AA1234 Â· Swift Dzire','CG17BB5678 Â· Alto K10','CG17CC9012 Â· WagonR','CG17DD3456 Â· Baleno'];
    const nm=names[Math.floor(Math.random()*names.length)];
    const vh=vehs[Math.floor(Math.random()*vehs.length)];
    const eta=Math.floor(Math.random()*4)+2;
    document.getElementById('confDrv').innerText=nm;
    document.getElementById('confVeh').innerText=vh;
    document.getElementById('confETA').innerText=eta;
    document.getElementById('confDist').innerText=S.dist;
    document.getElementById('confFare').innerText='â‚¹'+fare;
    document.getElementById('confPick').innerText=S.pickName;
    document.getElementById('confDropLbl').innerText=S.dropName;
    document.getElementById('confPay').innerText=S.pay.toUpperCase();
    const dLat=(S.pickLat||myLat)+(Math.random()-.5)*.012;
    const dLng=(S.pickLng||myLng)+(Math.random()-.5)*.012;
    placeDrvMark(dLat,dLng);
    this.toast('ğŸš– Driver found! '+nm+' is on the way',4000);
    setTimeout(()=>this.showRating(fare),14000);
  },
  cancelRide() {
    if(!confirm('Cancel this ride?'))return;
    document.getElementById('ridePanel').style.display='none';
    document.getElementById('riderSheet').style.display='flex';
    document.getElementById('sosBtn').style.display='none';
    document.getElementById('myLocBtn').style.bottom='330px';
    document.getElementById('bookBtn').innerHTML='Confirm '+S.ride+' Booking';
    document.getElementById('bookBtn').disabled=false;
    if(drvMark){drvMark.remove();drvMark=null;}
    if(S.rideId)window.FB.updateDoc(window.FB.doc(window.FB.db,'rides',S.rideId),{status:'cancelled'}).catch(()=>{});
    this.toast('ğŸš« Ride cancelled',2500);
  },
  showRating(fare) {
    document.getElementById('ridePanel').style.display='none';
    document.getElementById('sosBtn').style.display='none';
    document.getElementById('ratingOv').style.display='flex';
    document.getElementById('rDist').innerText=S.dist+'km';
    document.getElementById('rBase').innerText='â‚¹'+Math.round(fare*.78);
    document.getElementById('rPay').innerText=S.pay.toUpperCase();
    document.getElementById('rTotal').innerText='â‚¹'+fare;
    document.querySelectorAll('.star').forEach(s=>s.className='star');
    S.rating=0;
  },
  setRat(n) {
    S.rating=n;
    document.querySelectorAll('.star').forEach((s,i)=>s.className='star'+(i<n?' lit':''));
  },
  async submitRat() {
    if(!S.rating){this.toast('â­ Please rate your driver',2000);return;}
    if(S.rideId){
      try{await window.FB.updateDoc(window.FB.doc(window.FB.db,'rides',S.rideId),{status:'completed',rating:S.rating,completedAt:new Date()});}catch(e){}
    }
    document.getElementById('ratingOv').style.display='none';
    document.getElementById('riderSheet').style.display='flex';
    document.getElementById('rideOptions').style.display='none';
    document.getElementById('bfoot').style.display='none';
    document.getElementById('myLocBtn').style.bottom='330px';
    const d=document.getElementById('dropLbl');d.innerText='Where are you going?';d.style.color='var(--muted)';d.style.fontWeight='400';
    document.getElementById('bookBtn').innerHTML='Confirm Auto Booking';document.getElementById('bookBtn').disabled=false;
    S.dropName='';S.rideId=null;S.promo=false;S.promoAmt=0;
    document.getElementById('promoSave').style.display='none';
    if(drvMark){drvMark.remove();drvMark=null;}
    if(dropMark){dropMark.remove();dropMark=null;}
    rSnap=60;document.getElementById('riderSheet').style.transform='translateY(60%)';
    this.toast('ğŸ™ Thanks for your feedback! Enjoy.',3000);
  },

  // â”€â”€ DRIVER â”€â”€
  async toggleOnline() {
    S.online=!S.online;
    const badge=document.getElementById('dBadge'),btn=document.getElementById('onlineBtn');
    if(S.online){
      badge.className='badge b-green';badge.innerHTML='<span class="pulse">â—</span> ONLINE';
      btn.className='btn btn-danger btn-sm';btn.innerText='Go Offline';
      if(S.user)await window.FB.updateDoc(window.FB.doc(window.FB.db,'users',S.user.uid),{isOnline:true,lat:myLat,lng:myLng}).catch(()=>{});
      this.toast('âœ… Online! Listening for ride requests...',3000);
      setTimeout(()=>{if(S.online)this.simIncoming();},7000);
    } else {
      badge.className='badge b-red';badge.innerHTML='<span class="pulse">â—</span> OFFLINE';
      btn.className='btn btn-success btn-sm';btn.innerText='Go Online';
      document.getElementById('incCard').style.display='none';
      if(S.user)await window.FB.updateDoc(window.FB.doc(window.FB.db,'users',S.user.uid),{isOnline:false}).catch(()=>{});
      this.toast('â›” Gone offline',2000);
    }
  },
  simIncoming() {
    const picks=['Bus Stand','Railway Station','City Market','Lal Bagh','Dimhans Gate'];
    const drops=['DIMHANS Hospital','Bastar Palace','Airport','Kondagaon','ITI College'];
    const types=['Auto','Cab','Premium'];
    const card=document.getElementById('incCard');
    const pick=picks[Math.floor(Math.random()*picks.length)];
    const drop=drops[Math.floor(Math.random()*drops.length)];
    const type=types[Math.floor(Math.random()*types.length)];
    const dist=(Math.random()*5+1.2).toFixed(1);
    const fare=type==='Auto'?Math.max(25,Math.round(dist*12)):type==='Cab'?Math.max(50,Math.round(dist*16)):Math.max(80,Math.round(dist*22));
    const eta=Math.ceil(dist*2.5);
    document.getElementById('incPick').innerText=pick+', Jagdalpur';
    document.getElementById('incDrop').innerText=drop;
    document.getElementById('incType').innerText=type;
    document.getElementById('incFare').innerText='â‚¹'+fare;
    document.getElementById('incDist').innerText=dist+'km';
    document.getElementById('incETA').innerText=eta+'m';
    card.style.display='block';
    document.getElementById('driverDash').style.transform='translateY(0%)';dSnap=0;
    const fill=document.getElementById('tfill');
    fill.style.transition='none';fill.style.width='100%';
    setTimeout(()=>{fill.style.transition='width 15s linear';fill.style.width='0%';},60);
    setTimeout(()=>{if(card.style.display!=='none'){card.style.display='none';this.toast('â° Ride request expired',2000);}},15500);
    this.toast('ğŸ”” New ride request!',3000);
  },
  listenRides() {
    if(!window.FB)return;
    try {
      const q=window.FB.query(window.FB.collection(window.FB.db,'rides'),window.FB.where('status','==','finding'));
      window.FB.onSnapshot(q,(snap)=>{
        snap.docChanges().forEach(ch=>{
          if(ch.type==='added'&&S.online&&S.user&&ch.doc.data().riderId!==S.user.uid){
            const r=ch.doc.data();
            document.getElementById('incPick').innerText=r.pickupName||'...';
            document.getElementById('incDrop').innerText=r.dropName||'...';
            document.getElementById('incType').innerText=r.cabType||'Auto';
            document.getElementById('incFare').innerText='â‚¹'+(r.fare||'--');
            document.getElementById('incDist').innerText=(r.distance||'--')+'km';
            document.getElementById('incETA').innerText=Math.ceil((r.distance||3)*2.5)+'m';
            document.getElementById('incCard').dataset.rideId=ch.doc.id;
            document.getElementById('incCard').style.display='block';
          }
        });
      });
    } catch(e){}
  },
  acceptRide() {
    const card=document.getElementById('incCard');card.style.display='none';
    const addFare=parseInt(document.getElementById('incFare').innerText.replace('â‚¹',''))||0;
    S.user.earnings=(S.user.earnings||0)+addFare;
    S.user.ridesCompleted=(S.user.ridesCompleted||0)+1;
    document.getElementById('dEarn').innerText='â‚¹'+S.user.earnings;
    document.getElementById('dTrips').innerText=S.user.ridesCompleted;
    if(S.user)window.FB.updateDoc(window.FB.doc(window.FB.db,'users',S.user.uid),{earnings:S.user.earnings,ridesCompleted:S.user.ridesCompleted}).catch(()=>{});
    this.toast('âœ… Ride accepted! Navigate to pickup.',3500);
    document.getElementById('driverDash').style.transform='translateY(60%)';dSnap=60;
  },
  rejectRide() { document.getElementById('incCard').style.display='none';this.toast('ğŸš« Ride declined',2000); },

  // â”€â”€ SOS â”€â”€
  sos() {
    this.toast('ğŸ†˜ SOS! Alerting emergency contacts + 112',5000);
    if(navigator.vibrate)navigator.vibrate([200,100,200,100,200,100,300]);
  },
  callDriver() { this.toast('ğŸ“ Calling driver... (Demo mode)',3000); },
  shareRide() {
    const txt=`I'm riding with JDP CABS from ${S.pickName} to ${S.dropName}. Stay safe! ğŸš–`;
    if(navigator.share)navigator.share({title:'JDP CABS Ride',text:txt});
    else{navigator.clipboard.writeText(txt).catch(()=>{});this.toast('ğŸ“‹ Ride info copied!',2500);}
  },

  // â”€â”€ MENU â”€â”€
  openMenu() { document.getElementById('sideMenu').style.display='block';setTimeout(()=>document.getElementById('sPanel').classList.add('open'),10); },
  closeMenu() { document.getElementById('sPanel').classList.remove('open');setTimeout(()=>document.getElementById('sideMenu').style.display='none',380); },

  // â”€â”€ HISTORY â”€â”€
  async showHistory() {
    this.closeMenu();
    document.getElementById('historyOv').style.display='flex';
    const list=document.getElementById('histList');
    list.innerHTML='<div style="text-align:center;padding:50px;color:var(--muted)"><div class="spinner"></div></div>';
    try {
      const q=window.FB.query(window.FB.collection(window.FB.db,'rides'),window.FB.where('riderId','==',S.user.uid));
      const snap=await window.FB.getDocs(q);
      if(snap.empty){list.innerHTML='<div style="text-align:center;padding:60px;color:var(--muted);line-height:2">ğŸš–<br>No rides yet.<br>Book your first ride!</div>';return;}
      let h='';
      const docs=[...snap.docs].reverse();
      docs.forEach(d=>{
        const r=d.data();
        const date=r.timestamp?.toDate?.()?.toLocaleDateString('en-IN',{day:'numeric',month:'short',year:'numeric'})||'N/A';
        const sc=r.status==='completed'?'b-green':r.status==='cancelled'?'b-red':'b-amber';
        const ico=r.cabType==='Auto'?'ğŸ›º':r.cabType==='Premium'?'ğŸš™':'ğŸš•';
        h+=`<div class="hi"><div class="hi-t"><div style="display:flex;align-items:center;gap:9px"><span style="font-size:18px">${ico}</span><div><div style="font-weight:700;font-size:14px">${r.cabType||'Ride'}</div><div class="hi-date">${date}</div></div></div><div class="badge ${sc}">${r.status||'completed'}</div></div><div class="h-route"><div class="hr"><span style="color:var(--primary)">â—</span>${r.pickupName||'Pickup'}</div><div class="hr"><span style="color:var(--amber)">â—</span>${r.dropName||'Drop'}</div></div><div class="hi-b"><div class="hi-fare">â‚¹${r.fare||'--'}</div><div>${r.rating?'â­'.repeat(r.rating):'Â·'}</div></div></div>`;
      });
      list.innerHTML=h;
    } catch(e){list.innerHTML='<div style="text-align:center;padding:40px;color:var(--red)">âš ï¸ Could not load history</div>';}
  },
  closeHistory() { document.getElementById('historyOv').style.display='none'; },

  // â”€â”€ SCHEDULE â”€â”€
  showSched() {
    document.getElementById('schedDate').value=new Date().toISOString().split('T')[0];
    document.getElementById('schedTime').value='10:00';
    document.getElementById('schedOv').style.display='flex';
  },
  closeSched() { document.getElementById('schedOv').style.display='none'; },
  confirmSched() {
    const dt=document.getElementById('schedDate').value;
    const tm=document.getElementById('schedTime').value;
    const dp=document.getElementById('schedDrop').value;
    if(!dt||!tm){this.toast('âš ï¸ Pick date & time',2000);return;}
    this.closeSched();
    this.toast(`ğŸ“… Scheduled! ${dp?'To: '+dp+' Â· ':''} ${dt} at ${tm}`,4000);
  },

  // â”€â”€ TOAST â”€â”€
  _tt: null,
  toast(msg,dur=3000) {
    clearTimeout(this._tt);
    const el=document.getElementById('toast');
    document.getElementById('t-txt').innerText=msg;
    el.style.display='flex';
    this._tt=setTimeout(()=>{el.style.display='none';},dur);
  }
};

// â•â•â• DRAG â€” RIDER SHEET â•â•â•
let rSnap=60;
function initRdrDrag() {
  const sh=document.getElementById('riderSheet');
  const h=document.getElementById('dhRider');
  let sy=0,drag=false;
  h.addEventListener('touchstart',e=>{sy=e.touches[0].clientY;drag=true;sh.style.transition='none';},{passive:true});
  h.addEventListener('touchmove',e=>{
    if(!drag)return;
    let t=rSnap+((e.touches[0].clientY-sy)/window.innerHeight)*100;
    t=Math.max(0,Math.min(82,t));sh.style.transform=`translateY(${t}%)`;
  },{passive:true});
  h.addEventListener('touchend',e=>{
    drag=false;sh.style.transition='transform .38s cubic-bezier(.22,1,.36,1)';
    const dy=e.changedTouches[0].clientY-sy;
    if(dy<-35)rSnap=0;else if(dy>35)rSnap=rSnap===0?62:82;
    sh.style.transform=`translateY(${rSnap}%)`;
  });
}

// â•â•â• DRAG â€” DRIVER SHEET â•â•â•
let dSnap=22;
function initDrvDrag() {
  const sh=document.getElementById('driverDash');
  const h=document.getElementById('dhDriver');
  let sy=0,drag=false;
  h.addEventListener('touchstart',e=>{sy=e.touches[0].clientY;drag=true;sh.style.transition='none';},{passive:true});
  h.addEventListener('touchmove',e=>{
    if(!drag)return;
    let t=dSnap+((e.touches[0].clientY-sy)/window.innerHeight)*100;
    t=Math.max(0,Math.min(82,t));sh.style.transform=`translateY(${t}%)`;
  },{passive:true});
  h.addEventListener('touchend',e=>{
    drag=false;sh.style.transition='transform .38s cubic-bezier(.22,1,.36,1)';
    const dy=e.changedTouches[0].clientY-sy;
    if(dy<-35)dSnap=0;else if(dy>35)dSnap=dSnap===0?60:82;
    sh.style.transform=`translateY(${dSnap}%)`;
  });
}
</script>
</body>
</html>

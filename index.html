<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>JDP CABS ‚Äî Jagdalpur Live</title>

<!-- ‚úÖ PWA Meta Tags -->
<meta name="theme-color" content="#f59e0b">
<meta name="mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="JDP Cabs">
<meta name="application-name" content="JDP Cabs">
<meta name="description" content="Jagdalpur ka smartest cab booking ‚Äî live tracking, instant ride">

<!-- ‚úÖ Icons -->
<link rel="icon" type="image/png" sizes="192x192" href="icon-192.png">
<link rel="apple-touch-icon" href="icon-192.png">

<!-- ‚úÖ Security Headers via meta -->
<meta http-equiv="X-Content-Type-Options" content="nosniff">
<meta name="referrer" content="strict-origin-when-cross-origin">
<link href="https://fonts.googleapis.com/css2?family=Syne:wght@700;800;900&family=DM+Sans:wght@400;500;600;700&display=swap" rel="stylesheet">

<!-- ‚úÖ PERFORMANCE & ERROR BOUNDARY ‚Äî 50K concurrent users -->

// Global error boundary ‚Äî prevent single error from crashing app
window.onerror = function(msg, src, line, col, err) {
  console.warn('[JDP] Caught error:', msg, 'at', src, line);
  // Don't crash the app ‚Äî just log it
  return true;
};
window.onunhandledrejection = function(e) {
  console.warn('[JDP] Unhandled promise:', e.reason);
  e.preventDefault();
};

// Performance: lazy load non-critical resources
window.PERF = {
  start: Date.now(),
  mark: function(n) { try { performance.mark(n); } catch(e) {} }
};

// Debounce utility ‚Äî prevent API spam under load
window.debounce = function(fn, ms) {
  var t; return function() { var a=arguments, ctx=this; clearTimeout(t); t=setTimeout(function(){fn.apply(ctx,a)},ms); };
};

// Throttle utility ‚Äî rate-limit Firebase writes
window.throttle = function(fn, ms) {
  var last=0; return function() { var now=Date.now(); if(now-last>=ms){last=now;fn.apply(this,arguments);} };
};

// Request queue ‚Äî prevent Firebase overload
window.ReqQueue = {
  q: [], running: 0, max: 3,
  add: function(fn) {
    return new Promise(function(res, rej) {
      window.ReqQueue.q.push({fn:fn, res:res, rej:rej});
      window.ReqQueue.run();
    });
  },
  run: function() {
    while(window.ReqQueue.running < window.ReqQueue.max && window.ReqQueue.q.length) {
      var item = window.ReqQueue.q.shift();
      window.ReqQueue.running++;
      item.fn().then(function(v){window.ReqQueue.running--;item.res(v);window.ReqQueue.run();})
               .catch(function(e){window.ReqQueue.running--;item.rej(e);window.ReqQueue.run();});
    }
  }
};

// Cache layer ‚Äî reduce duplicate API calls
window.Cache = {
  _store: {},
  get: function(k) { var v=this._store[k]; return v && Date.now()-v.t < v.ttl ? v.d : null; },
  set: function(k, d, ttl) { this._store[k]={d:d,t:Date.now(),ttl:ttl||60000}; },
  clear: function() { this._store={}; }
};

// GPS cache ‚Äî don't call GPS more than once per 3s
window.GPS_CACHE = { lat: null, lng: null, ts: 0, TTL: 3000 };


<!-- ‚úÖ Mappls Map SDK v3 ‚Äî Full India Vector Maps (Leaflet bundled inside) -->
<script>window.MAPPLS_KEY='4e97759ed6a3fb245e52f7e22d820954';</script>
<link href="https://apis.mappls.com/advancedmaps/api/4e97759ed6a3fb245e52f7e22d820954/map_sdk?v=3.0" rel="stylesheet">
<script src="https://apis.mappls.com/advancedmaps/api/4e97759ed6a3fb245e52f7e22d820954/map_sdk?v=3.0" defer></script>

<style>
:root{
  --bg:#07090f;--card:#0d1219;--card2:#131b25;
  --border:#1a2535;--text:#eaf0fb;--muted:#4d6a8a;
  --yellow:#f59e0b;--green:#10b981;--red:#ef4444;--blue:#3b82f6;
  --orange:#f97316;--purple:#8b5cf6;
}
body.lm{--bg:#f0f4fb;--card:#fff;--card2:#e8eef8;--border:#c8d4e4;--text:#0c1929;--muted:#4d6a8a;}
*{margin:0;padding:0;box-sizing:border-box;-webkit-tap-highlight-color:transparent;}
body{font-family:'DM Sans',sans-serif;background:#0a0e16;color:var(--text);height:100vh;overflow:hidden;}

/* ‚ïê‚ïê MAP ‚ïê‚ïê */
#map{position:absolute;inset:0;z-index:1;width:100vw;height:100vh;background:#1a2535;}

/* ‚ïê‚ïê MAPPLS MAP ‚Äî Full Screen, Uber-clean ‚ïê‚ïê */
.leaflet-control-zoom,.leaflet-control-scale,
.mappls-ctrl-zoom,.mappls-ctrl-scale{display:none!important;}
.leaflet-control-attribution,.mappls-ctrl-attrib-container{
  font-size:7px!important;opacity:.2!important;bottom:2px!important;right:4px!important;}
.leaflet-popup-content-wrapper,.mappls-popup-content-wrapper{
  background:rgba(10,14,22,.97)!important;color:white!important;
  border:1px solid rgba(255,255,255,.1)!important;border-radius:16px!important;
  font-family:'DM Sans',sans-serif!important;box-shadow:0 12px 40px rgba(0,0,0,.7)!important;
  backdrop-filter:blur(20px)!important;}
.leaflet-popup-tip,.mappls-popup-tip{background:rgba(10,14,22,.97)!important;}
.leaflet-popup-content,.mappls-popup-content{margin:14px 16px!important;font-size:.83rem!important;}

/* ‚ïê‚ïê UBER ZOOM CONTROLS ‚ïê‚ïê */
.zoom-ctrl{position:fixed;right:14px;z-index:500;display:flex;flex-direction:column;gap:5px;}
.zbtn{width:44px;height:44px;background:white;border:none;border-radius:12px;font-size:1.25rem;font-weight:800;cursor:pointer;
  box-shadow:0 4px 20px rgba(0,0,0,.22);display:flex;align-items:center;justify-content:center;
  color:#000;transition:transform .12s,box-shadow .18s;}
.zbtn:active{transform:scale(.92);box-shadow:0 2px 10px rgba(0,0,0,.18);}
body.lm .zbtn{background:#fff;color:#000;}

/* ‚ïê‚ïê TOP BAR ‚Äî Uber minimal ghost ‚ïê‚ïê */
.tb{position:fixed;top:0;left:0;right:0;z-index:500;display:flex;justify-content:space-between;
  align-items:center;padding:14px 16px;
  background:linear-gradient(to bottom,rgba(0,0,0,.55) 0%,transparent 100%);
  pointer-events:none;}
.tb>*{pointer-events:all;}
.tb-logo{font-family:'Syne',sans-serif;font-weight:900;color:white;font-size:1rem;
  letter-spacing:.06em;text-shadow:0 2px 8px rgba(0,0,0,.5);}
.tb-actions{display:flex;gap:8px;}
.tbtn{height:38px;background:rgba(255,255,255,.15);border:1px solid rgba(255,255,255,.18);
  border-radius:99px;display:flex;align-items:center;justify-content:center;cursor:pointer;
  padding:0 13px;font-size:.76rem;font-weight:700;color:white;gap:5px;
  backdrop-filter:blur(16px);transition:background .15s;}
.tbtn:active{background:rgba(255,255,255,.28);}
body.lm .tbtn{background:rgba(0,0,0,.1);color:#000;border-color:rgba(0,0,0,.15);}
.tbtn-icon{height:38px;width:38px;padding:0;border-radius:50%;}

/* ‚ïê‚ïê LOCATE BUTTON ‚Äî Uber FAB ‚ïê‚ïê */
.locbtn{position:fixed;right:14px;z-index:500;width:48px;height:48px;
  background:white;border-radius:50%;border:none;cursor:pointer;font-size:1.1rem;
  box-shadow:0 4px 20px rgba(0,0,0,.28);display:flex;align-items:center;justify-content:center;
  transition:transform .12s;}
.locbtn:active{transform:scale(.93);}

/* ‚ïê‚ïê MAP STATS CHIPS ‚Äî Uber top pill style ‚ïê‚ïê */
#mapStats{position:fixed;top:68px;left:12px;right:12px;z-index:450;display:none;pointer-events:none;}
.ms-row{display:flex;gap:6px;justify-content:center;}
.ms-chip{background:rgba(0,0,0,.62);backdrop-filter:blur(20px);
  border:1px solid rgba(255,255,255,.12);border-radius:99px;
  padding:6px 14px;font-size:.7rem;font-weight:700;
  display:flex;align-items:center;gap:5px;pointer-events:all;cursor:pointer;color:white;}
.ms-dot{width:7px;height:7px;border-radius:50%;flex-shrink:0;}
body.lm .ms-chip{background:rgba(255,255,255,.88);color:#000;}

/* ‚ïê‚ïê ZONE LEGEND ‚Äî compact, hidden by default ‚ïê‚ïê */
#zoneLegend{position:fixed;left:12px;z-index:450;background:rgba(10,14,22,.92);
  backdrop-filter:blur(20px);border:1px solid rgba(255,255,255,.08);
  border-radius:16px;padding:12px 15px;display:none;min-width:155px;}
body.lm #zoneLegend{background:rgba(255,255,255,.95);color:#000;}
.zl-title{font-size:.6rem;font-weight:800;color:var(--muted);text-transform:uppercase;letter-spacing:.06em;margin-bottom:8px;}
.zl-row{display:flex;align-items:center;gap:7px;margin-bottom:5px;font-size:.72rem;font-weight:600;}
.zl-dot{width:10px;height:10px;border-radius:50%;flex-shrink:0;}
.zl-tag{font-size:.6rem;color:var(--muted);margin-left:auto;}

/* ‚ïê‚ïê UBER BOTTOM SHEET ‚ïê‚ïê */
.sheet{position:fixed;bottom:0;left:0;right:0;z-index:400;
  background:#0a0e16;
  border-radius:24px 24px 0 0;
  border-top:1px solid rgba(255,255,255,.06);
  padding:0 18px 38px;
  max-height:58vh;        /* ‚Üê KEY: never cover more than 58% of screen */
  overflow-y:auto;display:none;
  box-shadow:0 -8px 40px rgba(0,0,0,.6);}
.sheet::-webkit-scrollbar{display:none;}
body.lm .sheet{background:#f8fafd;border-top:1px solid rgba(0,0,0,.05);}
.hdl{width:36px;height:4px;background:rgba(255,255,255,.12);border-radius:4px;margin:12px auto 16px;}
body.lm .hdl{background:rgba(0,0,0,.1);}

/* ‚ïê‚ïê SEARCH BAR inside sheet ‚Äî Uber style ‚ïê‚ïê */
.lbs{display:flex;flex-direction:column;margin-bottom:10px;}
.lb{display:flex;align-items:center;gap:12px;
  background:rgba(255,255,255,.05);
  border:1.5px solid rgba(255,255,255,.07);padding:13px 14px;transition:all .2s;}
.lb:first-child{border-radius:14px 14px 0 0;border-bottom:none;}
.lb:last-child{border-radius:0 0 14px 14px;border-bottom-width:1.5px;}
.lb:last-child:focus-within{border-color:var(--yellow);}
body.lm .lb{background:rgba(0,0,0,.04);border-color:rgba(0,0,0,.08);}

/* ‚ïê‚ïê MAPPLS AUTOCOMPLETE DROPDOWN ‚ïê‚ïê */
#dropSuggest{
  position:absolute;left:0;right:0;
  background:#0d1525;
  border:1px solid rgba(255,255,255,.1);
  border-radius:0 0 16px 16px;
  max-height:220px;overflow-y:auto;
  z-index:9999;
  box-shadow:0 12px 40px rgba(0,0,0,.7);
  display:none;
}
body.lm #dropSuggest{background:#fff;border-color:rgba(0,0,0,.1);}
#dropSuggest::-webkit-scrollbar{display:none;}
.sug-item{display:flex;align-items:center;gap:10px;padding:11px 14px;cursor:pointer;
  border-bottom:1px solid rgba(255,255,255,.04);transition:background .15s;}
.sug-item:last-child{border-bottom:none;}
.sug-item:active,.sug-item:hover{background:rgba(245,158,11,.1);}
body.lm .sug-item:hover{background:#f5f8ff;}
.sug-icon{width:30px;height:30px;border-radius:8px;background:rgba(255,255,255,.06);
  display:flex;align-items:center;justify-content:center;font-size:.9rem;flex-shrink:0;}
.sug-main{font-size:.82rem;font-weight:700;color:var(--text);}
.sug-sub{font-size:.66rem;color:var(--muted);margin-top:1px;}
.sug-dist{font-size:.65rem;color:var(--yellow);font-weight:700;margin-left:auto;flex-shrink:0;}

/* Wrap the drop input lb for positioning */
#dropLbWrap{position:relative;}

/* ‚ïê‚ïê QUICK PLACES SCROLL ‚ïê‚ïê */
.qp-label{font-size:.6rem;font-weight:800;color:var(--muted);
  text-transform:uppercase;letter-spacing:.06em;margin-bottom:8px;}
.qp-scroll{display:flex;gap:8px;overflow-x:auto;padding-bottom:4px;margin-bottom:10px;}
.qp-scroll::-webkit-scrollbar{display:none;}
.qp-chip{flex-shrink:0;background:rgba(255,255,255,.06);border:1px solid rgba(255,255,255,.09);
  border-radius:99px;padding:7px 14px;font-size:.75rem;font-weight:700;
  cursor:pointer;white-space:nowrap;transition:all .18s;}
.qp-chip:active{background:rgba(245,158,11,.15);border-color:var(--yellow);}
body.lm .qp-chip{background:#f0f4ff;border-color:#dde5f0;}

/* ‚ïê‚ïê FIND DRIVER BUTTON ‚Äî Uber yellow ‚ïê‚ïê */
.mbtn{width:100%;border:none;border-radius:16px;padding:16px;
  font-size:.96rem;font-weight:900;cursor:pointer;margin-top:8px;
  font-family:'Syne',sans-serif;transition:transform .1s,box-shadow .2s;}
.mbtn:active{transform:scale(.97);}
.mbtn.y{background:var(--yellow);color:#000;
  box-shadow:0 6px 24px rgba(245,158,11,.4),0 2px 8px rgba(245,158,11,.2);}
.mbtn.ro{background:rgba(239,68,68,.08);color:var(--red);border:1px solid rgba(239,68,68,.2);}
.mbtn.g{background:var(--green);color:#fff;box-shadow:0 6px 24px rgba(16,185,129,.35);}
.mbtn.b{background:var(--blue);color:#fff;}

/* ‚ïê‚ïê MARKERS ‚ïê‚ïê */
.my-loc-wrap{position:relative;width:24px;height:24px;display:flex;align-items:center;justify-content:center;}
.my-loc-dot{width:13px;height:13px;background:#3b82f6;border:2.5px solid #fff;border-radius:50%;z-index:2;position:relative;box-shadow:0 0 0 0 rgba(59,130,246,.5);animation:locpulse 2s infinite;}
.my-loc-wave{position:absolute;width:24px;height:24px;border:2px solid rgba(59,130,246,.4);border-radius:50%;animation:locwave 2s infinite;}
@keyframes locpulse{0%{box-shadow:0 0 0 0 rgba(59,130,246,.7)}70%{box-shadow:0 0 0 12px rgba(59,130,246,0)}100%{box-shadow:0 0 0 0 rgba(59,130,246,0)}}
@keyframes locwave{0%{transform:scale(.7);opacity:1}100%{transform:scale(2.2);opacity:0}}

.driver-dot-wrap{position:relative;display:flex;flex-direction:column;align-items:center;}
.driver-car{font-size:22px;line-height:1;filter:drop-shadow(0 3px 6px rgba(0,0,0,.8));animation:carfloat 3s ease-in-out infinite;}
.driver-dot-shadow{width:10px;height:3px;background:rgba(0,0,0,.5);border-radius:50%;margin-top:1px;}
@keyframes carfloat{0%,100%{transform:translateY(0) scale(1)}50%{transform:translateY(-3px) scale(1.05)}}

.assigned-car{font-size:30px;line-height:1;filter:drop-shadow(0 4px 10px rgba(245,158,11,.6));animation:assignedcar 1s ease-in-out infinite;}
@keyframes assignedcar{0%,100%{transform:scale(1)}50%{transform:scale(1.12)}}

.pickup-wrap{display:flex;flex-direction:column;align-items:center;}
.pickup-icon{font-size:28px;filter:drop-shadow(0 3px 8px rgba(16,185,129,.6));}
.drop-icon{font-size:28px;filter:drop-shadow(0 3px 8px rgba(239,68,68,.6));}
.landmark-icon{font-size:18px;opacity:.85;}

/* ‚ïê‚ïê LIVE MAP OVERLAY BADGES ‚ïê‚ïê */
#mapStats{position:fixed;top:60px;left:12px;right:12px;z-index:450;display:none;pointer-events:none;}
.ms-row{display:flex;gap:7px;justify-content:center;}
.ms-chip{background:rgba(7,9,15,.88);backdrop-filter:blur(12px);border:1px solid rgba(255,255,255,.1);border-radius:99px;padding:5px 12px;font-size:.68rem;font-weight:700;display:flex;align-items:center;gap:5px;pointer-events:all;cursor:pointer;}
.ms-dot{width:7px;height:7px;border-radius:50%;flex-shrink:0;}
body.lm .ms-chip{background:rgba(255,255,255,.92);color:#000;}

/* ‚ïê‚ïê ZONE LEGEND ‚ïê‚ïê */
#zoneLegend{position:fixed;left:12px;z-index:450;background:rgba(7,9,15,.9);backdrop-filter:blur(14px);border:1px solid rgba(255,255,255,.1);border-radius:13px;padding:10px 13px;display:none;min-width:145px;}
body.lm #zoneLegend{background:rgba(255,255,255,.95);color:#000;}
.zl-title{font-size:.6rem;font-weight:800;color:var(--muted);text-transform:uppercase;letter-spacing:.06em;margin-bottom:7px;}
.zl-row{display:flex;align-items:center;gap:7px;margin-bottom:5px;font-size:.7rem;font-weight:600;}
.zl-dot{width:10px;height:10px;border-radius:50%;flex-shrink:0;}
.zl-tag{font-size:.58rem;color:var(--muted);margin-left:auto;}

/* ‚ïê‚ïê DEMAND SURGE BANNER ‚ïê‚ïê */
#surgeBanner{position:fixed;top:0;left:0;right:0;z-index:600;background:linear-gradient(135deg,#f59e0b,#f97316);padding:7px 16px;text-align:center;font-size:.75rem;font-weight:800;color:#000;display:none;animation:surgeIn .4s ease;}
@keyframes surgeIn{from{transform:translateY(-100%)}to{transform:translateY(0)}}

/* ‚ïê‚ïê LOADER ‚ïê‚ïê */
#loader{position:fixed;inset:0;background:var(--bg);z-index:9999;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:16px;}
.ld-box{width:82px;height:82px;background:var(--yellow);border-radius:20px;display:flex;align-items:center;justify-content:center;font-family:'Syne',sans-serif;font-size:1.35rem;font-weight:900;color:#000;animation:ldp 2s infinite;}
@keyframes ldp{0%,100%{box-shadow:0 0 36px rgba(245,158,11,.45)}50%{box-shadow:0 0 72px rgba(245,158,11,.9)}}
.ld-t{font-family:'Syne',sans-serif;font-size:1.5rem;font-weight:900;letter-spacing:.06em;}
.ld-s{font-size:.75rem;color:var(--muted);text-align:center;}
.ld-bar-w{width:180px;height:3px;background:rgba(255,255,255,.07);border-radius:99px;overflow:hidden;}
.ld-bar{height:100%;width:0%;background:linear-gradient(90deg,var(--yellow),#f97316);border-radius:99px;transition:width .25s;}

/* ‚ïê‚ïê AUTH ‚ïê‚ïê */
#auth{position:fixed;inset:0;z-index:8000;display:none;flex-direction:column;background:var(--bg);overflow-y:auto;}
#auth::-webkit-scrollbar{display:none;}
.ah{position:relative;height:195px;overflow:hidden;flex-shrink:0;}
.ah img{width:100%;height:100%;object-fit:cover;opacity:.3;}
.ah-ov{position:absolute;inset:0;background:linear-gradient(to bottom,rgba(7,9,15,.05),rgba(7,9,15,1));display:flex;flex-direction:column;justify-content:flex-end;padding:20px;}
.ah-tag{display:inline-flex;align-items:center;gap:5px;background:rgba(245,158,11,.15);border:1px solid rgba(245,158,11,.3);border-radius:99px;padding:3px 10px;font-size:.62rem;font-weight:700;color:var(--yellow);margin-bottom:6px;}
.ab{padding:0 16px 48px;}
.rtog{display:flex;gap:4px;background:rgba(255,255,255,.04);border:1px solid var(--border);border-radius:13px;padding:4px;margin-bottom:14px;}
.rtab{flex:1;padding:11px;border-radius:9px;border:none;background:transparent;color:var(--muted);font-weight:700;cursor:pointer;font-size:.87rem;font-family:'DM Sans',sans-serif;}
.rtab.ar{background:var(--yellow);color:#000;}
.rtab.ad{background:var(--green);color:#fff;}
.atabs{display:flex;gap:4px;background:rgba(255,255,255,.04);border:1px solid var(--border);border-radius:11px;padding:4px;margin-bottom:16px;}
.atab{flex:1;padding:9px;border-radius:8px;border:none;background:transparent;color:var(--muted);font-weight:700;cursor:pointer;font-family:'DM Sans',sans-serif;}
.atab.on{background:var(--card2);color:var(--text);}
.afrm{display:none;}.afrm.sh{display:block;animation:fup .3s ease;}
@keyframes fup{from{opacity:0;transform:translateY(14px)}to{opacity:1;transform:translateY(0)}}
.fg{margin-bottom:12px;}
.fl{font-size:.65rem;font-weight:700;color:var(--muted);margin-bottom:5px;display:block;text-transform:uppercase;letter-spacing:.05em;}
.fi{width:100%;background:rgba(255,255,255,.04);border:1.5px solid var(--border);border-radius:11px;padding:12px 14px;color:var(--text);outline:none;font-family:'DM Sans',sans-serif;font-size:.9rem;transition:border-color .2s;}
.fi:focus{border-color:var(--yellow);}
.fi.gf:focus{border-color:var(--green);}
body.lm .fi{background:#fff;color:#0c1929;}
.fr{display:grid;grid-template-columns:1fr 1fr;gap:10px;}
.vg{display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-bottom:12px;}
.vc{background:rgba(255,255,255,.04);border:1.5px solid var(--border);border-radius:11px;padding:11px;text-align:center;cursor:pointer;transition:all .2s;}
.vc.on{border-color:var(--green);background:rgba(16,185,129,.08);}
.asub{width:100%;border:none;border-radius:13px;padding:15px;font-size:.94rem;font-weight:800;cursor:pointer;font-family:'Syne',sans-serif;}
.asub.y{background:var(--yellow);color:#000;}
.asub.g{background:var(--green);color:#fff;}
.fbb{display:inline-flex;align-items:center;gap:5px;border-radius:99px;padding:4px 11px;font-size:.63rem;font-weight:700;margin-bottom:13px;background:rgba(255,165,0,.1);border:1px solid rgba(255,165,0,.2);color:orange;}
.fbb.ok{background:rgba(16,185,129,.1);border-color:rgba(16,185,129,.2);color:var(--green);}
.fbb.er{background:rgba(239,68,68,.1);border-color:rgba(239,68,68,.2);color:var(--red);}
.eb{background:rgba(239,68,68,.1);border:1px solid rgba(239,68,68,.25);border-radius:11px;padding:10px 13px;font-size:.78rem;font-weight:600;color:var(--red);margin-bottom:11px;display:none;}

/* ‚ïê‚ïê TOP BAR ‚ïê‚ïê */
.tb{position:fixed;top:0;left:0;right:0;z-index:500;display:flex;justify-content:space-between;align-items:center;padding:11px 15px;background:linear-gradient(to bottom,rgba(0,0,0,.8) 0%,transparent 100%);}
.tbtn{height:36px;background:rgba(0,0,0,.58);border:1px solid rgba(255,255,255,.12);border-radius:9px;display:flex;align-items:center;justify-content:center;cursor:pointer;padding:0 11px;font-size:.76rem;font-weight:700;color:var(--text);gap:5px;backdrop-filter:blur(10px);}
body.lm .tbtn{background:rgba(255,255,255,.88);color:#000;}
.locbtn{position:fixed;right:15px;z-index:500;width:44px;height:44px;background:white;border-radius:50%;border:none;cursor:pointer;font-size:1.05rem;box-shadow:0 4px 18px rgba(0,0,0,.4);display:flex;align-items:center;justify-content:center;}

/* ‚ïê‚ïê SHEETS ‚ïê‚ïê */
.sheet{position:fixed;bottom:0;left:0;right:0;z-index:400;background:rgba(7,9,15,.97);backdrop-filter:blur(32px);border-radius:22px 22px 0 0;border-top:1px solid rgba(255,255,255,.07);padding:0 17px 34px;max-height:88vh;overflow-y:auto;display:none;}
.sheet::-webkit-scrollbar{display:none;}
body.lm .sheet{background:rgba(240,244,251,.97);}
.hdl{width:34px;height:4px;background:rgba(255,255,255,.1);border-radius:4px;margin:11px auto 17px;}
body.lm .hdl{background:rgba(0,0,0,.1);}

/* ‚ïê‚ïê SCREENS ‚ïê‚ïê */
.scr{display:none;}.scr.on{display:block;animation:fup .3s ease;}
.mbtn{width:100%;border:none;border-radius:14px;padding:15px;font-size:.94rem;font-weight:800;cursor:pointer;margin-top:9px;font-family:'Syne',sans-serif;transition:transform .1s,box-shadow .2s;}
.mbtn:active{transform:scale(.97);}
.mbtn.y{background:var(--yellow);color:#000;box-shadow:0 5px 20px rgba(245,158,11,.35);}
.mbtn.ro{background:rgba(239,68,68,.08);color:var(--red);border:1px solid rgba(239,68,68,.2);}
.mbtn.g{background:var(--green);color:#fff;box-shadow:0 5px 20px rgba(16,185,129,.3);}
.mbtn.b{background:var(--blue);color:#fff;}

/* ‚ïê‚ïê LOCATION BOXES ‚ïê‚ïê */
.lbs{display:flex;flex-direction:column;margin-bottom:11px;}
.lb{display:flex;align-items:center;gap:11px;background:rgba(255,255,255,.04);border:1.5px solid var(--border);padding:12px 13px;transition:all .2s;}
.lb:first-child{border-radius:13px 13px 0 0;border-bottom:none;}
.lb:last-child{border-radius:0 0 13px 13px;}
.lb:last-child:focus-within{border-color:var(--yellow);}
body.lm .lb{background:rgba(0,0,0,.03);}
.pdot{width:10px;height:10px;background:var(--green);border-radius:50%;flex-shrink:0;animation:dpulse 2s infinite;}
@keyframes dpulse{0%,100%{box-shadow:0 0 5px var(--green)}50%{box-shadow:0 0 14px var(--green)}}
.lspin{width:9px;height:9px;border:2px solid rgba(16,185,129,.3);border-top:2px solid var(--green);border-radius:50%;animation:spin .8s linear infinite;flex-shrink:0;}
@keyframes spin{to{transform:rotate(360deg)}}

/* ‚ïê‚ïê QUICK PLACES ‚ïê‚ïê */
.qp-label{font-size:.6rem;font-weight:700;color:var(--muted);text-transform:uppercase;letter-spacing:.06em;margin-bottom:7px;}
.qp-scroll{display:flex;gap:7px;overflow-x:auto;padding-bottom:6px;margin-bottom:12px;}
.qp-scroll::-webkit-scrollbar{display:none;}
.qp-chip{flex-shrink:0;background:rgba(255,255,255,.05);border:1px solid var(--border);border-radius:10px;padding:7px 11px;font-size:.74rem;font-weight:700;cursor:pointer;white-space:nowrap;transition:all .2s;}
.qp-chip:active{background:rgba(245,158,11,.12);border-color:var(--yellow);}
body.lm .qp-chip{background:#f1f5f9;}

/* ‚ïê‚ïê CHIPS ‚ïê‚ïê */
.chips{display:flex;gap:7px;margin-bottom:13px;}
.chip{flex:1;background:rgba(255,255,255,.04);border:1px solid var(--border);border-radius:11px;padding:9px 7px;text-align:center;}
body.lm .chip{background:#f1f5f9;}
.cv{font-weight:800;font-size:.97rem;font-family:'Syne',sans-serif;}
.cl{font-size:.58rem;font-weight:600;color:var(--muted);margin-top:2px;text-transform:uppercase;letter-spacing:.04em;}

/* ‚ïê‚ïê SURGE CHIP ‚ïê‚ïê */
.surge-chip{display:inline-flex;align-items:center;gap:4px;background:rgba(239,68,68,.1);border:1px solid rgba(239,68,68,.3);border-radius:99px;padding:3px 9px;font-size:.64rem;font-weight:800;color:var(--red);margin-bottom:10px;}

/* ‚ïê‚ïê RIDE OPTIONS ‚ïê‚ïê */
.ro-card{display:flex;align-items:center;padding:13px;background:rgba(255,255,255,.04);border:1.5px solid var(--border);border-radius:13px;margin-bottom:8px;cursor:pointer;transition:all .2s;}
.ro-card.sel{background:rgba(245,158,11,.06);border-color:var(--yellow);}
body.lm .ro-card{background:#fff;}
.ro-surge{font-size:.6rem;font-weight:800;background:rgba(239,68,68,.15);border:1px solid rgba(239,68,68,.3);color:var(--red);padding:2px 6px;border-radius:99px;margin-left:5px;}

/* ‚ïê‚ïê NEARBY DRIVERS PANEL ‚ïê‚ïê */
.nd-panel{background:rgba(255,255,255,.03);border:1px solid var(--border);border-radius:13px;padding:12px;margin-bottom:12px;}
.nd-row{display:flex;align-items:center;justify-content:space-between;margin-bottom:8px;}
.nd-title{font-size:.72rem;font-weight:800;color:var(--muted);text-transform:uppercase;letter-spacing:.05em;}
.nd-count{font-family:'Syne',sans-serif;font-weight:900;font-size:1.3rem;color:var(--green);}
.nd-bars{display:flex;gap:4px;align-items:flex-end;height:28px;}
.nd-bar{width:8px;background:rgba(16,185,129,.25);border-radius:3px;transition:height .4s ease;}
.nd-bar.active{background:var(--green);}
.nd-zone-row{display:flex;gap:6px;flex-wrap:wrap;margin-top:6px;}
.nd-zone{font-size:.64rem;font-weight:700;padding:3px 8px;border-radius:99px;}
.nd-zone.z1{background:rgba(16,185,129,.12);color:var(--green);border:1px solid rgba(16,185,129,.25);}
.nd-zone.z2{background:rgba(59,130,246,.12);color:var(--blue);border:1px solid rgba(59,130,246,.25);}
.nd-zone.z3{background:rgba(245,158,11,.12);color:var(--yellow);border:1px solid rgba(245,158,11,.25);}

/* ‚ïê‚ïê RADAR ‚ïê‚ïê */
.rdr{text-align:center;padding:20px 0;}
.rdr-rings{position:relative;width:90px;height:90px;margin:0 auto 16px;}
.r1{position:absolute;inset:0;border:2px solid rgba(245,158,11,.1);border-radius:50%;}
.r2{position:absolute;inset:10px;border:2px solid rgba(245,158,11,.18);border-radius:50%;}
.r3{position:absolute;inset:20px;border:3px solid transparent;border-top:3px solid var(--yellow);border-radius:50%;animation:spin .9s linear infinite;}
.r4{position:absolute;inset:34px;background:var(--yellow);border-radius:50%;box-shadow:0 0 16px rgba(245,158,11,.9);}
.r4-inner{position:absolute;inset:42px;background:rgba(245,158,11,.3);border-radius:50%;animation:rdpulse 1.2s ease-out infinite;}
@keyframes rdpulse{0%{transform:scale(1);opacity:1}100%{transform:scale(2.5);opacity:0}}

/* ‚ïê‚ïê DRIVER CARD ‚ïê‚ïê */
.dcard{display:flex;align-items:center;gap:13px;margin-bottom:14px;padding:13px;background:rgba(255,255,255,.03);border:1px solid var(--border);border-radius:15px;}
body.lm .dcard{background:#fff;}
.dava{width:52px;height:52px;background:linear-gradient(135deg,#1e2d4a,#253a5e);border-radius:50%;font-size:1.9rem;display:flex;align-items:center;justify-content:center;flex-shrink:0;}
.otp{background:var(--card2);padding:8px 11px;border-radius:10px;border:1px solid var(--border);text-align:center;min-width:65px;}
.star-row{display:flex;align-items:center;gap:3px;}
.star{color:var(--yellow);font-size:.8rem;}

/* ‚ïê‚ïê LIVE BADGE ‚ïê‚ïê */
.lbadge{display:flex;align-items:center;gap:7px;padding:8px 12px;border-radius:9px;margin-bottom:11px;font-size:.76rem;font-weight:600;}
.lbadge.g{background:rgba(16,185,129,.08);border:1px solid rgba(16,185,129,.2);color:var(--green);}
.lbadge.r{background:rgba(239,68,68,.08);border:1px solid rgba(239,68,68,.2);color:var(--red);}
.lbadge.b{background:rgba(59,130,246,.08);border:1px solid rgba(59,130,246,.2);color:var(--blue);}
.lbadge.o{background:rgba(249,115,22,.08);border:1px solid rgba(249,115,22,.2);color:var(--orange);}
.lbd{width:7px;height:7px;border-radius:50%;flex-shrink:0;}
.lbadge.g .lbd{background:var(--green);box-shadow:0 0 6px var(--green);}
.lbadge.r .lbd{background:var(--red);box-shadow:0 0 6px var(--red);}
.lbadge.b .lbd{background:var(--blue);box-shadow:0 0 6px var(--blue);animation:dpulse 1.5s infinite;}
.lbadge.o .lbd{background:var(--orange);box-shadow:0 0 6px var(--orange);animation:dpulse 1s infinite;}

/* ‚ïê‚ïê DRIVER DASHBOARD ‚ïê‚ïê */
#dTopBar{position:fixed;top:0;left:0;right:0;z-index:500;display:none;padding:11px 15px;background:linear-gradient(to bottom,rgba(0,0,0,.85),transparent);}
.d-nr{display:flex;align-items:center;justify-content:space-between;}
.d-nm{font-family:'Syne',sans-serif;font-weight:800;font-size:.92rem;color:white;}
.tgsw{position:relative;width:52px;height:27px;cursor:pointer;}
.tgsw input{opacity:0;width:0;height:0;}
.tgtr{position:absolute;inset:0;background:#2d3748;border-radius:99px;transition:background .3s;border:1.5px solid rgba(255,255,255,.08);}
.tgsw input:checked+.tgtr{background:var(--green);}
.tgth{position:absolute;height:19px;width:19px;left:4px;top:50%;transform:translateY(-50%);background:white;border-radius:50%;transition:transform .3s;box-shadow:0 2px 5px rgba(0,0,0,.3);}
.tgsw input:checked~.tgth{transform:translateY(-50%) translateX(25px);}

#dStats{position:fixed;top:62px;left:0;right:0;z-index:499;display:none;padding:0 13px;}
.dsr{display:flex;gap:7px;}
.dst{background:rgba(7,9,15,.9);backdrop-filter:blur(14px);border:1px solid rgba(255,255,255,.08);border-radius:11px;padding:9px 10px;flex:1;text-align:center;}
.dsv{font-family:'Syne',sans-serif;font-weight:800;font-size:.92rem;color:var(--yellow);}
.dsl{font-size:.55rem;color:var(--muted);font-weight:600;text-transform:uppercase;margin-top:1px;letter-spacing:.04em;}

/* ‚ïê‚ïê DRIVER PANELS ‚ïê‚ïê */
#dPanel{position:fixed;bottom:0;left:0;right:0;z-index:400;display:none;}
#dOff,#dOn,#dNav{background:rgba(7,9,15,.97);backdrop-filter:blur(28px);border-radius:22px 22px 0 0;border-top:1px solid rgba(255,255,255,.07);padding:18px 17px 32px;}
body.lm #dOff,body.lm #dOn,body.lm #dNav{background:rgba(240,244,251,.97);}
#dOff{text-align:center;}
#dOn,#dNav{display:none;}
.opulse{display:flex;align-items:center;gap:9px;background:rgba(16,185,129,.08);border:1px solid rgba(16,185,129,.2);border-radius:13px;padding:13px;margin-bottom:12px;}
.odpulse{width:9px;height:9px;background:var(--green);border-radius:50%;flex-shrink:0;animation:oping 1.8s infinite;}
@keyframes oping{0%{box-shadow:0 0 0 0 rgba(16,185,129,.5)}70%{box-shadow:0 0 0 9px rgba(16,185,129,0)}100%{box-shadow:0 0 0 0 rgba(16,185,129,0)}}

/* ‚ïê‚ïê DRIVER ZONE STATS ‚ïê‚ïê */
.dzone-row{display:grid;grid-template-columns:1fr 1fr;gap:7px;margin-bottom:10px;}
.dzone-card{background:rgba(255,255,255,.04);border:1px solid var(--border);border-radius:11px;padding:9px;text-align:center;}
.dzone-val{font-family:'Syne',sans-serif;font-weight:800;font-size:1.05rem;}
.dzone-lbl{font-size:.58rem;color:var(--muted);font-weight:700;margin-top:2px;text-transform:uppercase;letter-spacing:.04em;}

/* ‚ïê‚ïê REQUEST POPUP ‚ïê‚ïê */
#reqPopup{position:fixed;bottom:-110%;left:0;right:0;z-index:700;transition:bottom .45s cubic-bezier(.34,1.56,.64,1);}
#reqPopup.sh{bottom:0;}
.rpc{background:var(--bg);border-radius:26px 26px 0 0;border-top:1px solid rgba(255,255,255,.12);padding:18px 17px 34px;box-shadow:0 -16px 60px rgba(0,0,0,.7);}
body.lm .rpc{background:#fff;}
.rtring{position:relative;width:60px;height:60px;margin:0 auto 13px;}
.rtsvg{transform:rotate(-90deg);}
.rtcbg{fill:none;stroke:rgba(255,255,255,.07);stroke-width:5;}
.rtc{fill:none;stroke:var(--yellow);stroke-width:5;stroke-linecap:round;stroke-dasharray:163;stroke-dashoffset:0;transition:stroke-dashoffset 1s linear;}
.rtn{position:absolute;inset:0;display:flex;align-items:center;justify-content:center;font-family:'Syne',sans-serif;font-weight:900;font-size:1.25rem;color:var(--yellow);}
.trip-row{display:flex;align-items:stretch;gap:11px;margin:12px 0;}
.tdots{display:flex;flex-direction:column;align-items:center;gap:3px;padding-top:4px;}
.tdg{width:8px;height:8px;background:var(--green);border-radius:50%;flex-shrink:0;}
.tdl{width:2px;flex:1;background:rgba(255,255,255,.09);}
.tdr{width:8px;height:8px;background:var(--red);border-radius:50%;flex-shrink:0;}
.tadd{flex:1;}
.ta-row{padding:6px 0;border-bottom:1px solid rgba(255,255,255,.05);}
.ta-row:last-child{border-bottom:none;padding-bottom:0;}
.ta-lbl{font-size:.6rem;color:var(--muted);font-weight:700;text-transform:uppercase;letter-spacing:.04em;}
.ta-val{font-size:.86rem;font-weight:700;margin-top:2px;}
.req-btns{display:grid;grid-template-columns:1fr 1.6fr;gap:9px;margin-top:13px;}
.dist-badge{display:inline-flex;align-items:center;gap:4px;background:rgba(59,130,246,.12);border:1px solid rgba(59,130,246,.25);border-radius:99px;padding:3px 9px;font-size:.66rem;font-weight:700;color:var(--blue);}

/* ‚ïê‚ïê NAV ‚ïê‚ïê */
.nstep{display:flex;align-items:center;gap:11px;border-radius:13px;padding:11px 13px;margin-bottom:10px;}
.nstep.bl{background:rgba(59,130,246,.08);border:1px solid rgba(59,130,246,.2);}
.nstep.gr{background:rgba(16,185,129,.08);border:1px solid rgba(16,185,129,.2);}
.nicon{width:38px;height:38px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:1.1rem;flex-shrink:0;}
.nstep.bl .nicon{background:rgba(59,130,246,.15);}
.nstep.gr .nicon{background:rgba(16,185,129,.15);}

/* ‚ïê‚ïê TOAST ‚ïê‚ïê */
.toast{position:fixed;top:80px;left:50%;transform:translateX(-50%);background:rgba(10,15,24,.97);border:1px solid rgba(255,255,255,.1);border-radius:99px;padding:9px 20px;font-size:.78rem;font-weight:600;z-index:9999;animation:tin .3s ease,tout .3s ease 2.6s forwards;white-space:nowrap;box-shadow:0 6px 24px rgba(0,0,0,.45);max-width:88vw;text-overflow:ellipsis;overflow:hidden;}
@keyframes tin{from{opacity:0;top:60px}to{opacity:1;top:80px}}
@keyframes tout{to{opacity:0;top:60px}}

/* ‚ïê‚ïê NET ‚ïê‚ïê */
.netb{position:fixed;bottom:0;left:50%;transform:translateX(-50%);z-index:9998;background:#ef4444;color:#fff;padding:5px 16px;font-size:.73rem;font-weight:700;border-radius:99px 99px 0 0;display:none;}

/* ‚ïê‚ïê ASSIGNED ANIMATION ‚ïê‚ïê */
@keyframes assignBounce{0%{transform:scale(1)}20%{transform:scale(1.05)}40%{transform:scale(.98)}60%{transform:scale(1.03)}80%{transform:scale(.99)}100%{transform:scale(1)}}
.assign-bounce{animation:assignBounce .6s ease;}

/* ‚ïê‚ïê DRIVER PHOTO UPLOAD ‚ïê‚ïê */
.photo-upload-box{display:flex;flex-direction:column;align-items:center;gap:10px;background:rgba(255,255,255,.03);border:2px dashed rgba(16,185,129,.35);border-radius:16px;padding:16px;margin-bottom:13px;cursor:pointer;transition:all .2s;}
.photo-upload-box:hover,.photo-upload-box.has-photo{border-color:var(--green);background:rgba(16,185,129,.05);}
.photo-preview{width:80px;height:80px;border-radius:50%;object-fit:cover;border:3px solid var(--green);display:none;box-shadow:0 4px 16px rgba(16,185,129,.35);}
.photo-placeholder{width:80px;height:80px;border-radius:50%;background:rgba(255,255,255,.07);display:flex;align-items:center;justify-content:center;font-size:2rem;border:2px solid rgba(255,255,255,.1);}
.photo-upload-lbl{font-size:.75rem;font-weight:700;color:var(--green);}
.photo-upload-sub{font-size:.62rem;color:var(--muted);text-align:center;}
/* Driver photo in rider panel */
.dava-photo{width:52px;height:52px;border-radius:50%;object-fit:cover;border:2.5px solid var(--green);box-shadow:0 3px 12px rgba(16,185,129,.3);flex-shrink:0;}
.dava-verified{position:relative;flex-shrink:0;}
.dava-verified::after{content:'‚úÖ';position:absolute;bottom:-2px;right:-4px;font-size:.65rem;background:var(--card);border-radius:50%;padding:1px;}

/* ‚ïê‚ïê NEW FEATURES CSS ‚ïê‚ïê */
#histModal,#ratingModal,#receiptModal,#cancelModal,#msgModal,#promoModal{position:fixed;inset:0;z-index:9500;background:rgba(0,0,0,.82);display:none;align-items:flex-end;justify-content:center;backdrop-filter:blur(4px);}
#histModal.sh,#ratingModal.sh,#receiptModal.sh,#cancelModal.sh,#msgModal.sh,#promoModal.sh{display:flex;animation:fup .3s ease;}
.modal-box{background:var(--bg);border-radius:26px 26px 0 0;border-top:1px solid rgba(255,255,255,.1);padding:20px 18px 44px;width:100%;max-width:500px;max-height:88vh;overflow-y:auto;}
.modal-box::-webkit-scrollbar{display:none;}
body.lm .modal-box{background:#f0f4fb;}
.modal-hd{display:flex;align-items:center;justify-content:space-between;margin-bottom:16px;}
.modal-title{font-family:'Syne',sans-serif;font-weight:900;font-size:1.05rem;}
.modal-close{width:32px;height:32px;background:rgba(255,255,255,.07);border:none;border-radius:50%;cursor:pointer;font-size:1.1rem;color:var(--muted);}
.hist-item{display:flex;align-items:center;gap:12px;padding:11px 0;border-bottom:1px solid var(--border);}
.hist-item:last-child{border-bottom:none;}
.hist-icon{width:42px;height:42px;border-radius:50%;background:rgba(245,158,11,.1);border:1px solid rgba(245,158,11,.2);display:flex;align-items:center;justify-content:center;font-size:1.2rem;flex-shrink:0;}
.hist-info{flex:1;min-width:0;}
.hist-route{font-weight:700;font-size:.84rem;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
.hist-meta{font-size:.67rem;color:var(--muted);margin-top:2px;}
.hist-fare{font-family:'Syne',sans-serif;font-weight:900;font-size:.95rem;color:var(--yellow);}
.hist-tag{font-size:.6rem;font-weight:800;padding:2px 8px;border-radius:99px;display:inline-block;margin-top:3px;}
.hist-tag.done{background:rgba(16,185,129,.12);color:var(--green);}
.hist-tag.cancel{background:rgba(239,68,68,.12);color:var(--red);}
.star-big{font-size:2.4rem;cursor:pointer;transition:transform .15s;filter:grayscale(1);opacity:.4;display:inline-block;}
.star-big.lit{filter:none;opacity:1;}
.star-big:active{transform:scale(1.3);}
.rcpt-row{display:flex;justify-content:space-between;align-items:center;padding:8px 0;border-bottom:1px solid var(--border);font-size:.83rem;}
.rcpt-row:last-child{border-bottom:none;}
.fav-row{display:grid;grid-template-columns:1fr 1fr;gap:9px;margin-bottom:12px;}
.fav-chip{display:flex;align-items:center;gap:8px;background:rgba(255,255,255,.04);border:1.5px solid var(--border);border-radius:13px;padding:10px 12px;cursor:pointer;transition:all .2s;}
.fav-chip.set{border-color:var(--yellow);background:rgba(245,158,11,.07);}
body.lm .fav-chip{background:#fff;}
#sosBtn{position:fixed;right:14px;z-index:700;width:50px;height:50px;background:var(--red);border-radius:50%;border:3px solid rgba(255,255,255,.3);cursor:pointer;font-size:1.2rem;display:none;align-items:center;justify-content:center;box-shadow:0 0 0 0 rgba(239,68,68,.7);animation:sosPulse 2s infinite;}
@keyframes sosPulse{0%{box-shadow:0 0 0 0 rgba(239,68,68,.7)}70%{box-shadow:0 0 0 16px rgba(239,68,68,0)}100%{box-shadow:0 0 0 0 rgba(239,68,68,0)}}
.qmsg-chip{display:inline-flex;align-items:center;gap:5px;background:rgba(255,255,255,.05);border:1px solid var(--border);border-radius:99px;padding:7px 13px;font-size:.76rem;font-weight:600;cursor:pointer;margin:4px;}
.qmsg-chip:active{background:rgba(59,130,246,.15);border-color:var(--blue);}
.promo-strip{background:linear-gradient(135deg,rgba(139,92,246,.12),rgba(59,130,246,.1));border:1px solid rgba(139,92,246,.3);border-radius:13px;padding:10px 13px;margin-bottom:11px;display:flex;align-items:center;gap:10px;cursor:pointer;}
.promo-tag{background:var(--purple);color:#fff;border-radius:6px;padding:2px 8px;font-size:.6rem;font-weight:800;}
.earn-bar-bg{height:8px;background:rgba(255,255,255,.07);border-radius:99px;overflow:hidden;margin-top:4px;}
.earn-bar-fill{height:100%;border-radius:99px;background:linear-gradient(90deg,var(--yellow),var(--orange));transition:width .8s;}
.cancel-opt{display:flex;align-items:center;gap:10px;padding:12px 14px;border:1.5px solid var(--border);border-radius:12px;cursor:pointer;margin-bottom:8px;transition:all .2s;}
.cancel-opt.sel{border-color:var(--red);background:rgba(239,68,68,.07);}
.wa-btn{display:flex;align-items:center;justify-content:center;gap:8px;background:linear-gradient(135deg,#25d366,#128c7e);color:#fff;border-radius:13px;padding:13px;font-weight:800;font-size:.9rem;text-decoration:none;margin-top:9px;}
/* ‚úÖ FIX 1: eta-big was missing - ETA countdown styling */
.eta-big{font-family:'Syne',sans-serif;font-weight:900;font-size:2.2rem;color:var(--blue);letter-spacing:.01em;margin:4px 0;line-height:1.1;}
/* ‚úÖ Active ride highlight */
.assigned-glow{animation:assignGlow 2s ease-in-out infinite;}
@keyframes assignGlow{0%,100%{box-shadow:0 0 0 0 rgba(16,185,129,.2)}50%{box-shadow:0 0 24px 4px rgba(16,185,129,.15)}}
/* ‚ïê‚ïê CALL BUTTON ‚ïê‚ïê */
.call-btn{display:flex;align-items:center;justify-content:center;gap:7px;width:100%;border:none;border-radius:13px;padding:13px;font-size:.92rem;font-weight:800;cursor:pointer;font-family:'Syne',sans-serif;background:linear-gradient(135deg,#16a34a,#15803d);color:#fff;box-shadow:0 5px 18px rgba(22,163,74,.4);transition:transform .1s,box-shadow .2s;margin-top:8px;text-decoration:none;}
.call-btn:active{transform:scale(.97);box-shadow:0 2px 8px rgba(22,163,74,.3);}
.call-btn .call-pulse{width:9px;height:9px;background:#fff;border-radius:50%;animation:dpulse 1.2s infinite;}
.call-btn-mini{display:inline-flex;align-items:center;justify-content:center;gap:5px;border:none;border-radius:99px;padding:7px 14px;font-size:.75rem;font-weight:800;cursor:pointer;font-family:'DM Sans',sans-serif;background:linear-gradient(135deg,#16a34a,#15803d);color:#fff;box-shadow:0 3px 12px rgba(22,163,74,.4);transition:transform .1s;text-decoration:none;}
.call-btn-mini:active{transform:scale(.96);}
.call-ring{display:inline-block;animation:callring .6s infinite alternate;}
@keyframes callring{0%{transform:rotate(-15deg)}100%{transform:rotate(15deg)}}
</style>
</head>
<body>

<!-- SURGE BANNER -->
<div id="surgeBanner">‚ö° High Demand ‚Äî Surge Pricing Active in Your Area! Fares 1.5x</div>

<!-- LOADER -->
<div id="loader">
  <div class="ld-box">JDP</div>
  <div class="ld-t">CABS</div>
  <div class="ld-s">Jagdalpur ¬∑ Live Ride System<br>Bastar Division</div>
  <div class="ld-bar-w"><div class="ld-bar" id="ldBar"></div></div>
  <div id="ldStatus" style="font-size:.7rem;color:var(--muted);margin-top:4px;">Initializing...</div>
</div>

<!-- MAP ‚Äî Full screen with gradient blend at bottom -->
<div id="map"></div>

<!-- ‚úÖ Map gradient fade ‚Äî so map flows into bottom sheet (Uber effect) -->
<div id="mapFade" style="
  position:fixed;bottom:0;left:0;right:0;
  height:160px;
  background:linear-gradient(to top, rgba(10,14,22,1) 0%, rgba(10,14,22,0.7) 50%, transparent 100%);
  z-index:390;pointer-events:none;display:none;
"></div>

<!-- ‚úÖ Uber-style zoom controls ‚Äî positioned above locate button -->
<div class="zoom-ctrl" id="zoomCtrl" style="bottom:410px;">
  <button class="zbtn" onclick="zoomIn()" title="Zoom In">+</button>
  <button class="zbtn" onclick="zoomOut()" title="Zoom Out">‚àí</button>
</div>

<!-- ZONE LEGEND -->
<div id="zoneLegend">
  <div class="zl-title">üó∫Ô∏è Jagdalpur Zones</div>
  <div class="zl-row"><div class="zl-dot" style="background:#10b981"></div><span>City Core</span><span class="zl-tag">0‚Äì3 km</span></div>
  <div class="zl-row"><div class="zl-dot" style="background:#3b82f6"></div><span>City Zone</span><span class="zl-tag">3‚Äì8 km</span></div>
  <div class="zl-row"><div class="zl-dot" style="background:#f59e0b"></div><span>Outer Area</span><span class="zl-tag">8‚Äì15 km</span></div>
  <div class="zl-row" style="margin-bottom:0"><div class="zl-dot" style="background:#8b5cf6"></div><span>Landmarks</span><span class="zl-tag">Live</span></div>
</div>

<!-- MAP STATS (live count badges) -->
<div id="mapStats">
  <div class="ms-row">
    <div class="ms-chip" onclick="toggleZone()">
      <div class="ms-dot" style="background:var(--green)"></div>
      <span id="liveDriverBadge">0 Drivers</span>
    </div>
    <div class="ms-chip" onclick="toggleLandmarks()">
      <div class="ms-dot" style="background:var(--purple)"></div>
      <span>üìç Places</span>
    </div>
    <div class="ms-chip" onclick="toggleZone()">
      <div class="ms-dot" id="zoneDot" style="background:var(--yellow)"></div>
      <span id="myZoneText">City Zone</span>
    </div>
  </div>
</div>

<!-- AUTH -->
<div id="auth">
  <div class="ah">
    <img src="https://images.unsplash.com/photo-1449965408869-eaa3f722e40d?auto=format&fit=crop&w=800&q=80">
    <div class="ah-ov">
      <div class="ah-tag">üó∫Ô∏è Jagdalpur ‚Ä¢ Bastar</div>
      <div style="font-family:'Syne',sans-serif;font-size:1.8rem;font-weight:900;color:white;">JDP CABS</div>
      <div style="color:rgba(255,255,255,.5);font-size:.8rem;margin-top:3px;">Jagdalpur's Smartest Cab System</div>
    </div>
  </div>
  <div class="ab">
    <div class="fbb" id="fbBadge">‚è≥ Connecting to Firebase...</div>
    <div class="rtog">
      <button class="rtab ar" id="rTab" onclick="setRole('rider')">üßç Rider</button>
      <button class="rtab" id="dTab" onclick="setRole('driver')">üöñ Driver</button>
    </div>
    <div class="atabs">
      <button class="atab on" id="loginTab" onclick="setTab('login')">Login</button>
      <button class="atab" id="regTab" onclick="setTab('register')">Register</button>
    </div>
    <div class="afrm sh" id="loginForm">
      <div id="loginErr" class="eb"></div>
      <div class="fg"><label class="fl">Mobile Number</label><input type="tel" class="fi" id="lId" placeholder="9876543210" maxlength="10"></div>
      <div class="fg"><label class="fl">Password</label><input type="password" class="fi" id="lPass" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢"></div>
      <button class="asub y" onclick="doLogin()">üöÄ Login</button>
    </div>
    <div class="afrm" id="rRegForm">
      <div id="rRegErr" class="eb"></div>
      <div class="fr">
        <div class="fg"><label class="fl">Full Name</label><input type="text" class="fi" id="rFn" placeholder="Aapka Naam"></div>
        <div class="fg"><label class="fl">Mobile</label><input type="tel" class="fi" id="rPh" placeholder="9876543210" maxlength="10"></div>
      </div>
      <div class="fg"><label class="fl">Password</label><input type="password" class="fi" id="rPw" placeholder="min 6 chars"></div>
      <button class="asub y" onclick="doRiderReg()">‚úÖ Create Rider Account</button>
    </div>
    <div class="afrm" id="dRegForm">
      <div id="dRegErr" class="eb"></div>

      <!-- STEP 1: Basic Info -->
      <div id="dStep1">
        <div style="font-size:.6rem;font-weight:800;color:var(--green);text-transform:uppercase;letter-spacing:.08em;margin-bottom:9px;display:flex;align-items:center;gap:5px">
          <span style="background:var(--green);color:#000;border-radius:50%;width:16px;height:16px;display:inline-flex;align-items:center;justify-content:center;font-size:.55rem">1</span>
          Basic Information
        </div>
        <div class="fr">
          <div class="fg"><label class="fl">Full Name</label><input type="text" class="fi gf" id="dFn" placeholder="Aapka Naam"></div>
          <div class="fg"><label class="fl">Mobile</label><input type="tel" class="fi gf" id="dPh" placeholder="9876543210" maxlength="10"></div>
        </div>
        <div class="fg"><label class="fl">Vehicle Number</label><input type="text" class="fi gf" id="dVeh" placeholder="CG 17 XX 0000"></div>
        <div class="fg"><label class="fl">Vehicle Type</label>
          <div class="vg">
            <div class="vc on" id="vAuto" onclick="selVeh('auto')"><div style="font-size:1.6rem">üõ∫</div><div style="font-size:.73rem;font-weight:700;margin-top:3px">Auto</div></div>
            <div class="vc" id="vCab" onclick="selVeh('cab')"><div style="font-size:1.6rem">üöó</div><div style="font-size:.73rem;font-weight:700;margin-top:3px">Mini Cab</div></div>
          </div>
        </div>
        <div class="fg"><label class="fl">Password</label><input type="password" class="fi gf" id="dPw" placeholder="min 6 chars"></div>
        <button class="asub" style="background:rgba(16,185,129,.15);color:var(--green);border:1px solid rgba(16,185,129,.3)" onclick="showKycStep()">Next: KYC Documents ‚Üí</button>
      </div>

      <!-- STEP 2: KYC Documents -->
      <div id="dStep2" style="display:none;animation:fup .3s ease">
        <div style="font-size:.6rem;font-weight:800;color:var(--green);text-transform:uppercase;letter-spacing:.08em;margin-bottom:9px;display:flex;align-items:center;gap:5px">
          <span style="background:var(--green);color:#000;border-radius:50%;width:16px;height:16px;display:inline-flex;align-items:center;justify-content:center;font-size:.55rem">2</span>
          KYC Verification Documents
        </div>
        <div style="background:rgba(245,158,11,.07);border:1px solid rgba(245,158,11,.2);border-radius:10px;padding:9px 12px;font-size:.71rem;color:rgba(245,158,11,.9);margin-bottom:13px">
          ‚ö†Ô∏è Ye documents sirf verification ke liye hain. Admin review ke baad account activate hoga.
        </div>

        <!-- üì∏ DRIVER PHOTO UPLOAD -->
        <label class="fl">üì∏ Driver Profile Photo <span style="color:var(--red)">*</span></label>
        <div class="photo-upload-box" id="photoUploadBox" onclick="document.getElementById('dPhotoInput').click()">
          <img id="dPhotoPreview" class="photo-preview" alt="Driver Photo">
          <div class="photo-placeholder" id="photoPlaceholder">ü§≥</div>
          <div class="photo-upload-lbl" id="photoUploadLbl">Tap to upload selfie / photo</div>
          <div class="photo-upload-sub">Camera se selfie ya gallery se photo chune<br>JPG/PNG ‚Ä¢ Max 5MB ‚Ä¢ Square photo best hogi</div>
        </div>
        <input type="file" id="dPhotoInput" accept="image/*" capture="user" style="display:none" onchange="handleDriverPhoto(this)">
        <div id="photoStatus" style="font-size:.68rem;color:var(--green);text-align:center;margin-bottom:10px;display:none">‚úÖ Photo ready!</div>

        <div class="fg"><label class="fl">ü™™ Aadhaar Card Number</label><input type="tel" class="fi gf" id="dAadhar" placeholder="XXXX XXXX XXXX" maxlength="14" oninput="fmtAadhar(this)"></div>
        <div class="fg"><label class="fl">üìÑ PAN Card Number</label><input type="text" class="fi gf" id="dPan" placeholder="ABCDE1234F" maxlength="10" style="text-transform:uppercase"></div>
        <div class="fg"><label class="fl">üöó Driving Licence Number</label><input type="text" class="fi gf" id="dDl" placeholder="CG1720XXXXXXX" style="text-transform:uppercase"></div>

        <div style="font-size:.6rem;font-weight:800;color:var(--blue);text-transform:uppercase;letter-spacing:.08em;margin:13px 0 9px;display:flex;align-items:center;gap:5px">
          <span style="background:var(--blue);color:#fff;border-radius:50%;width:16px;height:16px;display:inline-flex;align-items:center;justify-content:center;font-size:.55rem">3</span>
          Bank Account Details
        </div>
        <div class="fg"><label class="fl">üè¶ Account Holder Name</label><input type="text" class="fi gf" id="dBankName" placeholder="Aapka Naam (Bank mein)"></div>
        <div class="fg"><label class="fl">Account Number</label><input type="tel" class="fi gf" id="dAccNo" placeholder="00000000000000"></div>
        <div class="fg"><label class="fl">IFSC Code</label><input type="text" class="fi gf" id="dIfsc" placeholder="SBIN0001234" maxlength="11" style="text-transform:uppercase"></div>

        <div style="display:grid;grid-template-columns:1fr 1.5fr;gap:8px">
          <button class="asub" style="background:rgba(255,255,255,.05);color:var(--muted);border:1px solid var(--border)" onclick="document.getElementById('dStep1').style.display='block';document.getElementById('dStep2').style.display='none'">‚Üê Back</button>
          <button class="asub g" onclick="doDriverReg()">‚úÖ Submit Registration</button>
        </div>
        <div style="text-align:center;font-size:.65rem;color:var(--muted);margin-top:9px">üîí Aapki details securely store hoti hain</div>
      </div>
    </div>
  </div>
</div>

<!-- ‚ïê‚ïê‚ïê RIDER UI ‚ïê‚ïê‚ïê -->
<!-- ‚úÖ UBER-STYLE MINIMAL TOP BAR -->
<div class="tb" id="rTop" style="display:none">
  <div class="tb-logo">JDP CABS</div>
  <div class="tb-actions">
    <div class="tbtn tbtn-icon" onclick="showHistory()" title="Ride History">üìã</div>
    <div class="tbtn tbtn-icon" onclick="toggleTheme()">‚òÄÔ∏è</div>
    <div class="tbtn tbtn-icon" id="zoneBtnR" onclick="toggleZone()">üì°</div>
    <div class="tbtn" style="color:rgba(255,80,80,1);border-color:rgba(239,68,68,.3);background:rgba(239,68,68,.12)" onclick="doLogout()">Exit</div>
  </div>
</div>

<!-- ‚úÖ LOCATE FAB ‚Äî Uber position -->
<button class="locbtn" id="locBtn" style="display:none;bottom:340px" onclick="locateMe()">üìç</button>

<div class="sheet" id="rSheet">
  <div class="hdl"></div>

  <!-- ‚úÖ HOME SCREEN ‚Äî Uber-style compact -->
  <div class="scr on" id="sHome">

    <!-- Greeting + driver badge ‚Äî single row -->
    <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:10px;">
      <div style="font-size:.65rem;color:var(--muted);font-weight:800;letter-spacing:.1em;text-transform:uppercase">
        WHERE TO, <span id="riderName" style="color:var(--yellow)">RIDER</span>?
      </div>
      <div id="homeDrvBadge" style="display:none;font-size:.65rem;font-weight:700;color:var(--green);
        display:flex;align-items:center;gap:4px">
        <div style="width:6px;height:6px;border-radius:50%;background:var(--green);
          box-shadow:0 0 6px var(--green)"></div>
        <span id="homeDrvText">0 drivers</span>
      </div>
    </div>

    <!-- ‚úÖ SEARCH BOX ‚Äî Uber style with pickup pre-filled -->
    <div class="lbs">
      <div class="lb" onclick="refreshGPS()" style="cursor:pointer;">
        <div class="pdot"></div>
        <div style="flex:1;min-width:0">
          <div style="font-weight:700;font-size:.88rem;white-space:nowrap;overflow:hidden;text-overflow:ellipsis" id="pAddr">Detecting location...</div>
          <div id="pSub" style="font-size:.66rem;color:var(--muted);margin-top:1px;display:flex;align-items:center;gap:4px">
            <div class="lspin"></div><span>Getting GPS...</span>
          </div>
        </div>
        <div style="font-size:.85rem;opacity:.4;flex-shrink:0">üîÑ</div>
      </div>
      <div id="dropLbWrap">
        <div class="lb" style="border-color:rgba(255,255,255,.12)">
          <div style="width:10px;height:10px;background:var(--red);border-radius:3px;flex-shrink:0;transform:rotate(45deg)"></div>
          <input type="text" id="dropIn" placeholder="üîç Jagdalpur mein kahan jaana hai?"
            autocomplete="off"
            style="background:transparent;border:none;color:var(--text);width:100%;
            font-family:'DM Sans',sans-serif;font-weight:600;font-size:.88rem;outline:none;"
            onkeydown="if(event.key==='Enter'){hideSuggest();calcFare();}"
            oninput="onDropInput(this.value)"
            onfocus="if(this.value.length>1)showSuggest(this.value)"
            onblur="setTimeout(hideSuggest,200)">
        </div>
        <!-- ‚úÖ Autocomplete dropdown ‚Äî Uber style -->
        <div id="dropSuggest"></div>
      </div>
    </div>

    <!-- ‚úÖ QUICK FAVORITES ROW ‚Äî Uber home/work chips -->
    <div style="display:flex;gap:8px;margin-bottom:10px;">
      <div class="fav-chip" id="favHomeChip" onclick="useFavLoc('home')"
        style="flex:1;display:flex;align-items:center;gap:8px;background:rgba(255,255,255,.05);
        border:1px solid rgba(255,255,255,.08);border-radius:12px;padding:9px 11px;cursor:pointer;">
        <span style="font-size:1.2rem">üè†</span>
        <div style="min-width:0">
          <div style="font-size:.58rem;color:var(--muted);font-weight:700;text-transform:uppercase">Home</div>
          <div style="font-size:.75rem;font-weight:700;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;max-width:90px" id="favHomeLbl">Set location</div>
        </div>
      </div>
      <div class="fav-chip" id="favWorkChip" onclick="useFavLoc('work')"
        style="flex:1;display:flex;align-items:center;gap:8px;background:rgba(255,255,255,.05);
        border:1px solid rgba(255,255,255,.08);border-radius:12px;padding:9px 11px;cursor:pointer;">
        <span style="font-size:1.2rem">üíº</span>
        <div style="min-width:0">
          <div style="font-size:.58rem;color:var(--muted);font-weight:700;text-transform:uppercase">Work</div>
          <div style="font-size:.75rem;font-weight:700;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;max-width:90px" id="favWorkLbl">Set location</div>
        </div>
      </div>
    </div>

    <!-- ‚úÖ POPULAR PLACES ‚Äî horizontal scroll, Uber pill style -->
    <div class="qp-label">üèôÔ∏è Popular in Jagdalpur</div>
    <div class="qp-scroll" id="qpScroll">
      <div class="qp-chip" onclick="setDrop('Bastar Palace, Jagdalpur')">üèØ Bastar Palace</div>
      <div class="qp-chip" onclick="setDrop('Maharaja Hospital, Jagdalpur')">üè• Hospital</div>
      <div class="qp-chip" onclick="setDrop('Jagdalpur Bus Stand')">üöå Bus Stand</div>
      <div class="qp-chip" onclick="setDrop('Chitrakote Waterfall, Jagdalpur')">üåä Chitrakote</div>
      <div class="qp-chip" onclick="setDrop('JNKVV College, Jagdalpur')">üéì JNKVV</div>
      <div class="qp-chip" onclick="setDrop('Collectorate Jagdalpur')">üèõÔ∏è Collectorate</div>
      <div class="qp-chip" onclick="setDrop('Jagdalpur Railway Station')">üöÇ Railway</div>
      <div class="qp-chip" onclick="setDrop('Danteshwari Temple, Jagdalpur')">üõï Danteshwari</div>
      <div class="qp-chip" onclick="setDrop('Airport Jagdalpur')">‚úàÔ∏è Airport</div>
    </div>

    <!-- Promo strip (hidden by default) -->
    <div class="promo-strip" id="promoStrip" onclick="openModal('promoModal')" style="display:none">
      <span class="promo-tag">OFFER</span>
      <div style="flex:1;font-size:.78rem;font-weight:700" id="promoStripText">üéâ Promo available!</div>
      <span style="font-size:.8rem;color:var(--purple)">‚Üí</span>
    </div>

    <div id="homeErr" class="eb"></div>
    <button class="mbtn y" onclick="calcFare()" style="margin-top:6px">Find Driver üöó</button>
  </div>

  <!-- FARE SCREEN -->
  <div class="scr" id="sFare">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px">
      <div style="font-family:'Syne',sans-serif;font-size:.98rem;font-weight:800">Select Ride</div>
      <span style="color:var(--red);font-weight:700;font-size:.83rem;cursor:pointer" onclick="goScr('sHome');clearRoute()">‚úï Back</span>
    </div>
    <div id="surgeChip" style="display:none;" class="surge-chip">‚ö° 1.5x Surge ‚Äî High demand</div>
    <div class="chips">
      <div class="chip"><div class="cv" id="cDist">--</div><div class="cl">KM</div></div>
      <div class="chip"><div class="cv" id="cETA">--</div><div class="cl">MINS</div></div>
      <div class="chip"><div class="cv" id="cZone">--</div><div class="cl">ZONE</div></div>
    </div>
    <div class="ro-card sel" id="optAuto" onclick="selRide(this,'JDP Auto','auto')">
      <div style="font-size:1.9rem">üõ∫</div>
      <div style="flex:1;margin-left:12px">
        <div style="font-weight:800;font-size:.95rem">JDP Auto <span class="ro-surge" id="autoSurge" style="display:none">‚ö° Surge</span></div>
        <div style="font-size:.7rem;color:var(--muted)">~3 min ‚Ä¢ 3 seater ‚Ä¢ Jagdalpur</div>
      </div>
      <div style="font-weight:900;font-size:1.2rem;font-family:'Syne',sans-serif">‚Çπ<span id="fAuto">--</span></div>
    </div>
    <div class="ro-card" id="optMini" onclick="selRide(this,'Mini Cab','cab')">
      <div style="font-size:1.9rem">üöó</div>
      <div style="flex:1;margin-left:12px">
        <div style="font-weight:800;font-size:.95rem">Mini Cab <span class="ro-surge" id="miniSurge" style="display:none">‚ö° Surge</span></div>
        <div style="font-size:.7rem;color:var(--muted)">~5 min ‚Ä¢ 4 seater ‚Ä¢ AC</div>
      </div>
      <div style="font-weight:900;font-size:1.2rem;font-family:'Syne',sans-serif">‚Çπ<span id="fMini">--</span></div>
    </div>

    <!-- Nearby drivers in zones -->
    <div class="nd-panel">
      <div class="nd-row">
        <div class="nd-title">üì° Nearby Drivers</div>
        <div style="display:flex;align-items:baseline;gap:4px">
          <div class="nd-count" id="ndTotal">0</div>
          <div style="font-size:.65rem;color:var(--muted)">online</div>
        </div>
      </div>
      <div class="nd-bars" id="ndBars">
        <div class="nd-bar" style="height:20%;"></div>
        <div class="nd-bar" style="height:40%;"></div>
        <div class="nd-bar" style="height:30%;"></div>
        <div class="nd-bar" style="height:60%;"></div>
        <div class="nd-bar" style="height:50%;"></div>
      </div>
      <div class="nd-zone-row">
        <div class="nd-zone z1">üü¢ <span id="nd0to3">0</span> within 3km</div>
        <div class="nd-zone z2">üîµ <span id="nd3to8">0</span> within 8km</div>
        <div class="nd-zone z3">üü° <span id="nd8to15">0</span> within 15km</div>
      </div>
    </div>
    <button class="mbtn y" onclick="confirmBook()">Book <span id="bookBtnType">JDP Auto</span> ‚Üí</button>
  </div>

  <!-- FINDING SCREEN -->
  <div class="scr" id="sFind">
    <div class="rdr">
      <div class="rdr-rings">
        <div class="r1"></div><div class="r2"></div><div class="r3"></div>
        <div class="r4"><div class="r4-inner"></div></div>
      </div>
      <div style="font-family:'Syne',sans-serif;font-weight:900;font-size:1.08rem">Finding nearby drivers...</div>
      <div style="color:var(--muted);font-size:.78rem;margin-top:5px">Live request sent to all online drivers</div>
      <div style="margin-top:13px;background:rgba(59,130,246,.08);border:1px solid rgba(59,130,246,.2);border-radius:12px;padding:11px">
        <div style="font-size:.68rem;color:var(--muted);font-weight:700;text-transform:uppercase;letter-spacing:.04em;margin-bottom:4px">üéØ Smart Matching</div>
        <div style="font-family:'Syne',sans-serif;font-weight:900;font-size:1.35rem;color:var(--blue)" id="nearbyCount">--</div>
        <div style="font-size:.68rem;color:var(--muted);margin-top:3px" id="matchZoneText">Searching within 5km first...</div>
      </div>
      <button class="mbtn ro" style="max-width:180px;margin:16px auto 0" onclick="cancelBook()">Cancel</button>
    </div>
  </div>

  <!-- ASSIGNED SCREEN -->
  <div class="scr" id="sAssigned">
    <div id="assignedBanner" style="background:rgba(16,185,129,.1);color:var(--green);padding:9px;border-radius:11px;text-align:center;font-weight:800;margin-bottom:13px;border:1px solid rgba(16,185,129,.25);font-size:.88rem">‚úÖ Driver Assigned!</div>
    <div class="dcard" id="driverCard">
      <!-- Driver photo or emoji fallback -->
      <div class="dava-verified" id="dAvaWrap">
        <img id="dAvaPhoto" class="dava-photo" src="" alt="" style="display:none">
        <div class="dava" id="dAvaEmoji">üë®üèΩ‚Äç‚úàÔ∏è</div>
      </div>
      <div style="flex:1">
        <div style="font-family:'Syne',sans-serif;font-weight:900;font-size:1.02rem" id="aDName">--</div>
        <div style="font-size:.76rem;color:var(--muted);margin-top:2px" id="aVeh">--</div>
        <div class="star-row" style="margin-top:3px">
          <span class="star">‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ</span>
          <span style="font-size:.7rem;font-weight:700;color:var(--muted);margin-left:2px">4.8</span>
        </div>
        <!-- Phone number display -->
        <div id="aDriverPhone" style="font-size:.72rem;color:var(--muted);margin-top:3px;display:none">
          üìû <span id="aDriverPhoneNum">--</span>
        </div>
      </div>
      <div class="otp">
        <div style="font-size:.58rem;color:var(--muted);font-weight:700;letter-spacing:.04em;text-transform:uppercase">OTP</div>
        <div style="font-family:'Syne',sans-serif;font-weight:900;font-size:1.35rem;color:var(--yellow)" id="rideOTP">----</div>
      </div>
    </div>

    <!-- üìû CALL DRIVER BUTTON -->
    <a id="callDriverBtn" href="#" class="call-btn" onclick="callDriver();return false;">
      <span class="call-ring">üìû</span>
      <span>Call Driver</span>
      <span id="callDriverNumLabel" style="font-size:.72rem;opacity:.85;font-weight:600"></span>
    </a>

    <!-- ‚è±Ô∏è ETA COUNTDOWN -->
    <div style="background:rgba(59,130,246,.07);border:1px solid rgba(59,130,246,.2);border-radius:13px;padding:12px;text-align:center;margin-top:9px">
      <div style="font-size:.58rem;color:var(--muted);font-weight:700;text-transform:uppercase;letter-spacing:.05em">Driver Pahunchega</div>
      <div class="eta-big" id="etaCountdown">--</div>
      <div style="font-size:.62rem;color:var(--muted);margin-top:1px" id="etaSubText">Calculating ETA...</div>
    </div>

    <!-- üí¨ QUICK ACTIONS -->
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-top:9px">
      <button class="mbtn" style="margin-top:0;background:rgba(59,130,246,.1);border:1px solid rgba(59,130,246,.25);color:var(--blue)" onclick="openModal('msgModal')">üí¨ Message</button>
      <button class="mbtn" style="margin-top:0;background:rgba(37,211,102,.08);border:1px solid rgba(37,211,102,.25);color:#25d366" onclick="shareTrip()">üì§ Share Trip</button>
    </div>

    <div class="lbadge b" style="margin-top:9px"><div class="lbd"></div><span id="driverTrackText">üöó Tracking driver on map...</span></div>
    <div class="lbadge g"><div class="lbd"></div><span id="driverDistText">Calculating distance...</span></div>
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px">
      <button class="mbtn g" style="margin-top:0" onclick="locateMe()">üìç My Location</button>
      <button class="mbtn ro" style="margin-top:0" onclick="cancelRide()">Cancel Ride</button>
    </div>
  </div>
</div>

<!-- ‚ïê‚ïê‚ïê DRIVER DASHBOARD ‚ïê‚ïê‚ïê -->
<div id="dTopBar">
  <div class="d-nr">
    <div class="d-nm">üöñ <span id="dName">Driver</span></div>
    <div style="display:flex;align-items:center;gap:9px">
      <span style="font-size:.72rem;font-weight:700;color:rgba(255,255,255,.6)" id="onlineLbl">OFFLINE</span>
      <label class="tgsw">
        <input type="checkbox" id="onTog" onchange="toggleOnline()">
        <div class="tgtr"></div><div class="tgth"></div>
      </label>
    </div>
  </div>
</div>

<div id="dStats">
  <div class="dsr">
    <div class="dst" onclick="showEarningsBreak()" style="cursor:pointer">
      <div class="dsv" id="dsEarn">‚Çπ0</div>
      <div class="dsl">Today üìä</div>
    </div>
    <div class="dst"><div class="dsv" id="dsRides">0</div><div class="dsl">Rides</div></div>
    <div class="dst"><div class="dsv" id="dsZone">--</div><div class="dsl">Zone</div></div>
    <div class="dst"><div class="dsv" id="dsTime">0h</div><div class="dsl">Online</div></div>
  </div>
  <!-- Earnings progress bar -->
  <div style="padding:0 14px 10px;display:none" id="earnBarWrap">
    <div style="display:flex;justify-content:space-between;font-size:.62rem;color:var(--muted);margin-bottom:3px">
      <span>Daily Progress</span><span id="earnGoalPct">0%</span>
    </div>
    <div class="earn-bar-bg"><div class="earn-bar-fill" id="earnBarFill" style="width:0%"></div></div>
    <div style="font-size:.6rem;color:var(--muted);text-align:right;margin-top:2px">Goal: ‚Çπ1000/day</div>
  </div>
</div>

<div id="dPanel">
  <div id="dOff">
    <div style="font-size:2.8rem;margin-bottom:9px">üò¥</div>
    <div style="font-family:'Syne',sans-serif;font-weight:900;font-size:1.1rem;margin-bottom:5px">You are Offline</div>
    <div style="font-size:.8rem;color:var(--muted);margin-bottom:16px">Go online to receive ride requests in Jagdalpur</div>
    <div id="kycPendingWarn" style="display:none;background:rgba(245,158,11,.08);border:1px solid rgba(245,158,11,.25);border-radius:11px;padding:9px 12px;font-size:.74rem;color:rgba(245,158,11,.9);margin-bottom:11px;text-align:left">
      ‚è≥ <b>KYC Verification Pending</b><br>Admin aapke documents review kar raha hai. Verify hone ke baad aap rides accept kar payenge.
    </div>
    <button class="mbtn g" onclick="document.getElementById('onTog').checked=true;toggleOnline()">üü¢ Go Online & Earn</button>
  </div>

  <div id="dOn">
    <div class="opulse">
      <div class="odpulse"></div>
      <div style="flex:1">
        <div style="font-weight:700;font-size:.88rem">You're Online ‚Äî Waiting for Rides</div>
        <div style="font-size:.7rem;color:var(--muted);margin-top:1px" id="dLocText">Sharing your location live...</div>
      </div>
    </div>
    <div class="dzone-row">
      <div class="dzone-card">
        <div class="dzone-val" id="dRidersNearby" style="color:var(--blue)">--</div>
        <div class="dzone-lbl">Riders Nearby</div>
      </div>
      <div class="dzone-card">
        <div class="dzone-val" id="dDriversZone" style="color:var(--green)">--</div>
        <div class="dzone-lbl">Drivers Online</div>
      </div>
    </div>
    <div class="lbadge g"><div class="lbd"></div><span id="dZoneText">In Service Zone ¬∑ Jagdalpur</span></div>
    <div style="font-size:.7rem;color:var(--muted);text-align:center">üì° Listening for rides within <b>8km</b> radius</div>
  </div>

  <div id="dNav">
    <div style="font-family:'Syne',sans-serif;font-weight:800;font-size:.85rem;margin-bottom:11px;color:var(--muted);text-transform:uppercase;letter-spacing:.04em" id="navLabel">üîµ Going to Pickup</div>
    <div class="nstep bl" id="navPickup">
      <div class="nicon">üìç</div>
      <div style="flex:1;min-width:0">
        <div style="font-size:.62rem;color:var(--muted);font-weight:700;text-transform:uppercase;letter-spacing:.04em">PICKUP</div>
        <div style="font-weight:700;font-size:.87rem;margin-top:2px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis" id="navPA">--</div>
      </div>
      <div style="text-align:right;flex-shrink:0">
        <div style="font-family:'Syne',sans-serif;font-weight:800;color:var(--blue);font-size:.9rem" id="navPDist">--</div>
        <div style="font-size:.62rem;color:var(--muted)" id="navPETA">--</div>
      </div>
    </div>
    <div class="nstep gr" id="navDrop">
      <div class="nicon">üèÅ</div>
      <div style="flex:1;min-width:0">
        <div style="font-size:.62rem;color:var(--muted);font-weight:700;text-transform:uppercase;letter-spacing:.04em">DROP</div>
        <div style="font-weight:700;font-size:.87rem;margin-top:2px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis" id="navDA">--</div>
      </div>
      <div style="text-align:right;flex-shrink:0">
        <div style="font-family:'Syne',sans-serif;font-weight:800;color:var(--green);font-size:.9rem" id="navFare">‚Çπ--</div>
        <div style="font-size:.62rem;color:var(--muted)">Fare</div>
      </div>
    </div>

    <!-- üìû RIDER INFO + CALL BUTTON ‚Äî Always visible -->
    <div style="background:linear-gradient(135deg,rgba(16,185,129,.12),rgba(16,185,129,.06));border:1.5px solid rgba(16,185,129,.35);border-radius:13px;padding:11px 13px;margin-bottom:9px;">
      <div style="font-size:.58rem;font-weight:800;color:var(--green);text-transform:uppercase;letter-spacing:.06em;margin-bottom:7px">üìû Rider Contact</div>
      <div style="display:flex;align-items:center;justify-content:space-between;gap:10px">
        <div>
          <div style="font-weight:800;font-size:.92rem" id="navRiderName">--</div>
          <div style="font-size:.74rem;color:var(--muted);margin-top:2px" id="navRiderPhone">Loading...</div>
        </div>
        <a id="callRiderBtn" href="#" onclick="callRider();return false;"
           style="display:inline-flex;align-items:center;gap:6px;background:linear-gradient(135deg,#16a34a,#15803d);color:#fff;border:none;border-radius:99px;padding:10px 18px;font-size:.82rem;font-weight:800;text-decoration:none;box-shadow:0 4px 14px rgba(22,163,74,.5);flex-shrink:0;cursor:pointer;">
          <span style="display:inline-block;animation:callring .6s infinite alternate">üìû</span>
          Call Rider
        </a>
      </div>
    </div>

    <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-top:0">
      <button class="mbtn g" style="margin-top:0" id="navActBtn" onclick="driverNext()">‚úÖ Rider Picked Up</button>
      <button class="mbtn ro" style="margin-top:0" onclick="driverCancel()">Cancel</button>
    </div>
  </div>
</div>

<!-- RIDE REQUEST POPUP -->
<div id="reqPopup">
  <div class="rpc">
    <div style="text-align:center;font-family:'Syne',sans-serif;font-weight:900;font-size:1rem;margin-bottom:2px">üîî New Ride Request!</div>
    <div id="reqDistBadge" style="text-align:center;margin-bottom:8px"></div>
    <div class="rtring">
      <svg class="rtsvg" width="60" height="60" viewBox="0 0 60 60">
        <circle class="rtcbg" cx="30" cy="30" r="26"/>
        <circle class="rtc" id="tCircle" cx="30" cy="30" r="26"/>
      </svg>
      <div class="rtn" id="tNum">60</div>
    </div>
    <div style="display:flex;gap:7px;margin-bottom:3px">
      <div style="flex:1;text-align:center;background:rgba(255,255,255,.04);border:1px solid var(--border);border-radius:10px;padding:9px">
        <div style="font-family:'Syne',sans-serif;font-weight:900;font-size:1.05rem;color:var(--yellow)" id="reqFare">‚Çπ--</div>
        <div style="font-size:.58rem;color:var(--muted);font-weight:600;margin-top:1px">FARE</div>
      </div>
      <div style="flex:1;text-align:center;background:rgba(255,255,255,.04);border:1px solid var(--border);border-radius:10px;padding:9px">
        <div style="font-family:'Syne',sans-serif;font-weight:800;font-size:1.05rem" id="reqDist">--km</div>
        <div style="font-size:.58rem;color:var(--muted);font-weight:600;margin-top:1px">TRIP</div>
      </div>
      <div style="flex:1;text-align:center;background:rgba(255,255,255,.04);border:1px solid var(--border);border-radius:10px;padding:9px">
        <div style="font-family:'Syne',sans-serif;font-weight:800;font-size:1.05rem" id="reqPickupDist">--km</div>
        <div style="font-size:.58rem;color:var(--muted);font-weight:600;margin-top:1px">PICKUP</div>
      </div>
      <div style="flex:1;text-align:center;background:rgba(255,255,255,.04);border:1px solid var(--border);border-radius:10px;padding:9px">
        <div style="font-family:'Syne',sans-serif;font-weight:800;font-size:1.05rem" id="reqETA">--m</div>
        <div style="font-size:.58rem;color:var(--muted);font-weight:600;margin-top:1px">ETA</div>
      </div>
    </div>
    <div class="trip-row">
      <div class="tdots"><div class="tdg"></div><div class="tdl"></div><div class="tdr"></div></div>
      <div class="tadd">
        <div class="ta-row"><div class="ta-lbl">Pickup</div><div class="ta-val" id="reqPick">--</div></div>
        <div class="ta-row"><div class="ta-lbl">Drop</div><div class="ta-val" id="reqDrop">--</div></div>
      </div>
    </div>
    <div class="req-btns">
      <button class="mbtn ro" style="margin-top:0" onclick="declineReq()">Decline</button>
      <button class="mbtn g" style="margin-top:0" onclick="acceptReq()">‚úÖ Accept</button>
    </div>
  </div>
</div>

<!-- üÜò SOS BUTTON (visible during active ride) -->
<button id="sosBtn" onclick="panicSOS()" title="Emergency SOS">üÜò</button>

<!-- ‚ïê‚ïê MODALS ‚ïê‚ïê -->

<!-- RIDE HISTORY MODAL -->
<div id="histModal" onclick="if(event.target===this)closeModal('histModal')">
  <div class="modal-box">
    <div class="modal-hd">
      <div class="modal-title">üìã Ride History</div>
      <button class="modal-close" onclick="closeModal('histModal')">‚úï</button>
    </div>
    <div id="histList"><div style="text-align:center;color:var(--muted);padding:30px">Loading...</div></div>
  </div>
</div>

<!-- RATING MODAL -->
<div id="ratingModal" onclick="if(event.target===this)closeModal('ratingModal')">
  <div class="modal-box">
    <div class="modal-hd">
      <div class="modal-title">‚≠ê Rate Your Ride</div>
    </div>
    <div style="text-align:center">
      <div id="rateDriverName" style="font-size:.85rem;color:var(--muted);margin-bottom:4px">Your Driver</div>
      <div id="rateDriverPhoto" style="font-size:3rem;margin-bottom:8px">üë®üèΩ‚Äç‚úàÔ∏è</div>
      <div style="font-size:.75rem;color:var(--muted);margin-bottom:4px">Ride Experience Kaisa Tha?</div>
      <div class="stars-wrap" id="starsWrap">
        <span class="star-big" onclick="setRating(1)">‚òÖ</span>
        <span class="star-big" onclick="setRating(2)">‚òÖ</span>
        <span class="star-big" onclick="setRating(3)">‚òÖ</span>
        <span class="star-big" onclick="setRating(4)">‚òÖ</span>
        <span class="star-big" onclick="setRating(5)">‚òÖ</span>
      </div>
      <div id="ratingLabel" style="font-size:.8rem;color:var(--muted);min-height:20px;margin-bottom:12px"></div>
      <textarea id="ratingComment" class="fi" placeholder="Comment (optional)..." style="height:70px;resize:none;margin-bottom:12px"></textarea>
      <button class="mbtn y" style="margin-top:0" onclick="submitRating()">‚úÖ Submit Rating</button>
      <button class="mbtn" style="margin-top:8px;background:transparent;color:var(--muted);border:1px solid var(--border)" onclick="closeModal('ratingModal')">Skip</button>
    </div>
  </div>
</div>

<!-- RECEIPT MODAL -->
<div id="receiptModal" onclick="if(event.target===this)closeModal('receiptModal')">
  <div class="modal-box">
    <div class="modal-hd">
      <div class="modal-title">üßæ Ride Receipt</div>
      <button class="modal-close" onclick="closeModal('receiptModal')">‚úï</button>
    </div>
    <div style="text-align:center;margin-bottom:14px">
      <div style="font-size:.65rem;color:var(--muted);font-weight:700;text-transform:uppercase;letter-spacing:.05em">JDP CABS ‚Äî JAGDALPUR</div>
      <div style="font-size:.7rem;color:var(--muted);margin-top:2px" id="rcptDate">--</div>
    </div>
    <div id="rcptBody"></div>
    <div style="font-family:'Syne',sans-serif;font-weight:900;font-size:1.6rem;color:var(--green);text-align:center;padding:14px 0;border-top:1px solid var(--border);border-bottom:1px solid var(--border);margin:8px 0" id="rcptTotal">‚Çπ--</div>
    <div id="rcptShareBtns" style="margin-top:8px"></div>
  </div>
</div>

<!-- CANCEL REASON MODAL -->
<div id="cancelModal" onclick="if(event.target===this)closeModal('cancelModal')">
  <div class="modal-box">
    <div class="modal-hd">
      <div class="modal-title">‚ùå Cancel Ride</div>
      <button class="modal-close" onclick="closeModal('cancelModal')">‚úï</button>
    </div>
    <div style="font-size:.8rem;color:var(--muted);margin-bottom:14px">Cancel karne ki wajah batao:</div>
    <div id="cancelReasonList">
      <div class="cancel-opt" onclick="selectCancelReason(this,'Driver bahut door hai')">üöó Driver bahut door hai</div>
      <div class="cancel-opt" onclick="selectCancelReason(this,'Bahut zyada wait hua')">‚è∞ Bahut zyada wait hua</div>
      <div class="cancel-opt" onclick="selectCancelReason(this,'Plans change ho gaye')">üîÑ Plans change ho gaye</div>
      <div class="cancel-opt" onclick="selectCancelReason(this,'Galat location select hui')">üìç Galat location select hui</div>
      <div class="cancel-opt" onclick="selectCancelReason(this,'Doosra cab mil gaya')">üöï Doosra cab mil gaya</div>
      <div class="cancel-opt" onclick="selectCancelReason(this,'Koi aur karan')">üí¨ Koi aur karan</div>
    </div>
    <button class="mbtn ro" style="margin-top:8px" id="confirmCancelBtn" onclick="confirmCancelRide()" disabled>Cancel Ride ‚Üí</button>
  </div>
</div>

<!-- QUICK MESSAGES MODAL -->
<div id="msgModal" onclick="if(event.target===this)closeModal('msgModal')">
  <div class="modal-box">
    <div class="modal-hd">
      <div class="modal-title">üí¨ Quick Message</div>
      <button class="modal-close" onclick="closeModal('msgModal')">‚úï</button>
    </div>
    <div style="font-size:.8rem;color:var(--muted);margin-bottom:12px">Driver ko quick message bhejo:</div>
    <div id="qmsgs">
      <div class="qmsg-chip" onclick="sendQuickMsg('üìç Main pickup point par hoon')">üìç Main pickup par hoon</div>
      <div class="qmsg-chip" onclick="sendQuickMsg('‚è≥ 2 minute aur wait karo please')">‚è≥ 2 min wait karo</div>
      <div class="qmsg-chip" onclick="sendQuickMsg('üî¥ Gate ke bahar khada hoon')">üî¥ Gate ke bahar hoon</div>
      <div class="qmsg-chip" onclick="sendQuickMsg('üìû Please call karo')">üìû Call karo</div>
      <div class="qmsg-chip" onclick="sendQuickMsg('‚úÖ Aa raha hoon 1 min mein')">‚úÖ 1 min mein aa raha hoon</div>
      <div class="qmsg-chip" onclick="sendQuickMsg('üè† Building ke andar aao')">üè† Andar aao</div>
    </div>
    <div style="margin-top:14px">
      <textarea id="customMsgInput" class="fi" placeholder="Ya apna message type karo..." style="height:60px;resize:none;margin-bottom:9px"></textarea>
      <button class="mbtn b" style="margin-top:0" onclick="sendCustomMsg()">üì® Send Message</button>
    </div>
    <div id="msgSentConfirm" style="display:none;text-align:center;color:var(--green);font-size:.8rem;margin-top:9px">‚úÖ Message sent!</div>
  </div>
</div>

<!-- PROMO CODE MODAL -->
<div id="promoModal" onclick="if(event.target===this)closeModal('promoModal')">
  <div class="modal-box">
    <div class="modal-hd">
      <div class="modal-title">üéÅ Promo Code</div>
      <button class="modal-close" onclick="closeModal('promoModal')">‚úï</button>
    </div>
    <input type="text" class="fi" id="promoInput" placeholder="Code daalo (e.g. JDP50)" style="text-transform:uppercase;margin-bottom:10px;letter-spacing:.08em;font-weight:700;" oninput="this.value=this.value.toUpperCase()">
    <button class="mbtn y" style="margin-top:0" onclick="applyPromo()">‚úÖ Apply</button>
    <div id="promoResult" style="margin-top:10px;text-align:center;font-size:.82rem"></div>
    <div style="margin-top:16px;font-size:.72rem;color:var(--muted);font-weight:700;text-transform:uppercase;letter-spacing:.04em;margin-bottom:8px">Available Offers</div>
    <div onclick="document.getElementById('promoInput').value='JDP50';applyPromo()" style="background:rgba(139,92,246,.08);border:1px solid rgba(139,92,246,.2);border-radius:12px;padding:10px 13px;margin-bottom:8px;cursor:pointer">
      <div style="font-weight:800;font-size:.88rem">üéâ JDP50 ‚Äî ‚Çπ50 Off</div>
      <div style="font-size:.7rem;color:var(--muted);margin-top:2px">Pehli ride par ‚Çπ50 discount</div>
    </div>
    <div onclick="document.getElementById('promoInput').value='FREE1';applyPromo()" style="background:rgba(16,185,129,.08);border:1px solid rgba(16,185,129,.2);border-radius:12px;padding:10px 13px;cursor:pointer">
      <div style="font-weight:800;font-size:.88rem">üöñ FREE1 ‚Äî Pehli Ride Free</div>
      <div style="font-size:.7rem;color:var(--muted);margin-top:2px">Max ‚Çπ100 tak free (New users only)</div>
    </div>
  </div>
</div>

<!-- NET -->
<div class="netb" id="netB">‚ö†Ô∏è No Internet</div>

<!-- FIREBASE -->
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
import { getFirestore, doc, setDoc, getDoc, getDocs, collection, addDoc, updateDoc, deleteDoc, onSnapshot, query, where, orderBy, limit, serverTimestamp, GeoPoint } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

const cfg = {
  apiKey:"AIzaSyBRPV3mosWr3YFnW6xCfJaqC1bV4MhJm_Y",
  authDomain:"jdpcabs.firebaseapp.com",
  projectId:"jdpcabs",
  storageBucket:"jdpcabs.firebasestorage.app",
  messagingSenderId:"148264332732",
  appId:"1:148264332732:web:eed512ac4e685cef97cfb9"
};
try {
  const fbApp = initializeApp(cfg);
  const auth = getAuth(fbApp);
  const db = getFirestore(fbApp);
  window.FB = { auth, db, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, onAuthStateChanged,
    doc, setDoc, getDoc, getDocs, collection, addDoc, updateDoc, deleteDoc, onSnapshot, query, where, orderBy, limit, serverTimestamp, GeoPoint };
  window.FB_READY = true;
  document.getElementById('fbBadge').className = 'fbb ok';
  document.getElementById('fbBadge').textContent = '‚úÖ Firebase Live';
} catch(e) {
  window.FB_READY = false;
  document.getElementById('fbBadge').className = 'fbb er';
  document.getElementById('fbBadge').textContent = '‚ùå Firebase Error';
}
</script>

<script>
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// ‚úÖ JAGDALPUR CONFIG ‚Äî City coordinates & zones
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const JDPC = { lat: 19.0760, lng: 82.0150 };  // Jagdalpur city center
const ZONE_CORE   = 3;   // km ‚Äî City core (Green)
const ZONE_CITY   = 8;   // km ‚Äî City zone (Blue) ‚Äî main service area
const ZONE_OUTER  = 15;  // km ‚Äî Outer area (Yellow)
const MATCH_RADIUS_1 = 5; // km ‚Äî First try matching within 5km
const MATCH_RADIUS_2 = 8; // km ‚Äî Then expand to 8km

// ‚úÖ JAGDALPUR COMPLETE LOCAL ADDRESS DATABASE ‚Äî 200+ locations
// Roads, Mohallas, Hospitals, Schools, Markets, Shops, Govt Offices
const JAGDALPUR_LANDMARKS = [

  // ‚ïê‚ïê MAJOR LANDMARKS ‚ïê‚ïê
  { name:'Bastar Palace',                lat:19.0741, lng:82.0192, icon:'üèØ', info:'Historic Royal Palace, Jagdalpur', cat:'landmark' },
  { name:'Jagdalpur Bus Stand',          lat:19.0798, lng:82.0087, icon:'üöå', info:'Main State Bus Stand', cat:'transport' },
  { name:'Jagdalpur Railway Station',    lat:19.0650, lng:82.0310, icon:'üöÇ', info:'Railway Station, Jagdalpur', cat:'transport' },
  { name:'Swami Vivekananda Airport',    lat:19.0600, lng:82.0580, icon:'‚úàÔ∏è', info:'Jagdalpur Airport', cat:'transport' },
  { name:'Collectorate Jagdalpur',       lat:19.0734, lng:82.0141, icon:'üèõÔ∏è', info:'District Collectorate', cat:'govt' },
  { name:'Danteshwari Temple',           lat:19.0756, lng:82.0165, icon:'üõï', info:'Maa Danteshwari Mandir', cat:'temple' },
  { name:'Chitrakote Waterfall',         lat:19.2100, lng:81.8600, icon:'üåä', info:'India Niagara, ~40km', cat:'tourism' },
  { name:'Kanger Valley National Park',  lat:19.0500, lng:81.9000, icon:'üåø', info:'National Park entrance', cat:'tourism' },

  // ‚ïê‚ïê HOSPITALS & MEDICAL ‚ïê‚ïê
  { name:'Maharaja Hospital',            lat:19.0712, lng:82.0223, icon:'üè•', info:'District Hospital, Main Road', cat:'hospital' },
  { name:'Govt Medical College',         lat:19.0700, lng:82.0280, icon:'‚öïÔ∏è', info:'Govt Medical College & Hospital', cat:'hospital' },
  { name:'DKS Hospital',                 lat:19.0730, lng:82.0200, icon:'üè•', info:'DKS Super Speciality Hospital', cat:'hospital' },
  { name:'Community Health Centre',      lat:19.0760, lng:82.0120, icon:'üè•', info:'CHC Jagdalpur', cat:'hospital' },
  { name:'District Hospital Jagdalpur',  lat:19.0715, lng:82.0190, icon:'üè•', info:'District Hospital', cat:'hospital' },
  { name:'Ayurvedic Hospital',           lat:19.0740, lng:82.0170, icon:'üåø', info:'Govt Ayurvedic Hospital', cat:'hospital' },
  { name:'Apollo Clinic Jagdalpur',      lat:19.0755, lng:82.0155, icon:'üè•', info:'Apollo Pharmacy & Clinic', cat:'hospital' },
  { name:'Jan Swasthya Sahayog',         lat:19.0780, lng:82.0100, icon:'‚öïÔ∏è', info:'Health Centre', cat:'hospital' },

  // ‚ïê‚ïê SCHOOLS & COLLEGES ‚ïê‚ïê
  { name:'JNKVV College',                lat:19.0820, lng:81.9980, icon:'üéì', info:'Jawaharlal Nehru Krishi Vishwa Vidyalaya', cat:'education' },
  { name:'Govt Engineering College',     lat:19.0850, lng:81.9950, icon:'üéì', info:'Govt Engineering College Jagdalpur', cat:'education' },
  { name:'Govt PG College',              lat:19.0760, lng:82.0130, icon:'üéì', info:'Govt Post Graduate College', cat:'education' },
  { name:'Bastar University',            lat:19.0800, lng:82.0050, icon:'üéì', info:'Shaheed Mahendra Karma Vishwavidyalaya', cat:'education' },
  { name:'St Xavier School',             lat:19.0770, lng:82.0170, icon:'üè´', info:"St. Xavier's Higher Secondary School", cat:'education' },
  { name:'Kendriya Vidyalaya',           lat:19.0720, lng:82.0240, icon:'üè´', info:'Kendriya Vidyalaya Jagdalpur', cat:'education' },
  { name:'Navodaya Vidyalaya',           lat:19.0680, lng:82.0300, icon:'üè´', info:'Jawahar Navodaya Vidyalaya', cat:'education' },
  { name:'DPS Jagdalpur',                lat:19.0810, lng:82.0060, icon:'üè´', info:'Delhi Public School', cat:'education' },
  { name:'Govt Boys High School',        lat:19.0745, lng:82.0185, icon:'üè´', info:'Govt Higher Secondary School Boys', cat:'education' },
  { name:'Govt Girls School',            lat:19.0750, lng:82.0200, icon:'üè´', info:'Govt Higher Secondary School Girls', cat:'education' },
  { name:'Dharampura School',            lat:19.0790, lng:82.0110, icon:'üè´', info:'Primary School Dharampura', cat:'education' },
  { name:'BIT College',                  lat:19.0830, lng:81.9970, icon:'üéì', info:'Bastar Institute of Technology', cat:'education' },
  { name:'ITI Jagdalpur',                lat:19.0700, lng:82.0260, icon:'üéì', info:'Industrial Training Institute', cat:'education' },
  { name:'Polytechnic College',          lat:19.0720, lng:82.0250, icon:'üéì', info:'Govt Polytechnic College', cat:'education' },

  // ‚ïê‚ïê MARKETS & SHOPPING ‚ïê‚ïê
  { name:'Gol Bazar',                    lat:19.0760, lng:82.0150, icon:'üõçÔ∏è', info:'Main Market, City Center', cat:'market' },
  { name:'Lal Bazar Jagdalpur',          lat:19.0755, lng:82.0158, icon:'üõçÔ∏è', info:'Lal Bazar Main Market', cat:'market' },
  { name:'Dhanteras Market',             lat:19.0762, lng:82.0145, icon:'üõí', info:'Weekly Market Area', cat:'market' },
  { name:'Subhash Market',               lat:19.0758, lng:82.0155, icon:'üõçÔ∏è', info:'Subhash Market Complex', cat:'market' },
  { name:'Cloth Market Jagdalpur',       lat:19.0760, lng:82.0148, icon:'üëó', info:'Kapda Market, Jagdalpur', cat:'market' },
  { name:'Sabzi Mandi Jagdalpur',        lat:19.0775, lng:82.0130, icon:'ü•¶', info:'Vegetable Market', cat:'market' },
  { name:'Grain Market',                 lat:19.0770, lng:82.0135, icon:'üåæ', info:'Anaj Mandi Jagdalpur', cat:'market' },
  { name:'Iron Market Jagdalpur',        lat:19.0758, lng:82.0160, icon:'üîß', info:'Loha Bazaar', cat:'market' },
  { name:'City Mall Jagdalpur',          lat:19.0752, lng:82.0165, icon:'üè¨', info:'Shopping Mall', cat:'mall' },
  { name:'Bastar Mall',                  lat:19.0748, lng:82.0175, icon:'üè¨', info:'Bastar Shopping Complex', cat:'mall' },
  { name:'Reliance Smart',               lat:19.0755, lng:82.0162, icon:'üõí', info:'Reliance Supermarket', cat:'mall' },
  { name:'Big Bazaar Jagdalpur',         lat:19.0750, lng:82.0168, icon:'üõí', info:'Big Bazaar / D-Mart area', cat:'mall' },
  { name:'Shree Ram Cloth House',        lat:19.0761, lng:82.0150, icon:'üëï', info:'Kapda Store, Gol Bazar', cat:'shop' },
  { name:'Sharma Electronics',           lat:19.0759, lng:82.0152, icon:'üì±', info:'Electronics Market', cat:'shop' },
  { name:'Book Market Jagdalpur',        lat:19.0756, lng:82.0157, icon:'üìö', info:'Kitab Bazaar', cat:'shop' },

  // ‚ïê‚ïê MOHALLAS & COLONIES ‚ïê‚ïê
  { name:'Dharampura',                   lat:19.0790, lng:82.0110, icon:'üèòÔ∏è', info:'Dharampura Mohalla', cat:'area' },
  { name:'Shiv Nagar Colony',            lat:19.0780, lng:82.0090, icon:'üèòÔ∏è', info:'Shiv Nagar Residential', cat:'area' },
  { name:'Gandhi Nagar Jagdalpur',       lat:19.0770, lng:82.0120, icon:'üèòÔ∏è', info:'Gandhi Nagar Colony', cat:'area' },
  { name:'Nehru Nagar Jagdalpur',        lat:19.0765, lng:82.0140, icon:'üèòÔ∏è', info:'Nehru Nagar Area', cat:'area' },
  { name:'Ambedkar Nagar',               lat:19.0785, lng:82.0105, icon:'üèòÔ∏è', info:'Ambedkar Nagar Colony', cat:'area' },
  { name:'Ram Nagar Jagdalpur',          lat:19.0795, lng:82.0095, icon:'üèòÔ∏è', info:'Ram Nagar Mohalla', cat:'area' },
  { name:'Sunder Nagar',                 lat:19.0760, lng:82.0170, icon:'üèòÔ∏è', info:'Sunder Nagar Colony', cat:'area' },
  { name:'Indira Nagar Jagdalpur',       lat:19.0740, lng:82.0200, icon:'üèòÔ∏è', info:'Indira Nagar Area', cat:'area' },
  { name:'Shankar Nagar Jagdalpur',      lat:19.0730, lng:82.0210, icon:'üèòÔ∏è', info:'Shankar Nagar Colony', cat:'area' },
  { name:'Tilak Nagar Jagdalpur',        lat:19.0725, lng:82.0220, icon:'üèòÔ∏è', info:'Tilak Nagar Residential', cat:'area' },
  { name:'Durkigudapara',                lat:19.0800, lng:82.0080, icon:'üèòÔ∏è', info:'Durkigudapara Area', cat:'area' },
  { name:'Manikpur Colony',              lat:19.0815, lng:82.0065, icon:'üèòÔ∏è', info:'Manikpur Residential', cat:'area' },
  { name:'Kumarapara',                   lat:19.0750, lng:82.0180, icon:'üèòÔ∏è', info:'Kumarapara Mohalla', cat:'area' },
  { name:'Singanpur',                    lat:19.0770, lng:82.0080, icon:'üèòÔ∏è', info:'Singanpur Area', cat:'area' },
  { name:'Umarwara',                     lat:19.0680, lng:82.0340, icon:'üèòÔ∏è', info:'Umarwara Colony', cat:'area' },
  { name:'Tikrapara Jagdalpur',          lat:19.0760, lng:82.0190, icon:'üèòÔ∏è', info:'Tikrapara Area', cat:'area' },
  { name:'Bhadrapara',                   lat:19.0735, lng:82.0210, icon:'üèòÔ∏è', info:'Bhadrapara Colony', cat:'area' },
  { name:'Golapara',                     lat:19.0820, lng:82.0070, icon:'üèòÔ∏è', info:'Golapara Mohalla', cat:'area' },
  { name:'Potkapara',                    lat:19.0710, lng:82.0270, icon:'üèòÔ∏è', info:'Potkapara Area', cat:'area' },
  { name:'Kotenar',                      lat:19.0830, lng:82.0050, icon:'üèòÔ∏è', info:'Kotenar Area', cat:'area' },
  { name:'Keshlur',                      lat:19.0660, lng:82.0350, icon:'üèòÔ∏è', info:'Keshlur Colony', cat:'area' },
  { name:'Kachanar Colony',              lat:19.0840, lng:82.0040, icon:'üèòÔ∏è', info:'Kachanar Residential', cat:'area' },
  { name:'Subhash Nagar Jagdalpur',      lat:19.0755, lng:82.0175, icon:'üèòÔ∏è', info:'Subhash Nagar Colony', cat:'area' },
  { name:'Laxmi Nagar Jagdalpur',        lat:19.0745, lng:82.0185, icon:'üèòÔ∏è', info:'Laxmi Nagar Area', cat:'area' },
  { name:'Patel Nagar Jagdalpur',        lat:19.0775, lng:82.0100, icon:'üèòÔ∏è', info:'Patel Nagar Mohalla', cat:'area' },
  { name:'Civil Lines Jagdalpur',        lat:19.0720, lng:82.0230, icon:'üèòÔ∏è', info:'Civil Lines Residential Area', cat:'area' },
  { name:'Rajendra Nagar Jagdalpur',     lat:19.0730, lng:82.0215, icon:'üèòÔ∏è', info:'Rajendra Nagar Colony', cat:'area' },
  { name:'New Bus Stand Colony',         lat:19.0795, lng:82.0090, icon:'üèòÔ∏è', info:'Near New Bus Stand Area', cat:'area' },
  { name:'Station Road Colony',          lat:19.0660, lng:82.0315, icon:'üèòÔ∏è', info:'Near Railway Station', cat:'area' },

  // ‚ïê‚ïê MAIN ROADS & CHOWKS ‚ïê‚ïê
  { name:'Mahatma Gandhi Chowk',         lat:19.0762, lng:82.0147, icon:'üîÑ', info:'Main Chowk, City Center', cat:'road' },
  { name:'Netaji Chowk Jagdalpur',       lat:19.0758, lng:82.0153, icon:'üîÑ', info:'Netaji Subhash Chowk', cat:'road' },
  { name:'Dharampura Chowk',             lat:19.0788, lng:82.0112, icon:'üîÑ', info:'Dharampura Crossing', cat:'road' },
  { name:'Hospital Chowk Jagdalpur',     lat:19.0715, lng:82.0218, icon:'üîÑ', info:'Near Hospital Crossing', cat:'road' },
  { name:'Collectorate Chowk',           lat:19.0736, lng:82.0138, icon:'üîÑ', info:'Collectorate Crossing', cat:'road' },
  { name:'Station Road Jagdalpur',       lat:19.0660, lng:82.0320, icon:'üõ£Ô∏è', info:'Railway Station Road', cat:'road' },
  { name:'Main Road Jagdalpur',          lat:19.0760, lng:82.0150, icon:'üõ£Ô∏è', info:'NH-30 Main Road', cat:'road' },
  { name:'NH-30 Jagdalpur',              lat:19.0760, lng:82.0200, icon:'üõ£Ô∏è', info:'National Highway 30', cat:'road' },
  { name:'NH-63 Jagdalpur',              lat:19.0700, lng:82.0100, icon:'üõ£Ô∏è', info:'National Highway 63', cat:'road' },
  { name:'Bus Stand Road',               lat:19.0793, lng:82.0093, icon:'üõ£Ô∏è', info:'Road to Bus Stand', cat:'road' },
  { name:'Airport Road Jagdalpur',       lat:19.0620, lng:82.0490, icon:'üõ£Ô∏è', info:'Road to Airport', cat:'road' },
  { name:'Bastar Palace Road',           lat:19.0743, lng:82.0188, icon:'üõ£Ô∏è', info:'Palace Road', cat:'road' },
  { name:'College Road Jagdalpur',       lat:19.0815, lng:81.9985, icon:'üõ£Ô∏è', info:'College Area Road', cat:'road' },
  { name:'Medical College Road',         lat:19.0705, lng:82.0272, icon:'üõ£Ô∏è', info:'Road to Medical College', cat:'road' },
  { name:'Ring Road Jagdalpur',          lat:19.0850, lng:82.0100, icon:'üõ£Ô∏è', info:'Ring Road Bypass', cat:'road' },
  { name:'Bypass Road Jagdalpur',        lat:19.0880, lng:82.0080, icon:'üõ£Ô∏è', info:'NH Bypass Road', cat:'road' },
  { name:'Dharampura Road',              lat:19.0790, lng:82.0108, icon:'üõ£Ô∏è', info:'Dharampura Main Road', cat:'road' },
  { name:'Tikrapara Road',               lat:19.0755, lng:82.0185, icon:'üõ£Ô∏è', info:'Tikrapara Colony Road', cat:'road' },
  { name:'Kanger Valley Road',           lat:19.0600, lng:81.9800, icon:'üõ£Ô∏è', info:'Road to Kanger Valley', cat:'road' },

  // ‚ïê‚ïê GOVERNMENT OFFICES ‚ïê‚ïê
  { name:'SP Office Jagdalpur',          lat:19.0730, lng:82.0148, icon:'üöî', info:'Superintendent of Police Office', cat:'govt' },
  { name:'CMHO Office Jagdalpur',        lat:19.0728, lng:82.0160, icon:'üèõÔ∏è', info:'Chief Medical Health Officer', cat:'govt' },
  { name:'Tehsildar Office',             lat:19.0732, lng:82.0143, icon:'üèõÔ∏è', info:'Tehsil Office Jagdalpur', cat:'govt' },
  { name:'PWD Office Jagdalpur',         lat:19.0726, lng:82.0155, icon:'üèõÔ∏è', info:'Public Works Department', cat:'govt' },
  { name:'Forest Office Jagdalpur',      lat:19.0720, lng:82.0165, icon:'üå≥', info:'Divisional Forest Office', cat:'govt' },
  { name:'Court Compound Jagdalpur',     lat:19.0735, lng:82.0145, icon:'‚öñÔ∏è', info:'District Court Jagdalpur', cat:'govt' },
  { name:'Jail Jagdalpur',               lat:19.0710, lng:82.0200, icon:'üèõÔ∏è', info:'District Jail', cat:'govt' },
  { name:'Post Office Jagdalpur',        lat:19.0758, lng:82.0160, icon:'üìÆ', info:'Head Post Office', cat:'govt' },
  { name:'SBI Bank Main Branch',         lat:19.0757, lng:82.0158, icon:'üè¶', info:'State Bank of India Main', cat:'bank' },
  { name:'Bank of Baroda Jagdalpur',     lat:19.0759, lng:82.0155, icon:'üè¶', info:'Bank of Baroda Branch', cat:'bank' },
  { name:'PNB Bank Jagdalpur',           lat:19.0761, lng:82.0151, icon:'üè¶', info:'Punjab National Bank', cat:'bank' },
  { name:'HDFC Bank Jagdalpur',          lat:19.0754, lng:82.0163, icon:'üè¶', info:'HDFC Bank Branch', cat:'bank' },
  { name:'Axis Bank Jagdalpur',          lat:19.0756, lng:82.0161, icon:'üè¶', info:'Axis Bank ATM & Branch', cat:'bank' },
  { name:'Income Tax Office',            lat:19.0728, lng:82.0150, icon:'üèõÔ∏è', info:'IT Office Jagdalpur', cat:'govt' },
  { name:'CGSEB Office',                 lat:19.0724, lng:82.0162, icon:'üí°', info:'Electricity Board Office', cat:'govt' },
  { name:'Nagar Palika Jagdalpur',       lat:19.0738, lng:82.0140, icon:'üèõÔ∏è', info:'Municipal Council Office', cat:'govt' },
  { name:'DRDA Office Jagdalpur',        lat:19.0732, lng:82.0148, icon:'üèõÔ∏è', info:'District Rural Dev Authority', cat:'govt' },

  // ‚ïê‚ïê PETROL PUMPS ‚ïê‚ïê
  { name:'IOC Petrol Pump Main Road',    lat:19.0765, lng:82.0143, icon:'‚õΩ', info:'Indian Oil Petrol Pump', cat:'fuel' },
  { name:'HPCL Petrol Pump',             lat:19.0800, lng:82.0085, icon:'‚õΩ', info:'HP Petrol Pump, Bus Stand Road', cat:'fuel' },
  { name:'BPCL Petrol Pump',             lat:19.0710, lng:82.0265, icon:'‚õΩ', info:'Bharat Petrol Pump', cat:'fuel' },
  { name:'Petrol Pump Airport Road',     lat:19.0625, lng:82.0470, icon:'‚õΩ', info:'Fuel Station, Airport Road', cat:'fuel' },
  { name:'Petrol Pump NH-30',            lat:19.0870, lng:82.0070, icon:'‚õΩ', info:'Petrol Pump, National Highway 30', cat:'fuel' },

  // ‚ïê‚ïê TEMPLES & RELIGIOUS ‚ïê‚ïê
  { name:'Shiv Mandir Dharampura',       lat:19.0792, lng:82.0108, icon:'üõï', info:'Shiv Mandir, Dharampura', cat:'temple' },
  { name:'Hanuman Mandir Main Road',     lat:19.0763, lng:82.0145, icon:'üõï', info:'Hanuman Temple, Main Road', cat:'temple' },
  { name:'Kali Mata Mandir',             lat:19.0748, lng:82.0178, icon:'üõï', info:'Kali Mandir Jagdalpur', cat:'temple' },
  { name:'Masjid Jagdalpur',             lat:19.0768, lng:82.0137, icon:'üïå', info:'Jama Masjid, Jagdalpur', cat:'temple' },
  { name:'Church Jagdalpur',             lat:19.0775, lng:82.0125, icon:'‚õ™', info:'Christian Church', cat:'temple' },
  { name:'Gurudwara Jagdalpur',          lat:19.0772, lng:82.0130, icon:'‚õ©Ô∏è', info:'Gurudwara Sahib', cat:'temple' },
  { name:'Ram Mandir Jagdalpur',         lat:19.0778, lng:82.0118, icon:'üõï', info:'Ram Mandir Colony', cat:'temple' },
  { name:'Durga Mandir',                 lat:19.0745, lng:82.0183, icon:'üõï', info:'Durga Mata Mandir', cat:'temple' },

  // ‚ïê‚ïê HOTELS & RESTAURANTS ‚ïê‚ïê
  { name:'Hotel Bastar Residency',       lat:19.0756, lng:82.0162, icon:'üè®', info:'Hotel near City Center', cat:'hotel' },
  { name:'Hotel Panchvati',              lat:19.0758, lng:82.0158, icon:'üè®', info:'Panchvati Hotel Jagdalpur', cat:'hotel' },
  { name:'Hotel Arogya',                 lat:19.0762, lng:82.0148, icon:'üè®', info:'Budget Hotel Jagdalpur', cat:'hotel' },
  { name:'Krishna Hotel',                lat:19.0760, lng:82.0152, icon:'üçΩÔ∏è', info:'Restaurant, Main Road', cat:'hotel' },
  { name:'Bastar Dhaba',                 lat:19.0770, lng:82.0132, icon:'üçΩÔ∏è', info:'Local Dhaba, City Center', cat:'hotel' },
  { name:'Hotel Kanker Palace',          lat:19.0753, lng:82.0165, icon:'üè®', info:'Hotel near Palace', cat:'hotel' },
  { name:'Rajmahal Restaurant',          lat:19.0761, lng:82.0149, icon:'üçΩÔ∏è', info:'Popular Restaurant', cat:'hotel' },

  // ‚ïê‚ïê FAMOUS AREAS NEAR JAGDALPUR ‚ïê‚ïê
  { name:'Darbha',                       lat:19.1500, lng:81.9000, icon:'üè°', info:'Darbha Town ~30km', cat:'area' },
  { name:'Tokapal',                      lat:19.0000, lng:81.9200, icon:'üè°', info:'Tokapal Area ~20km', cat:'area' },
  { name:'Nagaras',                      lat:19.1000, lng:82.0500, icon:'üè°', info:'Nagaras Village', cat:'area' },
  { name:'Barsur',                       lat:19.1800, lng:81.7500, icon:'üè°', info:'Barsur Historical ~50km', cat:'area' },
  { name:'Kondagaon',                    lat:19.5950, lng:81.6678, icon:'üè°', info:'Kondagaon District ~90km', cat:'area' },
  { name:'Sukma',                        lat:18.3911, lng:81.6600, icon:'üè°', info:'Sukma ~170km', cat:'area' },
  { name:'Bijapur CG',                   lat:18.8000, lng:80.8000, icon:'üè°', info:'Bijapur ~200km', cat:'area' },
  { name:'Narayanpur',                   lat:19.7047, lng:81.2378, icon:'üè°', info:'Narayanpur ~130km', cat:'area' },
  { name:'Kanker',                       lat:20.2737, lng:81.4899, icon:'üè°', info:'Kanker ~100km', cat:'area' },

  // ‚ïê‚ïê AUTO STANDS & TAXI POINTS ‚ïê‚ïê
  { name:'Auto Stand Gol Bazar',         lat:19.0762, lng:82.0147, icon:'üõ∫', info:'Auto Rickshaw Stand, Gol Bazar', cat:'transport' },
  { name:'Auto Stand Bus Stand',         lat:19.0800, lng:82.0085, icon:'üõ∫', info:'Auto Stand near Bus Stand', cat:'transport' },
  { name:'Auto Stand Station',           lat:19.0652, lng:82.0312, icon:'üõ∫', info:'Auto Stand, Railway Station', cat:'transport' },
  { name:'Taxi Stand Jagdalpur',         lat:19.0762, lng:82.0145, icon:'üöï', info:'Taxi Stand, Main Market', cat:'transport' },

  // ‚ïê‚ïê POPULAR SHOPS & SERVICES ‚ïê‚ïê
  { name:'Vishal Mega Mart Jagdalpur',   lat:19.0751, lng:82.0167, icon:'üõí', info:'Vishal Mega Mart', cat:'shop' },
  { name:'Medical Store Main Road',      lat:19.0758, lng:82.0157, icon:'üíä', info:'Medical & Pharmacy Store', cat:'shop' },
  { name:'Mobile Market Jagdalpur',      lat:19.0760, lng:82.0151, icon:'üì±', info:'Mobile Phone Market', cat:'shop' },
  { name:'Furniture Market',             lat:19.0770, lng:82.0135, icon:'ü™ë', info:'Furniture Bazaar Jagdalpur', cat:'shop' },
  { name:'Hardware Market',              lat:19.0765, lng:82.0140, icon:'üî©', info:'Hardware & Tools Market', cat:'shop' },
  { name:'Ration Depot Jagdalpur',       lat:19.0772, lng:82.0128, icon:'üè™', info:'Fair Price Shop', cat:'shop' },
  { name:'Kirana Store Dharampura',      lat:19.0792, lng:82.0110, icon:'üè™', info:'General Store Dharampura', cat:'shop' },
  { name:'Cold Storage Jagdalpur',       lat:19.0780, lng:82.0105, icon:'‚ùÑÔ∏è', info:'Cold Storage Facility', cat:'shop' },

  // ‚ïê‚ïê SPORTS & RECREATION ‚ïê‚ïê
  { name:'Football Ground Jagdalpur',    lat:19.0740, lng:82.0195, icon:'‚öΩ', info:'Municipal Football Ground', cat:'sports' },
  { name:'Cricket Ground Jagdalpur',     lat:19.0720, lng:82.0235, icon:'üèè', info:'Cricket Stadium Jagdalpur', cat:'sports' },
  { name:'Indoor Stadium Jagdalpur',     lat:19.0748, lng:82.0180, icon:'üèüÔ∏è', info:'Indoor Sports Complex', cat:'sports' },
  { name:'Parade Ground',               lat:19.0730, lng:82.0205, icon:'üèüÔ∏è', info:'Parade Maidan Jagdalpur', cat:'sports' },
  { name:'Bastar Dussehra Ground',      lat:19.0750, lng:82.0170, icon:'üé™', info:'Famous Dussehra Festival Ground', cat:'sports' },

  // ‚ïê‚ïê WATER BODIES ‚ïê‚ïê
  { name:'Dalpit Sagar Lake',            lat:19.0760, lng:82.0130, icon:'üåä', info:'Dalpit Sagar Talab', cat:'landmark' },
  { name:'Indravati River Ghat',         lat:19.0850, lng:82.0200, icon:'üåä', info:'Indravati River Bank', cat:'landmark' },
  { name:'Murnar River',                 lat:19.0900, lng:82.0100, icon:'üåä', info:'Murnar Nadi Ghat', cat:'landmark' },
];

// Quick lookup by name for autocomplete
const LM_NAMES = JAGDALPUR_LANDMARKS.map(l => l.name.toLowerCase());

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// STATE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let CU = null;
let authRole = 'rider';
let selVehType = 'auto';
let isLoaded = false;
let surgeActive = false;

let leafMap = null;
let routePolyline = null;
let zoneCircles = [];
let landmarkMarkers = [];
let landmarksVisible = true;  // ‚úÖ Show Jagdalpur city landmarks by default
let liveDriverMarkers = {};  // driverId ‚Üí mappls.Marker
let liveDriversListener = null;

let myMarker = null, pickupMk = null, dropMk = null, driverMk = null;
let prevDriverLat = null, prevDriverLng = null;
let driverMarkerInterval = null;

let watchId = null;
let myLat = null, myLng = null;
let pickLat = null, pickLng = null, pickAddr = '';

let fareA = 0, fareM = 0, distKM = 0;
let cabType = 'JDP Auto', cabFare = 0;

let rideDocId = null;
let rideListener = null;
let driverLocListener = null;

let isOnline = false;
let newRideListener = null;
let curReqId = null, curReqData = null;
let navPhase = 'pickup';
let dEarnings = 0, dRides = 0;
let onlineStart = null;
let reqTimer = 60, reqInterval = null;
let onlineTimeInterval = null;

const routeCache = {};

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// ‚úÖ AUDIO ‚Äî Uber-style sounds
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let audioCtx = null;
function getACtx() {
  if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
  return audioCtx;
}
function playTone(freq, start, dur, type='sine', vol=0.4) {
  try {
    const ctx = getACtx();
    const o = ctx.createOscillator();
    const g = ctx.createGain();
    o.connect(g); g.connect(ctx.destination);
    o.type = type; o.frequency.setValueAtTime(freq, ctx.currentTime + start);
    g.gain.setValueAtTime(0, ctx.currentTime + start);
    g.gain.linearRampToValueAtTime(vol, ctx.currentTime + start + 0.02);
    g.gain.exponentialRampToValueAtTime(0.001, ctx.currentTime + start + dur);
    o.start(ctx.currentTime + start);
    o.stop(ctx.currentTime + start + dur);
  } catch(e) {}
}
function playDriverAssigned() {
  // Uber-like triumphant 4-note melody
  playTone(523, 0,    0.15, 'sine', 0.3);
  playTone(659, 0.18, 0.15, 'sine', 0.35);
  playTone(784, 0.36, 0.15, 'sine', 0.4);
  playTone(1047,0.54, 0.4,  'sine', 0.45);
}
function playNewRide() {
  // Urgent ding-ding-ding for driver
  playTone(880, 0,   0.12, 'triangle', 0.4);
  playTone(880, 0.16,0.12, 'triangle', 0.4);
  playTone(1100,0.32,0.18, 'triangle', 0.45);
  playTone(1100,0.52,0.22, 'triangle', 0.45);
}
function playSurge() {
  playTone(400, 0, 0.08, 'sawtooth', 0.2);
  playTone(500, 0.1, 0.12, 'sawtooth', 0.25);
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// LOADER
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let lp = 0;
const lpInt = setInterval(() => { if(lp<85){lp+=12;document.getElementById('ldBar').style.width=lp+'%';} }, 200);
function finishLoad() {
  if (isLoaded) return; isLoaded = true;
  clearInterval(lpInt);
  document.getElementById('ldBar').style.width = '100%';
  document.getElementById('ldStatus').textContent = 'Ready! üöñ Jagdalpur';
  setTimeout(() => {
    document.getElementById('loader').style.display = 'none';
    if (!CU) document.getElementById('auth').style.display = 'flex';
    initMap();
  }, 350);
}
let fbWait = 0;
const fbWI = setInterval(() => { fbWait++; if (window.FB_READY !== undefined || fbWait > 25) { clearInterval(fbWI); finishLoad(); } }, 140);
setTimeout(finishLoad, 4000);

window.addEventListener('offline', () => document.getElementById('netB').style.display = 'block');
window.addEventListener('online', () => { document.getElementById('netB').style.display = 'none'; toast('üåê Back online!'); });

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// ‚úÖ MAP ‚Äî Full Mappls v3 SDK (India Vector Maps, Uber-level)
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

// ‚úÖ Network quality check ‚Äî degrade gracefully for slow connections

// ‚úÖ Safe Firebase wrapper with retry ‚Äî handles 50K concurrent users
async function fbSafe(operation, retries=2) {
  for (let i=0; i<=retries; i++) {
    try {
      return await operation();
    } catch(e) {
      if (i === retries) {
        console.warn('[JDP] Firebase op failed after retries:', e.code || e.message);
        return null;
      }
      // Exponential backoff: 500ms, 1000ms
      await new Promise(r => setTimeout(r, 500 * Math.pow(2, i)));
    }
  }
}

function checkNetworkQuality() {
  const conn = navigator.connection || navigator.mozConnection || navigator.webkitConnection;
  if (conn) {
    const slow = conn.effectiveType === '2g' || conn.effectiveType === 'slow-2g' || conn.saveData;
    if (slow) {
      window.LOW_BANDWIDTH = true;
      // Disable landmark markers on slow connections
      landmarksVisible = false;
      console.log('[JDP] Low bandwidth detected ‚Äî reduced mode');
    }
  }
}

function initMap() {
  if (typeof mappls === 'undefined') { setTimeout(initMap, 400); return; }
  try {
    // ‚úÖ Mappls v3 Map ‚Äî India's best vector map, MapmyIndia tiles
    leafMap = new mappls.Map('map', {
      center: { lat: JDPC.lat, lng: JDPC.lng },
      zoom: 14,  // ‚úÖ Closer zoom ‚Äî Jagdalpur streets visible
      zoomControl: false,          // we have custom Uber zoom buttons
      clickableIcons: true,
      fullscreenControl: false,
      search: false
    });

    // ‚úÖ Wait for map tiles to fully load, then draw overlays
    leafMap.on('load', function() {
      drawCityZones();
      addLandmarkMarkers();
      document.getElementById('ldStatus').textContent = '‚úÖ Jagdalpur map loaded (Mappls)';
      document.getElementById('mapStats').style.display = 'block';
    });

  } catch(e) { console.error('[JDP] Map init error:', e); setTimeout(initMap, 1000); }
}

// ‚úÖ Uber-style smooth zoom functions
function zoomIn()  { if(leafMap) leafMap.zoomIn(1,  {animate:true}); }
function zoomOut() { if(leafMap) leafMap.zoomOut(1, {animate:true}); }

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// ‚úÖ JAGDALPUR CITY ZONES ‚Äî 3 concentric circles
// Like Uber surge zones but for Jagdalpur
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function drawCityZones() {
  if (!leafMap) return;
  clearZones();

  // ‚úÖ Outer area ‚Äî Yellow (15km)
  const outerZone = new mappls.Circle({
    map: leafMap,
    center: { lat: JDPC.lat, lng: JDPC.lng },
    radius: ZONE_OUTER * 1000,
    strokeColor: '#f59e0b', strokeWeight: 1.5, strokeOpacity: 0.3,
    fillColor: '#f59e0b', fillOpacity: 0.03
  });

  // ‚úÖ City zone ‚Äî Blue (8km)
  const cityZone = new mappls.Circle({
    map: leafMap,
    center: { lat: JDPC.lat, lng: JDPC.lng },
    radius: ZONE_CITY * 1000,
    strokeColor: '#3b82f6', strokeWeight: 2, strokeOpacity: 0.5,
    fillColor: '#3b82f6', fillOpacity: 0.04
  });

  // ‚úÖ City core ‚Äî Green (3km)
  const coreZone = new mappls.Circle({
    map: leafMap,
    center: { lat: JDPC.lat, lng: JDPC.lng },
    radius: ZONE_CORE * 1000,
    strokeColor: '#10b981', strokeWeight: 2, strokeOpacity: 0.65,
    fillColor: '#10b981', fillOpacity: 0.06
  });

  // ‚úÖ Center dot ‚Äî Jagdalpur hub marker
  const centerMark = new mappls.Marker({
    map: leafMap,
    position: { lat: JDPC.lat, lng: JDPC.lng },
    html: `<div style="background:rgba(245,158,11,.85);border:2.5px solid white;
      width:12px;height:12px;border-radius:50%;
      box-shadow:0 0 18px rgba(245,158,11,1);
      transform:translate(-6px,-6px)"></div>`,
    popupHtml: '<b>üìç Jagdalpur City Center</b><br><small>JDP Cabs Service Hub</small>'
  });

  zoneCircles = [outerZone, cityZone, coreZone, centerMark];

  document.getElementById('zoneLegend').style.display = 'block';
  document.getElementById('zoneLegend').style.bottom = '360px';
}

function clearZones() {
  zoneCircles.forEach(c => {
    try {
      if (c && typeof c.setMap === 'function') c.setMap(null);
      else if (c && typeof c.remove === 'function') c.remove();
    } catch(e){}
  });
  zoneCircles = [];
}

let zonesVisible = true;
function toggleZone() {
  zonesVisible = !zonesVisible;
  if (zonesVisible) {
    drawCityZones();
    document.getElementById('zoneLegend').style.display = 'block';
    const btn = document.getElementById('zoneBtnR');
    if(btn) btn.style.color = 'var(--green)';
    toast('üì° Jagdalpur city zones shown');
  } else {
    clearZones();
    document.getElementById('zoneLegend').style.display = 'none';
    const btn = document.getElementById('zoneBtnR');
    if(btn) btn.style.color = '';
    toast('üì° Zones hidden');
  }
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// ‚úÖ LANDMARK MARKERS ‚Äî Jagdalpur famous places
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function addLandmarkMarkers() {
  JAGDALPUR_LANDMARKS.forEach(place => {
    const mk = new mappls.Marker({
      map: landmarksVisible ? leafMap : null,
      position: { lat: place.lat, lng: place.lng },
      html: `<div style="background:rgba(10,14,22,.9);border:1.5px solid rgba(255,255,255,.15);border-radius:8px;padding:3px 5px;font-size:13px;transform:translate(-14px,-14px);white-space:nowrap;box-shadow:0 3px 10px rgba(0,0,0,.5)">${place.icon}</div>`,
      popupHtml: ('<b>'+place.icon+' '+place.name+'</b><br><small style="color:#aaa">'+place.info+'</small><br><button onclick="setDropFromMap('+place.lat+','+place.lng+',\''+place.name.replace(/'/g,'').replace(/"/g,'')+'\');" style="background:#f59e0b;border:none;color:#000;padding:4px 10px;border-radius:6px;font-size:.72rem;font-weight:800;margin-top:6px;cursor:pointer;width:100%">üöó Set as Drop Point</button>')
    });
    landmarkMarkers.push(mk);
  });
}

function toggleLandmarks() {
  landmarksVisible = !landmarksVisible;
  landmarkMarkers.forEach(mk => {
    try {
      if (typeof mk.setMap === 'function') mk.setMap(landmarksVisible ? leafMap : null);
    } catch(e){}
  });
  toast(landmarksVisible ? 'üìç Jagdalpur landmarks shown' : 'üìç Landmarks hidden');
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// ‚úÖ LIVE DRIVER DOTS ON MAP ‚Äî All online drivers visible
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function startLiveDriverWatch() {
  if (!window.FB_READY) return;
  if (liveDriversListener) { liveDriversListener(); }

  const q = window.FB.query(
    window.FB.collection(window.FB.db, 'users'),
    window.FB.where('role','==','driver'),
    window.FB.where('isOnline','==',true)
  );

  liveDriversListener = window.FB.onSnapshot(q, { includeMetadataChanges: false }, (snap) => {
    const onlineIds = new Set();
    let totalDrivers = 0;
    let in3km = 0, in8km = 0, in15km = 0;

    snap.forEach(docSnap => {
      const d = docSnap.data();
      const id = docSnap.id;
      if (!d.lat || !d.lng) return;
      if (CU && id === CU.uid) return; // Don't show own marker

      onlineIds.add(id);
      totalDrivers++;

      const dist = distKmCalc(JDPC.lat, JDPC.lng, d.lat, d.lng);
      if (myLat) {
        const dFromMe = distKmCalc(myLat, myLng, d.lat, d.lng);
        if (dFromMe <= 3) in3km++;
        else if (dFromMe <= 8) in8km++;
        else if (dFromMe <= 15) in15km++;
      }

      // ‚úÖ Update or add driver marker ‚Äî Mappls native
      const carHtml = `<div class="driver-dot-wrap" style="transform:translate(-14px,-32px)">
          <div class="driver-car">${d.vehicleType==='cab'?'üöó':'üõ∫'}</div>
          <div class="driver-dot-shadow"></div>
        </div>`;
      const popupHtml = `<b>${d.vehicleType==='cab'?'üöó':'üõ∫'} ${d.name||'Driver'}</b><br><small style="color:#aaa">Online ¬∑ ${dist.toFixed(1)}km from center</small>`;

      if (liveDriverMarkers[id]) {
        try {
          if (typeof liveDriverMarkers[id].setPosition === 'function')
            liveDriverMarkers[id].setPosition({ lat: d.lat, lng: d.lng });
        } catch(e){}
      } else if (leafMap) {
        const mk = new mappls.Marker({
          map: leafMap,
          position: { lat: d.lat, lng: d.lng },
          html: carHtml,
          popupHtml: popupHtml
        });
        liveDriverMarkers[id] = mk;
      }
    });

    // ‚úÖ Remove offline drivers
    Object.keys(liveDriverMarkers).forEach(id => {
      if (!onlineIds.has(id)) {
        try {
          const mk = liveDriverMarkers[id];
          if (typeof mk.setMap === 'function') mk.setMap(null);
          else if (typeof mk.remove === 'function') mk.remove();
        } catch(e){}
        delete liveDriverMarkers[id];
      }
    });

    // Update UI
    document.getElementById('liveDriverBadge').textContent = `${totalDrivers} Driver${totalDrivers!==1?'s':''} Live`;

    // Update zone breakdown on fare screen
    document.getElementById('ndTotal').textContent = totalDrivers;
    if (myLat) {
      document.getElementById('nd0to3').textContent = in3km;
      document.getElementById('nd3to8').textContent = in8km;
      document.getElementById('nd8to15').textContent = in15km;
      animateNdBars(in3km, in8km, in15km, totalDrivers);
    }

    // Driver dashboard stats
    if (CU?.role === 'driver') {
      document.getElementById('dDriversZone').textContent = totalDrivers;
    }

    // Check surge pricing
    checkSurge(totalDrivers);

    // Show home screen badge
    if (CU?.role === 'rider') {
      const badge = document.getElementById('homeDrvBadge');
      const drvText = document.getElementById('homeDrvText');
      if (totalDrivers > 0) {
        badge.style.display = 'flex';
        if (drvText) drvText.textContent = `${totalDrivers} driver${totalDrivers!==1?'s':''} online`;
      } else {
        badge.style.display = 'flex';
        badge.style.color = 'var(--muted)';
        if (drvText) drvText.textContent = 'No drivers online';
      }
    }

    // Update my zone text
    if (myLat) updateMyZone();
  });
}

function animateNdBars(a, b, c, total) {
  const bars = document.querySelectorAll('.nd-bar');
  const max = Math.max(a+b+c, 1);
  const heights = [
    Math.max(15, (a/max)*100),
    Math.max(15, ((a+b)/max)*100 * 0.8),
    Math.max(15, (b/max)*100),
    Math.max(15, ((b+c)/max)*100 * 0.7),
    Math.max(15, (c/max)*100 * 0.6)
  ];
  bars.forEach((bar, i) => {
    bar.style.height = heights[i] + '%';
    bar.classList.toggle('active', total > 0 && i <= 2);
  });
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// ‚úÖ SURGE PRICING ‚Äî Based on demand vs supply
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function checkSurge(driverCount) {
  // Surge if very few drivers online
  const newSurge = (driverCount < 2);
  if (newSurge !== surgeActive) {
    surgeActive = newSurge;
    document.getElementById('surgeBanner').style.display = surgeActive ? 'block' : 'none';
    document.getElementById('surgeChip').style.display = surgeActive ? 'flex' : 'none';
    document.getElementById('autoSurge').style.display = surgeActive ? 'inline' : 'none';
    document.getElementById('miniSurge').style.display = surgeActive ? 'inline' : 'none';
    if (surgeActive) { playSurge(); toast('‚ö° Surge pricing active!'); }
  }
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// ‚úÖ ZONE DETECTION for current user
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function updateMyZone() {
  if (!myLat) return;
  const dist = distKmCalc(myLat, myLng, JDPC.lat, JDPC.lng);
  let zoneName, zoneColor, dotColor;
  if (dist <= ZONE_CORE) {
    zoneName = 'City Core (0-3km)'; zoneColor = 'var(--green)'; dotColor = '#10b981';
  } else if (dist <= ZONE_CITY) {
    zoneName = 'City Zone (3-8km)'; zoneColor = 'var(--blue)'; dotColor = '#3b82f6';
  } else if (dist <= ZONE_OUTER) {
    zoneName = 'Outer Area (8-15km)'; zoneColor = 'var(--yellow)'; dotColor = '#f59e0b';
  } else {
    zoneName = 'Outside Zone'; zoneColor = 'var(--red)'; dotColor = '#ef4444';
  }

  document.getElementById('myZoneText').textContent = zoneName;
  document.getElementById('zoneDot').style.background = dotColor;

  if (CU?.role === 'driver') {
    document.getElementById('dsZone').textContent = dist <= ZONE_CORE ? 'Core' : dist <= ZONE_CITY ? 'City' : 'Outer';
    document.getElementById('dZoneText').textContent = `${zoneName} ¬∑ ${dist.toFixed(1)}km from center`;
  }
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// ‚úÖ NEARBY RIDERS COUNT for driver dashboard
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
async function updateNearbyRidersCount() {
  if (!window.FB_READY || !myLat) return;
  try {
    // Count "finding" rides within 8km
    const snap = await window.FB.getDocs(
      window.FB.query(window.FB.collection(window.FB.db,'rides'), window.FB.where('status','==','finding'))
    );
    let count = 0;
    snap.forEach(d => {
      const data = d.data();
      if (data.pickupLat && data.pickupLng) {
        const dist = distKmCalc(myLat, myLng, data.pickupLat, data.pickupLng);
        if (dist <= ZONE_CITY) count++;
      }
    });
    document.getElementById('dRidersNearby').textContent = count;
  } catch(e) {}
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// ‚úÖ REVERSE GEOCODE ‚Äî Mappls API (India's best local data)
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
async function revGeo(lat, lng) {
  // 1. Check our local landmark database first (250m radius)
  const nearLM = JAGDALPUR_LANDMARKS.reduce((best, lm) => {
    const d = distKmCalc(lat, lng, lm.lat, lm.lng);
    return (!best || d < best.d) ? { lm, d } : best;
  }, null);
  if (nearLM && nearLM.d < 0.25) {
    return `Near ${nearLM.lm.name}, Jagdalpur`;
  }

  // 2. Try Mappls Reverse Geocoding API ‚Äî accurate India street data
  try {
    const r = await fetch(
      `https://apis.mappls.com/advancedmaps/v1/${window.MAPPLS_KEY}/rev_geocode?lat=${lat}&lng=${lng}&region=IND`,
      { headers: { 'Accept': 'application/json' } }
    );
    if (r.ok) {
      const d = await r.json();
      const res = d?.results?.[0];
      if (res) {
        // Build address from Mappls response fields
        const parts = [];
        if (res.houseNumber) parts.push(res.houseNumber);
        if (res.houseName)   parts.push(res.houseName);
        if (res.street)      parts.push(res.street);
        if (res.subLocality) parts.push(res.subLocality);
        if (res.locality)    parts.push(res.locality);
        if (res.city && !parts.some(p=>p.includes(res.city))) parts.push(res.city);
        if (parts.length) return parts.slice(0, 3).join(', ');
        // Fallback to formatted address
        if (res.formattedAddress) return res.formattedAddress.split(',').slice(0,3).join(',').trim();
      }
    }
  } catch(e) {}

  // 3. Fallback: nearest landmark in database (within 1km)
  if (nearLM && nearLM.d < 1.0) {
    const dist = nearLM.d < 0.1 ? '' : ` (~${(nearLM.d * 1000).toFixed(0)}m from ${nearLM.lm.name})`;
    return `${nearLM.lm.name}${dist}, Jagdalpur`;
  }

  // 4. Last resort: coordinates
  return `Jagdalpur (${lat.toFixed(4)}, ${lng.toFixed(4)})`;
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// ‚úÖ FORWARD GEOCODE ‚Äî Mappls Geocode API
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
async function geocodeAddress(address) {
  // 1. Local database check ‚Äî exact/partial match
  const lc = address.toLowerCase().trim();
  const lm = JAGDALPUR_LANDMARKS.find(p =>
    lc.includes(p.name.toLowerCase().split(',')[0].toLowerCase()) ||
    p.name.toLowerCase().includes(lc.split(',')[0].toLowerCase())
  );
  if (lm) return { lat: lm.lat, lng: lm.lng, name: lm.name };

  // 2. Mappls Geocode API ‚Äî best for India addresses
  try {
    const q = encodeURIComponent(address + ' Jagdalpur Chhattisgarh');
    const r = await fetch(
      `https://apis.mappls.com/advancedmaps/v1/${window.MAPPLS_KEY}/geo_code?addr=${q}&region=IND`
    );
    if (r.ok) {
      const d = await r.json();
      const res = d?.copResults;
      if (res?.latitude && res?.longitude) {
        return { lat: parseFloat(res.latitude), lng: parseFloat(res.longitude), name: res.formattedAddress || address };
      }
    }
  } catch(e) {}

  // 3. Mappls Atlas Search fallback
  try {
    const q = encodeURIComponent(address + ' Jagdalpur');
    const r = await fetch(
      `https://apis.mappls.com/advancedmaps/v1/${window.MAPPLS_KEY}/textsearch?query=${q}&region=IND`
    );
    if (r.ok) {
      const d = await r.json();
      const res = d?.suggestedLocations?.[0];
      if (res?.latitude && res?.longitude) {
        return { lat: parseFloat(res.latitude), lng: parseFloat(res.longitude), name: res.placeName || address };
      }
    }
  } catch(e) {}

  return null;
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// ‚úÖ MAPPLS PLACE AUTOCOMPLETE ‚Äî Real-time search
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let suggestTimer = null;
let lastSuggestQuery = '';

function onDropInput(val) {
  filterPlaces(val);
  clearTimeout(suggestTimer);
  if (val.length < 2) { hideSuggest(); return; }
  suggestTimer = setTimeout(() => showSuggest(val), 350); // 350ms debounce
}

async function showSuggest(query) {
  if (query === lastSuggestQuery) return;
  lastSuggestQuery = query;
  const box = document.getElementById('dropSuggest');
  if (!box) return;

  const lc = query.toLowerCase();

  // ‚îÄ‚îÄ A. Search local landmark database first ‚îÄ‚îÄ
  const localMatches = JAGDALPUR_LANDMARKS.filter(lm =>
    lm.name.toLowerCase().includes(lc) ||
    lm.info.toLowerCase().includes(lc) ||
    (lm.cat && lm.cat.includes(lc))
  ).slice(0, 6);

  // ‚îÄ‚îÄ B. Mappls Place Autocomplete API ‚îÄ‚îÄ
  let mapplsResults = [];
  try {
    const q = encodeURIComponent(query + ' Jagdalpur');
    const r = await fetch(
      `https://apis.mappls.com/advancedmaps/v1/${window.MAPPLS_KEY}/textsearch?query=${q}&region=IND&tokenizeAddress=true`
    );
    if (r.ok) {
      const d = await r.json();
      mapplsResults = (d?.suggestedLocations || []).slice(0, 5).map(s => ({
        name: s.placeName || s.placeAddress,
        info: s.placeAddress || s.placeDetails || 'Jagdalpur',
        lat: parseFloat(s.latitude),
        lng: parseFloat(s.longitude),
        fromMappls: true,
        dist: s.distance ? (parseFloat(s.distance)/1000).toFixed(1)+'km' : ''
      }));
    }
  } catch(e) {}

  // ‚îÄ‚îÄ Merge results ‚Äî local first, then Mappls ‚îÄ‚îÄ
  const combined = [
    ...localMatches.map(lm => ({
      name: lm.name, info: lm.info, lat: lm.lat, lng: lm.lng,
      icon: lm.icon, cat: lm.cat,
      dist: myLat ? distKmCalc(myLat, myLng, lm.lat, lm.lng).toFixed(1)+'km' : ''
    })),
    ...mapplsResults.filter(m => !localMatches.some(lm =>
      lm.name.toLowerCase() === m.name?.toLowerCase()
    ))
  ].slice(0, 8);

  if (combined.length === 0) { hideSuggest(); return; }

  // ‚îÄ‚îÄ Render suggestions ‚îÄ‚îÄ
  box.innerHTML = combined.map(function(item) {
    var safeName = (item.name || '').replace(/['"]/g, '');
    var icon = item.icon || getCatIcon(item.cat || '');
    var dist = item.dist ? '<div class="sug-dist">' + item.dist + '</div>' : '';
    var hl = highlight(item.name || '', query);
    var sub = (item.info || '').split(',').slice(0,2).join(',');
    return '<div class="sug-item" onclick="selectSuggest(' + item.lat + ',' + item.lng + ',\'' + safeName + '\')">' +
      '<div class="sug-icon">' + icon + '</div>' +
      '<div style="flex:1;min-width:0">' +
        '<div class="sug-main">' + hl + '</div>' +
        '<div class="sug-sub">' + sub + '</div>' +
      '</div>' + dist +
    '</div>';
  }).join('');

  box.style.display = 'block';
}

function highlight(text, query) {
  if (!query || !text) return text;
  const re = new RegExp(`(${query.replace(/[.*+?^${}()|[\]\\]/g,'\\$&')})`, 'gi');
  return text.replace(re, '<mark style="background:rgba(245,158,11,.3);color:inherit;border-radius:2px">$1</mark>');
}

function getCatIcon(cat) {
  const icons = { hospital:'üè•', education:'üéì', market:'üõçÔ∏è', mall:'üè¨',
    area:'üèòÔ∏è', road:'üõ£Ô∏è', govt:'üèõÔ∏è', bank:'üè¶', fuel:'‚õΩ',
    temple:'üõï', hotel:'üè®', shop:'üè™', transport:'üöå',
    sports:'‚öΩ', landmark:'üìç', tourism:'üåø' };
  return icons[cat] || 'üìç';
}


// ‚úÖ Safe drop selection from map marker popup
function setDropFromMap(lat, lng, name) {
  document.getElementById('dropIn').value = name;
  window._selectedDropLat = lat;
  window._selectedDropLng = lng;
  window._selectedDropName = name;
  window._preSelectedDrop = { lat: lat, lng: lng, name: name };
  hideSuggest();
  toast('üìç Drop: ' + name);
}

function hideSuggest() {
  const box = document.getElementById('dropSuggest');
  if (box) box.style.display = 'none';
  lastSuggestQuery = '';
}

function selectSuggest(lat, lng, name) {
  hideSuggest();
  document.getElementById('dropIn').value = name;
  // Store selected drop coords directly
  window._selectedDropLat = lat;
  window._selectedDropLng = lng;
  window._selectedDropName = name;
  toast(`üìç Drop: ${name}`);
}

async function getOSRMRoute(fLat, fLng, tLat, tLng) {
  // ‚úÖ Try Mappls Route API first ‚Äî India road network aware
  try {
    const r = await fetch(
      `https://apis.mappls.com/advancedmaps/v1/${window.MAPPLS_KEY}/route_adv/driving/${fLng},${fLat};${tLng},${tLat}?geometries=geojson&overview=full&region=IND`
    );
    if (r.ok) {
      const d = await r.json();
      if (d?.routes?.[0]) {
        const rt = d.routes[0];
        return {
          distKM: parseFloat((rt.distance/1000).toFixed(1)),
          durationMin: Math.ceil(rt.duration/60),
          geometry: rt.geometry
        };
      }
    }
  } catch(e) {}

  // ‚úÖ OSRM fallback ‚Äî if Mappls routing unavailable
  try {
    const r = await fetch(`https://router.project-osrm.org/route/v1/driving/${fLng},${fLat};${tLng},${tLat}?overview=full&geometries=geojson`);
    const d = await r.json();
    if (d?.routes?.[0]) {
      const rt = d.routes[0];
      return { distKM: parseFloat((rt.distance/1000).toFixed(1)), durationMin: Math.ceil(rt.duration/60), geometry: rt.geometry };
    }
  } catch(e) {}
  return null;
}

function drawRoute(geometry, color='#f59e0b') {
  clearRoute();
  if (!leafMap || !geometry?.coordinates) return;
  // ‚úÖ Convert GeoJSON coords to Mappls path format
  const path = geometry.coordinates.map(c => ({ lat: c[1], lng: c[0] }));

  // ‚úÖ Mappls Polyline ‚Äî smooth Uber-style route
  routePolyline = new mappls.Polyline({
    map: leafMap,
    path: path,
    strokeColor: color,
    strokeWeight: 5,
    strokeOpacity: 0.88,
    lineJoin: 'round',
    lineCap: 'round'
  });

  // ‚úÖ Fit map to show full route with padding
  if (path.length > 1) {
    const lats = path.map(p => p.lat), lngs = path.map(p => p.lng);
    const bounds = [[Math.min(...lats)-0.01, Math.min(...lngs)-0.01],
                    [Math.max(...lats)+0.01, Math.max(...lngs)+0.01]];
    try { leafMap.fitBounds(bounds, { padding: [65, 65] }); } catch(e) {}
  }
}

function clearRoute() {
  if (routePolyline) {
    try {
      if (typeof routePolyline.setMap === 'function') routePolyline.setMap(null);
      else if (typeof routePolyline.remove === 'function') routePolyline.remove();
    } catch(e){}
    routePolyline = null;
  }
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// ‚úÖ GPS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function startGPS() {
  if (!navigator.geolocation) { toast('GPS not available'); return; }
  if (watchId) navigator.geolocation.clearWatch(watchId);

  watchId = navigator.geolocation.watchPosition(async (pos) => {
    myLat = pos.coords.latitude; myLng = pos.coords.longitude;
    pickLat = myLat; pickLng = myLng;
    updateMyMarker(myLat, myLng);
    updateMyZone();

    if (CU?.role === 'driver' && isOnline && window.FB_READY) {
      // ‚úÖ PERF: Throttle Firebase location writes ‚Äî max 1 write per 4s (reduces DB load)
      if (!window._lastGPSWrite || Date.now() - window._lastGPSWrite > 4000) {
        window._lastGPSWrite = Date.now();
        try {
          await window.FB.updateDoc(window.FB.doc(window.FB.db,'users',CU.uid),
            { lat:myLat, lng:myLng, lastSeen:window.FB.serverTimestamp() });
        } catch(e) {}
      }
      // Reverse geocode with cache ‚Äî don't call API on every GPS tick
      const geoKey = Math.round(myLat*1000)/1000 + ',' + Math.round(myLng*1000)/1000;
      const cached = window.Cache.get('geo_' + geoKey);
      if (cached) {
        const el = document.getElementById('dLocText');
        if(el) el.textContent = 'üìç ' + cached;
      } else {
        revGeo(myLat, myLng).then(addr => {
          window.Cache.set('geo_' + geoKey, addr, 120000); // cache 2 min
          const el = document.getElementById('dLocText');
          if(el) el.textContent = 'üìç ' + addr;
        });
      }
      // Throttle nearby riders count
      if (!window._lastNearby || Date.now() - window._lastNearby > 15000) {
        window._lastNearby = Date.now();
        updateNearbyRidersCount();
      }
    }
  }, err => { if(err.code===1) toast('üìç Location access dene se accurate service milegi'); },
  { enableHighAccuracy:true, timeout:12000, maximumAge:2000 });

  navigator.geolocation.getCurrentPosition(async (pos) => {
    myLat = pos.coords.latitude; myLng = pos.coords.longitude;
    pickLat = myLat; pickLng = myLng;
    const pAddrEl = document.getElementById('pAddr');
    const pSubEl = document.getElementById('pSub');
    if(pAddrEl) pAddrEl.textContent = 'Getting address...';
    if(pSubEl) pSubEl.innerHTML = '<div class="lspin"></div><span>Detecting location...</span>';
    const geoKey2 = Math.round(myLat*1000)/1000+','+Math.round(myLng*1000)/1000;
    const cachedAddr = window.Cache.get('geo_'+geoKey2);
    const addr = cachedAddr || await revGeo(myLat, myLng);
    if (!cachedAddr) window.Cache.set('geo_'+geoKey2, addr, 120000);
    pickAddr = addr;
    if(pAddrEl) pAddrEl.textContent = addr;
    // Show accuracy info
    const acc = pos.coords.accuracy ? Math.round(pos.coords.accuracy) : '?';
    if(pSubEl) pSubEl.innerHTML = `<span style="color:var(--green);font-size:.66rem">üìç Accuracy: ¬±${acc}m ¬∑ GPS Live</span>`;
    if (leafMap) leafMap.flyTo([myLat, myLng], 16);
    updateMyMarker(myLat, myLng);
    updateMyZone();
    toast('üìç Location detected!');
  }, err => {
    const pAddrEl = document.getElementById('pAddr');
    const pSubEl = document.getElementById('pSub');
    if(pAddrEl) pAddrEl.textContent = 'Location unavailable ‚Äî enable GPS';
    if(pSubEl) pSubEl.innerHTML = '<span style="color:var(--red)">Tap üîÑ to retry</span>';
  }, { enableHighAccuracy:true, timeout:15000 });
}

function refreshGPS() {
  document.getElementById('pAddr').textContent = 'Refreshing...';
  document.getElementById('pSub').innerHTML = '<div class="lspin"></div><span>Getting GPS...</span>';
  startGPS();
}

function updateMyMarker(lat, lng) {
  if (!leafMap) return;
  const html = '<div class="my-loc-wrap" style="transform:translate(-12px,-12px)"><div class="my-loc-wave"></div><div class="my-loc-dot"></div></div>';
  if (!myMarker) {
    // ‚úÖ Mappls Marker for user location
    myMarker = new mappls.Marker({
      map: leafMap,
      position: { lat, lng },
      html: html,
      popupHtml: '<b>üìç Your Location</b>'
    });
  } else {
    try {
      if (typeof myMarker.setPosition === 'function')
        myMarker.setPosition({ lat, lng });
    } catch(e){}
  }
}

function locateMe() {
  if (leafMap && myLat) leafMap.flyTo([myLat, myLng], 16);
  refreshGPS();
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// ‚úÖ DRIVER TRACKING ‚Äî Assigned driver marker
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function startDriverTracking(driverId) {
  if (driverLocListener) { driverLocListener(); driverLocListener = null; }

  driverLocListener = window.FB.onSnapshot(window.FB.doc(window.FB.db,'users',driverId), snap => {
    if (!snap.exists()) return;
    const d = snap.data();
    if (!d.lat || !d.lng) return;

    moveAssignedDriverMarker(d.lat, d.lng, d.name || 'Driver', d.vehicleType);

    if (myLat) {
      const dist = distKmCalc(myLat, myLng, d.lat, d.lng);
      document.getElementById('driverTrackText').textContent =
        dist < 0.1 ? 'üöñ Driver is here!' :
        dist < 1 ? `üöñ Driver is ${(dist*1000).toFixed(0)}m away` :
        `üöñ Driver is ${dist.toFixed(1)}km away`;

      const eta = Math.ceil(dist / 0.5); // ~30km/h avg
      document.getElementById('driverDistText').textContent = `‚è±Ô∏è ETA ~${eta} min`;
    }
  });
}

function moveAssignedDriverMarker(lat, lng, name, vehType) {
  if (!leafMap) return;
  const carHtml = `<div class="assigned-car" style="transform:translate(-18px,-36px)">${vehType==='cab'?'üöó':'üõ∫'}</div>`;
  if (!driverMk) {
    // ‚úÖ Create Mappls marker for assigned driver
    driverMk = new mappls.Marker({
      map: leafMap,
      position: { lat, lng },
      html: carHtml,
      popupHtml: `<b>${vehType==='cab'?'üöó':'üõ∫'} ${name}</b><br><small style="color:#aaa">Coming to you!</small>`
    });
  } else {
    // ‚úÖ Smooth animated movement ‚Äî cubic ease-out (Uber-style)
    const fromLat = prevDriverLat || lat, fromLng = prevDriverLng || lng;
    let step = 0;
    if (driverMarkerInterval) clearInterval(driverMarkerInterval);
    driverMarkerInterval = setInterval(() => {
      step++;
      const t = 1 - Math.pow(1 - (step / 30), 3); // cubic ease-out
      const curLat = fromLat + (lat - fromLat) * t;
      const curLng = fromLng + (lng - fromLng) * t;
      try {
        if (typeof driverMk.setPosition === 'function')
          driverMk.setPosition({ lat: curLat, lng: curLng });
      } catch(e){}
      if (step >= 30) clearInterval(driverMarkerInterval);
    }, 16); // 60fps
  }
  prevDriverLat = lat; prevDriverLng = lng;
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// HELPERS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function distKmCalc(la1, ln1, la2, ln2) {
  const R=6371, dL=(la2-la1)*Math.PI/180, dN=(ln2-ln1)*Math.PI/180;
  const a=Math.sin(dL/2)**2+Math.cos(la1*Math.PI/180)*Math.cos(la2*Math.PI/180)*Math.sin(dN/2)**2;
  return R*2*Math.atan2(Math.sqrt(a),Math.sqrt(1-a));
}

function setDrop(place) {
  document.getElementById('dropIn').value = place;
  toast(`Drop set: ${place}`);
}

function filterPlaces(val) {
  // Highlight matching quick place chips
  const chips = document.querySelectorAll('.qp-chip');
  chips.forEach(c => {
    c.style.borderColor = val && c.textContent.toLowerCase().includes(val.toLowerCase())
      ? 'var(--yellow)' : '';
    c.style.background = val && c.textContent.toLowerCase().includes(val.toLowerCase())
      ? 'rgba(245,158,11,.1)' : '';
  });
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// AUTH
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function setRole(r) {
  authRole = r;
  document.getElementById('rTab').className='rtab'+(r==='rider'?' ar':'');
  document.getElementById('dTab').className='rtab'+(r==='driver'?' ad':'');
  setTab(document.getElementById('loginTab').classList.contains('on')?'login':'register');
}
function setTab(t) {
  document.getElementById('loginTab').className='atab'+(t==='login'?' on':'');
  document.getElementById('regTab').className='atab'+(t==='register'?' on':'');
  ['loginForm','rRegForm','dRegForm'].forEach(id=>document.getElementById(id).classList.remove('sh'));
  if(t==='login') document.getElementById('loginForm').classList.add('sh');
  if(t==='register'&&authRole==='rider') document.getElementById('rRegForm').classList.add('sh');
  if(t==='register'&&authRole==='driver') document.getElementById('dRegForm').classList.add('sh');
}
function selVeh(type) {
  selVehType=type;
  document.getElementById('vAuto').classList.toggle('on',type==='auto');
  document.getElementById('vCab').classList.toggle('on',type==='cab');
}
function showErr(id,msg) {
  const el=document.getElementById(id);
  el.textContent='‚ö†Ô∏è '+msg; el.style.display='block';
  setTimeout(()=>el.style.display='none',4000);
}
async function doLogin() {
  if (!window.FB_READY) return toast('Firebase not ready');
  const id=document.getElementById('lId').value.trim(), pw=document.getElementById('lPass').value;
  if (!id||!pw) return showErr('loginErr','Enter mobile and password');
  if (id.length!==10) return showErr('loginErr','Valid 10-digit mobile required');
  try {
    const c=await window.FB.signInWithEmailAndPassword(window.FB.auth,id+'@jdpcabs.in',pw);
    const s=await window.FB.getDoc(window.FB.doc(window.FB.db,'users',c.user.uid));
    if(s.exists()){CU={uid:c.user.uid,...s.data()};launch();}
    else showErr('loginErr','Account not found. Register first.');
  } catch(e){showErr('loginErr',e.code==='auth/wrong-password'?'Wrong password':e.code==='auth/user-not-found'?'Not registered':e.code==='auth/network-request-failed'?'No internet':'Login failed.');}
}
async function doRiderReg() {
  if (!window.FB_READY) return toast('Firebase not ready');
  const fn=document.getElementById('rFn').value.trim(),ph=document.getElementById('rPh').value.trim(),pw=document.getElementById('rPw').value;
  if(!fn||!ph||!pw) return showErr('rRegErr','Fill all fields');
  if(ph.length!==10) return showErr('rRegErr','Valid 10-digit mobile required');
  if(pw.length<6) return showErr('rRegErr','Password min 6 characters');
  try{
    const c=await window.FB.createUserWithEmailAndPassword(window.FB.auth,ph+'@jdpcabs.in',pw);
    const ud={name:fn,phone:ph,role:'rider',createdAt:window.FB.serverTimestamp()};
    await window.FB.setDoc(window.FB.doc(window.FB.db,'users',c.user.uid),ud);
    CU={uid:c.user.uid,...ud};launch();
  }catch(e){showErr('rRegErr',e.code==='auth/email-already-in-use'?'Mobile already registered. Login.':'Registration failed.');}
}
function fmtAadhar(el) {
  let v = el.value.replace(/\D/g,'').slice(0,12);
  el.value = v.replace(/(\d{4})(?=\d)/g,'$1 ').trim();
}

// ‚úÖ Driver photo compress + preview
let driverPhotoBase64 = '';
function handleDriverPhoto(input) {
  const file = input.files[0];
  if (!file) return;
  if (file.size > 5 * 1024 * 1024) { toast('‚ùå Photo 5MB se chhota hona chahiye'); return; }

  const reader = new FileReader();
  reader.onload = (e) => {
    const img = new Image();
    img.onload = () => {
      // Compress to 200x200 thumbnail
      const canvas = document.createElement('canvas');
      const SIZE = 200;
      let w = img.width, h = img.height;
      // Crop to square from center
      const min = Math.min(w, h);
      const sx = (w - min) / 2, sy = (h - min) / 2;
      canvas.width = SIZE; canvas.height = SIZE;
      const ctx = canvas.getContext('2d');
      // Circle clip
      ctx.beginPath();
      ctx.arc(SIZE/2, SIZE/2, SIZE/2, 0, Math.PI*2);
      ctx.clip();
      ctx.drawImage(img, sx, sy, min, min, 0, 0, SIZE, SIZE);
      driverPhotoBase64 = canvas.toDataURL('image/jpeg', 0.75);

      // Show preview
      const prevEl = document.getElementById('dPhotoPreview');
      prevEl.src = driverPhotoBase64;
      prevEl.style.display = 'block';
      document.getElementById('photoPlaceholder').style.display = 'none';
      document.getElementById('photoUploadLbl').textContent = '‚úÖ Photo selected ‚Äî tap to change';
      document.getElementById('photoUploadBox').classList.add('has-photo');
      document.getElementById('photoStatus').style.display = 'block';
    };
    img.src = e.target.result;
  };
  reader.readAsDataURL(file);
}

function showKycStep() {
  const fn=document.getElementById('dFn').value.trim(),ph=document.getElementById('dPh').value.trim();
  const veh=document.getElementById('dVeh').value.trim().toUpperCase(),pw=document.getElementById('dPw').value;
  if(!fn||!ph||!veh||!pw) return showErr('dRegErr','Fill all basic fields first');
  if(ph.length!==10) return showErr('dRegErr','Valid 10-digit mobile required');
  if(pw.length<6) return showErr('dRegErr','Password min 6 chars');
  if(veh.length<5) return showErr('dRegErr','Valid vehicle number required');
  document.getElementById('dStep1').style.display='none';
  document.getElementById('dStep2').style.display='block';
}
async function doDriverReg() {
  if (!window.FB_READY) return toast('Firebase not ready');
  const fn=document.getElementById('dFn').value.trim(),ph=document.getElementById('dPh').value.trim();
  const veh=document.getElementById('dVeh').value.trim().toUpperCase(),pw=document.getElementById('dPw').value;
  const aadhar=document.getElementById('dAadhar').value.replace(/\s/g,'');
  const pan=document.getElementById('dPan').value.trim().toUpperCase();
  const dl=document.getElementById('dDl').value.trim().toUpperCase();
  const bankName=document.getElementById('dBankName').value.trim();
  const accNo=document.getElementById('dAccNo').value.trim();
  const ifsc=document.getElementById('dIfsc').value.trim().toUpperCase();

  if(!fn||!ph||!veh||!pw) return showErr('dRegErr','Basic details missing');
  if(ph.length!==10) return showErr('dRegErr','Valid 10-digit mobile required');
  if(pw.length<6) return showErr('dRegErr','Password min 6 chars');
  if(!driverPhotoBase64) return showErr('dRegErr','üì∏ Profile photo zaroori hai ‚Äî please upload karo');
  if(aadhar.length!==12) return showErr('dRegErr','Aadhaar 12 digits required');
  if(pan.length!==10) return showErr('dRegErr','PAN card 10 characters required');
  if(!dl) return showErr('dRegErr','Driving Licence number required');
  if(!bankName||!accNo||!ifsc) return showErr('dRegErr','Bank details required');
  if(ifsc.length!==11) return showErr('dRegErr','IFSC code 11 characters hona chahiye');

  try{
    const c=await window.FB.createUserWithEmailAndPassword(window.FB.auth,ph+'@jdpcabs.in',pw);
    const ud={
      name:fn, phone:ph, role:'driver', vehicleNo:veh, vehicleType:selVehType,
      rating:5.0, isOnline:false, earnings:0, ridesCompleted:0,
      photoBase64: driverPhotoBase64,
      kycStatus:'pending',
      kyc:{ aadhaar:aadhar, pan:pan, drivingLicence:dl },
      bank:{ accountHolderName:bankName, accountNumber:accNo, ifsc:ifsc },
      createdAt:window.FB.serverTimestamp()
    };
    await window.FB.setDoc(window.FB.doc(window.FB.db,'users',c.user.uid),ud);
    CU={uid:c.user.uid,...ud};
    toast('‚úÖ Registration submitted! Admin verification pending.');
    launch();
  }catch(e){showErr('dRegErr',e.code==='auth/email-already-in-use'?'Mobile already registered. Login.':'Registration failed: '+e.message);}
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// LAUNCH
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function launch() {
  document.getElementById('auth').style.display='none';
  setTimeout(()=>{ if(leafMap) leafMap.invalidateSize(); },300);
  if(CU?.role==='driver') launchDriver();
  else launchRider();
  startGPS();
  startLiveDriverWatch();  // ‚úÖ Watch all live drivers on map
}
function launchRider() {
  document.getElementById('rTop').style.display='flex';
  document.getElementById('rSheet').style.display='block';document.getElementById('mapFade').style.display='block';
  document.getElementById('locBtn').style.display='flex';
  document.getElementById('mapStats').style.display='block';
  document.getElementById('zoneLegend').style.bottom='380px';
  if(CU) document.getElementById('riderName').textContent=CU.name?.toUpperCase()||'RIDER';
  loadFavChips();
}
function launchDriver() {
  document.getElementById('dTopBar').style.display='block';
  document.getElementById('dStats').style.display='block';
  document.getElementById('dPanel').style.display='block';
  document.getElementById('locBtn').style.display='flex';
  document.getElementById('locBtn').style.bottom='250px';
  document.getElementById('mapStats').style.display='block';
  document.getElementById('zoneLegend').style.bottom='250px';
  if(CU) document.getElementById('dName').textContent=CU.name;
  dEarnings=CU.earnings||0; dRides=CU.ridesCompleted||0;
  updateDStats(); showDCard('off');
  // Show KYC pending warning
  if(CU.kycStatus==='pending'){
    const w=document.getElementById('kycPendingWarn');
    if(w) w.style.display='block';
  }
  // Auto show landmarks for driver
  landmarksVisible = true;
  landmarkMarkers.forEach(mk => { try { mk.addTo(leafMap); } catch(e){} });
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// DRIVER ONLINE/OFFLINE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
async function toggleOnline() {
  isOnline=document.getElementById('onTog').checked;

  // ‚úÖ FIX 5: Block KYC pending drivers from going online
  if(isOnline && CU?.kycStatus==='pending'){
    document.getElementById('onTog').checked=false;
    isOnline=false;
    document.getElementById('onlineLbl').textContent='OFFLINE';
    document.getElementById('onlineLbl').style.color='rgba(255,255,255,.55)';
    toast('‚ö†Ô∏è KYC pending hai ‚Äî admin approval ke baad online ho sakte hain');
    return;
  }

  document.getElementById('onlineLbl').textContent=isOnline?'ONLINE':'OFFLINE';
  document.getElementById('onlineLbl').style.color=isOnline?'#10b981':'rgba(255,255,255,.55)';
  if(isOnline){
    onlineStart=Date.now();
    showDCard('on');
    toast('üü¢ Online! Listening for rides within 8km...');
    if(onlineTimeInterval) clearInterval(onlineTimeInterval);
    onlineTimeInterval=setInterval(()=>{
      if(onlineStart) document.getElementById('dsTime').textContent=((Date.now()-onlineStart)/3600000).toFixed(1)+'h';
      updateNearbyRidersCount();
    }, 30000);
    if(window.FB_READY&&CU){
      try{await window.FB.updateDoc(window.FB.doc(window.FB.db,'users',CU.uid),{isOnline:true,lat:myLat||JDPC.lat,lng:myLng||JDPC.lng});}catch(e){}
    }
    startListeningForRides();
    updateNearbyRidersCount();
  } else {
    stopListeningForRides();
    showDCard('off');
    if(onlineTimeInterval){clearInterval(onlineTimeInterval);onlineTimeInterval=null;}
    toast('üî¥ You are offline');
    if(window.FB_READY&&CU){
      try{await window.FB.updateDoc(window.FB.doc(window.FB.db,'users',CU.uid),{isOnline:false});}catch(e){}
    }
  }
}

// ‚úÖ SMART MATCHING ‚Äî First try 5km, then expand to 8km
function startListeningForRides() {
  if(!window.FB_READY) return;
  stopListeningForRides();
  const q=window.FB.query(window.FB.collection(window.FB.db,'rides'),window.FB.where('status','==','finding'));
  newRideListener=window.FB.onSnapshot(q, snap => {
    snap.docChanges().forEach(change => {
      if(change.type==='added'&&isOnline&&!curReqId){
        const data=change.doc.data();
        // ‚úÖ Distance-based matching ‚Äî only accept rides within zone
        if(myLat&&data.pickupLat){
          const dist=distKmCalc(myLat,myLng,data.pickupLat,data.pickupLng);
          if(dist>ZONE_CITY) return; // Beyond 8km ‚Äî skip
        }
        curReqId=change.doc.id;
        curReqData={id:curReqId,...data};
        showReqPopup(curReqData);
        playNewRide();
      }
    });
  });
}
function stopListeningForRides() {
  if(newRideListener){newRideListener();newRideListener=null;}
}
function showDCard(type) {
  document.getElementById('dOff').style.display=type==='off'?'block':'none';
  document.getElementById('dOn').style.display=type==='on'?'block':'none';
  document.getElementById('dNav').style.display=type==='nav'?'block':'none';
}
function updateDStats() {
  document.getElementById('dsEarn').textContent='‚Çπ'+dEarnings;
  document.getElementById('dsRides').textContent=dRides;
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// REQUEST POPUP
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function showReqPopup(data) {
  document.getElementById('reqFare').textContent='‚Çπ'+(data.fare||'--');
  document.getElementById('reqDist').textContent=(data.distanceKM||'--')+'km';
  document.getElementById('reqPick').textContent=data.pickup||'--';
  document.getElementById('reqDrop').textContent=data.drop||'--';

  // ‚úÖ Show how far the rider is from driver
  let pickupDist = '--';
  if(myLat&&data.pickupLat){
    const d=distKmCalc(myLat,myLng,data.pickupLat,data.pickupLng);
    pickupDist=d<1?(d*1000).toFixed(0)+'m':d.toFixed(1)+'km';
    document.getElementById('reqDistBadge').innerHTML=`<span class="dist-badge">üìç Rider is ${pickupDist} from you</span>`;
  }
  document.getElementById('reqPickupDist').textContent=pickupDist;
  const reqETAEl = document.getElementById('reqETA');
  if(reqETAEl) reqETAEl.textContent = (data.etaMin||'--')+'m';
  document.getElementById('reqPopup').classList.add('sh');

  reqTimer=60;
  document.getElementById('tNum').textContent=reqTimer;
  const circ=document.getElementById('tCircle');
  circ.style.stroke='var(--yellow)';
  document.getElementById('tNum').style.color='var(--yellow)';
  circ.style.strokeDashoffset='0';

  if(reqInterval) clearInterval(reqInterval);
  reqInterval=setInterval(()=>{
    reqTimer--;
    document.getElementById('tNum').textContent=reqTimer;
    circ.style.strokeDashoffset=163*(1-reqTimer/60);
    if(reqTimer<=10){circ.style.stroke='var(--red)';document.getElementById('tNum').style.color='var(--red)';}
    if(reqTimer<=0){clearInterval(reqInterval);hideReqPopup();curReqId=null;curReqData=null;toast('‚è∞ Request expired');}
  },1000);
}
function hideReqPopup() {
  document.getElementById('reqPopup').classList.remove('sh');
  if(reqInterval) clearInterval(reqInterval);
}

async function acceptReq() {
  if(!curReqData) return;
  clearInterval(reqInterval);
  hideReqPopup();
  stopListeningForRides();
  const data=curReqData;
  navPhase='pickup';

  if(window.FB_READY){
    try{
      const otp=Math.floor(1000+Math.random()*9000);
      await window.FB.updateDoc(window.FB.doc(window.FB.db,'rides',data.id),{
        status:'assigned',driverId:CU.uid,driverName:CU.name,driverPhone:CU.phone,
        driverVehicle:CU.vehicleNo,driverVehicleType:CU.vehicleType,otp,
        acceptedAt:window.FB.serverTimestamp()
      });
    }catch(e){toast('‚ùå Accept failed');return;}
  }

  document.getElementById('navLabel').textContent='üîµ Going to Pickup';
  document.getElementById('navPA').textContent=data.pickup||'--';
  document.getElementById('navDA').textContent=data.drop||'--';
  document.getElementById('navFare').textContent='‚Çπ'+(data.fare||'--');
  document.getElementById('navActBtn').textContent='‚úÖ Rider Picked Up';
  document.getElementById('navPickup').style.opacity='1';

  // ‚úÖ Show rider contact info for driver to call
  const riderNameEl = document.getElementById('navRiderName');
  const riderPhoneEl = document.getElementById('navRiderPhone');
  const callBtn = document.getElementById('callRiderBtn');

  if(riderNameEl) riderNameEl.textContent = data.riderName || 'Rider';

  // riderPhone ‚Äî try multiple fields
  const rPhone = data.riderPhone || data.rPhone || data.phone || '';

  if(rPhone && rPhone.length >= 10){
    if(riderPhoneEl) riderPhoneEl.textContent = 'üìû ' + rPhone;
    if(callBtn){
      callBtn.href = 'tel:' + rPhone;
      callBtn.style.opacity = '1';
      callBtn.style.pointerEvents = 'auto';
    }
    toast('üöó Ride accepted! Rider: ' + (data.riderName||'') + ' ¬∑ üìû ' + rPhone);
  } else {
    if(riderPhoneEl) riderPhoneEl.textContent = 'Phone number nahi mila';
    if(callBtn){
      callBtn.style.opacity = '0.5';
      callBtn.href = '#';
    }
    toast('üöó Ride accepted! (Rider phone unavailable)');
  }

  showDCard('nav');

  if(leafMap&&myLat&&data.pickupLat){
    const route=await getOSRMRoute(myLat,myLng,data.pickupLat,data.pickupLng);
    if(route){
      drawRoute(route.geometry,'#3b82f6');
      document.getElementById('navPDist').textContent=route.distKM+'km';
      document.getElementById('navPETA').textContent=route.durationMin+' min';
    }
    if(pickupMk){ try{if(typeof pickupMk.setMap==='function')pickupMk.setMap(null);}catch(e){} pickupMk=null; }
    pickupMk = new mappls.Marker({ map:leafMap, position:{lat:data.pickupLat,lng:data.pickupLng},
      html:'<div class="pickup-wrap" style="transform:translate(-16px,-36px)"><div class="pickup-icon">üìç</div></div>',
      popupHtml:`<b style="color:#10b981">üìç ${data.pickup}</b>` });
  }
  toast('‚úÖ Ride accepted! Going to pickup');
}

function declineReq() {
  clearInterval(reqInterval);
  hideReqPopup();
  curReqId=null;curReqData=null;
  toast('Declined');
}

async function driverNext() {
  if(!curReqData) return;
  if(navPhase==='pickup'){
    navPhase='drop';
    document.getElementById('navLabel').textContent='üü¢ Going to Drop';
    document.getElementById('navPickup').style.opacity='.45';
    document.getElementById('navActBtn').textContent='üèÅ Complete Trip';
    if(window.FB_READY&&curReqData.id){
      try{await window.FB.updateDoc(window.FB.doc(window.FB.db,'rides',curReqData.id),{status:'ongoing',pickedAt:window.FB.serverTimestamp()});}catch(e){}
    }
    toast('Heading to drop! üöó');
    if(leafMap&&myLat&&curReqData.drop){
      const dc=await geocodeAddress(curReqData.drop);
      if(dc){
        const route=await getOSRMRoute(myLat,myLng,dc.lat,dc.lng);
        if(route) drawRoute(route.geometry,'#10b981');
        if(dropMk){ try{if(typeof dropMk.setMap==='function')dropMk.setMap(null);}catch(e){} dropMk=null; }
        dropMk = new mappls.Marker({ map:leafMap, position:{lat:dc.lat,lng:dc.lng},
          html:'<div class="drop-icon" style="transform:translate(-15px,-30px)">üèÅ</div>',
          popupHtml:`<b style="color:#ef4444">üèÅ ${curReqData.drop}</b>` });
      }
    }
  } else { await completeTrip(); }
}

async function completeTrip() {
  const data=curReqData;
  dEarnings+=(data.fare||0); dRides+=1; updateDStats();
  if(window.FB_READY){
    try{
      await window.FB.updateDoc(window.FB.doc(window.FB.db,'rides',data.id),{status:'completed',completedAt:window.FB.serverTimestamp()});
      await window.FB.updateDoc(window.FB.doc(window.FB.db,'users',CU.uid),{earnings:dEarnings,ridesCompleted:dRides});
    }catch(e){}
  }
  clearRoute();
  if(pickupMk){ try{if(typeof pickupMk.setMap==='function')pickupMk.setMap(null);}catch(e){} pickupMk=null; }
  if(dropMk){ try{if(typeof dropMk.setMap==='function')dropMk.setMap(null);}catch(e){} dropMk=null; }
  curReqId=null;curReqData=null;navPhase='pickup';
  showDCard('on');
  toast(`üéâ Trip done! ‚Çπ${data.fare} earned!`);
  if(isOnline) startListeningForRides();
}

async function driverCancel() {
  if(window.FB_READY&&curReqData?.id){
    try{await window.FB.updateDoc(window.FB.doc(window.FB.db,'rides',curReqData.id),{status:'cancelled_driver',cancelledAt:window.FB.serverTimestamp()});}catch(e){}
  }
  clearRoute();
  curReqId=null;curReqData=null;navPhase='pickup';
  if(pickupMk){ try{if(typeof pickupMk.setMap==='function')pickupMk.setMap(null);}catch(e){} pickupMk=null; }
  showDCard('on');
  toast('Ride cancelled');
  if(isOnline) startListeningForRides();
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// RIDER BOOKING
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function goScr(id) {
  // ‚úÖ Uber: Resize map after sheet transition
  setTimeout(() => { try { leafMap && leafMap.invalidateSize && leafMap.invalidateSize(); } catch(e){} }, 320);
  document.querySelectorAll('.scr').forEach(e=>e.classList.remove('on'));
  document.getElementById(id).classList.add('on');
}

async function calcFare() {
  // ‚úÖ Use pre-selected drop coords from autocomplete if available
  if (window._selectedDropLat && window._selectedDropLng && window._selectedDropName) {
    const dropIn = document.getElementById('dropIn');
    if (dropIn && dropIn.value === window._selectedDropName) {
      // Use the exact coords from autocomplete selection
      const result = {
        lat: window._selectedDropLat,
        lng: window._selectedDropLng,
        name: window._selectedDropName
      };
      window._preSelectedDrop = result;
    }
  }
  const drop=document.getElementById('dropIn').value.trim();
  if(!drop){
    const e=document.getElementById('homeErr');
    e.textContent='‚ö†Ô∏è Enter drop location ya popular place select karo';
    e.style.display='block';
    setTimeout(()=>e.style.display='none',3000);
    return;
  }

  toast('üó∫Ô∏è Calculating real road distance...');
  const cKey=`${pickLat||JDPC.lat}_${drop}`;
  if(routeCache[cKey]){applyRoute(routeCache[cKey],drop);return;}

  const dropCoords=await geocodeAddress(drop);
  if(dropCoords){
    const fLat=pickLat||JDPC.lat, fLng=pickLng||JDPC.lng;
    const route=await getOSRMRoute(fLat,fLng,dropCoords.lat,dropCoords.lng);
    if(route){
      routeCache[cKey]={route,dropCoords};
      applyRoute({route,dropCoords},drop);
      return;
    }
  }
  useFallback(drop);
}

function applyRoute({route,dropCoords},drop) {
  distKM=route.distKM;
  const eta=route.durationMin;
  const surge=surgeActive?1.5:1;
  fareA=Math.round(Math.max(25,20+distKM*12)*surge);
  fareM=Math.round(Math.max(50,40+distKM*16)*surge);

  document.getElementById('cDist').textContent=distKM;
  document.getElementById('cETA').textContent=eta;
  document.getElementById('cZone').textContent=distKM<=3?'Core':distKM<=8?'City':'Outer';
  document.getElementById('fAuto').textContent=fareA;
  document.getElementById('fMini').textContent=fareM;
  cabType='JDP Auto';cabFare=fareA;
  document.getElementById('bookBtnType').textContent='JDP Auto';
  document.getElementById('optAuto').classList.add('sel');
  document.getElementById('optMini').classList.remove('sel');

  if(route.geometry) drawRoute(route.geometry,'#f59e0b');

  if(leafMap){
    if(pickLat){
      if(pickupMk){ try{if(typeof pickupMk.setMap==='function')pickupMk.setMap(null);}catch(e){} pickupMk=null; }
      pickupMk = new mappls.Marker({ map:leafMap, position:{lat:pickLat,lng:pickLng},
        html:'<div class="pickup-wrap" style="transform:translate(-16px,-36px)"><div class="pickup-icon">üìç</div></div>',
        popupHtml:`<b style="color:#10b981">üìç ${pickAddr || 'Your Pickup'}</b>` });
    }
    if(dropCoords){
      if(dropMk){ try{if(typeof dropMk.setMap==='function')dropMk.setMap(null);}catch(e){} dropMk=null; }
      dropMk = new mappls.Marker({ map:leafMap, position:{lat:dropCoords.lat,lng:dropCoords.lng},
        html:'<div class="drop-icon" style="transform:translate(-15px,-30px)">üèÅ</div>',
        popupHtml:`<b style="color:#ef4444">üèÅ ${drop}</b>` });
    }
  }
  goScr('sFare');
}

function useFallback(drop) {
  let d=3;
  if(pickLat){d=distKmCalc(pickLat,pickLng,JDPC.lat,JDPC.lng)*1.3;if(d<1)d=2+Math.random()*3;}
  else d=2+Math.random()*4;
  d=parseFloat(d.toFixed(1));distKM=d;
  const surge=surgeActive?1.5:1;
  fareA=Math.round(Math.max(25,20+d*12)*surge);
  fareM=Math.round(Math.max(50,40+d*16)*surge);
  document.getElementById('cDist').textContent=d+'*';
  document.getElementById('cETA').textContent=Math.ceil(d*3)+'*';
  document.getElementById('cZone').textContent='Jagdalpur';
  document.getElementById('fAuto').textContent=fareA;
  document.getElementById('fMini').textContent=fareM;
  cabType='JDP Auto';cabFare=fareA;
  document.getElementById('bookBtnType').textContent='JDP Auto';
  document.getElementById('optAuto').classList.add('sel');
  document.getElementById('optMini').classList.remove('sel');
  toast('‚ö†Ô∏è * = Estimated distance');
  goScr('sFare');
}

function selRide(el,type,vk) {
  document.querySelectorAll('.ro-card').forEach(e=>e.classList.remove('sel'));
  el.classList.add('sel');
  cabType=type;cabFare=vk==='auto'?fareA:fareM;
  document.getElementById('bookBtnType').textContent=type;
}

// ‚úÖ SMART BOOKING with zone matching info
async function confirmBook() {
  goScr('sFind');

  let nearbyCount=0,in5km=0,in8km=0;
  if(window.FB_READY){
    try{
      const snap=await window.FB.getDocs(
        window.FB.query(window.FB.collection(window.FB.db,'users'),window.FB.where('role','==','driver'),window.FB.where('isOnline','==',true))
      );
      nearbyCount=snap.size;
      snap.forEach(d=>{
        const data=d.data();
        if(data.lat&&myLat){
          const dist=distKmCalc(myLat,myLng,data.lat,data.lng);
          if(dist<=MATCH_RADIUS_1) in5km++;
          else if(dist<=MATCH_RADIUS_2) in8km++;
        }
      });
    }catch(e){}
  }

  document.getElementById('nearbyCount').textContent=nearbyCount>0?`${nearbyCount} driver${nearbyCount>1?'s':''} online`:'Searching...';
  document.getElementById('matchZoneText').textContent=
    in5km>0?`‚úÖ ${in5km} driver${in5km>1?'s':''} within 5km ‚Äî fast match!`:
    in8km>0?`üîµ ${in8km} driver${in8km>1?'s':''} within 8km ‚Äî matching...`:
    nearbyCount>0?'üü° Drivers in outer zone ‚Äî matching...':
    '‚è≥ No drivers nearby ‚Äî please wait...';

  if(nearbyCount===0){
    setTimeout(()=>{toast('‚ö†Ô∏è No drivers online. Try again soon.');goScr('sHome');},4500);
    return;
  }

  // Get rider phone ‚Äî try all possible fields
  const riderPhoneVal = CU?.phone || CU?.mobile || CU?.phoneNumber || '';

  // ‚úÖ FIX 3: Apply promo discount to actual fare
  const promoDiscount = appliedPromo ? Math.min(appliedPromo.discount, cabFare) : 0;
  const effectiveFare = Math.max(1, cabFare - promoDiscount);

  const rideData={
    riderId:CU?.uid||'guest',
    riderName:CU?.name||'Rider',
    riderPhone: riderPhoneVal,
    phone: riderPhoneVal,   // extra field as backup
    pickup:pickAddr||'GPS Location',pickupLat:pickLat||JDPC.lat,pickupLng:pickLng||JDPC.lng,
    drop:document.getElementById('dropIn').value.trim(),
    cabType,
    fare: effectiveFare,              // ‚úÖ FIX 3: discounted fare
    originalFare: cabFare,             // ‚úÖ save original
    promoCode: appliedPromo?.code || null,  // ‚úÖ FIX 7: save promo info
    promoDiscount: promoDiscount,      // ‚úÖ FIX 7: receipt will show correctly
    distanceKM:distKM,
    etaMin:parseInt(document.getElementById('cETA').textContent)||10,
    status:'finding',
    createdAt:window.FB_READY?window.FB.serverTimestamp():new Date().toISOString()
  };

  try{
    if(window.FB_READY){
      const ref=await window.FB.addDoc(window.FB.collection(window.FB.db,'rides'),rideData);
      rideDocId=ref.id;
      listenToRide(rideDocId);
      appliedPromo = null; // ‚úÖ FIX 3: Reset promo after booking
      document.getElementById('promoStrip').style.display = 'none';
    }else{
      setTimeout(()=>{toast('‚ùå Firebase required');goScr('sHome');},3000);
    }
  }catch(e){toast('‚ùå Booking failed. Check internet.');goScr('sHome');}
}

// ‚úÖ Separate async function to fetch and show driver photo safely
async function fetchAndShowDriverPhoto(driverId) {
  if(!driverId || !window.FB_READY) return;
  try {
    const dSnap = await window.FB.getDoc(window.FB.doc(window.FB.db,'users',driverId));
    if(dSnap.exists()){
      const dData = dSnap.data();
      if(dData.photoBase64){
        const photoEl = document.getElementById('dAvaPhoto');
        const emojiEl = document.getElementById('dAvaEmoji');
        if(photoEl){ photoEl.src = dData.photoBase64; photoEl.style.display = 'block'; }
        if(emojiEl){ emojiEl.style.display = 'none'; }
      }
    }
  } catch(e) {}
}

function listenToRide(id) {
  if(rideListener){rideListener();rideListener=null;}
  rideListener=window.FB.onSnapshot(window.FB.doc(window.FB.db,'rides',id), snap=>{
    if(!snap.exists()) return;
    const data=snap.data();
    // ‚úÖ FIX 2: Check rideDocId active AND not already on assigned screen (was blocking if user changed screen)
    if(data.status==='assigned'&&rideDocId&&!document.getElementById('sAssigned').classList.contains('on')){
      document.getElementById('aDName').textContent=data.driverName||'--';
      document.getElementById('aVeh').textContent=`${data.driverVehicle||'--'} ‚Ä¢ ${data.cabType||'--'}`;
      document.getElementById('rideOTP').textContent=data.otp||'----';

      // ‚úÖ FIX 4: Fetch and update driver rating dynamically
      if(data.driverId && window.FB_READY){
        window.FB.getDoc(window.FB.doc(window.FB.db,'users',data.driverId)).then(dSnap=>{
          if(dSnap.exists()){
            const dd=dSnap.data();
            const rating=(dd.rating||5.0).toFixed(1);
            const ratingEl=document.querySelector('#driverCard .star-row span:last-child');
            if(ratingEl) ratingEl.textContent=rating;
            // update vehicle type display
            if(dd.vehicleType){
              const vehLabel = dd.vehicleType==='cab'?'üöó Mini Cab':'üõ∫ Auto';
              const vehEl=document.getElementById('aVeh');
              if(vehEl) vehEl.textContent=`${data.driverVehicle||dd.vehicleNo||'--'} ‚Ä¢ ${vehLabel}`;
            }
          }
        }).catch(()=>{});
      }

      // ‚úÖ Store driver phone and show call button
      const dPhone = data.driverPhone||'';
      if(dPhone){
        document.getElementById('aDriverPhoneNum').textContent=dPhone;
        document.getElementById('aDriverPhone').style.display='block';
        document.getElementById('callDriverBtn').href='tel:'+dPhone;
        document.getElementById('callDriverNumLabel').textContent=dPhone;
      }

      // ‚úÖ Fetch driver photo ‚Äî called as separate async function (no await here)
      if(data.driverId) fetchAndShowDriverPhoto(data.driverId);

      goScr('sAssigned');
      playDriverAssigned();
      const banner=document.getElementById('assignedBanner');
      banner.classList.add('assign-bounce');
      setTimeout(()=>banner.classList.remove('assign-bounce'),700);
      // ‚úÖ Add assigned glow to driver card
      const dCard=document.getElementById('driverCard');
      if(dCard){ dCard.classList.add('assigned-glow'); setTimeout(()=>dCard.classList.remove('assigned-glow'),4000); }
      toast('üéâ Driver accepted your ride!');
      if(data.driverId) startDriverTracking(data.driverId);
      // ‚úÖ Show SOS button during ride
      showSOS(470);
      // ‚úÖ Start ETA countdown
      if(data.etaMin) startEtaTimer(data.etaMin);
    }
    if(data.status==='ongoing'){
      document.getElementById('driverTrackText').textContent='üöó Driver heading to your drop';
      // ‚úÖ Rider picked up ‚Äî update ETA for drop
      if(data.dropEtaMin) startEtaTimer(data.dropEtaMin);
      const etaSub = document.getElementById('etaSubText');
      if(etaSub) etaSub.textContent = 'Drop tak ka ETA';
    }
    if(data.status==='completed'){
      if(rideListener){rideListener();rideListener=null;}
      if(driverLocListener){driverLocListener();driverLocListener=null;}
      if(driverMk){ try{if(typeof driverMk.setMap==='function')driverMk.setMap(null);}catch(e){} driverMk=null; }
      clearRoute();
      document.getElementById('dropIn').value='';
      hideSOS();
      stopEtaTimer();
      goScr('sHome');
      toast('üéâ Ride complete! Shukriya JDP Cabs!');
      // ‚úÖ Show receipt then rating
      const rData = {...data, rideId: id, completedAt: data.completedAt || {toDate:()=>new Date()}};
      setTimeout(() => showReceipt(rData), 600);
      setTimeout(() => showRatingModal(id, data.driverName, data.driverId), 3000);
      rideDocId=null;
    }
    if(data.status==='cancelled_driver'){
      if(rideListener){rideListener();rideListener=null;}
      hideSOS(); stopEtaTimer();
      goScr('sHome');
      toast('‚ùå Driver cancelled. Please rebook.');
      rideDocId=null;
    }
  });
}

async function cancelBook() {
  if(rideDocId&&window.FB_READY){
    try{await window.FB.updateDoc(window.FB.doc(window.FB.db,'rides',rideDocId),{status:'cancelled',cancelledAt:window.FB.serverTimestamp()});}catch(e){}
  }
  if(rideListener){rideListener();rideListener=null;}
  clearRoute();rideDocId=null;
  document.getElementById('nearbyCount').textContent='--';
  goScr('sHome');toast('Booking cancelled');
}
// NOTE: cancelRide() is now defined in new features section above (with reason dialog)

// THEME ‚Äî Mappls v3 has built-in style switching
function toggleTheme() {
  document.body.classList.toggle('lm');
  // ‚úÖ Mappls vector map supports style toggle via setStyle
  if (leafMap && typeof leafMap.setStyle === 'function') {
    const isLight = document.body.classList.contains('lm');
    try {
      leafMap.setStyle(isLight ? 'standard-day' : 'standard-night');
    } catch(e) {}
  }
  setTimeout(() => { try { leafMap && leafMap.invalidateSize && leafMap.invalidateSize(); } catch(e){} }, 300);
}

async function doLogout() {
  if(watchId) navigator.geolocation.clearWatch(watchId);
  if(rideListener) rideListener();
  if(driverLocListener) driverLocListener();
  if(newRideListener) newRideListener();
  if(liveDriversListener) liveDriversListener();
  if(onlineTimeInterval) clearInterval(onlineTimeInterval);
  clearRoute();
  if(window.FB_READY&&CU?.role==='driver'){
    try{await window.FB.updateDoc(window.FB.doc(window.FB.db,'users',CU.uid),{isOnline:false});}catch(e){}
  }
  if(window.FB_READY){try{await window.FB.signOut(window.FB.auth);}catch(e){}}
  location.reload();
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// üìû CALL FUNCTIONS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function callDriver() {
  const btn = document.getElementById('callDriverBtn');
  const phone = btn?.href?.replace('tel:','').replace('#','');
  if (!phone || phone === '#' || phone === '') {
    toast('‚ùå Driver ka phone number available nahi hai');
    return;
  }
  // Animate button
  btn.style.transform = 'scale(0.96)';
  setTimeout(() => { btn.style.transform = ''; }, 200);
  window.location.href = 'tel:' + phone;
}

function callRider() {
  const btn = document.getElementById('callRiderBtn');
  const href = btn?.getAttribute('href') || '';
  const phone = href.replace('tel:','').trim();

  if (!phone || phone === '#' || phone === '') {
    toast('‚ùå Rider ka phone number nahi mila ‚Äî ride data mein phone save nahi tha');
    return;
  }
  // Visual feedback
  if(btn){ btn.style.transform='scale(0.95)'; setTimeout(()=>btn.style.transform='',200); }
  window.location.href = 'tel:' + phone;
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// üÜï NEW FEATURES ‚Äî Uber se Better!
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

// ‚îÄ‚îÄ Modal helpers ‚îÄ‚îÄ
function openModal(id){ document.getElementById(id).classList.add('sh'); }
function closeModal(id){ document.getElementById(id).classList.remove('sh'); }

// ‚îÄ‚îÄ ‚≠ê RIDE HISTORY ‚îÄ‚îÄ
async function showHistory() {
  openModal('histModal');
  const listEl = document.getElementById('histList');
  listEl.innerHTML = '<div style="text-align:center;color:var(--muted);padding:24px">Loading...</div>';
  if(!window.FB_READY || !CU) {
    listEl.innerHTML = '<div style="text-align:center;color:var(--muted);padding:24px">Login required</div>';
    return;
  }
  try {
    const q = window.FB.query(
      window.FB.collection(window.FB.db,'rides'),
      window.FB.where('riderId','==',CU.uid),
      window.FB.orderBy('createdAt','desc'),
      window.FB.limit(20)
    );
    const snap = await window.FB.getDocs(q);
    if(snap.empty){ listEl.innerHTML='<div style="text-align:center;padding:30px;color:var(--muted)">üöñ Koi rides nahi mili abhi tak</div>'; return; }
    let html = '';
    snap.forEach(d => {
      const r = d.data();
      const ts = r.createdAt?.toDate ? r.createdAt.toDate() : new Date();
      const dateStr = ts.toLocaleDateString('hi-IN',{day:'numeric',month:'short',year:'numeric'});
      const done = r.status === 'completed';
      html += `<div class="hist-item">
        <div class="hist-icon">${r.cabType?.includes('Mini') ? 'üöó' : 'üõ∫'}</div>
        <div class="hist-info">
          <div class="hist-route">${r.pickup||'?'} ‚Üí ${r.drop||'?'}</div>
          <div class="hist-meta">${dateStr} ¬∑ ${r.distanceKM||'?'}km ¬∑ ${r.driverName||'Driver'}</div>
          <span class="hist-tag ${done?'done':'cancel'}">${done?'‚úÖ Completed':'‚ùå Cancelled'}</span>
        </div>
        <div style="text-align:right;flex-shrink:0">
          <div class="hist-fare">‚Çπ${r.fare||'--'}</div>
          ${done ? `<div style="font-size:.62rem;color:var(--muted);margin-top:2px;cursor:pointer" onclick="showReceiptFromHistory(${JSON.stringify(r).replace(/"/g,'&quot;')})">üßæ Receipt</div>` : ''}
        </div>
      </div>`;
    });
    listEl.innerHTML = html;
  } catch(e) { listEl.innerHTML = `<div style="color:var(--red);padding:12px">‚ùå Error: ${e.message}</div>`; }
}

// ‚îÄ‚îÄ ‚≠ê STAR RATING ‚îÄ‚îÄ
let selectedRating = 0, lastRideData = null;
const ratingLabels = ['','üòû Bahut Bura','üòê Theek Tha','üôÇ Accha Tha','üòä Bahut Accha','ü§© Zabardast!'];
function setRating(n) {
  selectedRating = n;
  document.querySelectorAll('.star-big').forEach((s,i) => {
    s.classList.toggle('lit', i < n);
    s.style.transform = i < n ? 'scale(1.1)' : 'scale(1)';
  });
  document.getElementById('ratingLabel').textContent = ratingLabels[n];
  document.getElementById('ratingLabel').style.color = n>=4 ? 'var(--green)' : n>=3 ? 'var(--yellow)' : 'var(--red)';
}
async function submitRating() {
  if(!selectedRating){ toast('‚≠ê Pehle rating do!'); return; }
  const comment = document.getElementById('ratingComment').value.trim();
  if(window.FB_READY && lastRideData?.rideId) {
    try {
      await window.FB.updateDoc(window.FB.doc(window.FB.db,'rides',lastRideData.rideId),{
        riderRating: selectedRating, riderComment: comment, ratedAt: window.FB.serverTimestamp()
      });
      // Update driver avg rating
      if(lastRideData.driverId) {
        const dSnap = await window.FB.getDoc(window.FB.doc(window.FB.db,'users',lastRideData.driverId));
        if(dSnap.exists()){
          const ddata = dSnap.data();
          const oldRating = ddata.rating || 5.0;
          const totalRides = ddata.ridesCompleted || 1;
          const newRating = parseFloat(((oldRating * (totalRides-1) + selectedRating) / totalRides).toFixed(1));
          await window.FB.updateDoc(window.FB.doc(window.FB.db,'users',lastRideData.driverId),{rating: newRating});
        }
      }
    } catch(e) {}
  }
  closeModal('ratingModal');
  toast('üôè Rating submit ho gaya! Shukriya!');
  selectedRating = 0;
  document.querySelectorAll('.star-big').forEach(s => { s.classList.remove('lit'); s.style.transform=''; });
}
function showRatingModal(rideId, driverName, driverId) {
  lastRideData = {rideId, driverName, driverId};
  document.getElementById('rateDriverName').textContent = driverName || 'Driver';
  selectedRating = 0;
  document.querySelectorAll('.star-big').forEach(s => { s.classList.remove('lit'); s.style.transform=''; });
  document.getElementById('ratingLabel').textContent = '';
  document.getElementById('ratingComment').value = '';
  openModal('ratingModal');
}

// ‚îÄ‚îÄ üßæ RECEIPT ‚îÄ‚îÄ
let lastReceiptData = null;
function showReceipt(data) {
  lastReceiptData = data;
  const ts = data.completedAt?.toDate ? data.completedAt.toDate() : new Date();
  document.getElementById('rcptDate').textContent = ts.toLocaleString('hi-IN');
  document.getElementById('rcptTotal').textContent = `‚Çπ${data.fare || '--'}`;
  const discount = data.promoDiscount || 0;
  document.getElementById('rcptBody').innerHTML = `
    <div class="rcpt-row"><span style="color:var(--muted)">Pickup</span><span style="text-align:right;max-width:60%">${data.pickup||'--'}</span></div>
    <div class="rcpt-row"><span style="color:var(--muted)">Drop</span><span style="text-align:right;max-width:60%">${data.drop||'--'}</span></div>
    <div class="rcpt-row"><span style="color:var(--muted)">Distance</span><span>${data.distanceKM||'--'} km</span></div>
    <div class="rcpt-row"><span style="color:var(--muted)">Vehicle</span><span>${data.cabType||'--'}</span></div>
    <div class="rcpt-row"><span style="color:var(--muted)">Driver</span><span>${data.driverName||'--'}</span></div>
    <div class="rcpt-row"><span style="color:var(--muted)">Base Fare</span><span>‚Çπ${data.originalFare||data.fare||'--'}</span></div>
    ${discount ? `<div class="rcpt-row"><span style="color:var(--green)">Promo (${data.promoCode||''})</span><span style="color:var(--green)">-‚Çπ${discount}</span></div>` : ''}
    ${discount ? `<div class="rcpt-row"><span style="font-weight:800">Final Fare</span><span style="font-weight:800;color:var(--yellow)">‚Çπ${data.fare||'--'}</span></div>` : ''}
  `;
  document.getElementById('rcptShareBtns').innerHTML = `
    <a class="wa-btn" href="https://wa.me/?text=${encodeURIComponent(`JDP CABS Receipt üöñ\nPickup: ${data.pickup}\nDrop: ${data.drop}\nFare: ‚Çπ${data.fare}\nDate: ${ts.toLocaleDateString()}\n\nBook: jdpcabs.web.app`)}" target="_blank">
      <span>üì§</span> WhatsApp par Share karo
    </a>`;
  openModal('receiptModal');
}
function showReceiptFromHistory(data) {
  closeModal('histModal');
  setTimeout(() => showReceipt(data), 300);
}

// ‚îÄ‚îÄ üì§ SHARE TRIP ‚îÄ‚îÄ
function shareTrip() {
  const driverName = document.getElementById('aDName').textContent || 'Driver';
  const otp = document.getElementById('rideOTP').textContent || '----';
  const pickup = document.getElementById('pAddr')?.textContent || 'Current Location';
  const drop = document.getElementById('dropIn')?.value || 'Drop Location';
  const msg = `üöñ Meri JDP Cab ke baare mein:\nüë®‚Äç‚úàÔ∏è Driver: ${driverName}\nüìç Pickup: ${pickup}\nüèÅ Drop: ${drop}\nüîê OTP: ${otp}\n\nLive Track: jdpcabs.web.app`;
  const waUrl = `https://wa.me/?text=${encodeURIComponent(msg)}`;
  window.open(waUrl, '_blank');
}

// ‚îÄ‚îÄ üè† FAVORITE LOCATIONS ‚îÄ‚îÄ
let favLocations = JSON.parse(localStorage.getItem('jdpFavLocs') || '{}');
function loadFavChips() {
  if(favLocations.home) {
    document.getElementById('favHomeLbl').textContent = favLocations.home.name;
    document.getElementById('favHomeChip').classList.add('set');
  }
  if(favLocations.work) {
    document.getElementById('favWorkLbl').textContent = favLocations.work.name;
    document.getElementById('favWorkChip').classList.add('set');
  }
  // Show promo strip for new users
  const promoSeen = localStorage.getItem('jdpPromoSeen');
  if(!promoSeen) {
    document.getElementById('promoStrip').style.display = 'flex';
    document.getElementById('promoStripText').textContent = 'üéâ JDP50 ‚Äî Pehli ride ‚Çπ50 off!';
  }
}
function useFavLoc(type) {
  const fav = favLocations[type];
  if(fav) {
    document.getElementById('dropIn').value = fav.name;
    toast(`${type==='home'?'üè†':'üíº'} ${fav.name} set as drop`);
    calcFare();
  } else {
    const addr = prompt(`${type==='home'?'üè† Home':'üíº Work'} address daalo:`);
    if(addr && addr.trim()) {
      favLocations[type] = { name: addr.trim() };
      localStorage.setItem('jdpFavLocs', JSON.stringify(favLocations));
      document.getElementById(`fav${type==='home'?'Home':'Work'}Lbl`).textContent = addr.trim();
      document.getElementById(`fav${type==='home'?'Home':'Work'}Chip`).classList.add('set');
      toast(`‚úÖ ${type==='home'?'Home':'Work'} save ho gaya!`);
    }
  }
}

// ‚îÄ‚îÄ üí¨ QUICK MESSAGES ‚îÄ‚îÄ
async function sendQuickMsg(msg) {
  if(!rideDocId || !window.FB_READY){ toast('‚ùå No active ride'); return; }
  try {
    await window.FB.updateDoc(window.FB.doc(window.FB.db,'rides',rideDocId),{
      lastMsg: msg, lastMsgBy: 'rider', lastMsgAt: window.FB.serverTimestamp()
    });
    document.getElementById('msgSentConfirm').style.display = 'block';
    setTimeout(() => {
      document.getElementById('msgSentConfirm').style.display = 'none';
      closeModal('msgModal');
    }, 1500);
  } catch(e) { toast('‚ùå Message send nahi hua'); }
}
async function sendCustomMsg() {
  const msg = document.getElementById('customMsgInput').value.trim();
  if(!msg){ toast('Message khaali hai'); return; }
  await sendQuickMsg(msg);
  document.getElementById('customMsgInput').value = '';
}

// ‚îÄ‚îÄ üéÅ PROMO CODE ‚îÄ‚îÄ
const PROMO_CODES = { 'JDP50': {discount:50, desc:'‚Çπ50 off'}, 'FREE1': {discount:100, desc:'‚Çπ100 off (pehli ride)'}, 'BASTAR10': {discount:30, desc:'‚Çπ30 off'} };
let appliedPromo = null;
function applyPromo() {
  const code = document.getElementById('promoInput').value.trim().toUpperCase();
  const resultEl = document.getElementById('promoResult');
  if(!code){ resultEl.innerHTML = '<span style="color:var(--red)">Code daalo pehle</span>'; return; }
  if(PROMO_CODES[code]) {
    appliedPromo = { code, ...PROMO_CODES[code] };
    resultEl.innerHTML = `<span style="color:var(--green)">‚úÖ "${code}" apply hua! ${PROMO_CODES[code].desc}</span>`;
    localStorage.setItem('jdpPromoSeen','1');
    document.getElementById('promoStrip').style.display = 'none';
    toast(`üéâ Promo "${code}" apply hua!`);
    setTimeout(() => closeModal('promoModal'), 1200);
  } else {
    resultEl.innerHTML = '<span style="color:var(--red)">‚ùå Invalid code</span>';
    appliedPromo = null;
  }
}

// ‚îÄ‚îÄ üìä EARNINGS BREAKDOWN ‚îÄ‚îÄ
function showEarningsBreak() {
  const wrap = document.getElementById('earnBarWrap');
  const isVisible = wrap.style.display !== 'none';
  wrap.style.display = isVisible ? 'none' : 'block';
  if(!isVisible) {
    const pct = Math.min(100, Math.round((dEarnings / 1000) * 100));
    document.getElementById('earnGoalPct').textContent = pct + '%';
    document.getElementById('earnBarFill').style.width = pct + '%';
  }
}

// ‚îÄ‚îÄ ‚ùå CANCEL REASON ‚îÄ‚îÄ
let selectedCancelReason = '';
function cancelRide() {
  if(document.getElementById('sAssigned').classList.contains('on')) {
    openModal('cancelModal');
  } else {
    doCancelRide('');
  }
}
function selectCancelReason(el, reason) {
  document.querySelectorAll('.cancel-opt').forEach(o => o.classList.remove('sel'));
  el.classList.add('sel');
  selectedCancelReason = reason;
  document.getElementById('confirmCancelBtn').disabled = false;
  document.getElementById('confirmCancelBtn').style.opacity = '1';
}
async function confirmCancelRide() {
  closeModal('cancelModal');
  await doCancelRide(selectedCancelReason);
  selectedCancelReason = '';
}
async function doCancelRide(reason) {
  if(rideDocId && window.FB_READY){
    try { await window.FB.updateDoc(window.FB.doc(window.FB.db,'rides',rideDocId),{
      status:'cancelled', cancelReason: reason, cancelledAt: window.FB.serverTimestamp()
    }); } catch(e) {}
  }
  if(rideListener){ rideListener(); rideListener=null; }
  clearRoute(); rideDocId=null;
  hideSOS();
  stopEtaTimer();
  goScr('sHome');
  toast('Ride cancelled' + (reason ? `: ${reason}` : ''));
}

// ‚îÄ‚îÄ üÜò SOS PANIC BUTTON ‚îÄ‚îÄ
function showSOS(bottom) {
  const btn = document.getElementById('sosBtn');
  btn.style.display = 'flex';
  btn.style.bottom = (bottom || 420) + 'px';
}
function hideSOS() {
  document.getElementById('sosBtn').style.display = 'none';
}
function panicSOS() {
  const driverName = document.getElementById('aDName')?.textContent || 'Unknown';
  const vehicle = document.getElementById('aVeh')?.textContent || 'Unknown';
  const otp = document.getElementById('rideOTP')?.textContent || '----';
  const myLoc = myLat ? `${myLat.toFixed(5)},${myLng.toFixed(5)}` : 'Unknown';
  if(confirm('üÜò SOS ‚Äî Emergency hai kya?\n\nYeh message family ko WhatsApp par jayega:\n- Driver ka naam\n- Gaadi number\n- Aapki location\n\nContinue?')) {
    const msg = `üÜò EMERGENCY - JDP CABS\n\nMujhe help chahiye!\nDriver: ${driverName}\nGaadi: ${vehicle}\nOTP: ${otp}\nLocation: https://maps.google.com/?q=${myLoc}\nTime: ${new Date().toLocaleString('hi-IN')}`;
    window.open(`https://wa.me/?text=${encodeURIComponent(msg)}`,'_blank');
    toast('üÜò SOS WhatsApp message tayaar!');
  }
}

// ‚îÄ‚îÄ ‚è±Ô∏è ETA LIVE COUNTDOWN ‚îÄ‚îÄ
let etaTimerInterval = null, etaEndTime = null;
function startEtaTimer(minutes) {
  stopEtaTimer();
  const etaEl = document.getElementById('etaCountdown');
  const subEl = document.getElementById('etaSubText');
  if(!etaEl) return;
  etaEndTime = Date.now() + minutes * 60000;
  function tick() {
    const left = etaEndTime - Date.now();
    if(left <= 0) {
      etaEl.textContent = 'üöó Yahan hai!';
      subEl.textContent = 'Driver pahunch gaya!';
      clearInterval(etaTimerInterval);
      return;
    }
    const m = Math.floor(left / 60000);
    const s = Math.floor((left % 60000) / 1000);
    etaEl.textContent = m > 0 ? `${m}:${s.toString().padStart(2,'0')}` : `${s}s`;
    subEl.textContent = m > 0 ? `${m} minute ${s} second remaining` : `${s} seconds remaining`;
  }
  tick();
  etaTimerInterval = setInterval(tick, 1000);
}
function stopEtaTimer() {
  if(etaTimerInterval){ clearInterval(etaTimerInterval); etaTimerInterval=null; }
  const el = document.getElementById('etaCountdown');
  if(el) el.textContent = '--';
  const sub = document.getElementById('etaSubText');
  if(sub) sub.textContent = 'Calculating ETA...';
}

function toast(msg) {
  document.querySelectorAll('.toast').forEach(t=>t.remove());
  const el=document.createElement('div');el.className='toast';el.textContent=msg;
  document.body.appendChild(el);
  setTimeout(()=>el.remove(),3200);
}
</script>

<!-- ‚úÖ PWA: Inline Manifest + Service Worker (works as local file too) -->
<script>
(function(){
  try {
    // ‚îÄ‚îÄ Inline Manifest via Blob URL ‚îÄ‚îÄ
    const manifest = {
      name: "JDP CABS \u2014 Jagdalpur",
      short_name: "JDP Cabs",
      description: "Jagdalpur ka smartest cab booking app",
      start_url: "./",
      display: "standalone",
      orientation: "portrait",
      background_color: "#07090f",
      theme_color: "#f59e0b",
      icons: [
        { src: "icon-192.png", sizes: "192x192", type: "image/png", purpose: "any maskable" },
        { src: "icon-512.png", sizes: "512x512", type: "image/png", purpose: "any maskable" }
      ]
    };
    const mBlob = new Blob([JSON.stringify(manifest)], {type:'application/json'});
    const mUrl  = URL.createObjectURL(mBlob);
    const mLink = document.createElement('link');
    mLink.rel = 'manifest'; mLink.href = mUrl;
    document.head.appendChild(mLink);
  } catch(e) {}

  try {
    // ‚îÄ‚îÄ Inline Service Worker via Blob URL ‚îÄ‚îÄ
    if ('serviceWorker' in navigator) {
      const swCode = `
const CACHE='jdpcabs-v5';
self.addEventListener('install', e => { self.skipWaiting(); });
self.addEventListener('activate', e => { self.clients.claim(); });
self.addEventListener('fetch', e => {
  const url = new URL(e.request.url);
  const skip = ['firebase','firebaseapp','googleapis','osrm','openstreetmap','gstatic','unsplash','fonts','apis.mappls.com'];
                 'openstreetmap','gstatic','unsplash','fonts','apis.mappls.com'];
  if (skip.some(d => url.hostname.includes(d))) return;
  if (e.request.method !== 'GET') return;
  e.respondWith(
    caches.match(e.request).then(cached => {
      if (cached) return cached;
      return fetch(e.request).then(res => {
        if (res && res.status === 200) {
          const clone = res.clone();
          caches.open(CACHE).then(c => c.put(e.request, clone));
        }
        return res;
      }).catch(() => cached);
    })
  );
});`;
      const swBlob = new Blob([swCode], {type:'application/javascript'});
      const swUrl  = URL.createObjectURL(swBlob);
      navigator.serviceWorker.register(swUrl, {scope: './'})
        .then(() => console.log('[JDP Cabs] SW ready'))
        .catch(() => {});
    }
  } catch(e) {}
})();
</script>
</body>
</html>

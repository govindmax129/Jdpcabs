<!DOCTYPE html>
<html lang="hi">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>JDP CABS â€” Admin Control Panel</title>
<link href="https://fonts.googleapis.com/css2?family=Syne:wght@700;800;900&family=DM+Mono:wght@400;500&family=DM+Sans:wght@400;500;600;700&display=swap" rel="stylesheet">
<style>
:root{
  --bg:#04060d;--card:#090e1a;--card2:#0e1525;--border:#162035;
  --text:#e8f0fe;--muted:#3d5a8a;--yellow:#f59e0b;--green:#10b981;
  --red:#ef4444;--blue:#3b82f6;--purple:#8b5cf6;--orange:#f97316;
  --cyan:#06b6d4;
}
*{margin:0;padding:0;box-sizing:border-box;-webkit-tap-highlight-color:transparent;}
body{font-family:'DM Sans',sans-serif;background:var(--bg);color:var(--text);min-height:100vh;overflow-x:hidden;}
::-webkit-scrollbar{width:4px;height:4px;}
::-webkit-scrollbar-track{background:transparent;}
::-webkit-scrollbar-thumb{background:var(--border);border-radius:99px;}

/* â•â• GRID NOISE BACKGROUND â•â• */
body::before{content:'';position:fixed;inset:0;background-image:radial-gradient(ellipse 80% 50% at 20% -10%,rgba(59,130,246,.08),transparent),radial-gradient(ellipse 60% 40% at 80% 110%,rgba(245,158,11,.05),transparent);pointer-events:none;z-index:0;}

/* â•â• LOGIN â•â• */
#loginScreen{position:fixed;inset:0;z-index:9999;display:flex;align-items:center;justify-content:center;background:var(--bg);padding:20px;}
.login-box{width:100%;max-width:380px;background:var(--card);border:1px solid var(--border);border-radius:24px;padding:32px 28px;position:relative;overflow:hidden;}
.login-box::before{content:'';position:absolute;top:-60px;right:-60px;width:200px;height:200px;background:radial-gradient(circle,rgba(245,158,11,.12),transparent 70%);pointer-events:none;}
.login-logo{display:flex;align-items:center;gap:12px;margin-bottom:28px;}
.login-badge{width:48px;height:48px;background:var(--yellow);border-radius:14px;display:flex;align-items:center;justify-content:center;font-family:'Syne',sans-serif;font-size:1.1rem;font-weight:900;color:#000;}
.login-title{font-family:'Syne',sans-serif;font-weight:900;font-size:1.2rem;}
.login-sub{font-size:.72rem;color:var(--muted);margin-top:1px;}
.lfi{width:100%;background:rgba(255,255,255,.04);border:1.5px solid var(--border);border-radius:12px;padding:13px 15px;color:var(--text);outline:none;font-family:'DM Sans',sans-serif;font-size:.92rem;transition:border-color .2s;margin-bottom:11px;}
.lfi:focus{border-color:var(--yellow);}
.lbtn{width:100%;border:none;border-radius:12px;padding:14px;font-size:.95rem;font-weight:800;cursor:pointer;font-family:'Syne',sans-serif;background:var(--yellow);color:#000;transition:opacity .2s;}
.lbtn:active{opacity:.85;}
.lerr{color:var(--red);font-size:.78rem;margin-bottom:10px;text-align:center;min-height:20px;}

/* â•â• SIDEBAR â•â• */
#app{display:none;min-height:100vh;}
.layout{display:flex;}
#sidebar{width:240px;min-height:100vh;background:var(--card);border-right:1px solid var(--border);position:fixed;top:0;left:0;bottom:0;z-index:100;display:flex;flex-direction:column;transition:transform .25s;}
@media(max-width:768px){#sidebar{transform:translateX(-100%);}#sidebar.open{transform:translateX(0);}}
.sb-logo{padding:22px 18px 16px;border-bottom:1px solid var(--border);}
.sb-brand{font-family:'Syne',sans-serif;font-weight:900;font-size:1rem;letter-spacing:.04em;}
.sb-tag{font-size:.6rem;color:var(--muted);font-weight:600;margin-top:2px;text-transform:uppercase;letter-spacing:.06em;}
.sb-nav{flex:1;padding:12px 10px;overflow-y:auto;}
.sb-section{font-size:.55rem;font-weight:800;color:var(--muted);text-transform:uppercase;letter-spacing:.1em;padding:8px 10px 4px;}
.sb-item{display:flex;align-items:center;gap:10px;padding:10px 12px;border-radius:11px;cursor:pointer;font-size:.84rem;font-weight:600;color:var(--muted);transition:all .15s;margin-bottom:2px;}
.sb-item:hover{background:rgba(255,255,255,.04);color:var(--text);}
.sb-item.act{background:rgba(245,158,11,.12);color:var(--yellow);font-weight:700;}
.sb-icon{font-size:1rem;width:22px;text-align:center;flex-shrink:0;}
.sb-badge{margin-left:auto;background:var(--red);color:#fff;border-radius:99px;padding:2px 7px;font-size:.58rem;font-weight:800;}
.sb-bottom{padding:14px 10px;border-top:1px solid var(--border);}
.sb-admin-chip{display:flex;align-items:center;gap:9px;padding:10px 12px;background:rgba(255,255,255,.03);border-radius:11px;}
.sb-admin-av{width:32px;height:32px;background:var(--yellow);border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:.9rem;font-weight:800;color:#000;flex-shrink:0;}

/* â•â• MAIN â•â• */
.main{margin-left:240px;padding:24px;position:relative;z-index:1;}
@media(max-width:768px){.main{margin-left:0;}}
.topbar{display:flex;align-items:center;gap:12px;margin-bottom:24px;}
.hamburger{display:none;background:var(--card);border:1px solid var(--border);border-radius:10px;padding:8px 10px;cursor:pointer;font-size:1.1rem;}
@media(max-width:768px){.hamburger{display:flex;}}
.page-title{font-family:'Syne',sans-serif;font-weight:900;font-size:1.3rem;}
.page-sub{font-size:.72rem;color:var(--muted);margin-top:2px;}
.topbar-right{margin-left:auto;display:flex;align-items:center;gap:10px;}
.live-badge{display:flex;align-items:center;gap:6px;background:rgba(16,185,129,.08);border:1px solid rgba(16,185,129,.2);border-radius:99px;padding:5px 12px;font-size:.7rem;font-weight:700;color:var(--green);}
.live-dot{width:7px;height:7px;background:var(--green);border-radius:50%;animation:ldpulse 1.5s infinite;}
@keyframes ldpulse{0%,100%{opacity:1}50%{opacity:.3}}

/* â•â• STAT CARDS â•â• */
.stats-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(160px,1fr));gap:12px;margin-bottom:20px;}
.stat-card{background:var(--card);border:1px solid var(--border);border-radius:16px;padding:16px;position:relative;overflow:hidden;cursor:pointer;transition:border-color .2s;}
.stat-card:hover{border-color:rgba(255,255,255,.15);}
.stat-card::after{content:'';position:absolute;top:0;right:0;width:80px;height:80px;border-radius:50%;opacity:.06;background:var(--accent,var(--yellow));transform:translate(20px,-20px);}
.stat-icon{font-size:1.5rem;margin-bottom:8px;}
.stat-val{font-family:'Syne',sans-serif;font-weight:900;font-size:1.6rem;line-height:1;}
.stat-lbl{font-size:.65rem;font-weight:700;color:var(--muted);text-transform:uppercase;letter-spacing:.05em;margin-top:4px;}
.stat-change{font-size:.68rem;font-weight:700;margin-top:4px;}
.stat-change.up{color:var(--green);}
.stat-change.dn{color:var(--red);}

/* â•â• TABLES â•â• */
.panel{background:var(--card);border:1px solid var(--border);border-radius:16px;overflow:hidden;margin-bottom:16px;}
.panel-hd{display:flex;align-items:center;justify-content:space-between;padding:14px 16px;border-bottom:1px solid var(--border);}
.panel-title{font-family:'Syne',sans-serif;font-weight:800;font-size:.9rem;}
.panel-actions{display:flex;gap:8px;}
.act-btn{display:inline-flex;align-items:center;gap:5px;padding:6px 12px;border-radius:8px;border:1px solid var(--border);background:rgba(255,255,255,.03);font-size:.72rem;font-weight:700;cursor:pointer;color:var(--text);transition:all .15s;}
.act-btn:hover{background:rgba(255,255,255,.07);}
.act-btn.primary{background:var(--yellow);color:#000;border-color:var(--yellow);}
.act-btn.green{background:rgba(16,185,129,.15);border-color:rgba(16,185,129,.3);color:var(--green);}
.act-btn.red{background:rgba(239,68,68,.12);border-color:rgba(239,68,68,.25);color:var(--red);}
table{width:100%;border-collapse:collapse;}
th{font-size:.6rem;font-weight:800;color:var(--muted);text-transform:uppercase;letter-spacing:.07em;padding:10px 16px;text-align:left;border-bottom:1px solid var(--border);white-space:nowrap;}
td{padding:12px 16px;font-size:.83rem;border-bottom:1px solid rgba(255,255,255,.03);vertical-align:middle;}
tr:last-child td{border-bottom:none;}
tr:hover td{background:rgba(255,255,255,.02);}
.td-mono{font-family:'DM Mono',monospace;font-size:.78rem;}
.chip{display:inline-flex;align-items:center;gap:4px;padding:3px 9px;border-radius:99px;font-size:.64rem;font-weight:800;}
.chip.green{background:rgba(16,185,129,.12);color:var(--green);border:1px solid rgba(16,185,129,.2);}
.chip.red{background:rgba(239,68,68,.1);color:var(--red);border:1px solid rgba(239,68,68,.18);}
.chip.yellow{background:rgba(245,158,11,.1);color:var(--yellow);border:1px solid rgba(245,158,11,.2);}
.chip.blue{background:rgba(59,130,246,.1);color:var(--blue);border:1px solid rgba(59,130,246,.2);}
.chip.purple{background:rgba(139,92,246,.1);color:var(--purple);border:1px solid rgba(139,92,246,.2);}
.chip.grey{background:rgba(255,255,255,.07);color:var(--muted);border:1px solid var(--border);}
.avatar{width:32px;height:32px;border-radius:50%;object-fit:cover;border:2px solid var(--border);display:inline-flex;align-items:center;justify-content:center;font-size:.9rem;background:var(--card2);flex-shrink:0;}

/* â•â• SEARCH / FILTER â•â• */
.filter-row{display:flex;gap:8px;padding:10px 16px;border-bottom:1px solid var(--border);flex-wrap:wrap;}
.search-box{display:flex;align-items:center;gap:7px;background:rgba(255,255,255,.04);border:1px solid var(--border);border-radius:9px;padding:7px 11px;flex:1;min-width:180px;}
.search-box input{background:none;border:none;outline:none;color:var(--text);font-size:.82rem;font-family:'DM Sans',sans-serif;width:100%;}
.filter-chip{padding:6px 12px;border-radius:8px;border:1px solid var(--border);background:transparent;font-size:.72rem;font-weight:700;cursor:pointer;color:var(--muted);transition:all .15s;}
.filter-chip.act{background:rgba(245,158,11,.1);border-color:rgba(245,158,11,.3);color:var(--yellow);}

/* â•â• MAP CARD â•â• */
#liveMapCard{height:320px;background:var(--card);border:1px solid var(--border);border-radius:16px;overflow:hidden;margin-bottom:16px;position:relative;}
#adminMap{width:100%;height:100%;}
.map-overlay{position:absolute;top:12px;left:12px;z-index:500;display:flex;flex-direction:column;gap:7px;pointer-events:none;}
.map-chip{background:rgba(4,6,13,.92);backdrop-filter:blur(10px);border:1px solid rgba(255,255,255,.1);border-radius:99px;padding:5px 12px;font-size:.68rem;font-weight:700;display:flex;align-items:center;gap:5px;}

/* â•â• KYC REVIEW â•â• */
.kyc-card{background:var(--card);border:1px solid var(--border);border-radius:16px;padding:18px;margin-bottom:12px;}
.kyc-header{display:flex;align-items:center;gap:12px;margin-bottom:14px;}
.kyc-photo{width:56px;height:56px;border-radius:50%;object-fit:cover;border:2px solid var(--yellow);background:var(--card2);display:flex;align-items:center;justify-content:center;font-size:1.5rem;flex-shrink:0;}
.kyc-field{background:rgba(255,255,255,.03);border:1px solid var(--border);border-radius:10px;padding:10px 13px;margin-bottom:8px;}
.kyc-flbl{font-size:.58rem;font-weight:800;color:var(--muted);text-transform:uppercase;letter-spacing:.06em;margin-bottom:3px;}
.kyc-fval{font-family:'DM Mono',monospace;font-size:.84rem;font-weight:500;}
.kyc-grid{display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-bottom:12px;}
.kyc-actions{display:flex;gap:8px;}

/* â•â• TOAST â•â• */
.toast{position:fixed;bottom:24px;left:50%;transform:translateX(-50%);background:var(--card2);border:1px solid var(--border);border-radius:12px;padding:10px 20px;font-size:.82rem;font-weight:700;z-index:99999;white-space:nowrap;pointer-events:none;animation:toastIn .3s ease;}
@keyframes toastIn{from{opacity:0;transform:translateX(-50%) translateY(20px)}to{opacity:1;transform:translateX(-50%) translateY(0)}}

/* â•â• MODAL â•â• */
.overlay{position:fixed;inset:0;z-index:9000;background:rgba(0,0,0,.75);display:none;align-items:center;justify-content:center;padding:20px;backdrop-filter:blur(4px);}
.overlay.sh{display:flex;animation:fadeIn .2s ease;}
@keyframes fadeIn{from{opacity:0}to{opacity:1}}
.modal{background:var(--card);border:1px solid var(--border);border-radius:20px;padding:22px;width:100%;max-width:480px;max-height:90vh;overflow-y:auto;}
.modal-title{font-family:'Syne',sans-serif;font-weight:900;font-size:1rem;margin-bottom:16px;}
.fi{width:100%;background:rgba(255,255,255,.04);border:1.5px solid var(--border);border-radius:11px;padding:11px 13px;color:var(--text);outline:none;font-family:'DM Sans',sans-serif;font-size:.88rem;transition:border-color .2s;margin-bottom:10px;}
.fi:focus{border-color:var(--yellow);}
.fl{font-size:.62rem;font-weight:700;color:var(--muted);text-transform:uppercase;letter-spacing:.05em;display:block;margin-bottom:4px;}

/* â•â• PAGES â•â• */
.page{display:none;}
.page.act{display:block;animation:pageIn .25s ease;}
@keyframes pageIn{from{opacity:0;transform:translateY(8px)}to{opacity:1;transform:translateY(0)}}

/* â•â• SECTION TITLE â•â• */
.section-hd{display:flex;align-items:center;justify-content:space-between;margin-bottom:12px;}
.section-title{font-family:'Syne',sans-serif;font-weight:800;font-size:.88rem;color:var(--muted);text-transform:uppercase;letter-spacing:.06em;}

/* â•â• EMPTY STATE â•â• */
.empty{text-align:center;padding:40px 20px;color:var(--muted);}
.empty-icon{font-size:2.5rem;margin-bottom:10px;}

/* â•â• SURGE CONTROL â•â• */
.surge-card{background:linear-gradient(135deg,rgba(245,158,11,.08),rgba(249,115,22,.06));border:1px solid rgba(245,158,11,.2);border-radius:16px;padding:16px;margin-bottom:16px;}
.surge-toggle{display:flex;align-items:center;gap:12px;}
.tgsw{position:relative;width:48px;height:26px;flex-shrink:0;}
.tgtr{position:absolute;inset:0;background:rgba(255,255,255,.1);border-radius:99px;transition:background .2s;}
.tgth{position:absolute;top:3px;left:3px;width:20px;height:20px;background:#fff;border-radius:50%;transition:transform .2s;box-shadow:0 1px 4px rgba(0,0,0,.3);}
input:checked~.tgtr{background:var(--yellow);}
input:checked~.tgth{transform:translateX(22px);}
input[type=checkbox]{position:absolute;opacity:0;width:100%;height:100%;cursor:pointer;z-index:2;margin:0;}

/* â•â• RESPONSIVE â•â• */
@media(max-width:600px){.stats-grid{grid-template-columns:repeat(2,1fr);}.kyc-grid{grid-template-columns:1fr;}}
</style>
</head>
<body>

<!-- â•â• LOGIN SCREEN â•â• -->
<div id="loginScreen">
  <div class="login-box">
    <div class="login-logo">
      <div class="login-badge">JDP</div>
      <div>
        <div class="login-title">Admin Panel</div>
        <div class="login-sub">JDP CABS Â· Jagdalpur</div>
      </div>
    </div>
    <div class="lerr" id="loginErr"></div>
    <input class="lfi" type="email" id="adminEmail" placeholder="Admin Email" value="admin@jdpcabs.in">
    <input class="lfi" type="password" id="adminPass" placeholder="Password" onkeydown="if(event.key==='Enter')doAdminLogin()">
    <button class="lbtn" onclick="doAdminLogin()">ğŸ” Login to Dashboard</button>
    <div style="text-align:center;font-size:.65rem;color:var(--muted);margin-top:14px">ğŸ”’ Sirf authorized admin access</div>
  </div>
</div>

<!-- â•â• MAIN APP â•â• -->
<div id="app">
  <div class="layout">

    <!-- SIDEBAR -->
    <div id="sidebar">
      <div class="sb-logo">
        <div class="sb-brand">ğŸš– JDP CABS</div>
        <div class="sb-tag">Admin Control Panel</div>
      </div>
      <nav class="sb-nav">
        <div class="sb-section">Overview</div>
        <div class="sb-item act" onclick="gotoPage('dashboard')"><span class="sb-icon">ğŸ“Š</span> Dashboard</div>
        <div class="sb-item" onclick="gotoPage('livemap')"><span class="sb-icon">ğŸ—ºï¸</span> Live Map</div>

        <div class="sb-section">Management</div>
        <div class="sb-item" onclick="gotoPage('rides')"><span class="sb-icon">ğŸš—</span> All Rides</div>
        <div class="sb-item" onclick="gotoPage('drivers')"><span class="sb-icon">ğŸ‘¨â€âœˆï¸</span> Drivers</div>
        <div class="sb-item" onclick="gotoPage('riders')"><span class="sb-icon">ğŸ§</span> Riders</div>
        <div class="sb-item" onclick="gotoPage('kyc')"><span class="sb-icon">ğŸªª</span> KYC Review <span class="sb-badge" id="kycBadge">...</span></div>

        <div class="sb-section">Finance</div>
        <div class="sb-item" onclick="gotoPage('earnings')"><span class="sb-icon">ğŸ’°</span> Earnings</div>

        <div class="sb-section">Controls</div>
        <div class="sb-item" onclick="gotoPage('surge')"><span class="sb-icon">âš¡</span> Surge Control</div>
        <div class="sb-item" onclick="gotoPage('promo')"><span class="sb-icon">ğŸ</span> Promo Codes</div>
        <div class="sb-item" onclick="gotoPage('settings')"><span class="sb-icon">âš™ï¸</span> Settings</div>
      </nav>
      <div class="sb-bottom">
        <div class="sb-admin-chip">
          <div class="sb-admin-av">A</div>
          <div style="flex:1;min-width:0">
            <div style="font-weight:700;font-size:.8rem" id="adminName">Admin</div>
            <div style="font-size:.62rem;color:var(--muted)">Super Admin</div>
          </div>
          <span style="cursor:pointer;color:var(--red);font-size:.75rem" onclick="doLogout()">Exit</span>
        </div>
      </div>
    </div>

    <!-- MAIN CONTENT -->
    <div class="main" id="mainContent">
      <div class="topbar">
        <button class="hamburger" onclick="document.getElementById('sidebar').classList.toggle('open')">â˜°</button>
        <div>
          <div class="page-title" id="pageTitle">Dashboard</div>
          <div class="page-sub" id="pageSub">Jagdalpur Live Overview</div>
        </div>
        <div class="topbar-right">
          <div class="live-badge"><div class="live-dot"></div>LIVE</div>
          <div style="font-size:.72rem;color:var(--muted)" id="lastRefresh">Refreshing...</div>
        </div>
      </div>

      <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
      <!-- PAGE: DASHBOARD -->
      <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
      <div class="page act" id="page-dashboard">
        <div class="stats-grid">
          <div class="stat-card" style="--accent:var(--yellow)" onclick="gotoPage('rides')">
            <div class="stat-icon">ğŸš—</div>
            <div class="stat-val" id="s-totalRides">--</div>
            <div class="stat-lbl">Total Rides (Today)</div>
            <div class="stat-change up" id="s-ridesChange">Loading...</div>
          </div>
          <div class="stat-card" style="--accent:var(--green)" onclick="gotoPage('drivers')">
            <div class="stat-icon">ğŸ‘¨â€âœˆï¸</div>
            <div class="stat-val" id="s-onlineDrivers">--</div>
            <div class="stat-lbl">Drivers Online</div>
            <div class="stat-change" id="s-driversChange">of <span id="s-totalDrivers">--</span> total</div>
          </div>
          <div class="stat-card" style="--accent:var(--blue)" onclick="gotoPage('earnings')">
            <div class="stat-icon">ğŸ’°</div>
            <div class="stat-val" id="s-revenue">--</div>
            <div class="stat-lbl">Today Revenue</div>
            <div class="stat-change up" id="s-revChange">Loading...</div>
          </div>
          <div class="stat-card" style="--accent:var(--purple)" onclick="gotoPage('kyc')">
            <div class="stat-icon">ğŸªª</div>
            <div class="stat-val" id="s-kycPending">--</div>
            <div class="stat-lbl">KYC Pending</div>
            <div class="stat-change dn" id="s-kycChange">Needs review</div>
          </div>
          <div class="stat-card" style="--accent:var(--cyan)" onclick="gotoPage('riders')">
            <div class="stat-icon">ğŸ§</div>
            <div class="stat-val" id="s-totalRiders">--</div>
            <div class="stat-lbl">Total Riders</div>
            <div class="stat-change up">Registered</div>
          </div>
          <div class="stat-card" style="--accent:var(--orange)">
            <div class="stat-icon">âš¡</div>
            <div class="stat-val" id="s-surgeStatus">OFF</div>
            <div class="stat-lbl">Surge Status</div>
            <div class="stat-change" id="s-surgeChange">1.0x multiplier</div>
          </div>
        </div>

        <!-- Live Rides -->
        <div class="panel">
          <div class="panel-hd">
            <div class="panel-title">ğŸ”´ Live Active Rides</div>
            <button class="act-btn" onclick="loadLiveRides()">ğŸ”„ Refresh</button>
          </div>
          <div id="liveRidesTable">
            <div class="empty"><div class="empty-icon">ğŸ•</div>Loading live rides...</div>
          </div>
        </div>

        <!-- Recent Rides -->
        <div class="panel">
          <div class="panel-hd">
            <div class="panel-title">ğŸ“‹ Recent Rides</div>
            <button class="act-btn" onclick="gotoPage('rides')">View All â†’</button>
          </div>
          <div id="recentRidesTable">
            <div class="empty"><div class="empty-icon">â³</div>Loading...</div>
          </div>
        </div>
      </div>

      <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
      <!-- PAGE: LIVE MAP -->
      <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
      <div class="page" id="page-livemap">
        <div id="liveMapCard">
          <div id="adminMap"></div>
          <div class="map-overlay">
            <div class="map-chip">ğŸŸ¢ <span id="map-onlineCount">--</span> online</div>
            <div class="map-chip">ğŸš— <span id="map-activeRides">--</span> active rides</div>
          </div>
        </div>
        <div class="panel">
          <div class="panel-hd"><div class="panel-title">ğŸŸ¢ Online Drivers</div></div>
          <div id="liveDriversList"><div class="empty">Loading...</div></div>
        </div>
      </div>

      <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
      <!-- PAGE: ALL RIDES -->
      <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
      <div class="page" id="page-rides">
        <div class="panel">
          <div class="panel-hd">
            <div class="panel-title">ğŸš— All Rides</div>
            <div class="panel-actions">
              <button class="act-btn" onclick="exportRidesCSV()">ğŸ“¥ Export CSV</button>
            </div>
          </div>
          <div class="filter-row">
            <div class="search-box"><span>ğŸ”</span><input type="text" id="rideSearch" placeholder="Rider/Driver naam ya ID..." oninput="filterRides()"></div>
            <button class="filter-chip act" onclick="setRideFilter('all',this)">All</button>
            <button class="filter-chip" onclick="setRideFilter('completed',this)">Completed</button>
            <button class="filter-chip" onclick="setRideFilter('cancelled',this)">Cancelled</button>
            <button class="filter-chip" onclick="setRideFilter('finding',this)">Active</button>
          </div>
          <div id="allRidesTable"><div class="empty">Loading...</div></div>
        </div>
      </div>

      <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
      <!-- PAGE: DRIVERS -->
      <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
      <div class="page" id="page-drivers">
        <div class="panel">
          <div class="panel-hd">
            <div class="panel-title">ğŸ‘¨â€âœˆï¸ All Drivers</div>
            <div class="panel-actions">
              <button class="act-btn green" onclick="openAddDriverModal()">+ Add Driver</button>
            </div>
          </div>
          <div class="filter-row">
            <div class="search-box"><span>ğŸ”</span><input type="text" id="driverSearch" placeholder="Driver naam ya phone..." oninput="filterDrivers()"></div>
            <button class="filter-chip act" onclick="setDriverFilter('all',this)">All</button>
            <button class="filter-chip" onclick="setDriverFilter('online',this)">Online</button>
            <button class="filter-chip" onclick="setDriverFilter('offline',this)">Offline</button>
            <button class="filter-chip" onclick="setDriverFilter('pending',this)">KYC Pending</button>
          </div>
          <div id="driversTable"><div class="empty">Loading...</div></div>
        </div>
      </div>

      <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
      <!-- PAGE: RIDERS -->
      <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
      <div class="page" id="page-riders">
        <div class="panel">
          <div class="panel-hd">
            <div class="panel-title">ğŸ§ All Riders</div>
          </div>
          <div class="filter-row">
            <div class="search-box"><span>ğŸ”</span><input type="text" id="riderSearch" placeholder="Rider naam ya phone..." oninput="filterRiders()"></div>
          </div>
          <div id="ridersTable"><div class="empty">Loading...</div></div>
        </div>
      </div>

      <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
      <!-- PAGE: KYC REVIEW -->
      <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
      <div class="page" id="page-kyc">
        <div style="margin-bottom:14px;background:rgba(245,158,11,.07);border:1px solid rgba(245,158,11,.2);border-radius:13px;padding:12px 15px;font-size:.8rem">
          âš ï¸ <b>KYC Review:</b> Yahan aap drivers ke documents verify karke approve/reject kar sakte ho. Approve hone ke baad hi driver online ho sakta hai.
        </div>
        <div id="kycList"><div class="empty"><div class="empty-icon">â³</div>Loading...</div></div>
      </div>

      <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
      <!-- PAGE: EARNINGS -->
      <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
      <div class="page" id="page-earnings">
        <div class="stats-grid">
          <div class="stat-card" style="--accent:var(--green)">
            <div class="stat-icon">ğŸ’°</div>
            <div class="stat-val" id="e-today">â‚¹--</div>
            <div class="stat-lbl">Aaj ka Revenue</div>
          </div>
          <div class="stat-card" style="--accent:var(--yellow)">
            <div class="stat-icon">ğŸ“…</div>
            <div class="stat-val" id="e-week">â‚¹--</div>
            <div class="stat-lbl">Is Hafte</div>
          </div>
          <div class="stat-card" style="--accent:var(--blue)">
            <div class="stat-icon">ğŸ“†</div>
            <div class="stat-val" id="e-month">â‚¹--</div>
            <div class="stat-lbl">Is Mahine</div>
          </div>
          <div class="stat-card" style="--accent:var(--purple)">
            <div class="stat-icon">ğŸ†</div>
            <div class="stat-val" id="e-total">â‚¹--</div>
            <div class="stat-lbl">Total Revenue</div>
          </div>
        </div>
        <div class="panel">
          <div class="panel-hd">
            <div class="panel-title">ğŸ’° Top Earning Drivers</div>
          </div>
          <div id="topDriversTable"><div class="empty">Loading...</div></div>
        </div>
      </div>

      <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
      <!-- PAGE: SURGE CONTROL -->
      <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
      <div class="page" id="page-surge">
        <div class="surge-card">
          <div style="font-family:'Syne',sans-serif;font-weight:900;font-size:1rem;margin-bottom:14px">âš¡ Surge Pricing Control</div>
          <div class="surge-toggle" style="margin-bottom:16px">
            <label class="tgsw">
              <input type="checkbox" id="surgeToggle" onchange="toggleSurge()">
              <div class="tgtr"></div><div class="tgth"></div>
            </label>
            <div>
              <div style="font-weight:700" id="surgeLbl">Surge: OFF</div>
              <div style="font-size:.72rem;color:var(--muted)">Sabhi riders ke liye fare multiplied hoga</div>
            </div>
          </div>
          <div style="margin-bottom:12px">
            <label class="fl">Surge Multiplier</label>
            <div style="display:flex;gap:8px;flex-wrap:wrap">
              <button class="filter-chip act" onclick="setSurgeMultiplier(1.5,this)">1.5x</button>
              <button class="filter-chip" onclick="setSurgeMultiplier(2.0,this)">2.0x</button>
              <button class="filter-chip" onclick="setSurgeMultiplier(2.5,this)">2.5x</button>
              <button class="filter-chip" onclick="setSurgeMultiplier(3.0,this)">3.0x</button>
            </div>
          </div>
          <div style="margin-bottom:14px">
            <label class="fl">Surge Message (riders ko dikhega)</label>
            <input class="fi" id="surgeMsg" value="ğŸŒ§ï¸ High demand! Surge pricing active." style="margin-bottom:0">
          </div>
          <button class="act-btn primary" style="padding:10px 20px" onclick="saveSurge()">âœ… Apply Surge Settings</button>
        </div>
        <div class="panel">
          <div class="panel-hd"><div class="panel-title">ğŸ“œ Surge History</div></div>
          <div id="surgeHistory"><div class="empty">No recent surge events</div></div>
        </div>
      </div>

      <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
      <!-- PAGE: PROMO CODES -->
      <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
      <div class="page" id="page-promo">
        <div class="panel">
          <div class="panel-hd">
            <div class="panel-title">ğŸ Promo Codes</div>
            <button class="act-btn primary" onclick="openAddPromoModal()">+ Add Code</button>
          </div>
          <table>
            <thead><tr><th>Code</th><th>Discount</th><th>Uses</th><th>Status</th><th>Action</th></tr></thead>
            <tbody id="promoTable">
              <tr><td>JDP50</td><td>â‚¹50 off</td><td>âˆ</td><td><span class="chip green">Active</span></td><td><button class="act-btn red" onclick="deletePromo('JDP50')">Delete</button></td></tr>
              <tr><td>FREE1</td><td>â‚¹100 off</td><td>1/user</td><td><span class="chip green">Active</span></td><td><button class="act-btn red" onclick="deletePromo('FREE1')">Delete</button></td></tr>
              <tr><td>BASTAR10</td><td>â‚¹30 off</td><td>âˆ</td><td><span class="chip green">Active</span></td><td><button class="act-btn red" onclick="deletePromo('BASTAR10')">Delete</button></td></tr>
            </tbody>
          </table>
        </div>
      </div>

      <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
      <!-- PAGE: SETTINGS -->
      <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
      <div class="page" id="page-settings">
        <div class="panel" style="padding:18px">
          <div class="panel-title" style="margin-bottom:16px">âš™ï¸ App Settings</div>
          <label class="fl">Base Auto Fare (â‚¹ per km)</label>
          <input class="fi" id="set-autoFare" type="number" value="12" placeholder="12">
          <label class="fl">Base Mini Cab Fare (â‚¹ per km)</label>
          <input class="fi" id="set-cabFare" type="number" value="16" placeholder="16">
          <label class="fl">Minimum Auto Fare (â‚¹)</label>
          <input class="fi" id="set-minAuto" type="number" value="25" placeholder="25">
          <label class="fl">Minimum Cab Fare (â‚¹)</label>
          <input class="fi" id="set-minCab" type="number" value="50" placeholder="50">
          <label class="fl">Driver Search Radius (km)</label>
          <input class="fi" id="set-radius" type="number" value="8" placeholder="8">
          <label class="fl">Driver Timeout (seconds)</label>
          <input class="fi" id="set-timeout" type="number" value="60" placeholder="60">
          <button class="act-btn primary" style="padding:12px 24px;width:100%;justify-content:center" onclick="saveSettings()">âœ… Save Settings</button>
        </div>
      </div>

    </div><!-- /main -->
  </div><!-- /layout -->
</div><!-- /app -->

<!-- â•â• MODALS â•â• -->

<!-- Driver Detail Modal -->
<div class="overlay" id="driverModal" onclick="if(event.target===this)this.classList.remove('sh')">
  <div class="modal">
    <div class="modal-title" id="driverModalTitle">Driver Details</div>
    <div id="driverModalBody"></div>
    <button class="act-btn" style="width:100%;justify-content:center;margin-top:4px" onclick="document.getElementById('driverModal').classList.remove('sh')">Close</button>
  </div>
</div>

<!-- Add Promo Modal -->
<div class="overlay" id="promoAddModal" onclick="if(event.target===this)this.classList.remove('sh')">
  <div class="modal">
    <div class="modal-title">ğŸ New Promo Code</div>
    <label class="fl">Code</label>
    <input class="fi" id="newPromoCode" placeholder="JDPNEW" style="text-transform:uppercase">
    <label class="fl">Discount Amount (â‚¹)</label>
    <input class="fi" id="newPromoAmt" type="number" placeholder="50">
    <label class="fl">Description</label>
    <input class="fi" id="newPromoDesc" placeholder="â‚¹50 off pehli ride">
    <div style="display:flex;gap:8px;margin-top:4px">
      <button class="act-btn primary" style="flex:1;justify-content:center" onclick="addPromo()">âœ… Add Code</button>
      <button class="act-btn" onclick="document.getElementById('promoAddModal').classList.remove('sh')">Cancel</button>
    </div>
  </div>
</div>

<!-- FIREBASE -->
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
import { getAuth, signInWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
import { getFirestore, doc, setDoc, getDoc, getDocs, collection, addDoc, updateDoc, deleteDoc, onSnapshot, query, where, orderBy, limit, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

const cfg = {
  apiKey:"AIzaSyBRPV3mosWr3YFnW6xCfJaqC1bV4MhJm_Y",
  authDomain:"jdpcabs.firebaseapp.com",
  projectId:"jdpcabs",
  storageBucket:"jdpcabs.firebasestorage.app",
  messagingSenderId:"148264332732",
  appId:"1:148264332732:web:eed512ac4e685cef97cfb9"
};
const fbApp = initializeApp(cfg);
const auth  = getAuth(fbApp);
const db    = getFirestore(fbApp);
window.FB = { auth, db, signInWithEmailAndPassword, signOut, onAuthStateChanged,
  doc, setDoc, getDoc, getDocs, collection, addDoc, updateDoc, deleteDoc,
  onSnapshot, query, where, orderBy, limit, serverTimestamp };
window.FB_READY = true;

onAuthStateChanged(auth, user => {
  if(user){
    document.getElementById('loginScreen').style.display='none';
    document.getElementById('app').style.display='block';
    document.getElementById('adminName').textContent = user.email.split('@')[0];
    initAdmin();
  } else {
    document.getElementById('loginScreen').style.display='flex';
    document.getElementById('app').style.display='none';
  }
});
</script>

<!-- LEAFLET -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.css">
<script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.js"></script>

<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// STATE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let allRides=[], allDrivers=[], allRiders=[], allKyc=[];
let rideFilter='all', driverFilter='all';
let surgeOn=false, surgeMultiplier=1.5;
let adminMap=null;
const JDPC = {lat:19.0748, lng:82.0164};

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// LOGIN
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function doAdminLogin() {
  const email = document.getElementById('adminEmail').value.trim();
  const pass  = document.getElementById('adminPass').value;
  const errEl = document.getElementById('loginErr');
  errEl.textContent = '';
  if(!email||!pass){ errEl.textContent='Email aur password required'; return; }
  try {
    await window.FB.signInWithEmailAndPassword(window.FB.auth, email, pass);
  } catch(e) {
    errEl.textContent = e.code==='auth/wrong-password'?'âŒ Wrong password':
      e.code==='auth/user-not-found'?'âŒ Email not found':
      e.code==='auth/network-request-failed'?'âŒ No internet':'âŒ Login failed: '+e.message;
  }
}
window.doAdminLogin = doAdminLogin;

async function doLogout() {
  if(confirm('Logout karna chahte ho?')) await window.FB.signOut(window.FB.auth);
}
window.doLogout = doLogout;

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// INIT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function initAdmin() {
  loadDashboard();
  setInterval(loadDashboard, 30000); // auto refresh every 30s
  setInterval(()=>{document.getElementById('lastRefresh').textContent='Updated '+new Date().toLocaleTimeString('hi-IN');},1000);
}
window.initAdmin = initAdmin;

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// NAVIGATION
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const pageTitles = {
  dashboard:['Dashboard','Jagdalpur Live Overview'],
  livemap:['ğŸ—ºï¸ Live Map','Real-time driver tracking'],
  rides:['ğŸš— All Rides','Complete ride history'],
  drivers:['ğŸ‘¨â€âœˆï¸ Drivers','All registered drivers'],
  riders:['ğŸ§ Riders','All registered riders'],
  kyc:['ğŸªª KYC Review','Document verification'],
  earnings:['ğŸ’° Earnings','Revenue analytics'],
  surge:['âš¡ Surge Control','Fare multiplier'],
  promo:['ğŸ Promo Codes','Discount management'],
  settings:['âš™ï¸ Settings','App configuration'],
};

function gotoPage(id) {
  document.querySelectorAll('.page').forEach(p=>p.classList.remove('act'));
  document.querySelectorAll('.sb-item').forEach(i=>i.classList.remove('act'));
  document.getElementById('page-'+id)?.classList.add('act');
  document.querySelectorAll('.sb-item').forEach(i=>{ if(i.textContent.toLowerCase().includes(id.split('')[0])) {} });
  // highlight sidebar
  document.querySelectorAll('.sb-item').forEach(i=>{
    if(i.getAttribute('onclick')?.includes("'"+id+"'")) i.classList.add('act');
  });
  const t = pageTitles[id]||[id,''];
  document.getElementById('pageTitle').textContent=t[0];
  document.getElementById('pageSub').textContent=t[1];
  // Close sidebar on mobile
  document.getElementById('sidebar').classList.remove('open');
  // Load page data
  if(id==='livemap') initAdminMap();
  if(id==='rides')   loadAllRides();
  if(id==='drivers') loadAllDrivers();
  if(id==='riders')  loadAllRiders();
  if(id==='kyc')     loadKYC();
  if(id==='earnings') loadEarnings();
}
window.gotoPage = gotoPage;

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// DASHBOARD
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function loadDashboard() {
  if(!window.FB_READY) return;
  try {
    // Drivers
    const dSnap = await window.FB.getDocs(window.FB.collection(window.FB.db,'users'));
    let drivers=[], riders=[], onlineD=0, kycPending=0;
    dSnap.forEach(d=>{
      const u=d.data();
      if(u.role==='driver'){ drivers.push({id:d.id,...u}); if(u.isOnline)onlineD++; if(u.kycStatus==='pending')kycPending++; }
      if(u.role==='rider') riders.push({id:d.id,...u});
    });
    allDrivers=drivers; allRiders=riders;
    document.getElementById('s-onlineDrivers').textContent=onlineD;
    document.getElementById('s-totalDrivers').textContent=drivers.length;
    document.getElementById('s-totalRiders').textContent=riders.length;
    document.getElementById('s-kycPending').textContent=kycPending;
    document.getElementById('kycBadge').textContent=kycPending||'0';

    // Today's rides
    const today=new Date(); today.setHours(0,0,0,0);
    const rSnap = await window.FB.getDocs(
      window.FB.query(window.FB.collection(window.FB.db,'rides'), window.FB.orderBy('createdAt','desc'), window.FB.limit(100))
    );
    let todayRides=0, todayRev=0, liveRides=[], recentRides=[];
    rSnap.forEach(d=>{
      const r={id:d.id,...d.data()};
      const ts=r.createdAt?.toDate?r.createdAt.toDate():new Date();
      if(ts>=today){ todayRides++; if(r.status==='completed')todayRev+=r.fare||0; }
      if(['finding','assigned','ongoing'].includes(r.status)) liveRides.push(r);
      recentRides.push(r);
    });
    allRides=recentRides;
    document.getElementById('s-totalRides').textContent=todayRides;
    document.getElementById('s-revenue').textContent='â‚¹'+todayRev;
    document.getElementById('map-onlineCount').textContent=onlineD;
    document.getElementById('map-activeRides').textContent=liveRides.length;

    renderLiveRides(liveRides);
    renderRecentRides(recentRides.slice(0,8));
  } catch(e){ console.error(e); }
}
window.loadDashboard = loadDashboard;

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// RENDER TABLES
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function timeAgo(ts) {
  if(!ts) return '--';
  const d = ts.toDate ? ts.toDate() : new Date(ts);
  const sec = Math.floor((Date.now()-d)/1000);
  if(sec<60) return sec+'s ago';
  if(sec<3600) return Math.floor(sec/60)+'m ago';
  if(sec<86400) return Math.floor(sec/3600)+'h ago';
  return d.toLocaleDateString('hi-IN');
}

function statusChip(status) {
  const map={completed:'green',cancelled:'red',assigned:'blue',finding:'yellow',ongoing:'purple',cancelled_driver:'red'};
  const labels={completed:'âœ… Done',cancelled:'âŒ Cancelled',assigned:'ğŸš— Assigned',finding:'ğŸ” Finding',ongoing:'ğŸŸ¢ Ongoing',cancelled_driver:'âŒ Driver Cancel'};
  return `<span class="chip ${map[status]||'grey'}">${labels[status]||status}</span>`;
}

function renderLiveRides(rides) {
  const el=document.getElementById('liveRidesTable');
  if(!rides.length){el.innerHTML='<div class="empty"><div class="empty-icon">âœ…</div>Koi active ride nahi</div>';return;}
  el.innerHTML=`<table><thead><tr><th>Rider</th><th>Driver</th><th>Pickup â†’ Drop</th><th>Fare</th><th>Status</th><th>Action</th></tr></thead><tbody>
    ${rides.map(r=>`<tr>
      <td>${r.riderName||'--'}</td>
      <td>${r.driverName||'Searching...'}</td>
      <td style="max-width:200px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap">${(r.pickup||'').slice(0,25)} â†’ ${(r.drop||'').slice(0,20)}</td>
      <td style="color:var(--yellow);font-weight:700">â‚¹${r.fare||'--'}</td>
      <td>${statusChip(r.status)}</td>
      <td><button class="act-btn red" onclick="forceCancel('${r.id}')">Force Cancel</button></td>
    </tr>`).join('')}
  </tbody></table>`;
}

function renderRecentRides(rides) {
  const el=document.getElementById('recentRidesTable');
  if(!rides.length){el.innerHTML='<div class="empty">No recent rides</div>';return;}
  el.innerHTML=`<table><thead><tr><th>Time</th><th>Rider</th><th>Driver</th><th>Route</th><th>Fare</th><th>Status</th></tr></thead><tbody>
    ${rides.map(r=>`<tr>
      <td class="td-mono" style="white-space:nowrap">${timeAgo(r.createdAt)}</td>
      <td>${r.riderName||'--'}<br><span style="font-size:.65rem;color:var(--muted)">${r.riderPhone||''}</span></td>
      <td>${r.driverName||'--'}</td>
      <td style="max-width:180px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;font-size:.76rem">${(r.pickup||'--').slice(0,20)} â†’ ${(r.drop||'--').slice(0,20)}</td>
      <td style="color:var(--yellow);font-weight:700">â‚¹${r.fare||'--'}</td>
      <td>${statusChip(r.status)}</td>
    </tr>`).join('')}
  </tbody></table>`;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ALL RIDES PAGE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let ridesData=[];
async function loadAllRides() {
  document.getElementById('allRidesTable').innerHTML='<div class="empty">Loading...</div>';
  try {
    const snap=await window.FB.getDocs(window.FB.query(window.FB.collection(window.FB.db,'rides'),window.FB.orderBy('createdAt','desc'),window.FB.limit(200)));
    ridesData=[];
    snap.forEach(d=>ridesData.push({id:d.id,...d.data()}));
    filterRides();
  } catch(e){document.getElementById('allRidesTable').innerHTML=`<div class="empty" style="color:var(--red)">Error: ${e.message}</div>`;}
}
window.loadAllRides=loadAllRides;

function filterRides() {
  const q=(document.getElementById('rideSearch')?.value||'').toLowerCase();
  let filtered=ridesData.filter(r=>{
    if(rideFilter!=='all'&&r.status!==rideFilter) return false;
    if(q&&!JSON.stringify(r).toLowerCase().includes(q)) return false;
    return true;
  });
  const el=document.getElementById('allRidesTable');
  if(!filtered.length){el.innerHTML='<div class="empty">Koi ride nahi mili</div>';return;}
  el.innerHTML=`<table><thead><tr><th>Time</th><th>Rider</th><th>Driver</th><th>Pickup</th><th>Drop</th><th>km</th><th>Fare</th><th>Status</th><th>OTP</th></tr></thead><tbody>
    ${filtered.map(r=>`<tr>
      <td class="td-mono" style="white-space:nowrap;font-size:.72rem">${timeAgo(r.createdAt)}</td>
      <td>${r.riderName||'--'}<br><span class="td-mono" style="font-size:.65rem;color:var(--muted)">${r.riderPhone||''}</span></td>
      <td>${r.driverName||'--'}<br><span style="font-size:.65rem;color:var(--muted)">${r.driverPhone||''}</span></td>
      <td style="font-size:.76rem;max-width:120px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap">${r.pickup||'--'}</td>
      <td style="font-size:.76rem;max-width:120px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap">${r.drop||'--'}</td>
      <td>${r.distanceKM||'--'}</td>
      <td style="color:var(--yellow);font-weight:700">â‚¹${r.fare||'--'}</td>
      <td>${statusChip(r.status)}</td>
      <td class="td-mono">${r.otp||'--'}</td>
    </tr>`).join('')}
  </tbody></table>`;
}
window.filterRides=filterRides;

function setRideFilter(f,el){
  rideFilter=f;
  document.querySelectorAll('#page-rides .filter-chip').forEach(c=>c.classList.remove('act'));
  el.classList.add('act');
  filterRides();
}
window.setRideFilter=setRideFilter;

function exportRidesCSV() {
  const headers=['Time','Rider','Phone','Driver','Pickup','Drop','KM','Fare','Status','OTP'];
  const rows=ridesData.map(r=>[
    r.createdAt?.toDate?r.createdAt.toDate().toLocaleString():'',
    r.riderName||'',r.riderPhone||'',r.driverName||'',
    (r.pickup||'').replace(/,/g,';'),(r.drop||'').replace(/,/g,';'),
    r.distanceKM||'',r.fare||'',r.status||'',r.otp||''
  ]);
  const csv=[headers,...rows].map(r=>r.join(',')).join('\n');
  const a=document.createElement('a');
  a.href='data:text/csv;charset=utf-8,'+encodeURIComponent(csv);
  a.download='jdpcabs_rides_'+new Date().toISOString().slice(0,10)+'.csv';
  a.click();
  toast('ğŸ“¥ CSV downloaded!');
}
window.exportRidesCSV=exportRidesCSV;

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// DRIVERS PAGE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let driversData=[];
async function loadAllDrivers() {
  document.getElementById('driversTable').innerHTML='<div class="empty">Loading...</div>';
  try {
    const snap=await window.FB.getDocs(window.FB.query(window.FB.collection(window.FB.db,'users'),window.FB.where('role','==','driver')));
    driversData=[];
    snap.forEach(d=>driversData.push({id:d.id,...d.data()}));
    filterDrivers();
  } catch(e){document.getElementById('driversTable').innerHTML=`<div class="empty" style="color:var(--red)">Error: ${e.message}</div>`;}
}
window.loadAllDrivers=loadAllDrivers;

function filterDrivers() {
  const q=(document.getElementById('driverSearch')?.value||'').toLowerCase();
  let filtered=driversData.filter(d=>{
    if(driverFilter==='online'&&!d.isOnline) return false;
    if(driverFilter==='offline'&&d.isOnline) return false;
    if(driverFilter==='pending'&&d.kycStatus!=='pending') return false;
    if(q&&!(d.name||'').toLowerCase().includes(q)&&!(d.phone||'').includes(q)) return false;
    return true;
  });
  const el=document.getElementById('driversTable');
  if(!filtered.length){el.innerHTML='<div class="empty">Koi driver nahi mila</div>';return;}
  el.innerHTML=`<table><thead><tr><th>Photo</th><th>Name</th><th>Phone</th><th>Vehicle</th><th>Status</th><th>KYC</th><th>Rides</th><th>Rating</th><th>Actions</th></tr></thead><tbody>
    ${filtered.map(d=>`<tr>
      <td><div class="avatar">${d.photoBase64?`<img src="${d.photoBase64}" style="width:32px;height:32px;border-radius:50%;object-fit:cover">`:'ğŸ‘¨â€âœˆï¸'}</div></td>
      <td style="font-weight:700">${d.name||'--'}</td>
      <td class="td-mono">${d.phone||'--'}</td>
      <td>${d.vehicleNo||'--'}<br><span style="font-size:.65rem;color:var(--muted)">${d.vehicleType||''}</span></td>
      <td><span class="chip ${d.isOnline?'green':'grey'}">${d.isOnline?'ğŸŸ¢ Online':'âš« Offline'}</span></td>
      <td><span class="chip ${d.kycStatus==='approved'?'green':d.kycStatus==='pending'?'yellow':'red'}">${d.kycStatus||'--'}</span></td>
      <td style="text-align:center">${d.ridesCompleted||0}</td>
      <td style="color:var(--yellow)">â­${(d.rating||5.0).toFixed(1)}</td>
      <td style="display:flex;gap:4px;flex-wrap:wrap">
        <button class="act-btn" onclick="viewDriver('${d.id}')">ğŸ‘</button>
        ${d.kycStatus==='pending'?`<button class="act-btn green" onclick="approveKYC('${d.id}','${d.name}')">âœ…</button><button class="act-btn red" onclick="rejectKYC('${d.id}','${d.name}')">âŒ</button>`:''}
        <button class="act-btn red" onclick="blockDriver('${d.id}','${d.name}')">ğŸš«</button>
      </td>
    </tr>`).join('')}
  </tbody></table>`;
}
window.filterDrivers=filterDrivers;

function setDriverFilter(f,el){
  driverFilter=f;
  document.querySelectorAll('#page-drivers .filter-chip').forEach(c=>c.classList.remove('act'));
  el.classList.add('act');
  filterDrivers();
}
window.setDriverFilter=setDriverFilter;

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// RIDERS PAGE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let ridersData=[];
async function loadAllRiders() {
  document.getElementById('ridersTable').innerHTML='<div class="empty">Loading...</div>';
  try {
    const snap=await window.FB.getDocs(window.FB.query(window.FB.collection(window.FB.db,'users'),window.FB.where('role','==','rider')));
    ridersData=[];
    snap.forEach(d=>ridersData.push({id:d.id,...d.data()}));
    filterRiders();
  } catch(e){document.getElementById('ridersTable').innerHTML=`<div class="empty" style="color:var(--red)">Error: ${e.message}</div>`;}
}
window.loadAllRiders=loadAllRiders;

function filterRiders() {
  const q=(document.getElementById('riderSearch')?.value||'').toLowerCase();
  let filtered=ridersData.filter(r=>!q||((r.name||'').toLowerCase().includes(q)||(r.phone||'').includes(q)));
  const el=document.getElementById('ridersTable');
  if(!filtered.length){el.innerHTML='<div class="empty">Koi rider nahi mila</div>';return;}
  el.innerHTML=`<table><thead><tr><th>Name</th><th>Phone</th><th>Joined</th><th>Actions</th></tr></thead><tbody>
    ${filtered.map(r=>`<tr>
      <td style="font-weight:700">${r.name||'--'}</td>
      <td class="td-mono">${r.phone||'--'}</td>
      <td>${timeAgo(r.createdAt)}</td>
      <td><button class="act-btn red" onclick="blockUser('${r.id}','${r.name}')">ğŸš« Block</button></td>
    </tr>`).join('')}
  </tbody></table>`;
}
window.filterRiders=filterRiders;

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// KYC REVIEW
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function loadKYC() {
  document.getElementById('kycList').innerHTML='<div class="empty">Loading...</div>';
  try {
    const snap=await window.FB.getDocs(window.FB.query(window.FB.collection(window.FB.db,'users'),window.FB.where('role','==','driver'),window.FB.where('kycStatus','==','pending')));
    let html='';
    snap.forEach(d=>{
      const u={id:d.id,...d.data()};
      html+=`<div class="kyc-card">
        <div class="kyc-header">
          <div class="kyc-photo">${u.photoBase64?`<img src="${u.photoBase64}" style="width:56px;height:56px;border-radius:50%;object-fit:cover">`:'ğŸ¤³'}</div>
          <div style="flex:1">
            <div style="font-family:'Syne',sans-serif;font-weight:900;font-size:1rem">${u.name||'--'}</div>
            <div style="font-size:.75rem;color:var(--muted);margin-top:2px">ğŸ“ ${u.phone||'--'}</div>
            <div style="font-size:.72rem;color:var(--muted)">${u.vehicleType||'--'} Â· ${u.vehicleNo||'--'}</div>
          </div>
          <span class="chip yellow">â³ Pending</span>
        </div>
        <div class="kyc-grid">
          <div class="kyc-field"><div class="kyc-flbl">ğŸªª Aadhaar</div><div class="kyc-fval">${u.kyc?.aadhaar||'--'}</div></div>
          <div class="kyc-field"><div class="kyc-flbl">ğŸ“„ PAN</div><div class="kyc-fval">${u.kyc?.pan||'--'}</div></div>
          <div class="kyc-field"><div class="kyc-flbl">ğŸš— Driving Licence</div><div class="kyc-fval">${u.kyc?.drivingLicence||'--'}</div></div>
          <div class="kyc-field"><div class="kyc-flbl">ğŸ¦ IFSC</div><div class="kyc-fval">${u.bank?.ifsc||'--'}</div></div>
        </div>
        <div class="kyc-field" style="margin-bottom:12px"><div class="kyc-flbl">ğŸ¦ Bank Account</div><div class="kyc-fval">${u.bank?.accountHolderName||'--'} Â· ${u.bank?.accountNumber||'--'}</div></div>
        <div class="kyc-actions">
          <button class="act-btn green" style="flex:1;justify-content:center;padding:10px" onclick="approveKYC('${u.id}','${u.name}')">âœ… Approve</button>
          <button class="act-btn red" style="flex:1;justify-content:center;padding:10px" onclick="rejectKYC('${u.id}','${u.name}')">âŒ Reject</button>
        </div>
      </div>`;
    });
    document.getElementById('kycList').innerHTML=html||'<div class="empty"><div class="empty-icon">âœ…</div><b>Sab KYC clear hain!</b><br>Koi pending nahi</div>';
  } catch(e){document.getElementById('kycList').innerHTML=`<div class="empty" style="color:var(--red)">Error: ${e.message}</div>`;}
}
window.loadKYC=loadKYC;

async function approveKYC(uid, name) {
  if(!confirm(`âœ… "${name}" ka KYC approve karna chahte ho?`)) return;
  try {
    await window.FB.updateDoc(window.FB.doc(window.FB.db,'users',uid),{kycStatus:'approved', kycApprovedAt:window.FB.serverTimestamp()});
    toast(`âœ… ${name} KYC approved!`);
    loadKYC(); loadDashboard();
  } catch(e){ toast('âŒ Error: '+e.message); }
}
window.approveKYC=approveKYC;

async function rejectKYC(uid, name) {
  const reason = prompt(`âŒ "${name}" ka KYC reject karne ki wajah:`)||'Documents invalid';
  try {
    await window.FB.updateDoc(window.FB.doc(window.FB.db,'users',uid),{kycStatus:'rejected', kycRejectReason:reason, kycRejectedAt:window.FB.serverTimestamp()});
    toast(`âŒ ${name} KYC rejected`);
    loadKYC(); loadDashboard();
  } catch(e){ toast('âŒ Error: '+e.message); }
}
window.rejectKYC=rejectKYC;

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// EARNINGS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function loadEarnings() {
  try {
    const snap=await window.FB.getDocs(window.FB.query(window.FB.collection(window.FB.db,'rides'),window.FB.where('status','==','completed'),window.FB.orderBy('createdAt','desc'),window.FB.limit(500)));
    const now=new Date(), today=new Date(now); today.setHours(0,0,0,0);
    const weekAgo=new Date(now); weekAgo.setDate(now.getDate()-7);
    const monthAgo=new Date(now); monthAgo.setDate(1); monthAgo.setHours(0,0,0,0);
    let todayRev=0, weekRev=0, monthRev=0, totalRev=0;
    const driverMap={};
    snap.forEach(d=>{
      const r=d.data(); const f=r.fare||0;
      const ts=r.createdAt?.toDate?r.createdAt.toDate():new Date();
      totalRev+=f;
      if(ts>=today)todayRev+=f;
      if(ts>=weekAgo)weekRev+=f;
      if(ts>=monthAgo)monthRev+=f;
      if(r.driverId){
        if(!driverMap[r.driverId]) driverMap[r.driverId]={name:r.driverName||'--',total:0,rides:0};
        driverMap[r.driverId].total+=f; driverMap[r.driverId].rides++;
      }
    });
    document.getElementById('e-today').textContent='â‚¹'+todayRev;
    document.getElementById('e-week').textContent='â‚¹'+weekRev;
    document.getElementById('e-month').textContent='â‚¹'+monthRev;
    document.getElementById('e-total').textContent='â‚¹'+totalRev;
    // Top drivers
    const top=Object.entries(driverMap).sort((a,b)=>b[1].total-a[1].total).slice(0,10);
    document.getElementById('topDriversTable').innerHTML=`<table><thead><tr><th>#</th><th>Driver</th><th>Total Earned</th><th>Rides</th><th>Avg/Ride</th></tr></thead><tbody>
      ${top.map(([id,d],i)=>`<tr>
        <td style="font-weight:800;color:${i<3?'var(--yellow)':'var(--muted)'}">${i+1}</td>
        <td style="font-weight:700">${d.name}</td>
        <td style="color:var(--green);font-weight:800">â‚¹${d.total}</td>
        <td>${d.rides}</td>
        <td style="color:var(--muted)">â‚¹${Math.round(d.total/d.rides)}</td>
      </tr>`).join('')}
    </tbody></table>`;
  } catch(e){ console.error(e); }
}
window.loadEarnings=loadEarnings;

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// SURGE CONTROL
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function setSurgeMultiplier(m, el) {
  surgeMultiplier=m;
  document.querySelectorAll('#page-surge .filter-chip').forEach(c=>c.classList.remove('act'));
  el.classList.add('act');
}
window.setSurgeMultiplier=setSurgeMultiplier;

function toggleSurge() {
  surgeOn=document.getElementById('surgeToggle').checked;
  document.getElementById('surgeLbl').textContent='Surge: '+(surgeOn?'ğŸ”´ ON':'OFF');
  document.getElementById('surgeLbl').style.color=surgeOn?'var(--yellow)':'var(--text)';
}
window.toggleSurge=toggleSurge;

async function saveSurge() {
  const msg=document.getElementById('surgeMsg').value;
  try {
    await window.FB.setDoc(window.FB.doc(window.FB.db,'settings','surge'),{
      active:surgeOn, multiplier:surgeMultiplier, message:msg, updatedAt:window.FB.serverTimestamp()
    });
    document.getElementById('s-surgeStatus').textContent=surgeOn?'ON':'OFF';
    document.getElementById('s-surgeChange').textContent=surgeOn?surgeMultiplier+'x multiplier':'1.0x multiplier';
    toast(surgeOn?`âš¡ Surge ${surgeMultiplier}x activated!`:'âœ… Surge OFF kiya');
  } catch(e){ toast('âŒ Error: '+e.message); }
}
window.saveSurge=saveSurge;

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ADMIN MAP
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function initAdminMap() {
  if(adminMap){adminMap.invalidateSize();loadLiveDriversOnMap();return;}
  setTimeout(()=>{
    try {
      adminMap=L.map('adminMap',{center:[JDPC.lat,JDPC.lng],zoom:13,zoomControl:true});
      L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png',{attribution:'Â© CARTO',subdomains:'abcd',maxZoom:19}).addTo(adminMap);
      loadLiveDriversOnMap();
      setInterval(loadLiveDriversOnMap,15000);
    } catch(e){}
  },200);
}
window.initAdminMap=initAdminMap;

let mapDriverMarkers={};
async function loadLiveDriversOnMap() {
  if(!adminMap||!window.FB_READY) return;
  try {
    const snap=await window.FB.getDocs(window.FB.query(window.FB.collection(window.FB.db,'users'),window.FB.where('role','==','driver'),window.FB.where('isOnline','==',true)));
    // clear old
    Object.values(mapDriverMarkers).forEach(m=>{ try{adminMap.removeLayer(m);}catch(e){} });
    mapDriverMarkers={};
    let html='';
    snap.forEach(d=>{
      const u=d.data();
      if(!u.lat||!u.lng) return;
      const icon=L.divIcon({className:'',html:`<div style="font-size:22px;filter:drop-shadow(0 2px 6px rgba(0,0,0,.8))">${u.vehicleType==='cab'?'ğŸš—':'ğŸ›º'}</div>`,iconSize:[28,28],iconAnchor:[14,14]});
      mapDriverMarkers[d.id]=L.marker([u.lat,u.lng],{icon}).addTo(adminMap).bindPopup(`<b>${u.name}</b><br>${u.vehicleNo||'--'}<br>â­${(u.rating||5).toFixed(1)}`);
      html+=`<div style="display:flex;align-items:center;gap:10px;padding:10px 16px;border-bottom:1px solid var(--border)">
        <div style="font-size:1.3rem">${u.vehicleType==='cab'?'ğŸš—':'ğŸ›º'}</div>
        <div style="flex:1"><div style="font-weight:700">${u.name}</div><div style="font-size:.7rem;color:var(--muted)">${u.vehicleNo||'--'} Â· â­${(u.rating||5).toFixed(1)}</div></div>
        <span class="chip green">Online</span>
      </div>`;
    });
    document.getElementById('map-onlineCount').textContent=snap.size;
    const el=document.getElementById('liveDriversList');
    el.innerHTML=html||'<div class="empty">Koi driver online nahi</div>';
  } catch(e){}
}
window.loadLiveDriversOnMap=loadLiveDriversOnMap;

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// DRIVER ACTIONS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function viewDriver(uid) {
  const d=driversData.find(x=>x.id===uid);
  if(!d) return;
  document.getElementById('driverModalTitle').textContent='ğŸ‘¨â€âœˆï¸ '+d.name;
  document.getElementById('driverModalBody').innerHTML=`
    <div style="text-align:center;margin-bottom:16px">
      ${d.photoBase64?`<img src="${d.photoBase64}" style="width:80px;height:80px;border-radius:50%;object-fit:cover;border:3px solid var(--yellow)">`:'<div style="font-size:3rem">ğŸ‘¨â€âœˆï¸</div>'}
    </div>
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-bottom:12px">
      <div class="kyc-field"><div class="kyc-flbl">Phone</div><div class="kyc-fval">${d.phone}</div></div>
      <div class="kyc-field"><div class="kyc-flbl">Vehicle</div><div class="kyc-fval">${d.vehicleNo}</div></div>
      <div class="kyc-field"><div class="kyc-flbl">Rides</div><div class="kyc-fval">${d.ridesCompleted||0}</div></div>
      <div class="kyc-field"><div class="kyc-flbl">Rating</div><div class="kyc-fval">â­${(d.rating||5).toFixed(1)}</div></div>
      <div class="kyc-field"><div class="kyc-flbl">KYC</div><div class="kyc-fval">${d.kycStatus||'--'}</div></div>
      <div class="kyc-field"><div class="kyc-flbl">Earnings</div><div class="kyc-fval">â‚¹${d.earnings||0}</div></div>
    </div>
    <div class="kyc-field" style="margin-bottom:8px"><div class="kyc-flbl">Aadhaar</div><div class="kyc-fval">${d.kyc?.aadhaar||'--'}</div></div>
    <div class="kyc-field" style="margin-bottom:8px"><div class="kyc-flbl">PAN</div><div class="kyc-fval">${d.kyc?.pan||'--'}</div></div>
    <div class="kyc-field" style="margin-bottom:12px"><div class="kyc-flbl">Driving Licence</div><div class="kyc-fval">${d.kyc?.drivingLicence||'--'}</div></div>
    ${d.kycStatus==='pending'?`<div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-bottom:10px">
      <button class="act-btn green" style="justify-content:center;padding:10px" onclick="approveKYC('${d.id}','${d.name}');document.getElementById('driverModal').classList.remove('sh')">âœ… Approve KYC</button>
      <button class="act-btn red" style="justify-content:center;padding:10px" onclick="rejectKYC('${d.id}','${d.name}');document.getElementById('driverModal').classList.remove('sh')">âŒ Reject KYC</button>
    </div>`:''}
    <button class="act-btn red" style="width:100%;justify-content:center;margin-top:4px" onclick="blockDriver('${d.id}','${d.name}');document.getElementById('driverModal').classList.remove('sh')">ğŸš« Block Driver</button>
  `;
  document.getElementById('driverModal').classList.add('sh');
}
window.viewDriver=viewDriver;

async function blockDriver(uid, name) {
  if(!confirm(`ğŸš« "${name}" ko block karna chahte ho?`)) return;
  try {
    await window.FB.updateDoc(window.FB.doc(window.FB.db,'users',uid),{isBlocked:true, isOnline:false, blockedAt:window.FB.serverTimestamp()});
    toast(`ğŸš« ${name} blocked`); loadAllDrivers();
  } catch(e){toast('âŒ Error: '+e.message);}
}
window.blockDriver=blockDriver;

async function blockUser(uid, name) {
  if(!confirm(`ğŸš« "${name}" ko block karna chahte ho?`)) return;
  try {
    await window.FB.updateDoc(window.FB.doc(window.FB.db,'users',uid),{isBlocked:true});
    toast(`ğŸš« ${name} blocked`); loadAllRiders();
  } catch(e){toast('âŒ Error: '+e.message);}
}
window.blockUser=blockUser;

async function forceCancel(rideId) {
  if(!confirm('Force cancel karna chahte ho yeh ride?')) return;
  try {
    await window.FB.updateDoc(window.FB.doc(window.FB.db,'rides',rideId),{status:'cancelled', cancelReason:'Admin forced cancel', cancelledAt:window.FB.serverTimestamp()});
    toast('âœ… Ride force cancelled'); loadDashboard();
  } catch(e){toast('âŒ Error: '+e.message);}
}
window.forceCancel=forceCancel;

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// PROMO
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function openAddPromoModal(){document.getElementById('promoAddModal').classList.add('sh');}
window.openAddPromoModal=openAddPromoModal;
function openAddDriverModal(){toast('Driver registration main app se karo');}
window.openAddDriverModal=openAddDriverModal;

function addPromo() {
  const code=document.getElementById('newPromoCode').value.trim().toUpperCase();
  const amt=document.getElementById('newPromoAmt').value;
  const desc=document.getElementById('newPromoDesc').value.trim();
  if(!code||!amt){toast('Code aur amount required');return;}
  const tbody=document.getElementById('promoTable');
  const row=document.createElement('tr');
  row.innerHTML=`<td>${code}</td><td>â‚¹${amt} off</td><td>âˆ</td><td><span class="chip green">Active</span></td><td><button class="act-btn red" onclick="deletePromo('${code}')">Delete</button></td>`;
  tbody.appendChild(row);
  document.getElementById('promoAddModal').classList.remove('sh');
  toast(`âœ… Promo "${code}" added!`);
}
window.addPromo=addPromo;

function deletePromo(code) {
  if(!confirm(`"${code}" delete karna chahte ho?`)) return;
  document.querySelectorAll('#promoTable tr').forEach(r=>{ if(r.cells[0]?.textContent===code) r.remove(); });
  toast(`ğŸ—‘ï¸ ${code} deleted`);
}
window.deletePromo=deletePromo;

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// SETTINGS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function saveSettings() {
  const settings={
    autoFarePerKm: parseFloat(document.getElementById('set-autoFare').value)||12,
    cabFarePerKm: parseFloat(document.getElementById('set-cabFare').value)||16,
    minAutoFare: parseFloat(document.getElementById('set-minAuto').value)||25,
    minCabFare: parseFloat(document.getElementById('set-minCab').value)||50,
    driverSearchRadius: parseFloat(document.getElementById('set-radius').value)||8,
    driverTimeout: parseInt(document.getElementById('set-timeout').value)||60,
    updatedAt: window.FB_READY ? window.FB.serverTimestamp() : new Date().toISOString()
  };
  try {
    if(window.FB_READY) await window.FB.setDoc(window.FB.doc(window.FB.db,'settings','appConfig'),settings);
    toast('âœ… Settings saved!');
  } catch(e){toast('âŒ Error: '+e.message);}
}
window.saveSettings=saveSettings;

function loadLiveRides(){loadDashboard();}
window.loadLiveRides=loadLiveRides;

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// TOAST
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function toast(msg) {
  document.querySelectorAll('.toast').forEach(t=>t.remove());
  const el=document.createElement('div'); el.className='toast'; el.textContent=msg;
  document.body.appendChild(el);
  setTimeout(()=>el.remove(),3000);
}
window.toast=toast;
</script>
</body>
</html>
